(()=>{"use strict";var e,t,i,s,r={981:(e,t,i)=>{i.d(t,{U:()=>n});var s=i(134),r=i(963);class n extends r.Z{callbacks;helpButton;helpRequested=!1;freqSlider=null;ampSlider=null;offsetSlider=null;phaseShiftSlider=null;constructor(e,t){super(e),this.callbacks=t,this.element.className="mainContent",this.element.replaceChildren(this.helpButton=this.createHelpButton(),this.createSliders())}showHelpButton(){this.helpButton.classList.remove("buttonHidden","selected")}hideHelpButton(){this.helpRequested=!1,this.helpButton.classList.add("buttonHidden")}toggleHelp(){this.helpRequested?this.unrequestHelp():this.requestHelp(),this.callbacks.helpButtonClicked(this.helpRequested)}unrequestHelp(){this.helpRequested=!1,this.helpButton.classList.remove("selected"),this.helpButton.innerText="Request help",s.p.setLocalisationKey(this.helpButton,"requestHelp")}requestHelp(){this.helpRequested=!0,this.helpButton.classList.add("selected"),this.helpButton.innerText="Unrequest help",s.p.setLocalisationKey(this.helpButton,"unrequestHelp")}highlight(e){switch(e){case"frequency":this.freqSlider.highlight();break;case"amplitude":this.ampSlider.highlight();break;case"offset":this.offsetSlider.highlight();break;case"relation":this.phaseShiftSlider.highlight()}}set frequency(e){this.freqSlider.value=e}set amplitude(e){this.ampSlider.value=e}set offset(e){this.offsetSlider.value=e}set phaseShift(e){this.phaseShiftSlider.value=e}createHelpButton(){const e=document.createElement("div");return e.className="card noflex buttonHidden bigText",e.innerText="Request help",e.style.padding="1em",s.p.setLocalisationKey(e,"requestHelp"),e.addEventListener("click",(e=>this.toggleHelp())),e}createSliders(){const e=document.createElement("div");return e.className="slidersContainer",e.replaceChildren((this.freqSlider=new o("Frequency",0,0,2,.05,this.callbacks.frequencyChangedCallback)).element,(this.ampSlider=new o("Amplitude",0,0,90,1,this.callbacks.amplitudeChangedCallback)).element,(this.offsetSlider=new o("Offset",90,0,180,1,this.callbacks.offsetChangedCallback)).element,(this.phaseShiftSlider=new o("Relation",0,0,360,1,this.callbacks.phaseShiftChangedCallback)).element,this.createResetButton()),document.createElement("div").className="spacer",e}createResetButton(){const e=document.createElement("div");return e.className="card noflex bigText",e.style.marginTop="1em",e.innerText="Reset sliders",e.style.padding="1em",s.p.setLocalisationKey(e,"resetSliders"),e.addEventListener("click",(e=>this.resetValues())),e}resetValues(){this.callbacks.frequencyChangedCallback(this.frequency=0),this.callbacks.amplitudeChangedCallback(this.amplitude=0),this.callbacks.offsetChangedCallback(this.offset=90),this.callbacks.phaseShiftChangedCallback(this.phaseShift=0)}}class o{slider;text;element;highlightInterval;constructor(e,t,i,r,n,a){const l=this.element=document.createElement("div");l.style.animationDuration="5000ms";const h=document.createElement("h2");h.innerText=e,s.p.setLocalisationKey(h,e.toLowerCase()),l.appendChild(h);const c=document.createElement("div");c.className="sliderbox",l.appendChild(c);const u=this.slider=document.createElement("input");u.type="range",u.className="slider";const d=document.createElement("div");d.className="textBox sliderinput";const p=this.text=document.createElement("input");p.type="number",p.classList.add("sliderinputText","textBoxInput"),p.autocomplete="off",d.appendChild(p),u.min=p.min=i.toString(),u.max=p.max=r.toString(),u.step=p.step=n.toString(),u.value=p.value=t.toString();const _=e=>{const t=o.clamp(e.target.value,i,r);this.value=t,a(t)};u.addEventListener("input",_),p.addEventListener("input",_),c.replaceChildren(u,d),this.element.replaceChildren(h,c)}static clamp(e,t,i){try{let s=Number(e);return isNaN(s)?t:Math.max(Math.min(s,i))}catch(e){return t}}highlight(){this.highlightInterval&&this.unhighlight(),this.element.style.animationName="highlight",this.highlightInterval=setInterval(this.unhighlight.bind(this),5e3)}unhighlight(){this.element.style.animationName="",clearInterval(this.highlightInterval),this.highlightInterval=null}set value(e){this.slider.value=this.text.value=e.toString()}}},963:(e,t,i)=>{i.d(t,{Z:()=>s});class s{element;constructor(e){this.element=document.createElement("div"),e&&this.setParent(e)}init(){this.element.replaceChildren(...this.createPanelContent())}createPanelContent(){return[]}setParent(e){e?.appendChild(this.element)}replaceWith(e){this.element.replaceWith(e)}}},418:(e,t,i)=>{i.d(t,{Q:()=>s});class s{element;buttons;entries=[];currentSelection=-1;constructor(e){this.entries=e;const t=this.element=document.createElement("div");t.className="panelButtons",this.buttons=e.map(((e,t)=>s.createButton(e.faIcon,(()=>{this.CurrentSelection=t}),e.overlayElement))),this.CurrentSelection=0,t.replaceChildren(...this.buttons)}set CurrentSelection(e){if(this.currentSelection!=e){-1!=this.currentSelection&&this.buttons[this.currentSelection].classList.remove("panelButtonSelected"),this.buttons[e].classList.add("panelButtonSelected"),this.currentSelection=e;try{this.entries[e].selectionCallback()}catch(e){}}}static createButton(e,t,i){const s=document.createElement("div");s.className="panelButton";const r=document.createElement("i");return r.className=`panelButtonIcon fa-solid ${e}`,i&&r.appendChild(i),s.appendChild(r),s.addEventListener("click",(e=>t())),s}}},77:(e,t,i)=>{i.d(t,{Z:()=>o});var s=i(134),r=i(963);const n=[0,120,240,60];class o extends r.Z{playerID=0;constructor(){super(null),this.element.className="mainContent",this.refreshPlayers()}setID(e){this.playerID=e}refreshPlayers(e=[]){if(0==e.length){const e=document.createElement("h2");return e.innerText="There are no players in this session.",s.p.setLocalisationKey(e,"noPlayers"),void this.element.replaceChildren(e)}this.element.replaceChildren(...e.map((e=>this.createPlayerCard(e,this.playerID))))}createPlayerCard(e,t){const i=document.createElement("div");i.classList.add("card","noflex","playerCard"),i.style.setProperty("--hue",n[e.number].toString());const r=document.createElement("h2");if(r.className="cardText",e.number!=t)r.innerText=`${e.name}`,s.p.removeLocalisationKey(r);else{r.innerText=`${e.name}${e.number==t?" (You)":""}`;const i="baba"==e.name.toLowerCase()||"kiki"==e.name.toLowerCase(),n={name:e.name};s.p.setLocalisationKey(r,i?"playerIsBabaIsYou":"playerIsYou",n)}if(i.appendChild(r),e.voted){const e=document.createElement("i");e.className="playerCardIcon fa-solid fa-question-circle",i.appendChild(e)}return i}}},909:(e,t,i)=>{i.d(t,{W:()=>n});var s=i(134),r=i(963);class n extends r.Z{taskBubble;constructor(e){super(null),this.taskBubble=e,this.element.className="mainContent",this.refreshTasks()}refreshTasks(e=[]){if(0==e.length){const e=document.createElement("h2");return this.taskBubble.innerText=e.innerText="There are no tasks in this session.",s.p.setLocalisationKey(e,"noTasks"),s.p.setLocalisationKey(this.taskBubble,"noTasks"),void this.element.replaceChildren(e)}const t=e.find((e=>!e.completed));if(t){const e=s.p.CurrentLanguage;this.taskBubble.innerText=t.strings[e]}else this.taskBubble.innerText="You've completed all tasks",s.p.setLocalisationKey(this.taskBubble,"tasksCompleted");this.element.replaceChildren(...e.map((e=>this.createTaskCard(e))))}createTaskCard(e){const t=document.createElement("div");t.classList.add("card","noflex");const i=document.createElement("h2");i.className="cardText";const r=s.p.CurrentLanguage;return i.innerText=e.strings[r],t.appendChild(i),e.completed&&i.classList.add("taskCompleted"),t}}},816:(e,t,i)=>{i.d(t,{v:()=>s});class s{static ICE_SERVERS={iceServers:[{urls:"stun:stun.relay.metered.ca:80"},{urls:"turn:a.relay.metered.ca:80",username:"e3e28e4f25f3c94a995bc9dd",credential:"VSg2ZCdBfND7hEgA"},{urls:"turn:a.relay.metered.ca:80?transport=tcp",username:"e3e28e4f25f3c94a995bc9dd",credential:"VSg2ZCdBfND7hEgA"},{urls:"turn:a.relay.metered.ca:443",username:"e3e28e4f25f3c94a995bc9dd",credential:"VSg2ZCdBfND7hEgA"},{urls:"turn:a.relay.metered.ca:443?transport=tcp",username:"e3e28e4f25f3c94a995bc9dd",credential:"VSg2ZCdBfND7hEgA"}]};pc;ws;dataChannel;callbacks=[];name;constructor(e,t="ws://localhost:8080",i=[]){if(!this.checkWebSocketURL(t))throw new Error("Invalid WebSocket URL");this.name=e,this.pc=new RTCPeerConnection,this.ws=new WebSocket(t),this.pc.oniceconnectionstatechange=this.onConnectionStateChange.bind(this),this.dataChannel=this.pc.createDataChannel("channel"),this.dataChannel.onmessage=this.onDataChannelMessage.bind(this),this.ws.onopen=this.webSocketOpen.bind(this),this.ws.onmessage=this.onWebSocketMessage.bind(this),i.forEach((e=>{this.OnDataChannelMessage(e)}),this),window.addEventListener("beforeunload",(()=>this.close()))}checkWebSocketURL(e){return e.startsWith("ws://")||e.startsWith("wss://")}connectionStateChangedHandlers=[];OnConnectionStateChange(e){this.connectionStateChangedHandlers.push(e)}onConnectionStateChange(){this.connectionStateChangedHandlers.forEach((e=>e(this.pc.iceConnectionState)))}sendMessage(e){"open"==this.dataChannel.readyState&&this.dataChannel.send(e)}onDataChannelMessage(e){this.callbacks.forEach((t=>t(e.data))),console.log("Received message:",e.data)}OnDataChannelMessage(e){this.callbacks.push(e)}async webSocketOpen(){const e=this.pc,t=this.ws,i=await e.createOffer();await e.setLocalDescription(i);const s={playerName:this.name,handshake:JSON.stringify(i)};t.send(JSON.stringify(s))}async onWebSocketMessage(e){const t=JSON.parse(e.data);await this.pc.setRemoteDescription(new RTCSessionDescription(t)),this.ws.close()}close(){this.sendMessage("CLOSE"),this.dataChannel.close(),this.pc.close(),this.ws.close()}}},993:(e,t,i)=>{i.d(t,{n:()=>_y});class s{constructor(){this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[]}static AddParser(e,t){this._BabylonFileParsers[e]=t}static GetParser(e){return this._BabylonFileParsers[e]?this._BabylonFileParsers[e]:null}static AddIndividualParser(e,t){this._IndividualBabylonFileParsers[e]=t}static GetIndividualParser(e){return this._IndividualBabylonFileParsers[e]?this._IndividualBabylonFileParsers[e]:null}static Parse(e,t,i,s){for(const r in this._BabylonFileParsers)Object.prototype.hasOwnProperty.call(this._BabylonFileParsers,r)&&this._BabylonFileParsers[r](e,t,i,s)}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e}getNodes(){let e=[];return e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes),this.skeletons.forEach((t=>e=e.concat(t.bones))),e}}s._BabylonFileParsers={},s._IndividualBabylonFileParsers={};class r{constructor(){this.hoverCursor="",this.actions=[],this.isRecursive=!1}static get HasTriggers(){for(const e in r.Triggers)if(Object.prototype.hasOwnProperty.call(r.Triggers,e))return!0;return!1}static get HasPickTriggers(){for(const e in r.Triggers)if(Object.prototype.hasOwnProperty.call(r.Triggers,e)){const t=parseInt(e);if(t>=1&&t<=7)return!0}return!1}static HasSpecificTrigger(e){for(const t in r.Triggers)if(Object.prototype.hasOwnProperty.call(r.Triggers,t)&&parseInt(t)===e)return!0;return!1}}r.Triggers={};class n{constructor(e,t=!1,i,s){this.initialize(e,t,i,s)}initialize(e,t=!1,i,s){return this.mask=e,this.skipNextObservers=t,this.target=i,this.currentTarget=s,this}}class o{constructor(e,t,i=null){this.callback=e,this.mask=t,this.scope=i,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1,this._remove=null}remove(){this._remove&&this._remove()}}class a{static FromPromise(e,t){const i=new a;return e.then((e=>{i.notifyObservers(e)})).catch((e=>{if(!t)throw e;t.notifyObservers(e)})),i}get observers(){return this._observers}constructor(e,t=!1){this.notifyIfTriggered=t,this._observers=new Array,this._numObserversMarkedAsDeleted=0,this._hasNotified=!1,this._eventState=new n(0),e&&(this._onObserverAdded=e)}add(e,t=-1,i=!1,s=null,r=!1){if(!e)return null;const n=new o(e,t,s);return n.unregisterOnNextCall=r,i?this._observers.unshift(n):this._observers.push(n),this._onObserverAdded&&this._onObserverAdded(n),this._hasNotified&&this.notifyIfTriggered&&void 0!==this._lastNotifiedValue&&this.notifyObserver(n,this._lastNotifiedValue),n._remove=()=>{this.remove(n)},n}addOnce(e){return this.add(e,void 0,void 0,void 0,!0)}remove(e){return!!e&&(e._remove=null,-1!==this._observers.indexOf(e)&&(this._deferUnregister(e),!0))}removeCallback(e,t){for(let i=0;i<this._observers.length;i++){const s=this._observers[i];if(!(s._willBeUnregistered||s.callback!==e||t&&t!==s.scope))return this._deferUnregister(s),!0}return!1}_deferUnregister(e){e._willBeUnregistered||(this._numObserversMarkedAsDeleted++,e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout((()=>{this._remove(e)}),0))}_remove(e,t=!0){if(!e)return!1;const i=this._observers.indexOf(e);return-1!==i&&(t&&this._numObserversMarkedAsDeleted--,this._observers.splice(i,1),!0)}makeObserverTopPriority(e){this._remove(e,!1),this._observers.unshift(e)}makeObserverBottomPriority(e){this._remove(e,!1),this._observers.push(e)}notifyObservers(e,t=-1,i,s,r){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=e),!this._observers.length)return!0;const n=this._eventState;n.mask=t,n.target=i,n.currentTarget=s,n.skipNextObservers=!1,n.lastReturnValue=e,n.userInfo=r;for(const i of this._observers)if(!i._willBeUnregistered&&(i.mask&t&&(i.unregisterOnNextCall&&this._deferUnregister(i),i.scope?n.lastReturnValue=i.callback.apply(i.scope,[e,n]):n.lastReturnValue=i.callback(e,n)),n.skipNextObservers))return!1;return!0}notifyObserver(e,t,i=-1){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=t),e._willBeUnregistered)return;const s=this._eventState;s.mask=i,s.skipNextObservers=!1,e.unregisterOnNextCall&&this._deferUnregister(e),e.callback(t,s)}hasObservers(){return this._observers.length-this._numObserversMarkedAsDeleted>0}clear(){for(;this._observers.length;){const e=this._observers.pop();e&&(e._remove=null)}this._onObserverAdded=null,this._numObserversMarkedAsDeleted=0,this.cleanLastNotifiedState()}cleanLastNotifiedState(){this._hasNotified=!1,this._lastNotifiedValue=void 0}clone(){const e=new a;return e._observers=this._observers.slice(0),e}hasSpecificMask(e=-1){for(const t of this._observers)if(t.mask&e||t.mask===e)return!0;return!1}}class l{static WithinEpsilon(e,t,i=1401298e-51){return Math.abs(e-t)<=i}static ToHex(e){const t=e.toString(16);return e<=15?("0"+t).toUpperCase():t.toUpperCase()}static Sign(e){return 0==(e=+e)||isNaN(e)?e:e>0?1:-1}static Clamp(e,t=0,i=1){return Math.min(i,Math.max(t,e))}static Log2(e){return Math.log(e)*Math.LOG2E}static ILog2(e){if(Math.log2)return Math.floor(Math.log2(e));if(e<0)return NaN;if(0===e)return-1/0;let t=0;if(e<1){for(;e<1;)t++,e*=2;t=-t}else if(e>1)for(;e>1;)t++,e=Math.floor(e/2);return t}static Repeat(e,t){return e-Math.floor(e/t)*t}static Normalize(e,t,i){return(e-t)/(i-t)}static Denormalize(e,t,i){return e*(i-t)+t}static DeltaAngle(e,t){let i=l.Repeat(t-e,360);return i>180&&(i-=360),i}static PingPong(e,t){const i=l.Repeat(e,2*t);return t-Math.abs(i-t)}static SmoothStep(e,t,i){let s=l.Clamp(i);return s=-2*s*s*s+3*s*s,t*s+e*(1-s)}static MoveTowards(e,t,i){let s=0;return s=Math.abs(t-e)<=i?t:e+l.Sign(t-e)*i,s}static MoveTowardsAngle(e,t,i){const s=l.DeltaAngle(e,t);let r=0;return-i<s&&s<i?r=t:(t=e+s,r=l.MoveTowards(e,t,i)),r}static Lerp(e,t,i){return e+(t-e)*i}static LerpAngle(e,t,i){let s=l.Repeat(t-e,360);return s>180&&(s-=360),e+s*l.Clamp(i)}static InverseLerp(e,t,i){let s=0;return s=e!=t?l.Clamp((i-e)/(t-e)):0,s}static Hermite(e,t,i,s,r){const n=r*r,o=r*n;return e*(2*o-3*n+1)+i*(-2*o+3*n)+t*(o-2*n+r)+s*(o-n)}static Hermite1stDerivative(e,t,i,s,r){const n=r*r;return 6*(n-r)*e+(3*n-4*r+1)*t+6*(-n+r)*i+(3*n-2*r)*s}static RandomRange(e,t){return e===t?e:Math.random()*(t-e)+e}static RangeToPercent(e,t,i){return(e-t)/(i-t)}static PercentToRange(e,t,i){return(i-t)*e+t}static NormalizeRadians(e){return e-l.TwoPi*Math.floor((e+Math.PI)/l.TwoPi)}static HCF(e,t){const i=e%t;return 0===i?t:l.HCF(t,i)}}l.TwoPi=2*Math.PI;const h=1/2.2,c=2.2,u=(Math.sqrt(5),.001);class d{static BuildArray(e,t){const i=[];for(let s=0;s<e;++s)i.push(t());return i}static BuildTuple(e,t){return d.BuildArray(e,t)}}const p=["push","splice","pop","shift","unshift"];function _(e,t){const i=p.map((i=>function(e,t,i){const s=e[t];if("function"!=typeof s)return null;const r=function(){const s=e.length,n=r.previous.apply(e,arguments);return i(t,s),n};return s.next=r,r.previous=s,e[t]=r,()=>{const i=r.previous;if(!i)return;const s=r.next;s?(i.next=s,s.previous=i):(i.next=void 0,e[t]=i),r.next=void 0,r.previous=void 0}}(e,i,t)));return()=>{i.forEach((e=>{null==e||e()}))}}const f={};function m(e,t){f[e]=t}function g(e){return f[e]}class v{static SetMatrixPrecision(e){if(v.MatrixTrackPrecisionChange=!1,e&&!v.MatrixUse64Bits&&v.MatrixTrackedMatrices)for(let e=0;e<v.MatrixTrackedMatrices.length;++e){const t=v.MatrixTrackedMatrices[e],i=t._m;t._m=new Array(16);for(let e=0;e<16;++e)t._m[e]=i[e]}v.MatrixUse64Bits=e,v.MatrixCurrentType=v.MatrixUse64Bits?Array:Float32Array,v.MatrixTrackedMatrices=null}}v.MatrixUse64Bits=!1,v.MatrixTrackPrecisionChange=!0,v.MatrixCurrentType=Float32Array,v.MatrixTrackedMatrices=[];class x{static get LastCreatedEngine(){return 0===this.Instances.length?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this._LastCreatedScene}}x.Instances=[],x.OnEnginesDisposedObservable=new a,x._LastCreatedScene=null,x.UseFallbackTexture=!0,x.FallbackTexture="";const T=e=>parseInt(e.toString().replace(/\W/g,""));class E{constructor(e=0,t=0){this.x=e,this.y=t}toString(){return`{X: ${this.x} Y: ${this.y}}`}getClassName(){return"Vector2"}getHashCode(){let e=T(this.x);return e=397*e^T(this.y),e}toArray(e,t=0){return e[t]=this.x,e[t+1]=this.y,this}fromArray(e,t=0){return E.FromArrayToRef(e,t,this),this}asArray(){const e=[];return this.toArray(e,0),e}copyFrom(e){return this.x=e.x,this.y=e.y,this}copyFromFloats(e,t){return this.x=e,this.y=t,this}set(e,t){return this.copyFromFloats(e,t)}add(e){return new this.constructor(this.x+e.x,this.y+e.y)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t}addInPlace(e){return this.x+=e.x,this.y+=e.y,this}addVector3(e){return new this.constructor(this.x+e.x,this.y+e.y)}subtract(e){return new this.constructor(this.x-e.x,this.y-e.y)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this}multiply(e){return new this.constructor(this.x*e.x,this.y*e.y)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t}multiplyByFloats(e,t){return new this.constructor(this.x*e,this.y*t)}divide(e){return new this.constructor(this.x/e.x,this.y/e.y)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t}divideInPlace(e){return this.divideToRef(e,this)}negate(){return new this.constructor(-this.x,-this.y)}negateInPlace(){return this.x*=-1,this.y*=-1,this}negateToRef(e){return e.copyFromFloats(-1*this.x,-1*this.y)}scaleInPlace(e){return this.x*=e,this.y*=e,this}scale(e){const t=new this.constructor(0,0);return this.scaleToRef(e,t),t}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y}equalsWithEpsilon(e,t=u){return e&&l.WithinEpsilon(this.x,e.x,t)&&l.WithinEpsilon(this.y,e.y,t)}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y))}rotateToRef(e,t){const i=Math.cos(e),s=Math.sin(e),r=i*this.x-s*this.y,n=s*this.x+i*this.y;return t.x=r,t.y=n,t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new this.constructor(0,0);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return 0===t||1===t?e.copyFromFloats(this.x,this.y):this.scaleToRef(1/t,e)}clone(){return new this.constructor(this.x,this.y)}dot(e){return this.x*e.x+this.y*e.y}static Zero(){return new E(0,0)}static One(){return new E(1,1)}static Random(e=0,t=1){return new E(l.RandomRange(e,t),l.RandomRange(e,t))}static get ZeroReadOnly(){return E._ZeroReadOnly}static FromArray(e,t=0){return new E(e[t],e[t+1])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i}static CatmullRom(e,t,i,s,r){const n=r*r,o=r*n,a=.5*(2*t.x+(-e.x+i.x)*r+(2*e.x-5*t.x+4*i.x-s.x)*n+(-e.x+3*t.x-3*i.x+s.x)*o),l=.5*(2*t.y+(-e.y+i.y)*r+(2*e.y-5*t.y+4*i.y-s.y)*n+(-e.y+3*t.y-3*i.y+s.y)*o);return new e.constructor(a,l)}static Clamp(e,t,i){let s=e.x;s=s>i.x?i.x:s,s=s<t.x?t.x:s;let r=e.y;return r=r>i.y?i.y:r,r=r<t.y?t.y:r,new e.constructor(s,r)}static Hermite(e,t,i,s,r){const n=r*r,o=r*n,a=2*o-3*n+1,l=-2*o+3*n,h=o-2*n+r,c=o-n,u=e.x*a+i.x*l+t.x*h+s.x*c,d=e.y*a+i.y*l+t.y*h+s.y*c;return new e.constructor(u,d)}static Hermite1stDerivative(e,t,i,s,r){const n=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const o=r*r;return n.x=6*(o-r)*e.x+(3*o-4*r+1)*t.x+6*(-o+r)*i.x+(3*o-2*r)*s.x,n.y=6*(o-r)*e.y+(3*o-4*r+1)*t.y+6*(-o+r)*i.y+(3*o-2*r)*s.y,n}static Lerp(e,t,i){const s=e.x+(t.x-e.x)*i,r=e.y+(t.y-e.y)*i;return new e.constructor(s,r)}static Dot(e,t){return e.x*t.x+e.y*t.y}static Normalize(e){const t=new e.constructor;return E.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Minimize(e,t){const i=e.x<t.x?e.x:t.x,s=e.y<t.y?e.y:t.y;return new e.constructor(i,s)}static Maximize(e,t){const i=e.x>t.x?e.x:t.x,s=e.y>t.y?e.y:t.y;return new e.constructor(i,s)}static Transform(e,t){const i=new e.constructor;return E.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){const s=t.m,r=e.x*s[0]+e.y*s[4]+s[12],n=e.x*s[1]+e.y*s[5]+s[13];return i.x=r,i.y=n,i}static PointInTriangle(e,t,i,s){const r=.5*(-i.y*s.x+t.y*(-i.x+s.x)+t.x*(i.y-s.y)+i.x*s.y),n=r<0?-1:1,o=(t.y*s.x-t.x*s.y+(s.y-t.y)*e.x+(t.x-s.x)*e.y)*n,a=(t.x*i.y-t.y*i.x+(t.y-i.y)*e.x+(i.x-t.x)*e.y)*n;return o>0&&a>0&&o+a<2*r*n}static Distance(e,t){return Math.sqrt(E.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,s=e.y-t.y;return i*i+s*s}static Center(e,t){const i=new e.constructor;return E.CenterToRef(e,t,i)}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2)}static DistanceOfPointFromSegment(e,t,i){const s=E.DistanceSquared(t,i);if(0===s)return E.Distance(e,t);const r=i.subtract(t),n=Math.max(0,Math.min(1,E.Dot(e.subtract(t),r)/s)),o=t.add(r.multiplyByFloats(n,n));return E.Distance(e,o)}}E._ZeroReadOnly=E.Zero();class S{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}constructor(e=0,t=0,i=0){this._isDirty=!0,this._x=e,this._y=t,this._z=i}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z}}`}getClassName(){return"Vector3"}getHashCode(){let e=T(this._x);return e=397*e^T(this._y),e=397*e^T(this._z),e}asArray(){const e=[];return this.toArray(e,0),e}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,this}fromArray(e,t=0){return S.FromArrayToRef(e,t,this),this}toQuaternion(){return C.RotationYawPitchRoll(this._y,this._x,this._z)}addInPlace(e){return this.addInPlaceFromFloats(e._x,e._y,e._z)}addInPlaceFromFloats(e,t,i){return this._x+=e,this._y+=t,this._z+=i,this._isDirty=!0,this}add(e){return new this.constructor(this._x+e._x,this._y+e._y,this._z+e._z)}addToRef(e,t){return t.copyFromFloats(this._x+e._x,this._y+e._y,this._z+e._z)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._isDirty=!0,this}subtract(e){return new this.constructor(this._x-e._x,this._y-e._y,this._z-e._z)}subtractToRef(e,t){return this.subtractFromFloatsToRef(e._x,e._y,e._z,t)}subtractFromFloats(e,t,i){return new this.constructor(this._x-e,this._y-t,this._z-i)}subtractFromFloatsToRef(e,t,i,s){return s.copyFromFloats(this._x-e,this._y-t,this._z-i)}negate(){return new this.constructor(-this._x,-this._y,-this._z)}negateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}negateToRef(e){return e.copyFromFloats(-1*this._x,-1*this._y,-1*this._z)}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._isDirty=!0,this}scale(e){return new this.constructor(this._x*e,this._y*e,this._z*e)}scaleToRef(e,t){return t.copyFromFloats(this._x*e,this._y*e,this._z*e)}getNormalToRef(e){const t=this.length();let i=Math.acos(this.y/t);const s=Math.atan2(this.z,this.x);i>Math.PI/2?i-=Math.PI/2:i+=Math.PI/2;const r=t*Math.sin(i)*Math.cos(s),n=t*Math.cos(i),o=t*Math.sin(i)*Math.sin(s);return e.set(r,n,o),e}applyRotationQuaternionToRef(e,t){const i=this._x,s=this._y,r=this._z,n=e._x,o=e._y,a=e._z,l=e._w,h=2*(o*r-a*s),c=2*(a*i-n*r),u=2*(n*s-o*i);return t._x=i+l*h+o*u-a*c,t._y=s+l*c+a*h-n*u,t._z=r+l*u+n*c-o*h,t._isDirty=!0,t}applyRotationQuaternionInPlace(e){return this.applyRotationQuaternionToRef(e,this)}applyRotationQuaternion(e){return this.applyRotationQuaternionToRef(e,new this.constructor)}scaleAndAddToRef(e,t){return t.addInPlaceFromFloats(this._x*e,this._y*e,this._z*e)}projectOnPlane(e,t){const i=new this.constructor;return this.projectOnPlaneToRef(e,t,i),i}projectOnPlaneToRef(e,t,i){const s=e.normal,r=e.d,n=A.Vector3[0];this.subtractToRef(t,n),n.normalize();const o=S.Dot(n,s);if(Math.abs(o)<1e-10)i.setAll(1/0);else{const e=-(S.Dot(t,s)+r)/o,a=n.scaleInPlace(e);t.addToRef(a,i)}return i}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z}equalsWithEpsilon(e,t=u){return e&&l.WithinEpsilon(this._x,e._x,t)&&l.WithinEpsilon(this._y,e._y,t)&&l.WithinEpsilon(this._z,e._z,t)}equalsToFloats(e,t,i){return this._x===e&&this._y===t&&this._z===i}multiplyInPlace(e){return this._x*=e._x,this._y*=e._y,this._z*=e._z,this._isDirty=!0,this}multiply(e){return this.multiplyByFloats(e._x,e._y,e._z)}multiplyToRef(e,t){return t.copyFromFloats(this._x*e._x,this._y*e._y,this._z*e._z)}multiplyByFloats(e,t,i){return new this.constructor(this._x*e,this._y*t,this._z*i)}divide(e){return new this.constructor(this._x/e._x,this._y/e._y,this._z/e._z)}divideToRef(e,t){return t.copyFromFloats(this._x/e._x,this._y/e._y,this._z/e._z)}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e._x,e._y,e._z)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e._x,e._y,e._z)}minimizeInPlaceFromFloats(e,t,i){return e<this._x&&(this.x=e),t<this._y&&(this.y=t),i<this._z&&(this.z=i),this}maximizeInPlaceFromFloats(e,t,i){return e>this._x&&(this.x=e),t>this._y&&(this.y=t),i>this._z&&(this.z=i),this}isNonUniformWithinEpsilon(e){const t=Math.abs(this._x),i=Math.abs(this._y);if(!l.WithinEpsilon(t,i,e))return!0;const s=Math.abs(this._z);return!l.WithinEpsilon(t,s,e)||!l.WithinEpsilon(i,s,e)}get isNonUniform(){const e=Math.abs(this._x);return e!==Math.abs(this._y)||e!==Math.abs(this._z)}floor(){return new this.constructor(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z))}fract(){return new this.constructor(this._x-Math.floor(this._x),this._y-Math.floor(this._y),this._z-Math.floor(this._z))}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z}get hasAZeroComponent(){return this._x*this._y*this._z==0}normalize(){return this.normalizeFromLength(this.length())}reorderInPlace(e){if("xyz"===(e=e.toLowerCase()))return this;const t=A.Vector3[0].copyFrom(this);return this.x=t[e[0]],this.y=t[e[1]],this.z=t[e[2]],this}rotateByQuaternionToRef(e,t){return e.toRotationMatrix(A.Matrix[0]),S.TransformCoordinatesToRef(this,A.Matrix[0],t),t}rotateByQuaternionAroundPointToRef(e,t,i){return this.subtractToRef(t,A.Vector3[0]),A.Vector3[0].rotateByQuaternionToRef(e,A.Vector3[0]),t.addToRef(A.Vector3[0],i),i}cross(e){const t=new this.constructor;return S.CrossToRef(this,e,t)}normalizeFromLength(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new this.constructor(0,0,0);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return 0===t||1===t?e.copyFromFloats(this._x,this._y,this._z):this.scaleToRef(1/t,e)}clone(){return new this.constructor(this._x,this._y,this._z)}copyFrom(e){return this.copyFromFloats(e._x,e._y,e._z)}copyFromFloats(e,t,i){return this._x=e,this._y=t,this._z=i,this._isDirty=!0,this}set(e,t,i){return this.copyFromFloats(e,t,i)}setAll(e){return this._x=this._y=this._z=e,this._isDirty=!0,this}static GetClipFactor(e,t,i,s){const r=S.Dot(e,i);return(r-s)/(r-S.Dot(t,i))}static GetAngleBetweenVectors(e,t,i){const s=e.normalizeToRef(A.Vector3[1]),r=t.normalizeToRef(A.Vector3[2]);let n=S.Dot(s,r);n=l.Clamp(n,-1,1);const o=Math.acos(n),a=A.Vector3[3];return S.CrossToRef(s,r,a),S.Dot(a,i)>0?isNaN(o)?0:o:isNaN(o)?-Math.PI:-Math.acos(n)}static GetAngleBetweenVectorsOnPlane(e,t,i){A.Vector3[0].copyFrom(e);const s=A.Vector3[0];A.Vector3[1].copyFrom(t);const r=A.Vector3[1];A.Vector3[2].copyFrom(i);const n=A.Vector3[2],o=A.Vector3[3],a=A.Vector3[4];s.normalize(),r.normalize(),n.normalize(),S.CrossToRef(n,s,o),S.CrossToRef(o,n,a);const h=Math.atan2(S.Dot(r,o),S.Dot(r,a));return l.NormalizeRadians(h)}static PitchYawRollToMoveBetweenPointsToRef(e,t,i){const s=R.Vector3[0];return t.subtractToRef(e,s),i._y=Math.atan2(s.x,s.z)||0,i._x=Math.atan2(Math.sqrt(s.x**2+s.z**2),s.y)||0,i._z=0,i._isDirty=!0,i}static PitchYawRollToMoveBetweenPoints(e,t){const i=S.Zero();return S.PitchYawRollToMoveBetweenPointsToRef(e,t,i)}static SlerpToRef(e,t,i,s){i=l.Clamp(i,0,1);const r=A.Vector3[0],n=A.Vector3[1];r.copyFrom(e);const o=r.length();r.normalizeFromLength(o),n.copyFrom(t);const a=n.length();n.normalizeFromLength(a);const h=S.Dot(r,n);let c,d;if(h<1-u){const e=Math.acos(h),t=1/Math.sin(e);c=Math.sin((1-i)*e)*t,d=Math.sin(i*e)*t}else c=1-i,d=i;return r.scaleInPlace(c),n.scaleInPlace(d),s.copyFrom(r).addInPlace(n),s.scaleInPlace(l.Lerp(o,a,i)),s}static SmoothToRef(e,t,i,s,r){return S.SlerpToRef(e,t,0===s?1:i/s,r),r}static FromArray(e,t=0){return new S(e[t],e[t+1],e[t+2])}static FromFloatArray(e,t){return S.FromArray(e,t)}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._isDirty=!0,i}static FromFloatArrayToRef(e,t,i){return S.FromArrayToRef(e,t,i)}static FromFloatsToRef(e,t,i,s){return s.copyFromFloats(e,t,i),s}static Zero(){return new S(0,0,0)}static One(){return new S(1,1,1)}static Up(){return new S(0,1,0)}static get UpReadOnly(){return S._UpReadOnly}static get DownReadOnly(){return S._DownReadOnly}static get RightReadOnly(){return S._RightReadOnly}static get LeftReadOnly(){return S._LeftReadOnly}static get LeftHandedForwardReadOnly(){return S._LeftHandedForwardReadOnly}static get RightHandedForwardReadOnly(){return S._RightHandedForwardReadOnly}static get LeftHandedBackwardReadOnly(){return S._LeftHandedBackwardReadOnly}static get RightHandedBackwardReadOnly(){return S._RightHandedBackwardReadOnly}static get ZeroReadOnly(){return S._ZeroReadOnly}static get OneReadOnly(){return S._OneReadOnly}static Down(){return new S(0,-1,0)}static Forward(e=!1){return new S(0,0,e?-1:1)}static Backward(e=!1){return new S(0,0,e?1:-1)}static Right(){return new S(1,0,0)}static Left(){return new S(-1,0,0)}static Random(e=0,t=1){return new S(l.RandomRange(e,t),l.RandomRange(e,t),l.RandomRange(e,t))}static TransformCoordinates(e,t){const i=S.Zero();return S.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){return S.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,s,r){const n=s.m,o=e*n[0]+t*n[4]+i*n[8]+n[12],a=e*n[1]+t*n[5]+i*n[9]+n[13],l=e*n[2]+t*n[6]+i*n[10]+n[14],h=1/(e*n[3]+t*n[7]+i*n[11]+n[15]);return r._x=o*h,r._y=a*h,r._z=l*h,r._isDirty=!0,r}static TransformNormal(e,t){const i=S.Zero();return S.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){return this.TransformNormalFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformNormalFromFloatsToRef(e,t,i,s,r){const n=s.m;return r._x=e*n[0]+t*n[4]+i*n[8],r._y=e*n[1]+t*n[5]+i*n[9],r._z=e*n[2]+t*n[6]+i*n[10],r._isDirty=!0,r}static CatmullRom(e,t,i,s,r){const n=r*r,o=r*n,a=.5*(2*t._x+(-e._x+i._x)*r+(2*e._x-5*t._x+4*i._x-s._x)*n+(-e._x+3*t._x-3*i._x+s._x)*o),l=.5*(2*t._y+(-e._y+i._y)*r+(2*e._y-5*t._y+4*i._y-s._y)*n+(-e._y+3*t._y-3*i._y+s._y)*o),h=.5*(2*t._z+(-e._z+i._z)*r+(2*e._z-5*t._z+4*i._z-s._z)*n+(-e._z+3*t._z-3*i._z+s._z)*o);return new e.constructor(a,l,h)}static Clamp(e,t,i){const s=new e.constructor;return S.ClampToRef(e,t,i,s),s}static ClampToRef(e,t,i,s){let r=e._x;r=r>i._x?i._x:r,r=r<t._x?t._x:r;let n=e._y;n=n>i._y?i._y:n,n=n<t._y?t._y:n;let o=e._z;return o=o>i._z?i._z:o,o=o<t._z?t._z:o,s.copyFromFloats(r,n,o),s}static CheckExtends(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e)}static Hermite(e,t,i,s,r){const n=r*r,o=r*n,a=2*o-3*n+1,l=-2*o+3*n,h=o-2*n+r,c=o-n,u=e._x*a+i._x*l+t._x*h+s._x*c,d=e._y*a+i._y*l+t._y*h+s._y*c,p=e._z*a+i._z*l+t._z*h+s._z*c;return new e.constructor(u,d,p)}static Hermite1stDerivative(e,t,i,s,r){const n=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const o=r*r;return n._x=6*(o-r)*e._x+(3*o-4*r+1)*t._x+6*(-o+r)*i._x+(3*o-2*r)*s._x,n._y=6*(o-r)*e._y+(3*o-4*r+1)*t._y+6*(-o+r)*i._y+(3*o-2*r)*s._y,n._z=6*(o-r)*e._z+(3*o-4*r+1)*t._z+6*(-o+r)*i._z+(3*o-2*r)*s._z,n._isDirty=!0,n}static Lerp(e,t,i){const s=new e.constructor(0,0,0);return S.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){return s._x=e._x+(t._x-e._x)*i,s._y=e._y+(t._y-e._y)*i,s._z=e._z+(t._z-e._z)*i,s._isDirty=!0,s}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z}static Cross(e,t){const i=new e.constructor;return S.CrossToRef(e,t,i),i}static CrossToRef(e,t,i){const s=e._y*t._z-e._z*t._y,r=e._z*t._x-e._x*t._z,n=e._x*t._y-e._y*t._x;return i.copyFromFloats(s,r,n),i}static Normalize(e){const t=S.Zero();return S.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Project(e,t,i,s){const r=new e.constructor;return S.ProjectToRef(e,t,i,s,r),r}static ProjectToRef(e,t,i,s,r){const n=s.width,o=s.height,a=s.x,l=s.y,h=A.Matrix[1];y.FromValuesToRef(n/2,0,0,0,0,-o/2,0,0,0,0,.5,0,a+n/2,o/2+l,.5,1,h);const c=A.Matrix[0];return t.multiplyToRef(i,c),c.multiplyToRef(h,c),S.TransformCoordinatesToRef(e,c,r),r}static Reflect(e,t){return this.ReflectToRef(e,t,new S)}static ReflectToRef(e,t,i){const s=R.Vector3[0];return s.copyFrom(t).scaleInPlace(2*S.Dot(e,t)),i.copyFrom(e).subtractInPlace(s)}static _UnprojectFromInvertedMatrixToRef(e,t,i){S.TransformCoordinatesToRef(e,t,i);const s=t.m,r=e._x*s[3]+e._y*s[7]+e._z*s[11]+s[15];return l.WithinEpsilon(r,1)&&i.scaleInPlace(1/r),i}static UnprojectFromTransform(e,t,i,s,r){return this.Unproject(e,t,i,s,r,y.IdentityReadOnly)}static Unproject(e,t,i,s,r,n){const o=new e.constructor;return S.UnprojectToRef(e,t,i,s,r,n,o),o}static UnprojectToRef(e,t,i,s,r,n,o){return S.UnprojectFloatsToRef(e._x,e._y,e._z,t,i,s,r,n,o),o}static UnprojectFloatsToRef(e,t,i,s,r,n,o,a,l){var h;const c=A.Matrix[0];n.multiplyToRef(o,c),c.multiplyToRef(a,c),c.invert();const u=A.Vector3[0];return u.x=e/s*2-1,u.y=-(t/r*2-1),(null===(h=x.LastCreatedEngine)||void 0===h?void 0:h.isNDCHalfZRange)?u.z=i:u.z=2*i-1,S._UnprojectFromInvertedMatrixToRef(u,c,l),l}static Minimize(e,t){const i=new e.constructor;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new e.constructor;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(S.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e._x-t._x,s=e._y-t._y,r=e._z-t._z;return i*i+s*s+r*r}static ProjectOnTriangleToRef(e,t,i,s,r){const n=A.Vector3[0],o=A.Vector3[1],a=A.Vector3[2],h=A.Vector3[3],c=A.Vector3[4];i.subtractToRef(t,n),s.subtractToRef(t,o),s.subtractToRef(i,a);const d=n.length(),p=o.length(),_=a.length();if(d<u||p<u||_<u)return r.copyFrom(t),S.Distance(e,t);e.subtractToRef(t,c),S.CrossToRef(n,o,h);const f=h.length();if(f<u)return r.copyFrom(t),S.Distance(e,t);h.normalizeFromLength(f);let m=c.length();if(m<u)return r.copyFrom(t),0;c.normalizeFromLength(m);const g=S.Dot(h,c),v=A.Vector3[5],x=A.Vector3[6];v.copyFrom(h).scaleInPlace(-m*g),x.copyFrom(e).addInPlace(v);const T=A.Vector3[4],E=A.Vector3[5],b=A.Vector3[7],C=A.Vector3[8];T.copyFrom(n).scaleInPlace(1/d),C.copyFrom(o).scaleInPlace(1/p),T.addInPlace(C).scaleInPlace(-1),E.copyFrom(n).scaleInPlace(-1/d),C.copyFrom(a).scaleInPlace(1/_),E.addInPlace(C).scaleInPlace(-1),b.copyFrom(a).scaleInPlace(-1/_),C.copyFrom(o).scaleInPlace(-1/p),b.addInPlace(C).scaleInPlace(-1);const y=A.Vector3[9];let R;y.copyFrom(x).subtractInPlace(t),S.CrossToRef(T,y,C),R=S.Dot(C,h);const I=R;y.copyFrom(x).subtractInPlace(i),S.CrossToRef(E,y,C),R=S.Dot(C,h);const P=R;y.copyFrom(x).subtractInPlace(s),S.CrossToRef(b,y,C),R=S.Dot(C,h);const M=R,O=A.Vector3[10];let D,N;I>0&&P<0?(O.copyFrom(n),D=t,N=i):P>0&&M<0?(O.copyFrom(a),D=i,N=s):(O.copyFrom(o).scaleInPlace(-1),D=s,N=t);const F=A.Vector3[9],w=A.Vector3[4];if(D.subtractToRef(x,C),N.subtractToRef(x,F),S.CrossToRef(C,F,w),!(S.Dot(w,h)<0))return r.copyFrom(x),Math.abs(m*g);const L=A.Vector3[5];S.CrossToRef(O,w,L),L.normalize();const B=A.Vector3[9];B.copyFrom(D).subtractInPlace(x);const U=B.length();if(U<u)return r.copyFrom(D),S.Distance(e,D);B.normalizeFromLength(U);const V=S.Dot(L,B),k=A.Vector3[7];k.copyFrom(x).addInPlace(L.scaleInPlace(U*V)),C.copyFrom(k).subtractInPlace(D),m=O.length(),O.normalizeFromLength(m);let G=S.Dot(C,O)/Math.max(m,u);return G=l.Clamp(G,0,1),k.copyFrom(D).addInPlace(O.scaleInPlace(G*m)),r.copyFrom(k),S.Distance(e,k)}static Center(e,t){return S.CenterToRef(e,t,S.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e._x+t._x)/2,(e._y+t._y)/2,(e._z+t._z)/2)}static RotationFromAxis(e,t,i){const s=new e.constructor;return S.RotationFromAxisToRef(e,t,i,s),s}static RotationFromAxisToRef(e,t,i,s){const r=A.Quaternion[0];return C.RotationQuaternionFromAxisToRef(e,t,i,r),r.toEulerAnglesToRef(s),s}}S._UpReadOnly=S.Up(),S._DownReadOnly=S.Down(),S._LeftHandedForwardReadOnly=S.Forward(!1),S._RightHandedForwardReadOnly=S.Forward(!0),S._LeftHandedBackwardReadOnly=S.Backward(!1),S._RightHandedBackwardReadOnly=S.Backward(!0),S._RightReadOnly=S.Right(),S._LeftReadOnly=S.Left(),S._ZeroReadOnly=S.Zero(),S._OneReadOnly=S.One();class b{constructor(e=0,t=0,i=0,s=0){this.x=e,this.y=t,this.z=i,this.w=s}toString(){return`{X: ${this.x} Y: ${this.y} Z: ${this.z} W: ${this.w}}`}getClassName(){return"Vector4"}getHashCode(){let e=T(this.x);return e=397*e^T(this.y),e=397*e^T(this.z),e=397*e^T(this.w),e}asArray(){const e=[];return this.toArray(e,0),e}toArray(e,t){return void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this}fromArray(e,t=0){return b.FromArrayToRef(e,t,this),this}addInPlace(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add(e){return new this.constructor(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t.w=this.w+e.w,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subtract(e){return new this.constructor(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t.w=this.w-e.w,t}subtractFromFloats(e,t,i,s){return new this.constructor(this.x-e,this.y-t,this.z-i,this.w-s)}subtractFromFloatsToRef(e,t,i,s,r){return r.x=this.x-e,r.y=this.y-t,r.z=this.z-i,r.w=this.w-s,r}negate(){return new this.constructor(-this.x,-this.y,-this.z,-this.w)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this}negateToRef(e){return e.copyFromFloats(-1*this.x,-1*this.y,-1*this.z,-1*this.w)}scaleInPlace(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}scale(e){return new this.constructor(this.x*e,this.y*e,this.z*e,this.w*e)}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t.z+=this.z*e,t.w+=this.w*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsWithEpsilon(e,t=u){return e&&l.WithinEpsilon(this.x,e.x,t)&&l.WithinEpsilon(this.y,e.y,t)&&l.WithinEpsilon(this.z,e.z,t)&&l.WithinEpsilon(this.w,e.w,t)}equalsToFloats(e,t,i,s){return this.x===e&&this.y===t&&this.z===i&&this.w===s}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiply(e){return new this.constructor(this.x*e.x,this.y*e.y,this.z*e.z,this.w*e.w)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z,t.w=this.w*e.w,t}multiplyByFloats(e,t,i,s){return new this.constructor(this.x*e,this.y*t,this.z*i,this.w*s)}divide(e){return new this.constructor(this.x/e.x,this.y/e.y,this.z/e.z,this.w/e.w)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t.z=this.z/e.z,t.w=this.w/e.w,t}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}maximizeInPlace(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z),Math.floor(this.w))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y),this.z-Math.floor(this.z),this.w-Math.floor(this.w))}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new this.constructor(0,0,0,0);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return 0===t||1===t?e.copyFromFloats(this.x,this.y,this.z,this.w):this.scaleToRef(1/t,e)}toVector3(){return new S(this.x,this.y,this.z)}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}copyFromFloats(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this}set(e,t,i,s){return this.copyFromFloats(e,t,i,s)}setAll(e){return this.x=this.y=this.z=this.w=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}static FromArray(e,t){return t||(t=0),new b(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i.z=e[t+2],i.w=e[t+3],i}static FromFloatArrayToRef(e,t,i){return b.FromArrayToRef(e,t,i),i}static FromFloatsToRef(e,t,i,s,r){return r.x=e,r.y=t,r.z=i,r.w=s,r}static Zero(){return new b(0,0,0,0)}static One(){return new b(1,1,1,1)}static Random(e=0,t=1){return new b(l.RandomRange(e,t),l.RandomRange(e,t),l.RandomRange(e,t),l.RandomRange(e,t))}static get ZeroReadOnly(){return b._ZeroReadOnly}static Normalize(e){const t=b.Zero();return b.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Minimize(e,t){const i=new e.constructor;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new e.constructor;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(b.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,s=e.y-t.y,r=e.z-t.z,n=e.w-t.w;return i*i+s*s+r*r+n*n}static Center(e,t){return b.CenterToRef(e,t,b.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2,(e.w+t.w)/2)}static TransformCoordinates(e,t){const i=b.Zero();return b.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){return b.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,s,r){const n=s.m,o=e*n[0]+t*n[4]+i*n[8]+n[12],a=e*n[1]+t*n[5]+i*n[9]+n[13],l=e*n[2]+t*n[6]+i*n[10]+n[14],h=e*n[3]+t*n[7]+i*n[11]+n[15];return r.x=o,r.y=a,r.z=l,r.w=h,r}static TransformNormal(e,t){const i=new e.constructor;return b.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){const s=t.m,r=e.x*s[0]+e.y*s[4]+e.z*s[8],n=e.x*s[1]+e.y*s[5]+e.z*s[9],o=e.x*s[2]+e.y*s[6]+e.z*s[10];return i.x=r,i.y=n,i.z=o,i.w=e.w,i}static TransformNormalFromFloatsToRef(e,t,i,s,r,n){const o=r.m;return n.x=e*o[0]+t*o[4]+i*o[8],n.y=e*o[1]+t*o[5]+i*o[9],n.z=e*o[2]+t*o[6]+i*o[10],n.w=s,n}static FromVector3(e,t=0){return new b(e._x,e._y,e._z,t)}static Dot(e,t){return e.dot(t)}}b._ZeroReadOnly=b.Zero();class C{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}get w(){return this._w}set w(e){this._w=e,this._isDirty=!0}constructor(e=0,t=0,i=0,s=1){this._isDirty=!0,this._x=e,this._y=t,this._z=i,this._w=s}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z} W: ${this._w}}`}getClassName(){return"Quaternion"}getHashCode(){let e=T(this._x);return e=397*e^T(this._y),e=397*e^T(this._z),e=397*e^T(this._w),e}asArray(){return[this._x,this._y,this._z,this._w]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,this}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z&&this._w===e._w}equalsWithEpsilon(e,t=u){return e&&l.WithinEpsilon(this._x,e._x,t)&&l.WithinEpsilon(this._y,e._y,t)&&l.WithinEpsilon(this._z,e._z,t)&&l.WithinEpsilon(this._w,e._w,t)}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copyFrom(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._w=e._w,this._isDirty=!0,this}copyFromFloats(e,t,i,s){return this._x=e,this._y=t,this._z=i,this._w=s,this._isDirty=!0,this}set(e,t,i,s){return this.copyFromFloats(e,t,i,s)}add(e){return new this.constructor(this._x+e._x,this._y+e._y,this._z+e._z,this._w+e._w)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this._isDirty=!0,this}subtract(e){return new this.constructor(this._x-e._x,this._y-e._y,this._z-e._z,this._w-e._w)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this._isDirty=!0,this}scale(e){return new this.constructor(this._x*e,this._y*e,this._z*e,this._w*e)}scaleToRef(e,t){return t._x=this._x*e,t._y=this._y*e,t._z=this._z*e,t._w=this._w*e,t._isDirty=!0,t}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._w*=e,this._isDirty=!0,this}scaleAndAddToRef(e,t){return t._x+=this._x*e,t._y+=this._y*e,t._z+=this._z*e,t._w+=this._w*e,t._isDirty=!0,t}multiply(e){const t=new this.constructor(0,0,0,1);return this.multiplyToRef(e,t),t}multiplyToRef(e,t){const i=this._x*e._w+this._y*e._z-this._z*e._y+this._w*e._x,s=-this._x*e._z+this._y*e._w+this._z*e._x+this._w*e._y,r=this._x*e._y-this._y*e._x+this._z*e._w+this._w*e._z,n=-this._x*e._x-this._y*e._y-this._z*e._z+this._w*e._w;return t.copyFromFloats(i,s,r,n),t}multiplyInPlace(e){return this.multiplyToRef(e,this),this}conjugateToRef(e){return e.copyFromFloats(-this._x,-this._y,-this._z,this._w),e}conjugateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}conjugate(){return new this.constructor(-this._x,-this._y,-this._z,this._w)}invert(){const e=this.conjugate(),t=this.lengthSquared();return 0==t||1==t||e.scaleInPlace(1/t),e}invertInPlace(){this.conjugateInPlace();const e=this.lengthSquared();return 0==e||1==e||this.scaleInPlace(1/e),this}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this.lengthSquared())}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new this.constructor(0,0,0,1);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return 0===t||1===t?e.copyFromFloats(this._x,this._y,this._z,this._w):this.scaleToRef(1/t,e)}toEulerAngles(){const e=S.Zero();return this.toEulerAnglesToRef(e),e}toEulerAnglesToRef(e){const t=this._z,i=this._x,s=this._y,r=this._w,n=s*t-i*r,o=.4999999;if(n<-o)e._y=2*Math.atan2(s,r),e._x=Math.PI/2,e._z=0,e._isDirty=!0;else if(n>o)e._y=2*Math.atan2(s,r),e._x=-Math.PI/2,e._z=0,e._isDirty=!0;else{const o=r*r,a=t*t,l=i*i,h=s*s;e._z=Math.atan2(2*(i*s+t*r),-a-l+h+o),e._x=Math.asin(-2*n),e._y=Math.atan2(2*(t*i+s*r),a-l-h+o),e._isDirty=!0}return e}toRotationMatrix(e){return y.FromQuaternionToRef(this,e),e}fromRotationMatrix(e){return C.FromRotationMatrixToRef(e,this),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}static FromRotationMatrix(e){const t=new C;return C.FromRotationMatrixToRef(e,t),t}static FromRotationMatrixToRef(e,t){const i=e.m,s=i[0],r=i[4],n=i[8],o=i[1],a=i[5],l=i[9],h=i[2],c=i[6],u=i[10],d=s+a+u;let p;return d>0?(p=.5/Math.sqrt(d+1),t._w=.25/p,t._x=(c-l)*p,t._y=(n-h)*p,t._z=(o-r)*p,t._isDirty=!0):s>a&&s>u?(p=2*Math.sqrt(1+s-a-u),t._w=(c-l)/p,t._x=.25*p,t._y=(r+o)/p,t._z=(n+h)/p,t._isDirty=!0):a>u?(p=2*Math.sqrt(1+a-s-u),t._w=(n-h)/p,t._x=(r+o)/p,t._y=.25*p,t._z=(l+c)/p,t._isDirty=!0):(p=2*Math.sqrt(1+u-s-a),t._w=(o-r)/p,t._x=(n+h)/p,t._y=(l+c)/p,t._z=.25*p,t._isDirty=!0),t}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w}static AreClose(e,t,i=.1){const s=C.Dot(e,t);return 1-s*s<=i}static SmoothToRef(e,t,i,s,r){let n=0===s?1:i/s;return n=l.Clamp(n,0,1),C.SlerpToRef(e,t,n,r),r}static Zero(){return new C(0,0,0,0)}static Inverse(e){return new e.constructor(-e._x,-e._y,-e._z,e._w)}static InverseToRef(e,t){return t.set(-e._x,-e._y,-e._z,e._w),t}static Identity(){return new C(0,0,0,1)}static IsIdentity(e){return e&&0===e._x&&0===e._y&&0===e._z&&1===e._w}static RotationAxis(e,t){return C.RotationAxisToRef(e,t,new C)}static RotationAxisToRef(e,t,i){const s=Math.sin(t/2);return e.normalize(),i._w=Math.cos(t/2),i._x=e._x*s,i._y=e._y*s,i._z=e._z*s,i._isDirty=!0,i}static FromArray(e,t){return t||(t=0),new C(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._w=e[t+3],i._isDirty=!0,i}static FromEulerAngles(e,t,i){const s=new C;return C.RotationYawPitchRollToRef(t,e,i,s),s}static FromEulerAnglesToRef(e,t,i,s){return C.RotationYawPitchRollToRef(t,e,i,s),s}static FromEulerVector(e){const t=new C;return C.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromEulerVectorToRef(e,t){return C.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromUnitVectorsToRef(e,t,i,s=u){const r=S.Dot(e,t)+1;return r<s?Math.abs(e.x)>Math.abs(e.z)?i.set(-e.y,e.x,0,0):i.set(0,-e.z,e.y,0):(S.CrossToRef(e,t,R.Vector3[0]),i.set(R.Vector3[0].x,R.Vector3[0].y,R.Vector3[0].z,r)),i.normalize()}static RotationYawPitchRoll(e,t,i){const s=new C;return C.RotationYawPitchRollToRef(e,t,i,s),s}static RotationYawPitchRollToRef(e,t,i,s){const r=.5*i,n=.5*t,o=.5*e,a=Math.sin(r),l=Math.cos(r),h=Math.sin(n),c=Math.cos(n),u=Math.sin(o),d=Math.cos(o);return s._x=d*h*l+u*c*a,s._y=u*c*l-d*h*a,s._z=d*c*a-u*h*l,s._w=d*c*l+u*h*a,s._isDirty=!0,s}static RotationAlphaBetaGamma(e,t,i){const s=new C;return C.RotationAlphaBetaGammaToRef(e,t,i,s),s}static RotationAlphaBetaGammaToRef(e,t,i,s){const r=.5*(i+e),n=.5*(i-e),o=.5*t;return s._x=Math.cos(n)*Math.sin(o),s._y=Math.sin(n)*Math.sin(o),s._z=Math.sin(r)*Math.cos(o),s._w=Math.cos(r)*Math.cos(o),s._isDirty=!0,s}static RotationQuaternionFromAxis(e,t,i){const s=new C(0,0,0,0);return C.RotationQuaternionFromAxisToRef(e,t,i,s),s}static RotationQuaternionFromAxisToRef(e,t,i,s){const r=A.Matrix[0];return y.FromXYZAxesToRef(e.normalize(),t.normalize(),i.normalize(),r),C.FromRotationMatrixToRef(r,s),s}static FromLookDirectionLH(e,t){const i=new C;return C.FromLookDirectionLHToRef(e,t,i),i}static FromLookDirectionLHToRef(e,t,i){const s=A.Matrix[0];return y.LookDirectionLHToRef(e,t,s),C.FromRotationMatrixToRef(s,i),i}static FromLookDirectionRH(e,t){const i=new C;return C.FromLookDirectionRHToRef(e,t,i),i}static FromLookDirectionRHToRef(e,t,i){const s=A.Matrix[0];return y.LookDirectionRHToRef(e,t,s),C.FromRotationMatrixToRef(s,i)}static Slerp(e,t,i){const s=C.Identity();return C.SlerpToRef(e,t,i,s),s}static SlerpToRef(e,t,i,s){let r,n,o=e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w,a=!1;if(o<0&&(a=!0,o=-o),o>.999999)n=1-i,r=a?-i:i;else{const e=Math.acos(o),t=1/Math.sin(e);n=Math.sin((1-i)*e)*t,r=a?-Math.sin(i*e)*t:Math.sin(i*e)*t}return s._x=n*e._x+r*t._x,s._y=n*e._y+r*t._y,s._z=n*e._z+r*t._z,s._w=n*e._w+r*t._w,s._isDirty=!0,s}static Hermite(e,t,i,s,r){const n=r*r,o=r*n,a=2*o-3*n+1,l=-2*o+3*n,h=o-2*n+r,c=o-n,u=e._x*a+i._x*l+t._x*h+s._x*c,d=e._y*a+i._y*l+t._y*h+s._y*c,p=e._z*a+i._z*l+t._z*h+s._z*c,_=e._w*a+i._w*l+t._w*h+s._w*c;return new e.constructor(u,d,p,_)}static Hermite1stDerivative(e,t,i,s,r){const n=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const o=r*r;return n._x=6*(o-r)*e._x+(3*o-4*r+1)*t._x+6*(-o+r)*i._x+(3*o-2*r)*s._x,n._y=6*(o-r)*e._y+(3*o-4*r+1)*t._y+6*(-o+r)*i._y+(3*o-2*r)*s._y,n._z=6*(o-r)*e._z+(3*o-4*r+1)*t._z+6*(-o+r)*i._z+(3*o-2*r)*s._z,n._w=6*(o-r)*e._w+(3*o-4*r+1)*t._w+6*(-o+r)*i._w+(3*o-2*r)*s._w,n._isDirty=!0,n}static Normalize(e){const t=C.Zero();return C.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}}class y{static get Use64Bits(){return v.MatrixUse64Bits}get m(){return this._m}markAsUpdated(){this.updateFlag=y._UpdateFlagSeed++,this._isIdentity=!1,this._isIdentity3x2=!1,this._isIdentityDirty=!0,this._isIdentity3x2Dirty=!0}_updateIdentityStatus(e,t=!1,i=!1,s=!0){this._isIdentity=e,this._isIdentity3x2=e||i,this._isIdentityDirty=!this._isIdentity&&t,this._isIdentity3x2Dirty=!this._isIdentity3x2&&s}constructor(){this._isIdentity=!1,this._isIdentityDirty=!0,this._isIdentity3x2=!0,this._isIdentity3x2Dirty=!0,this.updateFlag=-1,v.MatrixTrackPrecisionChange&&v.MatrixTrackedMatrices.push(this),this._m=new v.MatrixCurrentType(16),this.markAsUpdated()}isIdentity(){if(this._isIdentityDirty){this._isIdentityDirty=!1;const e=this._m;this._isIdentity=1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]}return this._isIdentity}isIdentityAs3x2(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=!1,1!==this._m[0]||1!==this._m[5]||1!==this._m[15]||0!==this._m[1]||0!==this._m[2]||0!==this._m[3]||0!==this._m[4]||0!==this._m[6]||0!==this._m[7]||0!==this._m[8]||0!==this._m[9]||0!==this._m[10]||0!==this._m[11]||0!==this._m[12]||0!==this._m[13]||0!==this._m[14]?this._isIdentity3x2=!1:this._isIdentity3x2=!0),this._isIdentity3x2}determinant(){if(!0===this._isIdentity)return 1;const e=this._m,t=e[0],i=e[1],s=e[2],r=e[3],n=e[4],o=e[5],a=e[6],l=e[7],h=e[8],c=e[9],u=e[10],d=e[11],p=e[12],_=e[13],f=e[14],m=e[15],g=u*m-f*d,v=c*m-_*d,x=c*f-_*u,T=h*m-p*d,E=h*f-u*p,S=h*_-p*c;return t*+(o*g-a*v+l*x)+i*-(n*g-a*T+l*E)+s*+(n*v-o*T+l*S)+r*-(n*x-o*E+a*S)}toString(){return`{${this.m[0]}, ${this.m[1]}, ${this.m[2]}, ${this.m[3]}\n${this.m[4]}, ${this.m[5]}, ${this.m[6]}, ${this.m[7]}\n${this.m[8]}, ${this.m[9]}, ${this.m[10]}, ${this.m[11]}\n${this.m[12]}, ${this.m[13]}, ${this.m[14]}, ${this.m[15]}}`}toArray(){return this._m}asArray(){return this._m}invert(){return this.invertToRef(this),this}reset(){return y.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(!1),this}add(e){const t=new this.constructor;return this.addToRef(e,t),t}addToRef(e,t){const i=this._m,s=t._m,r=e.m;for(let e=0;e<16;e++)s[e]=i[e]+r[e];return t.markAsUpdated(),t}addToSelf(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]+=i[e];return this.markAsUpdated(),this}invertToRef(e){if(!0===this._isIdentity)return y.IdentityToRef(e),e;const t=this._m,i=t[0],s=t[1],r=t[2],n=t[3],o=t[4],a=t[5],l=t[6],h=t[7],c=t[8],u=t[9],d=t[10],p=t[11],_=t[12],f=t[13],m=t[14],g=t[15],v=d*g-m*p,x=u*g-f*p,T=u*m-f*d,E=c*g-_*p,S=c*m-d*_,b=c*f-_*u,C=+(a*v-l*x+h*T),A=-(o*v-l*E+h*S),R=+(o*x-a*E+h*b),I=-(o*T-a*S+l*b),P=i*C+s*A+r*R+n*I;if(0===P)return e.copyFrom(this),e;const M=1/P,O=l*g-m*h,D=a*g-f*h,N=a*m-f*l,F=o*g-_*h,w=o*m-_*l,L=o*f-_*a,B=l*p-d*h,U=a*p-u*h,V=a*d-u*l,k=o*p-c*h,G=o*d-c*l,z=o*u-c*a,W=-(s*v-r*x+n*T),H=+(i*v-r*E+n*S),X=-(i*x-s*E+n*b),Y=+(i*T-s*S+r*b),j=+(s*O-r*D+n*N),K=-(i*O-r*F+n*w),$=+(i*D-s*F+n*L),q=-(i*N-s*w+r*L),Q=-(s*B-r*U+n*V),Z=+(i*B-r*k+n*G),J=-(i*U-s*k+n*z),ee=+(i*V-s*G+r*z);return y.FromValuesToRef(C*M,W*M,j*M,Q*M,A*M,H*M,K*M,Z*M,R*M,X*M,$*M,J*M,I*M,Y*M,q*M,ee*M,e),e}addAtIndex(e,t){return this._m[e]+=t,this.markAsUpdated(),this}multiplyAtIndex(e,t){return this._m[e]*=t,this.markAsUpdated(),this}setTranslationFromFloats(e,t,i){return this._m[12]=e,this._m[13]=t,this._m[14]=i,this.markAsUpdated(),this}addTranslationFromFloats(e,t,i){return this._m[12]+=e,this._m[13]+=t,this._m[14]+=i,this.markAsUpdated(),this}setTranslation(e){return this.setTranslationFromFloats(e._x,e._y,e._z)}getTranslation(){return new S(this._m[12],this._m[13],this._m[14])}getTranslationToRef(e){return e.x=this._m[12],e.y=this._m[13],e.z=this._m[14],e}removeRotationAndScaling(){const e=this.m;return y.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e[12],e[13],e[14],e[15],this),this._updateIdentityStatus(0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]),this}multiply(e){const t=new this.constructor;return this.multiplyToRef(e,t),t}copyFrom(e){e.copyToArray(this._m);const t=e;return this.updateFlag=t.updateFlag,this._updateIdentityStatus(t._isIdentity,t._isIdentityDirty,t._isIdentity3x2,t._isIdentity3x2Dirty),this}copyToArray(e,t=0){const i=this._m;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],this}multiplyToRef(e,t){return this._isIdentity?(t.copyFrom(e),t):e._isIdentity?(t.copyFrom(this),t):(this.multiplyToArray(e,t._m,0),t.markAsUpdated(),t)}multiplyToArray(e,t,i){const s=this._m,r=e.m,n=s[0],o=s[1],a=s[2],l=s[3],h=s[4],c=s[5],u=s[6],d=s[7],p=s[8],_=s[9],f=s[10],m=s[11],g=s[12],v=s[13],x=s[14],T=s[15],E=r[0],S=r[1],b=r[2],C=r[3],y=r[4],A=r[5],R=r[6],I=r[7],P=r[8],M=r[9],O=r[10],D=r[11],N=r[12],F=r[13],w=r[14],L=r[15];return t[i]=n*E+o*y+a*P+l*N,t[i+1]=n*S+o*A+a*M+l*F,t[i+2]=n*b+o*R+a*O+l*w,t[i+3]=n*C+o*I+a*D+l*L,t[i+4]=h*E+c*y+u*P+d*N,t[i+5]=h*S+c*A+u*M+d*F,t[i+6]=h*b+c*R+u*O+d*w,t[i+7]=h*C+c*I+u*D+d*L,t[i+8]=p*E+_*y+f*P+m*N,t[i+9]=p*S+_*A+f*M+m*F,t[i+10]=p*b+_*R+f*O+m*w,t[i+11]=p*C+_*I+f*D+m*L,t[i+12]=g*E+v*y+x*P+T*N,t[i+13]=g*S+v*A+x*M+T*F,t[i+14]=g*b+v*R+x*O+T*w,t[i+15]=g*C+v*I+x*D+T*L,this}equals(e){const t=e;if(!t)return!1;if((this._isIdentity||t._isIdentity)&&!this._isIdentityDirty&&!t._isIdentityDirty)return this._isIdentity&&t._isIdentity;const i=this.m,s=t.m;return i[0]===s[0]&&i[1]===s[1]&&i[2]===s[2]&&i[3]===s[3]&&i[4]===s[4]&&i[5]===s[5]&&i[6]===s[6]&&i[7]===s[7]&&i[8]===s[8]&&i[9]===s[9]&&i[10]===s[10]&&i[11]===s[11]&&i[12]===s[12]&&i[13]===s[13]&&i[14]===s[14]&&i[15]===s[15]}clone(){const e=new this.constructor;return e.copyFrom(this),e}getClassName(){return"Matrix"}getHashCode(){let e=T(this._m[0]);for(let t=1;t<16;t++)e=397*e^T(this._m[t]);return e}decomposeToTransformNode(e){return e.rotationQuaternion=e.rotationQuaternion||new C,this.decompose(e.scaling,e.rotationQuaternion,e.position)}decompose(e,t,i,s,r=!0){if(this._isIdentity)return i&&i.setAll(0),e&&e.setAll(1),t&&t.copyFromFloats(0,0,0,1),!0;const n=this._m;if(i&&i.copyFromFloats(n[12],n[13],n[14]),(e=e||A.Vector3[0]).x=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]),e.y=Math.sqrt(n[4]*n[4]+n[5]*n[5]+n[6]*n[6]),e.z=Math.sqrt(n[8]*n[8]+n[9]*n[9]+n[10]*n[10]),s){const t=(r?s.absoluteScaling.x:s.scaling.x)<0?-1:1,i=(r?s.absoluteScaling.y:s.scaling.y)<0?-1:1,n=(r?s.absoluteScaling.z:s.scaling.z)<0?-1:1;e.x*=t,e.y*=i,e.z*=n}else this.determinant()<=0&&(e.y*=-1);if(0===e._x||0===e._y||0===e._z)return t&&t.copyFromFloats(0,0,0,1),!1;if(t){const i=1/e._x,s=1/e._y,r=1/e._z;y.FromValuesToRef(n[0]*i,n[1]*i,n[2]*i,0,n[4]*s,n[5]*s,n[6]*s,0,n[8]*r,n[9]*r,n[10]*r,0,0,0,0,1,A.Matrix[0]),C.FromRotationMatrixToRef(A.Matrix[0],t)}return!0}getRow(e){if(e<0||e>3)return null;const t=4*e;return new b(this._m[t+0],this._m[t+1],this._m[t+2],this._m[t+3])}getRowToRef(e,t){if(e>=0&&e<=3){const i=4*e;t.x=this._m[i+0],t.y=this._m[i+1],t.z=this._m[i+2],t.w=this._m[i+3]}return t}setRow(e,t){return this.setRowFromFloats(e,t.x,t.y,t.z,t.w)}transpose(){const e=new this.constructor;return y.TransposeToRef(this,e),e}transposeToRef(e){return y.TransposeToRef(this,e),e}setRowFromFloats(e,t,i,s,r){if(e<0||e>3)return this;const n=4*e;return this._m[n+0]=t,this._m[n+1]=i,this._m[n+2]=s,this._m[n+3]=r,this.markAsUpdated(),this}scale(e){const t=new this.constructor;return this.scaleToRef(e,t),t}scaleToRef(e,t){for(let i=0;i<16;i++)t._m[i]=this._m[i]*e;return t.markAsUpdated(),t}scaleAndAddToRef(e,t){for(let i=0;i<16;i++)t._m[i]+=this._m[i]*e;return t.markAsUpdated(),t}toNormalMatrix(e){const t=A.Matrix[0];this.invertToRef(t),t.transposeToRef(e);const i=e._m;return y.FromValuesToRef(i[0],i[1],i[2],0,i[4],i[5],i[6],0,i[8],i[9],i[10],0,0,0,0,1,e),e}getRotationMatrix(){const e=new this.constructor;return this.getRotationMatrixToRef(e),e}getRotationMatrixToRef(e){const t=A.Vector3[0];if(!this.decompose(t))return y.IdentityToRef(e),e;const i=this._m,s=1/t._x,r=1/t._y,n=1/t._z;return y.FromValuesToRef(i[0]*s,i[1]*s,i[2]*s,0,i[4]*r,i[5]*r,i[6]*r,0,i[8]*n,i[9]*n,i[10]*n,0,0,0,0,1,e),e}toggleModelMatrixHandInPlace(){const e=this._m;return e[2]*=-1,e[6]*=-1,e[8]*=-1,e[9]*=-1,e[14]*=-1,this.markAsUpdated(),this}toggleProjectionMatrixHandInPlace(){const e=this._m;return e[8]*=-1,e[9]*=-1,e[10]*=-1,e[11]*=-1,this.markAsUpdated(),this}static FromArray(e,t=0){const i=new y;return y.FromArrayToRef(e,t,i),i}static FromArrayToRef(e,t,i){for(let s=0;s<16;s++)i._m[s]=e[s+t];return i.markAsUpdated(),i}static FromFloat32ArrayToRefScaled(e,t,i,s){for(let r=0;r<16;r++)s._m[r]=e[r+t]*i;return s.markAsUpdated(),s}static get IdentityReadOnly(){return y._IdentityReadOnly}static FromValuesToRef(e,t,i,s,r,n,o,a,l,h,c,u,d,p,_,f,m){const g=m._m;g[0]=e,g[1]=t,g[2]=i,g[3]=s,g[4]=r,g[5]=n,g[6]=o,g[7]=a,g[8]=l,g[9]=h,g[10]=c,g[11]=u,g[12]=d,g[13]=p,g[14]=_,g[15]=f,m.markAsUpdated()}static FromValues(e,t,i,s,r,n,o,a,l,h,c,u,d,p,_,f){const m=new y,g=m._m;return g[0]=e,g[1]=t,g[2]=i,g[3]=s,g[4]=r,g[5]=n,g[6]=o,g[7]=a,g[8]=l,g[9]=h,g[10]=c,g[11]=u,g[12]=d,g[13]=p,g[14]=_,g[15]=f,m.markAsUpdated(),m}static Compose(e,t,i){const s=new y;return y.ComposeToRef(e,t,i,s),s}static ComposeToRef(e,t,i,s){const r=s._m,n=t._x,o=t._y,a=t._z,l=t._w,h=n+n,c=o+o,u=a+a,d=n*h,p=n*c,_=n*u,f=o*c,m=o*u,g=a*u,v=l*h,x=l*c,T=l*u,E=e._x,S=e._y,b=e._z;return r[0]=(1-(f+g))*E,r[1]=(p+T)*E,r[2]=(_-x)*E,r[3]=0,r[4]=(p-T)*S,r[5]=(1-(d+g))*S,r[6]=(m+v)*S,r[7]=0,r[8]=(_+x)*b,r[9]=(m-v)*b,r[10]=(1-(d+f))*b,r[11]=0,r[12]=i._x,r[13]=i._y,r[14]=i._z,r[15]=1,s.markAsUpdated(),s}static Identity(){const e=y.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return e._updateIdentityStatus(!0),e}static IdentityToRef(e){return y.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,e),e._updateIdentityStatus(!0),e}static Zero(){const e=y.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return e._updateIdentityStatus(!1),e}static RotationX(e){const t=new y;return y.RotationXToRef(e,t),t}static Invert(e){const t=new e.constructor;return e.invertToRef(t),t}static RotationXToRef(e,t){const i=Math.sin(e),s=Math.cos(e);return y.FromValuesToRef(1,0,0,0,0,s,i,0,0,-i,s,0,0,0,0,1,t),t._updateIdentityStatus(1===s&&0===i),t}static RotationY(e){const t=new y;return y.RotationYToRef(e,t),t}static RotationYToRef(e,t){const i=Math.sin(e),s=Math.cos(e);return y.FromValuesToRef(s,0,-i,0,0,1,0,0,i,0,s,0,0,0,0,1,t),t._updateIdentityStatus(1===s&&0===i),t}static RotationZ(e){const t=new y;return y.RotationZToRef(e,t),t}static RotationZToRef(e,t){const i=Math.sin(e),s=Math.cos(e);return y.FromValuesToRef(s,i,0,0,-i,s,0,0,0,0,1,0,0,0,0,1,t),t._updateIdentityStatus(1===s&&0===i),t}static RotationAxis(e,t){const i=new y;return y.RotationAxisToRef(e,t,i),i}static RotationAxisToRef(e,t,i){const s=Math.sin(-t),r=Math.cos(-t),n=1-r;e.normalize();const o=i._m;return o[0]=e._x*e._x*n+r,o[1]=e._x*e._y*n-e._z*s,o[2]=e._x*e._z*n+e._y*s,o[3]=0,o[4]=e._y*e._x*n+e._z*s,o[5]=e._y*e._y*n+r,o[6]=e._y*e._z*n-e._x*s,o[7]=0,o[8]=e._z*e._x*n-e._y*s,o[9]=e._z*e._y*n+e._x*s,o[10]=e._z*e._z*n+r,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,i.markAsUpdated(),i}static RotationAlignToRef(e,t,i,s=!1){const r=S.Dot(t,e),n=i._m;if(r<-1+u)n[0]=-1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=s?1:-1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=s?-1:1,n[11]=0;else{const i=S.Cross(t,e),s=1/(1+r);n[0]=i._x*i._x*s+r,n[1]=i._y*i._x*s-i._z,n[2]=i._z*i._x*s+i._y,n[3]=0,n[4]=i._x*i._y*s+i._z,n[5]=i._y*i._y*s+r,n[6]=i._z*i._y*s-i._x,n[7]=0,n[8]=i._x*i._z*s-i._y,n[9]=i._y*i._z*s+i._x,n[10]=i._z*i._z*s+r,n[11]=0}return n[12]=0,n[13]=0,n[14]=0,n[15]=1,i.markAsUpdated(),i}static RotationYawPitchRoll(e,t,i){const s=new y;return y.RotationYawPitchRollToRef(e,t,i,s),s}static RotationYawPitchRollToRef(e,t,i,s){return C.RotationYawPitchRollToRef(e,t,i,A.Quaternion[0]),A.Quaternion[0].toRotationMatrix(s),s}static Scaling(e,t,i){const s=new y;return y.ScalingToRef(e,t,i,s),s}static ScalingToRef(e,t,i,s){return y.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1,s),s._updateIdentityStatus(1===e&&1===t&&1===i),s}static Translation(e,t,i){const s=new y;return y.TranslationToRef(e,t,i,s),s}static TranslationToRef(e,t,i,s){return y.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1,s),s._updateIdentityStatus(0===e&&0===t&&0===i),s}static Lerp(e,t,i){const s=new e.constructor;return y.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){const r=s._m,n=e.m,o=t.m;for(let e=0;e<16;e++)r[e]=n[e]*(1-i)+o[e]*i;return s.markAsUpdated(),s}static DecomposeLerp(e,t,i){const s=new e.constructor;return y.DecomposeLerpToRef(e,t,i,s),s}static DecomposeLerpToRef(e,t,i,s){const r=A.Vector3[0],n=A.Quaternion[0],o=A.Vector3[1];e.decompose(r,n,o);const a=A.Vector3[2],l=A.Quaternion[1],h=A.Vector3[3];t.decompose(a,l,h);const c=A.Vector3[4];S.LerpToRef(r,a,i,c);const u=A.Quaternion[2];C.SlerpToRef(n,l,i,u);const d=A.Vector3[5];return S.LerpToRef(o,h,i,d),y.ComposeToRef(c,u,d,s),s}static LookAtLH(e,t,i){const s=new y;return y.LookAtLHToRef(e,t,i,s),s}static LookAtLHToRef(e,t,i,s){const r=A.Vector3[0],n=A.Vector3[1],o=A.Vector3[2];t.subtractToRef(e,o),o.normalize(),S.CrossToRef(i,o,r);const a=r.lengthSquared();0===a?r.x=1:r.normalizeFromLength(Math.sqrt(a)),S.CrossToRef(o,r,n),n.normalize();const l=-S.Dot(r,e),h=-S.Dot(n,e),c=-S.Dot(o,e);return y.FromValuesToRef(r._x,n._x,o._x,0,r._y,n._y,o._y,0,r._z,n._z,o._z,0,l,h,c,1,s),s}static LookAtRH(e,t,i){const s=new y;return y.LookAtRHToRef(e,t,i,s),s}static LookAtRHToRef(e,t,i,s){const r=A.Vector3[0],n=A.Vector3[1],o=A.Vector3[2];e.subtractToRef(t,o),o.normalize(),S.CrossToRef(i,o,r);const a=r.lengthSquared();0===a?r.x=1:r.normalizeFromLength(Math.sqrt(a)),S.CrossToRef(o,r,n),n.normalize();const l=-S.Dot(r,e),h=-S.Dot(n,e),c=-S.Dot(o,e);return y.FromValuesToRef(r._x,n._x,o._x,0,r._y,n._y,o._y,0,r._z,n._z,o._z,0,l,h,c,1,s),s}static LookDirectionLH(e,t){const i=new y;return y.LookDirectionLHToRef(e,t,i),i}static LookDirectionLHToRef(e,t,i){const s=A.Vector3[0];s.copyFrom(e),s.scaleInPlace(-1);const r=A.Vector3[1];return S.CrossToRef(t,s,r),y.FromValuesToRef(r._x,r._y,r._z,0,t._x,t._y,t._z,0,s._x,s._y,s._z,0,0,0,0,1,i),i}static LookDirectionRH(e,t){const i=new y;return y.LookDirectionRHToRef(e,t,i),i}static LookDirectionRHToRef(e,t,i){const s=A.Vector3[2];return S.CrossToRef(t,e,s),y.FromValuesToRef(s._x,s._y,s._z,0,t._x,t._y,t._z,0,e._x,e._y,e._z,0,0,0,0,1,i),i}static OrthoLH(e,t,i,s,r){const n=new y;return y.OrthoLHToRef(e,t,i,s,n,r),n}static OrthoLHToRef(e,t,i,s,r,n){const o=2/e,a=2/t,l=2/(s-i),h=-(s+i)/(s-i);return y.FromValuesToRef(o,0,0,0,0,a,0,0,0,0,l,0,0,0,h,1,r),n&&r.multiplyToRef(I,r),r._updateIdentityStatus(1===o&&1===a&&1===l&&0===h),r}static OrthoOffCenterLH(e,t,i,s,r,n,o){const a=new y;return y.OrthoOffCenterLHToRef(e,t,i,s,r,n,a,o),a}static OrthoOffCenterLHToRef(e,t,i,s,r,n,o,a){const l=2/(t-e),h=2/(s-i),c=2/(n-r),u=-(n+r)/(n-r),d=(e+t)/(e-t),p=(s+i)/(i-s);return y.FromValuesToRef(l,0,0,0,0,h,0,0,0,0,c,0,d,p,u,1,o),a&&o.multiplyToRef(I,o),o.markAsUpdated(),o}static ObliqueOffCenterLHToRef(e,t,i,s,r,n,o,a,l,h,c){const u=-o*Math.cos(a),d=-o*Math.sin(a);return y.TranslationToRef(0,0,-l,A.Matrix[1]),y.FromValuesToRef(1,0,0,0,0,1,0,0,u,d,1,0,0,0,0,1,A.Matrix[0]),A.Matrix[1].multiplyToRef(A.Matrix[0],A.Matrix[0]),y.TranslationToRef(0,0,l,A.Matrix[1]),A.Matrix[0].multiplyToRef(A.Matrix[1],A.Matrix[0]),y.OrthoOffCenterLHToRef(e,t,i,s,r,n,h,c),A.Matrix[0].multiplyToRef(h,h),h}static OrthoOffCenterRH(e,t,i,s,r,n,o){const a=new y;return y.OrthoOffCenterRHToRef(e,t,i,s,r,n,a,o),a}static OrthoOffCenterRHToRef(e,t,i,s,r,n,o,a){return y.OrthoOffCenterLHToRef(e,t,i,s,r,n,o,a),o._m[10]*=-1,o}static ObliqueOffCenterRHToRef(e,t,i,s,r,n,o,a,l,h,c){const u=o*Math.cos(a),d=o*Math.sin(a);return y.TranslationToRef(0,0,l,A.Matrix[1]),y.FromValuesToRef(1,0,0,0,0,1,0,0,u,d,1,0,0,0,0,1,A.Matrix[0]),A.Matrix[1].multiplyToRef(A.Matrix[0],A.Matrix[0]),y.TranslationToRef(0,0,-l,A.Matrix[1]),A.Matrix[0].multiplyToRef(A.Matrix[1],A.Matrix[0]),y.OrthoOffCenterRHToRef(e,t,i,s,r,n,h,c),A.Matrix[0].multiplyToRef(h,h),h}static PerspectiveLH(e,t,i,s,r,n=0){const o=new y,a=2*i/e,l=2*i/t,h=(s+i)/(s-i),c=-2*s*i/(s-i),u=Math.tan(n);return y.FromValuesToRef(a,0,0,0,0,l,0,u,0,0,h,1,0,0,c,0,o),r&&o.multiplyToRef(I,o),o._updateIdentityStatus(!1),o}static PerspectiveFovLH(e,t,i,s,r,n=0,o=!1){const a=new y;return y.PerspectiveFovLHToRef(e,t,i,s,a,!0,r,n,o),a}static PerspectiveFovLHToRef(e,t,i,s,r,n=!0,o,a=0,l=!1){const h=i,c=s,u=1/Math.tan(.5*e),d=n?u/t:u,p=n?u:u*t,_=l&&0===h?-1:0!==c?(c+h)/(c-h):1,f=l&&0===h?2*c:0!==c?-2*c*h/(c-h):-2*h,m=Math.tan(a);return y.FromValuesToRef(d,0,0,0,0,p,0,m,0,0,_,1,0,0,f,0,r),o&&r.multiplyToRef(I,r),r._updateIdentityStatus(!1),r}static PerspectiveFovReverseLHToRef(e,t,i,s,r,n=!0,o,a=0){const l=1/Math.tan(.5*e),h=n?l/t:l,c=n?l:l*t,u=Math.tan(a);return y.FromValuesToRef(h,0,0,0,0,c,0,u,0,0,-i,1,0,0,1,0,r),o&&r.multiplyToRef(I,r),r._updateIdentityStatus(!1),r}static PerspectiveFovRH(e,t,i,s,r,n=0,o=!1){const a=new y;return y.PerspectiveFovRHToRef(e,t,i,s,a,!0,r,n,o),a}static PerspectiveFovRHToRef(e,t,i,s,r,n=!0,o,a=0,l=!1){const h=i,c=s,u=1/Math.tan(.5*e),d=n?u/t:u,p=n?u:u*t,_=l&&0===h?1:0!==c?-(c+h)/(c-h):-1,f=l&&0===h?2*c:0!==c?-2*c*h/(c-h):-2*h,m=Math.tan(a);return y.FromValuesToRef(d,0,0,0,0,p,0,m,0,0,_,-1,0,0,f,0,r),o&&r.multiplyToRef(I,r),r._updateIdentityStatus(!1),r}static PerspectiveFovReverseRHToRef(e,t,i,s,r,n=!0,o,a=0){const l=1/Math.tan(.5*e),h=n?l/t:l,c=n?l:l*t,u=Math.tan(a);return y.FromValuesToRef(h,0,0,0,0,c,0,u,0,0,-i,-1,0,0,-1,0,r),o&&r.multiplyToRef(I,r),r._updateIdentityStatus(!1),r}static GetFinalMatrix(e,t,i,s,r,n){const o=e.width,a=e.height,l=e.x,h=e.y,c=y.FromValues(o/2,0,0,0,0,-a/2,0,0,0,0,n-r,0,l+o/2,a/2+h,r,1),u=new t.constructor;return t.multiplyToRef(i,u),u.multiplyToRef(s,u),u.multiplyToRef(c,u)}static GetAsMatrix2x2(e){const t=e.m,i=[t[0],t[1],t[4],t[5]];return v.MatrixUse64Bits?i:new Float32Array(i)}static GetAsMatrix3x3(e){const t=e.m,i=[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]];return v.MatrixUse64Bits?i:new Float32Array(i)}static Transpose(e){const t=new e.constructor;return y.TransposeToRef(e,t),t}static TransposeToRef(e,t){const i=e.m,s=i[0],r=i[4],n=i[8],o=i[12],a=i[1],l=i[5],h=i[9],c=i[13],u=i[2],d=i[6],p=i[10],_=i[14],f=i[3],m=i[7],g=i[11],v=i[15],x=t._m;return x[0]=s,x[1]=r,x[2]=n,x[3]=o,x[4]=a,x[5]=l,x[6]=h,x[7]=c,x[8]=u,x[9]=d,x[10]=p,x[11]=_,x[12]=f,x[13]=m,x[14]=g,x[15]=v,t.markAsUpdated(),t._updateIdentityStatus(e._isIdentity,e._isIdentityDirty),t}static Reflection(e){const t=new y;return y.ReflectionToRef(e,t),t}static ReflectionToRef(e,t){e.normalize();const i=e.normal.x,s=e.normal.y,r=e.normal.z,n=-2*i,o=-2*s,a=-2*r;return y.FromValuesToRef(n*i+1,o*i,a*i,0,n*s,o*s+1,a*s,0,n*r,o*r,a*r+1,0,n*e.d,o*e.d,a*e.d,1,t),t}static FromXYZAxesToRef(e,t,i,s){return y.FromValuesToRef(e._x,e._y,e._z,0,t._x,t._y,t._z,0,i._x,i._y,i._z,0,0,0,0,1,s),s}static FromQuaternionToRef(e,t){const i=e._x*e._x,s=e._y*e._y,r=e._z*e._z,n=e._x*e._y,o=e._z*e._w,a=e._z*e._x,l=e._y*e._w,h=e._y*e._z,c=e._x*e._w;return t._m[0]=1-2*(s+r),t._m[1]=2*(n+o),t._m[2]=2*(a-l),t._m[3]=0,t._m[4]=2*(n-o),t._m[5]=1-2*(r+i),t._m[6]=2*(h+c),t._m[7]=0,t._m[8]=2*(a+l),t._m[9]=2*(h-c),t._m[10]=1-2*(s+i),t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t.markAsUpdated(),t}}y._UpdateFlagSeed=0,y._IdentityReadOnly=y.Identity();class A{}A.Vector3=d.BuildTuple(11,S.Zero),A.Matrix=d.BuildTuple(2,y.Identity),A.Quaternion=d.BuildTuple(3,C.Zero);class R{}R.Vector2=d.BuildTuple(3,E.Zero),R.Vector3=d.BuildTuple(13,S.Zero),R.Vector4=d.BuildTuple(3,b.Zero),R.Quaternion=d.BuildTuple(2,C.Zero),R.Matrix=d.BuildTuple(8,y.Identity),m("BABYLON.Vector2",E),m("BABYLON.Vector3",S),m("BABYLON.Vector4",b),m("BABYLON.Matrix",y);const I=y.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1);function P(e){return Math.pow(e,c)}function M(e){return e<=.04045?.0773993808*e:Math.pow(.947867299*(e+.055),2.4)}function O(e){return Math.pow(e,h)}function D(e){return e<=.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}class N{constructor(e=0,t=0,i=0){this.r=e,this.g=t,this.b=i}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"}getClassName(){return"Color3"}getHashCode(){let e=255*this.r|0;return e=397*e^255*this.g,e=397*e^255*this.b,e}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this}fromArray(e,t=0){return N.FromArrayToRef(e,t,this),this}toColor4(e=1){return new F(this.r,this.g,this.b,e)}asArray(){return[this.r,this.g,this.b]}toLuminance(){return.3*this.r+.59*this.g+.11*this.b}multiply(e){return new N(this.r*e.r,this.g*e.g,this.b*e.b)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b}equalsFloats(e,t,i){return this.r===e&&this.g===t&&this.b===i}scale(e){return new N(this.r*e,this.g*e,this.b*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,this}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,this}clampToRef(e=0,t=1,i){return i.r=l.Clamp(this.r,e,t),i.g=l.Clamp(this.g,e,t),i.b=l.Clamp(this.b,e,t),this}add(e){return new N(this.r+e.r,this.g+e.g,this.b+e.b)}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,this}subtract(e){return new N(this.r-e.r,this.g-e.g,this.b-e.b)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,this}clone(){return new N(this.r,this.g,this.b)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyFromFloats(e,t,i){return this.r=e,this.g=t,this.b=i,this}set(e,t,i){return this.copyFromFloats(e,t,i)}toHexString(){const e=Math.round(255*this.r),t=Math.round(255*this.g),i=Math.round(255*this.b);return"#"+l.ToHex(e)+l.ToHex(t)+l.ToHex(i)}toHSV(){const e=new N;return this.toHSVToRef(e),e}toHSVToRef(e){const t=this.r,i=this.g,s=this.b,r=Math.max(t,i,s),n=Math.min(t,i,s);let o=0,a=0;const l=r,h=r-n;0!==r&&(a=h/r),r!=n&&(r==t?(o=(i-s)/h,i<s&&(o+=6)):r==i?o=(s-t)/h+2:r==s&&(o=(t-i)/h+4),o*=60),e.r=o,e.g=a,e.b=l}toLinearSpace(e=!1){const t=new N;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=M(this.r),e.g=M(this.g),e.b=M(this.b)):(e.r=P(this.r),e.g=P(this.g),e.b=P(this.b)),this}toGammaSpace(e=!1){const t=new N;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=D(this.r),e.g=D(this.g),e.b=D(this.b)):(e.r=O(this.r),e.g=O(this.g),e.b=O(this.b)),this}static HSVtoRGBToRef(e,t,i,s){const r=i*t,n=e/60,o=r*(1-Math.abs(n%2-1));let a=0,l=0,h=0;n>=0&&n<=1?(a=r,l=o):n>=1&&n<=2?(a=o,l=r):n>=2&&n<=3?(l=r,h=o):n>=3&&n<=4?(l=o,h=r):n>=4&&n<=5?(a=o,h=r):n>=5&&n<=6&&(a=r,h=o);const c=i-r;s.set(a+c,l+c,h+c)}static FromHSV(e,t,i){const s=new N(0,0,0);return N.HSVtoRGBToRef(e,t,i,s),s}static FromHexString(e){if("#"!==e.substring(0,1)||7!==e.length)return new N(0,0,0);const t=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),s=parseInt(e.substring(5,7),16);return N.FromInts(t,i,s)}static FromArray(e,t=0){return new N(e[t],e[t+1],e[t+2])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2]}static FromInts(e,t,i){return new N(e/255,t/255,i/255)}static Lerp(e,t,i){const s=new N(0,0,0);return N.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){s.r=e.r+(t.r-e.r)*i,s.g=e.g+(t.g-e.g)*i,s.b=e.b+(t.b-e.b)*i}static Hermite(e,t,i,s,r){const n=r*r,o=r*n,a=2*o-3*n+1,l=-2*o+3*n,h=o-2*n+r,c=o-n,u=e.r*a+i.r*l+t.r*h+s.r*c,d=e.g*a+i.g*l+t.g*h+s.g*c,p=e.b*a+i.b*l+t.b*h+s.b*c;return new N(u,d,p)}static Hermite1stDerivative(e,t,i,s,r){const n=N.Black();return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const o=r*r;n.r=6*(o-r)*e.r+(3*o-4*r+1)*t.r+6*(-o+r)*i.r+(3*o-2*r)*s.r,n.g=6*(o-r)*e.g+(3*o-4*r+1)*t.g+6*(-o+r)*i.g+(3*o-2*r)*s.g,n.b=6*(o-r)*e.b+(3*o-4*r+1)*t.b+6*(-o+r)*i.b+(3*o-2*r)*s.b}static Red(){return new N(1,0,0)}static Green(){return new N(0,1,0)}static Blue(){return new N(0,0,1)}static Black(){return new N(0,0,0)}static get BlackReadOnly(){return N._BlackReadOnly}static White(){return new N(1,1,1)}static Purple(){return new N(.5,0,.5)}static Magenta(){return new N(1,0,1)}static Yellow(){return new N(1,1,0)}static Gray(){return new N(.5,.5,.5)}static Teal(){return new N(0,1,1)}static Random(){return new N(Math.random(),Math.random(),Math.random())}}N._BlackReadOnly=N.Black();class F{constructor(e=0,t=0,i=0,s=1){this.r=e,this.g=t,this.b=i,this.a=s}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this}asArray(){return[this.r,this.g,this.b,this.a]}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this}fromArray(e,t=0){return F.FromArrayToRef(e,t,this),this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}add(e){return new F(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}subtract(e){return new F(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,this}scale(e){return new F(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,this}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,this}clampToRef(e=0,t=1,i){return i.r=l.Clamp(this.r,e,t),i.g=l.Clamp(this.g,e,t),i.b=l.Clamp(this.b,e,t),i.a=l.Clamp(this.a,e,t),this}multiply(e){return new F(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"}getClassName(){return"Color4"}getHashCode(){let e=255*this.r|0;return e=397*e^255*this.g,e=397*e^255*this.b,e=397*e^255*this.a,e}clone(){return new F(this.r,this.g,this.b,this.a)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}copyFromFloats(e,t,i,s){return this.r=e,this.g=t,this.b=i,this.a=s,this}set(e,t,i,s){return this.copyFromFloats(e,t,i,s)}toHexString(e=!1){const t=Math.round(255*this.r),i=Math.round(255*this.g),s=Math.round(255*this.b);if(e)return"#"+l.ToHex(t)+l.ToHex(i)+l.ToHex(s);const r=Math.round(255*this.a);return"#"+l.ToHex(t)+l.ToHex(i)+l.ToHex(s)+l.ToHex(r)}toLinearSpace(e=!1){const t=new F;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=M(this.r),e.g=M(this.g),e.b=M(this.b)):(e.r=P(this.r),e.g=P(this.g),e.b=P(this.b)),e.a=this.a,this}toGammaSpace(e=!1){const t=new F;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=D(this.r),e.g=D(this.g),e.b=D(this.b)):(e.r=O(this.r),e.g=O(this.g),e.b=O(this.b)),e.a=this.a,this}static FromHexString(e){if("#"!==e.substring(0,1)||9!==e.length&&7!==e.length)return new F(0,0,0,0);const t=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),s=parseInt(e.substring(5,7),16),r=9===e.length?parseInt(e.substring(7,9),16):255;return F.FromInts(t,i,s,r)}static Lerp(e,t,i){const s=new F(0,0,0,0);return F.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){s.r=e.r+(t.r-e.r)*i,s.g=e.g+(t.g-e.g)*i,s.b=e.b+(t.b-e.b)*i,s.a=e.a+(t.a-e.a)*i}static Hermite(e,t,i,s,r){const n=r*r,o=r*n,a=2*o-3*n+1,l=-2*o+3*n,h=o-2*n+r,c=o-n,u=e.r*a+i.r*l+t.r*h+s.r*c,d=e.g*a+i.g*l+t.g*h+s.g*c,p=e.b*a+i.b*l+t.b*h+s.b*c,_=e.a*a+i.a*l+t.a*h+s.a*c;return new F(u,d,p,_)}static Hermite1stDerivative(e,t,i,s,r){const n=new F;return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const o=r*r;n.r=6*(o-r)*e.r+(3*o-4*r+1)*t.r+6*(-o+r)*i.r+(3*o-2*r)*s.r,n.g=6*(o-r)*e.g+(3*o-4*r+1)*t.g+6*(-o+r)*i.g+(3*o-2*r)*s.g,n.b=6*(o-r)*e.b+(3*o-4*r+1)*t.b+6*(-o+r)*i.b+(3*o-2*r)*s.b,n.a=6*(o-r)*e.a+(3*o-4*r+1)*t.a+6*(-o+r)*i.a+(3*o-2*r)*s.a}static FromColor3(e,t=1){return new F(e.r,e.g,e.b,t)}static FromArray(e,t=0){return new F(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2],i.a=e[t+3]}static FromInts(e,t,i,s){return new F(e/255,t/255,i/255,s/255)}static CheckColors4(e,t){if(e.length===3*t){const t=[];for(let i=0;i<e.length;i+=3){const s=i/3*4;t[s]=e[i],t[s+1]=e[i+1],t[s+2]=e[i+2],t[s+3]=1}return t}return e}}class w{}w.Color3=d.BuildArray(3,N.Black),w.Color4=d.BuildArray(3,(()=>new F(0,0,0,0))),m("BABYLON.Color3",N),m("BABYLON.Color4",F);class L{constructor(e,t){this.triggerOptions=e,this.onBeforeExecuteObservable=new a,e.parameter?(this.trigger=e.trigger,this._triggerParameter=e.parameter):e.trigger?this.trigger=e.trigger:this.trigger=e,this._nextActiveAction=this,this._condition=t}_prepare(){}getTriggerParameter(){return this._triggerParameter}setTriggerParameter(e){this._triggerParameter=e}_evaluateConditionForCurrentFrame(){const e=this._condition;if(!e)return!0;const t=this._actionManager.getScene().getRenderId();return e._evaluationId!==t&&(e._evaluationId=t,e._currentResult=e.isValid()),e._currentResult}_executeCurrent(e){this._evaluateConditionForCurrentFrame()&&(this.onBeforeExecuteObservable.notifyObservers(this),this._nextActiveAction.execute(e),this.skipToNextActiveAction())}execute(e){}skipToNextActiveAction(){this._nextActiveAction._child?(this._nextActiveAction._child._actionManager||(this._nextActiveAction._child._actionManager=this._actionManager),this._nextActiveAction=this._nextActiveAction._child):this._nextActiveAction=this}then(e){return this._child=e,e._actionManager=this._actionManager,e._prepare(),e}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(e){}_serialize(e,t){const i={type:1,children:[],name:e.name,properties:e.properties||[]};if(this._child&&this._child.serialize(i),this._condition){const e=this._condition.serialize();return e.children.push(i),t&&t.children.push(e),e}return t&&t.children.push(i),i}}L._SerializeValueAsString=e=>"number"==typeof e?e.toString():"boolean"==typeof e?e?"true":"false":e instanceof E?e.x+", "+e.y:e instanceof S?e.x+", "+e.y+", "+e.z:e instanceof N?e.r+", "+e.g+", "+e.b:e instanceof F?e.r+", "+e.g+", "+e.b+", "+e.a:e,L._GetTargetProperty=e=>({name:"target",targetType:e._isMesh?"MeshProperties":e._isLight?"LightProperties":e._isCamera?"CameraProperties":e._isMaterial?"MaterialProperties":"SceneProperties",value:e._isScene?"Scene":e.name}),m("BABYLON.Action",L);class B{constructor(e,t,i,s,r,n){this.source=e,this.pointerX=t,this.pointerY=i,this.meshUnderPointer=s,this.sourceEvent=r,this.additionalData=n}static CreateNew(e,t,i){const s=e.getScene();return new B(e,s.pointerX,s.pointerY,s.meshUnderPointer||e,t,i)}static CreateNewFromSprite(e,t,i,s){return new B(e,t.pointerX,t.pointerY,t.meshUnderPointer,i,s)}static CreateNewFromScene(e,t){return new B(null,e.pointerX,e.pointerY,e.meshUnderPointer,t)}static CreateNewFromPrimitive(e,t,i,s){return new B(e,t.x,t.y,null,i,s)}}class U{constructor(e){this._actionManager=e}isValid(){return!0}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(){}_serialize(e){return{type:2,children:[],name:e.name,properties:e.properties}}}class V extends U{static get IsEqual(){return V._IsEqual}static get IsDifferent(){return V._IsDifferent}static get IsGreater(){return V._IsGreater}static get IsLesser(){return V._IsLesser}constructor(e,t,i,s,r=V.IsEqual){super(e),this.propertyPath=i,this.value=s,this.operator=r,this._target=t,this._effectiveTarget=this._getEffectiveTarget(t,this.propertyPath),this._property=this._getProperty(this.propertyPath)}isValid(){switch(this.operator){case V.IsGreater:return this._effectiveTarget[this._property]>this.value;case V.IsLesser:return this._effectiveTarget[this._property]<this.value;case V.IsEqual:case V.IsDifferent:{let e;return e=this.value.equals?this.value.equals(this._effectiveTarget[this._property]):this.value===this._effectiveTarget[this._property],this.operator===V.IsEqual?e:!e}}return!1}serialize(){return this._serialize({name:"ValueCondition",properties:[L._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:L._SerializeValueAsString(this.value)},{name:"operator",value:V.GetOperatorName(this.operator)}]})}static GetOperatorName(e){switch(e){case V._IsEqual:return"IsEqual";case V._IsDifferent:return"IsDifferent";case V._IsGreater:return"IsGreater";case V._IsLesser:return"IsLesser";default:return""}}}V._IsEqual=0,V._IsDifferent=1,V._IsGreater=2,V._IsLesser=3,m("BABYLON.ValueCondition",V),m("BABYLON.PredicateCondition",class extends U{constructor(e,t){super(e),this.predicate=t}isValid(){return this.predicate()}}),m("BABYLON.StateCondition",class extends U{constructor(e,t,i){super(e),this.value=i,this._target=t}isValid(){return this._target.state===this.value}serialize(){return this._serialize({name:"StateCondition",properties:[L._GetTargetProperty(this._target),{name:"value",value:this.value}]})}});class k{static _CheckLimit(e,t){let i=k._LogLimitOutputs[e];return i?i.current++:(i={limit:t,current:1},k._LogLimitOutputs[e]=i),i.current<=i.limit}static _GenerateLimitMessage(e,t=1){var i;const s=k._LogLimitOutputs[e];if(!s||!k.MessageLimitReached)return;const r=this._Levels[t];s.current===s.limit&&k[r.name](k.MessageLimitReached.replace(/%LIMIT%/g,""+s.limit).replace(/%TYPE%/g,null!==(i=r.name)&&void 0!==i?i:""))}static _AddLogEntry(e){k._LogCache=e+k._LogCache,k.OnNewCacheEntry&&k.OnNewCacheEntry(e)}static _FormatMessage(e){const t=e=>e<10?"0"+e:""+e,i=new Date;return"["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e}static _LogDisabled(e,t){}static _LogEnabled(e=1,t,i){if(void 0!==i&&!k._CheckLimit(t,i))return;const s=k._FormatMessage(t),r=this._Levels[e];r.logFunc&&r.logFunc("BJS - "+s);const n=`<div style='color:${r.color}'>${s}</div><br>`;k._AddLogEntry(n),k._GenerateLimitMessage(t,e)}static get LogCache(){return k._LogCache}static ClearLogCache(){k._LogCache="",k._LogLimitOutputs={},k.errorsCount=0}static set LogLevels(e){k.Log=k._LogDisabled,k.Warn=k._LogDisabled,k.Error=k._LogDisabled,[k.MessageLogLevel,k.WarningLogLevel,k.ErrorLogLevel].forEach((t=>{if((e&t)===t){const e=this._Levels[t];k[e.name]=k._LogEnabled.bind(k,t)}}))}}k.NoneLogLevel=0,k.MessageLogLevel=1,k.WarningLogLevel=2,k.ErrorLogLevel=4,k.AllLogLevel=7,k.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.",k._LogCache="",k._LogLimitOutputs={},k._Levels=[{},{color:"white",logFunc:console.log,name:"Log"},{color:"orange",logFunc:console.warn,name:"Warn"},{},{color:"red",logFunc:console.error,name:"Error"}],k.errorsCount=0,k.Log=k._LogEnabled.bind(k,k.MessageLogLevel),k.Warn=k._LogEnabled.bind(k,k.WarningLogLevel),k.Error=k._LogEnabled.bind(k,k.ErrorLogLevel);class G extends L{constructor(e=0,t){super(e,t)}execute(){}serialize(e){return super._serialize({name:"DoNothingAction",properties:[]},e)}}class z extends L{constructor(e,t,i,s){super(e,s),this._target=t,this._parent=i}_prepare(){}execute(){if(this._target.parent===this._parent)return;const e=this._parent.getWorldMatrix().clone();e.invert(),this._target.position=S.TransformCoordinates(this._target.position,e),this._target.parent=this._parent}serialize(e){return super._serialize({name:"SetParentAction",properties:[L._GetTargetProperty(this._target),L._GetTargetProperty(this._parent)]},e)}}m("BABYLON.SetParentAction",z),m("BABYLON.ExecuteCodeAction",class extends L{constructor(e,t,i){super(e,i),this.func=t}execute(e){this.func(e)}}),m("BABYLON.DoNothingAction",G),m("BABYLON.StopAnimationAction",class extends L{constructor(e,t,i){super(e,i),this._target=t}_prepare(){}execute(){this._actionManager.getScene().stopAnimation(this._target)}serialize(e){return super._serialize({name:"StopAnimationAction",properties:[L._GetTargetProperty(this._target)]},e)}}),m("BABYLON.PlayAnimationAction",class extends L{constructor(e,t,i,s,r,n){super(e,n),this.from=i,this.to=s,this.loop=r,this._target=t}_prepare(){}execute(){this._actionManager.getScene().beginAnimation(this._target,this.from,this.to,this.loop)}serialize(e){return super._serialize({name:"PlayAnimationAction",properties:[L._GetTargetProperty(this._target),{name:"from",value:String(this.from)},{name:"to",value:String(this.to)},{name:"loop",value:L._SerializeValueAsString(this.loop)||!1}]},e)}}),m("BABYLON.IncrementValueAction",class extends L{constructor(e,t,i,s,r){super(e,r),this.propertyPath=i,this.value=s,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath),"number"!=typeof this._effectiveTarget[this._property]&&k.Warn("Warning: IncrementValueAction can only be used with number values")}execute(){this._effectiveTarget[this._property]+=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"IncrementValueAction",properties:[L._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:L._SerializeValueAsString(this.value)}]},e)}}),m("BABYLON.SetValueAction",class extends L{constructor(e,t,i,s,r){super(e,r),this.propertyPath=i,this.value=s,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"SetValueAction",properties:[L._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:L._SerializeValueAsString(this.value)}]},e)}}),m("BABYLON.SetStateAction",class extends L{constructor(e,t,i,s){super(e,s),this.value=i,this._target=t}execute(){this._target.state=this.value}serialize(e){return super._serialize({name:"SetStateAction",properties:[L._GetTargetProperty(this._target),{name:"value",value:this.value}]},e)}}),m("BABYLON.SetParentAction",z),m("BABYLON.SwitchBooleanAction",class extends L{constructor(e,t,i,s){super(e,s),this.propertyPath=i,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=!this._effectiveTarget[this._property]}serialize(e){return super._serialize({name:"SwitchBooleanAction",properties:[L._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath}]},e)}}),m("BABYLON.CombineAction",class extends L{constructor(e,t,i,s=!0){super(e,i),this.children=t,this.enableChildrenConditions=s}_prepare(){for(let e=0;e<this.children.length;e++)this.children[e]._actionManager=this._actionManager,this.children[e]._prepare()}execute(e){for(const t of this.children)this.enableChildrenConditions&&!t._evaluateConditionForCurrentFrame()||t.execute(e)}serialize(e){const t=super._serialize({name:"CombineAction",properties:[],combine:[]},e);for(let e=0;e<this.children.length;e++)t.combine.push(this.children[e].serialize(null));return t}});const W=(e,t,i)=>e?e.getClassName&&"Mesh"===e.getClassName()?null:!e.getClassName||"SubMesh"!==e.getClassName()&&"PhysicsBody"!==e.getClassName()?e.clone?e.clone():Array.isArray(e)?e.slice():i&&"object"==typeof e?Object.assign({},e):null:e.clone(t):null;class H{static DeepCopy(e,t,i,s,r=!1){const n=function(e){const t=[];do{Object.getOwnPropertyNames(e).forEach((function(e){-1===t.indexOf(e)&&t.push(e)}))}while(e=Object.getPrototypeOf(e));return t}(e);for(const o of n){if("_"===o[0]&&(!s||-1===s.indexOf(o)))continue;if(o.endsWith("Observable"))continue;if(i&&-1!==i.indexOf(o))continue;const n=e[o],a=typeof n;if("function"!==a)try{if("object"===a)if(n instanceof Uint8Array)t[o]=Uint8Array.from(n);else if(n instanceof Array){if(t[o]=[],n.length>0)if("object"==typeof n[0])for(let e=0;e<n.length;e++){const i=W(n[e],t,r);-1===t[o].indexOf(i)&&t[o].push(i)}else t[o]=n.slice(0)}else t[o]=W(n,t,r);else t[o]=n}catch(e){k.Warn(e.message)}}}}class X extends r{constructor(e){super(),(e=e||x.LastCreatedScene)&&(this._scene=e,e.actionManagers.push(this))}dispose(){const e=this._scene.actionManagers.indexOf(this);for(let e=0;e<this.actions.length;e++){const t=this.actions[e];X.Triggers[t.trigger]--,0===X.Triggers[t.trigger]&&delete X.Triggers[t.trigger]}this.actions.length=0,e>-1&&this._scene.actionManagers.splice(e,1);const t=this._scene.meshes.filter((e=>e.actionManager===this));for(const e of t)e.actionManager=null}getScene(){return this._scene}hasSpecificTriggers(e){for(let t=0;t<this.actions.length;t++){const i=this.actions[t];if(e.indexOf(i.trigger)>-1)return!0}return!1}hasSpecificTriggers2(e,t){for(let i=0;i<this.actions.length;i++){const s=this.actions[i];if(e==s.trigger||t==s.trigger)return!0}return!1}hasSpecificTrigger(e,t){for(let i=0;i<this.actions.length;i++){const s=this.actions[i];if(s.trigger===e){if(!t)return!0;if(t(s.getTriggerParameter()))return!0}}return!1}get hasPointerTriggers(){for(let e=0;e<this.actions.length;e++){const t=this.actions[e];if(t.trigger>=X.OnPickTrigger&&t.trigger<=X.OnPointerOutTrigger)return!0}return!1}get hasPickTriggers(){for(let e=0;e<this.actions.length;e++){const t=this.actions[e];if(t.trigger>=X.OnPickTrigger&&t.trigger<=X.OnPickUpTrigger)return!0}return!1}registerAction(e){return e.trigger===X.OnEveryFrameTrigger&&this.getScene().actionManager!==this?(k.Warn("OnEveryFrameTrigger can only be used with scene.actionManager"),null):(this.actions.push(e),this.getScene()._registeredActions++,X.Triggers[e.trigger]?X.Triggers[e.trigger]++:X.Triggers[e.trigger]=1,e._actionManager=this,e._prepare(),e)}unregisterAction(e){const t=this.actions.indexOf(e);return-1!==t&&(this.actions.splice(t,1),X.Triggers[e.trigger]-=1,0===X.Triggers[e.trigger]&&delete X.Triggers[e.trigger],e._actionManager=null,this.getScene()._registeredActions--,!0)}processTrigger(e,t){for(let i=0;i<this.actions.length;i++){const s=this.actions[i];if(s.trigger===e){if(t&&(e===X.OnKeyUpTrigger||e===X.OnKeyDownTrigger)){const e=s.getTriggerParameter();if("function"==typeof e){if(!e(t))continue}else if(e&&e!==t.sourceEvent.keyCode){if(!e.toLowerCase)continue;const i=e.toLowerCase();if(i!==t.sourceEvent.key){const e=t.sourceEvent.charCode?t.sourceEvent.charCode:t.sourceEvent.keyCode;if(String.fromCharCode(e).toLowerCase()!==i)continue}}}s._executeCurrent(t)}}}_getEffectiveTarget(e,t){const i=t.split(".");for(let t=0;t<i.length-1;t++)e=e[i[t]];return e}_getProperty(e){const t=e.split(".");return t[t.length-1]}serialize(e){const t={children:new Array,name:e,type:3,properties:new Array};for(let e=0;e<this.actions.length;e++){const i={type:0,children:new Array,name:X.GetTriggerName(this.actions[e].trigger),properties:new Array},s=this.actions[e].triggerOptions;if(s&&"number"!=typeof s)if(s.parameter instanceof Node)i.properties.push(L._GetTargetProperty(s.parameter));else if("object"==typeof s.parameter){const e={};H.DeepCopy(s.parameter,e,["mesh"]),s.parameter&&s.parameter.mesh&&(e._meshId=s.parameter.mesh.id),i.properties.push({name:"parameter",targetType:null,value:e})}else i.properties.push({name:"parameter",targetType:null,value:s.parameter});this.actions[e].serialize(i),t.children.push(i)}return t}static Parse(e,t,i){const s=new X(i);null===t?i.actionManager=s:t.actionManager=s;const r=(e,t,i,s)=>{if(null===s){const e=parseFloat(t);return"true"===t||"false"===t?"true"===t:isNaN(e)?t:e}const r=s.split("."),n=t.split(",");for(let e=0;e<r.length;e++)i=i[r[e]];if("boolean"==typeof i)return"true"===n[0];if("string"==typeof i)return n[0];const o=[];for(let e=0;e<n.length;e++)o.push(parseFloat(n[e]));return i instanceof S?S.FromArray(o):i instanceof b?b.FromArray(o):i instanceof N?N.FromArray(o):i instanceof F?F.FromArray(o):parseFloat(n[0])},n=(e,t,o,a,l=null)=>{if(e.detached)return;const h=[];let c=null,u=null;const d=e.combine&&e.combine.length>0;if(2===e.type?h.push(s):h.push(t),d){const t=[];for(let i=0;i<e.combine.length;i++)n(e.combine[i],X.NothingTrigger,o,a,t);h.push(t)}else for(let t=0;t<e.properties.length;t++){let s=e.properties[t].value;const n=e.properties[t].name,o=e.properties[t].targetType;"target"===n?s=c="SceneProperties"===o?i:"MaterialProperties"===o?i.getMaterialByName(s):i.getNodeByName(s):"parent"===n?s=i.getNodeByName(s):"sound"===n?i.getSoundByName&&(s=i.getSoundByName(s)):"propertyPath"!==n?s=2===e.type&&"operator"===n?V[s]:r(0,s,c,"value"===n?u:null):u=s,h.push(s)}if(null===l?h.push(o):h.push(null),"InterpolateValueAction"===e.name){const e=h[h.length-2];h[h.length-1]=e,h[h.length-2]=o}let p=((e,t)=>{const i=g("BABYLON."+e);return i&&new i(...t)})(e.name,h);if(p instanceof U&&null!==o){const e=new G(t,o);a?a.then(e):s.registerAction(e),a=e}null===l?p instanceof U?(o=p,p=a):(o=null,a?a.then(p):s.registerAction(p)):l.push(p);for(let i=0;i<e.children.length;i++)n(e.children[i],t,o,p,null)};for(let t=0;t<e.children.length;t++){let s;const r=e.children[t];if(r.properties.length>0){const e=r.properties[0].value,t=null===r.properties[0].targetType?e:i.getMeshByName(e);t._meshId&&(t.mesh=i.getMeshById(t._meshId)),s={trigger:X[r.name],parameter:t}}else s=X[r.name];for(let e=0;e<r.children.length;e++)r.detached||n(r.children[e],s,null,null)}}static GetTriggerName(e){switch(e){case 0:return"NothingTrigger";case 1:return"OnPickTrigger";case 2:return"OnLeftPickTrigger";case 3:return"OnRightPickTrigger";case 4:return"OnCenterPickTrigger";case 5:return"OnPickDownTrigger";case 6:return"OnDoublePickTrigger";case 7:return"OnPickUpTrigger";case 8:return"OnLongPressTrigger";case 9:return"OnPointerOverTrigger";case 10:return"OnPointerOutTrigger";case 11:return"OnEveryFrameTrigger";case 12:return"OnIntersectionEnterTrigger";case 13:return"OnIntersectionExitTrigger";case 14:return"OnKeyDownTrigger";case 15:return"OnKeyUpTrigger";case 16:return"OnPickOutTrigger";default:return""}}}X.NothingTrigger=0,X.OnPickTrigger=1,X.OnLeftPickTrigger=2,X.OnRightPickTrigger=3,X.OnCenterPickTrigger=4,X.OnPickDownTrigger=5,X.OnDoublePickTrigger=6,X.OnPickUpTrigger=7,X.OnPickOutTrigger=16,X.OnLongPressTrigger=8,X.OnPointerOverTrigger=9,X.OnPointerOutTrigger=10,X.OnEveryFrameTrigger=11,X.OnIntersectionEnterTrigger=12,X.OnIntersectionExitTrigger=13,X.OnKeyDownTrigger=14,X.OnKeyUpTrigger=15,m("BABYLON.PlaySoundAction",class extends L{constructor(e,t,i){super(e,i),this._sound=t}_prepare(){}execute(){void 0!==this._sound&&this._sound.play()}serialize(e){return super._serialize({name:"PlaySoundAction",properties:[{name:"sound",value:this._sound.name}]},e)}}),m("BABYLON.StopSoundAction",class extends L{constructor(e,t,i){super(e,i),this._sound=t}_prepare(){}execute(){void 0!==this._sound&&this._sound.stop()}serialize(e){return super._serialize({name:"StopSoundAction",properties:[{name:"sound",value:this._sound.name}]},e)}});class Y{static Eval(e,t){return"true"===(e=e.match(/\([^()]*\)/g)?e.replace(/\([^()]*\)/g,(e=>(e=e.slice(1,e.length-1),Y._HandleParenthesisContent(e,t)))):Y._HandleParenthesisContent(e,t))||"false"!==e&&Y.Eval(e,t)}static _HandleParenthesisContent(e,t){let i;t=t||(e=>"true"===e);const s=e.split("||");for(const e in s)if(Object.prototype.hasOwnProperty.call(s,e)){let r=Y._SimplifyNegation(s[e].trim());const n=r.split("&&");if(n.length>1)for(let e=0;e<n.length;++e){const s=Y._SimplifyNegation(n[e].trim());if(i="true"!==s&&"false"!==s?"!"===s[0]?!t(s.substring(1)):t(s):"true"===s,!i){r="false";break}}if(i||"true"===r){i=!0;break}i="true"!==r&&"false"!==r?"!"===r[0]?!t(r.substring(1)):t(r):"true"===r}return i?"true":"false"}static _SimplifyNegation(e){return"!true"===(e=(e=e.replace(/^[\s!]+/,(e=>(e=e.replace(/[\s]/g,(()=>""))).length%2?"!":""))).trim())?e="false":"!false"===e&&(e="true"),e}}class j{static EnableFor(e){e._tags=e._tags||{},e.hasTags=()=>j.HasTags(e),e.addTags=t=>j.AddTagsTo(e,t),e.removeTags=t=>j.RemoveTagsFrom(e,t),e.matchesTagsQuery=t=>j.MatchesQuery(e,t)}static DisableFor(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery}static HasTags(e){if(!e._tags)return!1;const t=e._tags;for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!0;return!1}static GetTags(e,t=!0){if(!e._tags)return null;if(t){const t=[];for(const i in e._tags)Object.prototype.hasOwnProperty.call(e._tags,i)&&!0===e._tags[i]&&t.push(i);return t.join(" ")}return e._tags}static AddTagsTo(e,t){t&&"string"==typeof t&&t.split(" ").forEach((function(t){j._AddTagTo(e,t)}))}static _AddTagTo(e,t){""!==(t=t.trim())&&"true"!==t&&"false"!==t&&(t.match(/[\s]/)||t.match(/^([!]|([|]|[&]){2})/)||(j.EnableFor(e),e._tags[t]=!0))}static RemoveTagsFrom(e,t){if(!j.HasTags(e))return;const i=t.split(" ");for(const t in i)j._RemoveTagFrom(e,i[t])}static _RemoveTagFrom(e,t){delete e._tags[t]}static MatchesQuery(e,t){return void 0===t||(""===t?j.HasTags(e):Y.Eval(t,(t=>j.HasTags(e)&&e._tags[t])))}}const K={};function $(e,t=!1){if(!t||!K[e])return K[e]=!0,`${e} needs to be imported before as it contains a side-effect required by your code.`}const q={},Q={},Z=function(e,t,i,s={}){const r=e();j&&j.HasTags(t)&&j.AddTagsTo(r,j.GetTags(t,!0));const n=J(r),o={};for(const e in n){const a=n[e],l=t[e],h=a.type;if(null!=l&&("uniqueId"!==e||de.AllowLoadingUniqueId))switch(h){case 0:case 6:case 11:r[e]=l;break;case 1:s.cloneTexturesOnlyOnce&&o[l.uniqueId]?r[e]=o[l.uniqueId]:(r[e]=i||l.isRenderTarget?l:l.clone(),o[l.uniqueId]=r[e]);break;case 2:case 3:case 4:case 5:case 7:case 10:case 12:r[e]=i?l:l.clone()}}return r};function J(e){const t=e.getClassName();if(Q[t])return Q[t];Q[t]={};const i=Q[t];let s=e,r=t;for(;r;){const e=q[r];for(const t in e)i[t]=e[t];let t,n=!1;do{if(t=Object.getPrototypeOf(s),!t.getClassName){n=!0;break}if(t.getClassName()!==r)break;s=t}while(t);if(n)break;r=t.getClassName(),s=t}return i}function ee(e,t){return(i,s)=>{const r=function(e){const t=e.getClassName();return q[t]||(q[t]={}),q[t]}(i);r[s]||(r[s]={type:e,sourceName:t})}}function te(e,t=null){return function(e,t=null){return(i,s)=>{const r=t||"_"+s;Object.defineProperty(i,s,{get:function(){return this[r]},set:function(t){"function"==typeof this.equals&&this.equals(t)||this[r]!==t&&(this[r]=t,i[e].apply(this))},enumerable:!0,configurable:!0})}}(e,t)}function ie(e){return ee(0,e)}function se(e){return ee(1,e)}function re(e){return ee(2,e)}function ne(e){return ee(3,e)}function oe(e){return ee(4,e)}function ae(e){return ee(5,e)}function le(e){return ee(6,e)}function he(e){return ee(8,e)}function ce(e){return ee(9,e)}function ue(e){return ee(12,e)}class de{static AppendSerializedAnimations(e,t){if(e.animations){t.animations=[];for(let i=0;i<e.animations.length;i++){const s=e.animations[i];t.animations.push(s.serialize())}}}static Serialize(e,t){t||(t={}),j&&(t.tags=j.GetTags(e));const i=J(e);for(const s in i){const r=i[s],n=r.sourceName||s,o=r.type,a=e[s];if(null!=a&&("uniqueId"!==s||de.AllowLoadingUniqueId))switch(o){case 0:t[n]=a;break;case 1:case 3:case 7:case 9:t[n]=a.serialize();break;case 2:case 4:case 5:case 8:case 10:case 12:t[n]=a.asArray();break;case 6:case 11:t[n]=a.id}}return t}static ParseProperties(e,t,i,s){s||(s="");const r=J(t);for(const n in r){const o=r[n],a=e[o.sourceName||n],l=o.type;if(null!=a&&("uniqueId"!==n||de.AllowLoadingUniqueId)){const e=t;switch(l){case 0:e[n]=a;break;case 1:i&&(e[n]=de._TextureParser(a,i,s));break;case 2:e[n]=N.FromArray(a);break;case 3:e[n]=de._FresnelParametersParser(a);break;case 4:e[n]=E.FromArray(a);break;case 5:e[n]=S.FromArray(a);break;case 6:i&&(e[n]=i.getLastMeshById(a));break;case 7:e[n]=de._ColorCurvesParser(a);break;case 8:e[n]=F.FromArray(a);break;case 9:e[n]=de._ImageProcessingConfigurationParser(a);break;case 10:e[n]=C.FromArray(a);break;case 11:i&&(e[n]=i.getCameraById(a));break;case 12:e[n]=y.FromArray(a)}}}}static Parse(e,t,i,s=null){const r=e();return j&&j.AddTagsTo(r,t.tags),de.ParseProperties(t,r,i,s),r}static Clone(e,t,i={}){return Z(e,t,!1,i)}static Instanciate(e,t){return Z(e,t,!0)}}function pe(e,t,i,s){const r=i.value;i.value=(...i)=>{let n=r;if("undefined"!=typeof _native&&_native[t]){const e=_native[t];n=s?(...t)=>s(...t)?e(...t):r(...t):e}return e[t]=n,n(...i)}}var _e;de.AllowLoadingUniqueId=!1,de._ImageProcessingConfigurationParser=e=>{throw $("ImageProcessingConfiguration")},de._FresnelParametersParser=e=>{throw $("FresnelParameters")},de._ColorCurvesParser=e=>{throw $("ColorCurves")},de._TextureParser=(e,t,i)=>{throw $("Texture")},pe.filter=function(e){return(t,i,s)=>pe(t,i,s,e)},function(e){e[e.NONE=0]="NONE",e[e.STEP=1]="STEP"}(_e||(_e={}));class fe{constructor(e,t,i){this.name=e,this.from=t,this.to=i}clone(){return new fe(this.name,this.from,this.to)}}function me(e,t,i,s){var r,n=arguments.length,o=n<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,s);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(n<3?r(o):n>3?r(t,i,o):r(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o}Object.create,Object.create;class ge{constructor(){this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new a,this._onClonedObservable=new a}}class ve{static AddNodeConstructor(e,t){this._NodeConstructors[e]=t}static Construct(e,t,i,s){const r=this._NodeConstructors[e];return r?r(t,i,s):null}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}get accessibilityTag(){return this._accessibilityTag}get doNotSerialize(){return!!this._nodeDataStorage._doNotSerialize||!!this._parentNode&&this._parentNode.doNotSerialize}set doNotSerialize(e){this._nodeDataStorage._doNotSerialize=e}isDisposed(){return this._nodeDataStorage._isDisposed}set parent(e){if(this._parentNode===e)return;const t=this._parentNode;if(this._parentNode&&void 0!==this._parentNode._children&&null!==this._parentNode._children){const t=this._parentNode._children.indexOf(this);-1!==t&&this._parentNode._children.splice(t,1),e||this._nodeDataStorage._isDisposed||this._addToSceneRootNodes()}this._parentNode=e,this._parentNode&&(void 0!==this._parentNode._children&&null!==this._parentNode._children||(this._parentNode._children=new Array),this._parentNode._children.push(this),t||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}get parent(){return this._parentNode}_serializeAsParent(e){e.parentId=this.uniqueId}_addToSceneRootNodes(){-1===this._nodeDataStorage._sceneRootNodesIndex&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))}_removeFromSceneRootNodes(){if(-1!==this._nodeDataStorage._sceneRootNodesIndex){const e=this._scene.rootNodes,t=e.length-1;e[this._nodeDataStorage._sceneRootNodesIndex]=e[t],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}getClassName(){return"Node"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onEnabledStateChangedObservable(){return this._nodeDataStorage._onEnabledStateChangedObservable}get onClonedObservable(){return this._nodeDataStorage._onClonedObservable}constructor(e,t=null){this._isDirty=!1,this._nodeDataStorage=new ge,this.state="",this.metadata=null,this.reservedDataStore=null,this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new a,this._parentContainer=null,this.animations=[],this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=y.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new a,this._onDisposeObserver=null,this._behaviors=new Array,this.name=e,this.id=e,this._scene=t||x.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache()}getScene(){return this._scene}getEngine(){return this._scene.getEngine()}addBehavior(e,t=!1){return-1!==this._behaviors.indexOf(e)||(e.init(),this._scene.isLoading&&!t?this._scene.onDataLoadedObservable.addOnce((()=>{e.attach(this)})):e.attach(this),this._behaviors.push(e)),this}removeBehavior(e){const t=this._behaviors.indexOf(e);return-1===t||(this._behaviors[t].detach(),this._behaviors.splice(t,1)),this}get behaviors(){return this._behaviors}getBehaviorByName(e){for(const t of this._behaviors)if(t.name===e)return t;return null}getWorldMatrix(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix}_getWorldMatrixDeterminant(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant}get worldMatrixFromCache(){return this._worldMatrix}_initCache(){this._cache={},this._cache.parent=void 0}updateCache(e){!e&&this.isSynchronized()||(this._cache.parent=this.parent,this._updateCache())}_getActionManagerForTrigger(e,t=!0){return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_updateCache(e){}_isSynchronized(){return!0}_markSyncedWithParent(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)}isSynchronizedWithParent(){return!this._parentNode||!this._parentNode._isDirty&&this._parentUpdateId===this._parentNode._childUpdateId&&this._parentNode.isSynchronized()}isSynchronized(){return this._cache.parent!==this._parentNode?(this._cache.parent=this._parentNode,!1):!(this._parentNode&&!this.isSynchronizedWithParent())&&this._isSynchronized()}isReady(e=!1){return this._nodeDataStorage._isReady}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}isEnabled(e=!0){return!1===e?this._nodeDataStorage._isEnabled:!!this._nodeDataStorage._isEnabled&&this._nodeDataStorage._isParentEnabled}_syncParentEnabledState(){this._nodeDataStorage._isParentEnabled=!this._parentNode||this._parentNode.isEnabled(),this._children&&this._children.forEach((e=>{e._syncParentEnabledState()}))}setEnabled(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._syncParentEnabledState(),this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e))}isDescendantOf(e){return!!this.parent&&(this.parent===e||this.parent.isDescendantOf(e))}_getDescendants(e,t=!1,i){if(this._children)for(let s=0;s<this._children.length;s++){const r=this._children[s];i&&!i(r)||e.push(r),t||r._getDescendants(e,!1,i)}}getDescendants(e,t){const i=[];return this._getDescendants(i,e,t),i}getChildMeshes(e,t){const i=[];return this._getDescendants(i,e,(e=>(!t||t(e))&&void 0!==e.cullingStrategy)),i}getChildren(e,t=!0){return this.getDescendants(t,e)}_setReady(e){e!==this._nodeDataStorage._isReady&&(e?(this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0):this._nodeDataStorage._isReady=!1)}getAnimationByName(e){for(let t=0;t<this.animations.length;t++){const i=this.animations[t];if(i.name===e)return i}return null}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=ve._AnimationRangeFactory(e,t,i);for(let s=0,r=this.animations.length;s<r;s++)this.animations[s]&&this.animations[s].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,s=this.animations.length;i<s;i++)this.animations[i]&&this.animations[i].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}clone(e,t,i){const s=de.Clone((()=>new ve(e,this.getScene())),this);if(t&&(s.parent=t),!i){const t=this.getDescendants(!0);for(let i=0;i<t.length;i++){const r=t[i];r.clone(e+"."+r.name,s)}}return s}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}beginAnimation(e,t,i,s){const r=this.getAnimationRange(e);return r?this._scene.beginAnimation(this,r.from,r.to,t,i,s):null}serializeAnimationRanges(){const e=[];for(const t in this._ranges){const i=this._ranges[t];if(!i)continue;const s={};s.name=t,s.from=i.from,s.to=i.to,e.push(s)}return e}computeWorldMatrix(e){return this._worldMatrix||(this._worldMatrix=y.Identity()),this._worldMatrix}dispose(e,t=!1){if(this._nodeDataStorage._isDisposed=!0,!e){const i=this.getDescendants(!0);for(const s of i)s.dispose(e,t)}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(const e of this._behaviors)e.detach();this._behaviors.length=0,this.metadata=null}static ParseAnimationRanges(e,t,i){if(t.ranges)for(let i=0;i<t.ranges.length;i++){const s=t.ranges[i];e.createAnimationRange(s.name,s.from,s.to)}}getHierarchyBoundingVectors(e=!0,t=null){let i,s;this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);const r=this;if(r.getBoundingInfo&&r.subMeshes){const e=r.getBoundingInfo();i=e.boundingBox.minimumWorld.clone(),s=e.boundingBox.maximumWorld.clone()}else i=new S(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s=new S(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e){const e=this.getDescendants(!1);for(const r of e){const e=r;if(e.computeWorldMatrix(!0),t&&!t(e))continue;if(!e.getBoundingInfo||0===e.getTotalVertices())continue;const n=e.getBoundingInfo().boundingBox,o=n.minimumWorld,a=n.maximumWorld;S.CheckExtends(o,i,s),S.CheckExtends(a,i,s)}}return{min:i,max:s}}}ve._AnimationRangeFactory=(e,t,i)=>{throw $("AnimationRange")},ve._NodeConstructors={},me([ie()],ve.prototype,"name",void 0),me([ie()],ve.prototype,"id",void 0),me([ie()],ve.prototype,"uniqueId",void 0),me([ie()],ve.prototype,"state",void 0),me([ie()],ve.prototype,"metadata",void 0);class xe{constructor(e,t){this.width=e,this.height=t}toString(){return`{W: ${this.width}, H: ${this.height}}`}getClassName(){return"Size"}getHashCode(){let e=0|this.width;return e=397*e^this.height,e}copyFrom(e){this.width=e.width,this.height=e.height}copyFromFloats(e,t){return this.width=e,this.height=t,this}set(e,t){return this.copyFromFloats(e,t)}multiplyByFloats(e,t){return new xe(this.width*e,this.height*t)}clone(){return new xe(this.width,this.height)}equals(e){return!!e&&this.width===e.width&&this.height===e.height}get surface(){return this.width*this.height}static Zero(){return new xe(0,0)}add(e){return new xe(this.width+e.width,this.height+e.height)}subtract(e){return new xe(this.width-e.width,this.height-e.height)}scale(e){return new xe(this.width*e,this.height*e)}static Lerp(e,t,i){const s=e.width+(t.width-e.width)*i,r=e.height+(t.height-e.height)*i;return new xe(s,r)}}class Te{constructor(){this._xhr="undefined"!=typeof _native&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest,this._requestURL=""}static get IsCustomRequestAvailable(){return Object.keys(Te.CustomRequestHeaders).length>0||Te.CustomRequestModifiers.length>0}_injectCustomRequestHeaders(){if(!this._shouldSkipRequestModifications(this._requestURL))for(const e in Te.CustomRequestHeaders){const t=Te.CustomRequestHeaders[e];t&&this._xhr.setRequestHeader(e,t)}}_shouldSkipRequestModifications(e){return Te.SkipRequestModificationForBabylonCDN&&(e.includes("preview.babylonjs.com")||e.includes("cdn.babylonjs.com"))}get onprogress(){return this._xhr.onprogress}set onprogress(e){this._xhr.onprogress=e}get readyState(){return this._xhr.readyState}get status(){return this._xhr.status}get statusText(){return this._xhr.statusText}get response(){return this._xhr.response}get responseURL(){return this._xhr.responseURL}get responseText(){return this._xhr.responseText}get responseType(){return this._xhr.responseType}set responseType(e){this._xhr.responseType=e}get timeout(){return this._xhr.timeout}set timeout(e){this._xhr.timeout=e}addEventListener(e,t,i){this._xhr.addEventListener(e,t,i)}removeEventListener(e,t,i){this._xhr.removeEventListener(e,t,i)}abort(){this._xhr.abort()}send(e){Te.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(e)}open(e,t){for(const e of Te.CustomRequestModifiers){if(this._shouldSkipRequestModifications(t))return;e(this._xhr,t)}return t=(t=t.replace("file:http:","http:")).replace("file:https:","https:"),this._requestURL=t,this._xhr.open(e,t,!0)}setRequestHeader(e,t){this._xhr.setRequestHeader(e,t)}getResponseHeader(e){return this._xhr.getResponseHeader(e)}}Te.CustomRequestHeaders={},Te.CustomRequestModifiers=new Array,Te.SkipRequestModificationForBabylonCDN=!0;const Ee=Object.freeze(new C(0,0,0,0)),Se=Object.freeze(S.Zero()),be=Object.freeze(E.Zero()),Ce=Object.freeze(xe.Zero()),ye=Object.freeze(N.Black()),Ae=Object.freeze(new F(0,0,0,0)),Re={key:0,repeatCount:0,loopMode:2};class Ie{static _PrepareAnimation(e,t,i,s,r,n,o,a){let l;if(!isNaN(parseFloat(r))&&isFinite(r)?l=Ie.ANIMATIONTYPE_FLOAT:r instanceof C?l=Ie.ANIMATIONTYPE_QUATERNION:r instanceof S?l=Ie.ANIMATIONTYPE_VECTOR3:r instanceof E?l=Ie.ANIMATIONTYPE_VECTOR2:r instanceof N?l=Ie.ANIMATIONTYPE_COLOR3:r instanceof F?l=Ie.ANIMATIONTYPE_COLOR4:r instanceof xe&&(l=Ie.ANIMATIONTYPE_SIZE),null==l)return null;const h=new Ie(e,t,i,l,o),c=[{frame:0,value:r},{frame:s,value:n}];return h.setKeys(c),void 0!==a&&h.setEasingFunction(a),h}static CreateAnimation(e,t,i,s){const r=new Ie(e+"Animation",e,i,t,Ie.ANIMATIONLOOPMODE_CONSTANT);return r.setEasingFunction(s),r}static CreateAndStartAnimation(e,t,i,s,r,n,o,a,l,h,c){const u=Ie._PrepareAnimation(e,i,s,r,n,o,a,l);return u?(t.getScene&&(c=t.getScene()),c?c.beginDirectAnimation(t,[u],0,r,1===u.loopMode,1,h):null):null}static CreateAndStartHierarchyAnimation(e,t,i,s,r,n,o,a,l,h,c){const u=Ie._PrepareAnimation(e,s,r,n,o,a,l,h);return u?t.getScene().beginDirectHierarchyAnimation(t,i,[u],0,n,1===u.loopMode,1,c):null}static CreateMergeAndStartAnimation(e,t,i,s,r,n,o,a,l,h){const c=Ie._PrepareAnimation(e,i,s,r,n,o,a,l);return c?(t.animations.push(c),t.getScene().beginAnimation(t,0,r,1===c.loopMode,1,h)):null}static MakeAnimationAdditive(e,t,i,s=!1,r){var n,o;let a;a="object"==typeof t?t:{referenceFrame:null!=t?t:0,range:i,cloneOriginalAnimation:s,clonedAnimationName:r};let l=e;if(a.cloneOriginalAnimation&&(l=e.clone(),l.name=a.clonedAnimationName||l.name),!l._keys.length)return l;const h=a.referenceFrame&&a.referenceFrame>=0?a.referenceFrame:0;let c=0;const u=l._keys[0];let d=l._keys.length-1;const p=l._keys[d],_={referenceValue:u.value,referencePosition:R.Vector3[0],referenceQuaternion:R.Quaternion[0],referenceScaling:R.Vector3[1],keyPosition:R.Vector3[2],keyQuaternion:R.Quaternion[1],keyScaling:R.Vector3[3]};let f=u.frame,m=p.frame;if(a.range){const e=l.getRange(a.range);e&&(f=e.from,m=e.to)}else f=null!==(n=a.fromFrame)&&void 0!==n?n:f,m=null!==(o=a.toFrame)&&void 0!==o?o:m;if(f!==u.frame&&(c=l.createKeyForFrame(f)),m!==p.frame&&(d=l.createKeyForFrame(m)),1===l._keys.length){const e=l._getKeyValue(l._keys[0]);_.referenceValue=e.clone?e.clone():e}else if(h<=u.frame){const e=l._getKeyValue(u.value);_.referenceValue=e.clone?e.clone():e}else if(h>=p.frame){const e=l._getKeyValue(p.value);_.referenceValue=e.clone?e.clone():e}else{Re.key=0;const e=l._interpolate(h,Re);_.referenceValue=e.clone?e.clone():e}l.dataType===Ie.ANIMATIONTYPE_QUATERNION?_.referenceValue.normalize().conjugateInPlace():l.dataType===Ie.ANIMATIONTYPE_MATRIX&&(_.referenceValue.decompose(_.referenceScaling,_.referenceQuaternion,_.referencePosition),_.referenceQuaternion.normalize().conjugateInPlace());let g=Number.MAX_VALUE;const v=a.clipKeys?[]:null;for(let e=c;e<=d;e++){let t=l._keys[e];if(v&&(t={frame:t.frame,value:t.value.clone?t.value.clone():t.value,inTangent:t.inTangent,outTangent:t.outTangent,interpolation:t.interpolation,lockedTangent:t.lockedTangent},g===Number.MAX_VALUE&&(g=t.frame),t.frame-=g,v.push(t)),!e||l.dataType===Ie.ANIMATIONTYPE_FLOAT||t.value!==u.value)switch(l.dataType){case Ie.ANIMATIONTYPE_MATRIX:t.value.decompose(_.keyScaling,_.keyQuaternion,_.keyPosition),_.keyPosition.subtractInPlace(_.referencePosition),_.keyScaling.divideInPlace(_.referenceScaling),_.referenceQuaternion.multiplyToRef(_.keyQuaternion,_.keyQuaternion),y.ComposeToRef(_.keyScaling,_.keyQuaternion,_.keyPosition,t.value);break;case Ie.ANIMATIONTYPE_QUATERNION:_.referenceValue.multiplyToRef(t.value,t.value);break;case Ie.ANIMATIONTYPE_VECTOR2:case Ie.ANIMATIONTYPE_VECTOR3:case Ie.ANIMATIONTYPE_COLOR3:case Ie.ANIMATIONTYPE_COLOR4:t.value.subtractToRef(_.referenceValue,t.value);break;case Ie.ANIMATIONTYPE_SIZE:t.value.width-=_.referenceValue.width,t.value.height-=_.referenceValue.height;break;default:t.value-=_.referenceValue}}return v&&l.setKeys(v,!0),l}static TransitionTo(e,t,i,s,r,n,o,a=null){if(o<=0)return i[e]=t,a&&a(),null;const l=r*(o/1e3);n.setKeys([{frame:0,value:i[e].clone?i[e].clone():i[e]},{frame:l,value:t}]),i.animations||(i.animations=[]),i.animations.push(n);const h=s.beginAnimation(i,0,l,!1);return h.onAnimationEnd=a,h}get runtimeAnimations(){return this._runtimeAnimations}get hasRunningRuntimeAnimations(){for(const e of this._runtimeAnimations)if(!e.isStopped())return!0;return!1}constructor(e,t,i,s,r,n){this.name=e,this.targetProperty=t,this.framePerSecond=i,this.dataType=s,this.loopMode=r,this.enableBlending=n,this._easingFunction=null,this._runtimeAnimations=new Array,this._events=new Array,this.blendingSpeed=.01,this._ranges={},this.targetPropertyPath=t.split("."),this.dataType=s,this.loopMode=void 0===r?Ie.ANIMATIONLOOPMODE_CYCLE:r,this.uniqueId=Ie._UniqueIdGenerator++}toString(e){let t="Name: "+this.name+", property: "+this.targetProperty;if(t+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType],t+=", nKeys: "+(this._keys?this._keys.length:"none"),t+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),e){t+=", Ranges: {";let e=!0;for(const i in this._ranges)e&&(t+=", ",e=!1),t+=i;t+="}"}return t}addEvent(e){this._events.push(e),this._events.sort(((e,t)=>e.frame-t.frame))}removeEvents(e){for(let t=0;t<this._events.length;t++)this._events[t].frame===e&&(this._events.splice(t,1),t--)}getEvents(){return this._events}createRange(e,t,i){this._ranges[e]||(this._ranges[e]=new fe(e,t,i))}deleteRange(e,t=!0){const i=this._ranges[e];if(i){if(t){const e=i.from,t=i.to;for(let i=this._keys.length-1;i>=0;i--)this._keys[i].frame>=e&&this._keys[i].frame<=t&&this._keys.splice(i,1)}this._ranges[e]=null}}getRange(e){return this._ranges[e]}getKeys(){return this._keys}getHighestFrame(){let e=0;for(let t=0,i=this._keys.length;t<i;t++)e<this._keys[t].frame&&(e=this._keys[t].frame);return e}getEasingFunction(){return this._easingFunction}setEasingFunction(e){this._easingFunction=e}floatInterpolateFunction(e,t,i){return l.Lerp(e,t,i)}floatInterpolateFunctionWithTangents(e,t,i,s,r){return l.Hermite(e,t,i,s,r)}quaternionInterpolateFunction(e,t,i){return C.Slerp(e,t,i)}quaternionInterpolateFunctionWithTangents(e,t,i,s,r){return C.Hermite(e,t,i,s,r).normalize()}vector3InterpolateFunction(e,t,i){return S.Lerp(e,t,i)}vector3InterpolateFunctionWithTangents(e,t,i,s,r){return S.Hermite(e,t,i,s,r)}vector2InterpolateFunction(e,t,i){return E.Lerp(e,t,i)}vector2InterpolateFunctionWithTangents(e,t,i,s,r){return E.Hermite(e,t,i,s,r)}sizeInterpolateFunction(e,t,i){return xe.Lerp(e,t,i)}color3InterpolateFunction(e,t,i){return N.Lerp(e,t,i)}color3InterpolateFunctionWithTangents(e,t,i,s,r){return N.Hermite(e,t,i,s,r)}color4InterpolateFunction(e,t,i){return F.Lerp(e,t,i)}color4InterpolateFunctionWithTangents(e,t,i,s,r){return F.Hermite(e,t,i,s,r)}_getKeyValue(e){return"function"==typeof e?e():e}evaluate(e){return Re.key=0,this._interpolate(e,Re)}_interpolate(e,t,i=!1){var s;if(t.loopMode===Ie.ANIMATIONLOOPMODE_CONSTANT&&t.repeatCount>0)return t.highLimitValue.clone?t.highLimitValue.clone():t.highLimitValue;const r=this._keys,n=r.length;let o=t.key;for(;o>=0&&e<r[o].frame;)--o;for(;o+1<=n-1&&e>=r[o+1].frame;)++o;if(t.key=o,o<0)return i?void 0:this._getKeyValue(r[0].value);if(o+1>n-1)return i?void 0:this._getKeyValue(r[n-1].value);const a=r[o],l=r[o+1];if(i&&(e===a.frame||e===l.frame))return;const h=this._getKeyValue(a.value),c=this._getKeyValue(l.value);if(a.interpolation===_e.STEP)return l.frame>e?h:c;const u=void 0!==a.outTangent&&void 0!==l.inTangent,d=l.frame-a.frame;let p=(e-a.frame)/d;const _=a.easingFunction||this.getEasingFunction();switch(null!==_&&(p=_.ease(p)),this.dataType){case Ie.ANIMATIONTYPE_FLOAT:{const e=u?this.floatInterpolateFunctionWithTangents(h,a.outTangent*d,c,l.inTangent*d,p):this.floatInterpolateFunction(h,c,p);switch(t.loopMode){case Ie.ANIMATIONLOOPMODE_CYCLE:case Ie.ANIMATIONLOOPMODE_CONSTANT:case Ie.ANIMATIONLOOPMODE_YOYO:return e;case Ie.ANIMATIONLOOPMODE_RELATIVE:case Ie.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return(null!==(s=t.offsetValue)&&void 0!==s?s:0)*t.repeatCount+e}break}case Ie.ANIMATIONTYPE_QUATERNION:{const e=u?this.quaternionInterpolateFunctionWithTangents(h,a.outTangent.scale(d),c,l.inTangent.scale(d),p):this.quaternionInterpolateFunction(h,c,p);switch(t.loopMode){case Ie.ANIMATIONLOOPMODE_CYCLE:case Ie.ANIMATIONLOOPMODE_CONSTANT:case Ie.ANIMATIONLOOPMODE_YOYO:return e;case Ie.ANIMATIONLOOPMODE_RELATIVE:case Ie.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.addInPlace((t.offsetValue||Ee).scale(t.repeatCount))}return e}case Ie.ANIMATIONTYPE_VECTOR3:{const e=u?this.vector3InterpolateFunctionWithTangents(h,a.outTangent.scale(d),c,l.inTangent.scale(d),p):this.vector3InterpolateFunction(h,c,p);switch(t.loopMode){case Ie.ANIMATIONLOOPMODE_CYCLE:case Ie.ANIMATIONLOOPMODE_CONSTANT:case Ie.ANIMATIONLOOPMODE_YOYO:return e;case Ie.ANIMATIONLOOPMODE_RELATIVE:case Ie.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||Se).scale(t.repeatCount))}break}case Ie.ANIMATIONTYPE_VECTOR2:{const e=u?this.vector2InterpolateFunctionWithTangents(h,a.outTangent.scale(d),c,l.inTangent.scale(d),p):this.vector2InterpolateFunction(h,c,p);switch(t.loopMode){case Ie.ANIMATIONLOOPMODE_CYCLE:case Ie.ANIMATIONLOOPMODE_CONSTANT:case Ie.ANIMATIONLOOPMODE_YOYO:return e;case Ie.ANIMATIONLOOPMODE_RELATIVE:case Ie.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||be).scale(t.repeatCount))}break}case Ie.ANIMATIONTYPE_SIZE:switch(t.loopMode){case Ie.ANIMATIONLOOPMODE_CYCLE:case Ie.ANIMATIONLOOPMODE_CONSTANT:case Ie.ANIMATIONLOOPMODE_YOYO:return this.sizeInterpolateFunction(h,c,p);case Ie.ANIMATIONLOOPMODE_RELATIVE:case Ie.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return this.sizeInterpolateFunction(h,c,p).add((t.offsetValue||Ce).scale(t.repeatCount))}break;case Ie.ANIMATIONTYPE_COLOR3:{const e=u?this.color3InterpolateFunctionWithTangents(h,a.outTangent.scale(d),c,l.inTangent.scale(d),p):this.color3InterpolateFunction(h,c,p);switch(t.loopMode){case Ie.ANIMATIONLOOPMODE_CYCLE:case Ie.ANIMATIONLOOPMODE_CONSTANT:case Ie.ANIMATIONLOOPMODE_YOYO:return e;case Ie.ANIMATIONLOOPMODE_RELATIVE:case Ie.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||ye).scale(t.repeatCount))}break}case Ie.ANIMATIONTYPE_COLOR4:{const e=u?this.color4InterpolateFunctionWithTangents(h,a.outTangent.scale(d),c,l.inTangent.scale(d),p):this.color4InterpolateFunction(h,c,p);switch(t.loopMode){case Ie.ANIMATIONLOOPMODE_CYCLE:case Ie.ANIMATIONLOOPMODE_CONSTANT:case Ie.ANIMATIONLOOPMODE_YOYO:return e;case Ie.ANIMATIONLOOPMODE_RELATIVE:case Ie.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||Ae).scale(t.repeatCount))}break}case Ie.ANIMATIONTYPE_MATRIX:switch(t.loopMode){case Ie.ANIMATIONLOOPMODE_CYCLE:case Ie.ANIMATIONLOOPMODE_CONSTANT:case Ie.ANIMATIONLOOPMODE_YOYO:return Ie.AllowMatricesInterpolation?this.matrixInterpolateFunction(h,c,p,t.workValue):h;case Ie.ANIMATIONLOOPMODE_RELATIVE:case Ie.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return h}}return 0}matrixInterpolateFunction(e,t,i,s){return Ie.AllowMatrixDecomposeForInterpolation?s?(y.DecomposeLerpToRef(e,t,i,s),s):y.DecomposeLerp(e,t,i):s?(y.LerpToRef(e,t,i,s),s):y.Lerp(e,t,i)}clone(){const e=new Ie(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,this._keys&&e.setKeys(this._keys),this._ranges){e._ranges={};for(const t in this._ranges){const i=this._ranges[t];i&&(e._ranges[t]=i.clone())}}return e}setKeys(e,t=!1){this._keys=t?e:e.slice(0)}createKeyForFrame(e){Re.key=0;const t=this._interpolate(e,Re,!0);if(!t)return Re.key===e?Re.key:Re.key+1;const i={frame:e,value:t.clone?t.clone():t};return this._keys.splice(Re.key+1,0,i),Re.key+1}serialize(){const e={};e.name=this.name,e.property=this.targetProperty,e.framePerSecond=this.framePerSecond,e.dataType=this.dataType,e.loopBehavior=this.loopMode,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed;const t=this.dataType;e.keys=[];const i=this.getKeys();for(let s=0;s<i.length;s++){const r=i[s],n={};switch(n.frame=r.frame,t){case Ie.ANIMATIONTYPE_FLOAT:n.values=[r.value],void 0!==r.inTangent&&n.values.push(r.inTangent),void 0!==r.outTangent&&(void 0===r.inTangent&&n.values.push(void 0),n.values.push(r.outTangent)),void 0!==r.interpolation&&(void 0===r.inTangent&&n.values.push(void 0),void 0===r.outTangent&&n.values.push(void 0),n.values.push(r.interpolation));break;case Ie.ANIMATIONTYPE_QUATERNION:case Ie.ANIMATIONTYPE_MATRIX:case Ie.ANIMATIONTYPE_VECTOR3:case Ie.ANIMATIONTYPE_COLOR3:case Ie.ANIMATIONTYPE_COLOR4:n.values=r.value.asArray(),null!=r.inTangent&&n.values.push(r.inTangent.asArray()),null!=r.outTangent&&(void 0===r.inTangent&&n.values.push(void 0),n.values.push(r.outTangent.asArray())),void 0!==r.interpolation&&(void 0===r.inTangent&&n.values.push(void 0),void 0===r.outTangent&&n.values.push(void 0),n.values.push(r.interpolation))}e.keys.push(n)}e.ranges=[];for(const t in this._ranges){const i=this._ranges[t];if(!i)continue;const s={};s.name=t,s.from=i.from,s.to=i.to,e.ranges.push(s)}return e}static _UniversalLerp(e,t,i){const s=e.constructor;return s.Lerp?s.Lerp(e,t,i):s.Slerp?s.Slerp(e,t,i):e.toFixed?e*(1-i)+i*t:t}static Parse(e){const t=new Ie(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),i=e.dataType,s=[];let r,n;for(e.enableBlending&&(t.enableBlending=e.enableBlending),e.blendingSpeed&&(t.blendingSpeed=e.blendingSpeed),n=0;n<e.keys.length;n++){const t=e.keys[n];let o,a,l;switch(i){case Ie.ANIMATIONTYPE_FLOAT:r=t.values[0],t.values.length>=2&&(o=t.values[1]),t.values.length>=3&&(a=t.values[2]),t.values.length>=4&&(l=t.values[3]);break;case Ie.ANIMATIONTYPE_QUATERNION:if(r=C.FromArray(t.values),t.values.length>=8){const e=C.FromArray(t.values.slice(4,8));e.equals(C.Zero())||(o=e)}if(t.values.length>=12){const e=C.FromArray(t.values.slice(8,12));e.equals(C.Zero())||(a=e)}t.values.length>=13&&(l=t.values[12]);break;case Ie.ANIMATIONTYPE_MATRIX:r=y.FromArray(t.values),t.values.length>=17&&(l=t.values[16]);break;case Ie.ANIMATIONTYPE_COLOR3:r=N.FromArray(t.values),t.values[3]&&(o=N.FromArray(t.values[3])),t.values[4]&&(a=N.FromArray(t.values[4])),t.values[5]&&(l=t.values[5]);break;case Ie.ANIMATIONTYPE_COLOR4:r=F.FromArray(t.values),t.values[4]&&(o=F.FromArray(t.values[4])),t.values[5]&&(a=F.FromArray(t.values[5])),t.values[6]&&(l=F.FromArray(t.values[6]));break;case Ie.ANIMATIONTYPE_VECTOR3:default:r=S.FromArray(t.values),t.values[3]&&(o=S.FromArray(t.values[3])),t.values[4]&&(a=S.FromArray(t.values[4])),t.values[5]&&(l=t.values[5])}const h={};h.frame=t.frame,h.value=r,null!=o&&(h.inTangent=o),null!=a&&(h.outTangent=a),null!=l&&(h.interpolation=l),s.push(h)}if(t.setKeys(s),e.ranges)for(n=0;n<e.ranges.length;n++)r=e.ranges[n],t.createRange(r.name,r.from,r.to);return t}static AppendSerializedAnimations(e,t){de.AppendSerializedAnimations(e,t)}static ParseFromFileAsync(e,t){return new Promise(((i,s)=>{const r=new Te;r.addEventListener("readystatechange",(()=>{if(4==r.readyState)if(200==r.status){let t=JSON.parse(r.responseText);if(t.animations&&(t=t.animations),t.length){const e=[];for(const i of t)e.push(this.Parse(i));i(e)}else{const s=this.Parse(t);e&&(s.name=e),i(s)}}else s("Unable to load the animation")})),r.open("GET",t),r.send()}))}static ParseFromSnippetAsync(e){return new Promise(((t,i)=>{const s=new Te;s.addEventListener("readystatechange",(()=>{if(4==s.readyState)if(200==s.status){const i=JSON.parse(JSON.parse(s.responseText).jsonPayload);if(i.animations){const s=JSON.parse(i.animations),r=[];for(const t of s.animations){const i=this.Parse(t);i.snippetId=e,r.push(i)}t(r)}else{const s=JSON.parse(i.animation),r=this.Parse(s);r.snippetId=e,t(r)}}else i("Unable to load the snippet "+e)})),s.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),s.send()}))}}Ie._UniqueIdGenerator=0,Ie.AllowMatricesInterpolation=!1,Ie.AllowMatrixDecomposeForInterpolation=!0,Ie.SnippetUrl="https://snippet.babylonjs.com",Ie.ANIMATIONTYPE_FLOAT=0,Ie.ANIMATIONTYPE_VECTOR3=1,Ie.ANIMATIONTYPE_QUATERNION=2,Ie.ANIMATIONTYPE_MATRIX=3,Ie.ANIMATIONTYPE_COLOR3=4,Ie.ANIMATIONTYPE_COLOR4=7,Ie.ANIMATIONTYPE_VECTOR2=5,Ie.ANIMATIONTYPE_SIZE=6,Ie.ANIMATIONLOOPMODE_RELATIVE=0,Ie.ANIMATIONLOOPMODE_CYCLE=1,Ie.ANIMATIONLOOPMODE_CONSTANT=2,Ie.ANIMATIONLOOPMODE_YOYO=4,Ie.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT=5,Ie.CreateFromSnippetAsync=Ie.ParseFromSnippetAsync,m("BABYLON.Animation",Ie),ve._AnimationRangeFactory=(e,t,i)=>new fe(e,t,i),m("BABYLON.InterpolateValueAction",class extends L{constructor(e,t,i,s,r=1e3,n,o,l){super(e,n),this.duration=1e3,this.onInterpolationDoneObservable=new a,this.propertyPath=i,this.value=s,this.duration=r,this.stopOtherAnimations=o,this.onInterpolationDone=l,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){const e=this._actionManager.getScene(),t=[{frame:0,value:this._effectiveTarget[this._property]},{frame:100,value:this.value}];let i;if("number"==typeof this.value)i=Ie.ANIMATIONTYPE_FLOAT;else if(this.value instanceof N)i=Ie.ANIMATIONTYPE_COLOR3;else if(this.value instanceof S)i=Ie.ANIMATIONTYPE_VECTOR3;else if(this.value instanceof y)i=Ie.ANIMATIONTYPE_MATRIX;else{if(!(this.value instanceof C))return void k.Warn("InterpolateValueAction: Unsupported type ("+typeof this.value+")");i=Ie.ANIMATIONTYPE_QUATERNION}const s=new Ie("InterpolateValueAction",this._property,1e3/this.duration*100,i,Ie.ANIMATIONLOOPMODE_CONSTANT);s.setKeys(t),this.stopOtherAnimations&&e.stopAnimation(this._effectiveTarget),e.beginDirectAnimation(this._effectiveTarget,[s],0,100,!1,1,(()=>{this.onInterpolationDoneObservable.notifyObservers(this),this.onInterpolationDone&&this.onInterpolationDone()}))}serialize(e){return super._serialize({name:"InterpolateValueAction",properties:[L._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:L._SerializeValueAsString(this.value)},{name:"duration",value:L._SerializeValueAsString(this.duration)},{name:"stopOtherAnimations",value:L._SerializeValueAsString(this.stopOtherAnimations)||!1}]},e)}});class Pe{get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}constructor(e,t,i,s){if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._absoluteFrameOffset=0,this._previousElapsedTime=0,this._previousAbsoluteFrame=0,this._targetIsArray=!1,this._animation=t,this._target=e,this._scene=i,this._host=s,this._activeTargets=[],t._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===Ie.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=y.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,0!==this._minFrame){const e={frame:0,value:this._minValue};this._keys.splice(0,0,e)}if(this._target instanceof Array){let e=0;for(const t of this._target)this._preparePath(t,e),this._getOriginalValues(e),e++;this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];const r=t.getEvents();r&&r.length>0&&r.forEach((e=>{this._events.push(e._clone())})),this._enableBlending=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.enableBlending:this._animation.enableBlending}_preparePath(e,t=0){const i=this._animation.targetPropertyPath;if(i.length>1){let s=e[i[0]];for(let e=1;e<i.length-1;e++)s=s[i[e]];this._targetPath=i[i.length-1],this._activeTargets[t]=s}else this._targetPath=i[0],this._activeTargets[t]=e}get animation(){return this._animation}reset(e=!1){if(e)if(this._target instanceof Array){let e=0;for(const t of this._target)void 0!==this._originalValue[e]&&this._setValue(t,this._activeTargets[e],this._originalValue[e],-1,e),e++}else void 0!==this._originalValue[0]&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let e=0;e<this._events.length;e++)this._events[e].isDone=!1}isStopped(){return this._stopped}dispose(){const e=this._animation.runtimeAnimations.indexOf(this);e>-1&&this._animation.runtimeAnimations.splice(e,1)}setValue(e,t){if(this._targetIsArray)for(let i=0;i<this._target.length;i++){const s=this._target[i];this._setValue(s,this._activeTargets[i],e,t,i)}else this._setValue(this._target,this._directTarget,e,t,0)}_getOriginalValues(e=0){let t;const i=this._activeTargets[e];t=i.getLocalMatrix&&"_matrix"===this._targetPath?i.getLocalMatrix():i[this._targetPath],t&&t.clone?this._originalValue[e]=t.clone():this._originalValue[e]=t}_setValue(e,t,i,s,r){if(this._currentActiveTarget=t,this._weight=s,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){const e=t[this._targetPath];e.clone?this._originalBlendValue=e.clone():this._originalBlendValue=e}this._originalBlendValue.m?Ie.AllowMatrixDecomposeForInterpolation?this._currentValue?y.DecomposeLerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=y.DecomposeLerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue?y.LerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=y.Lerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue=Ie._UniversalLerp(this._originalBlendValue,i,this._blendingFactor);const s=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=s}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(i):this._currentValue=i:(null==i?void 0:i.clone)?this._currentValue=i.clone():this._currentValue=i;-1!==s?this._scene._registerTargetForLateAnimationBinding(this,this._originalValue[r]):this._animationState.loopMode===Ie.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT?this._currentValue.addToRef?this._currentValue.addToRef(this._originalValue[r],t[this._targetPath]):t[this._targetPath]=this._originalValue[r]+this._currentValue:t[this._targetPath]=this._currentValue,e.markAsDirty&&e.markAsDirty(this._animation.targetProperty)}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(e){const t=this._animation.getKeys();e<t[0].frame?e=t[0].frame:e>t[t.length-1].frame&&(e=t[t.length-1].frame);const i=this._events;if(i.length)for(let t=0;t<i.length;t++)i[t].onlyOnce||(i[t].isDone=i[t].frame<e);this._currentFrame=e;const s=this._animation._interpolate(e,this._animationState);this.setValue(s,-1)}_prepareForSpeedRatioChange(e){const t=this._previousElapsedTime*(this._animation.framePerSecond*e)/1e3;this._absoluteFrameOffset=this._previousAbsoluteFrame-t}animate(e,t,i,s,r,n=-1){const o=this._animation,a=o.targetPropertyPath;if(!a||a.length<1)return this._stopped=!0,!1;let l=!0;(t<this._minFrame||t>this._maxFrame)&&(t=this._minFrame),(i<this._minFrame||i>this._maxFrame)&&(i=this._maxFrame);const h=i-t;let c,u,d=e*(o.framePerSecond*r)/1e3+this._absoluteFrameOffset,p=0;if(s&&this._animationState.loopMode===Ie.ANIMATIONLOOPMODE_YOYO){const e=(d-t)/h;d=Math.abs(Math.sin(e*Math.PI))*h+t}if(this._previousElapsedTime=e,this._previousAbsoluteFrame=d,!s&&i>=t&&d>=h)l=!1,p=o._getKeyValue(this._maxValue);else if(!s&&t>=i&&d<=h)l=!1,p=o._getKeyValue(this._minValue);else if(this._animationState.loopMode!==Ie.ANIMATIONLOOPMODE_CYCLE){const e=i.toString()+t.toString();if(!this._offsetsCache[e]){this._animationState.repeatCount=0,this._animationState.loopMode=Ie.ANIMATIONLOOPMODE_CYCLE;const s=o._interpolate(t,this._animationState),r=o._interpolate(i,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),o.dataType){case Ie.ANIMATIONTYPE_FLOAT:this._offsetsCache[e]=r-s;break;case Ie.ANIMATIONTYPE_QUATERNION:case Ie.ANIMATIONTYPE_VECTOR3:case Ie.ANIMATIONTYPE_VECTOR2:case Ie.ANIMATIONTYPE_SIZE:case Ie.ANIMATIONTYPE_COLOR3:this._offsetsCache[e]=r.subtract(s)}this._highLimitsCache[e]=r}p=this._highLimitsCache[e],c=this._offsetsCache[e]}if(void 0===c)switch(o.dataType){case Ie.ANIMATIONTYPE_FLOAT:c=0;break;case Ie.ANIMATIONTYPE_QUATERNION:c=Ee;break;case Ie.ANIMATIONTYPE_VECTOR3:c=Se;break;case Ie.ANIMATIONTYPE_VECTOR2:c=be;break;case Ie.ANIMATIONTYPE_SIZE:c=Ce;break;case Ie.ANIMATIONTYPE_COLOR3:c=ye;break;case Ie.ANIMATIONTYPE_COLOR4:c=Ae}if(this._host&&this._host.syncRoot){const e=this._host.syncRoot;u=t+h*((e.masterFrame-e.fromFrame)/(e.toFrame-e.fromFrame))}else u=d>0&&t>i||d<0&&t<i?l&&0!==h?i+d%h:t:l&&0!==h?t+d%h:i;const _=this._events;if(r>0&&this.currentFrame>u||r<0&&this.currentFrame<u){this._onLoop();for(let e=0;e<_.length;e++)_[e].onlyOnce||(_[e].isDone=!1);this._animationState.key=r>0?0:o.getKeys().length-1}this._currentFrame=u,this._animationState.repeatCount=0===h?0:d/h|0,this._animationState.highLimitValue=p,this._animationState.offsetValue=c;const f=o._interpolate(u,this._animationState);if(this.setValue(f,n),_.length)for(let e=0;e<_.length;e++)if(h>0&&u>=_[e].frame&&_[e].frame>=t||h<0&&u<=_[e].frame&&_[e].frame<=t){const t=_[e];t.isDone||(t.onlyOnce&&(_.splice(e,1),e--),t.isDone=!0,t.action(u))}return l||(this._stopped=!0),l}}function Me(){return"undefined"!=typeof window}function Oe(){return"undefined"!=typeof navigator}function De(){return"undefined"!=typeof document}function Ne(e){let t="",i=e.firstChild;for(;i;)3===i.nodeType&&(t+=i.textContent),i=i.nextSibling;return t}class Fe{static get Now(){return Me()&&window.performance&&window.performance.now?window.performance.now():Date.now()}}class we{}we.FilesToLoad={};class Le extends Error{}Le._setPrototypeOf=Object.setPrototypeOf||((e,t)=>(e.__proto__=t,e));const Be=3e3;class Ue extends Le{constructor(e,t,i){super(e),this.errorCode=t,this.innerError=i,this.name="RuntimeError",Le._setPrototypeOf(this,Ue.prototype)}}const Ve=e=>{const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let i,s,r,n,o,a,l,h="",c=0;const u=ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e);for(;c<u.length;)i=u[c++],s=c<u.length?u[c++]:Number.NaN,r=c<u.length?u[c++]:Number.NaN,n=i>>2,o=(3&i)<<4|s>>4,a=(15&s)<<2|r>>6,l=63&r,isNaN(s)?a=l=64:isNaN(r)&&(l=64),h+=t.charAt(n)+t.charAt(o)+t.charAt(a)+t.charAt(l);return h},ke=e=>atob(e);class Ge{constructor(){this.children=[]}isValid(e){return!0}process(e,t){var i,s,r,n,o,a,l;let h="";if(this.line){let c=this.line;const u=t.processor;if(u){u.lineProcessor&&(c=u.lineProcessor(c,t.isFragment,t.processingContext));const h=null!==(s=null===(i=t.processor)||void 0===i?void 0:i.attributeKeywordName)&&void 0!==s?s:"attribute",d=t.isFragment&&(null===(r=t.processor)||void 0===r?void 0:r.varyingFragmentKeywordName)?null===(n=t.processor)||void 0===n?void 0:n.varyingFragmentKeywordName:!t.isFragment&&(null===(o=t.processor)||void 0===o?void 0:o.varyingVertexKeywordName)?null===(a=t.processor)||void 0===a?void 0:a.varyingVertexKeywordName:"varying";!t.isFragment&&u.attributeProcessor&&this.line.startsWith(h)?c=u.attributeProcessor(this.line,e,t.processingContext):u.varyingProcessor&&((null===(l=u.varyingCheck)||void 0===l?void 0:l.call(u,this.line,t.isFragment))||!u.varyingCheck&&this.line.startsWith(d))?c=u.varyingProcessor(this.line,t.isFragment,e,t.processingContext):u.uniformProcessor&&u.uniformRegexp&&u.uniformRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(c=u.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):u.uniformBufferProcessor&&u.uniformBufferRegexp&&u.uniformBufferRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(c=u.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0):u.textureProcessor&&u.textureRegexp&&u.textureRegexp.test(this.line)?c=u.textureProcessor(this.line,t.isFragment,e,t.processingContext):(u.uniformProcessor||u.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?u.uniformProcessor&&(c=u.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):u.uniformBufferProcessor&&(c=u.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)),t.lookForClosingBracketForUniformBuffer&&-1!==this.line.indexOf("}")&&(t.lookForClosingBracketForUniformBuffer=!1,u.endOfUniformBufferProcessor&&(c=u.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))}h+=c+"\n"}return this.children.forEach((i=>{h+=i.process(e,t)})),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true"),h}}class ze{constructor(){this._lines=[]}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(e){this._lines.length=0;for(const t of e){if(!t||"\r"===t)continue;if("#"===t[0]){this._lines.push(t);continue}const e=t.trim();if(!e)continue;if(e.startsWith("//")){this._lines.push(t);continue}const i=e.indexOf(";");if(-1===i)this._lines.push(e);else if(i===e.length-1)e.length>1&&this._lines.push(e);else{const e=t.split(";");for(let t=0;t<e.length;t++){let i=e[t];i&&(i=i.trim(),i&&this._lines.push(i+(t!==e.length-1?";":"")))}}}}}class We extends Ge{process(e,t){for(let i=0;i<this.children.length;i++){const s=this.children[i];if(s.isValid(e))return s.process(e,t)}return""}}class He extends Ge{isValid(e){return this.testExpression.isTrue(e)}}class Xe{isTrue(e){return!0}static postfixToInfix(e){const t=[];for(const i of e)if(void 0===Xe._OperatorPriority[i])t.push(i);else{const e=t[t.length-1],s=t[t.length-2];t.length-=2,t.push(`(${s}${i}${e})`)}return t[t.length-1]}static infixToPostfix(e){const t=Xe._InfixToPostfixCache.get(e);if(t)return t.accessTime=Date.now(),t.result;if(!(e.includes("&&")||e.includes("||")||e.includes(")")||e.includes("(")))return[e];const i=[];let s=-1;const r=()=>{h=h.trim(),""!==h&&(i.push(h),h="")},n=e=>{s<Xe._Stack.length-1&&(Xe._Stack[++s]=e)},o=()=>Xe._Stack[s],a=()=>-1===s?"!!INVALID EXPRESSION!!":Xe._Stack[s--];let l=0,h="";for(;l<e.length;){const t=e.charAt(l),c=l<e.length-1?e.substr(l,2):"";if("("===t)h="",n(t);else if(")"===t){for(r();-1!==s&&"("!==o();)i.push(a());a()}else if(Xe._OperatorPriority[c]>1){for(r();-1!==s&&Xe._OperatorPriority[o()]>=Xe._OperatorPriority[c];)i.push(a());n(c),l++}else h+=t;l++}for(r();-1!==s;)"("===o()?a():i.push(a());return Xe._InfixToPostfixCache.size>=Xe.InfixToPostfixCacheLimitSize&&Xe.ClearCache(),Xe._InfixToPostfixCache.set(e,{result:i,accessTime:Date.now()}),i}static ClearCache(){const e=Array.from(Xe._InfixToPostfixCache.entries()).sort(((e,t)=>e[1].accessTime-t[1].accessTime));for(let t=0;t<Xe.InfixToPostfixCacheCleanupSize;t++)Xe._InfixToPostfixCache.delete(e[t][0])}}Xe.InfixToPostfixCacheLimitSize=5e4,Xe.InfixToPostfixCacheCleanupSize=25e3,Xe._InfixToPostfixCache=new Map,Xe._OperatorPriority={")":0,"(":1,"||":2,"&&":3},Xe._Stack=["","","","","","","","","","","","","","","","","","","",""];class Ye extends Xe{constructor(e,t=!1){super(),this.define=e,this.not=t}isTrue(e){let t=void 0!==e[this.define];return this.not&&(t=!t),t}}class je extends Xe{isTrue(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)}}class Ke extends Xe{isTrue(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)}}class $e extends Xe{constructor(e,t,i){super(),this.define=e,this.operand=t,this.testValue=i}isTrue(e){let t=e[this.define];void 0===t&&(t=this.define);let i=!1;const s=parseInt(t),r=parseInt(this.testValue);switch(this.operand){case">":i=s>r;break;case"<":i=s<r;break;case"<=":i=s<=r;break;case">=":i=s>=r;break;case"==":i=s===r;break;case"!=":i=s!==r}return i}}var qe;!function(e){e[e.GLSL=0]="GLSL",e[e.WGSL=1]="WGSL"}(qe||(qe={}));const Qe=/defined\s*?\((.+?)\)/g,Ze=/defined\s*?\[(.+?)\]/g,Je=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g,et=/__decl__/,tt=/light\{X\}.(\w*)/g,it=/\{X\}/g,st=[];class rt{static Initialize(e){e.processor&&e.processor.initializeShaders&&e.processor.initializeShaders(e.processingContext)}static Process(e,t,i,s){var r;(null===(r=t.processor)||void 0===r?void 0:r.preProcessShaderCode)&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,(e=>{t.processCodeAfterIncludes&&(e=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",e));const r=this._ProcessShaderConversion(e,t,s);i(r,e)}))}static PreProcess(e,t,i,s){var r;(null===(r=t.processor)||void 0===r?void 0:r.preProcessShaderCode)&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,(e=>{t.processCodeAfterIncludes&&(e=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",e));const r=this._ApplyPreProcessing(e,t,s);i(r,e)}))}static Finalize(e,t,i){return i.processor&&i.processor.finalizeShaders?i.processor.finalizeShaders(e,t,i.processingContext):{vertexCode:e,fragmentCode:t}}static _ProcessPrecision(e,t){var i;if(null===(i=t.processor)||void 0===i?void 0:i.noPrecision)return e;const s=t.shouldUseHighPrecisionShader;return-1===e.indexOf("precision highp float")?e=s?"precision highp float;\n"+e:"precision mediump float;\n"+e:s||(e=e.replace("precision highp float","precision mediump float")),e}static _ExtractOperation(e){const t=/defined\((.+)\)/.exec(e);if(t&&t.length)return new Ye(t[1].trim(),"!"===e[0]);const i=["==","!=",">=","<=","<",">"];let s="",r=0;for(s of i)if(r=e.indexOf(s),r>-1)break;if(-1===r)return new Ye(e);const n=e.substring(0,r).trim(),o=e.substring(r+s.length).trim();return new $e(n,s,o)}static _BuildSubExpression(e){e=e.replace(Qe,"defined[$1]");const t=Xe.infixToPostfix(e),i=[];for(const e of t)if("||"!==e&&"&&"!==e)i.push(e);else if(i.length>=2){let t=i[i.length-1],s=i[i.length-2];i.length-=2;const r="&&"==e?new Ke:new je;"string"==typeof t&&(t=t.replace(Ze,"defined($1)")),"string"==typeof s&&(s=s.replace(Ze,"defined($1)")),r.leftOperand="string"==typeof s?this._ExtractOperation(s):s,r.rightOperand="string"==typeof t?this._ExtractOperation(t):t,i.push(r)}let s=i[i.length-1];return"string"==typeof s&&(s=s.replace(Ze,"defined($1)")),"string"==typeof s?this._ExtractOperation(s):s}static _BuildExpression(e,t){const i=new He,s=e.substring(0,t);let r=e.substring(t);return r=r.substring(0,(r.indexOf("//")+1||r.length+1)-1).trim(),i.testExpression="#ifdef"===s?new Ye(r):"#ifndef"===s?new Ye(r,!0):this._BuildSubExpression(r),i}static _MoveCursorWithinIf(e,t,i){let s=e.currentLine;for(;this._MoveCursor(e,i);){s=e.currentLine;const r=s.substring(0,5).toLowerCase();if("#else"===r){const i=new Ge;return t.children.push(i),void this._MoveCursor(e,i)}if("#elif"===r){const e=this._BuildExpression(s,5);t.children.push(e),i=e}}}static _MoveCursor(e,t){for(;e.canRead;){e.lineIndex++;const i=e.currentLine;if(i.indexOf("#")>=0){const s=rt._MoveCursorRegex.exec(i);if(s&&s.length){switch(s[0]){case"#ifdef":{const s=new We;t.children.push(s);const r=this._BuildExpression(i,6);s.children.push(r),this._MoveCursorWithinIf(e,s,r);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{const s=new We;t.children.push(s);const r=this._BuildExpression(i,7);s.children.push(r),this._MoveCursorWithinIf(e,s,r);break}case"#if":{const s=new We,r=this._BuildExpression(i,3);t.children.push(s),s.children.push(r),this._MoveCursorWithinIf(e,s,r);break}}continue}}const s=new Ge;if(s.line=i,t.children.push(s),"#"===i[0]&&"d"===i[1]){const e=i.replace(";","").split(" ");s.additionalDefineKey=e[1],3===e.length&&(s.additionalDefineValue=e[2])}}return!1}static _EvaluatePreProcessors(e,t,i){const s=new Ge,r=new ze;return r.lineIndex=-1,r.lines=e.split("\n"),this._MoveCursor(r,s),s.process(t,i)}static _PreparePreProcessors(e,t){var i;const s=e.defines,r={};for(const e of s){const t=e.replace("#define","").replace(";","").trim().split(" ");r[t[0]]=t.length>1?t[1]:""}return(null===(i=e.processor)||void 0===i?void 0:i.shaderLanguage)===qe.GLSL&&(r.GL_ES="true"),r.__VERSION__=e.version,r[e.platformName]="true",t._getGlobalDefines(r),r}static _ProcessShaderConversion(e,t,i){let s=this._ProcessPrecision(e,t);if(!t.processor)return s;if(t.processor.shaderLanguage===qe.GLSL&&-1!==s.indexOf("#version 3")&&(s=s.replace("#version 300 es",""),!t.processor.parseGLES3))return s;const r=t.defines,n=this._PreparePreProcessors(t,i);return t.processor.preProcessor&&(s=t.processor.preProcessor(s,r,t.isFragment,t.processingContext)),s=this._EvaluatePreProcessors(s,n,t),t.processor.postProcessor&&(s=t.processor.postProcessor(s,r,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(s=i.inlineShaderCode(s)),s}static _ApplyPreProcessing(e,t,i){var s,r;let n=e;const o=t.defines,a=this._PreparePreProcessors(t,i);return(null===(s=t.processor)||void 0===s?void 0:s.preProcessor)&&(n=t.processor.preProcessor(n,o,t.isFragment,t.processingContext)),n=this._EvaluatePreProcessors(n,a,t),(null===(r=t.processor)||void 0===r?void 0:r.postProcessor)&&(n=t.processor.postProcessor(n,o,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(n=i.inlineShaderCode(n)),n}static _ProcessIncludes(e,t,i){let s;for(st.length=0;null!==(s=Je.exec(e));)st.push(s);let r=String(e),n=[e],o=!1;for(const e of st){let s=e[1];if(-1!==s.indexOf("__decl__")&&(s=s.replace(et,""),t.supportsUniformBuffers&&(s=s.replace("Vertex","Ubo").replace("Fragment","Ubo")),s+="Declaration"),!t.includesShadersStore[s]){const e=t.shadersRepository+"ShadersInclude/"+s+".fx";return void rt._FileToolsLoadFile(e,(e=>{t.includesShadersStore[s]=e,this._ProcessIncludes(n.join(""),t,i)}))}{let i=t.includesShadersStore[s];if(e[2]){const t=e[3].split(",");for(let e=0;e<t.length;e+=2){const s=new RegExp(t[e],"g"),r=t[e+1];i=i.replace(s,r)}}if(e[4]){const s=e[5];if(-1!==s.indexOf("..")){const e=s.split(".."),r=parseInt(e[0]);let n=parseInt(e[1]),o=i.slice(0);i="",isNaN(n)&&(n=t.indexParameters[e[1]]);for(let e=r;e<n;e++)t.supportsUniformBuffers||(o=o.replace(tt,((e,t)=>t+"{X}"))),i+=o.replace(it,e.toString())+"\n"}else t.supportsUniformBuffers||(i=i.replace(tt,((e,t)=>t+"{X}"))),i=i.replace(it,s)}const r=[];for(const t of n){const s=t.split(e[0]);for(let e=0;e<s.length-1;e++)r.push(s[e]),r.push(i);r.push(s[s.length-1])}n=r,o=o||i.indexOf("#include<")>=0||i.indexOf("#include <")>=0}}st.length=0,r=n.join(""),o?this._ProcessIncludes(r.toString(),t,i):i(r)}static _FileToolsLoadFile(e,t,i,s,r,n){throw $("FileTools")}}rt._MoveCursorRegex=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/;class nt{static GetShadersRepository(e=qe.GLSL){return e===qe.GLSL?nt.ShadersRepository:nt.ShadersRepositoryWGSL}static GetShadersStore(e=qe.GLSL){return e===qe.GLSL?nt.ShadersStore:nt.ShadersStoreWGSL}static GetIncludesShadersStore(e=qe.GLSL){return e===qe.GLSL?nt.IncludesShadersStore:nt.IncludesShadersStoreWGSL}}nt.ShadersRepository="src/Shaders/",nt.ShadersStore={},nt.IncludesShadersStore={},nt.ShadersRepositoryWGSL="src/ShadersWGSL/",nt.ShadersStoreWGSL={},nt.IncludesShadersStoreWGSL={};class ot{static get ShadersRepository(){return nt.ShadersRepository}static set ShadersRepository(e){nt.ShadersRepository=e}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new a),this._onBindObservable}constructor(e,t,i,s=null,r,n=null,o=null,l=null,h=null,c,u="",d=qe.GLSL){var p,_,f;if(this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new a,this.onErrorObservable=new a,this._onBindObservable=null,this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!1,this._wasPreviouslyUsingInstances=null,this._isDisposed=!1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeBeforeMigration="",this._fragmentSourceCodeBeforeMigration="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this._processCodeAfterIncludes=void 0,this._processFinalCode=null,this.name=e,this._key=u,t.attributes){const e=t;if(this._engine=i,this._attributesNames=e.attributes,this._uniformsNames=e.uniformsNames.concat(e.samplers),this._samplerList=e.samplers.slice(),this.defines=e.defines,this.onError=e.onError,this.onCompiled=e.onCompiled,this._fallbacks=e.fallbacks,this._indexParameters=e.indexParameters,this._transformFeedbackVaryings=e.transformFeedbackVaryings||null,this._multiTarget=!!e.multiTarget,this._shaderLanguage=null!==(p=e.shaderLanguage)&&void 0!==p?p:qe.GLSL,e.uniformBuffersNames){this._uniformBuffersNamesList=e.uniformBuffersNames.slice();for(let t=0;t<e.uniformBuffersNames.length;t++)this._uniformBuffersNames[e.uniformBuffersNames[t]]=t}this._processFinalCode=null!==(_=e.processFinalCode)&&void 0!==_?_:null,this._processCodeAfterIncludes=null!==(f=e.processCodeAfterIncludes)&&void 0!==f?f:void 0}else this._engine=r,this.defines=null==n?"":n,this._uniformsNames=i.concat(s),this._samplerList=s?s.slice():[],this._attributesNames=t,this._uniformBuffersNamesList=[],this._shaderLanguage=d,this.onError=h,this.onCompiled=l,this._indexParameters=c,this._fallbacks=o;this._attributeLocationByName={},this.uniqueId=ot._UniqueIdSeed++,this._processShaderCode()}_processShaderCode(e=null,t=!1){let i,s;const r=this.name,n=Me()?this._engine.getHostDocument():null;r.vertexSource?i="source:"+r.vertexSource:r.vertexElement?(i=n?n.getElementById(r.vertexElement):null,i||(i=r.vertexElement)):i=r.vertex||r,r.fragmentSource?s="source:"+r.fragmentSource:r.fragmentElement?(s=n?n.getElementById(r.fragmentElement):null,s||(s=r.fragmentElement)):s=r.fragment||r,this._processingContext=this._engine._getShaderProcessingContext(this._shaderLanguage);let o={defines:this.defines.split("\n"),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:null!=e?e:this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:nt.GetShadersRepository(this._shaderLanguage),includesShadersStore:nt.GetIncludesShadersStore(this._shaderLanguage),version:(100*this._engine.version).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:this._processCodeAfterIncludes};const a=[void 0,void 0],l=()=>{if(a[0]&&a[1]){o.isFragment=!0;const[e,i]=a;rt.Process(i,o,((i,s)=>{this._fragmentSourceCodeBeforeMigration=s,this._processFinalCode&&(i=this._processFinalCode("fragment",i));const n=rt.Finalize(e,i,o);o=null,this._useFinalCode(n.vertexCode,n.fragmentCode,r,t)}),this._engine)}};this._loadShader(i,"Vertex","",(e=>{rt.Initialize(o),rt.Process(e,o,((t,i)=>{this._rawVertexSourceCode=e,this._vertexSourceCodeBeforeMigration=i,this._processFinalCode&&(t=this._processFinalCode("vertex",t)),a[0]=t,l()}),this._engine)})),this._loadShader(s,"Fragment","Pixel",(e=>{this._rawFragmentSourceCode=e,a[1]=e,l()}))}_useFinalCode(e,t,i,s=!1){if(i){const s=i.vertexElement||i.vertex||i.spectorName||i,r=i.fragmentElement||i.fragment||i.spectorName||i;this._vertexSourceCode=(this._shaderLanguage===qe.WGSL?"//":"")+"#define SHADER_NAME vertex:"+s+"\n"+e,this._fragmentSourceCode=(this._shaderLanguage===qe.WGSL?"//":"")+"#define SHADER_NAME fragment:"+r+"\n"+t}else this._vertexSourceCode=e,this._fragmentSourceCode=t;this._prepareEffect(s)}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch(e){return!1}}_isReadyInternal(){return!!this._isReady||!!this._pipelineContext&&this._pipelineContext.isReady}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getAttributesNames(){return this._attributesNames}getAttributeLocation(e){return this._attributes[e]}getAttributeLocationByName(e){return this._attributeLocationByName[e]}getAttributesCount(){return this._attributes.length}getUniformIndex(e){return this._uniformsNames.indexOf(e)}getUniform(e){return this._uniforms[e]}getSamplers(){return this._samplerList}getUniformNames(){return this._uniformsNames}getUniformBuffersNames(){return this._uniformBuffersNamesList}getIndexParameters(){return this._indexParameters}getCompilationError(){return this._compilationError}allFallbacksProcessed(){return this._allFallbacksProcessed}executeWhenCompiled(e){this.isReady()?e(this):(this.onCompileObservable.add((t=>{e(t)})),this._pipelineContext&&!this._pipelineContext.isAsync||setTimeout((()=>{this._checkIsReady(null)}),16))}_checkIsReady(e){try{if(this._isReadyInternal())return}catch(t){return void this._processCompilationErrors(t,e)}this._isDisposed||setTimeout((()=>{this._checkIsReady(e)}),16)}_loadShader(e,t,i,s){if("undefined"!=typeof HTMLElement&&e instanceof HTMLElement)return void s(Ne(e));if("source:"===e.substr(0,7))return void s(e.substr(7));if("base64:"===e.substr(0,7))return void s(window.atob(e.substr(7)));const r=nt.GetShadersStore(this._shaderLanguage);if(r[e+t+"Shader"])return void s(r[e+t+"Shader"]);if(i&&r[e+i+"Shader"])return void s(r[e+i+"Shader"]);let n;n="."===e[0]||"/"===e[0]||e.indexOf("http")>-1?e:nt.GetShadersRepository(this._shaderLanguage)+e,this._engine._loadFile(n+"."+t.toLowerCase()+".fx",s)}get vertexSourceCode(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:null!==(t=null===(e=this._pipelineContext)||void 0===e?void 0:e._getVertexShaderCode())&&void 0!==t?t:this._vertexSourceCode}get fragmentSourceCode(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:null!==(t=null===(e=this._pipelineContext)||void 0===e?void 0:e._getFragmentShaderCode())&&void 0!==t?t:this._fragmentSourceCode}get vertexSourceCodeBeforeMigration(){return this._vertexSourceCodeBeforeMigration}get fragmentSourceCodeBeforeMigration(){return this._fragmentSourceCodeBeforeMigration}get rawVertexSourceCode(){return this._rawVertexSourceCode}get rawFragmentSourceCode(){return this._rawFragmentSourceCode}_rebuildProgram(e,t,i,s){this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=(e,t)=>{s&&s(t)},this.onCompiled=()=>{const e=this.getEngine().scenes;if(e)for(let t=0;t<e.length;t++)e[t].markAllMaterialsAsDirty(63);this._pipelineContext._handlesSpectorRebuildCallback(i)},this._fallbacks=null,this._prepareEffect()}_prepareEffect(e=!1){var t;const i=this._attributesNames,s=this.defines,r=this._pipelineContext;this._isReady=!1;try{const n=this._engine;this._pipelineContext=null!==(t=e?r:void 0)&&void 0!==t?t:n.createPipelineContext(this._processingContext),this._pipelineContext._name=this._key.replace(/\r/g,"").replace(/\n/g,"|");const o=(e,t,i,s)=>this._rebuildProgram(e,t,i,s);this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?n._preparePipelineContext(this._pipelineContext,this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride,!0,this._rawVertexSourceCode,this._rawFragmentSourceCode,o,null,this._transformFeedbackVaryings,this._key):n._preparePipelineContext(this._pipelineContext,this._vertexSourceCode,this._fragmentSourceCode,!1,this._rawVertexSourceCode,this._rawFragmentSourceCode,o,s,this._transformFeedbackVaryings,this._key),n._executeWhenRenderingStateIsCompiled(this._pipelineContext,(()=>{if(this._attributes=[],this._pipelineContext._fillEffectInformation(this,this._uniformBuffersNames,this._uniformsNames,this._uniforms,this._samplerList,this._samplers,i,this._attributes),i)for(let e=0;e<i.length;e++){const t=i[e];this._attributeLocationByName[t]=this._attributes[e]}n.bindSamplers(this),this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh(),r&&!e&&this.getEngine()._deletePipelineContext(r)})),this._pipelineContext.isAsync&&this._checkIsReady(r)}catch(e){this._processCompilationErrors(e,r)}}_getShaderCodeAndErrorLine(e,t,i){const s=i?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/;let r=null;if(t&&e){const n=t.match(s);if(n&&2===n.length){const t=parseInt(n[1]),s=e.split("\n",-1);s.length>=t&&(r=`Offending line [${t}] in ${i?"fragment":"vertex"} code: ${s[t-1]}`)}}return[e,r]}_processCompilationErrors(e,t=null){var i,s,r;this._compilationError=e.message;const n=this._attributesNames,o=this._fallbacks;if(k.Error("Unable to compile effect:"),k.Error("Uniforms: "+this._uniformsNames.map((function(e){return" "+e}))),k.Error("Attributes: "+n.map((function(e){return" "+e}))),k.Error("Defines:\n"+this.defines),ot.LogShaderCodeOnCompilationError){let e=null,t=null,n=null;(null===(i=this._pipelineContext)||void 0===i?void 0:i._getVertexShaderCode())&&([n,e]=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),n&&(k.Error("Vertex code:"),k.Error(n))),(null===(s=this._pipelineContext)||void 0===s?void 0:s._getFragmentShaderCode())&&([n,t]=this._getShaderCodeAndErrorLine(null===(r=this._pipelineContext)||void 0===r?void 0:r._getFragmentShaderCode(),this._compilationError,!0),n&&(k.Error("Fragment code:"),k.Error(n))),e&&k.Error(e),t&&k.Error(t)}k.Error("Error: "+this._compilationError);const a=()=>{this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)};t&&(this._pipelineContext=t,this._isReady=!0,a()),o?(this._pipelineContext=null,o.hasMoreFallbacks?(this._allFallbacksProcessed=!1,k.Error("Trying next fallback."),this.defines=o.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,a(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=!0,t||a())}get isSupported(){return""===this._compilationError}_bindTexture(e,t){this._engine._bindTexture(this._samplers[e],t,e)}setTexture(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e)}setDepthStencilTexture(e,t){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],t,e)}setTextureArray(e,t){const i=e+"Ex";if(-1===this._samplerList.indexOf(i+"0")){const s=this._samplerList.indexOf(e);for(let e=1;e<t.length;e++){const t=i+(e-1).toString();this._samplerList.splice(s+e,0,t)}let r=0;for(const e of this._samplerList)this._samplers[e]=r,r+=1}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e)}setTextureFromPostProcess(e,t){this._engine.setTextureFromPostProcess(this._samplers[e],t,e)}setTextureFromPostProcessOutput(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers[e],t,e)}bindUniformBuffer(e,t){const i=this._uniformBuffersNames[t];void 0===i||ot._BaseCache[i]===e&&this._engine._features.useUBOBindingCache||(ot._BaseCache[i]=e,this._engine.bindUniformBufferBase(e,i,t))}bindUniformBlock(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)}setInt(e,t){return this._pipelineContext.setInt(e,t),this}setInt2(e,t,i){return this._pipelineContext.setInt2(e,t,i),this}setInt3(e,t,i,s){return this._pipelineContext.setInt3(e,t,i,s),this}setInt4(e,t,i,s,r){return this._pipelineContext.setInt4(e,t,i,s,r),this}setIntArray(e,t){return this._pipelineContext.setIntArray(e,t),this}setIntArray2(e,t){return this._pipelineContext.setIntArray2(e,t),this}setIntArray3(e,t){return this._pipelineContext.setIntArray3(e,t),this}setIntArray4(e,t){return this._pipelineContext.setIntArray4(e,t),this}setUInt(e,t){return this._pipelineContext.setUInt(e,t),this}setUInt2(e,t,i){return this._pipelineContext.setUInt2(e,t,i),this}setUInt3(e,t,i,s){return this._pipelineContext.setUInt3(e,t,i,s),this}setUInt4(e,t,i,s,r){return this._pipelineContext.setUInt4(e,t,i,s,r),this}setUIntArray(e,t){return this._pipelineContext.setUIntArray(e,t),this}setUIntArray2(e,t){return this._pipelineContext.setUIntArray2(e,t),this}setUIntArray3(e,t){return this._pipelineContext.setUIntArray3(e,t),this}setUIntArray4(e,t){return this._pipelineContext.setUIntArray4(e,t),this}setFloatArray(e,t){return this._pipelineContext.setArray(e,t),this}setFloatArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setFloatArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setFloatArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setArray(e,t){return this._pipelineContext.setArray(e,t),this}setArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setMatrices(e,t){return this._pipelineContext.setMatrices(e,t),this}setMatrix(e,t){return this._pipelineContext.setMatrix(e,t),this}setMatrix3x3(e,t){return this._pipelineContext.setMatrix3x3(e,t),this}setMatrix2x2(e,t){return this._pipelineContext.setMatrix2x2(e,t),this}setFloat(e,t){return this._pipelineContext.setFloat(e,t),this}setBool(e,t){return this._pipelineContext.setInt(e,t?1:0),this}setVector2(e,t){return this._pipelineContext.setVector2(e,t),this}setFloat2(e,t,i){return this._pipelineContext.setFloat2(e,t,i),this}setVector3(e,t){return this._pipelineContext.setVector3(e,t),this}setFloat3(e,t,i,s){return this._pipelineContext.setFloat3(e,t,i,s),this}setVector4(e,t){return this._pipelineContext.setVector4(e,t),this}setQuaternion(e,t){return this._pipelineContext.setQuaternion(e,t),this}setFloat4(e,t,i,s,r){return this._pipelineContext.setFloat4(e,t,i,s,r),this}setColor3(e,t){return this._pipelineContext.setColor3(e,t),this}setColor4(e,t,i){return this._pipelineContext.setColor4(e,t,i),this}setDirectColor4(e,t){return this._pipelineContext.setDirectColor4(e,t),this}dispose(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseEffect(this),this._isDisposed=!0}static RegisterShader(e,t,i,s=qe.GLSL){t&&(nt.GetShadersStore(s)[`${e}PixelShader`]=t),i&&(nt.GetShadersStore(s)[`${e}VertexShader`]=i)}static ResetCache(){ot._BaseCache={}}}ot.LogShaderCodeOnCompilationError=!0,ot._UniqueIdSeed=0,ot._BaseCache={},ot.ShadersStore=nt.ShadersStore,ot.IncludesShadersStore=nt.IncludesShadersStore;class at{constructor(e=!0){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,e&&this.reset()}get isDirty(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)}reset(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1}apply(e){this.isDirty&&(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))}}class lt{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=lt.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=lt.KEEP,this.opDepthFail=lt.KEEP,this.opStencilDepthPass=lt.REPLACE}get stencilFunc(){return this.func}set stencilFunc(e){this.func=e}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(e){this.funcRef=e}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(e){this.funcMask=e}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(e){this.opStencilFail=e}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(e){this.opDepthFail=e}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(e){this.opStencilDepthPass=e}get stencilMask(){return this.mask}set stencilMask(e){this.mask=e}get stencilTest(){return this.enabled}set stencilTest(e){this.enabled=e}}lt.ALWAYS=519,lt.KEEP=7680,lt.REPLACE=7681;class ht{constructor(){this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}get isDirty(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}get alphaBlend(){return this._alphaBlend}set alphaBlend(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)}setAlphaBlendConstants(e,t,i,s){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===i&&this._blendConstants[3]===s||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=i,this._blendConstants[3]=s,this._isBlendConstantsDirty=!0)}setAlphaBlendFunctionParameters(e,t,i,s){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===i&&this._blendFunctionParameters[3]===s||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=i,this._blendFunctionParameters[3]=s,this._isBlendFunctionParametersDirty=!0)}setAlphaEquationParameters(e,t){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=t,this._isBlendEquationParametersDirty=!0)}reset(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1}apply(e){this.isDirty&&(this._isAlphaBlendDirty&&(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))}}class ct{get wrapU(){return this._cachedWrapU}set wrapU(e){this._cachedWrapU=e}get wrapV(){return this._cachedWrapV}set wrapV(e){this._cachedWrapV=e}get wrapR(){return this._cachedWrapR}set wrapR(e){this._cachedWrapR=e}get anisotropicFilteringLevel(){return this._cachedAnisotropicFilteringLevel}set anisotropicFilteringLevel(e){this._cachedAnisotropicFilteringLevel=e}get comparisonFunction(){return this._comparisonFunction}set comparisonFunction(e){this._comparisonFunction=e}get useMipMaps(){return this._useMipMaps}set useMipMaps(e){this._useMipMaps=e}constructor(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}setParameters(e=1,t=1,i=1,s=1,r=2,n=0){return this._cachedWrapU=e,this._cachedWrapV=t,this._cachedWrapR=i,this._cachedAnisotropicFilteringLevel=s,this.samplingMode=r,this._comparisonFunction=n,this}compareSampler(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps}}var ut;!function(e){e[e.Unknown=0]="Unknown",e[e.Url=1]="Url",e[e.Temp=2]="Temp",e[e.Raw=3]="Raw",e[e.Dynamic=4]="Dynamic",e[e.RenderTarget=5]="RenderTarget",e[e.MultiRenderTarget=6]="MultiRenderTarget",e[e.Cube=7]="Cube",e[e.CubeRaw=8]="CubeRaw",e[e.CubePrefiltered=9]="CubePrefiltered",e[e.Raw3D=10]="Raw3D",e[e.Raw2DArray=11]="Raw2DArray",e[e.DepthStencil=12]="DepthStencil",e[e.CubeRawRGBD=13]="CubeRawRGBD",e[e.Depth=14]="Depth"}(ut||(ut={}));class dt extends ct{get useMipMaps(){return this.generateMipMaps}set useMipMaps(e){this.generateMipMaps=e}get uniqueId(){return this._uniqueId}_setUniqueId(e){this._uniqueId=e}getEngine(){return this._engine}get source(){return this._source}constructor(e,t,i=!1){super(),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new a,this.onErrorObservable=new a,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=ut.Unknown,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._cachedCoordinatesMode=null,this._isDisabled=!1,this._compression=null,this._sphericalPolynomial=null,this._sphericalPolynomialPromise=null,this._sphericalPolynomialComputed=!1,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._useSRGBBuffer=!1,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._hardwareTexture=null,this._maxLodLevel=null,this._references=1,this._gammaSpace=null,this._premulAlpha=!1,this._dynamicTextureSource=null,this._engine=e,this._source=t,this._uniqueId=dt._Counter++,i||(this._hardwareTexture=e._createHardwareTexture())}incrementReferences(){this._references++}updateSize(e,t,i=1){this._engine.updateTextureDimensions(this,e,t,i),this.width=e,this.height=t,this.depth=i,this.baseWidth=e,this.baseHeight=t,this.baseDepth=i,this._size=e*t*i}_rebuild(){var e;if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){const e=this.onRebuildCallback(this),t=t=>{t._swapAndDie(this,!1),this.isReady=e.isReady};return void(e.isAsync?e.proxy.then(t):t(e.proxy))}let t;switch(this.source){case ut.Temp:break;case ut.Url:return void(t=this._engine.createTexture(null!==(e=this._originalUrl)&&void 0!==e?e:this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,(e=>{e._swapAndDie(this,!1),this.isReady=!0}),null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer));case ut.Raw:t=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,void 0,this._useSRGBBuffer),t._swapAndDie(this,!1),this.isReady=!0;break;case ut.Raw3D:t=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),t._swapAndDie(this,!1),this.isReady=!0;break;case ut.Raw2DArray:t=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),t._swapAndDie(this,!1),this.isReady=!0;break;case ut.Dynamic:t=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),t._swapAndDie(this,!1),this._dynamicTextureSource&&this._engine.updateDynamicTexture(this,this._dynamicTextureSource,this.invertY,this._premulAlpha,this.format,!0);break;case ut.Cube:return void(t=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,(()=>{t._swapAndDie(this,!1),this.isReady=!0}),null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer));case ut.CubeRaw:t=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),t._swapAndDie(this,!1),this.isReady=!0;break;case ut.CubeRawRGBD:return;case ut.CubePrefiltered:return t=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,(e=>{e&&e._swapAndDie(this,!1),this.isReady=!0}),null,this.format,this._extension),void(t._sphericalPolynomial=this._sphericalPolynomial)}}_swapAndDie(e,t=!0){var i;null===(i=this._hardwareTexture)||void 0===i||i.setUsage(e._source,this.generateMipMaps,this.isCube,this.width,this.height),e._hardwareTexture=this._hardwareTexture,t&&(e._isRGBD=this._isRGBD),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);const s=this._engine.getLoadedTexturesCache();let r=s.indexOf(this);-1!==r&&s.splice(r,1),r=s.indexOf(e),-1===r&&s.push(e)}dispose(){this._references--,this.onLoadedObservable.clear(),this.onErrorObservable.clear(),0===this._references&&(this._engine._releaseTexture(this),this._hardwareTexture=null,this._dynamicTextureSource=null)}}dt._Counter=0;class pt{constructor(){this.shaderLanguage=qe.GLSL}postProcessor(e,t,i,s,r){if(!r.getCaps().drawBuffersExtension){const t=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(t,"")}return e}}const _t=/(flat\s)?\s*varying\s*.*/;class ft{constructor(){this.shaderLanguage=qe.GLSL}attributeProcessor(e){return e.replace("attribute","in")}varyingCheck(e,t){return _t.test(e)}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){const s=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),i){const t=-1!==e.search(/layout *\(location *= *0\) *out/g);e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(s||t?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(")}else if(-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e;return e}}class mt{get underlyingResource(){return null}constructor(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=mt._Counter++}}mt._Counter=0;class gt extends mt{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}}class vt{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null,this._isDisposed=!1}get isAsync(){return this.isParallelCompiled}get isReady(){return!!this.program&&(!this.isParallelCompiled||this.engine._isRenderingStateCompiled(this))}_handlesSpectorRebuildCallback(e){e&&this.program&&e(this.program)}_fillEffectInformation(e,t,i,s,r,n,o,a){const l=this.engine;if(l.supportsUniformBuffers)for(const i in t)e.bindUniformBlock(i,t[i]);let h;for(this.engine.getUniforms(this,i).forEach(((e,t)=>{s[i[t]]=e})),this._uniforms=s,h=0;h<r.length;h++)null==e.getUniform(r[h])&&(r.splice(h,1),h--);r.forEach(((e,t)=>{n[e]=t}));for(const e of l.getAttributes(this,o))a.push(e)}dispose(){this._uniforms={},this._isDisposed=!0}_cacheMatrix(e,t){const i=this._valueCache[e],s=t.updateFlag;return(void 0===i||i!==s)&&(this._valueCache[e]=s,!0)}_cacheFloat2(e,t,i){let s=this._valueCache[e];if(!s||2!==s.length)return s=[t,i],this._valueCache[e]=s,!0;let r=!1;return s[0]!==t&&(s[0]=t,r=!0),s[1]!==i&&(s[1]=i,r=!0),r}_cacheFloat3(e,t,i,s){let r=this._valueCache[e];if(!r||3!==r.length)return r=[t,i,s],this._valueCache[e]=r,!0;let n=!1;return r[0]!==t&&(r[0]=t,n=!0),r[1]!==i&&(r[1]=i,n=!0),r[2]!==s&&(r[2]=s,n=!0),n}_cacheFloat4(e,t,i,s,r){let n=this._valueCache[e];if(!n||4!==n.length)return n=[t,i,s,r],this._valueCache[e]=n,!0;let o=!1;return n[0]!==t&&(n[0]=t,o=!0),n[1]!==i&&(n[1]=i,o=!0),n[2]!==s&&(n[2]=s,o=!0),n[3]!==r&&(n[3]=r,o=!0),o}setInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this.engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this.engine.setInt3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setInt4(e,t,i,s,r){this._cacheFloat4(e,t,i,s,r)&&(this.engine.setInt4(this._uniforms[e],t,i,s,r)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this.engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setUInt3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this.engine.setUInt3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setUInt4(e,t,i,s,r){this._cacheFloat4(e,t,i,s,r)&&(this.engine.setUInt4(this._uniforms[e],t,i,s,r)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this.engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this.engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this.engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this.engine.setUIntArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this.engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this.engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this.engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this.engine.setFloat3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,s,r){this._cacheFloat4(e,t,i,s,r)&&(this.engine.setFloat4(this._uniforms[e],t,i,s,r)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this.engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}}class xt{get underlyingResource(){return this._webGLTexture}constructor(e=null,t){if(this._MSAARenderBuffers=null,this._context=t,!e&&!(e=t.createTexture()))throw new Error("Unable to create webGL texture");this.set(e)}setUsage(){}set(e){this._webGLTexture=e}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(e){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(e)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const e of this._MSAARenderBuffers)this._context.deleteRenderbuffer(e);this._MSAARenderBuffers=null}}getMSAARenderBuffer(e=0){var t,i;return null!==(i=null===(t=this._MSAARenderBuffers)||void 0===t?void 0:t[e])&&void 0!==i?i:null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}class Tt{static IsWrapper(e){return void 0===e.getPipelineContext}static GetEffect(e){return void 0===e.getPipelineContext?e.effect:e}constructor(e,t=!0){this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}setEffect(e,t,i=!0){var s;this.effect=e,void 0!==t&&(this.defines=t),i&&(null===(s=this.drawContext)||void 0===s||s.reset())}dispose(){var e;null===(e=this.drawContext)||void 0===e||e.dispose()}}class Et{get isDirty(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)}constructor(e=!0){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,e&&this.reset()}reset(){var e;this.stencilMaterial=void 0,null===(e=this.stencilGlobal)||void 0===e||e.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0}apply(e){var t;if(!e)return;const i=!this.useStencilGlobalOnly&&!!(null===(t=this.stencilMaterial)||void 0===t?void 0:t.enabled);this.enabled=i?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=i?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=i?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=i?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=i?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=i?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=i?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=i?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFunc(this.func,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),this._isStencilOpDirty=!1))}}class St{}class bt{static get NpmPackage(){return"babylonjs@6.33.1"}static get Version(){return"6.33.1"}get description(){let e=this.name+this.webGLVersion;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e}get name(){return this._name}set name(e){this._name=e}get version(){return this._webGLVersion}get isDisposed(){return this._isDisposed}static get ShadersRepository(){return ot.ShadersRepository}static set ShadersRepository(e){ot.ShadersRepository=e}_getShaderProcessor(e){return this._shaderProcessor}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,this._depthCullingState.depthFunc=e?518:515)}get frameId(){return this._frameId}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}getCreationOptions(){return this._creationOptions}get _shouldUseHighPrecisionShader(){return!(!this._caps.highPrecisionShaderSupported||!this._highPrecisionShadersAllowed)}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get activeRenderLoops(){return this._activeRenderLoops}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(e){this._doNotHandleContextLost=e}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e}get currentViewport(){return this._cachedViewport}get emptyTexture(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture}get emptyTexture3D(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D}get emptyTexture2DArray(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){const e=new Uint8Array(4),t=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(t,1,5,0,!1,!1,1)}return this._emptyCubeTexture}get isWebGPU(){return this._isWebGPU}get shaderPlatformName(){return this._shaderPlatformName}get snapshotRendering(){return!1}set snapshotRendering(e){}get snapshotRenderingMode(){return this._snapshotRenderingMode}set snapshotRenderingMode(e){this._snapshotRenderingMode=e}snapshotRenderingReset(){this.snapshotRendering=!1}static _CreateCanvas(e,t){if("undefined"==typeof document)return new OffscreenCanvas(e,t);const i=document.createElement("canvas");return i.width=e,i.height=t,i}createCanvas(e,t){return bt._CreateCanvas(e,t)}createCanvasImage(){return document.createElement("img")}constructor(e,t,i,s){var r,n,o,l,h,c,u,d,p,_,f;this._name="WebGL",this._isDisposed=!1,this.forcePOTTextures=!1,this.isFullscreen=!1,this.cullBackFaces=null,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this.validateShaderPrograms=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this.disableUniformBuffers=!1,this.onDisposeObservable=new a,this._frameId=0,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._webGLVersion=1,this._windowIsBackground=!1,this._highPrecisionShadersAllowed=!0,this._badOS=!1,this._badDesktopOS=!1,this._renderingQueueLaunched=!1,this._activeRenderLoops=new Array,this.onContextLostObservable=new a,this.onContextRestoredObservable=new a,this._contextWasLost=!1,this._doNotHandleContextLost=!1,this.disableVertexArrayObjects=!1,this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new at,this._stencilStateComposer=new Et,this._stencilState=new lt,this._alphaState=new ht,this._alphaMode=1,this._alphaEquation=0,this._internalTexturesCache=new Array,this._renderTargetWrapperCache=new Array,this._activeChannel=0,this._currentTextureChannel=-1,this._boundTexturesCache={},this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._currentRenderTarget=null,this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._activeRequests=new Array,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._transformTextureUrl=null,this.hostInformation={isMobile:!1},this.premultipliedAlpha=!0,this.onBeforeTextureInitObservable=new a,this._isWebGPU=!1,this._snapshotRenderingMode=0,this._viewportCached={x:0,y:0,z:0,w:0},this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},this.startTime=Fe.Now;let m=null;i=i||{},this._creationOptions=i,this.adaptToDeviceRatio=null!=s&&s,this._stencilStateComposer.stencilGlobal=this._stencilState,v.SetMatrixPrecision(!!i.useHighPrecisionMatrix),i.antialias=null!=t?t:i.antialias,i.deterministicLockstep=null!==(r=i.deterministicLockstep)&&void 0!==r&&r,i.lockstepMaxSteps=null!==(n=i.lockstepMaxSteps)&&void 0!==n?n:4,i.timeStep=null!==(o=i.timeStep)&&void 0!==o?o:1/60,i.audioEngine=null===(l=i.audioEngine)||void 0===l||l,i.stencil=null===(h=i.stencil)||void 0===h||h,this._audioContext=null!==(u=null===(c=i.audioEngineOptions)||void 0===c?void 0:c.audioContext)&&void 0!==u?u:null,this._audioDestination=null!==(p=null===(d=i.audioEngineOptions)||void 0===d?void 0:d.audioDestination)&&void 0!==p?p:null,this.premultipliedAlpha=null===(_=i.premultipliedAlpha)||void 0===_||_,this.useExactSrgbConversions=null!==(f=i.useExactSrgbConversions)&&void 0!==f&&f,this._doNotHandleContextLost=!!i.doNotHandleContextLost,this._isStencilEnable=!!i.stencil,s=s||i.adaptToDeviceRatio||!1;const g=Me()&&window.devicePixelRatio||1,x=i.limitDeviceRatio||g;if(this._hardwareScalingLevel=s?1/Math.min(x,g):1,this._lastDevicePixelRatio=g,!e)return;if(e.getContext){if(m=e,this._renderingCanvas=m,void 0===i.preserveDrawingBuffer&&(i.preserveDrawingBuffer=!1),void 0===i.xrCompatible&&(i.xrCompatible=!0),navigator&&navigator.userAgent){this._setupMobileChecks();const e=navigator.userAgent;for(const t of bt.ExceptionList){const s=t.key,r=t.targets;if(new RegExp(s).test(e)){if(t.capture&&t.captureConstraint){const i=t.capture,s=t.captureConstraint,r=new RegExp(i).exec(e);if(r&&r.length>0&&parseInt(r[r.length-1])>=s)continue}for(const e of r)switch(e){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":i.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1}}}}if(this._doNotHandleContextLost||(this._onContextLost=e=>{e.preventDefault(),this._contextWasLost=!0,k.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost((()=>this._initGLContext()))},m.addEventListener("webglcontextlost",this._onContextLost,!1),m.addEventListener("webglcontextrestored",this._onContextRestored,!1),i.powerPreference=i.powerPreference||"high-performance"),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this._badDesktopOS&&(i.xrCompatible=!1),!i.disableWebGL2Support)try{this._gl=m.getContext("webgl2",i)||m.getContext("experimental-webgl2",i),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch(e){}if(!this._gl){if(!m)throw new Error("The provided canvas is null or undefined.");try{this._gl=m.getContext("webgl",i)||m.getContext("experimental-webgl",i)}catch(e){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=e,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const t=this._gl.getContextAttributes();t&&(i.stencil=t.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),void 0!==i.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=i.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let e=0;e<this._caps.maxVertexAttribs;e++)this._currentBufferPointers[e]=new St;this._shaderProcessor=this.webGLVersion>1?new ft:new pt,this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent);const T=`Babylon.js v${bt.Version}`;console.log(T+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",T)}_setupMobileChecks(){navigator&&navigator.userAgent&&(this._checkForMobile=()=>{const e=navigator.userAgent;this.hostInformation.isMobile=-1!==e.indexOf("Mobile")||-1!==e.indexOf("Mac")&&De()&&"ontouchend"in document},this._checkForMobile(),Me()&&window.addEventListener("resize",this._checkForMobile))}_restoreEngineAfterContextLost(e){setTimeout((async()=>{var t;this._dummyFramebuffer=null;const i=this._depthCullingState.depthTest,s=this._depthCullingState.depthFunc,r=this._depthCullingState.depthMask,n=this._stencilState.stencilTest;await e(),this.wipeCaches(!0),this._rebuildEffects(),null===(t=this._rebuildComputeEffects)||void 0===t||t.call(this),this._rebuildBuffers(),this._rebuildInternalTextures(),this._rebuildRenderTargetWrappers(),this.wipeCaches(!0),this._depthCullingState.depthTest=i,this._depthCullingState.depthFunc=s,this._depthCullingState.depthMask=r,this._stencilState.stencilTest=n,k.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1}),0)}_sharedInit(e){this._renderingCanvas=e}_getShaderProcessingContext(e){return null}_rebuildInternalTextures(){const e=this._internalTexturesCache.slice();for(const t of e)t._rebuild()}_rebuildRenderTargetWrappers(){const e=this._renderTargetWrapperCache.slice();for(const t of e)t._rebuild()}_rebuildEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e];t._pipelineContext=null,t._wasPreviouslyReady=!1,t._prepareEffect()}ot.ResetCache()}areAllEffectsReady(){for(const e in this._compiledEffects)if(!this._compiledEffects[e].isReady())return!1;return!0}_rebuildBuffers(){for(const e of this._uniformBuffers)e._rebuild();for(const e of this._storageBuffers)e._rebuild()}_initGLContext(){var e;this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:this._webGLVersion>1||null!==this._gl.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),supportFloatTexturesResolve:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:1!==this._webGLVersion,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);const t=this._gl.getExtension("WEBGL_debug_renderer_info");if(null!=t&&(this._glRenderer=this._gl.getParameter(t.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(t.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193),34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(null!==(e=this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT))&&void 0!==e?e:0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=null!==this._maxMSAASamplesOverride?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES);else{const e=this._gl.getExtension("WEBGL_draw_buffers");if(null!==e){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=e.drawBuffersWEBGL.bind(e),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let t=0;t<16;t++)this._gl["COLOR_ATTACHMENT"+t+"_WEBGL"]=e["COLOR_ATTACHMENT"+t+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const e=this._gl.getExtension("WEBGL_depth_texture");null!=e&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=e.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const e=this._gl.getExtension("OES_vertex_array_object");null!=e&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=e.createVertexArrayOES.bind(e),this._gl.bindVertexArray=e.bindVertexArrayOES.bind(e),this._gl.deleteVertexArray=e.deleteVertexArrayOES.bind(e))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const e=this._gl.getExtension("ANGLE_instanced_arrays");null!=e?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=e.drawArraysInstancedANGLE.bind(e),this._gl.drawElementsInstanced=e.drawElementsInstancedANGLE.bind(e),this._gl.vertexAttribDivisor=e.vertexAttribDivisorANGLE.bind(e)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const e=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),t=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);e&&t&&(this._caps.highPrecisionShaderSupported=0!==e.precision&&0!==t.precision)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const e=this._gl.getExtension("EXT_blend_minmax");null!=e&&(this._caps.blendMinMax=!0,this._gl.MAX=e.MAX_EXT,this._gl.MIN=e.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const e=this._gl.getExtension("EXT_sRGB");null!=e&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:e.SRGB_EXT,SRGB8:e.SRGB_ALPHA_EXT,SRGB8_ALPHA8:e.SRGB_ALPHA_EXT})}this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&!(!this._creationOptions||!this._creationOptions.forceSRGBBufferSupportState)}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let e=0;e<this._maxSimultaneousTextures;e++)this._nextFreeTextureSlots.push(e);"Mali-G72"===this._glRenderer&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:1!==this._webGLVersion,supportDepthStencilTexture:1!==this._webGLVersion,supportShadowSamplers:1!==this._webGLVersion,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:1!==this._webGLVersion,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:1!==this._webGLVersion,basisNeedsPOT:1===this._webGLVersion,support3DTextures:1!==this._webGLVersion,needTypeSuffixInShaderConstants:1!==this._webGLVersion,supportMSAA:1!==this._webGLVersion,supportSSAO2:1!==this._webGLVersion,supportExtendedTextureFormats:1!==this._webGLVersion,supportSwitchCaseInShader:1!==this._webGLVersion,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideMultiple4Bytes:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}get isStencilEnable(){return this._isStencilEnable}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}resetTextureCache(){for(const e in this._boundTexturesCache)Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)&&(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}setHardwareScalingLevel(e){this._hardwareScalingLevel=e,this.resize()}getHardwareScalingLevel(){return this._hardwareScalingLevel}getLoadedTexturesCache(){return this._internalTexturesCache}getCaps(){return this._caps}stopRenderLoop(e){if(!e)return this._activeRenderLoops.length=0,void this._cancelFrame();const t=this._activeRenderLoops.indexOf(e);t>=0&&(this._activeRenderLoops.splice(t,1),0==this._activeRenderLoops.length&&this._cancelFrame())}_cancelFrame(){if(this._renderingQueueLaunched&&this._frameHandler){if(this._renderingQueueLaunched=!1,Me()){const{cancelAnimationFrame:e}=this.getHostWindow()||window;if("function"==typeof e)return e(this._frameHandler)}else if("function"==typeof cancelAnimationFrame)return cancelAnimationFrame(this._frameHandler);return clearTimeout(this._frameHandler)}}_renderLoop(){if(!this._contextWasLost){let e=!0;if((this._isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(e=!1),e){this.beginFrame();for(let e=0;e<this._activeRenderLoops.length;e++)(0,this._activeRenderLoops[e])();this.endFrame()}}this._activeRenderLoops.length>0?this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}getHostWindow(){return Me()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}_queueNewFrame(e,t){return bt.QueueNewFrame(e,t)}runRenderLoop(e){-1===this._activeRenderLoops.indexOf(e)&&(this._activeRenderLoops.push(e),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._boundRenderFunction=()=>this._renderLoop(),this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))}clear(e,t,i,s=!1){var r,n;const o=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=o;let a=0;if(t&&e){let t=!0;if(this._currentRenderTarget){const i=null===(r=this._currentRenderTarget.texture)||void 0===r?void 0:r.format;if(8===i||9===i||10===i||11===i){const i=null===(n=this._currentRenderTarget.texture)||void 0===n?void 0:n.type;7===i||5===i?(bt._TempClearColorUint32[0]=255*e.r,bt._TempClearColorUint32[1]=255*e.g,bt._TempClearColorUint32[2]=255*e.b,bt._TempClearColorUint32[3]=255*e.a,this._gl.clearBufferuiv(this._gl.COLOR,0,bt._TempClearColorUint32),t=!1):(bt._TempClearColorInt32[0]=255*e.r,bt._TempClearColorInt32[1]=255*e.g,bt._TempClearColorInt32[2]=255*e.b,bt._TempClearColorInt32[3]=255*e.a,this._gl.clearBufferiv(this._gl.COLOR,0,bt._TempClearColorInt32),t=!1)}}t&&(this._gl.clearColor(e.r,e.g,e.b,void 0!==e.a?e.a:1),a|=this._gl.COLOR_BUFFER_BIT)}i&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),a|=this._gl.DEPTH_BUFFER_BIT),s&&(this._gl.clearStencil(0),a|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(a)}_viewport(e,t,i,s){e===this._viewportCached.x&&t===this._viewportCached.y&&i===this._viewportCached.z&&s===this._viewportCached.w||(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=s,this._gl.viewport(e,t,i,s))}setViewport(e,t,i){const s=t||this.getRenderWidth(),r=i||this.getRenderHeight(),n=e.x||0,o=e.y||0;this._cachedViewport=e,this._viewport(n*s,o*r,s*e.width,r*e.height)}beginFrame(){}endFrame(){this._badOS&&this.flushFramebuffer(),this._frameId++}resize(e=!1){let t,i;if(this.adaptToDeviceRatio){const e=Me()&&window.devicePixelRatio||1,t=this._lastDevicePixelRatio/e;this._lastDevicePixelRatio=e,this._hardwareScalingLevel*=t}if(Me()&&De())if(this._renderingCanvas){const e=this._renderingCanvas.getBoundingClientRect?this._renderingCanvas.getBoundingClientRect():{width:this._renderingCanvas.width*this._hardwareScalingLevel,height:this._renderingCanvas.height*this._hardwareScalingLevel};t=this._renderingCanvas.clientWidth||e.width||this._renderingCanvas.width||100,i=this._renderingCanvas.clientHeight||e.height||this._renderingCanvas.height||100}else t=window.innerWidth,i=window.innerHeight;else t=this._renderingCanvas?this._renderingCanvas.width:100,i=this._renderingCanvas?this._renderingCanvas.height:100;this.setSize(t/this._hardwareScalingLevel,i/this._hardwareScalingLevel,e)}setSize(e,t,i=!1){return!(!this._renderingCanvas||(e|=0,t|=0,!i&&this._renderingCanvas.width===e&&this._renderingCanvas.height===t||(this._renderingCanvas.width=e,this._renderingCanvas.height=t,0)))}bindFramebuffer(e,t=0,i,s,r,n=0,o=0){var a,l,h,c,u,d;const p=e;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(p._MSAAFramebuffer?p._MSAAFramebuffer:p._framebuffer);const _=this._gl;e.isMulti||(e.is2DArray?_.framebufferTextureLayer(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,null===(a=e.texture._hardwareTexture)||void 0===a?void 0:a.underlyingResource,n,o):e.isCube?_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_CUBE_MAP_POSITIVE_X+t,null===(l=e.texture._hardwareTexture)||void 0===l?void 0:l.underlyingResource,n):p._currentLOD!==n&&(_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_2D,null===(h=e.texture._hardwareTexture)||void 0===h?void 0:h.underlyingResource,n),p._currentLOD=n));const f=e._depthStencilTexture;if(f){const i=e._depthStencilTextureWithStencil?_.DEPTH_STENCIL_ATTACHMENT:_.DEPTH_ATTACHMENT;e.is2DArray?_.framebufferTextureLayer(_.FRAMEBUFFER,i,null===(c=f._hardwareTexture)||void 0===c?void 0:c.underlyingResource,n,o):e.isCube?_.framebufferTexture2D(_.FRAMEBUFFER,i,_.TEXTURE_CUBE_MAP_POSITIVE_X+t,null===(u=f._hardwareTexture)||void 0===u?void 0:u.underlyingResource,n):_.framebufferTexture2D(_.FRAMEBUFFER,i,_.TEXTURE_2D,null===(d=f._hardwareTexture)||void 0===d?void 0:d.underlyingResource,n)}this._cachedViewport&&!r?this.setViewport(this._cachedViewport,i,s):(i||(i=e.width,n&&(i/=Math.pow(2,n))),s||(s=e.height,n&&(s/=Math.pow(2,n))),this._viewport(0,0,i,s)),this.wipeCaches()}setState(e,t=0,i,s=!1,r,n,o=0){var a,l;(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e);const h=null===(l=null!==(a=this.cullBackFaces)&&void 0!==a?a:r)||void 0===l||l?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==h||i)&&(this._depthCullingState.cullFace=h),this.setZOffset(t),this.setZOffsetUnits(o);const c=s?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==c||i)&&(this._depthCullingState.frontFace=c),this._stencilStateComposer.stencilMaterial=n}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(e){this._depthCullingState.depthTest=e}setZOffset(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e}getZOffset(){const e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e}setZOffsetUnits(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e}getZOffsetUnits(){const e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)}_currentFrameBufferIsDefaultFrameBuffer(){return null===this._currentFramebuffer}generateMipmaps(e){this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)}unBindFramebuffer(e,t=!1,i){var s;const r=e;this._currentRenderTarget=null;const n=this._gl;if(r._MSAAFramebuffer){if(e.isMulti)return void this.unBindMultiColorAttachmentFramebuffer(e,t,i);n.bindFramebuffer(n.READ_FRAMEBUFFER,r._MSAAFramebuffer),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,r._framebuffer),n.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,n.COLOR_BUFFER_BIT,n.NEAREST)}!(null===(s=e.texture)||void 0===s?void 0:s.generateMipMaps)||t||e.isCube||this.generateMipmaps(e.texture),i&&(r._MSAAFramebuffer&&this._bindUnboundFramebuffer(r._framebuffer),i()),this._bindUnboundFramebuffer(null)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(e,t,i){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)}_createVertexBuffer(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create vertex buffer");const s=new gt(i);return this.bindArrayBuffer(s),e instanceof Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t):this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),this._resetVertexBufferBinding(),s.references=1,s}createDynamicVertexBuffer(e,t){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(e,t,i){const s=this._gl.createBuffer(),r=new gt(s);if(!s)throw new Error("Unable to create index buffer");this.bindIndexBuffer(r);const n=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,n,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),r.references=1,r.is32Bits=4===n.BYTES_PER_ELEMENT,r}_normalizeIndexData(e){if(2===e.BYTES_PER_ELEMENT)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(let t=0;t<e.length;t++)if(e[t]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)}bindArrayBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)}bindUniformBlock(e,t,i){const s=e.program,r=this._gl.getUniformBlockIndex(s,t);this._gl.uniformBlockBinding(s,r,i)}bindIndexBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)}updateArrayBuffer(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)}_vertexAttribPointer(e,t,i,s,r,n,o){const a=this._currentBufferPointers[t];if(!a)return;let l=!1;a.active?(a.buffer!==e&&(a.buffer=e,l=!0),a.size!==i&&(a.size=i,l=!0),a.type!==s&&(a.type=s,l=!0),a.normalized!==r&&(a.normalized=r,l=!0),a.stride!==n&&(a.stride=n,l=!0),a.offset!==o&&(a.offset=o,l=!0)):(l=!0,a.active=!0,a.index=t,a.size=i,a.type=s,a.normalized=r,a.stride=n,a.offset=o,a.buffer=e),(l||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),s===this._gl.UNSIGNED_INT||s===this._gl.INT?this._gl.vertexAttribIPointer(t,i,s,n,o):this._gl.vertexAttribPointer(t,i,s,r,n,o))}_bindIndexBufferWithCache(e){null!=e&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)}_bindVertexBuffersAttributes(e,t,i){const s=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let r=0;r<s.length;r++){const n=t.getAttributeLocation(r);if(n>=0){const t=s[r];let o=null;if(i&&(o=i[t]),o||(o=e[t]),!o)continue;this._gl.enableVertexAttribArray(n),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[n]=!0);const a=o.getBuffer();a&&(this._vertexAttribPointer(a,n,o.getSize(),o.type,o.normalized,o.byteStride,o.byteOffset),o.getIsInstanced()&&(this._gl.vertexAttribDivisor(n,o.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(n),this._currentInstanceBuffers.push(a))))}}}recordVertexArrayObject(e,t,i,s){const r=this._gl.createVertexArray();if(!r)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(r),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,i,s),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),r}bindVertexArrayObject(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=t&&t.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(e,t,i,s,r){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==r){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=r;const t=r.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let n=0;for(let o=0;o<t;o++)if(o<i.length){const t=r.getAttributeLocation(o);t>=0&&(this._gl.enableVertexAttribArray(t),this._vertexAttribArraysEnabled[t]=!0,this._vertexAttribPointer(e,t,i[o],this._gl.FLOAT,!1,s,n)),n+=4*i[o]}}this._bindIndexBufferWithCache(t)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(e,t,i,s){this._cachedVertexBuffers===e&&this._cachedEffectForVertexBuffers===i||(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i,this._bindVertexBuffersAttributes(e,i,s)),this._bindIndexBufferWithCache(t)}unbindInstanceAttributes(){let e;for(let t=0,i=this._currentInstanceLocations.length;t<i;t++){const i=this._currentInstanceBuffers[t];e!=i&&i.references&&(e=i,this.bindArrayBuffer(i));const s=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(s,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(e){this._gl.deleteVertexArray(e)}_releaseBuffer(e){return e.references--,0===e.references&&(this._deleteBuffer(e),!0)}_deleteBuffer(e){this._gl.deleteBuffer(e.underlyingResource)}updateAndBindInstancesBuffer(e,t,i){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),void 0!==i[0].index)this.bindInstancesBuffer(e,i,!0);else for(let t=0;t<4;t++){const s=i[t];this._vertexAttribArraysEnabled[s]||(this._gl.enableVertexAttribArray(s),this._vertexAttribArraysEnabled[s]=!0),this._vertexAttribPointer(e,s,4,this._gl.FLOAT,!1,64,16*t),this._gl.vertexAttribDivisor(s,1),this._currentInstanceLocations.push(s),this._currentInstanceBuffers.push(e)}}bindInstancesBuffer(e,t,i=!0){this.bindArrayBuffer(e);let s=0;if(i)for(let e=0;e<t.length;e++)s+=4*t[e].attributeSize;for(let i=0;i<t.length;i++){const r=t[i];void 0===r.index&&(r.index=this._currentEffect.getAttributeLocationByName(r.attributeName)),r.index<0||(this._vertexAttribArraysEnabled[r.index]||(this._gl.enableVertexAttribArray(r.index),this._vertexAttribArraysEnabled[r.index]=!0),this._vertexAttribPointer(e,r.index,r.attributeSize,r.attributeType||this._gl.FLOAT,r.normalized||!1,s,r.offset),this._gl.vertexAttribDivisor(r.index,void 0===r.divisor?1:r.divisor),this._currentInstanceLocations.push(r.index),this._currentInstanceBuffers.push(e))}}disableInstanceAttributeByName(e){if(!this._currentEffect)return;const t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}disableInstanceAttribute(e){let t,i=!1;for(;-1!==(t=this._currentInstanceLocations.indexOf(e));)this._currentInstanceLocations.splice(t,1),this._currentInstanceBuffers.splice(t,1),i=!0,t=this._currentInstanceLocations.indexOf(e);i&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))}disableAttributeByIndex(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1}draw(e,t,i,s){this.drawElementsType(e?0:1,t,i,s)}drawPointClouds(e,t,i){this.drawArraysType(2,e,t,i)}drawUnIndexed(e,t,i,s){this.drawArraysType(e?0:1,t,i,s)}drawElementsType(e,t,i,s){this.applyStates(),this._reportDrawCall();const r=this._drawMode(e),n=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,o=this._uintIndicesCurrentlySet?4:2;s?this._gl.drawElementsInstanced(r,i,n,t*o,s):this._gl.drawElements(r,i,n,t*o)}drawArraysType(e,t,i,s){this.applyStates(),this._reportDrawCall();const r=this._drawMode(e);s?this._gl.drawArraysInstanced(r,t,i,s):this._gl.drawArrays(r,t,i)}_drawMode(e){switch(e){case 0:default:return this._gl.TRIANGLES;case 2:case 3:return this._gl.POINTS;case 1:case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN}}_reportDrawCall(){}_releaseEffect(e){this._compiledEffects[e._key]&&delete this._compiledEffects[e._key];const t=e.getPipelineContext();t&&this._deletePipelineContext(t)}_deletePipelineContext(e){const t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,this._gl.deleteProgram(t.program))}_getGlobalDefines(e){if(e)return this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,void(this.useExactSrgbConversions?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS);{let e="";return this.isNDCHalfZRange&&(e+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(e&&(e+="\n"),e+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(e&&(e+="\n"),e+="#define USE_EXACT_SRGB_CONVERSIONS"),e}}createEffect(e,t,i,s,r,n,o,a,l,h=qe.GLSL){var c;const u=e.vertexElement||e.vertex||e.vertexToken||e.vertexSource||e,d=e.fragmentElement||e.fragment||e.fragmentToken||e.fragmentSource||e,p=this._getGlobalDefines();let _=null!==(c=null!=r?r:t.defines)&&void 0!==c?c:"";p&&(_+=p);const f=u+"+"+d+"@"+_;if(this._compiledEffects[f]){const e=this._compiledEffects[f];return o&&e.isReady()&&o(e),e}const m=new ot(e,t,i,s,this,r,n,o,a,l,f,h);return this._compiledEffects[f]=m,m}static _ConcatenateShader(e,t,i=""){return i+(t?t+"\n":"")+e}_compileShader(e,t,i,s){return this._compileRawShader(bt._ConcatenateShader(e,i,s),t)}_compileRawShader(e,t){const i=this._gl,s=i.createShader("vertex"===t?i.VERTEX_SHADER:i.FRAGMENT_SHADER);if(!s){let e=i.NO_ERROR,s=i.NO_ERROR;for(;(s=i.getError())!==i.NO_ERROR;)e=s;throw new Error(`Something went wrong while creating a gl ${t} shader object. gl error=${e}, gl isContextLost=${i.isContextLost()}, _contextWasLost=${this._contextWasLost}`)}return i.shaderSource(s,e),i.compileShader(s),s}_getShaderSource(e){return this._gl.getShaderSource(e)}createRawShaderProgram(e,t,i,s,r=null){s=s||this._gl;const n=this._compileRawShader(t,"vertex"),o=this._compileRawShader(i,"fragment");return this._createShaderProgram(e,n,o,s,r)}createShaderProgram(e,t,i,s,r,n=null){r=r||this._gl;const o=this._webGLVersion>1?"#version 300 es\n#define WEBGL2 \n":"",a=this._compileShader(t,"vertex",s,o),l=this._compileShader(i,"fragment",s,o);return this._createShaderProgram(e,a,l,r,n)}inlineShaderCode(e){return e}createPipelineContext(e){const t=new vt;return t.engine=this,this._caps.parallelShaderCompile&&(t.isParallelCompiled=!0),t}createMaterialContext(){}createDrawContext(){}_createShaderProgram(e,t,i,s,r=null){const n=s.createProgram();if(e.program=n,!n)throw new Error("Unable to create program");return s.attachShader(n,t),s.attachShader(n,i),s.linkProgram(n),e.context=s,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),n}_finalizePipelineContext(e){const t=e.context,i=e.vertexShader,s=e.fragmentShader,r=e.program;if(!t.getProgramParameter(r,t.LINK_STATUS)){if(!this._gl.getShaderParameter(i,this._gl.COMPILE_STATUS)){const t=this._gl.getShaderInfoLog(i);if(t)throw e.vertexCompilationError=t,new Error("VERTEX SHADER "+t)}if(!this._gl.getShaderParameter(s,this._gl.COMPILE_STATUS)){const t=this._gl.getShaderInfoLog(s);if(t)throw e.fragmentCompilationError=t,new Error("FRAGMENT SHADER "+t)}const n=t.getProgramInfoLog(r);if(n)throw e.programLinkError=n,new Error(n)}if(this.validateShaderPrograms&&(t.validateProgram(r),!t.getProgramParameter(r,t.VALIDATE_STATUS))){const i=t.getProgramInfoLog(r);if(i)throw e.programValidationError=i,new Error(i)}t.deleteShader(i),t.deleteShader(s),e.vertexShader=void 0,e.fragmentShader=void 0,e.onCompiled&&(e.onCompiled(),e.onCompiled=void 0)}_preparePipelineContext(e,t,i,s,r,n,o,a,l,h){const c=e;c.program=s?this.createRawShaderProgram(c,t,i,void 0,l):this.createShaderProgram(c,t,i,a,void 0,l),c.program.__SPECTOR_rebuildProgram=o}_isRenderingStateCompiled(e){const t=e;return!(this._isDisposed||t._isDisposed||!this._gl.getProgramParameter(t.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)||(this._finalizePipelineContext(t),0))}_executeWhenRenderingStateIsCompiled(e,t){const i=e;if(!i.isParallelCompiled)return void t();const s=i.onCompiled;i.onCompiled=s?()=>{s(),t()}:t}getUniforms(e,t){const i=new Array,s=e;for(let e=0;e<t.length;e++)i.push(this._gl.getUniformLocation(s.program,t[e]));return i}getAttributes(e,t){const i=[],s=e;for(let e=0;e<t.length;e++)try{i.push(this._gl.getAttribLocation(s.program,t[e]))}catch(e){i.push(-1)}return i}enableEffect(e){(e=null!==e&&Tt.IsWrapper(e)?e.effect:e)&&e!==this._currentEffect&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setInt(e,t){return!!e&&(this._gl.uniform1i(e,t),!0)}setInt2(e,t,i){return!!e&&(this._gl.uniform2i(e,t,i),!0)}setInt3(e,t,i,s){return!!e&&(this._gl.uniform3i(e,t,i,s),!0)}setInt4(e,t,i,s,r){return!!e&&(this._gl.uniform4i(e,t,i,s,r),!0)}setIntArray(e,t){return!!e&&(this._gl.uniform1iv(e,t),!0)}setIntArray2(e,t){return!(!e||t.length%2!=0||(this._gl.uniform2iv(e,t),0))}setIntArray3(e,t){return!(!e||t.length%3!=0||(this._gl.uniform3iv(e,t),0))}setIntArray4(e,t){return!(!e||t.length%4!=0||(this._gl.uniform4iv(e,t),0))}setUInt(e,t){return!!e&&(this._gl.uniform1ui(e,t),!0)}setUInt2(e,t,i){return!!e&&(this._gl.uniform2ui(e,t,i),!0)}setUInt3(e,t,i,s){return!!e&&(this._gl.uniform3ui(e,t,i,s),!0)}setUInt4(e,t,i,s,r){return!!e&&(this._gl.uniform4ui(e,t,i,s,r),!0)}setUIntArray(e,t){return!!e&&(this._gl.uniform1uiv(e,t),!0)}setUIntArray2(e,t){return!(!e||t.length%2!=0||(this._gl.uniform2uiv(e,t),0))}setUIntArray3(e,t){return!(!e||t.length%3!=0||(this._gl.uniform3uiv(e,t),0))}setUIntArray4(e,t){return!(!e||t.length%4!=0||(this._gl.uniform4uiv(e,t),0))}setArray(e,t){return!(!e||t.length<1||(this._gl.uniform1fv(e,t),0))}setArray2(e,t){return!(!e||t.length%2!=0||(this._gl.uniform2fv(e,t),0))}setArray3(e,t){return!(!e||t.length%3!=0||(this._gl.uniform3fv(e,t),0))}setArray4(e,t){return!(!e||t.length%4!=0||(this._gl.uniform4fv(e,t),0))}setMatrices(e,t){return!!e&&(this._gl.uniformMatrix4fv(e,!1,t),!0)}setMatrix3x3(e,t){return!!e&&(this._gl.uniformMatrix3fv(e,!1,t),!0)}setMatrix2x2(e,t){return!!e&&(this._gl.uniformMatrix2fv(e,!1,t),!0)}setFloat(e,t){return!!e&&(this._gl.uniform1f(e,t),!0)}setFloat2(e,t,i){return!!e&&(this._gl.uniform2f(e,t,i),!0)}setFloat3(e,t,i,s){return!!e&&(this._gl.uniform3f(e,t,i,s),!0)}setFloat4(e,t,i,s,r){return!!e&&(this._gl.uniform4f(e,t,i,s,r),!0)}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const e=this._colorWrite;this._gl.colorMask(e,e,e,e)}}setColorWrite(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}clearInternalTexturesCache(){this._internalTexturesCache.length=0}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(e,t){const i=this._gl;let s=i.NEAREST,r=i.NEAREST;switch(e){case 11:s=i.LINEAR,r=t?i.LINEAR_MIPMAP_NEAREST:i.LINEAR;break;case 3:s=i.LINEAR,r=t?i.LINEAR_MIPMAP_LINEAR:i.LINEAR;break;case 8:s=i.NEAREST,r=t?i.NEAREST_MIPMAP_LINEAR:i.NEAREST;break;case 4:s=i.NEAREST,r=t?i.NEAREST_MIPMAP_NEAREST:i.NEAREST;break;case 5:s=i.NEAREST,r=t?i.LINEAR_MIPMAP_NEAREST:i.LINEAR;break;case 6:s=i.NEAREST,r=t?i.LINEAR_MIPMAP_LINEAR:i.LINEAR;break;case 7:s=i.NEAREST,r=i.LINEAR;break;case 1:s=i.NEAREST,r=i.NEAREST;break;case 9:s=i.LINEAR,r=t?i.NEAREST_MIPMAP_NEAREST:i.NEAREST;break;case 10:s=i.LINEAR,r=t?i.NEAREST_MIPMAP_LINEAR:i.NEAREST;break;case 2:s=i.LINEAR,r=i.LINEAR;break;case 12:s=i.LINEAR,r=i.NEAREST}return{min:r,mag:s}}_createTexture(){const e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e}_createHardwareTexture(){return new xt(this._createTexture(),this._gl)}_createInternalTexture(e,t,i=!0,s=ut.Unknown){var r;let n,o=!1,a=0,l=3,h=5,c=!1,u=1;void 0!==t&&"object"==typeof t?(o=!!t.generateMipMaps,a=void 0===t.type?0:t.type,l=void 0===t.samplingMode?3:t.samplingMode,h=void 0===t.format?5:t.format,c=void 0!==t.useSRGBBuffer&&t.useSRGBBuffer,u=null!==(r=t.samples)&&void 0!==r?r:1,n=t.label):o=!!t,c&&(c=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(1!==a||this._caps.textureFloatLinearFiltering)&&(2!==a||this._caps.textureHalfFloatLinearFiltering)||(l=1),1!==a||this._caps.textureFloat||(a=0,k.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const d=this._gl,p=new dt(this,s),_=e.width||e,f=e.height||e,m=e.layers||0,g=this._getSamplingParameters(l,o),v=0!==m?d.TEXTURE_2D_ARRAY:d.TEXTURE_2D,x=this._getRGBABufferInternalSizedFormat(a,h,c),T=this._getInternalFormat(h),E=this._getWebGLTextureType(a);return this._bindTextureDirectly(v,p),0!==m?(p.is2DArray=!0,d.texImage3D(v,0,x,_,f,m,0,T,E,null)):d.texImage2D(v,0,x,_,f,0,T,E,null),d.texParameteri(v,d.TEXTURE_MAG_FILTER,g.mag),d.texParameteri(v,d.TEXTURE_MIN_FILTER,g.min),d.texParameteri(v,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(v,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),o&&this._gl.generateMipmap(v),this._bindTextureDirectly(v,null),p._useSRGBBuffer=c,p.baseWidth=_,p.baseHeight=f,p.width=_,p.height=f,p.depth=m,p.isReady=!0,p.samples=u,p.generateMipMaps=o,p.samplingMode=l,p.type=a,p.format=h,p.label=n,this._internalTexturesCache.push(p),p}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||t)}_createTextureBase(e,t,i,s,r=3,n=null,o=null,a,l,h=null,c=null,u=null,d=null,p,_,f){const m="data:"===(e=e||"").substr(0,5),g="blob:"===e.substr(0,5),v=m&&-1!==e.indexOf(";base64,"),T=c||new dt(this,ut.Url);T!==c&&(T.label=e.substring(0,60));const E=e;!this._transformTextureUrl||v||c||h||(e=this._transformTextureUrl(e)),E!==e&&(T._originalUrl=E);const S=e.lastIndexOf(".");let b=d||(S>-1?e.substring(S).toLowerCase():""),C=null;b.indexOf("?")>-1&&(b=b.split("?")[0]);for(const e of bt._TextureLoaders)if(e.canLoad(b,p)){C=e;break}s&&s.addPendingData(T),T.url=e,T.generateMipMaps=!t,T.samplingMode=r,T.invertY=i,T._useSRGBBuffer=this._getUseSRGBBuffer(!!f,t),this._doNotHandleContextLost||(T._buffer=h);let y=null;n&&!c&&(y=T.onLoadedObservable.add(n)),c||this._internalTexturesCache.push(T);const A=(i,c)=>{s&&s.removePendingData(T),e===E?(y&&T.onLoadedObservable.remove(y),x.UseFallbackTexture&&this._createTextureBase(x.FallbackTexture,t,T.invertY,s,r,null,o,a,l,h,T),i=(i||"Unknown error")+(x.UseFallbackTexture?" - Fallback texture was used":""),T.onErrorObservable.notifyObservers({message:i,exception:c}),o&&o(i,c)):(k.Warn(`Failed to load ${e}, falling back to ${E}`),this._createTextureBase(E,t,T.invertY,s,r,n,o,a,l,h,T,u,d,p,_,f))};if(C){const t=e=>{C.loadData(e,T,((e,t,i,n,o,l)=>{l?A("TextureLoader failed to load data"):a(T,b,s,{width:e,height:t},T.invertY,!i,n,(()=>(o(),!1)),r)}),_)};h?h instanceof ArrayBuffer?t(new Uint8Array(h)):ArrayBuffer.isView(h)?t(h):o&&o("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(e,(e=>t(new Uint8Array(e))),void 0,s?s.offlineProvider:void 0,!0,((e,t)=>{A("Unable to load "+(e&&e.responseURL,t))}))}else{const i=e=>{g&&!this._doNotHandleContextLost&&(T._buffer=e),a(T,b,s,e,T.invertY,t,!1,l,r)};!m||v?h&&("string"==typeof h.decoding||h.close)?i(h):bt._FileToolsLoadImage(e,i,A,s?s.offlineProvider:null,p,T.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):"string"==typeof h||h instanceof ArrayBuffer||ArrayBuffer.isView(h)||h instanceof Blob?bt._FileToolsLoadImage(h,i,A,s?s.offlineProvider:null,p,T.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):h&&i(h)}return T}createTexture(e,t,i,s,r=3,n=null,o=null,a=null,l=null,h=null,c=null,u,d,p,_){return this._createTextureBase(e,t,i,s,r,n,o,this._prepareWebGLTexture.bind(this),((e,t,i,r,n,o)=>{const a=this._gl,l=i.width===e&&i.height===t,c=this._getTexImageParametersForCreateTexture(h,r,n._useSRGBBuffer);if(l)return a.texImage2D(a.TEXTURE_2D,0,c.internalFormat,c.format,c.type,i),!1;const u=this._caps.maxTextureSize;if(i.width>u||i.height>u||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!(!this._workingCanvas||!this._workingContext||(this._workingCanvas.width=e,this._workingCanvas.height=t,this._workingContext.drawImage(i,0,0,i.width,i.height,0,0,e,t),a.texImage2D(a.TEXTURE_2D,0,c.internalFormat,c.format,c.type,this._workingCanvas),n.width=e,n.height=t,1));{const e=new dt(this,ut.Temp);this._bindTextureDirectly(a.TEXTURE_2D,e,!0),a.texImage2D(a.TEXTURE_2D,0,c.internalFormat,c.format,c.type,i),this._rescaleTexture(e,n,s,c.format,(()=>{this._releaseTexture(e),this._bindTextureDirectly(a.TEXTURE_2D,n,!0),o()}))}return!0}),a,l,h,c,u,d,_)}_getTexImageParametersForCreateTexture(e,t,i){let s,r;return null==e&&(e=".jpg"!==t||i?5:4),1===this.webGLVersion?(s=this._getInternalFormat(e,i),r=s):(s=this._getInternalFormat(e,!1),r=this._getRGBABufferInternalSizedFormat(0,e,i)),{internalFormat:r,format:s,type:this._gl.UNSIGNED_BYTE}}static _FileToolsLoadImage(e,t,i,s,r,n){throw $("FileTools")}_rescaleTexture(e,t,i,s,r){}createRawTexture(e,t,i,s,r,n,o,a=null,l=0,h=0,c=!1){throw $("Engine.RawTexture")}createRawCubeTexture(e,t,i,s,r,n,o,a=null){throw $("Engine.RawTexture")}createRawTexture3D(e,t,i,s,r,n,o,a,l=null,h=0){throw $("Engine.RawTexture")}createRawTexture2DArray(e,t,i,s,r,n,o,a,l=null,h=0){throw $("Engine.RawTexture")}_unpackFlipY(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(e,t,i=!1){const s=this._getTextureTarget(t),r=this._getSamplingParameters(e,t.useMipMaps||i);this._setTextureParameterInteger(s,this._gl.TEXTURE_MAG_FILTER,r.mag,t),this._setTextureParameterInteger(s,this._gl.TEXTURE_MIN_FILTER,r.min),i&&(t.generateMipMaps=!0,this._gl.generateMipmap(s)),this._bindTextureDirectly(s,null),t.samplingMode=e}updateTextureDimensions(e,t,i,s=1){}updateTextureWrappingMode(e,t,i=null,s=null){const r=this._getTextureTarget(e);null!==t&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),null!==i&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i),e),e._cachedWrapV=i),(e.is2DArray||e.is3D)&&null!==s&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(s),e),e._cachedWrapR=s),this._bindTextureDirectly(r,null)}_setupDepthStencilTexture(e,t,i,s,r,n=1){const o=t.width||t,a=t.height||t,l=t.layers||0;e.baseWidth=o,e.baseHeight=a,e.width=o,e.height=a,e.is2DArray=l>0,e.depth=l,e.isReady=!0,e.samples=n,e.generateMipMaps=!1,e.samplingMode=s?2:1,e.type=0,e._comparisonFunction=r;const h=this._gl,c=this._getTextureTarget(e),u=this._getSamplingParameters(e.samplingMode,!1);h.texParameteri(c,h.TEXTURE_MAG_FILTER,u.mag),h.texParameteri(c,h.TEXTURE_MIN_FILTER,u.min),h.texParameteri(c,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(c,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),this.webGLVersion>1&&(0===r?(h.texParameteri(c,h.TEXTURE_COMPARE_FUNC,515),h.texParameteri(c,h.TEXTURE_COMPARE_MODE,h.NONE)):(h.texParameteri(c,h.TEXTURE_COMPARE_FUNC,r),h.texParameteri(c,h.TEXTURE_COMPARE_MODE,h.COMPARE_REF_TO_TEXTURE)))}_uploadCompressedDataToTextureDirectly(e,t,i,s,r,n=0,o=0){const a=this._gl;let l=a.TEXTURE_2D;if(e.isCube&&(l=a.TEXTURE_CUBE_MAP_POSITIVE_X+n),e._useSRGBBuffer)switch(t){case 37492:case 36196:this._caps.etc2?t=a.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?t=a.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:t=a.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=a.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=a.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?t=a.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=a.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1}this._gl.compressedTexImage2D(l,o,t,i,s,0,r)}_uploadDataToTextureDirectly(e,t,i=0,s=0,r,n=!1){const o=this._gl,a=this._getWebGLTextureType(e.type),l=this._getInternalFormat(e.format),h=void 0===r?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(r,e._useSRGBBuffer);this._unpackFlipY(e.invertY);let c=o.TEXTURE_2D;e.isCube&&(c=o.TEXTURE_CUBE_MAP_POSITIVE_X+i);const u=Math.round(Math.log(e.width)*Math.LOG2E),d=Math.round(Math.log(e.height)*Math.LOG2E),p=n?e.width:Math.pow(2,Math.max(u-s,0)),_=n?e.height:Math.pow(2,Math.max(d-s,0));o.texImage2D(c,s,h,p,_,0,l,a,t)}updateTextureData(e,t,i,s,r,n,o=0,a=0,l=!1){const h=this._gl,c=this._getWebGLTextureType(e.type),u=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);let d=h.TEXTURE_2D,p=h.TEXTURE_2D;e.isCube&&(p=h.TEXTURE_CUBE_MAP_POSITIVE_X+o,d=h.TEXTURE_CUBE_MAP),this._bindTextureDirectly(d,e,!0),h.texSubImage2D(p,a,i,s,r,n,u,c,t),l&&this._gl.generateMipmap(p),this._bindTextureDirectly(d,null)}_uploadArrayBufferViewToTexture(e,t,i=0,s=0){const r=this._gl,n=e.isCube?r.TEXTURE_CUBE_MAP:r.TEXTURE_2D;this._bindTextureDirectly(n,e,!0),this._uploadDataToTextureDirectly(e,t,i,s),this._bindTextureDirectly(n,null,!0)}_prepareWebGLTextureContinuation(e,t,i,s,r){const n=this._gl;if(!n)return;const o=this._getSamplingParameters(r,!i);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,o.mag),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,o.min),i||s||n.generateMipmap(n.TEXTURE_2D),this._bindTextureDirectly(n.TEXTURE_2D,null),t&&t.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}_prepareWebGLTexture(e,t,i,s,r,n,o,a,l=3){const h=this.getCaps().maxTextureSize,c=Math.min(h,this.needPOTTextures?bt.GetExponentOfTwo(s.width,h):s.width),u=Math.min(h,this.needPOTTextures?bt.GetExponentOfTwo(s.height,h):s.height),d=this._gl;d&&(e._hardwareTexture?(this._bindTextureDirectly(d.TEXTURE_2D,e,!0),this._unpackFlipY(void 0===r||!!r),e.baseWidth=s.width,e.baseHeight=s.height,e.width=c,e.height=u,e.isReady=!0,e.type=-1!==e.type?e.type:0,e.format=-1!==e.format?e.format:".jpg"!==t||e._useSRGBBuffer?5:4,a(c,u,s,t,e,(()=>{this._prepareWebGLTextureContinuation(e,i,n,o,l)}))||this._prepareWebGLTextureContinuation(e,i,n,o,l)):i&&i.removePendingData(e))}_setupFramebufferDepthAttachments(e,t,i,s,r=1){const n=this._gl;if(e&&t)return this._createRenderBuffer(i,s,r,n.DEPTH_STENCIL,n.DEPTH24_STENCIL8,n.DEPTH_STENCIL_ATTACHMENT);if(t){let e=n.DEPTH_COMPONENT16;return this._webGLVersion>1&&(e=n.DEPTH_COMPONENT32F),this._createRenderBuffer(i,s,r,e,e,n.DEPTH_ATTACHMENT)}return e?this._createRenderBuffer(i,s,r,n.STENCIL_INDEX8,n.STENCIL_INDEX8,n.STENCIL_ATTACHMENT):null}_createRenderBuffer(e,t,i,s,r,n,o=!0){const a=this._gl.createRenderbuffer();return this._updateRenderBuffer(a,e,t,i,s,r,n,o)}_updateRenderBuffer(e,t,i,s,r,n,o,a=!0){const l=this._gl;return l.bindRenderbuffer(l.RENDERBUFFER,e),s>1&&l.renderbufferStorageMultisample?l.renderbufferStorageMultisample(l.RENDERBUFFER,s,n,t,i):l.renderbufferStorage(l.RENDERBUFFER,r,t,i),l.framebufferRenderbuffer(l.FRAMEBUFFER,o,l.RENDERBUFFER,e),a&&l.bindRenderbuffer(l.RENDERBUFFER,null),e}_releaseTexture(e){var t;this._deleteTexture(null===(t=e._hardwareTexture)||void 0===t?void 0:t.underlyingResource),this.unbindAllTextures();const i=this._internalTexturesCache.indexOf(e);-1!==i&&this._internalTexturesCache.splice(i,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()}_releaseRenderTargetWrapper(e){const t=this._renderTargetWrapperCache.indexOf(e);-1!==t&&this._renderTargetWrapperCache.splice(t,1)}_deleteTexture(e){e&&this._gl.deleteTexture(e)}_setProgram(e){this._currentProgram!==e&&(this._gl.useProgram(e),this._currentProgram=e)}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.program);const i=e.getSamplers();for(let t=0;t<i.length;t++){const s=e.getUniform(i[t]);s&&(this._boundUniforms[t]=s)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(e,t,i=!1,s=!1){var r,n;let o=!1;const a=t&&t._associatedChannel>-1;if(i&&a&&(this._activeChannel=t._associatedChannel),this._boundTexturesCache[this._activeChannel]!==t||s){if(this._activateCurrentTexture(),t&&t.isMultiview)throw console.error(e,t),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,null!==(n=null===(r=null==t?void 0:t._hardwareTexture)||void 0===r?void 0:r.underlyingResource)&&void 0!==n?n:null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)}else i&&(o=!0,this._activateCurrentTexture());return a&&!i&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),o}_bindTexture(e,t,i){if(void 0===e)return;t&&(t._associatedChannel=e),this._activeChannel=e;const s=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(s,t)}unbindAllTextures(){for(let e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(e,t,i,s){void 0!==e&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,i))}_bindSamplerUniformToChannel(e,t){const i=this._boundUniforms[e];i&&i._currentState!==t&&(this._gl.uniform1i(i,t),i._currentState=t)}_getTextureWrapMode(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(e,t,i=!1,s=!1,r=""){if(!t)return null!=this._boundTexturesCache[e]&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video){this._activeChannel=e;const i=t.getInternalTexture();i&&(i._associatedChannel=e),t.update()}else if(4===t.delayLoadState)return t.delayLoad(),!1;let n;n=s?t.depthStencilTexture:t.isReady()?t.getInternalTexture():t.isCube?this.emptyCubeTexture:t.is3D?this.emptyTexture3D:t.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!i&&n&&(n._associatedChannel=e);let o=!0;this._boundTexturesCache[e]===n&&(i||this._bindSamplerUniformToChannel(n._associatedChannel,e),o=!1),this._activeChannel=e;const a=this._getTextureTarget(n);if(o&&this._bindTextureDirectly(a,n,i),n&&!n.isMultiview){if(n.isCube&&n._cachedCoordinatesMode!==t.coordinatesMode){n._cachedCoordinatesMode=t.coordinatesMode;const e=3!==t.coordinatesMode&&5!==t.coordinatesMode?1:0;t.wrapU=e,t.wrapV=e}n._cachedWrapU!==t.wrapU&&(n._cachedWrapU=t.wrapU,this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),n)),n._cachedWrapV!==t.wrapV&&(n._cachedWrapV=t.wrapV,this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),n)),n.is3D&&n._cachedWrapR!==t.wrapR&&(n._cachedWrapR=t.wrapR,this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),n)),this._setAnisotropicLevel(a,n,t.anisotropicFilteringLevel)}return!0}setTextureArray(e,t,i,s){if(void 0!==e&&t){this._textureUnits&&this._textureUnits.length===i.length||(this._textureUnits=new Int32Array(i.length));for(let t=0;t<i.length;t++){const s=i[t].getInternalTexture();s?(this._textureUnits[t]=e+t,s._associatedChannel=e+t):this._textureUnits[t]=-1}this._gl.uniform1iv(t,this._textureUnits);for(let e=0;e<i.length;e++)this._setTexture(this._textureUnits[e],i[e],!0)}}_setAnisotropicLevel(e,t,i){const s=this._caps.textureAnisotropicFilterExtension;11!==t.samplingMode&&3!==t.samplingMode&&2!==t.samplingMode&&(i=1),s&&t._cachedAnisotropicFilteringLevel!==i&&(this._setTextureParameterFloat(e,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=i)}_setTextureParameterFloat(e,t,i,s){this._bindTextureDirectly(e,s,!0,!0),this._gl.texParameterf(e,t,i)}_setTextureParameterInteger(e,t,i,s){s&&this._bindTextureDirectly(e,s,!0,!0),this._gl.texParameteri(e,t,i)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e)}else for(let e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}releaseEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={}}dispose(){var e,t;this._isDisposed=!0,this.stopRenderLoop(),this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.releaseEffects(),null===(e=this.releaseComputeEffects)||void 0===e||e.call(this),this.unbindAllAttributes(),this._boundUniforms={},Me()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),window.removeEventListener("resize",this._checkForMobile)),this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._renderingCanvas=null,this._currentProgram=null,this._boundRenderFunction=null,ot.ResetCache();for(const e of this._activeRequests)e.abort();this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._creationOptions.loseContextOnDispose&&(null===(t=this._gl.getExtension("WEBGL_lose_context"))||void 0===t||t.loseContext())}attachContextLostEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)}attachContextRestoredEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(e){const t=this._gl;for(;t.getError()!==t.NO_ERROR;);let i=!0;const s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);const r=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,r),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,s,0);const n=t.checkFramebufferStatus(t.FRAMEBUFFER);if(i=i&&n===t.FRAMEBUFFER_COMPLETE,i=i&&t.getError()===t.NO_ERROR,i&&(t.clear(t.COLOR_BUFFER_BIT),i=i&&t.getError()===t.NO_ERROR),i){t.bindFramebuffer(t.FRAMEBUFFER,null);const e=t.RGBA,s=t.UNSIGNED_BYTE,r=new Uint8Array(4);t.readPixels(0,0,1,1,e,s,r),i=i&&t.getError()===t.NO_ERROR}for(t.deleteTexture(s),t.deleteFramebuffer(r),t.bindFramebuffer(t.FRAMEBUFFER,null);!i&&t.getError()!==t.NO_ERROR;);return i}_getWebGLTextureType(e){if(1===this._webGLVersion){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(e,t=!1){let i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:i=this._gl.ALPHA;break;case 1:i=this._gl.LUMINANCE;break;case 2:i=this._gl.LUMINANCE_ALPHA;break;case 6:i=this._gl.RED;break;case 7:i=this._gl.RG;break;case 4:i=t?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA}if(this._webGLVersion>1)switch(e){case 8:i=this._gl.RED_INTEGER;break;case 9:i=this._gl.RG_INTEGER;break;case 10:i=this._gl.RGB_INTEGER;break;case 11:i=this._gl.RGBA_INTEGER}return i}_getRGBABufferInternalSizedFormat(e,t,i=!1){if(1===this._webGLVersion){if(void 0!==t)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return i?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return i?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:default:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI}}return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}_loadFile(e,t,i,s,r,n){const o=bt._FileToolsLoadFile(e,t,i,s,r,n);return this._activeRequests.push(o),o.onCompleteObservable.add((e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)})),o}static _FileToolsLoadFile(e,t,i,s,r,n){throw $("FileTools")}readPixels(e,t,i,s,r=!0,n=!0){const o=r?4:3,a=r?this._gl.RGBA:this._gl.RGB,l=new Uint8Array(s*i*o);return n&&this.flushFramebuffer(),this._gl.readPixels(e,t,i,s,a,this._gl.UNSIGNED_BYTE,l),Promise.resolve(l)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(null!==this._HasMajorPerformanceCaveat)return!this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{const e=this._CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=null!=t&&!!window.WebGLRenderingContext}catch(e){this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(null===this._HasMajorPerformanceCaveat)try{const e=this._CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch(e){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}static CeilingPOT(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}static FloorPOT(e){return e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,(e|=e>>16)-(e>>1)}static NearestPOT(e){const t=bt.CeilingPOT(e),i=bt.FloorPOT(e);return t-e>e-i?i:t}static GetExponentOfTwo(e,t,i=2){let s;switch(i){case 1:s=bt.FloorPOT(e);break;case 2:s=bt.NearestPOT(e);break;default:s=bt.CeilingPOT(e)}return Math.min(s,t)}static QueueNewFrame(e,t){if(Me()){const{requestAnimationFrame:i}=t||window;if("function"==typeof i)return i(e)}else if("function"==typeof requestAnimationFrame)return requestAnimationFrame(e);return setTimeout(e,16)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:De()?document:null}}bt._TempClearColorUint32=new Uint32Array(4),bt._TempClearColorInt32=new Int32Array(4),bt.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],bt._TextureLoaders=[],bt.CollisionsEpsilon=.001,bt._IsSupported=null,bt._HasMajorPerformanceCaveat=null;class Ct{static SetImmediate(e){Me()&&window.setImmediate?window.setImmediate(e):setTimeout(e,1)}}const yt=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i);class At extends Ue{constructor(e,t){super(e,4e3),this.name="LoadFileError",Le._setPrototypeOf(this,At.prototype),t instanceof Te?this.request=t:this.file=t}}class Rt extends Ue{constructor(e,t){super(e,4001),this.request=t,this.name="RequestFileError",Le._setPrototypeOf(this,Rt.prototype)}}class It extends Ue{constructor(e,t){super(e,4002),this.file=t,this.name="ReadFileError",Le._setPrototypeOf(this,It.prototype)}}const Pt={DefaultRetryStrategy:class{static ExponentialBackoff(e=3,t=500){return(i,s,r)=>0!==s.status||r>=e||-1!==i.indexOf("file:")?-1:Math.pow(2,r)*t}}.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:e=>e,ScriptBaseUrl:"",ScriptPreprocessUrl:e=>e},Mt=e=>e.replace(/#/gm,"%23"),Ot=(e,t)=>{if((!e||0!==e.indexOf("data:"))&&Pt.CorsBehavior)if("string"==typeof Pt.CorsBehavior||Pt.CorsBehavior instanceof String)t.crossOrigin=Pt.CorsBehavior;else{const i=Pt.CorsBehavior(e);i&&(t.crossOrigin=i)}},Dt=(e,t,i,s,r="",n)=>{var o;let a,l=!1;e instanceof ArrayBuffer||ArrayBuffer.isView(e)?"undefined"!=typeof Blob&&"undefined"!=typeof URL?(a=URL.createObjectURL(new Blob([e],{type:r})),l=!0):a=`data:${r};base64,`+Ve(e):e instanceof Blob?(a=URL.createObjectURL(e),l=!0):(a=Mt(e),a=Pt.PreprocessUrl(e));const h=x.LastCreatedEngine,c=t=>{if(i){const s=a||e.toString();i(`Error while trying to load image: ${0===s.indexOf("http")||s.length<=128?s:s.slice(0,128)+"..."}`,t)}};if("undefined"==typeof Image||null!==(o=null==h?void 0:h._features.forceBitmapOverHTMLImageElement)&&void 0!==o&&o)return Ft(a,(s=>{h.createImageBitmap(new Blob([s],{type:r}),Object.assign({premultiplyAlpha:"none"},n)).then((e=>{t(e),l&&URL.revokeObjectURL(a)})).catch((t=>{i&&i("Error while trying to load image: "+e,t)}))}),void 0,s||void 0,!0,((e,t)=>{c(t)})),null;const u=new Image;Ot(a,u);const d=[],p=()=>{d.forEach((e=>{e.target.removeEventListener(e.name,e.handler)})),d.length=0};d.push({target:u,name:"load",handler:()=>{p(),t(u),l&&u.src&&URL.revokeObjectURL(u.src)}}),d.push({target:u,name:"error",handler:e=>{p(),c(e),l&&u.src&&URL.revokeObjectURL(u.src)}}),d.push({target:document,name:"securitypolicyviolation",handler:e=>{if(e.blockedURI!==u.src)return;p();const t=new Error(`CSP violation of policy ${e.effectiveDirective} ${e.blockedURI}. Current policy is ${e.originalPolicy}`);x.UseFallbackTexture=!1,c(t),l&&u.src&&URL.revokeObjectURL(u.src),u.src=""}}),d.forEach((e=>{e.target.addEventListener(e.name,e.handler)}));const _="blob:"===a.substring(0,5),f="data:"===a.substring(0,5),m=()=>{_||f||!Te.IsCustomRequestAvailable?u.src=a:Ft(a,((e,t,i)=>{const s=new Blob([e],{type:!r&&i?i:r}),n=URL.createObjectURL(s);l=!0,u.src=n}),void 0,s||void 0,!0,((e,t)=>{c(t)}))};if(!_&&!f&&s&&s.enableTexturesOffline)s.open((()=>{s&&s.loadImage(a,u)}),m);else{if(-1!==a.indexOf("file:")){const e=decodeURIComponent(a.substring(5).toLowerCase());if(we.FilesToLoad[e]&&"undefined"!=typeof URL){try{let t;try{t=URL.createObjectURL(we.FilesToLoad[e])}catch(i){t=URL.createObjectURL(we.FilesToLoad[e])}u.src=t,l=!0}catch(e){u.src=""}return u}}m()}return u},Nt=(e,t,i,s,r)=>{const n=new FileReader,o={onCompleteObservable:new a,abort:()=>n.abort()};return n.onloadend=()=>o.onCompleteObservable.notifyObservers(o),r&&(n.onerror=()=>{r(new It(`Unable to read ${e.name}`,e))}),n.onload=e=>{t(e.target.result)},i&&(n.onprogress=i),s?n.readAsArrayBuffer(e):n.readAsText(e),o},Ft=(e,t,i,s,r,n,o)=>{if(e.name)return Nt(e,t,i,r,n?e=>{n(void 0,e)}:void 0);const l=e;if(-1!==l.indexOf("file:")){let e=decodeURIComponent(l.substring(5).toLowerCase());0===e.indexOf("./")&&(e=e.substring(2));const s=we.FilesToLoad[e];if(s)return Nt(s,t,i,r,n?e=>n(void 0,new At(e.message,e.file)):void 0)}const{match:h,type:c}=Ut(l);if(h){const e={onCompleteObservable:new a,abort:()=>()=>{}};try{const e=r?Vt(l):kt(l);t(e,void 0,c)}catch(e){n?n(void 0,e):k.Error(e.message||"Failed to parse the Data URL")}return Ct.SetImmediate((()=>{e.onCompleteObservable.notifyObservers(e)})),e}return wt(l,((e,i)=>{t(e,null==i?void 0:i.responseURL,null==i?void 0:i.getResponseHeader("content-type"))}),i,s,r,n?e=>{n(e.request,new At(e.message,e.request))}:void 0,o)},wt=(e,t,i,s,r,n,o)=>{e=Mt(e),e=Pt.PreprocessUrl(e);const l=Pt.BaseUrl+e;let h=!1;const c={onCompleteObservable:new a,abort:()=>h=!0},u=()=>{let e,s=new Te,a=null;const u=()=>{s&&(i&&s.removeEventListener("progress",i),e&&s.removeEventListener("readystatechange",e),s.removeEventListener("loadend",d))};let d=()=>{u(),c.onCompleteObservable.notifyObservers(c),c.onCompleteObservable.clear(),i=void 0,e=null,d=null,n=void 0,o=void 0,t=void 0};c.abort=()=>{h=!0,d&&d(),s&&s.readyState!==(XMLHttpRequest.DONE||4)&&s.abort(),null!==a&&(clearTimeout(a),a=null),s=null};const p=e=>{const t=e.message||"Unknown error";n&&s?n(new Rt(t,s)):k.Error(t)},_=c=>{if(s){if(s.open("GET",l),o)try{o(s)}catch(e){return void p(e)}r&&(s.responseType="arraybuffer"),i&&s.addEventListener("progress",i),d&&s.addEventListener("loadend",d),e=()=>{if(!h&&s&&s.readyState===(XMLHttpRequest.DONE||4)){if(e&&s.removeEventListener("readystatechange",e),s.status>=200&&s.status<300||0===s.status&&(!Me()||Lt())){try{t&&t(r?s.response:s.responseText,s)}catch(e){p(e)}return}const i=Pt.DefaultRetryStrategy;if(i){const e=i(l,s,c);if(-1!==e)return u(),s=new Te,void(a=setTimeout((()=>_(c+1)),e))}const o=new Rt("Error status: "+s.status+" "+s.statusText+" - Unable to load "+l,s);n&&n(o)}},s.addEventListener("readystatechange",e),s.send()}};_(0)};if(s&&s.enableSceneOffline){const o=e=>{e&&e.status>400?n&&n(e):u()},a=()=>{s&&s.loadFile(Pt.BaseUrl+e,(e=>{!h&&t&&t(e),c.onCompleteObservable.notifyObservers(c)}),i?e=>{!h&&i&&i(e)}:void 0,o,r)};s.open(a,o)}else u();return c},Lt=()=>"undefined"!=typeof location&&"file:"===location.protocol,Bt=e=>yt.test(e),Ut=e=>{const t=yt.exec(e);return null===t||0===t.length?{match:!1,type:""}:{match:!0,type:t[0].replace("data:","").replace("base64,","")}};function Vt(e){return(e=>{const t=ke(e),i=t.length,s=new Uint8Array(new ArrayBuffer(i));for(let e=0;e<i;e++)s[e]=t.charCodeAt(e);return s.buffer})(e.split(",")[1])}const kt=e=>ke(e.split(",")[1]);let Gt;bt._FileToolsLoadImage=Dt,bt._FileToolsLoadFile=Ft,rt._FileToolsLoadFile=Ft,((e,t,i,s,r,n,o,a,l,h)=>{Gt={DecodeBase64UrlToBinary:e,DecodeBase64UrlToString:t,DefaultRetryStrategy:i.DefaultRetryStrategy,BaseUrl:i.BaseUrl,CorsBehavior:i.CorsBehavior,PreprocessUrl:i.PreprocessUrl,IsBase64DataUrl:s,IsFileURL:r,LoadFile:n,LoadImage:o,ReadFile:a,RequestFile:l,SetCorsBehavior:h},Object.defineProperty(Gt,"DefaultRetryStrategy",{get:function(){return i.DefaultRetryStrategy},set:function(e){i.DefaultRetryStrategy=e}}),Object.defineProperty(Gt,"BaseUrl",{get:function(){return i.BaseUrl},set:function(e){i.BaseUrl=e}}),Object.defineProperty(Gt,"PreprocessUrl",{get:function(){return i.PreprocessUrl},set:function(e){i.PreprocessUrl=e}}),Object.defineProperty(Gt,"CorsBehavior",{get:function(){return i.CorsBehavior},set:function(e){i.CorsBehavior=e}})})(Vt,kt,Pt,Bt,Lt,Ft,Dt,Nt,wt,Ot);class zt{static Instantiate(e){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[e])return this.RegisteredExternalClasses[e];const t=g(e);if(t)return t;k.Warn(e+" not found, you may have missed an import.");const i=e.split(".");let s=window||this;for(let e=0,t=i.length;e<t;e++)s=s[i[e]];return"function"!=typeof s?null:s}}function Wt(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}zt.RegisteredExternalClasses={};class Ht{static get BaseUrl(){return Pt.BaseUrl}static set BaseUrl(e){Pt.BaseUrl=e}static IsAbsoluteUrl(e){return 0===e.indexOf("//")||-1!==e.indexOf("://")&&-1!==e.indexOf(".")&&-1!==e.indexOf("/")&&!(e.indexOf(":")>e.indexOf("/"))&&(e.indexOf("://")<e.indexOf(".")||0===e.indexOf("data:")||0===e.indexOf("blob:"))}static set ScriptBaseUrl(e){Pt.ScriptBaseUrl=e}static get ScriptBaseUrl(){return Pt.ScriptBaseUrl}static set ScriptPreprocessUrl(e){Pt.ScriptPreprocessUrl=e}static get ScriptPreprocessUrl(){return Pt.ScriptPreprocessUrl}static get DefaultRetryStrategy(){return Pt.DefaultRetryStrategy}static set DefaultRetryStrategy(e){Pt.DefaultRetryStrategy=e}static get CorsBehavior(){return Pt.CorsBehavior}static set CorsBehavior(e){Pt.CorsBehavior=e}static get UseFallbackTexture(){return x.UseFallbackTexture}static set UseFallbackTexture(e){x.UseFallbackTexture=e}static get RegisteredExternalClasses(){return zt.RegisteredExternalClasses}static set RegisteredExternalClasses(e){zt.RegisteredExternalClasses=e}static get fallbackTexture(){return x.FallbackTexture}static set fallbackTexture(e){x.FallbackTexture=e}static FetchToRef(e,t,i,s,r,n){const o=4*((Math.abs(e)*i%i|0)+(Math.abs(t)*s%s|0)*i);n.r=r[o]/255,n.g=r[o+1]/255,n.b=r[o+2]/255,n.a=r[o+3]/255}static Mix(e,t,i){return e*(1-i)+t*i}static Instantiate(e){return zt.Instantiate(e)}static SetImmediate(e){Ct.SetImmediate(e)}static IsExponentOfTwo(e){let t=1;do{t*=2}while(t<e);return t===e}static FloatRound(e){return Math.fround(e)}static GetFilename(e){const t=e.lastIndexOf("/");return t<0?e:e.substring(t+1)}static GetFolderPath(e,t=!1){const i=e.lastIndexOf("/");return i<0?t?e:"":e.substring(0,i+1)}static ToDegrees(e){return 180*e/Math.PI}static ToRadians(e){return e*Math.PI/180}static SmoothAngleChange(e,t,i=.9){const s=this.ToRadians(e),r=this.ToRadians(t);return this.ToDegrees(Math.atan2((1-i)*Math.sin(r)+i*Math.sin(s),(1-i)*Math.cos(r)+i*Math.cos(s)))}static MakeArray(e,t){return!0===t||void 0!==e&&null!=e?Array.isArray(e)?e:[e]:null}static GetPointerPrefix(e){let t="pointer";return Me()&&!window.PointerEvent&&(t="mouse"),!e._badDesktopOS||e._badOS||document&&"ontouchend"in document||(t="mouse"),t}static SetCorsBehavior(e,t){Ot(e,t)}static SetReferrerPolicyBehavior(e,t){t.referrerPolicy=e}static CleanUrl(e){return e.replace(/#/gm,"%23")}static get PreprocessUrl(){return Pt.PreprocessUrl}static set PreprocessUrl(e){Pt.PreprocessUrl=e}static LoadImage(e,t,i,s,r,n){return Dt(e,t,i,s,r,n)}static LoadFile(e,t,i,s,r,n){return Ft(e,t,i,s,r,n)}static LoadFileAsync(e,t=!0){return new Promise(((i,s)=>{Ft(e,(e=>{i(e)}),void 0,void 0,t,((e,t)=>{s(t)}))}))}static GetBabylonScriptURL(e,t){if(!e)return"";if(Ht.ScriptBaseUrl&&e.startsWith(Ht._DefaultCdnUrl)){const t="/"===Ht.ScriptBaseUrl[Ht.ScriptBaseUrl.length-1]?Ht.ScriptBaseUrl.substring(0,Ht.ScriptBaseUrl.length-1):Ht.ScriptBaseUrl;e=e.replace(Ht._DefaultCdnUrl,t)}return e=Ht.ScriptPreprocessUrl(e),t&&(e=Ht.GetAbsoluteUrl(e)),e}static LoadBabylonScript(e,t,i,s){e=Ht.GetBabylonScriptURL(e),Ht.LoadScript(e,t,i)}static LoadBabylonScriptAsync(e){return e=Ht.GetBabylonScriptURL(e),Ht.LoadScriptAsync(e)}static LoadScript(e,t,i,s){if("function"==typeof importScripts){try{importScripts(e),t()}catch(t){null==i||i(`Unable to load script '${e}' in worker`,t)}return}if(!Me())return void(null==i||i(`Cannot load script '${e}' outside of a window or a worker`));const r=document.getElementsByTagName("head")[0],n=document.createElement("script");n.setAttribute("type","text/javascript"),n.setAttribute("src",e),s&&(n.id=s),n.onload=()=>{t&&t()},n.onerror=t=>{i&&i(`Unable to load script '${e}'`,t)},r.appendChild(n)}static LoadScriptAsync(e){return new Promise(((t,i)=>{this.LoadScript(e,(()=>{t()}),((e,t)=>{i(t||new Error(e))}))}))}static ReadFileAsDataURL(e,t,i){const s=new FileReader,r={onCompleteObservable:new a,abort:()=>s.abort()};return s.onloadend=()=>{r.onCompleteObservable.notifyObservers(r)},s.onload=e=>{t(e.target.result)},s.onprogress=i,s.readAsDataURL(e),r}static ReadFile(e,t,i,s,r){return Nt(e,t,i,s,r)}static FileAsURL(e){const t=new Blob([e]);return window.URL.createObjectURL(t)}static Format(e,t=2){return e.toFixed(t)}static DeepCopy(e,t,i,s){H.DeepCopy(e,t,i,s)}static IsEmpty(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}static RegisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const s=t[i];e.addEventListener(s.name,s.handler,!1);try{window.parent&&window.parent.addEventListener(s.name,s.handler,!1)}catch(e){}}}static UnregisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const s=t[i];e.removeEventListener(s.name,s.handler);try{e.parent&&e.parent.removeEventListener(s.name,s.handler)}catch(e){}}}static async DumpFramebuffer(e,t,i,s,r="image/png",n,o){throw $("DumpTools")}static DumpData(e,t,i,s,r="image/png",n,o=!1,a=!1,l){throw $("DumpTools")}static DumpDataAsync(e,t,i,s="image/png",r,n=!1,o=!1,a){throw $("DumpTools")}static _IsOffScreenCanvas(e){return void 0!==e.convertToBlob}static ToBlob(e,t,i="image/png",s){Ht._IsOffScreenCanvas(e)||e.toBlob||(e.toBlob=function(e,t,i){setTimeout((()=>{const s=atob(this.toDataURL(t,i).split(",")[1]),r=s.length,n=new Uint8Array(r);for(let e=0;e<r;e++)n[e]=s.charCodeAt(e);e(new Blob([n]))}))}),Ht._IsOffScreenCanvas(e)?e.convertToBlob({type:i,quality:s}).then((e=>t(e))):e.toBlob((function(e){t(e)}),i,s)}static DownloadBlob(e,t){if("download"in document.createElement("a")){if(!t){const e=new Date;t="screenshot_"+(e.getFullYear()+"-"+(e.getMonth()+1)).slice(2)+"-"+e.getDate()+"_"+e.getHours()+"-"+("0"+e.getMinutes()).slice(-2)+".png"}Ht.Download(e,t)}else if(e&&"undefined"!=typeof URL){const t=URL.createObjectURL(e),i=window.open("");if(!i)return;const s=i.document.createElement("img");s.onload=function(){URL.revokeObjectURL(t)},s.src=t,i.document.body.appendChild(s)}}static EncodeScreenshotCanvasData(e,t,i="image/png",s,r){if("string"!=typeof s&&t){if(t){if(Ht._IsOffScreenCanvas(e))return void e.convertToBlob({type:i,quality:r}).then((e=>{const i=new FileReader;i.readAsDataURL(e),i.onloadend=()=>{const e=i.result;t(e)}}));const s=e.toDataURL(i,r);t(s)}}else this.ToBlob(e,(function(e){e&&Ht.DownloadBlob(e,s),t&&t("")}),i,r)}static Download(e,t){if("undefined"==typeof URL)return;const i=window.URL.createObjectURL(e),s=document.createElement("a");document.body.appendChild(s),s.style.display="none",s.href=i,s.download=t,s.addEventListener("click",(()=>{s.parentElement&&s.parentElement.removeChild(s)})),s.click(),window.URL.revokeObjectURL(i)}static BackCompatCameraNoPreventDefault(e){return"boolean"==typeof e[0]?e[0]:"boolean"==typeof e[1]&&e[1]}static CreateScreenshot(e,t,i,s,r="image/png",n=!1,o){throw $("ScreenshotTools")}static CreateScreenshotAsync(e,t,i,s="image/png",r){throw $("ScreenshotTools")}static CreateScreenshotUsingRenderTarget(e,t,i,s,r="image/png",n=1,o=!1,a,l=!1,h=!1,c=!0,u){throw $("ScreenshotTools")}static CreateScreenshotUsingRenderTargetAsync(e,t,i,s="image/png",r=1,n=!1,o,a=!1,l=!1,h=!0,c){throw $("ScreenshotTools")}static RandomId(){return Wt()}static IsBase64(e){return Bt(e)}static DecodeBase64(e){return Vt(e)}static get errorsCount(){return k.errorsCount}static Log(e){k.Log(e)}static Warn(e){k.Warn(e)}static Error(e){k.Error(e)}static get LogCache(){return k.LogCache}static ClearLogCache(){k.ClearLogCache()}static set LogLevels(e){k.LogLevels=e}static set PerformanceLogLevel(e){return(e&Ht.PerformanceUserMarkLogLevel)===Ht.PerformanceUserMarkLogLevel?(Ht.StartPerformanceCounter=Ht._StartUserMark,void(Ht.EndPerformanceCounter=Ht._EndUserMark)):(e&Ht.PerformanceConsoleLogLevel)===Ht.PerformanceConsoleLogLevel?(Ht.StartPerformanceCounter=Ht._StartPerformanceConsole,void(Ht.EndPerformanceCounter=Ht._EndPerformanceConsole)):(Ht.StartPerformanceCounter=Ht._StartPerformanceCounterDisabled,void(Ht.EndPerformanceCounter=Ht._EndPerformanceCounterDisabled))}static _StartPerformanceCounterDisabled(e,t){}static _EndPerformanceCounterDisabled(e,t){}static _StartUserMark(e,t=!0){if(!Ht._Performance){if(!Me())return;Ht._Performance=window.performance}t&&Ht._Performance.mark&&Ht._Performance.mark(e+"-Begin")}static _EndUserMark(e,t=!0){t&&Ht._Performance.mark&&(Ht._Performance.mark(e+"-End"),Ht._Performance.measure(e,e+"-Begin",e+"-End"))}static _StartPerformanceConsole(e,t=!0){t&&(Ht._StartUserMark(e,t),console.time&&console.time(e))}static _EndPerformanceConsole(e,t=!0){t&&(Ht._EndUserMark(e,t),console.timeEnd(e))}static get Now(){return Fe.Now}static GetClassName(e,t=!1){let i=null;return!t&&e.getClassName?i=e.getClassName():(e instanceof Object&&(i=(t?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__),i||(i=typeof e)),i}static First(e,t){for(const i of e)if(t(i))return i;return null}static getFullClassName(e,t=!1){let i=null,s=null;if(!t&&e.getClassName)i=e.getClassName();else{if(e instanceof Object){const r=t?e:Object.getPrototypeOf(e);i=r.constructor.__bjsclassName__,s=r.constructor.__bjsmoduleName__}i||(i=typeof e)}return i?(null!=s?s+".":"")+i:null}static DelayAsync(e){return new Promise((t=>{setTimeout((()=>{t()}),e)}))}static IsSafari(){return!!Oe()&&/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}}Ht.UseCustomRequestHeaders=!1,Ht.CustomRequestHeaders=Te.CustomRequestHeaders,Ht.GetDOMTextContent=Ne,Ht._DefaultCdnUrl="https://cdn.babylonjs.com",Ht.GetAbsoluteUrl="object"==typeof document?e=>{const t=document.createElement("a");return t.href=e,t.href}:"function"==typeof URL&&"object"==typeof location?e=>new URL(e,location.origin).href:()=>{throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")},Ht.NoneLogLevel=k.NoneLogLevel,Ht.MessageLogLevel=k.MessageLogLevel,Ht.WarningLogLevel=k.WarningLogLevel,Ht.ErrorLogLevel=k.ErrorLogLevel,Ht.AllLogLevel=k.AllLogLevel,Ht.IsWindowObjectExist=Me,Ht.PerformanceNoneLogLevel=0,Ht.PerformanceUserMarkLogLevel=1,Ht.PerformanceConsoleLogLevel=2,Ht.StartPerformanceCounter=Ht._StartPerformanceCounterDisabled,Ht.EndPerformanceCounter=Ht._EndPerformanceCounterDisabled;class Xt{constructor(e,t,i,s=0){this.iterations=e,this.index=s-1,this._done=!1,this._fn=t,this._successCallback=i}executeNext(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())}breakLoop(){this._done=!0,this._successCallback()}static Run(e,t,i,s=0){const r=new Xt(e,t,i,s);return r.executeNext(),r}static SyncAsyncForLoop(e,t,i,s,r,n=0){return Xt.Run(Math.ceil(e/t),(s=>{r&&r()?s.breakLoop():setTimeout((()=>{for(let n=0;n<t;++n){const o=s.index*t+n;if(o>=e)break;if(i(o),r&&r()){s.breakLoop();break}}s.executeNext()}),n)}),s)}}x.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z";class Yt{constructor(e){this.length=0,this.data=new Array(e),this._id=Yt._GlobalId++}push(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)}forEach(e){for(let t=0;t<this.length;t++)e(this.data[t])}sort(e){this.data.sort(e)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(let t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}}indexOf(e){const t=this.data.indexOf(e);return t>=this.length?-1:t}contains(e){return-1!==this.indexOf(e)}}Yt._GlobalId=0;class jt extends Yt{constructor(){super(...arguments),this._duplicateId=0}push(e){super.push(e),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(e){return!(e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId||(this.push(e),0))}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(let t=0;t<e.length;t++){const i=(e.data||e)[t];this.pushNoDuplicate(i)}}}}class Kt{constructor(){this._count=0,this._data={}}copyFrom(e){this.clear(),e.forEach(((e,t)=>this.add(e,t)))}get(e){const t=this._data[e];if(void 0!==t)return t}getOrAddWithFactory(e,t){let i=this.get(e);return void 0!==i||(i=t(e),i&&this.add(e,i)),i}getOrAdd(e,t){const i=this.get(e);return void 0!==i?i:(this.add(e,t),t)}contains(e){return void 0!==this._data[e]}add(e,t){return void 0===this._data[e]&&(this._data[e]=t,++this._count,!0)}set(e,t){return void 0!==this._data[e]&&(this._data[e]=t,!0)}getAndRemove(e){const t=this.get(e);return void 0!==t?(delete this._data[e],--this._count,t):null}remove(e){return!!this.contains(e)&&(delete this._data[e],--this._count,!0)}clear(){this._data={},this._count=0}get count(){return this._count}forEach(e){for(const t in this._data)e(t,this._data[t])}first(e){for(const t in this._data){const i=e(t,this._data[t]);if(i)return i}return null}}class $t{constructor(e){if(this._keys=[],this._isDirty=!0,this._areLightsDirty=!0,this._areLightsDisposed=!1,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1,this._externalProperties=e,e)for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&this._setDefaultValue(t)}get isDirty(){return this._isDirty}markAsProcessed(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areLightsDisposed=!1,this._areMiscDirty=!1,this._arePrePassDirty=!1,this._areImageProcessingDirty=!1}markAsUnprocessed(){this._isDirty=!0}markAllAsDirty(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!1,this._areImageProcessingDirty=!0,this._isDirty=!0}markAsImageProcessingDirty(){this._areImageProcessingDirty=!0,this._isDirty=!0}markAsLightDirty(e=!1){this._areLightsDirty=!0,this._areLightsDisposed=this._areLightsDisposed||e,this._isDirty=!0}markAsAttributesDirty(){this._areAttributesDirty=!0,this._isDirty=!0}markAsTexturesDirty(){this._areTexturesDirty=!0,this._isDirty=!0}markAsFresnelDirty(){this._areFresnelDirty=!0,this._isDirty=!0}markAsMiscDirty(){this._areMiscDirty=!0,this._isDirty=!0}markAsPrePassDirty(){this._arePrePassDirty=!0,this._isDirty=!0}rebuild(){this._keys.length=0;for(const e of Object.keys(this))"_"!==e[0]&&this._keys.push(e);if(this._externalProperties)for(const e in this._externalProperties)-1===this._keys.indexOf(e)&&this._keys.push(e)}isEqual(e){if(this._keys.length!==e._keys.length)return!1;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];if(this[i]!==e[i])return!1}return!0}cloneTo(e){this._keys.length!==e._keys.length&&(e._keys=this._keys.slice(0));for(let t=0;t<this._keys.length;t++){const i=this._keys[t];e[i]=this[i]}}reset(){this._keys.forEach((e=>this._setDefaultValue(e)))}_setDefaultValue(e){var t,i,s,r,n;const o=null!==(s=null===(i=null===(t=this._externalProperties)||void 0===t?void 0:t[e])||void 0===i?void 0:i.type)&&void 0!==s?s:typeof this[e],a=null===(n=null===(r=this._externalProperties)||void 0===r?void 0:r[e])||void 0===n?void 0:n.default;switch(o){case"number":this[e]=null!=a?a:0;break;case"string":this[e]=null!=a?a:"";break;default:this[e]=null!=a&&a}}toString(){let e="";for(let t=0;t<this._keys.length;t++){const i=this._keys[t],s=this[i];switch(typeof s){case"number":case"string":e+="#define "+i+" "+s+"\n";break;default:s&&(e+="#define "+i+"\n")}}return e}}class qt{constructor(){this._dirty=!0,this._tempColor=new F(0,0,0,0),this._globalCurve=new F(0,0,0,0),this._highlightsCurve=new F(0,0,0,0),this._midtonesCurve=new F(0,0,0,0),this._shadowsCurve=new F(0,0,0,0),this._positiveCurve=new F(0,0,0,0),this._negativeCurve=new F(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}get globalHue(){return this._globalHue}set globalHue(e){this._globalHue=e,this._dirty=!0}get globalDensity(){return this._globalDensity}set globalDensity(e){this._globalDensity=e,this._dirty=!0}get globalSaturation(){return this._globalSaturation}set globalSaturation(e){this._globalSaturation=e,this._dirty=!0}get globalExposure(){return this._globalExposure}set globalExposure(e){this._globalExposure=e,this._dirty=!0}get highlightsHue(){return this._highlightsHue}set highlightsHue(e){this._highlightsHue=e,this._dirty=!0}get highlightsDensity(){return this._highlightsDensity}set highlightsDensity(e){this._highlightsDensity=e,this._dirty=!0}get highlightsSaturation(){return this._highlightsSaturation}set highlightsSaturation(e){this._highlightsSaturation=e,this._dirty=!0}get highlightsExposure(){return this._highlightsExposure}set highlightsExposure(e){this._highlightsExposure=e,this._dirty=!0}get midtonesHue(){return this._midtonesHue}set midtonesHue(e){this._midtonesHue=e,this._dirty=!0}get midtonesDensity(){return this._midtonesDensity}set midtonesDensity(e){this._midtonesDensity=e,this._dirty=!0}get midtonesSaturation(){return this._midtonesSaturation}set midtonesSaturation(e){this._midtonesSaturation=e,this._dirty=!0}get midtonesExposure(){return this._midtonesExposure}set midtonesExposure(e){this._midtonesExposure=e,this._dirty=!0}get shadowsHue(){return this._shadowsHue}set shadowsHue(e){this._shadowsHue=e,this._dirty=!0}get shadowsDensity(){return this._shadowsDensity}set shadowsDensity(e){this._shadowsDensity=e,this._dirty=!0}get shadowsSaturation(){return this._shadowsSaturation}set shadowsSaturation(e){this._shadowsSaturation=e,this._dirty=!0}get shadowsExposure(){return this._shadowsExposure}set shadowsExposure(e){this._shadowsExposure=e,this._dirty=!0}getClassName(){return"ColorCurves"}static Bind(e,t,i="vCameraColorCurvePositive",s="vCameraColorCurveNeutral",r="vCameraColorCurveNegative"){e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(i,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(s,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(r,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))}static PrepareUniforms(e){e.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")}_getColorGradingDataToRef(e,t,i,s,r){null!=e&&(e=qt._Clamp(e,0,360),t=qt._Clamp(t,-100,100),i=qt._Clamp(i,-100,100),s=qt._Clamp(s,-100,100),t=qt._ApplyColorGradingSliderNonlinear(t),t*=.5,s=qt._ApplyColorGradingSliderNonlinear(s),t<0&&(t*=-1,e=(e+180)%360),qt._FromHSBToRef(e,t,50+.25*s,r),r.scaleToRef(2,r),r.a=1+.01*i)}static _ApplyColorGradingSliderNonlinear(e){e/=100;let t=Math.abs(e);return t=Math.pow(t,2),e<0&&(t*=-1),t*=100,t}static _FromHSBToRef(e,t,i,s){let r=qt._Clamp(e,0,360);const n=qt._Clamp(t/100,0,1),o=qt._Clamp(i/100,0,1);if(0===n)s.r=o,s.g=o,s.b=o;else{r/=60;const e=Math.floor(r),t=r-e,i=o*(1-n),a=o*(1-n*t),l=o*(1-n*(1-t));switch(e){case 0:s.r=o,s.g=l,s.b=i;break;case 1:s.r=a,s.g=o,s.b=i;break;case 2:s.r=i,s.g=o,s.b=l;break;case 3:s.r=i,s.g=a,s.b=o;break;case 4:s.r=l,s.g=i,s.b=o;break;default:s.r=o,s.g=i,s.b=a}}s.a=1}static _Clamp(e,t,i){return Math.min(Math.max(e,t),i)}clone(){return de.Clone((()=>new qt),this)}serialize(){return de.Serialize(this)}static Parse(e){return de.Parse((()=>new qt),e,null,null)}}me([ie()],qt.prototype,"_globalHue",void 0),me([ie()],qt.prototype,"_globalDensity",void 0),me([ie()],qt.prototype,"_globalSaturation",void 0),me([ie()],qt.prototype,"_globalExposure",void 0),me([ie()],qt.prototype,"_highlightsHue",void 0),me([ie()],qt.prototype,"_highlightsDensity",void 0),me([ie()],qt.prototype,"_highlightsSaturation",void 0),me([ie()],qt.prototype,"_highlightsExposure",void 0),me([ie()],qt.prototype,"_midtonesHue",void 0),me([ie()],qt.prototype,"_midtonesDensity",void 0),me([ie()],qt.prototype,"_midtonesSaturation",void 0),me([ie()],qt.prototype,"_midtonesExposure",void 0),de._ColorCurvesParser=qt.Parse;class Qt extends $t{constructor(){super(),this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.EXPOSURE=!1,this.SKIPFINALCOLORCLAMP=!1,this.rebuild()}}class Zt{constructor(){this.colorCurves=new qt,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=Zt.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new F(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=Zt.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._ditheringEnabled=!1,this._ditheringIntensity=1/255,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new a}get colorCurvesEnabled(){return this._colorCurvesEnabled}set colorCurvesEnabled(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())}get colorGradingTexture(){return this._colorGradingTexture}set colorGradingTexture(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())}get colorGradingEnabled(){return this._colorGradingEnabled}set colorGradingEnabled(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())}get colorGradingWithGreenDepth(){return this._colorGradingWithGreenDepth}set colorGradingWithGreenDepth(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())}get colorGradingBGR(){return this._colorGradingBGR}set colorGradingBGR(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())}get toneMappingEnabled(){return this._toneMappingEnabled}set toneMappingEnabled(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())}get toneMappingType(){return this._toneMappingType}set toneMappingType(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())}get contrast(){return this._contrast}set contrast(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())}get vignetteCentreY(){return this.vignetteCenterY}set vignetteCentreY(e){this.vignetteCenterY=e}get vignetteCentreX(){return this.vignetteCenterX}set vignetteCentreX(e){this.vignetteCenterX=e}get vignetteBlendMode(){return this._vignetteBlendMode}set vignetteBlendMode(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())}get vignetteEnabled(){return this._vignetteEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())}get ditheringEnabled(){return this._ditheringEnabled}set ditheringEnabled(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters())}get ditheringIntensity(){return this._ditheringIntensity}set ditheringIntensity(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters())}get skipFinalColorClamp(){return this._skipFinalColorClamp}set skipFinalColorClamp(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())}get applyByPostProcess(){return this._applyByPostProcess}set applyByPostProcess(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())}_updateParameters(){this.onUpdateParameters.notifyObservers(this)}getClassName(){return"ImageProcessingConfiguration"}static PrepareUniforms(e,t){t.EXPOSURE&&e.push("exposureLinear"),t.CONTRAST&&e.push("contrast"),t.COLORGRADING&&e.push("colorTransformSettings"),(t.VIGNETTE||t.DITHER)&&e.push("vInverseScreenSize"),t.VIGNETTE&&(e.push("vignetteSettings1"),e.push("vignetteSettings2")),t.COLORCURVES&&qt.PrepareUniforms(e),t.DITHER&&e.push("ditherIntensity")}static PrepareSamplers(e,t){t.COLORGRADING&&e.push("txColorTransform")}prepareDefines(e,t=!1){if(t!==this.applyByPostProcess||!this._isEnabled)return e.VIGNETTE=!1,e.TONEMAPPING=!1,e.TONEMAPPING_ACES=!1,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.DITHER=!1,e.IMAGEPROCESSING=!1,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,void(e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled);e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===Zt._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,e.TONEMAPPING=this.toneMappingEnabled,this._toneMappingType===Zt.TONEMAPPING_ACES?e.TONEMAPPING_ACES=!0:e.TONEMAPPING_ACES=!1,e.CONTRAST=1!==this.contrast,e.EXPOSURE=1!==this.exposure,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING?e.COLORGRADING3D=this.colorGradingTexture.is3D:e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.DITHER=this._ditheringEnabled,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING||e.DITHER}isReady(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&qt.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){const i=1/e.getEngine().getRenderWidth(),s=1/e.getEngine().getRenderHeight();if(e.setFloat2("vInverseScreenSize",i,s),this._ditheringEnabled&&e.setFloat("ditherIntensity",.5*this._ditheringIntensity),this._vignetteEnabled){const r=null!=t?t:s/i;let n=Math.tan(.5*this.vignetteCameraFov),o=n*r;const a=Math.sqrt(o*n);o=Ht.Mix(o,a,this.vignetteStretch),n=Ht.Mix(n,a,this.vignetteStretch),e.setFloat4("vignetteSettings1",o,n,-o*this.vignetteCenterX,-n*this.vignetteCenterY);const l=-2*this.vignetteWeight;e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,l)}}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);const t=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(t-1)/t,.5/t,t,this.colorGradingTexture.level)}}clone(){return de.Clone((()=>new Zt),this)}serialize(){return de.Serialize(this)}static Parse(e){const t=de.Parse((()=>new Zt),e,null,null);return void 0!==e.vignetteCentreX&&(t.vignetteCenterX=e.vignetteCentreX),void 0!==e.vignetteCentreY&&(t.vignetteCenterY=e.vignetteCentreY),t}static get VIGNETTEMODE_MULTIPLY(){return this._VIGNETTEMODE_MULTIPLY}static get VIGNETTEMODE_OPAQUE(){return this._VIGNETTEMODE_OPAQUE}}var Jt,ei,ti,ii,si,ri,ni,oi;Zt.TONEMAPPING_STANDARD=0,Zt.TONEMAPPING_ACES=1,Zt._VIGNETTEMODE_MULTIPLY=0,Zt._VIGNETTEMODE_OPAQUE=1,me([ee(7,undefined)],Zt.prototype,"colorCurves",void 0),me([ie()],Zt.prototype,"_colorCurvesEnabled",void 0),me([se("colorGradingTexture")],Zt.prototype,"_colorGradingTexture",void 0),me([ie()],Zt.prototype,"_colorGradingEnabled",void 0),me([ie()],Zt.prototype,"_colorGradingWithGreenDepth",void 0),me([ie()],Zt.prototype,"_colorGradingBGR",void 0),me([ie()],Zt.prototype,"_exposure",void 0),me([ie()],Zt.prototype,"_toneMappingEnabled",void 0),me([ie()],Zt.prototype,"_toneMappingType",void 0),me([ie()],Zt.prototype,"_contrast",void 0),me([ie()],Zt.prototype,"vignetteStretch",void 0),me([ie()],Zt.prototype,"vignetteCenterX",void 0),me([ie()],Zt.prototype,"vignetteCenterY",void 0),me([ie()],Zt.prototype,"vignetteWeight",void 0),me([he()],Zt.prototype,"vignetteColor",void 0),me([ie()],Zt.prototype,"vignetteCameraFov",void 0),me([ie()],Zt.prototype,"_vignetteBlendMode",void 0),me([ie()],Zt.prototype,"_vignetteEnabled",void 0),me([ie()],Zt.prototype,"_ditheringEnabled",void 0),me([ie()],Zt.prototype,"_ditheringIntensity",void 0),me([ie()],Zt.prototype,"_skipFinalColorClamp",void 0),me([ie()],Zt.prototype,"_applyByPostProcess",void 0),me([ie()],Zt.prototype,"_isEnabled",void 0),de._ImageProcessingConfigurationParser=Zt.Parse,bt.prototype.createUniformBuffer=function(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create uniform buffer");const s=new gt(i);return this.bindUniformBuffer(s),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),s.references=1,s},bt.prototype.createDynamicUniformBuffer=function(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create dynamic uniform buffer");const s=new gt(i);return this.bindUniformBuffer(s),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),s.references=1,s},bt.prototype.updateUniformBuffer=function(e,t,i,s){this.bindUniformBuffer(e),void 0===i&&(i=0),void 0===s?t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,i,t):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,i,new Float32Array(t)):t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,t.subarray(i,i+s)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(t).subarray(i,i+s)),this.bindUniformBuffer(null)},bt.prototype.bindUniformBuffer=function(e){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,e?e.underlyingResource:null)},bt.prototype.bindUniformBufferBase=function(e,t,i){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,t,e?e.underlyingResource:null)},bt.prototype.bindUniformBlock=function(e,t,i){const s=e.program,r=this._gl.getUniformBlockIndex(s,t);4294967295!==r&&this._gl.uniformBlockBinding(s,r,i)};class ai{constructor(e,t,i,s,r=!1){this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||r,this._dynamic=i,this._name=null!=s?s:"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return void 0!==this._dynamic}getData(){return this._bufferData}getBuffer(){return this._buffer}_fillAlignment(e){let t;if(t=e<=2?e:4,this._uniformLocationPointer%t!=0){const e=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;const i=this._uniformLocationPointer-e;for(let e=0;e<i;e++)this._data.push(0)}}addUniform(e,t,i=0){if(this._noUBO)return;if(void 0!==this._uniformLocations[e])return;let s;if(i>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;this._fillAlignment(4),this._uniformArraySizes[e]={strideSize:t,arraySize:i},16==t?t*=i:t=t*i+(4-t)*i,s=[];for(let e=0;e<t;e++)s.push(0)}else{if(t instanceof Array)s=t,t=s.length;else{s=[];for(let e=0;e<t;e++)s.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(let e=0;e<t;e++)this._data.push(s[e]);this._needSync=!0}addMatrix(e,t){this.addUniform(e,Array.prototype.slice.call(t.toArray()))}addFloat2(e,t,i){const s=[t,i];this.addUniform(e,s)}addFloat3(e,t,i,s){const r=[t,i,s];this.addUniform(e,r)}addColor3(e,t){const i=[t.r,t.g,t.b];this.addUniform(e,i)}addColor4(e,t,i){const s=[t.r,t.g,t.b,i];this.addUniform(e,s)}addVector3(e,t){const i=[t.x,t.y,t.z];this.addUniform(e,i)}addMatrix3x3(e){this.addUniform(e,12)}addMatrix2x2(e){this.addUniform(e,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_getNames(){const e=[];for(const t in this._uniformLocations)e.push(t);return e.join(",")}_rebuild(){!this._noUBO&&this._bufferData&&(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNames()):this._buffer=this._engine.createUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNames()),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}get currentEffect(){return this._currentEffect}_buffersEqual(e,t){for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}_copyBuffer(e,t){for(let i=0;i<e.length;++i)t[i]=e[i]}update(){if(!this._noUBO)if(this.bindUniformBuffer(),this._buffer)if(this._dynamic||this._needSync){if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1]){if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1]))return this._needSync=!1,void(this._createBufferOnWrite=this._engine._features.trackUbosInFrame);this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1])}this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(ai._UpdatedUbosInFrame[this._name]||(ai._UpdatedUbosInFrame[this._name]=0),ai._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}else this._createBufferOnWrite=this._engine._features.trackUbosInFrame;else this.create()}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=0!==this._bufferIndex,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(e,t,i){this._checkNewFrame();let s=this._uniformLocations[e];if(void 0===s){if(this._buffer)return void k.Error("Cannot add an uniform after UBO has been created.");this.addUniform(e,i),s=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(let e=0;e<i;e++)this._bufferData[s+e]=t[e];else{let e=!1;for(let r=0;r<i;r++)(16===i&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[s+r]!==Math.fround(t[r]))&&(e=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[s+r]=t[r]);this._needSync=this._needSync||e}}updateUniformArray(e,t,i){this._checkNewFrame();const s=this._uniformLocations[e];if(void 0===s)return void k.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");this._buffer||this.create();const r=this._uniformArraySizes[e];if(this._dynamic)for(let e=0;e<i;e++)this._bufferData[s+e]=t[e];else{let e=!1,n=0,o=0;for(let a=0;a<i;a++)if(this._bufferData[s+4*o+n]!==Ht.FloatRound(t[a])&&(e=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[s+4*o+n]=t[a]),n++,n===r.strideSize){for(;n<4;n++)this._bufferData[s+4*o+n]=0;n=0,o++}this._needSync=this._needSync||e}}_cacheMatrix(e,t){this._checkNewFrame();const i=this._valueCache[e],s=t.updateFlag;return(void 0===i||i!==s)&&(this._valueCache[e]=s,!0)}_updateMatrix3x3ForUniform(e,t){for(let e=0;e<3;e++)ai._TempBuffer[4*e]=t[3*e],ai._TempBuffer[4*e+1]=t[3*e+1],ai._TempBuffer[4*e+2]=t[3*e+2],ai._TempBuffer[4*e+3]=0;this.updateUniform(e,ai._TempBuffer,12)}_updateMatrix3x3ForEffect(e,t){this._currentEffect.setMatrix3x3(e,t)}_updateMatrix2x2ForEffect(e,t){this._currentEffect.setMatrix2x2(e,t)}_updateMatrix2x2ForUniform(e,t){for(let e=0;e<2;e++)ai._TempBuffer[4*e]=t[2*e],ai._TempBuffer[4*e+1]=t[2*e+1],ai._TempBuffer[4*e+2]=0,ai._TempBuffer[4*e+3]=0;this.updateUniform(e,ai._TempBuffer,8)}_updateFloatForEffect(e,t){this._currentEffect.setFloat(e,t)}_updateFloatForUniform(e,t){ai._TempBuffer[0]=t,this.updateUniform(e,ai._TempBuffer,1)}_updateFloat2ForEffect(e,t,i,s=""){this._currentEffect.setFloat2(e+s,t,i)}_updateFloat2ForUniform(e,t,i){ai._TempBuffer[0]=t,ai._TempBuffer[1]=i,this.updateUniform(e,ai._TempBuffer,2)}_updateFloat3ForEffect(e,t,i,s,r=""){this._currentEffect.setFloat3(e+r,t,i,s)}_updateFloat3ForUniform(e,t,i,s){ai._TempBuffer[0]=t,ai._TempBuffer[1]=i,ai._TempBuffer[2]=s,this.updateUniform(e,ai._TempBuffer,3)}_updateFloat4ForEffect(e,t,i,s,r,n=""){this._currentEffect.setFloat4(e+n,t,i,s,r)}_updateFloat4ForUniform(e,t,i,s,r){ai._TempBuffer[0]=t,ai._TempBuffer[1]=i,ai._TempBuffer[2]=s,ai._TempBuffer[3]=r,this.updateUniform(e,ai._TempBuffer,4)}_updateFloatArrayForEffect(e,t){this._currentEffect.setFloatArray(e,t)}_updateFloatArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateArrayForEffect(e,t){this._currentEffect.setArray(e,t)}_updateArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateIntArrayForEffect(e,t){this._currentEffect.setIntArray(e,t)}_updateIntArrayForUniform(e,t){ai._TempBufferInt32View.set(t),this.updateUniformArray(e,ai._TempBuffer,t.length)}_updateUIntArrayForEffect(e,t){this._currentEffect.setUIntArray(e,t)}_updateUIntArrayForUniform(e,t){ai._TempBufferUInt32View.set(t),this.updateUniformArray(e,ai._TempBuffer,t.length)}_updateMatrixForEffect(e,t){this._currentEffect.setMatrix(e,t)}_updateMatrixForUniform(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.toArray(),16)}_updateMatricesForEffect(e,t){this._currentEffect.setMatrices(e,t)}_updateMatricesForUniform(e,t){this.updateUniform(e,t,t.length)}_updateVector3ForEffect(e,t){this._currentEffect.setVector3(e,t)}_updateVector3ForUniform(e,t){ai._TempBuffer[0]=t.x,ai._TempBuffer[1]=t.y,ai._TempBuffer[2]=t.z,this.updateUniform(e,ai._TempBuffer,3)}_updateVector4ForEffect(e,t){this._currentEffect.setVector4(e,t)}_updateVector4ForUniform(e,t){ai._TempBuffer[0]=t.x,ai._TempBuffer[1]=t.y,ai._TempBuffer[2]=t.z,ai._TempBuffer[3]=t.w,this.updateUniform(e,ai._TempBuffer,4)}_updateColor3ForEffect(e,t,i=""){this._currentEffect.setColor3(e+i,t)}_updateColor3ForUniform(e,t){ai._TempBuffer[0]=t.r,ai._TempBuffer[1]=t.g,ai._TempBuffer[2]=t.b,this.updateUniform(e,ai._TempBuffer,3)}_updateColor4ForEffect(e,t,i,s=""){this._currentEffect.setColor4(e+s,t,i)}_updateDirectColor4ForEffect(e,t,i=""){this._currentEffect.setDirectColor4(e+i,t)}_updateColor4ForUniform(e,t,i){ai._TempBuffer[0]=t.r,ai._TempBuffer[1]=t.g,ai._TempBuffer[2]=t.b,ai._TempBuffer[3]=i,this.updateUniform(e,ai._TempBuffer,4)}_updateDirectColor4ForUniform(e,t){ai._TempBuffer[0]=t.r,ai._TempBuffer[1]=t.g,ai._TempBuffer[2]=t.b,ai._TempBuffer[3]=t.a,this.updateUniform(e,ai._TempBuffer,4)}_updateIntForEffect(e,t,i=""){this._currentEffect.setInt(e+i,t)}_updateIntForUniform(e,t){ai._TempBufferInt32View[0]=t,this.updateUniform(e,ai._TempBuffer,1)}_updateInt2ForEffect(e,t,i,s=""){this._currentEffect.setInt2(e+s,t,i)}_updateInt2ForUniform(e,t,i){ai._TempBufferInt32View[0]=t,ai._TempBufferInt32View[1]=i,this.updateUniform(e,ai._TempBuffer,2)}_updateInt3ForEffect(e,t,i,s,r=""){this._currentEffect.setInt3(e+r,t,i,s)}_updateInt3ForUniform(e,t,i,s){ai._TempBufferInt32View[0]=t,ai._TempBufferInt32View[1]=i,ai._TempBufferInt32View[2]=s,this.updateUniform(e,ai._TempBuffer,3)}_updateInt4ForEffect(e,t,i,s,r,n=""){this._currentEffect.setInt4(e+n,t,i,s,r)}_updateInt4ForUniform(e,t,i,s,r){ai._TempBufferInt32View[0]=t,ai._TempBufferInt32View[1]=i,ai._TempBufferInt32View[2]=s,ai._TempBufferInt32View[3]=r,this.updateUniform(e,ai._TempBuffer,4)}_updateUIntForEffect(e,t,i=""){this._currentEffect.setUInt(e+i,t)}_updateUIntForUniform(e,t){ai._TempBufferUInt32View[0]=t,this.updateUniform(e,ai._TempBuffer,1)}_updateUInt2ForEffect(e,t,i,s=""){this._currentEffect.setUInt2(e+s,t,i)}_updateUInt2ForUniform(e,t,i){ai._TempBufferUInt32View[0]=t,ai._TempBufferUInt32View[1]=i,this.updateUniform(e,ai._TempBuffer,2)}_updateUInt3ForEffect(e,t,i,s,r=""){this._currentEffect.setUInt3(e+r,t,i,s)}_updateUInt3ForUniform(e,t,i,s){ai._TempBufferUInt32View[0]=t,ai._TempBufferUInt32View[1]=i,ai._TempBufferUInt32View[2]=s,this.updateUniform(e,ai._TempBuffer,3)}_updateUInt4ForEffect(e,t,i,s,r,n=""){this._currentEffect.setUInt4(e+n,t,i,s,r)}_updateUInt4ForUniform(e,t,i,s,r){ai._TempBufferUInt32View[0]=t,ai._TempBufferUInt32View[1]=i,ai._TempBufferUInt32View[2]=s,ai._TempBufferUInt32View[3]=r,this.updateUniform(e,ai._TempBuffer,4)}setTexture(e,t){this._currentEffect.setTexture(e,t)}bindTexture(e,t){this._currentEffect._bindTexture(e,t)}updateUniformDirectly(e,t){this.updateUniform(e,t,t.length),this.update()}bindToEffect(e,t){this._currentEffect=e,this._currentEffectName=t}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,!0;return!1}dispose(){if(this._noUBO)return;const e=this._engine._uniformBuffers,t=e.indexOf(this);if(-1!==t&&(e[t]=e[e.length-1],e.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(let e=0;e<this._buffers.length;++e){const t=this._buffers[e][0];this._engine._releaseBuffer(t)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}}ai._UpdatedUbosInFrame={},ai._MAX_UNIFORM_SIZE=256,ai._TempBuffer=new Float32Array(ai._MAX_UNIFORM_SIZE),ai._TempBufferInt32View=new Int32Array(ai._TempBuffer.buffer),ai._TempBufferUInt32View=new Uint32Array(ai._TempBuffer.buffer);class li{get isDisposed(){return this._isDisposed}constructor(e,t,i,s=0,r=!1,n=!1,o=!1,a,l){this._isAlreadyOwned=!1,this._isDisposed=!1,e&&e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=i,this._instanced=n,this._divisor=a||1,this._label=l,t instanceof mt?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=o?s:s*Float32Array.BYTES_PER_ELEMENT,r||this.create()}createVertexBuffer(e,t,i,s,r,n=!1,o){const a=n?t:t*Float32Array.BYTES_PER_ELEMENT,l=s?n?s:s*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new hi(this._engine,this,e,this._updatable,!0,l,void 0===r?this._instanced:r,a,i,void 0,void 0,!0,this._divisor||o)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(e=null){!e&&this._buffer||(e=e||this._data)&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e,this._label),this._data=e):this._buffer=this._engine.createVertexBuffer(e,void 0,this._label))}_rebuild(){this._buffer=null,this.create(this._data)}update(e){this.create(e)}updateDirectly(e,t,i,s=!1){this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,s?t:t*Float32Array.BYTES_PER_ELEMENT,i?i*this.byteStride:void 0),this._data=0===t&&void 0===i?e:null)}_increaseReferences(){this._buffer&&(this._isAlreadyOwned?this._buffer.references++:this._isAlreadyOwned=!0)}dispose(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._isDisposed=!0,this._data=null,this._buffer=null)}}class hi{get isDisposed(){return this._isDisposed}get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(e){const t=0!=e;this._instanceDivisor=e,t!==this._instanced&&(this._instanced=t,this._computeHashCode())}get totalVertices(){const e=this.getData();return e?Array.isArray(e)?e.length/(this.byteStride/4)-this.byteOffset/4:(e.byteLength-this.byteOffset)/this.byteStride:0}constructor(e,t,i,s,r,n,o,a,l,h,c=!1,u=!1,d=1,p=!1){var _,f,m,g,v;this._isDisposed=!1;let x=!1;if(this.engine=e,"object"==typeof s&&null!==s?(x=null!==(_=s.updatable)&&void 0!==_&&_,r=s.postponeInternalCreation,n=s.stride,o=s.instanced,a=s.offset,l=s.size,h=s.type,c=null!==(f=s.normalized)&&void 0!==f&&f,u=null!==(m=s.useBytes)&&void 0!==m&&m,d=null!==(g=s.divisor)&&void 0!==g?g:1,p=null!==(v=s.takeBufferOwnership)&&void 0!==v&&v,this._label=s.label):x=!!s,t instanceof li?(this._buffer=t,this._ownsBuffer=p):(this._buffer=new li(e,t,x,n,r,o,u,d,this._label),this._ownsBuffer=!0),this.uniqueId=hi._Counter++,this._kind=i,void 0===h){const e=this.getData();this.type=e?hi.GetDataType(e):hi.FLOAT}else this.type=h;const T=hi.GetTypeByteLength(this.type);u?(this._size=l||(n?n/T:hi.DeduceStride(i)),this.byteStride=n||this._buffer.byteStride||this._size*T,this.byteOffset=a||0):(this._size=l||n||hi.DeduceStride(i),this.byteStride=n?n*T:this._buffer.byteStride||this._size*T,this.byteOffset=(a||0)*T),this.normalized=c,this._instanced=void 0!==o&&o,this._instanceDivisor=o?d:0,this._alignBuffer(),this._computeHashCode()}_computeHashCode(){this.hashCode=(this.type-5120|0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){var e;null===(e=this._buffer)||void 0===e||e._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(e,t){const i=this.getData();return i?(e=null!=e?e:this.totalVertices,hi.GetFloatData(i,this._size,this.type,this.byteOffset,this.byteStride,this.normalized,e,t)):null}getBuffer(){return this._buffer.getBuffer()}getStrideSize(){return this.byteStride/hi.GetTypeByteLength(this.type)}getOffset(){return this.byteOffset/hi.GetTypeByteLength(this.type)}getSize(e=!1){return e?this._size*hi.GetTypeByteLength(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(e){this._buffer.create(e),this._alignBuffer()}update(e){this._buffer.update(e),this._alignBuffer()}updateDirectly(e,t,i=!1){this._buffer.updateDirectly(e,t,void 0,i),this._alignBuffer()}dispose(){this._ownsBuffer&&this._buffer.dispose(),this._isDisposed=!0}forEach(e,t){hi.ForEach(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,t)}_alignBuffer(){}static DeduceStride(e){switch(e){case hi.UVKind:case hi.UV2Kind:case hi.UV3Kind:case hi.UV4Kind:case hi.UV5Kind:case hi.UV6Kind:return 2;case hi.NormalKind:case hi.PositionKind:return 3;case hi.ColorKind:case hi.ColorInstanceKind:case hi.MatricesIndicesKind:case hi.MatricesIndicesExtraKind:case hi.MatricesWeightsKind:case hi.MatricesWeightsExtraKind:case hi.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}}static GetDataType(e){return e instanceof Int8Array?hi.BYTE:e instanceof Uint8Array?hi.UNSIGNED_BYTE:e instanceof Int16Array?hi.SHORT:e instanceof Uint16Array?hi.UNSIGNED_SHORT:e instanceof Int32Array?hi.INT:e instanceof Uint32Array?hi.UNSIGNED_INT:hi.FLOAT}static GetTypeByteLength(e){switch(e){case hi.BYTE:case hi.UNSIGNED_BYTE:return 1;case hi.SHORT:case hi.UNSIGNED_SHORT:return 2;case hi.INT:case hi.UNSIGNED_INT:case hi.FLOAT:return 4;default:throw new Error(`Invalid type '${e}'`)}}static ForEach(e,t,i,s,r,n,o,a){if(e instanceof Array){let r=t/4;const o=i/4;for(let t=0;t<n;t+=s){for(let i=0;i<s;i++)a(e[r+i],t+i);r+=o}}else{const l=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),h=hi.GetTypeByteLength(r);for(let e=0;e<n;e+=s){let n=t;for(let t=0;t<s;t++)a(hi._GetFloatValue(l,r,n,o),e+t),n+=h;t+=i}}}static _GetFloatValue(e,t,i,s){switch(t){case hi.BYTE:{let t=e.getInt8(i);return s&&(t=Math.max(t/127,-1)),t}case hi.UNSIGNED_BYTE:{let t=e.getUint8(i);return s&&(t/=255),t}case hi.SHORT:{let t=e.getInt16(i,!0);return s&&(t=Math.max(t/32767,-1)),t}case hi.UNSIGNED_SHORT:{let t=e.getUint16(i,!0);return s&&(t/=65535),t}case hi.INT:return e.getInt32(i,!0);case hi.UNSIGNED_INT:return e.getUint32(i,!0);case hi.FLOAT:return e.getFloat32(i,!0);default:throw new Error(`Invalid component type ${t}`)}}static GetFloatData(e,t,i,s,r,n,o,a){const l=t*hi.GetTypeByteLength(i),h=o*t;if(i!==hi.FLOAT||r!==l){const o=new Float32Array(h);return hi.ForEach(e,s,r,t,i,h,n,((e,t)=>o[t]=e)),o}if(!(e instanceof Array||e instanceof Float32Array)||0!==s||e.length!==h){if(e instanceof Array){const t=s/4;return e.slice(t,t+h)}if(e instanceof ArrayBuffer)return new Float32Array(e,s,h);{let t=e.byteOffset+s;if(a){const i=new Float32Array(h),s=new Float32Array(e.buffer,t,h);return i.set(s),i}const i=t%4;return i&&(t=Math.max(0,t-i)),new Float32Array(e.buffer,t,h)}}return a?e.slice():e}}hi._Counter=0,hi.BYTE=5120,hi.UNSIGNED_BYTE=5121,hi.SHORT=5122,hi.UNSIGNED_SHORT=5123,hi.INT=5124,hi.UNSIGNED_INT=5125,hi.FLOAT=5126,hi.PositionKind="position",hi.NormalKind="normal",hi.TangentKind="tangent",hi.UVKind="uv",hi.UV2Kind="uv2",hi.UV3Kind="uv3",hi.UV4Kind="uv4",hi.UV5Kind="uv5",hi.UV6Kind="uv6",hi.ColorKind="color",hi.ColorInstanceKind="instanceColor",hi.MatricesIndicesKind="matricesIndices",hi.MatricesWeightsKind="matricesWeights",hi.MatricesIndicesExtraKind="matricesIndicesExtra",hi.MatricesWeightsExtraKind="matricesWeightsExtra";class ci{constructor(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}getNormal(e=!1,t=!0){if(!this.pickedMesh||t&&!this.pickedMesh.isVerticesDataPresent(hi.NormalKind))return null;let i,s=this.pickedMesh.getIndices();0===(null==s?void 0:s.length)&&(s=null);const r=R.Vector3[0],n=R.Vector3[1],o=R.Vector3[2];if(t){const e=this.pickedMesh.getVerticesData(hi.NormalKind);let t=s?S.FromArrayToRef(e,3*s[3*this.faceId],r):r.copyFromFloats(e[3*this.faceId*3],e[3*this.faceId*3+1],e[3*this.faceId*3+2]),a=s?S.FromArrayToRef(e,3*s[3*this.faceId+1],n):n.copyFromFloats(e[3*(3*this.faceId+1)],e[3*(3*this.faceId+1)+1],e[3*(3*this.faceId+1)+2]),l=s?S.FromArrayToRef(e,3*s[3*this.faceId+2],o):o.copyFromFloats(e[3*(3*this.faceId+2)],e[3*(3*this.faceId+2)+1],e[3*(3*this.faceId+2)+2]);t=t.scale(this.bu),a=a.scale(this.bv),l=l.scale(1-this.bu-this.bv),i=new S(t.x+a.x+l.x,t.y+a.y+l.y,t.z+a.z+l.z)}else{const e=this.pickedMesh.getVerticesData(hi.PositionKind),t=s?S.FromArrayToRef(e,3*s[3*this.faceId],r):r.copyFromFloats(e[3*this.faceId*3],e[3*this.faceId*3+1],e[3*this.faceId*3+2]),a=s?S.FromArrayToRef(e,3*s[3*this.faceId+1],n):n.copyFromFloats(e[3*(3*this.faceId+1)],e[3*(3*this.faceId+1)+1],e[3*(3*this.faceId+1)+2]),l=s?S.FromArrayToRef(e,3*s[3*this.faceId+2],o):o.copyFromFloats(e[3*(3*this.faceId+2)],e[3*(3*this.faceId+2)+1],e[3*(3*this.faceId+2)+2]),h=t.subtract(a),c=l.subtract(a);i=S.Cross(h,c)}const a=(e,t)=>{let i=e.getWorldMatrix();e.nonUniformScaling&&(R.Matrix[0].copyFrom(i),i=R.Matrix[0],i.setTranslationFromFloats(0,0,0),i.invert(),i.transposeToRef(R.Matrix[1]),i=R.Matrix[1]),S.TransformNormalToRef(t,i,t)};if(e&&a(this.pickedMesh,i),this.ray){const t=R.Vector3[0].copyFrom(i);e||a(this.pickedMesh,t),S.Dot(t,this.ray.direction)>0&&i.negateInPlace()}return i.normalize(),i}getTextureCoordinates(e=hi.UVKind){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(e))return null;const t=this.pickedMesh.getIndices();if(!t)return null;const i=this.pickedMesh.getVerticesData(e);if(!i)return null;let s=E.FromArray(i,2*t[3*this.faceId]),r=E.FromArray(i,2*t[3*this.faceId+1]),n=E.FromArray(i,2*t[3*this.faceId+2]);return s=s.scale(this.bu),r=r.scale(this.bv),n=n.scale(1-this.bu-this.bv),new E(s.x+r.x+n.x,s.y+r.y+n.y)}}class ui{constructor(e){this._vertexBuffers={},this._scene=e}_prepareBuffers(){if(this._vertexBuffers[hi.PositionKind])return;const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[hi.PositionKind]=new hi(this._scene.getEngine(),e,hi.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}_rebuild(){const e=this._vertexBuffers[hi.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer())}_prepareFrame(e=null,t=null){const i=this._scene.activeCamera;return!(!i||!(t=t||i._postProcesses.filter((e=>null!=e)))||0===t.length||!this._scene.postProcessesEnabled||(t[0].activate(i,e,null!=t),0))}directRender(e,t=null,i=!1,s=0,r=0,n=!1){var o;const a=this._scene.getEngine();for(let l=0;l<e.length;l++){l<e.length-1?e[l+1].activate(this._scene.activeCamera,null==t?void 0:t.texture):(t?a.bindFramebuffer(t,s,void 0,void 0,i,r):n||a.restoreDefaultFramebuffer(),null===(o=a._debugInsertMarker)||void 0===o||o.call(a,`post process ${e[l].name} output`));const h=e[l],c=h.apply();c&&(h.onBeforeRenderObservable.notifyObservers(c),this._prepareBuffers(),a.bindBuffers(this._vertexBuffers,this._indexBuffer,c),a.drawElementsType(0,0,6),h.onAfterRenderObservable.notifyObservers(c))}a.setDepthBuffer(!0),a.setDepthWrite(!0)}_finalizeFrame(e,t,i,s,r=!1){var n;const o=this._scene.activeCamera;if(!o)return;if(0===(s=s||o._postProcesses.filter((e=>null!=e))).length||!this._scene.postProcessesEnabled)return;const a=this._scene.getEngine();for(let l=0,h=s.length;l<h;l++){const c=s[l];if(l<h-1?c._outputTexture=s[l+1].activate(o,null==t?void 0:t.texture):(t?(a.bindFramebuffer(t,i,void 0,void 0,r),c._outputTexture=t):(a.restoreDefaultFramebuffer(),c._outputTexture=null),null===(n=a._debugInsertMarker)||void 0===n||n.call(a,`post process ${s[l].name} output`)),e)break;const u=c.apply();u&&(c.onBeforeRenderObservable.notifyObservers(u),this._prepareBuffers(),a.bindBuffers(this._vertexBuffers,this._indexBuffer,u),a.drawElementsType(0,0,6),c.onAfterRenderObservable.notifyObservers(u))}a.setDepthBuffer(!0),a.setDepthWrite(!0),a.setAlphaMode(0)}dispose(){const e=this._vertexBuffers[hi.PositionKind];e&&(e.dispose(),this._vertexBuffers[hi.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}}class di{set opaqueSortCompareFn(e){this._opaqueSortCompareFn=e||di.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(e){this._alphaTestSortCompareFn=e||di.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(e){this._transparentSortCompareFn=e||di.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}constructor(e,t,i=null,s=null,r=null){this.index=e,this._opaqueSubMeshes=new Yt(256),this._transparentSubMeshes=new Yt(256),this._alphaTestSubMeshes=new Yt(256),this._depthOnlySubMeshes=new Yt(256),this._particleSystems=new Yt(256),this._spriteManagers=new Yt(256),this._empty=!0,this._edgesRenderers=new jt(16),this._scene=t,this.opaqueSortCompareFn=i,this.alphaTestSortCompareFn=s,this.transparentSortCompareFn=r}render(e,t,i,s){if(e)return void e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);const r=this._scene.getEngine();0!==this._depthOnlySubMeshes.length&&(r.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),r.setColorWrite(!0)),0!==this._opaqueSubMeshes.length&&this._renderOpaque(this._opaqueSubMeshes),0!==this._alphaTestSubMeshes.length&&this._renderAlphaTest(this._alphaTestSubMeshes);const n=r.getStencilBuffer();if(r.setStencilBuffer(!1),t&&this._renderSprites(),i&&this._renderParticles(s),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),0!==this._transparentSubMeshes.length||this._scene.useOrderIndependentTransparency){if(r.setStencilBuffer(n),this._scene.useOrderIndependentTransparency){const e=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);e.length&&this._renderTransparent(e)}else this._renderTransparent(this._transparentSubMeshes);r.setAlphaMode(0)}if(r.setStencilBuffer(!1),this._edgesRenderers.length){for(let e=0;e<this._edgesRenderers.length;e++)this._edgesRenderers.data[e].render();r.setAlphaMode(0)}r.setStencilBuffer(n)}_renderOpaqueSorted(e){return di._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(e){return di._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(e){return di._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(e,t,i,s){let r,n=0;const o=i?i.globalPosition:di._ZeroVector;if(s)for(;n<e.length;n++)r=e.data[n],r._alphaIndex=r.getMesh().alphaIndex,r._distanceToCamera=S.Distance(r.getBoundingInfo().boundingSphere.centerWorld,o);const a=e.length===e.data.length?e.data:e.data.slice(0,e.length);t&&a.sort(t);const l=a[0].getMesh().getScene();for(n=0;n<a.length;n++)if(r=a[n],!l._activeMeshesFrozenButKeepClipping||r.isInFrustum(l._frustumPlanes)){if(s){const e=r.getMaterial();if(e&&e.needDepthPrePass){const t=e.getScene().getEngine();t.setColorWrite(!1),t.setAlphaMode(0),r.render(!1),t.setColorWrite(!0)}}r.render(s)}}static defaultTransparentSortCompare(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:di.backToFrontSortCompare(e,t)}static backToFrontSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}static frontToBackSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0}static PainterSortCompare(e,t){const i=e.getMesh(),s=t.getMesh();return i.material&&s.material?i.material.uniqueId-s.material.uniqueId:i.uniqueId-s.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(e,t,i){void 0===t&&(t=e.getMesh()),void 0===i&&(i=e.getMaterial()),null!=i&&(i.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):i.needAlphaTesting()?(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)}dispatchSprites(e){this._spriteManagers.push(e),this._empty=!1}dispatchParticles(e){this._particleSystems.push(e),this._empty=!1}_renderParticles(e){if(0===this._particleSystems.length)return;const t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let i=0;i<this._particleSystems.length;i++){const s=this._particleSystems.data[i];if(0===(t&&t.layerMask&s.layerMask))continue;const r=s.emitter;r.position&&e&&-1===e.indexOf(r)||this._scene._activeParticles.addCount(s.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||0===this._spriteManagers.length)return;const e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._spriteManagers.length;t++){const i=this._spriteManagers.data[t];0!==(e&&e.layerMask&i.layerMask)&&i.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}}di._ZeroVector=S.Zero();class pi{}class _i{get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(e){e!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=e,this._maintainStateBetweenFrames||this.restoreDispachedFlags())}restoreDispachedFlags(){for(const e of this._scene.meshes)if(e.subMeshes)for(const t of e.subMeshes)t._wasDispatched=!1;if(this._scene.spriteManagers)for(const e of this._scene.spriteManagers)e._wasDispatched=!1;for(const e of this._scene.particleSystems)e._wasDispatched=!1}constructor(e){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new pi,this._maintainStateBetweenFrames=!1,this._scene=e;for(let e=_i.MIN_RENDERINGGROUPS;e<_i.MAX_RENDERINGGROUPS;e++)this._autoClearDepthStencil[e]={autoClear:!0,depth:!0,stencil:!0}}getRenderingGroup(e){const t=e||0;return this._prepareRenderingGroup(t),this._renderingGroups[t]}_clearDepthStencilBuffer(e=!0,t=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)}render(e,t,i,s){const r=this._renderingGroupInfo;if(r.scene=this._scene,r.camera=this._scene.activeCamera,this._scene.spriteManagers&&s)for(let e=0;e<this._scene.spriteManagers.length;e++){const t=this._scene.spriteManagers[e];this.dispatchSprites(t)}for(let n=_i.MIN_RENDERINGGROUPS;n<_i.MAX_RENDERINGGROUPS;n++){this._depthStencilBufferAlreadyCleaned=n===_i.MIN_RENDERINGGROUPS;const o=this._renderingGroups[n];if(!o||o._empty)continue;const a=Math.pow(2,n);if(r.renderingGroupId=n,this._scene.onBeforeRenderingGroupObservable.notifyObservers(r,a),_i.AUTOCLEAR){const e=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(n):this._autoClearDepthStencil[n];e&&e.autoClear&&this._clearDepthStencilBuffer(e.depth,e.stencil)}for(const e of this._scene._beforeRenderingGroupDrawStage)e.action(n);o.render(e,s,i,t);for(const e of this._scene._afterRenderingGroupDrawStage)e.action(n);this._scene.onAfterRenderingGroupObservable.notifyObservers(r,a)}}reset(){if(!this.maintainStateBetweenFrames)for(let e=_i.MIN_RENDERINGGROUPS;e<_i.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let e=_i.MIN_RENDERINGGROUPS;e<_i.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let e=_i.MIN_RENDERINGGROUPS;e<_i.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.dispose()}}_prepareRenderingGroup(e){void 0===this._renderingGroups[e]&&(this._renderingGroups[e]=new di(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))}dispatchSprites(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchSprites(e))}dispatchParticles(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchParticles(e))}dispatch(e,t,i){void 0===t&&(t=e.getMesh()),this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatch(e,t,i))}setRenderingOrder(e,t=null,i=null,s=null){if(this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=i,this._customTransparentSortCompareFn[e]=s,this._renderingGroups[e]){const t=this._renderingGroups[e];t.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],t.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],t.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}}setRenderingAutoClearDepthStencil(e,t,i=!0,s=!0){this._autoClearDepthStencil[e]={autoClear:t,depth:i,stencil:s}}getAutoClearDepthStencilSetup(e){return this._autoClearDepthStencil[e]}}_i.MAX_RENDERINGGROUPS=4,_i.MIN_RENDERINGGROUPS=0,_i.AUTOCLEAR=!0;class fi{}fi.NAME_EFFECTLAYER="EffectLayer",fi.NAME_LAYER="Layer",fi.NAME_LENSFLARESYSTEM="LensFlareSystem",fi.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer",fi.NAME_PARTICLESYSTEM="ParticleSystem",fi.NAME_GAMEPAD="Gamepad",fi.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue",fi.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer",fi.NAME_PREPASSRENDERER="PrePassRenderer",fi.NAME_DEPTHRENDERER="DepthRenderer",fi.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer",fi.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager",fi.NAME_SPRITE="Sprite",fi.NAME_SUBSURFACE="SubSurface",fi.NAME_OUTLINERENDERER="Outline",fi.NAME_PROCEDURALTEXTURE="ProceduralTexture",fi.NAME_SHADOWGENERATOR="ShadowGenerator",fi.NAME_OCTREE="Octree",fi.NAME_PHYSICSENGINE="PhysicsEngine",fi.NAME_AUDIO="Audio",fi.NAME_FLUIDRENDERER="FluidRenderer",fi.STEP_ISREADYFORMESH_EFFECTLAYER=0,fi.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0,fi.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0,fi.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0,fi.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1,fi.STEP_BEFORECAMERADRAW_PREPASS=0,fi.STEP_BEFORECAMERADRAW_EFFECTLAYER=1,fi.STEP_BEFORECAMERADRAW_LAYER=2,fi.STEP_BEFORERENDERTARGETDRAW_PREPASS=0,fi.STEP_BEFORERENDERTARGETDRAW_LAYER=1,fi.STEP_BEFORERENDERINGMESH_PREPASS=0,fi.STEP_BEFORERENDERINGMESH_OUTLINE=1,fi.STEP_AFTERRENDERINGMESH_PREPASS=0,fi.STEP_AFTERRENDERINGMESH_OUTLINE=1,fi.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0,fi.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1,fi.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0,fi.STEP_BEFORECAMERAUPDATE_GAMEPAD=1,fi.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0,fi.STEP_BEFORECLEAR_PREPASS=1,fi.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0,fi.STEP_AFTERRENDERTARGETDRAW_PREPASS=0,fi.STEP_AFTERRENDERTARGETDRAW_LAYER=1,fi.STEP_AFTERCAMERADRAW_PREPASS=0,fi.STEP_AFTERCAMERADRAW_EFFECTLAYER=1,fi.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2,fi.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3,fi.STEP_AFTERCAMERADRAW_LAYER=4,fi.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5,fi.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0,fi.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0,fi.STEP_AFTERRENDER_AUDIO=0,fi.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0,fi.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1,fi.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2,fi.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3,fi.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0,fi.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1,fi.STEP_POINTERMOVE_SPRITE=0,fi.STEP_POINTERDOWN_SPRITE=0,fi.STEP_POINTERUP_SPRITE=0;class mi extends Array{constructor(e){super(...e)}static Create(){return Object.create(mi.prototype)}registerStep(e,t,i){let s=0,r=Number.MAX_VALUE;for(;s<this.length&&(r=this[s].index,!(e<r));s++);this.splice(s,0,{index:e,component:t,action:i.bind(t)})}clear(){this.length=0}}class gi{}gi.POINTERDOWN=1,gi.POINTERUP=2,gi.POINTERMOVE=4,gi.POINTERWHEEL=8,gi.POINTERPICK=16,gi.POINTERTAP=32,gi.POINTERDOUBLETAP=64;class vi{constructor(e,t){this.type=e,this.event=t}}class xi extends vi{constructor(e,t,i,s){super(e,t),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new E(i,s)}}class Ti extends vi{get pickInfo(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}constructor(e,t,i,s=null){super(e,t),this._pickInfo=i,this._inputManager=s}_generatePickInfo(){this._inputManager&&(this._pickInfo=this._inputManager._pickMove(this.event),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),this._inputManager=null)}}class Ei{}Ei.KEYDOWN=1,Ei.KEYUP=2;class Si{constructor(e,t){this.type=e,this.event=t}}class bi extends Si{get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(e){this.skipOnKeyboardObservable=e}constructor(e,t){super(e,t),this.type=e,this.event=t,this.skipOnKeyboardObservable=!1}}!function(e){e[e.Generic=0]="Generic",e[e.Keyboard=1]="Keyboard",e[e.Mouse=2]="Mouse",e[e.Touch=3]="Touch",e[e.DualShock=4]="DualShock",e[e.Xbox=5]="Xbox",e[e.Switch=6]="Switch",e[e.DualSense=7]="DualSense"}(Jt||(Jt={})),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.LeftClick=2]="LeftClick",e[e.MiddleClick=3]="MiddleClick",e[e.RightClick=4]="RightClick",e[e.BrowserBack=5]="BrowserBack",e[e.BrowserForward=6]="BrowserForward",e[e.MouseWheelX=7]="MouseWheelX",e[e.MouseWheelY=8]="MouseWheelY",e[e.MouseWheelZ=9]="MouseWheelZ",e[e.Move=12]="Move"}(ei||(ei={})),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.LeftClick=2]="LeftClick",e[e.MiddleClick=3]="MiddleClick",e[e.RightClick=4]="RightClick",e[e.BrowserBack=5]="BrowserBack",e[e.BrowserForward=6]="BrowserForward",e[e.MouseWheelX=7]="MouseWheelX",e[e.MouseWheelY=8]="MouseWheelY",e[e.MouseWheelZ=9]="MouseWheelZ",e[e.DeltaHorizontal=10]="DeltaHorizontal",e[e.DeltaVertical=11]="DeltaVertical"}(ti||(ti={})),function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.L2=6]="L2",e[e.R2=7]="R2",e[e.Share=8]="Share",e[e.Options=9]="Options",e[e.L3=10]="L3",e[e.R3=11]="R3",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.TouchPad=17]="TouchPad",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(ii||(ii={})),function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.L2=6]="L2",e[e.R2=7]="R2",e[e.Create=8]="Create",e[e.Options=9]="Options",e[e.L3=10]="L3",e[e.R3=11]="R3",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.TouchPad=17]="TouchPad",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(si||(si={})),function(e){e[e.A=0]="A",e[e.B=1]="B",e[e.X=2]="X",e[e.Y=3]="Y",e[e.LB=4]="LB",e[e.RB=5]="RB",e[e.LT=6]="LT",e[e.RT=7]="RT",e[e.Back=8]="Back",e[e.Start=9]="Start",e[e.LS=10]="LS",e[e.RS=11]="RS",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.LStickXAxis=17]="LStickXAxis",e[e.LStickYAxis=18]="LStickYAxis",e[e.RStickXAxis=19]="RStickXAxis",e[e.RStickYAxis=20]="RStickYAxis"}(ri||(ri={})),function(e){e[e.B=0]="B",e[e.A=1]="A",e[e.Y=2]="Y",e[e.X=3]="X",e[e.L=4]="L",e[e.R=5]="R",e[e.ZL=6]="ZL",e[e.ZR=7]="ZR",e[e.Minus=8]="Minus",e[e.Plus=9]="Plus",e[e.LS=10]="LS",e[e.RS=11]="RS",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.Capture=17]="Capture",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(ni||(ni={})),function(e){e[e.PointerMove=0]="PointerMove",e[e.PointerDown=1]="PointerDown",e[e.PointerUp=2]="PointerUp"}(oi||(oi={}));class Ci{}Ci.DOM_DELTA_PIXEL=0,Ci.DOM_DELTA_LINE=1,Ci.DOM_DELTA_PAGE=2;class yi{static CreateDeviceEvent(e,t,i,s,r,n,o){switch(e){case Jt.Keyboard:return this._CreateKeyboardEvent(i,s,r,n);case Jt.Mouse:if(i===ei.MouseWheelX||i===ei.MouseWheelY||i===ei.MouseWheelZ)return this._CreateWheelEvent(e,t,i,s,r,n);case Jt.Touch:return this._CreatePointerEvent(e,t,i,s,r,n,o);default:throw`Unable to generate event for device ${Jt[e]}`}}static _CreatePointerEvent(e,t,i,s,r,n,o){const a=this._CreateMouseEvent(e,t,i,s,r,n);e===Jt.Mouse?(a.deviceType=Jt.Mouse,a.pointerId=1,a.pointerType="mouse"):(a.deviceType=Jt.Touch,a.pointerId=null!=o?o:t,a.pointerType="touch");let l=0;return l+=r.pollInput(e,t,ei.LeftClick),l+=2*r.pollInput(e,t,ei.RightClick),l+=4*r.pollInput(e,t,ei.MiddleClick),a.buttons=l,i===ei.Move?a.type="pointermove":i>=ei.LeftClick&&i<=ei.RightClick&&(a.type=1===s?"pointerdown":"pointerup",a.button=i-2),a}static _CreateWheelEvent(e,t,i,s,r,n){const o=this._CreateMouseEvent(e,t,i,s,r,n);switch(o.pointerId=1,o.type="wheel",o.deltaMode=Ci.DOM_DELTA_PIXEL,o.deltaX=0,o.deltaY=0,o.deltaZ=0,i){case ei.MouseWheelX:o.deltaX=s;break;case ei.MouseWheelY:o.deltaY=s;break;case ei.MouseWheelZ:o.deltaZ=s}return o}static _CreateMouseEvent(e,t,i,s,r,n){const o=this._CreateEvent(n),a=r.pollInput(e,t,ei.Horizontal),l=r.pollInput(e,t,ei.Vertical);return n?(o.movementX=0,o.movementY=0,o.offsetX=o.movementX-n.getBoundingClientRect().x,o.offsetY=o.movementY-n.getBoundingClientRect().y):(o.movementX=r.pollInput(e,t,ti.DeltaHorizontal),o.movementY=r.pollInput(e,t,ti.DeltaVertical),o.offsetX=0,o.offsetY=0),this._CheckNonCharacterKeys(o,r),o.clientX=a,o.clientY=l,o.x=a,o.y=l,o.deviceType=e,o.deviceSlot=t,o.inputIndex=i,o}static _CreateKeyboardEvent(e,t,i,s){const r=this._CreateEvent(s);return this._CheckNonCharacterKeys(r,i),r.deviceType=Jt.Keyboard,r.deviceSlot=0,r.inputIndex=e,r.type=1===t?"keydown":"keyup",r.key=String.fromCharCode(e),r.keyCode=e,r}static _CheckNonCharacterKeys(e,t){const i=t.isDeviceAvailable(Jt.Keyboard),s=i&&1===t.pollInput(Jt.Keyboard,0,18),r=i&&1===t.pollInput(Jt.Keyboard,0,17),n=i&&(1===t.pollInput(Jt.Keyboard,0,91)||1===t.pollInput(Jt.Keyboard,0,92)||1===t.pollInput(Jt.Keyboard,0,93)),o=i&&1===t.pollInput(Jt.Keyboard,0,16);e.altKey=s,e.ctrlKey=r,e.metaKey=n,e.shiftKey=o}static _CreateEvent(e){const t={preventDefault:()=>{}};return t.target=e,t}}class Ai{constructor(e,t,i){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,((e,t,s,r)=>{const n=yi.CreateDeviceEvent(e,t,s,r,this);i(e,t,n)})):this._createDummyNativeInput()}pollInput(e,t,i){return this._nativeInput.pollInput(e,t,i)}isDeviceAvailable(e){return e===Jt.Mouse||e===Jt.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}}const Ri=Object.keys(ei).length/2;class Ii{constructor(e,t,i,s){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=Ht.IsSafari(),this._usingMacOS=Oe()&&/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=e=>{},this._keyboardUpEvent=e=>{},this._keyboardBlurEvent=e=>{},this._pointerMoveEvent=e=>{},this._pointerDownEvent=e=>{},this._pointerUpEvent=e=>{},this._pointerCancelEvent=e=>{},this._pointerWheelEvent=e=>{},this._pointerBlurEvent=e=>{},this._pointerMacOSChromeOutEvent=e=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=Oe()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Firefox"),this._isUsingChromium=Oe()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Chrome"),this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=e=>{},this._gamepadDisconnectedEvent=e=>{},this._eventPrefix=Ht.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=i,this._onInputChanged=s,this._mouseId=this._isUsingFirefox?0:1,this._enableEvents(),this._usingMacOS&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}pollInput(e,t,i){const s=this._inputs[e][t];if(!s)throw`Unable to find device ${Jt[e]}`;e>=Jt.DualShock&&e<=Jt.DualSense&&this._updateDevice(e,t,i);const r=s[i];if(void 0===r)throw`Unable to find input ${i} for device ${Jt[e]} in slot ${t}`;return i===ei.Move&&Ht.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),r}isDeviceAvailable(e){return void 0!==this._inputs[e]}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){const e=null==this?void 0:this._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs)for(const e of this._inputs)if(e)for(const t in e){const i=e[+t];if(i)for(let e=0;e<i.length;e++)i[e]=0}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=-1!==this._elementToAttachTo.tabIndex?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),this._usingMacOS&&this._isUsingChromium&&this._elementToAttachTo.removeEventListener("lostpointercapture",this._pointerMacOSChromeOutEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads){const e=navigator.getGamepads();for(const t of e)t&&this._addGamePad(t)}"function"==typeof matchMedia&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(Jt.Mouse,0,0,0)}_addGamePad(e){const t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t}_addPointerDevice(e,t,i,s){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,Ri);const r=this._inputs[e][t];r[0]=i,r[1]=s}_registerDevice(e,t,i){if(void 0===t)throw`Unable to register device ${Jt[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){const s=new Array(i);s.fill(0),this._inputs[e][t]=s,this._onDeviceConnected(e,t)}}_unregisterDevice(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(Jt.Keyboard,0,255));const t=this._inputs[Jt.Keyboard][0];if(t){t[e.keyCode]=1;const i=e;i.inputIndex=e.keyCode,this._usingMacOS&&e.metaKey&&"Meta"!==e.key&&(this._metaKeys.includes(e.keyCode)||this._metaKeys.push(e.keyCode)),this._onInputChanged(Jt.Keyboard,0,i)}},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(Jt.Keyboard,0,255));const t=this._inputs[Jt.Keyboard][0];if(t){t[e.keyCode]=0;const i=e;if(i.inputIndex=e.keyCode,this._usingMacOS&&"Meta"===e.key&&this._metaKeys.length>0){for(const e of this._metaKeys){const i=yi.CreateDeviceEvent(Jt.Keyboard,0,e,0,this,this._elementToAttachTo);t[e]=0,this._onInputChanged(Jt.Keyboard,0,i)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(Jt.Keyboard,0,i)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){const e=this._inputs[Jt.Keyboard][0];for(let t=0;t<e.length;t++)if(0!==e[t]){e[t]=0;const i=yi.CreateDeviceEvent(Jt.Keyboard,0,t,0,this,this._elementToAttachTo);this._onInputChanged(Jt.Keyboard,0,i)}this._usingMacOS&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=Oe()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(let e=0;e<this._maxTouchPoints;e++)this._activeTouchIds[e]=-1;this._pointerMoveEvent=e=>{const t=this._getPointerType(e);let i=t===Jt.Mouse?0:this._activeTouchIds.indexOf(e.pointerId);if(t===Jt.Touch&&-1===i){const s=this._activeTouchIds.indexOf(-1);if(!(s>=0))return void Ht.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);i=s,this._activeTouchIds[s]=e.pointerId,this._onDeviceConnected(t,i)}this._inputs[t]||(this._inputs[t]={}),this._inputs[t][i]||this._addPointerDevice(t,i,e.clientX,e.clientY);const s=this._inputs[t][i];if(s){const r=e;r.inputIndex=ei.Move,s[ei.Horizontal]=e.clientX,s[ei.Vertical]=e.clientY,t===Jt.Touch&&0===s[ei.LeftClick]&&(s[ei.LeftClick]=1),void 0===e.pointerId&&(e.pointerId=this._mouseId),this._onInputChanged(t,i,r),this._usingSafari||-1===e.button||(r.inputIndex=e.button+2,s[e.button+2]=s[e.button+2]?0:1,this._onInputChanged(t,i,r))}},this._pointerDownEvent=e=>{const t=this._getPointerType(e);let i=t===Jt.Mouse?0:e.pointerId;if(t===Jt.Touch){const t=this._activeTouchIds.indexOf(-1);if(!(t>=0))return void Ht.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);i=t,this._activeTouchIds[t]=e.pointerId}this._inputs[t]||(this._inputs[t]={}),this._inputs[t][i]?t===Jt.Touch&&this._onDeviceConnected(t,i):this._addPointerDevice(t,i,e.clientX,e.clientY);const s=this._inputs[t][i];if(s){const r=s[ei.Horizontal],n=s[ei.Vertical];if(t===Jt.Mouse){if(void 0===e.pointerId&&(e.pointerId=this._mouseId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch(e){}}else if(e.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(e.pointerId)}catch(e){}s[ei.Horizontal]=e.clientX,s[ei.Vertical]=e.clientY,s[e.button+2]=1;const o=e;o.inputIndex=e.button+2,this._onInputChanged(t,i,o),r===e.clientX&&n===e.clientY||(o.inputIndex=ei.Move,this._onInputChanged(t,i,o))}},this._pointerUpEvent=e=>{var t,i,s,r,n;const o=this._getPointerType(e),a=o===Jt.Mouse?0:this._activeTouchIds.indexOf(e.pointerId);if(o===Jt.Touch){if(-1===a)return;this._activeTouchIds[a]=-1}const l=null===(t=this._inputs[o])||void 0===t?void 0:t[a];if(l&&0!==l[e.button+2]){const t=l[ei.Horizontal],h=l[ei.Vertical];l[ei.Horizontal]=e.clientX,l[ei.Vertical]=e.clientY,l[e.button+2]=0;const c=e;void 0===e.pointerId&&(e.pointerId=this._mouseId),t===e.clientX&&h===e.clientY||(c.inputIndex=ei.Move,this._onInputChanged(o,a,c)),c.inputIndex=e.button+2,o===Jt.Mouse&&this._mouseId>=0&&(null===(s=(i=this._elementToAttachTo).hasPointerCapture)||void 0===s?void 0:s.call(i,this._mouseId))?this._elementToAttachTo.releasePointerCapture(this._mouseId):e.pointerId&&(null===(n=(r=this._elementToAttachTo).hasPointerCapture)||void 0===n?void 0:n.call(r,e.pointerId))&&this._elementToAttachTo.releasePointerCapture(e.pointerId),this._onInputChanged(o,a,c),o===Jt.Touch&&this._onDeviceDisconnected(o,a)}},this._pointerCancelEvent=e=>{var t,i,s,r;if("mouse"===e.pointerType){const e=this._inputs[Jt.Mouse][0];this._mouseId>=0&&(null===(i=(t=this._elementToAttachTo).hasPointerCapture)||void 0===i?void 0:i.call(t,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let t=ei.LeftClick;t<=ei.BrowserForward;t++)if(1===e[t]){e[t]=0;const i=yi.CreateDeviceEvent(Jt.Mouse,0,t,0,this,this._elementToAttachTo);this._onInputChanged(Jt.Mouse,0,i)}}else{const t=this._activeTouchIds.indexOf(e.pointerId);if(-1===t)return;(null===(r=(s=this._elementToAttachTo).hasPointerCapture)||void 0===r?void 0:r.call(s,e.pointerId))&&this._elementToAttachTo.releasePointerCapture(e.pointerId),this._inputs[Jt.Touch][t][ei.LeftClick]=0;const i=yi.CreateDeviceEvent(Jt.Touch,t,ei.LeftClick,0,this,this._elementToAttachTo,e.pointerId);this._onInputChanged(Jt.Touch,t,i),this._activeTouchIds[t]=-1,this._onDeviceDisconnected(Jt.Touch,t)}},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll";let e=!1;const t=function(){};try{const i=Object.defineProperty({},"passive",{get:function(){e=!0}});this._elementToAttachTo.addEventListener("test",t,i),this._elementToAttachTo.removeEventListener("test",t,i)}catch(e){}this._pointerBlurEvent=()=>{var e,t,i,s,r;if(this.isDeviceAvailable(Jt.Mouse)){const i=this._inputs[Jt.Mouse][0];this._mouseId>=0&&(null===(t=(e=this._elementToAttachTo).hasPointerCapture)||void 0===t?void 0:t.call(e,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let e=ei.LeftClick;e<=ei.BrowserForward;e++)if(1===i[e]){i[e]=0;const t=yi.CreateDeviceEvent(Jt.Mouse,0,e,0,this,this._elementToAttachTo);this._onInputChanged(Jt.Mouse,0,t)}}if(this.isDeviceAvailable(Jt.Touch)){const e=this._inputs[Jt.Touch];for(let t=0;t<this._activeTouchIds.length;t++){const n=this._activeTouchIds[t];if((null===(s=(i=this._elementToAttachTo).hasPointerCapture)||void 0===s?void 0:s.call(i,n))&&this._elementToAttachTo.releasePointerCapture(n),-1!==n&&1===(null===(r=e[t])||void 0===r?void 0:r[ei.LeftClick])){e[t][ei.LeftClick]=0;const i=yi.CreateDeviceEvent(Jt.Touch,t,ei.LeftClick,0,this,this._elementToAttachTo,n);this._onInputChanged(Jt.Touch,t,i),this._activeTouchIds[t]=-1,this._onDeviceDisconnected(Jt.Touch,t)}}}},this._pointerWheelEvent=e=>{const t=Jt.Mouse;this._inputs[t]||(this._inputs[t]=[]),this._inputs[t][0]||(this._pointerActive=!0,this._registerDevice(t,0,Ri));const i=this._inputs[t][0];if(i){i[ei.MouseWheelX]=e.deltaX||0,i[ei.MouseWheelY]=e.deltaY||e.wheelDelta||0,i[ei.MouseWheelZ]=e.deltaZ||0;const s=e;void 0===e.pointerId&&(e.pointerId=this._mouseId),0!==i[ei.MouseWheelX]&&(s.inputIndex=ei.MouseWheelX,this._onInputChanged(t,0,s)),0!==i[ei.MouseWheelY]&&(s.inputIndex=ei.MouseWheelY,this._onInputChanged(t,0,s)),0!==i[ei.MouseWheelZ]&&(s.inputIndex=ei.MouseWheelZ,this._onInputChanged(t,0,s))}},this._usingMacOS&&this._isUsingChromium&&(this._pointerMacOSChromeOutEvent=e=>{e.buttons>1&&this._pointerCancelEvent(e)},this._elementToAttachTo.addEventListener("lostpointercapture",this._pointerMacOSChromeOutEvent)),this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,!!e&&{passive:!1}),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add((()=>{if(this.isDeviceAvailable(Jt.Mouse)){const e=this._inputs[Jt.Mouse][0];e[ei.MouseWheelX]=0,e[ei.MouseWheelY]=0,e[ei.MouseWheelZ]=0}}))}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad)},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){const t=this._getGamepadDeviceType(e.gamepad.id),i=e.gamepad.index;this._unregisterDevice(t,i),delete this._gamepads[i]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}_updateDevice(e,t,i){const s=navigator.getGamepads()[t];if(s&&e===this._gamepads[t]){const r=this._inputs[e][t];i>=s.buttons.length?r[i]=s.axes[i-s.buttons.length].valueOf():r[i]=s.buttons[i].value}}_getGamepadDeviceType(e){return-1!==e.indexOf("054c")?-1!==e.indexOf("0ce6")?Jt.DualSense:Jt.DualShock:-1!==e.indexOf("Xbox One")||-1!==e.search("Xbox 360")||-1!==e.search("xinput")?Jt.Xbox:-1!==e.indexOf("057e")?Jt.Switch:Jt.Generic}_getPointerType(e){let t=Jt.Mouse;return("touch"===e.pointerType||"pen"===e.pointerType||e.touches)&&(t=Jt.Touch),t}}class Pi{constructor(e,t,i=0){this.deviceType=t,this.deviceSlot=i,this.onInputChangedObservable=new a,this._deviceInputSystem=e}getInput(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}}class Mi{constructor(e){this._registeredManagers=new Array,this._refCount=0,this.registerManager=e=>{for(let t=0;t<this._devices.length;t++){const i=this._devices[t];for(const s in i){const i=+s;e._addDevice(new Pi(this._deviceInputSystem,t,i))}}this._registeredManagers.push(e)},this.unregisterManager=e=>{const t=this._registeredManagers.indexOf(e);t>-1&&this._registeredManagers.splice(t,1)};const t=Object.keys(Jt).length/2;this._devices=new Array(t);const i=(e,t)=>{this._devices[e]||(this._devices[e]=new Array),this._devices[e][t]||(this._devices[e][t]=t);for(const i of this._registeredManagers){const s=new Pi(this._deviceInputSystem,e,t);i._addDevice(s)}},s=(e,t)=>{var i;(null===(i=this._devices[e])||void 0===i?void 0:i[t])&&delete this._devices[e][t];for(const i of this._registeredManagers)i._removeDevice(e,t)},r=(e,t,i)=>{if(i)for(const s of this._registeredManagers)s._onInputChanged(e,t,i)};"undefined"!=typeof _native?this._deviceInputSystem=new Ai(i,s,r):this._deviceInputSystem=new Ii(e,i,s,r)}dispose(){this._deviceInputSystem.dispose()}}class Oi{getDeviceSource(e,t){if(void 0===t){if(void 0===this._firstDevice[e])return null;t=this._firstDevice[e]}return this._devices[e]&&void 0!==this._devices[e][t]?this._devices[e][t]:null}getDeviceSources(e){return this._devices[e]?this._devices[e].filter((e=>!!e)):[]}constructor(e){const t=Object.keys(Jt).length/2;this._devices=new Array(t),this._firstDevice=new Array(t),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new Mi(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new a((e=>{for(const t of this._devices)if(t)for(const i of t)i&&this.onDeviceConnectedObservable.notifyObserver(e,i)})),this.onDeviceDisconnectedObservable=new a,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add((()=>{this.dispose()}))}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}_addDevice(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=new Array),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)}_removeDevice(e,t){var i,s;const r=null===(i=this._devices[e])||void 0===i?void 0:i[t];this.onDeviceDisconnectedObservable.notifyObservers(r),(null===(s=this._devices[e])||void 0===s?void 0:s[t])&&delete this._devices[e][t],this._updateFirstDevices(e)}_onInputChanged(e,t,i){var s,r;null===(r=null===(s=this._devices[e])||void 0===s?void 0:s[t])||void 0===r||r.onInputChangedObservable.notifyObservers(i)}_updateFirstDevices(e){switch(e){case Jt.Keyboard:case Jt.Mouse:this._firstDevice[e]=0;break;case Jt.Touch:case Jt.DualSense:case Jt.DualShock:case Jt.Xbox:case Jt.Switch:case Jt.Generic:{delete this._firstDevice[e];const t=this._devices[e];if(t)for(let i=0;i<t.length;i++)if(t[i]){this._firstDevice[e]=i;break}break}}}}class Di{constructor(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}get singleClick(){return this._singleClick}get doubleClick(){return this._doubleClick}get hasSwiped(){return this._hasSwiped}get ignore(){return this._ignore}set singleClick(e){this._singleClick=e}set doubleClick(e){this._doubleClick=e}set hasSwiped(e){this._hasSwiped=e}set ignore(e){this._ignore=e}}class Ni{constructor(e){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._totalPointersPressed=0,this._doubleClickOccured=!1,this._isSwiping=!1,this._swipeButtonPressed=-1,this._skipPointerTap=!1,this._isMultiTouchGesture=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new E(0,0),this._previousStartingPointerPosition=new E(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._movePointerInfo=null,this._cameraObserverCount=0,this._delayedClicks=[null,null,null,null,null],this._deviceSourceManager=null,this._scene=e||x.LastCreatedScene,this._scene}get meshUnderPointer(){return this._movePointerInfo&&(this._movePointerInfo._generatePickInfo(),this._movePointerInfo=null),this._pointerOverMesh}getMeshUnderPointerByPointerId(e){return this._meshUnderPointerId[e]||null}get unTranslatedPointer(){return new E(this._unTranslatedPointerX,this._unTranslatedPointerY)}get pointerX(){return this._pointerX}set pointerX(e){this._pointerX=e}get pointerY(){return this._pointerY}set pointerY(e){this._pointerY=e}_updatePointerPosition(e){const t=this._scene.getEngine().getInputElementClientRect();t&&(this._pointerX=e.clientX-t.left,this._pointerY=e.clientY-t.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)}_processPointerMove(e,t){const i=this._scene,s=i.getEngine(),r=s.getInputElement();r&&(r.tabIndex=s.canvasTabIndex,i.doNotHandleCursors||(r.style.cursor=i.defaultCursor)),this._setCursorAndPointerOverMesh(e,t,i);for(const s of i._pointerMoveStage){const i=!!(null==(e=e||this._pickMove(t))?void 0:e.pickedMesh);e=s.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,i,r)}const n=t.inputIndex>=ei.MouseWheelX&&t.inputIndex<=ei.MouseWheelZ?gi.POINTERWHEEL:gi.POINTERMOVE;let o;i.onPointerMove&&(e=e||this._pickMove(t),i.onPointerMove(t,e,n)),e?(o=new Ti(n,t,e),this._setRayOnPointerInfo(e,t)):(o=new Ti(n,t,null,this),this._movePointerInfo=o),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(o,n)}_setRayOnPointerInfo(e,t){const i=this._scene;e&&i._pickingAvailable&&(e.ray||(e.ray=i.createPickingRay(t.offsetX,t.offsetY,y.Identity(),i.activeCamera)))}_addCameraPointerObserver(e,t){return this._cameraObserverCount++,this._scene.onPointerObservable.add(e,t)}_removeCameraPointerObserver(e){return this._cameraObserverCount--,this._scene.onPointerObservable.remove(e)}_checkForPicking(){return!!(this._scene.onPointerObservable.observers.length>this._cameraObserverCount||this._scene.onPointerPick)}_checkPrePointerObservable(e,t,i){const s=this._scene,r=new xi(i,t,this._unTranslatedPointerX,this._unTranslatedPointerY);return e&&(r.originalPickingInfo=e,r.ray=e.ray,e.originMesh&&(r.nearInteractionPickingInfo=e)),s.onPrePointerObservable.notifyObservers(r,i),!!r.skipOnPointerObservable}_pickMove(e){const t=this._scene,i=t.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,t.pointerMovePredicate,t.pointerMoveFastCheck,t.cameraToUseForPointers,t.pointerMoveTrianglePredicate);return this._setCursorAndPointerOverMesh(i,e,t),i}_setCursorAndPointerOverMesh(e,t,i){const s=i.getEngine().getInputElement();if(null==e?void 0:e.pickedMesh){if(this.setPointerOverMesh(e.pickedMesh,t.pointerId,e,t),!i.doNotHandleCursors&&s&&this._pointerOverMesh){const e=this._pointerOverMesh._getActionManagerForTrigger();e&&e.hasPointerTriggers&&(s.style.cursor=e.hoverCursor||i.hoverCursor)}}else this.setPointerOverMesh(null,t.pointerId,e,t)}simulatePointerMove(e,t){const i=new PointerEvent("pointermove",t);i.inputIndex=ei.Move,this._checkPrePointerObservable(e,i,gi.POINTERMOVE)||this._processPointerMove(e,i)}simulatePointerDown(e,t){const i=new PointerEvent("pointerdown",t);i.inputIndex=i.button+2,this._checkPrePointerObservable(e,i,gi.POINTERDOWN)||this._processPointerDown(e,i)}_processPointerDown(e,t){const i=this._scene;if(null==e?void 0:e.pickedMesh){this._pickedDownMesh=e.pickedMesh;const s=e.pickedMesh._getActionManagerForTrigger();if(s){if(s.hasPickTriggers)switch(s.processTrigger(5,B.CreateNew(e.pickedMesh,t,e)),t.button){case 0:s.processTrigger(2,B.CreateNew(e.pickedMesh,t,e));break;case 1:s.processTrigger(4,B.CreateNew(e.pickedMesh,t,e));break;case 2:s.processTrigger(3,B.CreateNew(e.pickedMesh,t,e))}s.hasSpecificTrigger(8)&&window.setTimeout((()=>{const e=i.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,(e=>e.isPickable&&e.isVisible&&e.isReady()&&e.actionManager&&e.actionManager.hasSpecificTrigger(8)&&e===this._pickedDownMesh),!1,i.cameraToUseForPointers);(null==e?void 0:e.pickedMesh)&&s&&0!==this._totalPointersPressed&&Date.now()-this._startingPointerTime>Ni.LongPressDelay&&!this._isPointerSwiping()&&(this._startingPointerTime=0,s.processTrigger(8,B.CreateNew(e.pickedMesh,t)))}),Ni.LongPressDelay)}}else for(const s of i._pointerDownStage)e=s.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,!1);let s;const r=gi.POINTERDOWN;e?(i.onPointerDown&&i.onPointerDown(t,e,r),s=new Ti(r,t,e),this._setRayOnPointerInfo(e,t)):s=new Ti(r,t,null,this),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(s,r)}_isPointerSwiping(){return this._isSwiping}simulatePointerUp(e,t,i){const s=new PointerEvent("pointerup",t);s.inputIndex=ei.Move;const r=new Di;i?r.doubleClick=!0:r.singleClick=!0,this._checkPrePointerObservable(e,s,gi.POINTERUP)||this._processPointerUp(e,s,r)}_processPointerUp(e,t,i){const s=this._scene;if(null==e?void 0:e.pickedMesh){if(this._pickedUpMesh=e.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(s.onPointerPick&&s.onPointerPick(t,e),i.singleClick&&!i.ignore&&s.onPointerObservable.observers.length>this._cameraObserverCount)){const i=gi.POINTERPICK,r=new Ti(i,t,e);this._setRayOnPointerInfo(e,t),s.onPointerObservable.notifyObservers(r,i)}const r=e.pickedMesh._getActionManagerForTrigger();if(r&&!i.ignore){r.processTrigger(7,B.CreateNew(e.pickedMesh,t,e)),!i.hasSwiped&&i.singleClick&&r.processTrigger(1,B.CreateNew(e.pickedMesh,t,e));const s=e.pickedMesh._getActionManagerForTrigger(6);i.doubleClick&&s&&s.processTrigger(6,B.CreateNew(e.pickedMesh,t,e))}}else if(!i.ignore)for(const r of s._pointerUpStage)e=r.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,i.doubleClick);if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){const e=this._pickedDownMesh._getActionManagerForTrigger(16);e&&e.processTrigger(16,B.CreateNew(this._pickedDownMesh,t))}if(!i.ignore){const r=new Ti(gi.POINTERUP,t,e);if(this._setRayOnPointerInfo(e,t),s.onPointerObservable.notifyObservers(r,gi.POINTERUP),s.onPointerUp&&s.onPointerUp(t,e,gi.POINTERUP),!i.hasSwiped&&!this._skipPointerTap&&!this._isMultiTouchGesture){let r=0;if(i.singleClick?r=gi.POINTERTAP:i.doubleClick&&(r=gi.POINTERDOUBLETAP),r){const i=new Ti(r,t,e);s.onPointerObservable.hasObservers()&&s.onPointerObservable.hasSpecificMask(r)&&s.onPointerObservable.notifyObservers(i,r)}}}}isPointerCaptured(e=0){return this._pointerCaptures[e]}attachControl(e=!0,t=!0,i=!0,s=null){const n=this._scene,o=n.getEngine();s||(s=o.getInputElement()),this._alreadyAttached&&this.detachControl(),s&&(this._alreadyAttachedTo=s),this._deviceSourceManager=new Oi(o),this._initActionManager=e=>{if(!this._meshPickProceed){const t=n.skipPointerUpPicking||0===n._registeredActions&&!this._checkForPicking()&&!n.onPointerUp?null:n.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,n.pointerUpPredicate,n.pointerUpFastCheck,n.cameraToUseForPointers);this._currentPickResult=t,t&&(e=t.hit&&t.pickedMesh?t.pickedMesh._getActionManagerForTrigger():null),this._meshPickProceed=!0}return e},this._delayedSimpleClick=(e,t,i)=>{if((Date.now()-this._previousStartingPointerTime>Ni.DoubleClickDelay&&!this._doubleClickOccured||e!==this._previousButtonPressed)&&(this._doubleClickOccured=!1,t.singleClick=!0,t.ignore=!1,this._delayedClicks[e])){const t=this._delayedClicks[e].evt,i=gi.POINTERTAP,s=new Ti(i,t,this._currentPickResult);n.onPointerObservable.hasObservers()&&n.onPointerObservable.hasSpecificMask(i)&&n.onPointerObservable.notifyObservers(s,i),this._delayedClicks[e]=null}},this._initClickEvent=(e,t,i,s)=>{var n,o;const a=new Di;this._currentPickResult=null;let l=null,h=e.hasSpecificMask(gi.POINTERPICK)||t.hasSpecificMask(gi.POINTERPICK)||e.hasSpecificMask(gi.POINTERTAP)||t.hasSpecificMask(gi.POINTERTAP)||e.hasSpecificMask(gi.POINTERDOUBLETAP)||t.hasSpecificMask(gi.POINTERDOUBLETAP);!h&&r&&(l=this._initActionManager(l,a),l&&(h=l.hasPickTriggers));let c=!1;if(h){const h=i.button;if(a.hasSwiped=this._isPointerSwiping(),!a.hasSwiped){let u=!Ni.ExclusiveDoubleClickMode;if(u||(u=!e.hasSpecificMask(gi.POINTERDOUBLETAP)&&!t.hasSpecificMask(gi.POINTERDOUBLETAP),u&&!r.HasSpecificTrigger(6)&&(l=this._initActionManager(l,a),l&&(u=!l.hasSpecificTrigger(6)))),u)(Date.now()-this._previousStartingPointerTime>Ni.DoubleClickDelay||h!==this._previousButtonPressed)&&(a.singleClick=!0,s(a,this._currentPickResult),c=!0);else{const e={evt:i,clickInfo:a,timeoutId:window.setTimeout(this._delayedSimpleClick.bind(this,h,a,s),Ni.DoubleClickDelay)};this._delayedClicks[h]=e}let d=e.hasSpecificMask(gi.POINTERDOUBLETAP)||t.hasSpecificMask(gi.POINTERDOUBLETAP);!d&&r.HasSpecificTrigger(6)&&(l=this._initActionManager(l,a),l&&(d=l.hasSpecificTrigger(6))),d&&(h===this._previousButtonPressed&&Date.now()-this._previousStartingPointerTime<Ni.DoubleClickDelay&&!this._doubleClickOccured?(a.hasSwiped||this._isPointerSwiping()?(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=h,Ni.ExclusiveDoubleClickMode?(this._delayedClicks[h]&&(clearTimeout(null===(o=this._delayedClicks[h])||void 0===o?void 0:o.timeoutId),this._delayedClicks[h]=null),s(a,this._previousPickResult)):s(a,this._currentPickResult)):(this._previousStartingPointerTime=0,this._doubleClickOccured=!0,a.doubleClick=!0,a.ignore=!1,Ni.ExclusiveDoubleClickMode&&this._delayedClicks[h]&&(clearTimeout(null===(n=this._delayedClicks[h])||void 0===n?void 0:n.timeoutId),this._delayedClicks[h]=null),s(a,this._currentPickResult)),c=!0):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=h))}}c||s(a,this._currentPickResult)},this._onPointerMove=e=>{if(this._updatePointerPosition(e),this._isSwiping||-1===this._swipeButtonPressed||(this._isSwiping=Math.abs(this._startingPointerPosition.x-this._pointerX)>Ni.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>Ni.DragMovementThreshold),o.isPointerLock&&o._verifyPointerLock(),this._checkPrePointerObservable(null,e,e.inputIndex>=ei.MouseWheelX&&e.inputIndex<=ei.MouseWheelZ?gi.POINTERWHEEL:gi.POINTERMOVE))return;if(!n.cameraToUseForPointers&&!n.activeCamera)return;if(n.skipPointerMovePicking)return void this._processPointerMove(new ci,e);n.pointerMovePredicate||(n.pointerMovePredicate=e=>e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(e.enablePointerMoveEvents||n.constantlyUpdateMeshUnderPointer||null!==e._getActionManagerForTrigger())&&(!n.cameraToUseForPointers||!!(n.cameraToUseForPointers.layerMask&e.layerMask)));const t=n._registeredActions>0||n.constantlyUpdateMeshUnderPointer?this._pickMove(e):null;this._processPointerMove(t,e)},this._onPointerDown=e=>{var t;if(this._totalPointersPressed++,this._pickedDownMesh=null,this._meshPickProceed=!1,Ni.ExclusiveDoubleClickMode)for(let i=0;i<this._delayedClicks.length;i++)if(this._delayedClicks[i])if(e.button===i)clearTimeout(null===(t=this._delayedClicks[i])||void 0===t?void 0:t.timeoutId);else{const e=this._delayedClicks[i].clickInfo;this._doubleClickOccured=!1,e.singleClick=!0,e.ignore=!1;const t=this._delayedClicks[i].evt,s=gi.POINTERTAP,r=new Ti(s,t,this._currentPickResult);n.onPointerObservable.hasObservers()&&n.onPointerObservable.hasSpecificMask(s)&&n.onPointerObservable.notifyObservers(r,s),this._delayedClicks[i]=null}if(this._updatePointerPosition(e),-1===this._swipeButtonPressed&&(this._swipeButtonPressed=e.button),n.preventDefaultOnPointerDown&&s&&(e.preventDefault(),s.focus()),this._startingPointerPosition.x=this._pointerX,this._startingPointerPosition.y=this._pointerY,this._startingPointerTime=Date.now(),this._checkPrePointerObservable(null,e,gi.POINTERDOWN))return;if(!n.cameraToUseForPointers&&!n.activeCamera)return;let i;this._pointerCaptures[e.pointerId]=!0,n.pointerDownPredicate||(n.pointerDownPredicate=e=>e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(!n.cameraToUseForPointers||!!(n.cameraToUseForPointers.layerMask&e.layerMask))),this._pickedDownMesh=null,i=n.skipPointerDownPicking||0===n._registeredActions&&!this._checkForPicking()&&!n.onPointerDown?new ci:n.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,n.pointerDownPredicate,n.pointerDownFastCheck,n.cameraToUseForPointers),this._processPointerDown(i,e)},this._onPointerUp=e=>{0!==this._totalPointersPressed&&(this._totalPointersPressed--,this._pickedUpMesh=null,this._meshPickProceed=!1,this._updatePointerPosition(e),n.preventDefaultOnPointerUp&&s&&(e.preventDefault(),s.focus()),this._initClickEvent(n.onPrePointerObservable,n.onPointerObservable,e,((t,i)=>{if(n.onPrePointerObservable.hasObservers()&&(this._skipPointerTap=!1,!t.ignore)){if(this._checkPrePointerObservable(null,e,gi.POINTERUP))return this._swipeButtonPressed===e.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1),void(0===e.buttons&&(this._pointerCaptures[e.pointerId]=!1));t.hasSwiped||(t.singleClick&&n.onPrePointerObservable.hasSpecificMask(gi.POINTERTAP)&&this._checkPrePointerObservable(null,e,gi.POINTERTAP)&&(this._skipPointerTap=!0),t.doubleClick&&n.onPrePointerObservable.hasSpecificMask(gi.POINTERDOUBLETAP)&&this._checkPrePointerObservable(null,e,gi.POINTERDOUBLETAP)&&(this._skipPointerTap=!0))}this._pointerCaptures[e.pointerId]?(0===e.buttons&&(this._pointerCaptures[e.pointerId]=!1),(n.cameraToUseForPointers||n.activeCamera)&&(n.pointerUpPredicate||(n.pointerUpPredicate=e=>e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(!n.cameraToUseForPointers||!!(n.cameraToUseForPointers.layerMask&e.layerMask))),!this._meshPickProceed&&(r&&r.HasTriggers||this._checkForPicking()||n.onPointerUp)&&this._initActionManager(null,t),i||(i=this._currentPickResult),this._processPointerUp(i,e,t),this._previousPickResult=this._currentPickResult,this._swipeButtonPressed===e.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1))):this._swipeButtonPressed===e.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1)})))},this._onKeyDown=e=>{const t=Ei.KEYDOWN;if(n.onPreKeyboardObservable.hasObservers()){const i=new bi(t,e);if(n.onPreKeyboardObservable.notifyObservers(i,t),i.skipOnKeyboardObservable)return}if(n.onKeyboardObservable.hasObservers()){const i=new Si(t,e);n.onKeyboardObservable.notifyObservers(i,t)}n.actionManager&&n.actionManager.processTrigger(14,B.CreateNewFromScene(n,e))},this._onKeyUp=e=>{const t=Ei.KEYUP;if(n.onPreKeyboardObservable.hasObservers()){const i=new bi(t,e);if(n.onPreKeyboardObservable.notifyObservers(i,t),i.skipOnKeyboardObservable)return}if(n.onKeyboardObservable.hasObservers()){const i=new Si(t,e);n.onKeyboardObservable.notifyObservers(i,t)}n.actionManager&&n.actionManager.processTrigger(15,B.CreateNewFromScene(n,e))},this._deviceSourceManager.onDeviceConnectedObservable.add((s=>{s.deviceType===Jt.Mouse?s.onInputChangedObservable.add((r=>{r.inputIndex===ei.LeftClick||r.inputIndex===ei.MiddleClick||r.inputIndex===ei.RightClick||r.inputIndex===ei.BrowserBack||r.inputIndex===ei.BrowserForward?t&&1===s.getInput(r.inputIndex)?this._onPointerDown(r):e&&0===s.getInput(r.inputIndex)&&this._onPointerUp(r):i&&(r.inputIndex===ei.Move?this._onPointerMove(r):r.inputIndex!==ei.MouseWheelX&&r.inputIndex!==ei.MouseWheelY&&r.inputIndex!==ei.MouseWheelZ||this._onPointerMove(r))})):s.deviceType===Jt.Touch?s.onInputChangedObservable.add((r=>{r.inputIndex===ei.LeftClick&&(t&&1===s.getInput(r.inputIndex)?(this._onPointerDown(r),this._totalPointersPressed>1&&(this._isMultiTouchGesture=!0)):e&&0===s.getInput(r.inputIndex)&&(this._onPointerUp(r),0===this._totalPointersPressed&&(this._isMultiTouchGesture=!1))),i&&r.inputIndex===ei.Move&&this._onPointerMove(r)})):s.deviceType===Jt.Keyboard&&s.onInputChangedObservable.add((e=>{"keydown"===e.type?this._onKeyDown(e):"keyup"===e.type&&this._onKeyUp(e)}))})),this._alreadyAttached=!0}detachControl(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)}setPointerOverMesh(e,t=0,i,s){if(!(this._meshUnderPointerId[t]!==e||e&&e._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting))return;const r=this._meshUnderPointerId[t];let n;r&&(n=r._getActionManagerForTrigger(10),n&&n.processTrigger(10,B.CreateNew(r,s,{pointerId:t}))),e?(this._meshUnderPointerId[t]=e,this._pointerOverMesh=e,n=e._getActionManagerForTrigger(9),n&&n.processTrigger(9,B.CreateNew(e,s,{pointerId:t,pickResult:i}))):(delete this._meshUnderPointerId[t],this._pointerOverMesh=null)}getPointerOverMesh(){return this.meshUnderPointer}_invalidateMesh(e){this._pointerOverMesh===e&&(this._pointerOverMesh=null),this._pickedDownMesh===e&&(this._pickedDownMesh=null),this._pickedUpMesh===e&&(this._pickedUpMesh=null);for(const t in this._meshUnderPointerId)this._meshUnderPointerId[t]===e&&delete this._meshUnderPointerId[t]}}Ni.DragMovementThreshold=10,Ni.LongPressDelay=500,Ni.DoubleClickDelay=300,Ni.ExclusiveDoubleClickMode=!1;class Fi{get min(){return this._min}get max(){return this._max}get average(){return this._average}get lastSecAverage(){return this._lastSecAverage}get current(){return this._current}get total(){return this._totalAccumulated}get count(){return this._totalValueCount}constructor(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}fetchNewFrame(){this._totalValueCount++,this._current=0,this._lastSecValueCount++}addCount(e,t){Fi.Enabled&&(this._current+=e,t&&this._fetchResult())}beginMonitoring(){Fi.Enabled&&(this._startMonitoringTime=Fe.Now)}endMonitoring(e=!0){if(!Fi.Enabled)return;e&&this.fetchNewFrame();const t=Fe.Now;this._current=t-this._startMonitoringTime,e&&this._fetchResult()}endFrame(){this._fetchResult()}_fetchResult(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;const e=Fe.Now;e-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0)}}Fi.Enabled=!0;class wi{constructor(e,t,i,s){this.normal=new S(e,t,i),this.d=s}asArray(){return[this.normal.x,this.normal.y,this.normal.z,this.d]}clone(){return new wi(this.normal.x,this.normal.y,this.normal.z,this.d)}getClassName(){return"Plane"}getHashCode(){let e=this.normal.getHashCode();return e=397*e^this.d,e}normalize(){const e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z);let t=0;return 0!==e&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this}transform(e){const t=wi._TmpMatrix;e.invertToRef(t);const i=t.m,s=this.normal.x,r=this.normal.y,n=this.normal.z,o=this.d,a=s*i[0]+r*i[1]+n*i[2]+o*i[3],l=s*i[4]+r*i[5]+n*i[6]+o*i[7],h=s*i[8]+r*i[9]+n*i[10]+o*i[11],c=s*i[12]+r*i[13]+n*i[14]+o*i[15];return new wi(a,l,h,c)}dotCoordinate(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d}copyFromPoints(e,t,i){const s=t.x-e.x,r=t.y-e.y,n=t.z-e.z,o=i.x-e.x,a=i.y-e.y,l=i.z-e.z,h=r*l-n*a,c=n*o-s*l,u=s*a-r*o,d=Math.sqrt(h*h+c*c+u*u);let p;return p=0!==d?1/d:0,this.normal.x=h*p,this.normal.y=c*p,this.normal.z=u*p,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this}isFrontFacingTo(e,t){return S.Dot(this.normal,e)<=t}signedDistanceTo(e){return S.Dot(e,this.normal)+this.d}static FromArray(e){return new wi(e[0],e[1],e[2],e[3])}static FromPoints(e,t,i){const s=new wi(0,0,0,0);return s.copyFromPoints(e,t,i),s}static FromPositionAndNormal(e,t){const i=new wi(0,0,0,0);return this.FromPositionAndNormalToRef(e,t,i)}static FromPositionAndNormalToRef(e,t,i){return i.normal.copyFrom(t),i.normal.normalize(),i.d=-e.dot(i.normal),i}static SignedDistanceToPlaneFromPositionAndNormal(e,t,i){const s=-(t.x*e.x+t.y*e.y+t.z*e.z);return S.Dot(i,t)+s}}wi._TmpMatrix=y.Identity();class Li{static GetPlanes(e){const t=[];for(let e=0;e<6;e++)t.push(new wi(0,0,0,0));return Li.GetPlanesToRef(e,t),t}static GetNearPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[2],t.normal.y=i[7]+i[6],t.normal.z=i[11]+i[10],t.d=i[15]+i[14],t.normalize()}static GetFarPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[2],t.normal.y=i[7]-i[6],t.normal.z=i[11]-i[10],t.d=i[15]-i[14],t.normalize()}static GetLeftPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[0],t.normal.y=i[7]+i[4],t.normal.z=i[11]+i[8],t.d=i[15]+i[12],t.normalize()}static GetRightPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[0],t.normal.y=i[7]-i[4],t.normal.z=i[11]-i[8],t.d=i[15]-i[12],t.normalize()}static GetTopPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[1],t.normal.y=i[7]-i[5],t.normal.z=i[11]-i[9],t.d=i[15]-i[13],t.normalize()}static GetBottomPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[1],t.normal.y=i[7]+i[5],t.normal.z=i[11]+i[9],t.d=i[15]+i[13],t.normalize()}static GetPlanesToRef(e,t){Li.GetNearPlaneToRef(e,t[0]),Li.GetFarPlaneToRef(e,t[1]),Li.GetLeftPlaneToRef(e,t[2]),Li.GetRightPlaneToRef(e,t[3]),Li.GetTopPlaneToRef(e,t[4]),Li.GetBottomPlaneToRef(e,t[5])}static IsPointInFrustum(e,t){for(let i=0;i<6;i++)if(t[i].dotCoordinate(e)<0)return!1;return!0}}class Bi{static get UniqueId(){const e=this._UniqueIdCounter;return this._UniqueIdCounter++,e}}Bi._UniqueIdCounter=1;class Ui{static CompareLightsPriority(e,t){return e.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0):t.renderPriority-e.renderPriority}}Ui.FALLOFF_DEFAULT=0,Ui.FALLOFF_PHYSICAL=1,Ui.FALLOFF_GLTF=2,Ui.FALLOFF_STANDARD=3,Ui.LIGHTMAP_DEFAULT=0,Ui.LIGHTMAP_SPECULAR=1,Ui.LIGHTMAP_SHADOWSONLY=2,Ui.INTENSITYMODE_AUTOMATIC=0,Ui.INTENSITYMODE_LUMINOUSPOWER=1,Ui.INTENSITYMODE_LUMINOUSINTENSITY=2,Ui.INTENSITYMODE_ILLUMINANCE=3,Ui.INTENSITYMODE_LUMINANCE=4,Ui.LIGHTTYPEID_POINTLIGHT=0,Ui.LIGHTTYPEID_DIRECTIONALLIGHT=1,Ui.LIGHTTYPEID_SPOTLIGHT=2,Ui.LIGHTTYPEID_HEMISPHERICLIGHT=3;class Vi{constructor(){this.pointerDownFastCheck=!1,this.pointerUpFastCheck=!1,this.pointerMoveFastCheck=!1,this.skipPointerMovePicking=!1,this.skipPointerDownPicking=!1,this.skipPointerUpPicking=!1}}var ki,Gi,zi,Wi,Hi,Xi;!function(e){e[e.BackwardCompatible=0]="BackwardCompatible",e[e.Intermediate=1]="Intermediate",e[e.Aggressive=2]="Aggressive"}(ki||(ki={}));class Yi extends s{static DefaultMaterialFactory(e){throw $("StandardMaterial")}static CollisionCoordinatorFactory(){throw $("DefaultCollisionCoordinator")}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture!==e&&(this._environmentTexture=e,this.markAllMaterialsAsDirty(1))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}get performancePriority(){return this._performancePriority}set performancePriority(e){if(e!==this._performancePriority){switch(this._performancePriority=e,e){case ki.BackwardCompatible:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case ki.Intermediate:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case ki.Aggressive:this.skipFrustumClipping=!0,this._renderingManager.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1}this.onScenePerformancePriorityChangedObservable.notifyObservers(e)}}set forceWireframe(e){this._forceWireframe!==e&&(this._forceWireframe=e,this.markAllMaterialsAsDirty(16))}get forceWireframe(){return this._forceWireframe}set skipFrustumClipping(e){this._skipFrustumClipping!==e&&(this._skipFrustumClipping=e)}get skipFrustumClipping(){return this._skipFrustumClipping}set forcePointsCloud(e){this._forcePointsCloud!==e&&(this._forcePointsCloud=e,this.markAllMaterialsAsDirty(16))}get forcePointsCloud(){return this._forcePointsCloud}get animationPropertiesOverride(){return this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set beforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),e&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e))}set afterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),e&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(e))}set beforeCameraRender(e){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e)}set afterCameraRender(e){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e)}get pointerDownPredicate(){return this._pointerPickingConfiguration.pointerDownPredicate}set pointerDownPredicate(e){this._pointerPickingConfiguration.pointerDownPredicate=e}get pointerUpPredicate(){return this._pointerPickingConfiguration.pointerUpPredicate}set pointerUpPredicate(e){this._pointerPickingConfiguration.pointerUpPredicate=e}get pointerMovePredicate(){return this._pointerPickingConfiguration.pointerMovePredicate}set pointerMovePredicate(e){this._pointerPickingConfiguration.pointerMovePredicate=e}get pointerDownFastCheck(){return this._pointerPickingConfiguration.pointerDownFastCheck}set pointerDownFastCheck(e){this._pointerPickingConfiguration.pointerDownFastCheck=e}get pointerUpFastCheck(){return this._pointerPickingConfiguration.pointerUpFastCheck}set pointerUpFastCheck(e){this._pointerPickingConfiguration.pointerUpFastCheck=e}get pointerMoveFastCheck(){return this._pointerPickingConfiguration.pointerMoveFastCheck}set pointerMoveFastCheck(e){this._pointerPickingConfiguration.pointerMoveFastCheck=e}get skipPointerMovePicking(){return this._pointerPickingConfiguration.skipPointerMovePicking}set skipPointerMovePicking(e){this._pointerPickingConfiguration.skipPointerMovePicking=e}get skipPointerDownPicking(){return this._pointerPickingConfiguration.skipPointerDownPicking}set skipPointerDownPicking(e){this._pointerPickingConfiguration.skipPointerDownPicking=e}get skipPointerUpPicking(){return this._pointerPickingConfiguration.skipPointerUpPicking}set skipPointerUpPicking(e){this._pointerPickingConfiguration.skipPointerUpPicking=e}get unTranslatedPointer(){return this._inputManager.unTranslatedPointer}static get DragMovementThreshold(){return Ni.DragMovementThreshold}static set DragMovementThreshold(e){Ni.DragMovementThreshold=e}static get LongPressDelay(){return Ni.LongPressDelay}static set LongPressDelay(e){Ni.LongPressDelay=e}static get DoubleClickDelay(){return Ni.DoubleClickDelay}static set DoubleClickDelay(e){Ni.DoubleClickDelay=e}static get ExclusiveDoubleClickMode(){return Ni.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(e){Ni.ExclusiveDoubleClickMode=e}bindEyePosition(e,t="vEyePosition",i=!1){const s=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:this.activeCamera.globalPosition,r=this.useRightHandedSystem===(null!=this._mirroredCameraPosition);return R.Vector4[0].set(s.x,s.y,s.z,r?-1:1),e&&(i?e.setFloat3(t,R.Vector4[0].x,R.Vector4[0].y,R.Vector4[0].z):e.setVector4(t,R.Vector4[0])),R.Vector4[0]}finalizeSceneUbo(){const e=this.getSceneUniformBuffer(),t=this.bindEyePosition(null);return e.updateFloat4("vEyePosition",t.x,t.y,t.z,t.w),e.update(),e}set useRightHandedSystem(e){this._useRightHandedSystem!==e&&(this._useRightHandedSystem=e,this.markAllMaterialsAsDirty(16))}get useRightHandedSystem(){return this._useRightHandedSystem}setStepId(e){this._currentStepId=e}getStepId(){return this._currentStepId}getInternalStep(){return this._currentInternalStep}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAllMaterialsAsDirty(16))}get fogEnabled(){return this._fogEnabled}set fogMode(e){this._fogMode!==e&&(this._fogMode=e,this.markAllMaterialsAsDirty(16))}get fogMode(){return this._fogMode}get prePass(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this.markAllMaterialsAsDirty(2))}get shadowsEnabled(){return this._shadowsEnabled}set lightsEnabled(e){this._lightsEnabled!==e&&(this._lightsEnabled=e,this.markAllMaterialsAsDirty(2))}get lightsEnabled(){return this._lightsEnabled}get activeCameras(){return this._activeCameras}set activeCameras(e){this._unObserveActiveCameras&&(this._unObserveActiveCameras(),this._unObserveActiveCameras=null),e&&(this._unObserveActiveCameras=_(e,(()=>{this.onActiveCamerasChanged.notifyObservers(this)}))),this._activeCameras=e}get activeCamera(){return this._activeCamera}set activeCamera(e){e!==this._activeCamera&&(this._activeCamera=e,this.onActiveCameraChanged.notifyObservers(this))}get defaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=Yi.DefaultMaterialFactory(this)),this._defaultMaterial}set defaultMaterial(e){this._defaultMaterial=e}set texturesEnabled(e){this._texturesEnabled!==e&&(this._texturesEnabled=e,this.markAllMaterialsAsDirty(1))}get texturesEnabled(){return this._texturesEnabled}set skeletonsEnabled(e){this._skeletonsEnabled!==e&&(this._skeletonsEnabled=e,this.markAllMaterialsAsDirty(8))}get skeletonsEnabled(){return this._skeletonsEnabled}get collisionCoordinator(){return this._collisionCoordinator||(this._collisionCoordinator=Yi.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}get renderingManager(){return this._renderingManager}get frustumPlanes(){return this._frustumPlanes}_registerTransientComponents(){if(this._transientComponents.length>0){for(const e of this._transientComponents)e.register();this._transientComponents.length=0}}_addComponent(e){this._components.push(e),this._transientComponents.push(e);const t=e;t.addFromContainer&&t.serialize&&this._serializableComponents.push(t)}_getComponent(e){for(const t of this._components)if(t.name===e)return t;return null}constructor(e,t){super(),this._inputManager=new Ni(this),this.cameraToUseForPointers=null,this._isScene=!0,this._blockEntityCollection=!1,this.autoClear=!0,this.autoClearDepthAndStencil=!0,this.clearColor=new F(.2,.2,.3,1),this.ambientColor=new N(0,0,0),this.environmentIntensity=1,this._performancePriority=ki.BackwardCompatible,this.onScenePerformancePriorityChangedObservable=new a,this._forceWireframe=!1,this._skipFrustumClipping=!1,this._forcePointsCloud=!1,this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor="pointer",this.defaultCursor="",this.doNotHandleCursors=!1,this.preventDefaultOnPointerDown=!0,this.preventDefaultOnPointerUp=!0,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=[],this.onDisposeObservable=new a,this._onDisposeObserver=null,this.onBeforeRenderObservable=new a,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new a,this.onAfterRenderCameraObservable=new a,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new a,this.onAfterAnimationsObservable=new a,this.onBeforeDrawPhaseObservable=new a,this.onAfterDrawPhaseObservable=new a,this.onReadyObservable=new a,this.onBeforeCameraRenderObservable=new a,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new a,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new a,this.onAfterActiveMeshesEvaluationObservable=new a,this.onBeforeParticlesRenderingObservable=new a,this.onAfterParticlesRenderingObservable=new a,this.onDataLoadedObservable=new a,this.onNewCameraAddedObservable=new a,this.onCameraRemovedObservable=new a,this.onNewLightAddedObservable=new a,this.onLightRemovedObservable=new a,this.onNewGeometryAddedObservable=new a,this.onGeometryRemovedObservable=new a,this.onNewTransformNodeAddedObservable=new a,this.onTransformNodeRemovedObservable=new a,this.onNewMeshAddedObservable=new a,this.onMeshRemovedObservable=new a,this.onNewSkeletonAddedObservable=new a,this.onSkeletonRemovedObservable=new a,this.onNewMaterialAddedObservable=new a,this.onNewMultiMaterialAddedObservable=new a,this.onMaterialRemovedObservable=new a,this.onMultiMaterialRemovedObservable=new a,this.onNewTextureAddedObservable=new a,this.onTextureRemovedObservable=new a,this.onBeforeRenderTargetsRenderObservable=new a,this.onAfterRenderTargetsRenderObservable=new a,this.onBeforeStepObservable=new a,this.onAfterStepObservable=new a,this.onActiveCameraChanged=new a,this.onActiveCamerasChanged=new a,this.onBeforeRenderingGroupObservable=new a,this.onAfterRenderingGroupObservable=new a,this.onMeshImportedObservable=new a,this.onAnimationFileImportedObservable=new a,this._registeredForLateAnimationBindings=new jt(256),this._pointerPickingConfiguration=new Vi,this.onPrePointerObservable=new a,this.onPointerObservable=new a,this.onPreKeyboardObservable=new a,this.onKeyboardObservable=new a,this._useRightHandedSystem=!1,this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this._fogEnabled=!0,this._fogMode=Yi.FOGMODE_NONE,this.fogColor=new N(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=!1,this._shadowsEnabled=!0,this._lightsEnabled=!0,this._unObserveActiveCameras=null,this._texturesEnabled=!0,this.physicsEnabled=!0,this.particlesEnabled=!0,this.spritesEnabled=!0,this._skeletonsEnabled=!0,this.lensFlaresEnabled=!0,this.collisionsEnabled=!0,this.gravity=new S(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=[],this.importedMeshesFiles=[],this.probesEnabled=!0,this._meshesForIntersections=new jt(256),this.proceduralTexturesEnabled=!0,this._totalVertices=new Fi,this._activeIndices=new Fi,this._activeParticles=new Fi,this._activeBones=new Fi,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._frameId=0,this._executeWhenReadyTimeoutId=null,this._intermediateRendering=!1,this._defaultFrameBufferCleared=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._toBeDisposed=new Array(256),this._activeRequests=new Array,this._pendingData=new Array,this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new Yt(256),this._processedMaterials=new Yt(256),this._renderTargets=new jt(256),this._materialsRenderTargets=new jt(256),this._activeParticleSystems=new Yt(256),this._activeSkeletons=new jt(32),this._softwareSkinnedMeshes=new jt(32),this._activeAnimatables=new Array,this._transformMatrix=y.Zero(),this.requireLightSorting=!1,this._components=[],this._serializableComponents=[],this._transientComponents=[],this._beforeCameraUpdateStage=mi.Create(),this._beforeClearStage=mi.Create(),this._beforeRenderTargetClearStage=mi.Create(),this._gatherRenderTargetsStage=mi.Create(),this._gatherActiveCameraRenderTargetsStage=mi.Create(),this._isReadyForMeshStage=mi.Create(),this._beforeEvaluateActiveMeshStage=mi.Create(),this._evaluateSubMeshStage=mi.Create(),this._preActiveMeshStage=mi.Create(),this._cameraDrawRenderTargetStage=mi.Create(),this._beforeCameraDrawStage=mi.Create(),this._beforeRenderTargetDrawStage=mi.Create(),this._beforeRenderingGroupDrawStage=mi.Create(),this._beforeRenderingMeshStage=mi.Create(),this._afterRenderingMeshStage=mi.Create(),this._afterRenderingGroupDrawStage=mi.Create(),this._afterCameraDrawStage=mi.Create(),this._afterCameraPostProcessStage=mi.Create(),this._afterRenderTargetDrawStage=mi.Create(),this._afterRenderTargetPostProcessStage=mi.Create(),this._afterRenderStage=mi.Create(),this._pointerMoveStage=mi.Create(),this._pointerDownStage=mi.Create(),this._pointerUpStage=mi.Create(),this._geometriesByUniqueId=null,this._defaultMeshCandidates={data:[],length:0},this._defaultSubMeshCandidates={data:[],length:0},this._preventFreeActiveMeshesAndRenderingGroups=!1,this._activeMeshesFrozen=!1,this._activeMeshesFrozenButKeepClipping=!1,this._skipEvaluateActiveMeshesCompletely=!1,this._allowPostProcessClearColor=!0,this.getDeterministicFrameTime=()=>this._engine.getTimeStep(),this._registeredActions=0,this._blockMaterialDirtyMechanism=!1,this._perfCollector=null,this.activeCameras=[];const i=Object.assign({useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1},t);e=this._engine=e||x.LastCreatedEngine,i.virtual?e._virtualScenes.push(this):(x._LastCreatedScene=this,e.scenes.push(this)),this._uid=null,this._renderingManager=new _i(this),ui&&(this.postProcessManager=new ui(this)),Me()&&this.attachControl(),this._createUbo(),Zt&&(this._imageProcessingConfiguration=new Zt),this.setDefaultCandidateProviders(),i.useGeometryUniqueIdsMap&&(this._geometriesByUniqueId={}),this.useMaterialMeshMap=i.useMaterialMeshMap,this.useClonedMeshMap=i.useClonedMeshMap,t&&t.virtual||e.onNewSceneAddedObservable.notifyObservers(this)}getClassName(){return"Scene"}_getDefaultMeshCandidates(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}_getDefaultSubMeshCandidates(e){return this._defaultSubMeshCandidates.data=e.subMeshes,this._defaultSubMeshCandidates.length=e.subMeshes.length,this._defaultSubMeshCandidates}setDefaultCandidateProviders(){this.getActiveMeshCandidates=()=>this._getDefaultMeshCandidates(),this.getActiveSubMeshCandidates=e=>this._getDefaultSubMeshCandidates(e),this.getIntersectingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e),this.getCollidingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e)}get meshUnderPointer(){return this._inputManager.meshUnderPointer}get pointerX(){return this._inputManager.pointerX}set pointerX(e){this._inputManager.pointerX=e}get pointerY(){return this._inputManager.pointerY}set pointerY(e){this._inputManager.pointerY=e}getCachedMaterial(){return this._cachedMaterial}getCachedEffect(){return this._cachedEffect}getCachedVisibility(){return this._cachedVisibility}isCachedMaterialInvalid(e,t,i=1){return this._cachedEffect!==t||this._cachedMaterial!==e||this._cachedVisibility!==i}getEngine(){return this._engine}getTotalVertices(){return this._totalVertices.current}get totalVerticesPerfCounter(){return this._totalVertices}getActiveIndices(){return this._activeIndices.current}get totalActiveIndicesPerfCounter(){return this._activeIndices}getActiveParticles(){return this._activeParticles.current}get activeParticlesPerfCounter(){return this._activeParticles}getActiveBones(){return this._activeBones.current}get activeBonesPerfCounter(){return this._activeBones}getActiveMeshes(){return this._activeMeshes}getAnimationRatio(){return void 0!==this._animationRatio?this._animationRatio:1}getRenderId(){return this._renderId}getFrameId(){return this._frameId}incrementRenderId(){this._renderId++}_createUbo(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}simulatePointerMove(e,t){return this._inputManager.simulatePointerMove(e,t),this}simulatePointerDown(e,t){return this._inputManager.simulatePointerDown(e,t),this}simulatePointerUp(e,t,i){return this._inputManager.simulatePointerUp(e,t,i),this}isPointerCaptured(e=0){return this._inputManager.isPointerCaptured(e)}attachControl(e=!0,t=!0,i=!0){this._inputManager.attachControl(e,t,i)}detachControl(){this._inputManager.detachControl()}isReady(e=!0){var t,i,s;if(this._isDisposed)return!1;let r;const n=this.getEngine(),o=n.currentRenderPassId;n.currentRenderPassId=null!==(i=null===(t=this.activeCamera)||void 0===t?void 0:t.renderPassId)&&void 0!==i?i:o;let a=!0;for(this._pendingData.length>0&&(a=!1),null===(s=this.prePassRenderer)||void 0===s||s.update(),this.useOrderIndependentTransparency&&this.depthPeelingRenderer&&a&&(a=this.depthPeelingRenderer.isReady()),e&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),r=0;r<this.meshes.length;r++){const t=this.meshes[r];if(!t.subMeshes||0===t.subMeshes.length)continue;if(!t.isReady(!0)){a=!1;continue}const i=t.hasThinInstances||"InstancedMesh"===t.getClassName()||"InstancedLinesMesh"===t.getClassName()||n.getCaps().instancedArrays&&t.instances.length>0;for(const e of this._isReadyForMeshStage)e.action(t,i)||(a=!1);if(!e)continue;const s=t.material||this.defaultMaterial;if(s)if(s._storeEffectOnSubMeshes)for(const e of t.subMeshes){const t=e.getMaterial();t&&t.hasRenderTargetTextures&&null!=t.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(t)&&(this._processedMaterials.push(t),this._materialsRenderTargets.concatWithNoDuplicate(t.getRenderTargetTextures()))}else s.hasRenderTargetTextures&&null!=s.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(s)&&(this._processedMaterials.push(s),this._materialsRenderTargets.concatWithNoDuplicate(s.getRenderTargetTextures()))}if(e)for(r=0;r<this._materialsRenderTargets.length;++r)this._materialsRenderTargets.data[r].isReadyForRendering()||(a=!1);for(r=0;r<this.geometries.length;r++)2===this.geometries[r].delayLoadState&&(a=!1);if(this.activeCameras&&this.activeCameras.length>0)for(const e of this.activeCameras)e.isReady(!0)||(a=!1);else this.activeCamera&&(this.activeCamera.isReady(!0)||(a=!1));for(const e of this.particleSystems)e.isReady()||(a=!1);if(this.layers)for(const e of this.layers)e.isReady()||(a=!1);return n.areAllEffectsReady()||(a=!1),n.currentRenderPassId=o,a}resetCachedMaterial(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null}registerBeforeRender(e){this.onBeforeRenderObservable.add(e)}unregisterBeforeRender(e){this.onBeforeRenderObservable.removeCallback(e)}registerAfterRender(e){this.onAfterRenderObservable.add(e)}unregisterAfterRender(e){this.onAfterRenderObservable.removeCallback(e)}_executeOnceBeforeRender(e){const t=()=>{e(),setTimeout((()=>{this.unregisterBeforeRender(t)}))};this.registerBeforeRender(t)}executeOnceBeforeRender(e,t){void 0!==t?setTimeout((()=>{this._executeOnceBeforeRender(e)}),t):this._executeOnceBeforeRender(e)}addPendingData(e){this._pendingData.push(e)}removePendingData(e){const t=this.isLoading,i=this._pendingData.indexOf(e);-1!==i&&this._pendingData.splice(i,1),t&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}getWaitingItemsCount(){return this._pendingData.length}get isLoading(){return this._pendingData.length>0}executeWhenReady(e,t=!1){this.onReadyObservable.addOnce(e),null===this._executeWhenReadyTimeoutId&&this._checkIsReady(t)}whenReadyAsync(e=!1){return new Promise((t=>{this.executeWhenReady((()=>{t()}),e)}))}_checkIsReady(e=!1){return this._registerTransientComponents(),this.isReady(e)?(this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=null)):this._isDisposed?(this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=null)):void(this._executeWhenReadyTimeoutId=setTimeout((()=>{this.incrementRenderId(),this._checkIsReady(e)}),100))}get animatables(){return this._activeAnimatables}resetLastAnimationTimeFrame(){this._animationTimeLast=Fe.Now}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projectionMatrix}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(e,t,i,s){i||s||!this._multiviewSceneUbo||(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),this._viewUpdateFlag===e.updateFlag&&this._projectionUpdateFlag===t.updateFlag||(this._viewUpdateFlag=e.updateFlag,this._projectionUpdateFlag=t.updateFlag,this._viewMatrix=e,this._projectionMatrix=t,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?Li.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Li.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(i,s):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))}getSceneUniformBuffer(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}createSceneUniformBuffer(e){const t=new ai(this._engine,void 0,!1,null!=e?e:"scene");return t.addUniform("viewProjection",16),t.addUniform("view",16),t.addUniform("projection",16),t.addUniform("vEyePosition",4),t}setSceneUniformBuffer(e){this._sceneUbo=e,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1}getUniqueId(){return Bi.UniqueId}addMesh(e,t=!1){this._blockEntityCollection||(this.meshes.push(e),e._resyncLightSources(),e.parent||e._addToSceneRootNodes(),this.onNewMeshAddedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach((e=>{this.addMesh(e)})))}removeMesh(e,t=!1){const i=this.meshes.indexOf(e);return-1!==i&&(this.meshes[i]=this.meshes[this.meshes.length-1],this.meshes.pop(),e.parent||e._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(e),this.onMeshRemovedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach((e=>{this.removeMesh(e)})),i}addTransformNode(e){this._blockEntityCollection||e.getScene()===this&&-1!==e._indexInSceneTransformNodesArray||(e._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(e),e.parent||e._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(e))}removeTransformNode(e){const t=e._indexInSceneTransformNodesArray;if(-1!==t){if(t!==this.transformNodes.length-1){const e=this.transformNodes[this.transformNodes.length-1];this.transformNodes[t]=e,e._indexInSceneTransformNodesArray=t}e._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),e.parent||e._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(e),t}removeSkeleton(e){const t=this.skeletons.indexOf(e);return-1!==t&&(this.skeletons.splice(t,1),this.onSkeletonRemovedObservable.notifyObservers(e),this._executeActiveContainerCleanup(this._activeSkeletons)),t}removeMorphTargetManager(e){const t=this.morphTargetManagers.indexOf(e);return-1!==t&&this.morphTargetManagers.splice(t,1),t}removeLight(e){const t=this.lights.indexOf(e);if(-1!==t){for(const t of this.meshes)t._removeLightSource(e,!1);this.lights.splice(t,1),this.sortLightsByPriority(),e.parent||e._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(e),t}removeCamera(e){const t=this.cameras.indexOf(e);if(-1!==t&&(this.cameras.splice(t,1),e.parent||e._removeFromSceneRootNodes()),this.activeCameras){const t=this.activeCameras.indexOf(e);-1!==t&&this.activeCameras.splice(t,1)}return this.activeCamera===e&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(e),t}removeParticleSystem(e){const t=this.particleSystems.indexOf(e);return-1!==t&&(this.particleSystems.splice(t,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),t}removeAnimation(e){const t=this.animations.indexOf(e);return-1!==t&&this.animations.splice(t,1),t}stopAnimation(e,t,i){}removeAnimationGroup(e){const t=this.animationGroups.indexOf(e);return-1!==t&&this.animationGroups.splice(t,1),t}removeMultiMaterial(e){const t=this.multiMaterials.indexOf(e);return-1!==t&&this.multiMaterials.splice(t,1),this.onMultiMaterialRemovedObservable.notifyObservers(e),t}removeMaterial(e){const t=e._indexInSceneMaterialArray;if(-1!==t&&t<this.materials.length){if(t!==this.materials.length-1){const e=this.materials[this.materials.length-1];this.materials[t]=e,e._indexInSceneMaterialArray=t}e._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(e),t}removeActionManager(e){const t=this.actionManagers.indexOf(e);return-1!==t&&this.actionManagers.splice(t,1),t}removeTexture(e){const t=this.textures.indexOf(e);return-1!==t&&this.textures.splice(t,1),this.onTextureRemovedObservable.notifyObservers(e),t}addLight(e){if(!this._blockEntityCollection){this.lights.push(e),this.sortLightsByPriority(),e.parent||e._addToSceneRootNodes();for(const t of this.meshes)-1===t.lightSources.indexOf(e)&&(t.lightSources.push(e),t._resyncLightSources());this.onNewLightAddedObservable.notifyObservers(e)}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(Ui.CompareLightsPriority)}addCamera(e){this._blockEntityCollection||(this.cameras.push(e),this.onNewCameraAddedObservable.notifyObservers(e),e.parent||e._addToSceneRootNodes())}addSkeleton(e){this._blockEntityCollection||(this.skeletons.push(e),this.onNewSkeletonAddedObservable.notifyObservers(e))}addParticleSystem(e){this._blockEntityCollection||this.particleSystems.push(e)}addAnimation(e){this._blockEntityCollection||this.animations.push(e)}addAnimationGroup(e){this._blockEntityCollection||this.animationGroups.push(e)}addMultiMaterial(e){this._blockEntityCollection||(this.multiMaterials.push(e),this.onNewMultiMaterialAddedObservable.notifyObservers(e))}addMaterial(e){this._blockEntityCollection||e.getScene()===this&&-1!==e._indexInSceneMaterialArray||(e._indexInSceneMaterialArray=this.materials.length,this.materials.push(e),this.onNewMaterialAddedObservable.notifyObservers(e))}addMorphTargetManager(e){this._blockEntityCollection||this.morphTargetManagers.push(e)}addGeometry(e){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=this.geometries.length),this.geometries.push(e))}addActionManager(e){this.actionManagers.push(e)}addTexture(e){this._blockEntityCollection||(this.textures.push(e),this.onNewTextureAddedObservable.notifyObservers(e))}switchActiveCamera(e,t=!0){this._engine.getInputElement()&&(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=e,t&&e.attachControl())}setActiveCameraById(e){const t=this.getCameraById(e);return t?(this.activeCamera=t,t):null}setActiveCameraByName(e){const t=this.getCameraByName(e);return t?(this.activeCamera=t,t):null}getAnimationGroupByName(e){for(let t=0;t<this.animationGroups.length;t++)if(this.animationGroups[t].name===e)return this.animationGroups[t];return null}_getMaterial(e,t){for(let e=0;e<this.materials.length;e++){const i=this.materials[e];if(t(i))return i}if(e)for(let e=0;e<this.multiMaterials.length;e++){const i=this.multiMaterials[e];if(t(i))return i}return null}getMaterialByUniqueID(e,t=!1){return this._getMaterial(t,(t=>t.uniqueId===e))}getMaterialById(e,t=!1){return this._getMaterial(t,(t=>t.id===e))}getMaterialByName(e,t=!1){return this._getMaterial(t,(t=>t.name===e))}getLastMaterialById(e,t=!1){for(let t=this.materials.length-1;t>=0;t--)if(this.materials[t].id===e)return this.materials[t];if(t)for(let t=this.multiMaterials.length-1;t>=0;t--)if(this.multiMaterials[t].id===e)return this.multiMaterials[t];return null}getTextureByUniqueId(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].uniqueId===e)return this.textures[t];return null}getTextureByName(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].name===e)return this.textures[t];return null}getCameraById(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].id===e)return this.cameras[t];return null}getCameraByUniqueId(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].uniqueId===e)return this.cameras[t];return null}getCameraByName(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].name===e)return this.cameras[t];return null}getBoneById(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let t=0;t<i.bones.length;t++)if(i.bones[t].id===e)return i.bones[t]}return null}getBoneByName(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let t=0;t<i.bones.length;t++)if(i.bones[t].name===e)return i.bones[t]}return null}getLightByName(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].name===e)return this.lights[t];return null}getLightById(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].id===e)return this.lights[t];return null}getLightByUniqueId(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].uniqueId===e)return this.lights[t];return null}getParticleSystemById(e){for(let t=0;t<this.particleSystems.length;t++)if(this.particleSystems[t].id===e)return this.particleSystems[t];return null}getGeometryById(e){for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].id===e)return this.geometries[t];return null}_getGeometryByUniqueId(e){if(this._geometriesByUniqueId){const t=this._geometriesByUniqueId[e];if(void 0!==t)return this.geometries[t]}else for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].uniqueId===e)return this.geometries[t];return null}pushGeometry(e,t){return!(!t&&this._getGeometryByUniqueId(e.uniqueId)||(this.addGeometry(e),this.onNewGeometryAddedObservable.notifyObservers(e),0))}removeGeometry(e){let t;if(this._geometriesByUniqueId){if(t=this._geometriesByUniqueId[e.uniqueId],void 0===t)return!1}else if(t=this.geometries.indexOf(e),t<0)return!1;if(t!==this.geometries.length-1){const e=this.geometries[this.geometries.length-1];e&&(this.geometries[t]=e,this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=t))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(e),!0}getGeometries(){return this.geometries}getMeshById(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].id===e)return this.meshes[t];return null}getMeshesById(e){return this.meshes.filter((function(t){return t.id===e}))}getTransformNodeById(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getTransformNodeByUniqueId(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].uniqueId===e)return this.transformNodes[t];return null}getTransformNodesById(e){return this.transformNodes.filter((function(t){return t.id===e}))}getMeshByUniqueId(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].uniqueId===e)return this.meshes[t];return null}getLastMeshById(e){for(let t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];return null}getLastTransformNodeById(e){for(let t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getLastEntryById(e){let t;for(t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];for(t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];for(t=this.cameras.length-1;t>=0;t--)if(this.cameras[t].id===e)return this.cameras[t];for(t=this.lights.length-1;t>=0;t--)if(this.lights[t].id===e)return this.lights[t];return null}getNodeById(e){const t=this.getMeshById(e);if(t)return t;const i=this.getTransformNodeById(e);if(i)return i;const s=this.getLightById(e);if(s)return s;const r=this.getCameraById(e);if(r)return r;return this.getBoneById(e)||null}getNodeByName(e){const t=this.getMeshByName(e);if(t)return t;const i=this.getTransformNodeByName(e);if(i)return i;const s=this.getLightByName(e);if(s)return s;const r=this.getCameraByName(e);if(r)return r;return this.getBoneByName(e)||null}getMeshByName(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].name===e)return this.meshes[t];return null}getTransformNodeByName(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].name===e)return this.transformNodes[t];return null}getLastSkeletonById(e){for(let t=this.skeletons.length-1;t>=0;t--)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByUniqueId(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].uniqueId===e)return this.skeletons[t];return null}getSkeletonById(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByName(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].name===e)return this.skeletons[t];return null}getMorphTargetManagerById(e){for(let t=0;t<this.morphTargetManagers.length;t++)if(this.morphTargetManagers[t].uniqueId===e)return this.morphTargetManagers[t];return null}getMorphTargetById(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let t=0;t<i.numTargets;++t){const s=i.getTarget(t);if(s.id===e)return s}}return null}getMorphTargetByName(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let t=0;t<i.numTargets;++t){const s=i.getTarget(t);if(s.name===e)return s}}return null}getPostProcessByName(e){for(let t=0;t<this.postProcesses.length;++t){const i=this.postProcesses[t];if(i.name===e)return i}return null}isActiveMesh(e){return-1!==this._activeMeshes.indexOf(e)}get uid(){return this._uid||(this._uid=Ht.RandomId()),this._uid}addExternalData(e,t){return this._externalData||(this._externalData=new Kt),this._externalData.add(e,t)}getExternalData(e){return this._externalData?this._externalData.get(e):null}getOrAddExternalDataWithFactory(e,t){return this._externalData||(this._externalData=new Kt),this._externalData.getOrAddWithFactory(e,t)}removeExternalData(e){return this._externalData.remove(e)}_evaluateSubMesh(e,t,i,s){if(s||e.isInFrustum(this._frustumPlanes)){for(const i of this._evaluateSubMeshStage)i.action(t,e);const i=e.getMaterial();null!=i&&(i.hasRenderTargetTextures&&null!=i.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(i)&&(this._processedMaterials.push(i),this._materialsRenderTargets.concatWithNoDuplicate(i.getRenderTargetTextures())),this._renderingManager.dispatch(e,t,i))}}freeProcessedMaterials(){this._processedMaterials.dispose()}get blockfreeActiveMeshesAndRenderingGroups(){return this._preventFreeActiveMeshesAndRenderingGroups}set blockfreeActiveMeshesAndRenderingGroups(e){this._preventFreeActiveMeshesAndRenderingGroups!==e&&(e&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=e)}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(let e=0;e<this.activeCameras.length;e++){const t=this.activeCameras[e];t&&t._activeMeshes&&t._activeMeshes.dispose()}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(let e=0;e<this.textures.length;e++){const t=this.textures[e];t&&t.renderList&&t.freeRenderingGroups()}}_isInIntermediateRendering(){return this._intermediateRendering}freezeActiveMeshes(e=!1,t,i,s=!0,r=!1){return this.executeWhenReady((()=>{if(this.activeCamera){if(this._frustumPlanes||this.updateTransformMatrix(),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=r,this._skipEvaluateActiveMeshesCompletely=e,s)for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._freeze();t&&t()}else i&&i("No active camera found")})),this}unfreezeActiveMeshes(){for(let e=0;e<this.meshes.length;e++){const t=this.meshes[e];t._internalAbstractMeshDataInfo&&(t._internalAbstractMeshDataInfo._isActive=!1)}for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();return this._activeMeshesFrozen=!1,this}_executeActiveContainerCleanup(e){(!this._engine.snapshotRendering||1!==this._engine.snapshotRenderingMode)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce((()=>e.dispose()))}_evaluateActiveMeshes(){var e;if(this._engine.snapshotRendering&&1===this._engine.snapshotRenderingMode)return void(this._activeMeshes.length>0&&(null===(e=this.activeCamera)||void 0===e||e._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset()));if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely){const e=this._activeMeshes.length;for(let t=0;t<e;t++)this._activeMeshes.data[t].computeWorldMatrix()}if(this._activeParticleSystems){const e=this._activeParticleSystems.length;for(let t=0;t<e;t++)this._activeParticleSystems.data[t].animate()}return void this._renderingManager.resetSprites()}if(!this.activeCamera)return;this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(const e of this._beforeEvaluateActiveMeshStage)e.action();const t=this.getActiveMeshCandidates(),i=t.length;for(let e=0;e<i;e++){const i=t.data[e];if(i._internalAbstractMeshDataInfo._currentLODIsUpToDate=!1,i.isBlocked)continue;if(this._totalVertices.addCount(i.getTotalVertices(),!1),!i.isReady()||!i.isEnabled()||i.scaling.hasAZeroComponent)continue;i.computeWorldMatrix(),i.actionManager&&i.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(i);let s=this.customLODSelector?this.customLODSelector(i,this.activeCamera):i.getLOD(this.activeCamera);if(i._internalAbstractMeshDataInfo._currentLOD=s,i._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0,null!=s&&(s!==i&&0!==s.billboardMode&&s.computeWorldMatrix(),i._preActivate(),i.isVisible&&i.visibility>0&&i.layerMask&this.activeCamera.layerMask&&(this._skipFrustumClipping||i.alwaysSelectAsActiveMesh||i.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(i),this.activeCamera._activeMeshes.push(i),s!==i&&s._activate(this._renderId,!1);for(const e of this._preActiveMeshStage)e.action(i);i._activate(this._renderId,!1)&&(i.isAnInstance?i._internalAbstractMeshDataInfo._actAsRegularMesh&&(s=i):s._internalAbstractMeshDataInfo._onlyForInstances=!1,s._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(i,s)),i._postActivate()}}if(this.onAfterActiveMeshesEvaluationObservable.notifyObservers(this),this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let e=0;e<this.particleSystems.length;e++){const t=this.particleSystems[e];if(!t.isStarted()||!t.emitter)continue;const i=t.emitter;i.position&&!i.isEnabled()||(this._activeParticleSystems.push(t),t.animate(),this._renderingManager.dispatchParticles(t))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}_activeMesh(e,t){this._skeletonsEnabled&&null!==t.skeleton&&void 0!==t.skeleton&&(this._activeSkeletons.pushNoDuplicate(t.skeleton)&&(t.skeleton.prepare(),this._activeBones.addCount(t.skeleton.bones.length,!1)),t.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(t));let i=e.hasInstances||e.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||t.alwaysSelectAsActiveMesh;if(t&&t.subMeshes&&t.subMeshes.length>0){const s=this.getActiveSubMeshCandidates(t),r=s.length;i=i||1===r;for(let n=0;n<r;n++){const r=s.data[n];this._evaluateSubMesh(r,t,e,i)}}}updateTransformMatrix(e){const t=this.activeCamera;if(t)if(t._renderingMultiview){const i=t._rigCameras[0],s=t._rigCameras[1];this.setTransformMatrix(i.getViewMatrix(),i.getProjectionMatrix(e),s.getViewMatrix(),s.getProjectionMatrix(e))}else this.setTransformMatrix(t.getViewMatrix(),t.getProjectionMatrix(e))}_bindFrameBuffer(e,t=!0){e&&e._multiviewTexture?e._multiviewTexture._bindFrameBuffer():e&&e.outputRenderTarget?e.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer(),t&&this._clearFrameBuffer(e)}_clearFrameBuffer(e){if(e&&e._multiviewTexture);else if(e&&e.outputRenderTarget&&!e._renderingMultiview){const t=e.outputRenderTarget;t.onClearObservable.hasObservers()?t.onClearObservable.notifyObservers(this._engine):t.skipInitialClear||(this.autoClear&&this._engine.clear(t.clearColor||this.clearColor,!t._cleared,!0,!0),t._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())}_renderForCamera(e,t,i=!0){var s,r,n;if(e&&e._skipRendering)return;const o=this._engine;if(this._activeCamera=e,!this.activeCamera)throw new Error("Active camera not set");if(o.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&i){let t=!0;e._renderingMultiview&&e.outputRenderTarget&&(t=e.outputRenderTarget.skipInitialClear,this.autoClear&&(this._defaultFrameBufferCleared=!1,e.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),e._renderingMultiview&&e.outputRenderTarget&&(e.outputRenderTarget.skipInitialClear=t)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(let e=0;e<this._softwareSkinnedMeshes.length;e++){const t=this._softwareSkinnedMeshes.data[e];t.applySkeleton(t.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),e.customRenderTargets&&e.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(e.customRenderTargets),t&&t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(const e of this._gatherActiveCameraRenderTargetsStage)e.action(this._renderTargets);let a=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){Ht.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(let e=0;e<this._renderTargets.length;e++){const t=this._renderTargets.data[e];if(t._shouldRender()){this._renderId++;const e=t.activeCamera&&t.activeCamera!==this.activeCamera;t.render(e,this.dumpNextRenderTargets),a=!0}}Ht.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}for(const e of this._cameraDrawRenderTargetStage)a=e.action(this.activeCamera)||a;this._intermediateRendering=!1}this._engine.currentRenderPassId=null!==(n=null!==(r=null===(s=e.outputRenderTarget)||void 0===s?void 0:s.renderPassId)&&void 0!==r?r:e.renderPassId)&&void 0!==n?n:0,a&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),!this.postProcessManager||e._multiviewTexture||this.prePass||this.postProcessManager._prepareFrame();for(const e of this._beforeCameraDrawStage)e.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this),o.snapshotRendering&&1===o.snapshotRenderingMode&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);for(const e of this._afterCameraDrawStage)e.action(this.activeCamera);if(this.postProcessManager&&!e._multiviewTexture){const t=e.outputRenderTarget?e.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(e.isIntermediate,t)}for(const e of this._afterCameraPostProcessStage)e.action(this.activeCamera);this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}_processSubCameras(e,t=!0){if(0===e.cameraRigMode||e._renderingMultiview)return e._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(e,void 0,t),void this.onAfterRenderCameraObservable.notifyObservers(e);if(e._useMultiviewToSingleView)this._renderMultiviewToSingleView(e);else{this.onBeforeCameraRenderObservable.notifyObservers(e);for(let t=0;t<e._rigCameras.length;t++)this._renderForCamera(e._rigCameras[t],e)}this._activeCamera=e,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(e)}_checkIntersections(){for(let e=0;e<this._meshesForIntersections.length;e++){const t=this._meshesForIntersections.data[e];if(t.actionManager)for(let e=0;t.actionManager&&e<t.actionManager.actions.length;e++){const i=t.actionManager.actions[e];if(12===i.trigger||13===i.trigger){const e=i.getTriggerParameter(),s=e.mesh?e.mesh:e,r=s.intersectsMesh(t,e.usePreciseIntersection),n=t._intersectionsInProgress.indexOf(s);r&&-1===n?12===i.trigger?(i._executeCurrent(B.CreateNew(t,void 0,s)),t._intersectionsInProgress.push(s)):13===i.trigger&&t._intersectionsInProgress.push(s):!r&&n>-1&&(13===i.trigger&&i._executeCurrent(B.CreateNew(t,void 0,s)),t.actionManager.hasSpecificTrigger(13,(e=>{const t=e.mesh?e.mesh:e;return s===t}))&&13!==i.trigger||t._intersectionsInProgress.splice(n,1))}}}}_advancePhysicsEngineStep(e){}_animate(){}animate(){if(this._engine.isDeterministicLockStep()){let e=Math.max(Yi.MinDeltaTime,Math.min(this._engine.getDeltaTime(),Yi.MaxDeltaTime))+this._timeAccumulator;const t=this._engine.getTimeStep(),i=1e3/t/1e3;let s=0;const r=this._engine.getLockstepMaxSteps();let n=Math.floor(e/t);for(n=Math.min(n,r);e>0&&s<n;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=t*i,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,s++,e-=t;this._timeAccumulator=e<0?0:e}else{const e=this.useConstantAnimationDeltaTime?16:Math.max(Yi.MinDeltaTime,Math.min(this._engine.getDeltaTime(),Yi.MaxDeltaTime));this._animationRatio=.06*e,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(e)}}_clear(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}_checkCameraRenderTarget(e){var t;if((null==e?void 0:e.outputRenderTarget)&&!(null==e?void 0:e.isRigCamera)&&(e.outputRenderTarget._cleared=!1),null===(t=null==e?void 0:e.rigCameras)||void 0===t?void 0:t.length)for(let t=0;t<e.rigCameras.length;++t){const i=e.rigCameras[t].outputRenderTarget;i&&(i._cleared=!1)}}resetDrawCache(e){if(this.meshes)for(const t of this.meshes)t.resetDrawCache(e)}render(e=!0,t=!1){var i,s,r;if(this.isDisposed)return;this.onReadyObservable.hasObservers()&&null===this._executeWhenReadyTimeoutId&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),(null===(i=this.activeCameras)||void 0===i?void 0:i.length)&&this.activeCameras.forEach(this._checkCameraRenderTarget),this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),t||this.animate();for(const e of this._beforeCameraUpdateStage)e.action();if(e)if(this.activeCameras&&this.activeCameras.length>0)for(let e=0;e<this.activeCameras.length;e++){const t=this.activeCameras[e];if(t.update(),0!==t.cameraRigMode)for(let e=0;e<t._rigCameras.length;e++)t._rigCameras[e].update()}else if(this.activeCamera&&(this.activeCamera.update(),0!==this.activeCamera.cameraRigMode))for(let e=0;e<this.activeCamera._rigCameras.length;e++)this.activeCamera._rigCameras[e].update();this.onBeforeRenderObservable.notifyObservers(this);const n=this.getEngine();this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);const o=(null===(s=this.activeCameras)||void 0===s?void 0:s.length)?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){Ht.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!0;for(let e=0;e<this.customRenderTargets.length;e++){const t=this.customRenderTargets[e];if(t._shouldRender()){if(this._renderId++,this.activeCamera=t.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");n.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),t.render(o!==this.activeCamera,this.dumpNextRenderTargets)}}Ht.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!1,this._renderId++}this._engine.currentRenderPassId=null!==(r=null==o?void 0:o.renderPassId)&&void 0!==r?r:0,this.activeCamera=o,this._activeCamera&&22!==this._activeCamera.cameraRigMode&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(const e of this._beforeClearStage)e.action();this._clearFrameBuffer(this.activeCamera);for(const e of this._gatherRenderTargetsStage)e.action(this._renderTargets);if(this.activeCameras&&this.activeCameras.length>0)for(let e=0;e<this.activeCameras.length;e++)this._processSubCameras(this.activeCameras[e],e>0);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}this._checkIntersections();for(const e of this._afterRenderStage)e.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(let e=0;e<this._toBeDisposed.length;e++){const t=this._toBeDisposed[e];t&&t.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}freezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].freeze()}unfreezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].unfreeze()}dispose(){if(this.isDisposed)return;this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=[],this.stopAllAnimations&&(this._activeAnimatables.forEach((e=>{e.onAnimationEndObservable.clear(),e.onAnimationEnd=null})),this.stopAllAnimations()),this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0;const e=this._activeRequests.slice();for(const t of e)t.abort();this._activeRequests.length=0;try{this.onDisposeObservable.notifyObservers(this)}catch(e){console.error("An error occurred while calling onDisposeObservable!",e)}if(this.detachControl(),this._engine.getInputElement())for(let e=0;e<this.cameras.length;e++)this.cameras[e].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._disposeList(this.meshes,(e=>e.dispose(!0))),this._disposeList(this.transformNodes,(e=>e.dispose(!0)));const t=this.cameras;this._disposeList(t),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);let i=this._engine.scenes.indexOf(this);i>-1&&this._engine.scenes.splice(i,1),x._LastCreatedScene===this&&(this._engine.scenes.length>0?x._LastCreatedScene=this._engine.scenes[this._engine.scenes.length-1]:x._LastCreatedScene=null),i=this._engine._virtualScenes.indexOf(this),i>-1&&this._engine._virtualScenes.splice(i,1),this._engine.wipeCaches(!0),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onAfterRenderCameraObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onScenePerformancePriorityChangedObservable.clear(),this._isDisposed=!0}_disposeList(e,t){const i=e.slice(0);t=null!=t?t:e=>e.dispose();for(const e of i)t(e);e.length=0}get isDisposed(){return this._isDisposed}clearCachedVertexData(){for(let e=0;e<this.meshes.length;e++){const t=this.meshes[e].geometry;t&&t.clearCachedData()}}cleanCachedTextureBuffer(){for(const e of this.textures)e._buffer&&(e._buffer=null)}getWorldExtends(e){const t=new S(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i=new S(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return e=e||(()=>!0),this.meshes.filter(e).forEach((e=>{if(e.computeWorldMatrix(!0),!e.subMeshes||0===e.subMeshes.length||e.infiniteDistance)return;const s=e.getBoundingInfo(),r=s.boundingBox.minimumWorld,n=s.boundingBox.maximumWorld;S.CheckExtends(r,t,i),S.CheckExtends(n,t,i)})),{min:t,max:i}}createPickingRay(e,t,i,s,r=!1){throw $("Ray")}createPickingRayToRef(e,t,i,s,r,n=!1,o=!1){throw $("Ray")}createPickingRayInCameraSpace(e,t,i){throw $("Ray")}createPickingRayInCameraSpaceToRef(e,t,i,s){throw $("Ray")}get _pickingAvailable(){return!1}pick(e,t,i,s,r,n){const o=$("Ray",!0);return o&&k.Warn(o),new ci}pickWithBoundingInfo(e,t,i,s,r){const n=$("Ray",!0);return n&&k.Warn(n),new ci}pickWithRay(e,t,i,s){throw $("Ray")}multiPick(e,t,i,s,r){throw $("Ray")}multiPickWithRay(e,t,i){throw $("Ray")}setPointerOverMesh(e,t,i){this._inputManager.setPointerOverMesh(e,t,i)}getPointerOverMesh(){return this._inputManager.getPointerOverMesh()}_rebuildGeometries(){for(const e of this.geometries)e._rebuild();for(const e of this.meshes)e._rebuild();this.postProcessManager&&this.postProcessManager._rebuild();for(const e of this._components)e.rebuild();for(const e of this.particleSystems)e.rebuild();if(this.spriteManagers)for(const e of this.spriteManagers)e.rebuild()}_rebuildTextures(){for(const e of this.textures)e._rebuild();this.markAllMaterialsAsDirty(1)}_getByTags(e,t,i){if(void 0===t)return e;const s=[];for(const r in e){const n=e[r];j&&j.MatchesQuery(n,t)&&(!i||i(n))&&s.push(n)}return s}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}setRenderingOrder(e,t=null,i=null,s=null){this._renderingManager.setRenderingOrder(e,t,i,s)}setRenderingAutoClearDepthStencil(e,t,i=!0,s=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,i,s)}getAutoClearDepthStencilSetup(e){return this._renderingManager.getAutoClearDepthStencilSetup(e)}_forceBlockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism=e}get blockMaterialDirtyMechanism(){return this._blockMaterialDirtyMechanism}set blockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism!==e&&(this._blockMaterialDirtyMechanism=e,e||this.markAllMaterialsAsDirty(63))}markAllMaterialsAsDirty(e,t){if(!this._blockMaterialDirtyMechanism)for(const i of this.materials)t&&!t(i)||i.markAsDirty(e)}_loadFile(e,t,i,s,r,n,o){const a=Ft(e,t,i,s?this.offlineProvider:void 0,r,n,o);return this._activeRequests.push(a),a.onCompleteObservable.add((e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)})),a}_loadFileAsync(e,t,i,s,r){return new Promise(((n,o)=>{this._loadFile(e,(e=>{n(e)}),t,i,s,((e,t)=>{o(t)}),r)}))}_requestFile(e,t,i,s,r,n,o){const a=wt(e,t,i,s?this.offlineProvider:void 0,r,n,o);return this._activeRequests.push(a),a.onCompleteObservable.add((e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)})),a}_requestFileAsync(e,t,i,s,r){return new Promise(((n,o)=>{this._requestFile(e,(e=>{n(e)}),t,i,s,(e=>{o(e)}),r)}))}_readFile(e,t,i,s,r){const n=Nt(e,t,i,s,r);return this._activeRequests.push(n),n.onCompleteObservable.add((e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)})),n}_readFileAsync(e,t,i){return new Promise(((s,r)=>{this._readFile(e,(e=>{s(e)}),t,i,(e=>{r(e)}))}))}getPerfCollector(){throw $("performanceViewerSceneExtension")}setActiveCameraByID(e){return this.setActiveCameraById(e)}getMaterialByID(e){return this.getMaterialById(e)}getLastMaterialByID(e){return this.getLastMaterialById(e)}getTextureByUniqueID(e){return this.getTextureByUniqueId(e)}getCameraByID(e){return this.getCameraById(e)}getCameraByUniqueID(e){return this.getCameraByUniqueId(e)}getBoneByID(e){return this.getBoneById(e)}getLightByID(e){return this.getLightById(e)}getLightByUniqueID(e){return this.getLightByUniqueId(e)}getParticleSystemByID(e){return this.getParticleSystemById(e)}getGeometryByID(e){return this.getGeometryById(e)}getMeshByID(e){return this.getMeshById(e)}getMeshByUniqueID(e){return this.getMeshByUniqueId(e)}getLastMeshByID(e){return this.getLastMeshById(e)}getMeshesByID(e){return this.getMeshesById(e)}getTransformNodeByID(e){return this.getTransformNodeById(e)}getTransformNodeByUniqueID(e){return this.getTransformNodeByUniqueId(e)}getTransformNodesByID(e){return this.getTransformNodesById(e)}getNodeByID(e){return this.getNodeById(e)}getLastEntryByID(e){return this.getLastEntryById(e)}getLastSkeletonByID(e){return this.getLastSkeletonById(e)}}Yi.FOGMODE_NONE=0,Yi.FOGMODE_EXP=1,Yi.FOGMODE_EXP2=2,Yi.FOGMODE_LINEAR=3,Yi.MinDeltaTime=1,Yi.MaxDeltaTime=1e3,(Xi=Gi||(Gi={}))[Xi.LOCAL=0]="LOCAL",Xi[Xi.WORLD=1]="WORLD",Xi[Xi.BONE=2]="BONE";class ji{}ji.X=new S(1,0,0),ji.Y=new S(0,1,0),ji.Z=new S(0,0,1),function(e){e[e.X=0]="X",e[e.Y=1]="Y",e[e.Z=2]="Z"}(zi||(zi={}));class Ki extends ve{get _matrix(){return this._compose(),this._localMatrix}set _matrix(e){(e.updateFlag!==this._localMatrix.updateFlag||this._needToCompose)&&(this._needToCompose=!1,this._localMatrix.copyFrom(e),this._markAsDirtyAndDecompose())}constructor(e,t,i=null,s=null,r=null,n=null,o=null){var a;super(e,t.getScene()),this.name=e,this.children=[],this.animations=[],this._index=null,this._scalingDeterminant=1,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=t,this._localMatrix=null!==(a=null==s?void 0:s.clone())&&void 0!==a?a:y.Identity(),this._restMatrix=null!=r?r:this._localMatrix.clone(),this._bindMatrix=null!=n?n:this._localMatrix.clone(),this._index=o,this._absoluteMatrix=new y,this._absoluteBindMatrix=new y,this._absoluteInverseBindMatrix=new y,this._finalMatrix=new y,t.bones.push(this),this.setParent(i,!1),this._updateAbsoluteBindMatrices()}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return null===this._index?this.getSkeleton().bones.indexOf(this):this._index}set parent(e){this.setParent(e)}setParent(e,t=!0){if(this.parent!==e){if(this.parent){const e=this.parent.children.indexOf(this);-1!==e&&this.parent.children.splice(e,1)}this._parentNode=e,this.parent&&this.parent.children.push(this),t&&this._updateAbsoluteBindMatrices(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBindMatrix(){return this._bindMatrix}getBaseMatrix(){return this.getBindMatrix()}getRestMatrix(){return this._restMatrix}getRestPose(){return this.getRestMatrix()}setRestMatrix(e){this._restMatrix.copyFrom(e)}setRestPose(e){this.setRestMatrix(e)}getBindPose(){return this.getBindMatrix()}setBindMatrix(e){this.updateMatrix(e)}setBindPose(e){this.setBindMatrix(e)}getFinalMatrix(){return this._finalMatrix}getWorldMatrix(){return this.getFinalMatrix()}returnToRest(){var e;if(this._linkedTransformNode){const t=R.Vector3[0],i=R.Quaternion[0],s=R.Vector3[1];this.getRestMatrix().decompose(t,i,s),this._linkedTransformNode.position.copyFrom(s),this._linkedTransformNode.rotationQuaternion=null!==(e=this._linkedTransformNode.rotationQuaternion)&&void 0!==e?e:C.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(i),this._linkedTransformNode.scaling.copyFrom(t)}else this._matrix=this._restMatrix}getAbsoluteInverseBindMatrix(){return this._absoluteInverseBindMatrix}getInvertedAbsoluteTransform(){return this.getAbsoluteInverseBindMatrix()}getAbsoluteMatrix(){return this._absoluteMatrix}getAbsoluteTransform(){return this._absoluteMatrix}linkTransformNode(e){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(e){this._decompose(),this._localPosition.copyFrom(e),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(e){this.setRotation(e)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(e){this.setRotationQuaternion(e)}get scaling(){return this.getScale()}set scaling(e){this.setScale(e)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){this._needToDecompose&&(this._needToDecompose=!1,this._localScaling||(this._localScaling=S.Zero(),this._localRotation=C.Zero(),this._localPosition=S.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){this._needToCompose&&(this._localScaling?(this._needToCompose=!1,y.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)):this._needToCompose=!1)}updateMatrix(e,t=!0,i=!0){this._bindMatrix.copyFrom(e),t&&this._updateAbsoluteBindMatrices(),i?this._matrix=e:this.markAsDirty()}_updateAbsoluteBindMatrices(e,t=!0){if(e||(e=this._bindMatrix),this.parent?e.multiplyToRef(this.parent._absoluteBindMatrix,this._absoluteBindMatrix):this._absoluteBindMatrix.copyFrom(e),this._absoluteBindMatrix.invertToRef(this._absoluteInverseBindMatrix),t)for(let e=0;e<this.children.length;e++)this.children[e]._updateAbsoluteBindMatrices();this._scalingDeterminant=this._absoluteBindMatrix.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}_updatePosition(e,t=Gi.LOCAL,i,s=!0){const r=this.getLocalMatrix();if(t==Gi.LOCAL)s?(r.addAtIndex(12,e.x),r.addAtIndex(13,e.y),r.addAtIndex(14,e.z)):r.setTranslationFromFloats(e.x,e.y,e.z);else{let t=null;i&&(t=i.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const n=Ki._TmpMats[0],o=Ki._TmpVecs[0];this.parent?i&&t?(n.copyFrom(this.parent.getAbsoluteMatrix()),n.multiplyToRef(t,n)):n.copyFrom(this.parent.getAbsoluteMatrix()):y.IdentityToRef(n),s&&n.setTranslationFromFloats(0,0,0),n.invert(),S.TransformCoordinatesToRef(e,n,o),s?(r.addAtIndex(12,o.x),r.addAtIndex(13,o.y),r.addAtIndex(14,o.z)):r.setTranslationFromFloats(o.x,o.y,o.z)}this._markAsDirtyAndDecompose()}translate(e,t=Gi.LOCAL,i){this._updatePosition(e,t,i,!0)}setPosition(e,t=Gi.LOCAL,i){this._updatePosition(e,t,i,!1)}setAbsolutePosition(e,t){this.setPosition(e,Gi.WORLD,t)}scale(e,t,i,s=!1){const r=this.getLocalMatrix(),n=Ki._TmpMats[0];y.ScalingToRef(e,t,i,n),n.multiplyToRef(r,r),n.invert();for(const s of this.children){const r=s.getLocalMatrix();r.multiplyToRef(n,r),r.multiplyAtIndex(12,e),r.multiplyAtIndex(13,t),r.multiplyAtIndex(14,i),s._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),s)for(const r of this.children)r.scale(e,t,i,s)}setScale(e){this._decompose(),this._localScaling.copyFrom(e),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(e){this._decompose(),e.copyFrom(this._localScaling)}setYawPitchRoll(e,t,i,s=Gi.LOCAL,r){if(s===Gi.LOCAL){const n=Ki._TmpQuat;return C.RotationYawPitchRollToRef(e,t,i,n),void this.setRotationQuaternion(n,s,r)}const n=Ki._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(n,r))return;const o=Ki._TmpMats[1];y.RotationYawPitchRollToRef(e,t,i,o),n.multiplyToRef(o,o),this._rotateWithMatrix(o,s,r)}rotate(e,t,i=Gi.LOCAL,s){const r=Ki._TmpMats[0];r.setTranslationFromFloats(0,0,0),y.RotationAxisToRef(e,t,r),this._rotateWithMatrix(r,i,s)}setAxisAngle(e,t,i=Gi.LOCAL,s){if(i===Gi.LOCAL){const r=Ki._TmpQuat;return C.RotationAxisToRef(e,t,r),void this.setRotationQuaternion(r,i,s)}const r=Ki._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(r,s))return;const n=Ki._TmpMats[1];y.RotationAxisToRef(e,t,n),r.multiplyToRef(n,n),this._rotateWithMatrix(n,i,s)}setRotation(e,t=Gi.LOCAL,i){this.setYawPitchRoll(e.y,e.x,e.z,t,i)}setRotationQuaternion(e,t=Gi.LOCAL,i){if(t===Gi.LOCAL)return this._decompose(),this._localRotation.copyFrom(e),void this._markAsDirtyAndCompose();const s=Ki._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,i))return;const r=Ki._TmpMats[1];y.FromQuaternionToRef(e,r),s.multiplyToRef(r,r),this._rotateWithMatrix(r,t,i)}setRotationMatrix(e,t=Gi.LOCAL,i){if(t===Gi.LOCAL){const s=Ki._TmpQuat;return C.FromRotationMatrixToRef(e,s),void this.setRotationQuaternion(s,t,i)}const s=Ki._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,i))return;const r=Ki._TmpMats[1];r.copyFrom(e),s.multiplyToRef(e,r),this._rotateWithMatrix(r,t,i)}_rotateWithMatrix(e,t=Gi.LOCAL,i){const s=this.getLocalMatrix(),r=s.m[12],n=s.m[13],o=s.m[14],a=this.getParent(),l=Ki._TmpMats[3],h=Ki._TmpMats[4];a&&t==Gi.WORLD?(i?(l.copyFrom(i.getWorldMatrix()),a.getAbsoluteMatrix().multiplyToRef(l,l)):l.copyFrom(a.getAbsoluteMatrix()),h.copyFrom(l),h.invert(),s.multiplyToRef(l,s),s.multiplyToRef(e,s),s.multiplyToRef(h,s)):t==Gi.WORLD&&i?(l.copyFrom(i.getWorldMatrix()),h.copyFrom(l),h.invert(),s.multiplyToRef(l,s),s.multiplyToRef(e,s),s.multiplyToRef(h,s)):s.multiplyToRef(e,s),s.setTranslationFromFloats(r,n,o),this.computeAbsoluteMatrices(),this._markAsDirtyAndDecompose()}_getAbsoluteInverseMatrixUnscaledToRef(e,t){const i=Ki._TmpMats[2];return e.copyFrom(this.getAbsoluteMatrix()),t?(e.multiplyToRef(t.getWorldMatrix(),e),y.ScalingToRef(t.scaling.x,t.scaling.y,t.scaling.z,i)):y.IdentityToRef(i),e.invert(),!isNaN(e.m[0])&&(i.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyToRef(i,e),!0)}getPosition(e=Gi.LOCAL,t=null){const i=S.Zero();return this.getPositionToRef(e,t,i),i}getPositionToRef(e=Gi.LOCAL,t,i){if(e==Gi.LOCAL){const e=this.getLocalMatrix();i.x=e.m[12],i.y=e.m[13],i.z=e.m[14]}else{let e=null;t&&(e=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let s=Ki._TmpMats[0];t&&e?(s.copyFrom(this.getAbsoluteMatrix()),s.multiplyToRef(e,s)):s=this.getAbsoluteMatrix(),i.x=s.m[12],i.y=s.m[13],i.z=s.m[14]}}getAbsolutePosition(e=null){const t=S.Zero();return this.getPositionToRef(Gi.WORLD,e,t),t}getAbsolutePositionToRef(e,t){this.getPositionToRef(Gi.WORLD,e,t)}computeAbsoluteMatrices(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteMatrix,this._absoluteMatrix);else{this._absoluteMatrix.copyFrom(this._localMatrix);const e=this._skeleton.getPoseMatrix();e&&this._absoluteMatrix.multiplyToRef(e,this._absoluteMatrix)}const e=this.children,t=e.length;for(let i=0;i<t;i++)e[i].computeAbsoluteMatrices()}computeAbsoluteTransforms(){this.computeAbsoluteMatrices()}getDirection(e,t=null){const i=S.Zero();return this.getDirectionToRef(e,t,i),i}getDirectionToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const r=Ki._TmpMats[0];r.copyFrom(this.getAbsoluteMatrix()),t&&s&&r.multiplyToRef(s,r),S.TransformNormalToRef(e,r,i),i.normalize()}getRotation(e=Gi.LOCAL,t=null){const i=S.Zero();return this.getRotationToRef(e,t,i),i}getRotationToRef(e=Gi.LOCAL,t=null,i){const s=Ki._TmpQuat;this.getRotationQuaternionToRef(e,t,s),s.toEulerAnglesToRef(i)}getRotationQuaternion(e=Gi.LOCAL,t=null){const i=C.Identity();return this.getRotationQuaternionToRef(e,t,i),i}getRotationQuaternionToRef(e=Gi.LOCAL,t=null,i){if(e==Gi.LOCAL)this._decompose(),i.copyFrom(this._localRotation);else{const e=Ki._TmpMats[0],s=this.getAbsoluteMatrix();t?s.multiplyToRef(t.getWorldMatrix(),e):e.copyFrom(s),e.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyAtIndex(1,this._scalingDeterminant),e.multiplyAtIndex(2,this._scalingDeterminant),e.decompose(void 0,i,void 0)}}getRotationMatrix(e=Gi.LOCAL,t){const i=y.Identity();return this.getRotationMatrixToRef(e,t,i),i}getRotationMatrixToRef(e=Gi.LOCAL,t,i){if(e==Gi.LOCAL)this.getLocalMatrix().getRotationMatrixToRef(i);else{const e=Ki._TmpMats[0],s=this.getAbsoluteMatrix();t?s.multiplyToRef(t.getWorldMatrix(),e):e.copyFrom(s),e.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyAtIndex(1,this._scalingDeterminant),e.multiplyAtIndex(2,this._scalingDeterminant),e.getRotationMatrixToRef(i)}}getAbsolutePositionFromLocal(e,t=null){const i=S.Zero();return this.getAbsolutePositionFromLocalToRef(e,t,i),i}getAbsolutePositionFromLocalToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const r=Ki._TmpMats[0];r.copyFrom(this.getAbsoluteMatrix()),t&&s&&r.multiplyToRef(s,r),S.TransformCoordinatesToRef(e,r,i)}getLocalPositionFromAbsolute(e,t=null){const i=S.Zero();return this.getLocalPositionFromAbsoluteToRef(e,t,i),i}getLocalPositionFromAbsoluteToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const r=Ki._TmpMats[0];r.copyFrom(this.getAbsoluteMatrix()),t&&s&&r.multiplyToRef(s,r),r.invert(),S.TransformCoordinatesToRef(e,r,i)}setCurrentPoseAsRest(){this.setRestMatrix(this.getLocalMatrix())}}Ki._TmpVecs=d.BuildArray(2,S.Zero),Ki._TmpQuat=C.Identity(),Ki._TmpMats=d.BuildArray(5,y.Identity);class $i{get syncRoot(){return this._syncRoot}get masterFrame(){return 0===this._runtimeAnimations.length?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){this._weight=-1!==e?Math.min(Math.max(e,0),1):-1}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let t=0;t<this._runtimeAnimations.length;t++)this._runtimeAnimations[t]._prepareForSpeedRatioChange(e);this._speedRatio=e,null!==this._goToFrame&&this.goToFrame(this._goToFrame)}get elapsedTime(){return null===this._localDelayOffset?0:this._scene._animationTime-this._localDelayOffset}constructor(e,t,i=0,s=100,r=!1,n=1,o,l,h,c=!1,u=0){this.target=t,this.fromFrame=i,this.toFrame=s,this.loopAnimation=r,this.onAnimationEnd=o,this.onAnimationLoop=h,this.isAdditive=c,this.playOrder=u,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new a,this.onAnimationLoopObservable=new a,this._scene=e,l&&this.appendAnimations(t,l),this._speedRatio=n,e._activeAnimatables.push(this)}syncWith(e){if(this._syncRoot=e,e){const e=this._scene._activeAnimatables.indexOf(this);e>-1&&(this._scene._activeAnimatables.splice(e,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,t){for(let i=0;i<t.length;i++){const s=t[i],r=new Pe(e,s,this._scene,this);r._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(r)}}getAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i].animation;return null}getRuntimeAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i];return null}reset(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)t[i].animation.enableBlending=!0,t[i].animation.blendingSpeed=e}disableBlending(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].animation.enableBlending=!1}goToFrame(e){var t;const i=this._runtimeAnimations;if(i[0]){const s=i[0].animation.framePerSecond;this._frameToSyncFromJump=null!==(t=this._frameToSyncFromJump)&&void 0!==t?t:i[0].currentFrame;const r=0===this.speedRatio?0:(e-this._frameToSyncFromJump)/s*1e3/this.speedRatio;this._manualJumpDelay=-r}for(let t=0;t<i.length;t++)i[t].goToFrame(e);this._goToFrame=e}get paused(){return this._paused}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,t,i=!1){if(e||t){const s=this._scene._activeAnimatables.indexOf(this);if(s>-1){const r=this._runtimeAnimations;for(let i=r.length-1;i>=0;i--){const s=r[i];e&&s.animation.name!=e||t&&!t(s.target)||(s.dispose(),r.splice(i,1))}0==r.length&&(i||this._scene._activeAnimatables.splice(s,1),this._raiseOnAnimationEnd())}}else{const e=this._scene._activeAnimatables.indexOf(this);if(e>-1){i||this._scene._activeAnimatables.splice(e,1);const t=this._runtimeAnimations;for(let e=0;e<t.length;e++)t[e].dispose();this._runtimeAnimations.length=0,this._raiseOnAnimationEnd()}}}waitAsync(){return new Promise((e=>{this.onAnimationEndObservable.add((()=>{e(this)}),void 0,void 0,this,!0)}))}_animate(e){if(this._paused)return this.animationStarted=!1,null===this._pausedDelay&&(this._pausedDelay=e),!0;if(null===this._localDelayOffset?(this._localDelayOffset=e,this._pausedDelay=null):null!==this._pausedDelay&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),null!==this._manualJumpDelay&&(this._localDelayOffset+=this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,0===this._weight)return!0;let t=!1;const i=this._runtimeAnimations;let s;for(s=0;s<i.length;s++){const r=i[s].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);t=t||r}if(this.animationStarted=t,!t){if(this.disposeOnEnd)for(s=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(s,1),s=0;s<i.length;s++)i[s].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return t}}Yi.prototype._animate=function(){if(!this.animationsEnabled)return;const e=Fe.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=e}this.deltaTime=this.useConstantAnimationDeltaTime?16:(e-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=e;const t=this._activeAnimatables;if(0===t.length)return;this._animationTime+=this.deltaTime;const i=this._animationTime;for(let e=0;e<t.length;e++){const s=t[e];!s._animate(i)&&s.disposeOnEnd&&e--}this._processLateAnimationBindings()},Yi.prototype.sortActiveAnimatables=function(){this._activeAnimatables.sort(((e,t)=>e.playOrder-t.playOrder))},Yi.prototype.beginWeightedAnimation=function(e,t,i,s=1,r,n=1,o,a,l,h,c=!1){const u=this.beginAnimation(e,t,i,r,n,o,a,!1,l,h,c);return u.weight=s,u},Yi.prototype.beginAnimation=function(e,t,i,s,r=1,n,o,a=!0,l,h,c=!1){t>i&&r>0&&(r*=-1),a&&this.stopAnimation(e,void 0,l),o||(o=new $i(this,e,t,i,s,r,n,void 0,h,c));const u=!l||l(e);if(e.animations&&u&&o.appendAnimations(e,e.animations),e.getAnimatables){const c=e.getAnimatables();for(let e=0;e<c.length;e++)this.beginAnimation(c[e],t,i,s,r,n,o,a,l,h)}return o.reset(),o},Yi.prototype.beginHierarchyAnimation=function(e,t,i,s,r,n=1,o,a,l=!0,h,c,u=!1){const d=e.getDescendants(t),p=[];p.push(this.beginAnimation(e,i,s,r,n,o,a,l,h,void 0,u));for(const e of d)p.push(this.beginAnimation(e,i,s,r,n,o,a,l,h,void 0,u));return p},Yi.prototype.beginDirectAnimation=function(e,t,i,s,r,n,o,a,l=!1){if(void 0===n&&(n=1),i>s&&n>0)n*=-1;else if(s>i&&n<0){const e=s;s=i,i=e}return new $i(this,e,i,s,r,n,o,t,a,l)},Yi.prototype.beginDirectHierarchyAnimation=function(e,t,i,s,r,n,o,a,l,h=!1){const c=e.getDescendants(t),u=[];u.push(this.beginDirectAnimation(e,i,s,r,n,o,a,l,h));for(const e of c)u.push(this.beginDirectAnimation(e,i,s,r,n,o,a,l,h));return u},Yi.prototype.getAnimatableByTarget=function(e){for(let t=0;t<this._activeAnimatables.length;t++)if(this._activeAnimatables[t].target===e)return this._activeAnimatables[t];return null},Yi.prototype.getAllAnimatablesByTarget=function(e){const t=[];for(let i=0;i<this._activeAnimatables.length;i++)this._activeAnimatables[i].target===e&&t.push(this._activeAnimatables[i]);return t},Yi.prototype.stopAnimation=function(e,t,i){const s=this.getAllAnimatablesByTarget(e);for(const e of s)e.stop(t,i)},Yi.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let e=0;e<this._activeAnimatables.length;e++)this._activeAnimatables[e].stop(void 0,void 0,!0);this._activeAnimatables.length=0}for(const e of this.animationGroups)e.stop()},Yi.prototype._registerTargetForLateAnimationBinding=function(e,t){const i=e.target;this._registeredForLateAnimationBindings.pushNoDuplicate(i),i._lateAnimationHolders||(i._lateAnimationHolders={}),i._lateAnimationHolders[e.targetPath]||(i._lateAnimationHolders[e.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:t}),e.isAdditive?(i._lateAnimationHolders[e.targetPath].additiveAnimations.push(e),i._lateAnimationHolders[e.targetPath].totalAdditiveWeight+=e.weight):(i._lateAnimationHolders[e.targetPath].animations.push(e),i._lateAnimationHolders[e.targetPath].totalWeight+=e.weight)},Yi.prototype._processLateAnimationBindingsForMatrices=function(e){if(0===e.totalWeight&&0===e.totalAdditiveWeight)return e.originalValue;let t=1;const i=R.Vector3[0],s=R.Vector3[1],r=R.Quaternion[0];let n=0;const o=e.animations[0],a=e.originalValue;let l=1,h=!1;if(e.totalWeight<1)l=1-e.totalWeight,a.decompose(s,r,i);else{if(n=1,t=e.totalWeight,l=o.weight/t,1==l){if(!e.totalAdditiveWeight)return o.currentValue;h=!0}o.currentValue.decompose(s,r,i)}if(!h){s.scaleInPlace(l),i.scaleInPlace(l),r.scaleInPlace(l);for(let o=n;o<e.animations.length;o++){const n=e.animations[o];if(0===n.weight)continue;l=n.weight/t;const a=R.Vector3[2],h=R.Vector3[3],c=R.Quaternion[1];n.currentValue.decompose(h,c,a),h.scaleAndAddToRef(l,s),c.scaleAndAddToRef(C.Dot(r,c)>0?l:-l,r),a.scaleAndAddToRef(l,i)}r.normalize()}for(let t=0;t<e.additiveAnimations.length;t++){const n=e.additiveAnimations[t];if(0===n.weight)continue;const o=R.Vector3[2],a=R.Vector3[3],l=R.Quaternion[1];n.currentValue.decompose(a,l,o),a.multiplyToRef(s,a),S.LerpToRef(s,a,n.weight,s),r.multiplyToRef(l,l),C.SlerpToRef(r,l,n.weight,r),o.scaleAndAddToRef(n.weight,i)}const c=o?o._animationState.workValue:R.Matrix[0].clone();return y.ComposeToRef(s,r,i,c),c},Yi.prototype._processLateAnimationBindingsForQuaternions=function(e,t){if(0===e.totalWeight&&0===e.totalAdditiveWeight)return t;const i=e.animations[0],s=e.originalValue;let r=t;if(0===e.totalWeight&&e.totalAdditiveWeight>0)r.copyFrom(s);else if(1===e.animations.length){if(C.SlerpToRef(s,i.currentValue,Math.min(1,e.totalWeight),r),0===e.totalAdditiveWeight)return r}else if(e.animations.length>1){let i,n,o=1;if(e.totalWeight<1){const t=1-e.totalWeight;i=[],n=[],i.push(s),n.push(t)}else{if(2===e.animations.length&&(C.SlerpToRef(e.animations[0].currentValue,e.animations[1].currentValue,e.animations[1].weight/e.totalWeight,t),0===e.totalAdditiveWeight))return t;i=[],n=[],o=e.totalWeight}for(let t=0;t<e.animations.length;t++){const s=e.animations[t];i.push(s.currentValue),n.push(s.weight/o)}let a=0;for(let e=0;e<i.length;)e?(a+=n[e],C.SlerpToRef(r,i[e],n[e]/a,r),e++):(C.SlerpToRef(i[e],i[e+1],n[e+1]/(n[e]+n[e+1]),t),r=t,a=n[e]+n[e+1],e+=2)}for(let t=0;t<e.additiveAnimations.length;t++){const i=e.additiveAnimations[t];0!==i.weight&&(r.multiplyToRef(i.currentValue,R.Quaternion[0]),C.SlerpToRef(r,R.Quaternion[0],i.weight,r))}return r},Yi.prototype._processLateAnimationBindings=function(){if(this._registeredForLateAnimationBindings.length){for(let e=0;e<this._registeredForLateAnimationBindings.length;e++){const t=this._registeredForLateAnimationBindings.data[e];for(const e in t._lateAnimationHolders){const i=t._lateAnimationHolders[e],s=i.animations[0],r=i.originalValue;if(null==r)continue;const n=Ie.AllowMatrixDecomposeForInterpolation&&r.m;let o=t[e];if(n)o=this._processLateAnimationBindingsForMatrices(i);else if(void 0!==r.w)o=this._processLateAnimationBindingsForQuaternions(i,o||C.Identity());else{let e=0,t=1;const n=s&&s._animationState.loopMode===Ie.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT;if(i.totalWeight<1)o=n?r.clone?r.clone():r:s&&r.scale?r.scale(1-i.totalWeight):s?r*(1-i.totalWeight):r.clone?r.clone():r;else if(s){t=i.totalWeight;const a=s.weight/t;o=1!==a?s.currentValue.scale?s.currentValue.scale(a):s.currentValue*a:s.currentValue,n&&(o.addToRef?o.addToRef(r,o):o+=r),e=1}for(let s=e;s<i.animations.length;s++){const e=i.animations[s],r=e.weight/t;r&&(e.currentValue.scaleAndAddToRef?e.currentValue.scaleAndAddToRef(r,o):o+=e.currentValue*r)}for(let e=0;e<i.additiveAnimations.length;e++){const t=i.additiveAnimations[e],s=t.weight;s&&(t.currentValue.scaleAndAddToRef?t.currentValue.scaleAndAddToRef(s,o):o+=t.currentValue*s)}}t[e]=o}t._lateAnimationHolders={}}this._registeredForLateAnimationBindings.reset()}},Ki.prototype.copyAnimationRange=function(e,t,i,s=!1,r=null){0===this.animations.length&&(this.animations.push(new Ie(this.name,"_matrix",e.animations[0].framePerSecond,Ie.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));const n=e.animations[0].getRange(t);if(!n)return!1;const o=n.from,a=n.to,l=e.animations[0].getKeys(),h=e.length,c=e.getParent(),u=this.getParent(),d=s&&c&&h&&this.length&&h!==this.length,p=d&&u&&c?u.length/c.length:1,_=s&&!u&&r&&(1!==r.x||1!==r.y||1!==r.z),f=this.animations[0].getKeys();let m,g,v;for(let e=0,t=l.length;e<t;e++)m=l[e],m.frame>=o&&m.frame<=a&&(s?(v=m.value.clone(),d?(g=v.getTranslation(),v.setTranslation(g.scaleInPlace(p))):_&&r?(g=v.getTranslation(),v.setTranslation(g.multiplyInPlace(r))):v=m.value):v=m.value,f.push({frame:m.frame+i,value:v}));return this.animations[0].createRange(t,o+i,a+i),!0},function(e){e[e.CW=0]="CW",e[e.CCW=1]="CCW"}(Wi||(Wi={}));class qi{constructor(e){this._radians=e,this._radians<0&&(this._radians+=2*Math.PI)}degrees(){return 180*this._radians/Math.PI}radians(){return this._radians}static BetweenTwoPoints(e,t){const i=t.subtract(e),s=Math.atan2(i.y,i.x);return new qi(s)}static BetweenTwoVectors(e,t){let i=e.lengthSquared()*t.lengthSquared();if(0===i)return new qi(Math.PI/2);i=Math.sqrt(i);let s=e.dot(t)/i;s=l.Clamp(s,-1,1);const r=Math.acos(s);return new qi(r)}static FromRadians(e){return new qi(e)}static FromDegrees(e){return new qi(e*Math.PI/180)}}class Qi{constructor(e,t,i){this.startPoint=e,this.midPoint=t,this.endPoint=i;const s=Math.pow(t.x,2)+Math.pow(t.y,2),r=(Math.pow(e.x,2)+Math.pow(e.y,2)-s)/2,n=(s-Math.pow(i.x,2)-Math.pow(i.y,2))/2,o=(e.x-t.x)*(t.y-i.y)-(t.x-i.x)*(e.y-t.y);this.centerPoint=new E((r*(t.y-i.y)-n*(e.y-t.y))/o,((e.x-t.x)*n-(t.x-i.x)*r)/o),this.radius=this.centerPoint.subtract(this.startPoint).length(),this.startAngle=qi.BetweenTwoPoints(this.centerPoint,this.startPoint);const a=this.startAngle.degrees();let l=qi.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),h=qi.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();l-a>180&&(l-=360),l-a<-180&&(l+=360),h-l>180&&(h-=360),h-l<-180&&(h+=360),this.orientation=l-a<0?Wi.CW:Wi.CCW,this.angle=qi.FromDegrees(this.orientation===Wi.CW?a-h:h-a)}}class Zi{constructor(e,t){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new E(e,t))}addLineTo(e,t){if(this.closed)return this;const i=new E(e,t),s=this._points[this._points.length-1];return this._points.push(i),this._length+=i.subtract(s).length(),this}addArcTo(e,t,i,s,r=36){if(this.closed)return this;const n=this._points[this._points.length-1],o=new E(e,t),a=new E(i,s),l=new Qi(n,o,a);let h=l.angle.radians()/r;l.orientation===Wi.CW&&(h*=-1);let c=l.startAngle.radians()+h;for(let e=0;e<r;e++){const e=Math.cos(c)*l.radius+l.centerPoint.x,t=Math.sin(c)*l.radius+l.centerPoint.y;this.addLineTo(e,t),c+=h}return this}addQuadraticCurveTo(e,t,i,s,r=36){if(this.closed)return this;const n=(e,t,i,s)=>(1-e)*(1-e)*t+2*e*(1-e)*i+e*e*s,o=this._points[this._points.length-1];for(let a=0;a<=r;a++){const l=a/r,h=n(l,o.x,e,i),c=n(l,o.y,t,s);this.addLineTo(h,c)}return this}addBezierCurveTo(e,t,i,s,r,n,o=36){if(this.closed)return this;const a=(e,t,i,s,r)=>(1-e)*(1-e)*(1-e)*t+3*e*(1-e)*(1-e)*i+3*e*e*(1-e)*s+e*e*e*r,l=this._points[this._points.length-1];for(let h=0;h<=o;h++){const c=h/o,u=a(c,l.x,e,i,r),d=a(c,l.y,t,s,n);this.addLineTo(u,d)}return this}isPointInside(e){let t=!1;const i=this._points.length;for(let s=i-1,r=0;r<i;s=r++){let i=this._points[s],n=this._points[r],o=n.x-i.x,a=n.y-i.y;if(Math.abs(a)>Number.EPSILON){if(a<0&&(i=this._points[r],o=-o,n=this._points[s],a=-a),e.y<i.y||e.y>n.y)continue;if(e.y===i.y&&e.x===i.x)return!0;{const s=a*(e.x-i.x)-o*(e.y-i.y);if(0===s)return!0;if(s<0)continue;t=!t}}else{if(e.y!==i.y)continue;if(n.x<=e.x&&e.x<=i.x||i.x<=e.x&&e.x<=n.x)return!0}}return t}close(){return this.closed=!0,this}length(){let e=this._length;if(this.closed){const t=this._points[this._points.length-1];e+=this._points[0].subtract(t).length()}return e}area(){const e=this._points.length;let t=0;for(let i=e-1,s=0;s<e;i=s++)t+=this._points[i].x*this._points[s].y-this._points[s].x*this._points[i].y;return.5*t}getPoints(){return this._points}getPointAtLengthPosition(e){if(e<0||e>1)return E.Zero();const t=e*this.length();let i=0;for(let e=0;e<this._points.length;e++){const s=(e+1)%this._points.length,r=this._points[e],n=this._points[s].subtract(r),o=n.length()+i;if(t>=i&&t<=o){const e=n.normalize(),s=t-i;return new E(r.x+e.x*s,r.y+e.y*s)}i=o}return E.Zero()}static StartingAt(e,t){return new Zi(e,t)}}class Ji{constructor(e,t=null,i,s=!1){this.path=e,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:S.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:y.Identity()};for(let t=0;t<e.length;t++)this._curve[t]=e[t].clone();this._raw=i||!1,this._alignTangentsWithPath=s,this._compute(t,s)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(e){return this._updatePointAtData(e).point}getTangentAt(e,t=!1){return this._updatePointAtData(e,t),t?S.TransformCoordinates(S.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(e,t=!1){return this._updatePointAtData(e,t),t?S.TransformCoordinates(S.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(e,t=!1){return this._updatePointAtData(e,t),t?S.TransformCoordinates(S.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(e){return this.length()*e}getPreviousPointIndexAt(e){return this._updatePointAtData(e),this._pointAtData.previousPointArrayIndex}getSubPositionAt(e){return this._updatePointAtData(e),this._pointAtData.subPosition}getClosestPositionTo(e){let t=Number.MAX_VALUE,i=0;for(let s=0;s<this._curve.length-1;s++){const r=this._curve[s+0],n=this._curve[s+1].subtract(r).normalize(),o=this._distances[s+1]-this._distances[s+0],a=Math.min(Math.max(S.Dot(n,e.subtract(r).normalize()),0)*S.Distance(r,e)/o,1),l=S.Distance(r.add(n.scale(a*o)),e);l<t&&(t=l,i=(this._distances[s+0]+o*a)/this.length())}return i}slice(e=0,t=1){if(e<0&&(e=1- -1*e%1),t<0&&(t=1- -1*t%1),e>t){const i=e;e=t,t=i}const i=this.getCurve(),s=this.getPointAt(e);let r=this.getPreviousPointIndexAt(e);const n=this.getPointAt(t),o=this.getPreviousPointIndexAt(t)+1,a=[];return 0!==e&&(r++,a.push(s)),a.push(...i.slice(r,o)),1===t&&1!==e||a.push(n),new Ji(a,this.getNormalAt(e),this._raw,this._alignTangentsWithPath)}update(e,t=null,i=!1){for(let t=0;t<e.length;t++)this._curve[t].x=e[t].x,this._curve[t].y=e[t].y,this._curve[t].z=e[t].z;return this._compute(t,i),this}_compute(e,t=!1){const i=this._curve.length;if(i<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[i-1]=this._curve[i-1].subtract(this._curve[i-2]),this._raw||this._tangents[i-1].normalize();const s=this._tangents[0],r=this._normalVector(s,e);let n,o,a,l,h;this._normals[0]=r,this._raw||this._normals[0].normalize(),this._binormals[0]=S.Cross(s,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;for(let e=1;e<i;e++)n=this._getLastNonNullVector(e),e<i-1&&(o=this._getFirstNonNullVector(e),this._tangents[e]=t?o:n.add(o),this._tangents[e].normalize()),this._distances[e]=this._distances[e-1]+this._curve[e].subtract(this._curve[e-1]).length(),a=this._tangents[e],h=this._binormals[e-1],this._normals[e]=S.Cross(h,a),this._raw||(0===this._normals[e].length()?(l=this._normals[e-1],this._normals[e]=l.clone()):this._normals[e].normalize()),this._binormals[e]=S.Cross(a,this._normals[e]),this._raw||this._binormals[e].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(e){let t=1,i=this._curve[e+t].subtract(this._curve[e]);for(;0===i.length()&&e+t+1<this._curve.length;)t++,i=this._curve[e+t].subtract(this._curve[e]);return i}_getLastNonNullVector(e){let t=1,i=this._curve[e].subtract(this._curve[e-t]);for(;0===i.length()&&e>t+1;)t++,i=this._curve[e].subtract(this._curve[e-t]);return i}_normalVector(e,t){let i,s=e.length();if(0===s&&(s=1),null==t){let t;t=l.WithinEpsilon(Math.abs(e.y)/s,1,u)?l.WithinEpsilon(Math.abs(e.x)/s,1,u)?l.WithinEpsilon(Math.abs(e.z)/s,1,u)?S.Zero():new S(0,0,1):new S(1,0,0):new S(0,-1,0),i=S.Cross(e,t)}else i=S.Cross(e,t),S.CrossToRef(i,e,i);return i.normalize(),i}_updatePointAtData(e,t=!1){if(this._pointAtData.id===e)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=e;const i=this.getPoints();if(e<=0)return this._setPointAtData(0,0,i[0],0,t);if(e>=1)return this._setPointAtData(1,1,i[i.length-1],i.length-1,t);let s,r=i[0],n=0;const o=e*this.length();for(let a=1;a<i.length;a++){s=i[a];const l=S.Distance(r,s);if(n+=l,n===o)return this._setPointAtData(e,1,s,a,t);if(n>o){const i=(n-o)/l,h=r.subtract(s),c=s.add(h.scaleInPlace(i));return this._setPointAtData(e,1-i,c,a-1,t)}r=s}return this._pointAtData}_setPointAtData(e,t,i,s,r){return this._pointAtData.point=i,this._pointAtData.position=e,this._pointAtData.subPosition=t,this._pointAtData.previousPointArrayIndex=s,this._pointAtData.interpolateReady=r,r&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=y.Identity();const e=this._pointAtData.previousPointArrayIndex;if(e!==this._tangents.length-1){const t=e+1,i=this._tangents[e].clone(),s=this._normals[e].clone(),r=this._binormals[e].clone(),n=this._tangents[t].clone(),o=this._normals[t].clone(),a=this._binormals[t].clone(),l=C.RotationQuaternionFromAxis(s,r,i),h=C.RotationQuaternionFromAxis(o,a,n);C.Slerp(l,h,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}}class es{static CreateQuadraticBezier(e,t,i,s){s=s>2?s:3;const r=[],n=(e,t,i,s)=>(1-e)*(1-e)*t+2*e*(1-e)*i+e*e*s;for(let o=0;o<=s;o++)r.push(new S(n(o/s,e.x,t.x,i.x),n(o/s,e.y,t.y,i.y),n(o/s,e.z,t.z,i.z)));return new es(r)}static CreateCubicBezier(e,t,i,s,r){r=r>3?r:4;const n=[],o=(e,t,i,s,r)=>(1-e)*(1-e)*(1-e)*t+3*e*(1-e)*(1-e)*i+3*e*e*(1-e)*s+e*e*e*r;for(let a=0;a<=r;a++)n.push(new S(o(a/r,e.x,t.x,i.x,s.x),o(a/r,e.y,t.y,i.y,s.y),o(a/r,e.z,t.z,i.z,s.z)));return new es(n)}static CreateHermiteSpline(e,t,i,s,r){const n=[],o=1/r;for(let a=0;a<=r;a++)n.push(S.Hermite(e,t,i,s,a*o));return new es(n)}static CreateCatmullRomSpline(e,t,i){const s=[],r=1/t;let n=0;if(i){const i=e.length;for(let o=0;o<i;o++){n=0;for(let a=0;a<t;a++)s.push(S.CatmullRom(e[o%i],e[(o+1)%i],e[(o+2)%i],e[(o+3)%i],n)),n+=r}s.push(s[0])}else{const i=[];i.push(e[0].clone()),Array.prototype.push.apply(i,e),i.push(e[e.length-1].clone());let o=0;for(;o<i.length-3;o++){n=0;for(let e=0;e<t;e++)s.push(S.CatmullRom(i[o],i[o+1],i[o+2],i[o+3],n)),n+=r}o--,s.push(S.CatmullRom(i[o],i[o+1],i[o+2],i[o+3],n))}return new es(s)}static ArcThru3Points(e,t,i,s=32,r=!1,n=!1){const o=[],a=t.subtract(e),l=i.subtract(t),h=e.subtract(i),c=S.Cross(a,l),u=c.length();if(u<Math.pow(10,-8))return new es(o);const d=a.lengthSquared(),p=l.lengthSquared(),_=h.lengthSquared(),f=c.lengthSquared(),m=.5*a.length()*l.length()*h.length()/u,g=-.5*p*S.Dot(a,h)/f,v=-.5*_*S.Dot(a,l)/f,x=-.5*d*S.Dot(l,h)/f,T=e.scale(g).add(t.scale(v)).add(i.scale(x)),E=e.subtract(T).normalize(),b=S.Cross(c,E).normalize();if(n){const t=2*Math.PI/s;for(let e=0;e<=2*Math.PI;e+=t)o.push(T.add(E.scale(m*Math.cos(e)).add(b.scale(m*Math.sin(e)))));o.push(e)}else{const t=1/s;let n=0,a=S.Zero();do{a=T.add(E.scale(m*Math.cos(n)).add(b.scale(m*Math.sin(n)))),o.push(a),n+=t}while(!a.equalsWithEpsilon(i,m*t*1.1));o.push(i),r&&o.push(e)}return new es(o)}constructor(e){this._length=0,this._points=e,this._length=this._computeLength(e)}getPoints(){return this._points}length(){return this._length}continue(e){const t=this._points[this._points.length-1],i=this._points.slice(),s=e.getPoints();for(let e=1;e<s.length;e++)i.push(s[e].subtract(s[0]).add(t));return new es(i)}_computeLength(e){let t=0;for(let i=1;i<e.length;i++)t+=e[i].subtract(e[i-1]).length();return t}}class ts{constructor(){this._easingMode=ts.EASINGMODE_EASEIN}setEasingMode(e){const t=Math.min(Math.max(e,0),2);this._easingMode=t}getEasingMode(){return this._easingMode}easeInCore(e){throw new Error("You must implement this method")}ease(e){switch(this._easingMode){case ts.EASINGMODE_EASEIN:return this.easeInCore(e);case ts.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-e)}return e>=.5?.5*(1-this.easeInCore(2*(1-e)))+.5:.5*this.easeInCore(2*e)}}ts.EASINGMODE_EASEIN=0,ts.EASINGMODE_EASEOUT=1,ts.EASINGMODE_EASEINOUT=2;class is extends ts{easeInCore(e){return e=Math.max(0,Math.min(1,e)),1-Math.sqrt(1-e*e)}}class ss extends ts{easeInCore(e){return e*e}}class rs extends ts{easeInCore(e){return 1-Math.sin(1.5707963267948966*(1-e))}}class ns{constructor(e,t,i){this.frame=e,this.action=t,this.onlyOnce=i,this.isDone=!1}_clone(){return new ns(this.frame,this.action,this.onlyOnce)}}class os{getClassName(){return"TargetedAnimation"}serialize(){const e={};return e.animation=this.animation.serialize(),e.targetId=this.target.id,e}}class as{syncWithMask(){if(this.mask){this._numActiveAnimatables=0;for(let e=0;e<this._animatables.length;++e){const t=this._animatables[e];this.mask.retainsTarget(t.target.name)?(this._numActiveAnimatables++,t.paused&&t.restart()):t.paused||t.pause()}}else this._numActiveAnimatables=this._targetedAnimations.length}removeUnmaskedAnimations(){if(this.mask){for(let e=0;e<this._animatables.length;++e){const t=this._animatables[e];this.mask.retainsTarget(t.target.name)||(t.stop(),this._animatables.splice(e,1),--e)}for(let e=0;e<this._targetedAnimations.length;e++){const t=this._targetedAnimations[e];this.mask.retainsTarget(t.target.name)||(this._targetedAnimations.splice(e,1),--e)}}}get from(){return this._from}get to(){return this._to}get isStarted(){return this._isStarted}get isPlaying(){return this._isStarted&&!this._isPaused}get speedRatio(){return this._speedRatio}set speedRatio(e){if(this._speedRatio!==e){this._speedRatio=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].speedRatio=this._speedRatio}}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){if(this._loopAnimation!==e){this._loopAnimation=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].loopAnimation=this._loopAnimation}}get isAdditive(){return this._isAdditive}set isAdditive(e){if(this._isAdditive!==e){this._isAdditive=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].isAdditive=this._isAdditive}}get weight(){return this._weight}set weight(e){this._weight!==e&&(this._weight=e,this.setWeightForAllAnimatables(this._weight))}get targetedAnimations(){return this._targetedAnimations}get animatables(){return this._animatables}get children(){return this._targetedAnimations}get playOrder(){return this._playOrder}set playOrder(e){if(this._playOrder!==e&&(this._playOrder=e,this._animatables.length>0)){for(let e=0;e<this._animatables.length;e++)this._animatables[e].playOrder=this._playOrder;this._scene.sortActiveAnimatables()}}get enableBlending(){return this._enableBlending}set enableBlending(e){if(this._enableBlending!==e&&(this._enableBlending=e,null!==e))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.enableBlending=e}get blendingSpeed(){return this._blendingSpeed}set blendingSpeed(e){if(this._blendingSpeed!==e&&(this._blendingSpeed=e,null!==e))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.blendingSpeed=e}getLength(e,t){return e=null!=e?e:this._from,((t=null!=t?t:this._to)-e)/(this.targetedAnimations[0].animation.framePerSecond*this._speedRatio)}static MergeAnimationGroups(e,t=!0,i=!1,s){if(0===e.length)return null;s=null!=s?s:e[0].weight;let r=Number.MAX_VALUE,n=-Number.MAX_VALUE;if(i)for(const t of e)t.from<r&&(r=t.from),t.to>n&&(n=t.to);const o=new as(e[0].name+"_merged",e[0]._scene,s);for(const s of e){i&&s.normalize(r,n);for(const e of s.targetedAnimations)o.addTargetedAnimation(e.animation,e.target);t&&s.dispose()}return o}constructor(e,t=null,i=-1,s=0){this.name=e,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this._weight=-1,this._playOrder=0,this._enableBlending=null,this._blendingSpeed=null,this._numActiveAnimatables=0,this._parentContainer=null,this.onAnimationEndObservable=new a,this.onAnimationLoopObservable=new a,this.onAnimationGroupLoopObservable=new a,this.onAnimationGroupEndObservable=new a,this.onAnimationGroupPauseObservable=new a,this.onAnimationGroupPlayObservable=new a,this.metadata=null,this._animationLoopFlags=[],this._scene=t||x.LastCreatedScene,this._weight=i,this._playOrder=s,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}addTargetedAnimation(e,t){const i=new os;i.animation=e,i.target=t;const s=e.getKeys();return this._from>s[0].frame&&(this._from=s[0].frame),this._to<s[s.length-1].frame&&(this._to=s[s.length-1].frame),null!==this._enableBlending&&(e.enableBlending=this._enableBlending),null!==this._blendingSpeed&&(e.blendingSpeed=this._blendingSpeed),this._targetedAnimations.push(i),i}removeTargetedAnimation(e){for(let t=this._targetedAnimations.length-1;t>-1;t--)this._targetedAnimations[t].animation===e&&this._targetedAnimations.splice(t,1)}normalize(e=null,t=null){null==e&&(e=this._from),null==t&&(t=this._to);for(let i=0;i<this._targetedAnimations.length;i++){const s=this._targetedAnimations[i].animation.getKeys(),r=s[0],n=s[s.length-1];if(r.frame>e){const t={frame:e,value:r.value,inTangent:r.inTangent,outTangent:r.outTangent,interpolation:r.interpolation};s.splice(0,0,t)}if(n.frame<t){const e={frame:t,value:n.value,inTangent:n.inTangent,outTangent:n.outTangent,interpolation:n.interpolation};s.push(e)}}return this._from=e,this._to=t,this}_processLoop(e,t,i){e.onAnimationLoop=()=>{this.onAnimationLoopObservable.notifyObservers(t),this._animationLoopFlags[i]||(this._animationLoopFlags[i]=!0,this._animationLoopCount++,this._animationLoopCount===this._numActiveAnimatables&&(this.onAnimationGroupLoopObservable.notifyObservers(this),this._animationLoopCount=0,this._animationLoopFlags.length=0))}}start(e=!1,t=1,i,s,r){if(this._isStarted||0===this._targetedAnimations.length)return this;this._loopAnimation=e,this._animationLoopCount=0,this._animationLoopFlags.length=0;for(let n=0;n<this._targetedAnimations.length;n++){const o=this._targetedAnimations[n],a=this._scene.beginDirectAnimation(o.target,[o.animation],void 0!==i?i:this._from,void 0!==s?s:this._to,e,t,void 0,void 0,void 0!==r?r:this._isAdditive);a.weight=this._weight,a.playOrder=this._playOrder,a.onAnimationEnd=()=>{this.onAnimationEndObservable.notifyObservers(o),this._checkAnimationGroupEnded(a)},this._processLoop(a,o,n),this._animatables.push(a)}return this.syncWithMask(),this._scene.sortActiveAnimatables(),this._speedRatio=t,this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}pause(){if(!this._isStarted)return this;this._isPaused=!0;for(let e=0;e<this._animatables.length;e++)this._animatables[e].pause();return this.onAnimationGroupPauseObservable.notifyObservers(this),this}play(e){return this.isStarted&&this._animatables.length===this._targetedAnimations.length?(void 0!==e&&(this.loopAnimation=e),this.restart()):(this.stop(),this.start(e,this._speedRatio)),this._isPaused=!1,this}reset(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(),this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].reset();return this}restart(){if(!this._isStarted)return this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].restart();return this.onAnimationGroupPlayObservable.notifyObservers(this),this}stop(){if(!this._isStarted)return this;const e=this._animatables.slice();for(let t=0;t<e.length;t++)e[t].stop(void 0,void 0,!0);let t=0;for(let e=0;e<this._scene._activeAnimatables.length;e++){const i=this._scene._activeAnimatables[e];i._runtimeAnimations.length>0&&(this._scene._activeAnimatables[t++]=i)}return this._scene._activeAnimatables.length=t,this._isStarted=!1,this}setWeightForAllAnimatables(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].weight=e;return this}syncAllAnimationsWith(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].syncWith(e);return this}goToFrame(e){if(!this._isStarted)return this;for(let t=0;t<this._animatables.length;t++)this._animatables[t].goToFrame(e);return this}dispose(){this._targetedAnimations.length=0,this._animatables.length=0;const e=this._scene.animationGroups.indexOf(this);if(e>-1&&this._scene.animationGroups.splice(e,1),this._parentContainer){const e=this._parentContainer.animationGroups.indexOf(this);e>-1&&this._parentContainer.animationGroups.splice(e,1),this._parentContainer=null}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()}_checkAnimationGroupEnded(e){const t=this._animatables.indexOf(e);t>-1&&this._animatables.splice(t,1),0===this._animatables.length&&(this._isStarted=!1,this.onAnimationGroupEndObservable.notifyObservers(this))}clone(e,t,i=!1){const s=new as(e||this.name,this._scene,this._weight,this._playOrder);s._from=this.from,s._to=this.to,s._speedRatio=this.speedRatio,s._loopAnimation=this.loopAnimation,s._isAdditive=this.isAdditive,s._enableBlending=this.enableBlending,s._blendingSpeed=this.blendingSpeed,s.metadata=this.metadata,s.mask=this.mask;for(const e of this._targetedAnimations)s.addTargetedAnimation(i?e.animation.clone():e.animation,t?t(e.target):e.target);return s}serialize(){const e={};e.name=this.name,e.from=this.from,e.to=this.to,e.speedRatio=this.speedRatio,e.loopAnimation=this.loopAnimation,e.isAdditive=this.isAdditive,e.weight=this.weight,e.playOrder=this.playOrder,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,e.targetedAnimations=[];for(let t=0;t<this.targetedAnimations.length;t++){const i=this.targetedAnimations[t];e.targetedAnimations[t]=i.serialize()}return j&&j.HasTags(this)&&(e.tags=j.GetTags(this)),this.metadata&&(e.metadata=this.metadata),e}static Parse(e,t){const i=new as(e.name,t,e.weight,e.playOrder);for(let s=0;s<e.targetedAnimations.length;s++){const r=e.targetedAnimations[s],n=Ie.Parse(r.animation),o=r.targetId;if("influence"===r.animation.property){const e=t.getMorphTargetById(o);e&&i.addTargetedAnimation(n,e)}else{const e=t.getNodeById(o);null!=e&&i.addTargetedAnimation(n,e)}}return j&&j.AddTagsTo(i,e.tags),null!==e.from&&null!==e.to&&i.normalize(e.from,e.to),void 0!==e.speedRatio&&(i._speedRatio=e.speedRatio),void 0!==e.loopAnimation&&(i._loopAnimation=e.loopAnimation),void 0!==e.isAdditive&&(i._isAdditive=e.isAdditive),void 0!==e.weight&&(i._weight=e.weight),void 0!==e.playOrder&&(i._playOrder=e.playOrder),void 0!==e.enableBlending&&(i._enableBlending=e.enableBlending),void 0!==e.blendingSpeed&&(i._blendingSpeed=e.blendingSpeed),void 0!==e.metadata&&(i.metadata=e.metadata),i}static MakeAnimationAdditive(e,t,i,s=!1,r){let n;n="object"==typeof t?t:{referenceFrame:t,range:i,cloneOriginalAnimationGroup:s,clonedAnimationName:r};let o=e;n.cloneOriginalAnimationGroup&&(o=e.clone(n.clonedAnimationGroupName||o.name));const a=o.targetedAnimations;for(let e=0;e<a.length;e++){const t=a[e];t.animation=Ie.MakeAnimationAdditive(t.animation,n)}if(o.isAdditive=!0,n.clipKeys){let e=Number.MAX_VALUE,t=-Number.MAX_VALUE;const i=o.targetedAnimations;for(let s=0;s<i.length;s++){const r=i[s].animation.getKeys();e>r[0].frame&&(e=r[0].frame),t<r[r.length-1].frame&&(t=r[r.length-1].frame)}o._from=e,o._to=t}return o}static ClipKeys(e,t,i,s,r){const n=e.clone(s||e.name);return as.ClipKeysInPlace(n,t,i,r)}static ClipKeysInPlace(e,t,i,s){return as.ClipInPlace(e,t,i,s,!1)}static ClipFrames(e,t,i,s,r){const n=e.clone(s||e.name);return as.ClipFramesInPlace(n,t,i,r)}static ClipFramesInPlace(e,t,i,s){return as.ClipInPlace(e,t,i,s,!0)}static ClipInPlace(e,t,i,s,r=!1){let n=Number.MAX_VALUE,o=-Number.MAX_VALUE;const a=e.targetedAnimations;for(let e=0;e<a.length;e++){const l=a[e],h=s?l.animation:l.animation.clone();r&&(h.createKeyForFrame(t),h.createKeyForFrame(i));const c=h.getKeys(),u=[];let d=Number.MAX_VALUE;for(let e=0;e<c.length;e++){const s=c[e];if(!r&&e>=t&&e<=i||r&&s.frame>=t&&s.frame<=i){const e={frame:s.frame,value:s.value.clone?s.value.clone():s.value,inTangent:s.inTangent,outTangent:s.outTangent,interpolation:s.interpolation,lockedTangent:s.lockedTangent};d===Number.MAX_VALUE&&(d=e.frame),e.frame-=d,u.push(e)}}0!==u.length?(n>u[0].frame&&(n=u[0].frame),o<u[u.length-1].frame&&(o=u[u.length-1].frame),h.setKeys(u,!0),l.animation=h):(a.splice(e,1),e--)}return e._from=n,e._to=o,e}getClassName(){return"AnimationGroup"}toString(e){let t="Name: "+this.name;return t+=", type: "+this.getClassName(),e&&(t+=", from: "+this._from,t+=", to: "+this._to,t+=", isStarted: "+this._isStarted,t+=", speedRatio: "+this._speedRatio,t+=", targetedAnimations length: "+this._targetedAnimations.length,t+=", animatables length: "+this._animatables),t}}function ls(e,t,i){try{const s=e.next();s.done?t(s):s.value?s.value.then((()=>{s.value=void 0,t(s)}),i):t(s)}catch(e){i(e)}}function hs(e,t,i,s,r){const n=()=>{let o;const a=e=>{e.done?i(e.value):void 0===o?o=!0:n()};do{o=void 0,r&&r.aborted?s(new Error("Aborted")):t(e,a,s),void 0===o&&(o=!1)}while(o)};n()}function cs(e,t){let i;return hs(e,ls,(e=>i=e),(e=>{throw e}),t),i}function us(e,t,i){return new Promise(((s,r)=>{hs(e,t,s,r,i)}))}!function(e){e[e.Include=0]="Include",e[e.Exclude=1]="Exclude"}(Hi||(Hi={}));class ds{constructor(e,t,i,s){this.x=e,this.y=t,this.width=i,this.height=s}toGlobal(e,t){return new ds(this.x*e,this.y*t,this.width*e,this.height*t)}toGlobalToRef(e,t,i){return i.x=this.x*e,i.y=this.y*t,i.width=this.width*e,i.height=this.height*t,this}clone(){return new ds(this.x,this.y,this.width,this.height)}}class ps extends ve{get position(){return this._position}set position(e){this._position=e}set upVector(e){this._upVector=e}get upVector(){return this._upVector}get screenArea(){var e,t,i,s;let r=0,n=0;if(this.mode===ps.PERSPECTIVE_CAMERA)this.fovMode===ps.FOVMODE_VERTICAL_FIXED?(n=2*this.minZ*Math.tan(this.fov/2),r=this.getEngine().getAspectRatio(this)*n):(r=2*this.minZ*Math.tan(this.fov/2),n=r/this.getEngine().getAspectRatio(this));else{const o=this.getEngine().getRenderWidth()/2,a=this.getEngine().getRenderHeight()/2;r=(null!==(e=this.orthoRight)&&void 0!==e?e:o)-(null!==(t=this.orthoLeft)&&void 0!==t?t:-o),n=(null!==(i=this.orthoTop)&&void 0!==i?i:a)-(null!==(s=this.orthoBottom)&&void 0!==s?s:-a)}return r*n}set orthoLeft(e){this._orthoLeft=e;for(const t of this._rigCameras)t.orthoLeft=e}get orthoLeft(){return this._orthoLeft}set orthoRight(e){this._orthoRight=e;for(const t of this._rigCameras)t.orthoRight=e}get orthoRight(){return this._orthoRight}set orthoBottom(e){this._orthoBottom=e;for(const t of this._rigCameras)t.orthoBottom=e}get orthoBottom(){return this._orthoBottom}set orthoTop(e){this._orthoTop=e;for(const t of this._rigCameras)t.orthoTop=e}get orthoTop(){return this._orthoTop}set mode(e){this._mode=e;for(const t of this._rigCameras)t.mode=e}get mode(){return this._mode}constructor(e,t,i,s=!0){super(e,i),this._position=S.Zero(),this._upVector=S.Up(),this.oblique=null,this._orthoLeft=null,this._orthoRight=null,this._orthoBottom=null,this._orthoTop=null,this.fov=.8,this.projectionPlaneTilt=0,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this._mode=ps.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new ds(0,0,1,1),this.layerMask=268435455,this.fovMode=ps.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=ps.RIG_MODE_NONE,this.customRenderTargets=[],this.outputRenderTarget=null,this.onViewMatrixChangedObservable=new a,this.onProjectionMatrixChangedObservable=new a,this.onAfterCheckInputsObservable=new a,this.onRestoreStateObservable=new a,this.isRigCamera=!1,this._rigCameras=new Array,this._skipRendering=!1,this._projectionMatrix=new y,this._postProcesses=new Array,this._activeMeshes=new Yt(256),this._globalPosition=S.Zero(),this._computedViewMatrix=y.Identity(),this._doNotComputeProjectionMatrix=!1,this._transformMatrix=y.Zero(),this._refreshFrustumPlanes=!0,this._absoluteRotation=C.Identity(),this._isCamera=!0,this._isLeftCamera=!1,this._isRightCamera=!1,this.getScene().addCamera(this),s&&!this.getScene().activeCamera&&(this.getScene().activeCamera=this),this.position=t,this.renderPassId=this.getScene().getEngine().createRenderPassId(`Camera ${e}`)}storeState(){return this._stateStored=!0,this._storedFov=this.fov,this}_restoreStateValues(){return!!this._stateStored&&(this.fov=this._storedFov,!0)}restoreState(){return!!this._restoreStateValues()&&(this.onRestoreStateObservable.notifyObservers(this),!0)}getClassName(){return"Camera"}toString(e){let t="Name: "+this.name;if(t+=", type: "+this.getClassName(),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}applyVerticalCorrection(){const e=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-e.x:e.x}get globalPosition(){return this._globalPosition}getActiveMeshes(){return this._activeMeshes}isActiveMesh(e){return-1!==this._activeMeshes.indexOf(e)}isReady(e=!1){if(e)for(const e of this._postProcesses)if(e&&!e.isReady())return!1;return super.isReady(e)}_initCache(){super._initCache(),this._cache.position=new S(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new S(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.obliqueAngle=void 0,this._cache.obliqueLength=void 0,this._cache.obliqueOffset=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0}_updateCache(e){e||super._updateCache(),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)}_isSynchronized(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()}_isSynchronizedViewMatrix(){return!!super._isSynchronized()&&this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent()}_isSynchronizedProjectionMatrix(){let e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return!1;const t=this.getEngine();return this.mode===ps.PERSPECTIVE_CAMERA?e=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===t.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:(e=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===t.getRenderWidth()&&this._cache.renderHeight===t.getRenderHeight(),this.oblique&&(e=e&&this._cache.obliqueAngle===this.oblique.angle&&this._cache.obliqueLength===this.oblique.length&&this._cache.obliqueOffset===this.oblique.offset)),e}attachControl(e,t){}detachControl(e){}update(){this._checkInputs(),this.cameraRigMode!==ps.RIG_MODE_NONE&&this._updateRigCameras(),this.getViewMatrix(),this.getProjectionMatrix()}_checkInputs(){this.onAfterCheckInputsObservable.notifyObservers(this)}get rigCameras(){return this._rigCameras}get rigPostProcess(){return this._rigPostProcess}_getFirstPostProcess(){for(let e=0;e<this._postProcesses.length;e++)if(null!==this._postProcesses[e])return this._postProcesses[e];return null}_cascadePostProcessesToRigCams(){const e=this._getFirstPostProcess();e&&e.markTextureDirty();for(let e=0,t=this._rigCameras.length;e<t;e++){const t=this._rigCameras[e],i=t._rigPostProcess;i?("pass"===i.getEffectName()&&(t.isIntermediate=0===this._postProcesses.length),t._postProcesses=this._postProcesses.slice(0).concat(i),i.markTextureDirty()):t._postProcesses=this._postProcesses.slice(0)}}attachPostProcess(e,t=null){return!e.isReusable()&&this._postProcesses.indexOf(e)>-1?(k.Error("You're trying to reuse a post process not defined as reusable."),0):(null==t||t<0?this._postProcesses.push(e):null===this._postProcesses[t]?this._postProcesses[t]=e:this._postProcesses.splice(t,0,e),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(e))}detachPostProcess(e){const t=this._postProcesses.indexOf(e);-1!==t&&(this._postProcesses[t]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()}getWorldMatrix(){return this._isSynchronizedViewMatrix()||this.getViewMatrix(),this._worldMatrix}_getViewMatrix(){return y.Identity()}getViewMatrix(e){return!e&&this._isSynchronizedViewMatrix()||(this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix)),this._computedViewMatrix}freezeProjectionMatrix(e){this._doNotComputeProjectionMatrix=!0,void 0!==e&&(this._projectionMatrix=e)}unfreezeProjectionMatrix(){this._doNotComputeProjectionMatrix=!1}getProjectionMatrix(e){var t,i,s,r,n,o,a,l,h,c,u,d,p,_,f,m,g,v,x;if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;const T=this.getEngine(),E=this.getScene(),S=T.useReverseDepthBuffer;if(this.mode===ps.PERSPECTIVE_CAMERA){let e;this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=T.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1),e=E.useRightHandedSystem?y.PerspectiveFovRHToRef:y.PerspectiveFovLHToRef,e(this.fov,T.getAspectRatio(this),S?this.maxZ:this.minZ,S?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===ps.FOVMODE_VERTICAL_FIXED,T.isNDCHalfZRange,this.projectionPlaneTilt,S)}else{const e=T.getRenderWidth()/2,b=T.getRenderHeight()/2;E.useRightHandedSystem?this.oblique?y.ObliqueOffCenterRHToRef(null!==(t=this.orthoLeft)&&void 0!==t?t:-e,null!==(i=this.orthoRight)&&void 0!==i?i:e,null!==(s=this.orthoBottom)&&void 0!==s?s:-b,null!==(r=this.orthoTop)&&void 0!==r?r:b,S?this.maxZ:this.minZ,S?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,T.isNDCHalfZRange):y.OrthoOffCenterRHToRef(null!==(n=this.orthoLeft)&&void 0!==n?n:-e,null!==(o=this.orthoRight)&&void 0!==o?o:e,null!==(a=this.orthoBottom)&&void 0!==a?a:-b,null!==(l=this.orthoTop)&&void 0!==l?l:b,S?this.maxZ:this.minZ,S?this.minZ:this.maxZ,this._projectionMatrix,T.isNDCHalfZRange):this.oblique?y.ObliqueOffCenterLHToRef(null!==(h=this.orthoLeft)&&void 0!==h?h:-e,null!==(c=this.orthoRight)&&void 0!==c?c:e,null!==(u=this.orthoBottom)&&void 0!==u?u:-b,null!==(d=this.orthoTop)&&void 0!==d?d:b,S?this.maxZ:this.minZ,S?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,T.isNDCHalfZRange):y.OrthoOffCenterLHToRef(null!==(p=this.orthoLeft)&&void 0!==p?p:-e,null!==(_=this.orthoRight)&&void 0!==_?_:e,null!==(f=this.orthoBottom)&&void 0!==f?f:-b,null!==(m=this.orthoTop)&&void 0!==m?m:b,S?this.maxZ:this.minZ,S?this.minZ:this.maxZ,this._projectionMatrix,T.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.obliqueAngle=null===(g=this.oblique)||void 0===g?void 0:g.angle,this._cache.obliqueLength=null===(v=this.oblique)||void 0===v?void 0:v.length,this._cache.obliqueOffset=null===(x=this.oblique)||void 0===x?void 0:x.offset,this._cache.renderWidth=T.getRenderWidth(),this._cache.renderHeight=T.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix}getTransformationMatrix(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix}_computeObliqueDistance(e){return(this.radius||(this.target?S.Distance(this.position,this.target):this.position.length()))+e}_updateFrustumPlanes(){this._refreshFrustumPlanes&&(this.getTransformationMatrix(),this._frustumPlanes?Li.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Li.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)}isInFrustum(e,t=!1){if(this._updateFrustumPlanes(),t&&this.rigCameras.length>0){let t=!1;return this.rigCameras.forEach((i=>{i._updateFrustumPlanes(),t=t||e.isInFrustum(i._frustumPlanes)})),t}return e.isInFrustum(this._frustumPlanes)}isCompletelyInFrustum(e){return this._updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)}getForwardRay(e=100,t,i){throw $("Ray")}getForwardRayToRef(e,t=100,i,s){throw $("Ray")}dispose(e,t=!1){for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){const e=this._rigCameras.pop();e&&e.dispose()}if(this._parentContainer){const e=this._parentContainer.cameras.indexOf(this);e>-1&&this._parentContainer.cameras.splice(e,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==ps.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else{let e=this._postProcesses.length;for(;--e>=0;){const t=this._postProcesses[e];t&&t.dispose(this)}}let i=this.customRenderTargets.length;for(;--i>=0;)this.customRenderTargets[i].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),super.dispose(e,t)}get isLeftCamera(){return this._isLeftCamera}get isRightCamera(){return this._isRightCamera}get leftCamera(){return this._rigCameras.length<1?null:this._rigCameras[0]}get rightCamera(){return this._rigCameras.length<2?null:this._rigCameras[1]}getLeftTarget(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()}getRightTarget(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()}setCameraRigMode(e,t){if(this.cameraRigMode!==e){for(;this._rigCameras.length>0;){const e=this._rigCameras.pop();e&&e.dispose()}if(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=t.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=Ht.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==ps.RIG_MODE_NONE){const e=this.createRigCamera(this.name+"_L",0);e&&(e._isLeftCamera=!0);const t=this.createRigCamera(this.name+"_R",1);t&&(t._isRightCamera=!0),e&&t&&(this._rigCameras.push(e),this._rigCameras.push(t))}this._setRigMode(t),this._cascadePostProcessesToRigCams(),this.update()}}_setRigMode(e){}_getVRProjectionMatrix(){return y.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix}setCameraRigParameter(e,t){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=t,"interaxialDistance"===e&&(this._cameraRigParams.stereoHalfAngle=Ht.ToRadians(t/.0637))}createRigCamera(e,t){return null}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov,this._rigCameras[e].upVector.copyFrom(this.upVector);this.cameraRigMode===ps.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)}_setupInputs(){}serialize(){const e=de.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(e),this.inputs&&this.inputs.serialize(e),de.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}clone(e,t=null){const i=de.Clone(ps.GetConstructorFromName(this.getClassName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return i.name=e,i.parent=t,this.onClonedObservable.notifyObservers(i),i}getDirection(e){const t=S.Zero();return this.getDirectionToRef(e,t),t}get absoluteRotation(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation}getDirectionToRef(e,t){S.TransformNormalToRef(e,this.getWorldMatrix(),t)}static GetConstructorFromName(e,t,i,s=0,r=!0){return ve.Construct(e,t,i,{interaxial_distance:s,isStereoscopicSideBySide:r})||(()=>ps._CreateDefaultParsedCamera(t,i))}computeWorldMatrix(){return this.getWorldMatrix()}static Parse(e,t){const i=e.type,s=ps.GetConstructorFromName(i,e.name,t,e.interaxial_distance,e.isStereoscopicSideBySide),r=de.Parse(s,e,t);if(void 0!==e.parentId&&(r._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),r.inputs&&(r.inputs.parse(e),r._setupInputs()),e.upVector&&(r.upVector=S.FromArray(e.upVector)),r.setPosition&&(r.position.copyFromFloats(0,0,0),r.setPosition(S.FromArray(e.position))),e.target&&r.setTarget&&r.setTarget(S.FromArray(e.target)),e.cameraRigMode){const t=e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{};r.setCameraRigMode(e.cameraRigMode,t)}if(e.animations){for(let t=0;t<e.animations.length;t++){const i=e.animations[t],s=g("BABYLON.Animation");s&&r.animations.push(s.Parse(i))}ve.ParseAnimationRanges(r,e,t)}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),void 0!==e.isEnabled&&r.setEnabled(e.isEnabled),r}_calculateHandednessMultiplier(){let e=this.getScene().useRightHandedSystem?-1:1;return this.parent&&this.parent._getWorldMatrixDeterminant()<0&&(e*=-1),e}}ps._CreateDefaultParsedCamera=(e,t)=>{throw $("UniversalCamera")},ps.PERSPECTIVE_CAMERA=0,ps.ORTHOGRAPHIC_CAMERA=1,ps.FOVMODE_VERTICAL_FIXED=0,ps.FOVMODE_HORIZONTAL_FIXED=1,ps.RIG_MODE_NONE=0,ps.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,ps.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,ps.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,ps.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,ps.RIG_MODE_STEREOSCOPIC_INTERLACED=14,ps.RIG_MODE_VR=20,ps.RIG_MODE_CUSTOM=22,ps.ForceAttachControlToAlwaysPreventDefault=!1,me([ae("position")],ps.prototype,"_position",void 0),me([ae("upVector")],ps.prototype,"_upVector",void 0),me([ie()],ps.prototype,"orthoLeft",null),me([ie()],ps.prototype,"orthoRight",null),me([ie()],ps.prototype,"orthoBottom",null),me([ie()],ps.prototype,"orthoTop",null),me([ie()],ps.prototype,"fov",void 0),me([ie()],ps.prototype,"projectionPlaneTilt",void 0),me([ie()],ps.prototype,"minZ",void 0),me([ie()],ps.prototype,"maxZ",void 0),me([ie()],ps.prototype,"inertia",void 0),me([ie()],ps.prototype,"mode",null),me([ie()],ps.prototype,"layerMask",void 0),me([ie()],ps.prototype,"fovMode",void 0),me([ie()],ps.prototype,"cameraRigMode",void 0),me([ie()],ps.prototype,"interaxialDistance",void 0),me([ie()],ps.prototype,"isStereoscopicSideBySide",void 0);class _s{constructor(e,t,i){this.bu=e,this.bv=t,this.distance=i,this.faceId=0,this.subMeshId=0}}class fs{constructor(e,t,i){this.vectors=d.BuildArray(8,S.Zero),this.center=S.Zero(),this.centerWorld=S.Zero(),this.extendSize=S.Zero(),this.extendSizeWorld=S.Zero(),this.directions=d.BuildArray(3,S.Zero),this.vectorsWorld=d.BuildArray(8,S.Zero),this.minimumWorld=S.Zero(),this.maximumWorld=S.Zero(),this.minimum=S.Zero(),this.maximum=S.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(e,t,i)}reConstruct(e,t,i){const s=e.x,r=e.y,n=e.z,o=t.x,a=t.y,l=t.z,h=this.vectors;this.minimum.copyFromFloats(s,r,n),this.maximum.copyFromFloats(o,a,l),h[0].copyFromFloats(s,r,n),h[1].copyFromFloats(o,a,l),h[2].copyFromFloats(o,r,n),h[3].copyFromFloats(s,a,n),h[4].copyFromFloats(s,r,l),h[5].copyFromFloats(o,a,n),h[6].copyFromFloats(s,a,l),h[7].copyFromFloats(o,r,l),t.addToRef(e,this.center).scaleInPlace(.5),t.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=i||y.IdentityReadOnly,this._update(this._worldMatrix)}scale(e){const t=fs._TmpVector3,i=this.maximum.subtractToRef(this.minimum,t[0]),s=i.length();i.normalizeFromLength(s);const r=s*e,n=i.scaleInPlace(.5*r),o=this.center.subtractToRef(n,t[1]),a=this.center.addToRef(n,t[2]);return this.reConstruct(o,a,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){const t=this.minimumWorld,i=this.maximumWorld,s=this.directions,r=this.vectorsWorld,n=this.vectors;if(e.isIdentity()){t.copyFrom(this.minimum),i.copyFrom(this.maximum);for(let e=0;e<8;++e)r[e].copyFrom(n[e]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{t.setAll(Number.MAX_VALUE),i.setAll(-Number.MAX_VALUE);for(let s=0;s<8;++s){const o=r[s];S.TransformCoordinatesToRef(n[s],e,o),t.minimizeInPlace(o),i.maximizeInPlace(o)}i.subtractToRef(t,this.extendSizeWorld).scaleInPlace(.5),i.addToRef(t,this.centerWorld).scaleInPlace(.5)}S.FromArrayToRef(e.m,0,s[0]),S.FromArrayToRef(e.m,4,s[1]),S.FromArrayToRef(e.m,8,s[2]),this._worldMatrix=e}isInFrustum(e){return fs.IsInFrustum(this.vectorsWorld,e)}isCompletelyInFrustum(e){return fs.IsCompletelyInFrustum(this.vectorsWorld,e)}intersectsPoint(e){const t=this.minimumWorld,i=this.maximumWorld,s=t.x,r=t.y,n=t.z,o=i.x,a=i.y,l=i.z,h=e.x,c=e.y,d=e.z,p=-u;return!(o-h<p||p>h-s||a-c<p||p>c-r||l-d<p||p>d-n)}intersectsSphere(e){return fs.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)}intersectsMinMax(e,t){const i=this.minimumWorld,s=this.maximumWorld,r=i.x,n=i.y,o=i.z,a=s.x,l=s.y,h=s.z,c=e.x,u=e.y,d=e.z,p=t.x,_=t.y,f=t.z;return!(a<c||r>p||l<u||n>_||h<d||o>f)}dispose(){var e,t;null===(e=this._drawWrapperFront)||void 0===e||e.dispose(),null===(t=this._drawWrapperBack)||void 0===t||t.dispose()}static Intersects(e,t){return e.intersectsMinMax(t.minimumWorld,t.maximumWorld)}static IntersectsSphere(e,t,i,s){const r=fs._TmpVector3[0];return S.ClampToRef(i,e,t,r),S.DistanceSquared(i,r)<=s*s}static IsCompletelyInFrustum(e,t){for(let i=0;i<6;++i){const s=t[i];for(let t=0;t<8;++t)if(s.dotCoordinate(e[t])<0)return!1}return!0}static IsInFrustum(e,t){for(let i=0;i<6;++i){let s=!0;const r=t[i];for(let t=0;t<8;++t)if(r.dotCoordinate(e[t])>=0){s=!1;break}if(s)return!1}return!0}}fs._TmpVector3=d.BuildArray(3,S.Zero);class ms{constructor(e,t,i){this.center=S.Zero(),this.centerWorld=S.Zero(),this.minimum=S.Zero(),this.maximum=S.Zero(),this.reConstruct(e,t,i)}reConstruct(e,t,i){this.minimum.copyFrom(e),this.maximum.copyFrom(t);const s=S.Distance(e,t);t.addToRef(e,this.center).scaleInPlace(.5),this.radius=.5*s,this._update(i||y.IdentityReadOnly)}scale(e){const t=this.radius*e,i=ms._TmpVector3,s=i[0].setAll(t),r=this.center.subtractToRef(s,i[1]),n=this.center.addToRef(s,i[2]);return this.reConstruct(r,n,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){if(e.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{S.TransformCoordinatesToRef(this.center,e,this.centerWorld);const t=ms._TmpVector3[0];S.TransformNormalFromFloatsToRef(1,1,1,e,t),this.radiusWorld=Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))*this.radius}}isInFrustum(e){const t=this.centerWorld,i=this.radiusWorld;for(let s=0;s<6;s++)if(e[s].dotCoordinate(t)<=-i)return!1;return!0}isCenterInFrustum(e){const t=this.centerWorld;for(let i=0;i<6;i++)if(e[i].dotCoordinate(t)<0)return!1;return!0}intersectsPoint(e){const t=S.DistanceSquared(this.centerWorld,e);return!(this.radiusWorld*this.radiusWorld<t)}static Intersects(e,t){const i=S.DistanceSquared(e.centerWorld,t.centerWorld),s=e.radiusWorld+t.radiusWorld;return!(s*s<i)}static CreateFromCenterAndRadius(e,t,i){this._TmpVector3[0].copyFrom(e),this._TmpVector3[1].copyFromFloats(0,0,t),this._TmpVector3[2].copyFrom(e),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);const s=new ms(this._TmpVector3[0],this._TmpVector3[2]);return s._worldMatrix=i||y.Identity(),s}}ms._TmpVector3=d.BuildArray(3,S.Zero);const gs={min:0,max:0},vs={min:0,max:0},xs=(e,t,i)=>{const s=S.Dot(t.centerWorld,e),r=Math.abs(S.Dot(t.directions[0],e))*t.extendSize.x+Math.abs(S.Dot(t.directions[1],e))*t.extendSize.y+Math.abs(S.Dot(t.directions[2],e))*t.extendSize.z;i.min=s-r,i.max=s+r},Ts=(e,t,i)=>(xs(e,t,gs),xs(e,i,vs),!(gs.min>vs.max||vs.min>gs.max));class Es{constructor(e,t,i){this._isLocked=!1,this.boundingBox=new fs(e,t,i),this.boundingSphere=new ms(e,t,i)}reConstruct(e,t,i){this.boundingBox.reConstruct(e,t,i),this.boundingSphere.reConstruct(e,t,i)}get minimum(){return this.boundingBox.minimum}get maximum(){return this.boundingBox.maximum}get isLocked(){return this._isLocked}set isLocked(e){this._isLocked=e}update(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))}centerOn(e,t){const i=Es._TmpVector3[0].copyFrom(e).subtractInPlace(t),s=Es._TmpVector3[1].copyFrom(e).addInPlace(t);return this.boundingBox.reConstruct(i,s,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(i,s,this.boundingBox.getWorldMatrix()),this}encapsulate(e){const t=S.Minimize(this.minimum,e),i=S.Maximize(this.maximum,e);return this.reConstruct(t,i,this.boundingBox.getWorldMatrix()),this}encapsulateBoundingInfo(e){const t=R.Matrix[0];this.boundingBox.getWorldMatrix().invertToRef(t);const i=R.Vector3[0];return S.TransformCoordinatesToRef(e.boundingBox.minimumWorld,t,i),this.encapsulate(i),S.TransformCoordinatesToRef(e.boundingBox.maximumWorld,t,i),this.encapsulate(i),this}scale(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this}isInFrustum(e,t=0){return!(2!==t&&3!==t||!this.boundingSphere.isCenterInFrustum(e))||!!this.boundingSphere.isInFrustum(e)&&(!(1!==t&&3!==t)||this.boundingBox.isInFrustum(e))}get diagonalLength(){const e=this.boundingBox;return e.maximumWorld.subtractToRef(e.minimumWorld,Es._TmpVector3[0]).length()}isCompletelyInFrustum(e){return this.boundingBox.isCompletelyInFrustum(e)}_checkCollision(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}intersectsPoint(e){return!!this.boundingSphere.centerWorld&&!!this.boundingSphere.intersectsPoint(e)&&!!this.boundingBox.intersectsPoint(e)}intersects(e,t){if(!ms.Intersects(this.boundingSphere,e.boundingSphere))return!1;if(!fs.Intersects(this.boundingBox,e.boundingBox))return!1;if(!t)return!0;const i=this.boundingBox,s=e.boundingBox;return!!(Ts(i.directions[0],i,s)&&Ts(i.directions[1],i,s)&&Ts(i.directions[2],i,s)&&Ts(s.directions[0],i,s)&&Ts(s.directions[1],i,s)&&Ts(s.directions[2],i,s)&&Ts(S.Cross(i.directions[0],s.directions[0]),i,s)&&Ts(S.Cross(i.directions[0],s.directions[1]),i,s)&&Ts(S.Cross(i.directions[0],s.directions[2]),i,s)&&Ts(S.Cross(i.directions[1],s.directions[0]),i,s)&&Ts(S.Cross(i.directions[1],s.directions[1]),i,s)&&Ts(S.Cross(i.directions[1],s.directions[2]),i,s)&&Ts(S.Cross(i.directions[2],s.directions[0]),i,s)&&Ts(S.Cross(i.directions[2],s.directions[1]),i,s)&&Ts(S.Cross(i.directions[2],s.directions[2]),i,s))}}Es._TmpVector3=d.BuildArray(2,S.Zero);class Ss{static extractMinAndMaxIndexed(e,t,i,s,r,n){for(let o=i;o<i+s;o++){const i=3*t[o],s=e[i],a=e[i+1],l=e[i+2];r.minimizeInPlaceFromFloats(s,a,l),n.maximizeInPlaceFromFloats(s,a,l)}}static extractMinAndMax(e,t,i,s,r,n){for(let o=t,a=t*s;o<t+i;o++,a+=s){const t=e[a],i=e[a+1],s=e[a+2];r.minimizeInPlaceFromFloats(t,i,s),n.maximizeInPlaceFromFloats(t,i,s)}}}function bs(e,t,i,s=null,r){const n=new S(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o=new S(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return r||(r=3),Ss.extractMinAndMax(e,t,i,r,n,o),s&&(n.x-=n.x*s.x+s.y,n.y-=n.y*s.x+s.y,n.z-=n.z*s.x+s.y,o.x+=o.x*s.x+s.y,o.y+=o.y*s.x+s.y,o.z+=o.z*s.x+s.y),{minimum:n,maximum:o}}me([pe.filter(((...[e,t])=>!Array.isArray(e)&&!Array.isArray(t)))],Ss,"extractMinAndMaxIndexed",null),me([pe.filter(((...[e])=>!Array.isArray(e)))],Ss,"extractMinAndMax",null);class Cs{get materialDefines(){var e;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:null===(e=this._getDrawWrapper())||void 0===e?void 0:e.defines}set materialDefines(e){var t;(null!==(t=this._mainDrawWrapperOverride)&&void 0!==t?t:this._getDrawWrapper(void 0,!0)).defines=e}_getDrawWrapper(e,t=!1){e=null!=e?e:this._engine.currentRenderPassId;let i=this._drawWrappers[e];return!i&&t&&(this._drawWrappers[e]=i=new Tt(this._mesh.getScene().getEngine())),i}_removeDrawWrapper(e,t=!0){var i;t&&(null===(i=this._drawWrappers[e])||void 0===i||i.dispose()),this._drawWrappers[e]=void 0}get effect(){var e,t;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:null!==(t=null===(e=this._getDrawWrapper())||void 0===e?void 0:e.effect)&&void 0!==t?t:null}get _drawWrapper(){var e;return null!==(e=this._mainDrawWrapperOverride)&&void 0!==e?e:this._getDrawWrapper(void 0,!0)}get _drawWrapperOverride(){return this._mainDrawWrapperOverride}_setMainDrawWrapperOverride(e){this._mainDrawWrapperOverride=e}setEffect(e,t=null,i,s=!0){const r=this._drawWrapper;r.setEffect(e,t,s),void 0!==i&&(r.materialContext=i),e||(r.defines=null,r.materialContext=void 0)}resetDrawCache(e){if(this._drawWrappers){if(void 0!==e)return void this._removeDrawWrapper(e);for(const e of this._drawWrappers)null==e||e.dispose()}this._drawWrappers=[]}static AddToMesh(e,t,i,s,r,n,o,a=!0){return new Cs(e,t,i,s,r,n,o,a)}constructor(e,t,i,s,r,n,o,a=!0,l=!0){this.materialIndex=e,this.verticesStart=t,this.verticesCount=i,this.indexStart=s,this.indexCount=r,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._wasDispatched=!1,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=n,this._renderingMesh=o||n,l&&n.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=n.subMeshes.length-1,a&&(this.refreshBoundingInfo(),n.computeWorldMatrix(!0))}get IsGlobal(){return 0===this.verticesStart&&this.verticesCount===this._mesh.getTotalVertices()&&0===this.indexStart&&this.indexCount===this._mesh.getTotalIndices()}getBoundingInfo(){return this.IsGlobal||this._mesh.hasThinInstances?this._mesh.getBoundingInfo():this._boundingInfo}setBoundingInfo(e){return this._boundingInfo=e,this}getMesh(){return this._mesh}getRenderingMesh(){return this._renderingMesh}getReplacementMesh(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null}getEffectiveMesh(){return(this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null)||this._renderingMesh}getMaterial(e=!0){var t;const i=null!==(t=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId))&&void 0!==t?t:this._renderingMesh.material;if(!i)return e?this._mesh.getScene().defaultMaterial:null;if(this._isMultiMaterial(i)){const e=i.getSubMaterial(this.materialIndex);return this._currentMaterial!==e&&(this._currentMaterial=e,this.resetDrawCache()),e}return i}_isMultiMaterial(e){return void 0!==e.getSubMaterial}refreshBoundingInfo(e=null){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||(e=this._renderingMesh.getVerticesData(hi.PositionKind)),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;const t=this._renderingMesh.getIndices();let i;if(0===this.indexStart&&this.indexCount===t.length){const e=this._renderingMesh.getBoundingInfo();i={minimum:e.minimum.clone(),maximum:e.maximum.clone()}}else i=function(e,t,i,s,r=null){const n=new S(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o=new S(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return Ss.extractMinAndMaxIndexed(e,t,i,s,n,o),r&&(n.x-=n.x*r.x+r.y,n.y-=n.y*r.x+r.y,n.z-=n.z*r.x+r.y,o.x+=o.x*r.x+r.y,o.y+=o.y*r.x+r.y,o.z+=o.z*r.x+r.y),{minimum:n,maximum:o}}(e,t,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new Es(i.minimum,i.maximum),this}_checkCollision(e){return this.getBoundingInfo()._checkCollision(e)}updateBoundingInfo(e){let t=this.getBoundingInfo();return t||(this.refreshBoundingInfo(),t=this.getBoundingInfo()),t&&t.update(e),this}isInFrustum(e){const t=this.getBoundingInfo();return!!t&&t.isInFrustum(e,this._mesh.cullingStrategy)}isCompletelyInFrustum(e){const t=this.getBoundingInfo();return!!t&&t.isCompletelyInFrustum(e)}render(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this}_getLinesIndexBuffer(e,t){if(!this._linesIndexBuffer){const i=[];for(let t=this.indexStart;t<this.indexStart+this.indexCount;t+=3)i.push(e[t],e[t+1],e[t+1],e[t+2],e[t+2],e[t]);this._linesIndexBuffer=t.createIndexBuffer(i),this._linesIndexCount=i.length}return this._linesIndexBuffer}canIntersects(e){const t=this.getBoundingInfo();return!!t&&e.intersectsBox(t.boundingBox)}intersects(e,t,i,s,r){const n=this.getMaterial();if(!n)return null;let o=3,a=!1;switch(n.fillMode){case 3:case 5:case 6:case 8:return null;case 7:o=1,a=!0}return 4===n.fillMode?i.length?this._intersectLines(e,t,i,this._mesh.intersectionThreshold,s):this._intersectUnIndexedLines(e,t,i,this._mesh.intersectionThreshold,s):!i.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,t,i,s,r):this._intersectTriangles(e,t,i,o,a,s,r)}_intersectLines(e,t,i,s,r){let n=null;for(let o=this.indexStart;o<this.indexStart+this.indexCount;o+=2){const a=t[i[o]],l=t[i[o+1]],h=e.intersectionSegment(a,l,s);if(!(h<0)&&(r||!n||h<n.distance)&&(n=new _s(null,null,h),n.faceId=o/2,r))break}return n}_intersectUnIndexedLines(e,t,i,s,r){let n=null;for(let i=this.verticesStart;i<this.verticesStart+this.verticesCount;i+=2){const o=t[i],a=t[i+1],l=e.intersectionSegment(o,a,s);if(!(l<0)&&(r||!n||l<n.distance)&&(n=new _s(null,null,l),n.faceId=i/2,r))break}return n}_intersectTriangles(e,t,i,s,r,n,o){let a=null,l=-1;for(let h=this.indexStart;h<this.indexStart+this.indexCount-(3-s);h+=s){l++;const s=i[h],c=i[h+1],u=i[h+2];if(r&&4294967295===u){h+=2;continue}const d=t[s],p=t[c],_=t[u];if(!d||!p||!_)continue;if(o&&!o(d,p,_,e,s,c,u))continue;const f=e.intersectsTriangle(d,p,_);if(f){if(f.distance<0)continue;if((n||!a||f.distance<a.distance)&&(a=f,a.faceId=l,n))break}}return a}_intersectUnIndexedTriangles(e,t,i,s,r){let n=null;for(let i=this.verticesStart;i<this.verticesStart+this.verticesCount;i+=3){const o=t[i],a=t[i+1],l=t[i+2];if(r&&!r(o,a,l,e,-1,-1,-1))continue;const h=e.intersectsTriangle(o,a,l);if(h){if(h.distance<0)continue;if((s||!n||h.distance<n.distance)&&(n=h,n.faceId=i/3,s))break}}return n}_rebuild(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)}clone(e,t){const i=new Cs(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e,t,!1);if(!this.IsGlobal){const e=this.getBoundingInfo();if(!e)return i;i._boundingInfo=new Es(e.minimum,e.maximum)}return i}dispose(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);const e=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(e,1),this.resetDrawCache()}getClassName(){return"SubMesh"}static CreateFromIndices(e,t,i,s,r,n=!0){let o=Number.MAX_VALUE,a=-Number.MAX_VALUE;const l=(r||s).getIndices();for(let e=t;e<t+i;e++){const t=l[e];t<o&&(o=t),t>a&&(a=t)}return new Cs(e,o,a-o+1,t,i,s,r,n)}}class ys{}class As{constructor(){var e;this.uniqueId=0,this.metadata={},this._applyTo=(e=this._applyToCoroutine.bind(this),(...t)=>cs(e(...t),undefined)),this.uniqueId=As._UniqueIDGenerator,As._UniqueIDGenerator++}set(e,t){switch(e.length||k.Warn(`Setting vertex data kind '${t}' with an empty array`),t){case hi.PositionKind:this.positions=e;break;case hi.NormalKind:this.normals=e;break;case hi.TangentKind:this.tangents=e;break;case hi.UVKind:this.uvs=e;break;case hi.UV2Kind:this.uvs2=e;break;case hi.UV3Kind:this.uvs3=e;break;case hi.UV4Kind:this.uvs4=e;break;case hi.UV5Kind:this.uvs5=e;break;case hi.UV6Kind:this.uvs6=e;break;case hi.ColorKind:this.colors=e;break;case hi.MatricesIndicesKind:this.matricesIndices=e;break;case hi.MatricesWeightsKind:this.matricesWeights=e;break;case hi.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case hi.MatricesWeightsExtraKind:this.matricesWeightsExtra=e}}applyToMesh(e,t){return this._applyTo(e,t,!1),this}applyToGeometry(e,t){return this._applyTo(e,t,!1),this}updateMesh(e){return this._update(e),this}updateGeometry(e){return this._update(e),this}*_applyToCoroutine(e,t=!1,i){if(this.positions&&(e.setVerticesData(hi.PositionKind,this.positions,t),i&&(yield)),this.normals&&(e.setVerticesData(hi.NormalKind,this.normals,t),i&&(yield)),this.tangents&&(e.setVerticesData(hi.TangentKind,this.tangents,t),i&&(yield)),this.uvs&&(e.setVerticesData(hi.UVKind,this.uvs,t),i&&(yield)),this.uvs2&&(e.setVerticesData(hi.UV2Kind,this.uvs2,t),i&&(yield)),this.uvs3&&(e.setVerticesData(hi.UV3Kind,this.uvs3,t),i&&(yield)),this.uvs4&&(e.setVerticesData(hi.UV4Kind,this.uvs4,t),i&&(yield)),this.uvs5&&(e.setVerticesData(hi.UV5Kind,this.uvs5,t),i&&(yield)),this.uvs6&&(e.setVerticesData(hi.UV6Kind,this.uvs6,t),i&&(yield)),this.colors&&(e.setVerticesData(hi.ColorKind,this.colors,t),i&&(yield)),this.matricesIndices&&(e.setVerticesData(hi.MatricesIndicesKind,this.matricesIndices,t),i&&(yield)),this.matricesWeights&&(e.setVerticesData(hi.MatricesWeightsKind,this.matricesWeights,t),i&&(yield)),this.matricesIndicesExtra&&(e.setVerticesData(hi.MatricesIndicesExtraKind,this.matricesIndicesExtra,t),i&&(yield)),this.matricesWeightsExtra&&(e.setVerticesData(hi.MatricesWeightsExtraKind,this.matricesWeightsExtra,t),i&&(yield)),this.indices?(e.setIndices(this.indices,null,t),i&&(yield)):e.setIndices([],null),e.subMeshes&&this.materialInfos&&this.materialInfos.length>1){const t=e;t.subMeshes=[];for(const e of this.materialInfos)new Cs(e.materialIndex,e.verticesStart,e.verticesCount,e.indexStart,e.indexCount,t)}return this}_update(e,t,i){return this.positions&&e.updateVerticesData(hi.PositionKind,this.positions,t,i),this.normals&&e.updateVerticesData(hi.NormalKind,this.normals,t,i),this.tangents&&e.updateVerticesData(hi.TangentKind,this.tangents,t,i),this.uvs&&e.updateVerticesData(hi.UVKind,this.uvs,t,i),this.uvs2&&e.updateVerticesData(hi.UV2Kind,this.uvs2,t,i),this.uvs3&&e.updateVerticesData(hi.UV3Kind,this.uvs3,t,i),this.uvs4&&e.updateVerticesData(hi.UV4Kind,this.uvs4,t,i),this.uvs5&&e.updateVerticesData(hi.UV5Kind,this.uvs5,t,i),this.uvs6&&e.updateVerticesData(hi.UV6Kind,this.uvs6,t,i),this.colors&&e.updateVerticesData(hi.ColorKind,this.colors,t,i),this.matricesIndices&&e.updateVerticesData(hi.MatricesIndicesKind,this.matricesIndices,t,i),this.matricesWeights&&e.updateVerticesData(hi.MatricesWeightsKind,this.matricesWeights,t,i),this.matricesIndicesExtra&&e.updateVerticesData(hi.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,i),this.matricesWeightsExtra&&e.updateVerticesData(hi.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,i),this.indices&&e.setIndices(this.indices,null),this}static _TransformVector3Coordinates(e,t,i=0,s=e.length){const r=R.Vector3[0],n=R.Vector3[1];for(let o=i;o<i+s;o+=3)S.FromArrayToRef(e,o,r),S.TransformCoordinatesToRef(r,t,n),e[o]=n.x,e[o+1]=n.y,e[o+2]=n.z}static _TransformVector3Normals(e,t,i=0,s=e.length){const r=R.Vector3[0],n=R.Vector3[1];for(let o=i;o<i+s;o+=3)S.FromArrayToRef(e,o,r),S.TransformNormalToRef(r,t,n),e[o]=n.x,e[o+1]=n.y,e[o+2]=n.z}static _TransformVector4Normals(e,t,i=0,s=e.length){const r=R.Vector4[0],n=R.Vector4[1];for(let o=i;o<i+s;o+=4)b.FromArrayToRef(e,o,r),b.TransformNormalToRef(r,t,n),e[o]=n.x,e[o+1]=n.y,e[o+2]=n.z,e[o+3]=n.w}static _FlipFaces(e,t=0,i=e.length){for(let s=t;s<t+i;s+=3){const t=e[s+1];e[s+1]=e[s+2],e[s+2]=t}}transform(e){const t=e.determinant()<0;return this.positions&&As._TransformVector3Coordinates(this.positions,e),this.normals&&As._TransformVector3Normals(this.normals,e),this.tangents&&As._TransformVector4Normals(this.tangents,e),t&&this.indices&&As._FlipFaces(this.indices),this}splitBasedOnMaterialID(){if(!this.materialInfos||this.materialInfos.length<2)return[this];const e=[];for(const t of this.materialInfos){const i=new As;if(this.positions&&(i.positions=this.positions.slice(3*t.verticesStart,3*(t.verticesCount+t.verticesStart))),this.normals&&(i.normals=this.normals.slice(3*t.verticesStart,3*(t.verticesCount+t.verticesStart))),this.tangents&&(i.tangents=this.tangents.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.colors&&(i.colors=this.colors.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.uvs&&(i.uvs=this.uvs.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs2&&(i.uvs2=this.uvs2.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs3&&(i.uvs3=this.uvs3.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs4&&(i.uvs4=this.uvs4.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs5&&(i.uvs5=this.uvs5.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs6&&(i.uvs6=this.uvs6.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.matricesIndices&&(i.matricesIndices=this.matricesIndices.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.matricesIndicesExtra&&(i.matricesIndicesExtra=this.matricesIndicesExtra.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.matricesWeights&&(i.matricesWeights=this.matricesWeights.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.matricesWeightsExtra&&(i.matricesWeightsExtra=this.matricesWeightsExtra.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.indices){i.indices=[];for(let e=t.indexStart;e<t.indexStart+t.indexCount;e++)i.indices.push(this.indices[e]-t.verticesStart)}const s=new ys;s.indexStart=0,s.indexCount=i.indices?i.indices.length:0,s.materialIndex=t.materialIndex,s.verticesStart=0,s.verticesCount=(i.positions?i.positions.length:0)/3,i.materialInfos=[s],e.push(i)}return e}merge(e,t=!1,i=!1,s=!1,r=!1){const n=Array.isArray(e)?e.map((e=>({vertexData:e}))):[{vertexData:e}];return cs(this._mergeCoroutine(void 0,n,t,!1,i,s,r))}*_mergeCoroutine(e,t,i=!1,s,r,n=!1,o=!1){var a,l,h,c;this._validate();let u=t.map((e=>e.vertexData)),d=this;if(o)for(const e of u)e&&(e._validate(),!this.normals&&e.normals&&(this.normals=new Float32Array(this.positions.length)),!this.tangents&&e.tangents&&(this.tangents=new Float32Array(this.positions.length/3*4)),!this.uvs&&e.uvs&&(this.uvs=new Float32Array(this.positions.length/3*2)),!this.uvs2&&e.uvs2&&(this.uvs2=new Float32Array(this.positions.length/3*2)),!this.uvs3&&e.uvs3&&(this.uvs3=new Float32Array(this.positions.length/3*2)),!this.uvs4&&e.uvs4&&(this.uvs4=new Float32Array(this.positions.length/3*2)),!this.uvs5&&e.uvs5&&(this.uvs5=new Float32Array(this.positions.length/3*2)),!this.uvs6&&e.uvs6&&(this.uvs6=new Float32Array(this.positions.length/3*2)),!this.colors&&e.colors&&(this.colors=new Float32Array(this.positions.length/3*4),this.colors.fill(1)),!this.matricesIndices&&e.matricesIndices&&(this.matricesIndices=new Float32Array(this.positions.length/3*4)),!this.matricesWeights&&e.matricesWeights&&(this.matricesWeights=new Float32Array(this.positions.length/3*4)),!this.matricesIndicesExtra&&e.matricesIndicesExtra&&(this.matricesIndicesExtra=new Float32Array(this.positions.length/3*4)),!this.matricesWeightsExtra&&e.matricesWeightsExtra&&(this.matricesWeightsExtra=new Float32Array(this.positions.length/3*4)));for(const e of u)if(e)if(o)this.normals&&!e.normals&&(e.normals=new Float32Array(e.positions.length)),this.tangents&&!e.tangents&&(e.tangents=new Float32Array(e.positions.length/3*4)),this.uvs&&!e.uvs&&(e.uvs=new Float32Array(e.positions.length/3*2)),this.uvs2&&!e.uvs2&&(e.uvs2=new Float32Array(e.positions.length/3*2)),this.uvs3&&!e.uvs3&&(e.uvs3=new Float32Array(e.positions.length/3*2)),this.uvs4&&!e.uvs4&&(e.uvs4=new Float32Array(e.positions.length/3*2)),this.uvs5&&!e.uvs5&&(e.uvs5=new Float32Array(e.positions.length/3*2)),this.uvs6&&!e.uvs6&&(e.uvs6=new Float32Array(e.positions.length/3*2)),this.colors&&!e.colors&&(e.colors=new Float32Array(e.positions.length/3*4),e.colors.fill(1)),this.matricesIndices&&!e.matricesIndices&&(e.matricesIndices=new Float32Array(e.positions.length/3*4)),this.matricesWeights&&!e.matricesWeights&&(e.matricesWeights=new Float32Array(e.positions.length/3*4)),this.matricesIndicesExtra&&!e.matricesIndicesExtra&&(e.matricesIndicesExtra=new Float32Array(e.positions.length/3*4)),this.matricesWeightsExtra&&!e.matricesWeightsExtra&&(e.matricesWeightsExtra=new Float32Array(e.positions.length/3*4));else if(e._validate(),!this.normals!=!e.normals||!this.tangents!=!e.tangents||!this.uvs!=!e.uvs||!this.uvs2!=!e.uvs2||!this.uvs3!=!e.uvs3||!this.uvs4!=!e.uvs4||!this.uvs5!=!e.uvs5||!this.uvs6!=!e.uvs6||!this.colors!=!e.colors||!this.matricesIndices!=!e.matricesIndices||!this.matricesWeights!=!e.matricesWeights||!this.matricesIndicesExtra!=!e.matricesIndicesExtra||!this.matricesWeightsExtra!=!e.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes");if(n){let i=0,s=0,r=0;const n=[];let o=null;const a=[];for(const t of this.splitBasedOnMaterialID())a.push({vertexData:t,transform:e});for(const e of t)if(e.vertexData)for(const t of e.vertexData.splitBasedOnMaterialID())a.push({vertexData:t,transform:e.transform});a.sort(((e,t)=>{const i=e.vertexData.materialInfos?e.vertexData.materialInfos[0].materialIndex:0,s=t.vertexData.materialInfos?t.vertexData.materialInfos[0].materialIndex:0;return i>s?1:i===s?0:-1}));for(const e of a){const t=e.vertexData;if(i=t.materialInfos?t.materialInfos[0].materialIndex:0,o&&o.materialIndex===i)o.indexCount+=t.indices.length,o.verticesCount+=t.positions.length/3;else{const e=new ys;e.materialIndex=i,e.indexStart=s,e.indexCount=t.indices.length,e.verticesStart=r,e.verticesCount=t.positions.length/3,n.push(e),o=e}s+=t.indices.length,r+=t.positions.length/3}const l=a.splice(0,1)[0];d=l.vertexData,e=l.transform,u=a.map((e=>e.vertexData)),t=a,this.materialInfos=n}const p=u.reduce(((e,t)=>{var i,s;return e+(null!==(s=null===(i=t.indices)||void 0===i?void 0:i.length)&&void 0!==s?s:0)}),null!==(l=null===(a=d.indices)||void 0===a?void 0:a.length)&&void 0!==l?l:0);let _=r||u.some((e=>e.indices===d.indices))?null===(h=d.indices)||void 0===h?void 0:h.slice():d.indices;if(p>0){let r=null!==(c=null==_?void 0:_.length)&&void 0!==c?c:0;if(_||(_=new Array(p)),_.length!==p){if(Array.isArray(_))_.length=p;else{const e=i||_ instanceof Uint32Array?new Uint32Array(p):new Uint16Array(p);e.set(_),_=e}e&&e.determinant()<0&&As._FlipFaces(_,0,r)}let n=d.positions?d.positions.length/3:0;for(const{vertexData:e,transform:i}of t)if(e.indices){for(let t=0;t<e.indices.length;t++)_[r+t]=e.indices[t]+n;i&&i.determinant()<0&&As._FlipFaces(_,r,e.indices.length),n+=e.positions.length/3,r+=e.indices.length,s&&(yield)}}return this.indices=_,this.positions=As._MergeElement(hi.PositionKind,d.positions,e,t.map((e=>[e.vertexData.positions,e.transform]))),s&&(yield),d.normals&&(this.normals=As._MergeElement(hi.NormalKind,d.normals,e,t.map((e=>[e.vertexData.normals,e.transform]))),s&&(yield)),d.tangents&&(this.tangents=As._MergeElement(hi.TangentKind,d.tangents,e,t.map((e=>[e.vertexData.tangents,e.transform]))),s&&(yield)),d.uvs&&(this.uvs=As._MergeElement(hi.UVKind,d.uvs,e,t.map((e=>[e.vertexData.uvs,e.transform]))),s&&(yield)),d.uvs2&&(this.uvs2=As._MergeElement(hi.UV2Kind,d.uvs2,e,t.map((e=>[e.vertexData.uvs2,e.transform]))),s&&(yield)),d.uvs3&&(this.uvs3=As._MergeElement(hi.UV3Kind,d.uvs3,e,t.map((e=>[e.vertexData.uvs3,e.transform]))),s&&(yield)),d.uvs4&&(this.uvs4=As._MergeElement(hi.UV4Kind,d.uvs4,e,t.map((e=>[e.vertexData.uvs4,e.transform]))),s&&(yield)),d.uvs5&&(this.uvs5=As._MergeElement(hi.UV5Kind,d.uvs5,e,t.map((e=>[e.vertexData.uvs5,e.transform]))),s&&(yield)),d.uvs6&&(this.uvs6=As._MergeElement(hi.UV6Kind,d.uvs6,e,t.map((e=>[e.vertexData.uvs6,e.transform]))),s&&(yield)),d.colors&&(this.colors=As._MergeElement(hi.ColorKind,d.colors,e,t.map((e=>[e.vertexData.colors,e.transform]))),s&&(yield)),d.matricesIndices&&(this.matricesIndices=As._MergeElement(hi.MatricesIndicesKind,d.matricesIndices,e,t.map((e=>[e.vertexData.matricesIndices,e.transform]))),s&&(yield)),d.matricesWeights&&(this.matricesWeights=As._MergeElement(hi.MatricesWeightsKind,d.matricesWeights,e,t.map((e=>[e.vertexData.matricesWeights,e.transform]))),s&&(yield)),d.matricesIndicesExtra&&(this.matricesIndicesExtra=As._MergeElement(hi.MatricesIndicesExtraKind,d.matricesIndicesExtra,e,t.map((e=>[e.vertexData.matricesIndicesExtra,e.transform]))),s&&(yield)),d.matricesWeightsExtra&&(this.matricesWeightsExtra=As._MergeElement(hi.MatricesWeightsExtraKind,d.matricesWeightsExtra,e,t.map((e=>[e.vertexData.matricesWeightsExtra,e.transform])))),this}static _MergeElement(e,t,i,s){const r=s.filter((e=>null!==e[0]&&void 0!==e[0]));if(!t&&0==r.length)return t;if(!t)return this._MergeElement(e,r[0][0],r[0][1],r.slice(1));const n=r.reduce(((e,t)=>e+t[0].length),t.length),o=e===hi.PositionKind?As._TransformVector3Coordinates:e===hi.NormalKind?As._TransformVector3Normals:e===hi.TangentKind?As._TransformVector4Normals:()=>{};if(t instanceof Float32Array){const e=new Float32Array(n);e.set(t),i&&o(e,i,0,t.length);let s=t.length;for(const[t,i]of r)e.set(t,s),i&&o(e,i,s,t.length),s+=t.length;return e}{const e=new Array(n);for(let i=0;i<t.length;i++)e[i]=t[i];i&&o(e,i,0,t.length);let s=t.length;for(const[t,i]of r){for(let i=0;i<t.length;i++)e[s+i]=t[i];i&&o(e,i,s,t.length),s+=t.length}return e}}_validate(){if(!this.positions)throw new Ue("Positions are required",0);const e=(e,t)=>{const i=hi.DeduceStride(e);if(t.length%i!=0)throw new Error("The "+e+"s array count must be a multiple of "+i);return t.length/i},t=e(hi.PositionKind,this.positions),i=(i,s)=>{const r=e(i,s);if(r!==t)throw new Error("The "+i+"s element count ("+r+") does not match the positions count ("+t+")")};this.normals&&i(hi.NormalKind,this.normals),this.tangents&&i(hi.TangentKind,this.tangents),this.uvs&&i(hi.UVKind,this.uvs),this.uvs2&&i(hi.UV2Kind,this.uvs2),this.uvs3&&i(hi.UV3Kind,this.uvs3),this.uvs4&&i(hi.UV4Kind,this.uvs4),this.uvs5&&i(hi.UV5Kind,this.uvs5),this.uvs6&&i(hi.UV6Kind,this.uvs6),this.colors&&i(hi.ColorKind,this.colors),this.matricesIndices&&i(hi.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&i(hi.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&i(hi.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&i(hi.MatricesWeightsExtraKind,this.matricesWeightsExtra)}clone(){const e=this.serialize();return As.Parse(e)}serialize(){const e={};if(this.positions&&(e.positions=Array.from(this.positions)),this.normals&&(e.normals=Array.from(this.normals)),this.tangents&&(e.tangents=Array.from(this.tangents)),this.uvs&&(e.uvs=Array.from(this.uvs)),this.uvs2&&(e.uvs2=Array.from(this.uvs2)),this.uvs3&&(e.uvs3=Array.from(this.uvs3)),this.uvs4&&(e.uvs4=Array.from(this.uvs4)),this.uvs5&&(e.uvs5=Array.from(this.uvs5)),this.uvs6&&(e.uvs6=Array.from(this.uvs6)),this.colors&&(e.colors=Array.from(this.colors)),this.matricesIndices&&(e.matricesIndices=Array.from(this.matricesIndices),e.matricesIndices._isExpanded=!0),this.matricesWeights&&(e.matricesWeights=Array.from(this.matricesWeights)),this.matricesIndicesExtra&&(e.matricesIndicesExtra=Array.from(this.matricesIndicesExtra),e.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=Array.from(this.matricesWeightsExtra)),e.indices=Array.from(this.indices),this.materialInfos){e.materialInfos=[];for(const t of this.materialInfos){const i={indexStart:t.indexStart,indexCount:t.indexCount,materialIndex:t.materialIndex,verticesStart:t.verticesStart,verticesCount:t.verticesCount};e.materialInfos.push(i)}}return e}static ExtractFromMesh(e,t,i){return As._ExtractFrom(e,t,i)}static ExtractFromGeometry(e,t,i){return As._ExtractFrom(e,t,i)}static _ExtractFrom(e,t,i){const s=new As;return e.isVerticesDataPresent(hi.PositionKind)&&(s.positions=e.getVerticesData(hi.PositionKind,t,i)),e.isVerticesDataPresent(hi.NormalKind)&&(s.normals=e.getVerticesData(hi.NormalKind,t,i)),e.isVerticesDataPresent(hi.TangentKind)&&(s.tangents=e.getVerticesData(hi.TangentKind,t,i)),e.isVerticesDataPresent(hi.UVKind)&&(s.uvs=e.getVerticesData(hi.UVKind,t,i)),e.isVerticesDataPresent(hi.UV2Kind)&&(s.uvs2=e.getVerticesData(hi.UV2Kind,t,i)),e.isVerticesDataPresent(hi.UV3Kind)&&(s.uvs3=e.getVerticesData(hi.UV3Kind,t,i)),e.isVerticesDataPresent(hi.UV4Kind)&&(s.uvs4=e.getVerticesData(hi.UV4Kind,t,i)),e.isVerticesDataPresent(hi.UV5Kind)&&(s.uvs5=e.getVerticesData(hi.UV5Kind,t,i)),e.isVerticesDataPresent(hi.UV6Kind)&&(s.uvs6=e.getVerticesData(hi.UV6Kind,t,i)),e.isVerticesDataPresent(hi.ColorKind)&&(s.colors=e.getVerticesData(hi.ColorKind,t,i)),e.isVerticesDataPresent(hi.MatricesIndicesKind)&&(s.matricesIndices=e.getVerticesData(hi.MatricesIndicesKind,t,i)),e.isVerticesDataPresent(hi.MatricesWeightsKind)&&(s.matricesWeights=e.getVerticesData(hi.MatricesWeightsKind,t,i)),e.isVerticesDataPresent(hi.MatricesIndicesExtraKind)&&(s.matricesIndicesExtra=e.getVerticesData(hi.MatricesIndicesExtraKind,t,i)),e.isVerticesDataPresent(hi.MatricesWeightsExtraKind)&&(s.matricesWeightsExtra=e.getVerticesData(hi.MatricesWeightsExtraKind,t,i)),s.indices=e.getIndices(t,i),s}static CreateRibbon(e){throw $("ribbonBuilder")}static CreateBox(e){throw $("boxBuilder")}static CreateTiledBox(e){throw $("tiledBoxBuilder")}static CreateTiledPlane(e){throw $("tiledPlaneBuilder")}static CreateSphere(e){throw $("sphereBuilder")}static CreateCylinder(e){throw $("cylinderBuilder")}static CreateTorus(e){throw $("torusBuilder")}static CreateLineSystem(e){throw $("linesBuilder")}static CreateDashedLines(e){throw $("linesBuilder")}static CreateGround(e){throw $("groundBuilder")}static CreateTiledGround(e){throw $("groundBuilder")}static CreateGroundFromHeightMap(e){throw $("groundBuilder")}static CreatePlane(e){throw $("planeBuilder")}static CreateDisc(e){throw $("discBuilder")}static CreatePolygon(e,t,i,s,r,n,o){throw $("polygonBuilder")}static CreateIcoSphere(e){throw $("icoSphereBuilder")}static CreatePolyhedron(e){throw $("polyhedronBuilder")}static CreateCapsule(e={orientation:S.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){throw $("capsuleBuilder")}static CreateTorusKnot(e){throw $("torusKnotBuilder")}static ComputeNormals(e,t,i,s){let r=0,n=0,o=0,a=0,l=0,h=0,c=0,u=0,d=0,p=0,_=0,f=0,m=0,g=0,v=0,x=0,T=0,E=0,b=0,C=0,y=!1,A=!1,R=!1,I=!1,P=1,M=0,O=null;s&&(y=!!s.facetNormals,A=!!s.facetPositions,R=!!s.facetPartitioning,P=!0===s.useRightHandedSystem?-1:1,M=s.ratio||0,I=!!s.depthSort,O=s.distanceTo,I&&void 0===O&&(O=S.Zero()));let D=0,N=0,F=0,w=0;for(R&&s&&s.bbSize&&(D=s.subDiv.X*M/s.bbSize.x,N=s.subDiv.Y*M/s.bbSize.y,F=s.subDiv.Z*M/s.bbSize.z,w=s.subDiv.max*s.subDiv.max,s.facetPartitioning.length=0),r=0;r<e.length;r++)i[r]=0;const L=t.length/3|0;for(r=0;r<L;r++){if(f=3*t[3*r],m=f+1,g=f+2,v=3*t[3*r+1],x=v+1,T=v+2,E=3*t[3*r+2],b=E+1,C=E+2,n=e[f]-e[v],o=e[m]-e[x],a=e[g]-e[T],l=e[E]-e[v],h=e[b]-e[x],c=e[C]-e[T],u=P*(o*c-a*h),d=P*(a*l-n*c),p=P*(n*h-o*l),_=Math.sqrt(u*u+d*d+p*p),_=0===_?1:_,u/=_,d/=_,p/=_,y&&s&&(s.facetNormals[r].x=u,s.facetNormals[r].y=d,s.facetNormals[r].z=p),A&&s&&(s.facetPositions[r].x=(e[f]+e[v]+e[E])/3,s.facetPositions[r].y=(e[m]+e[x]+e[b])/3,s.facetPositions[r].z=(e[g]+e[T]+e[C])/3),R&&s){const t=Math.floor((s.facetPositions[r].x-s.bInfo.minimum.x*M)*D),i=Math.floor((s.facetPositions[r].y-s.bInfo.minimum.y*M)*N),n=Math.floor((s.facetPositions[r].z-s.bInfo.minimum.z*M)*F),o=Math.floor((e[f]-s.bInfo.minimum.x*M)*D),a=Math.floor((e[m]-s.bInfo.minimum.y*M)*N),l=Math.floor((e[g]-s.bInfo.minimum.z*M)*F),h=Math.floor((e[v]-s.bInfo.minimum.x*M)*D),c=Math.floor((e[x]-s.bInfo.minimum.y*M)*N),u=Math.floor((e[T]-s.bInfo.minimum.z*M)*F),d=Math.floor((e[E]-s.bInfo.minimum.x*M)*D),p=Math.floor((e[b]-s.bInfo.minimum.y*M)*N),_=Math.floor((e[C]-s.bInfo.minimum.z*M)*F),S=o+s.subDiv.max*a+w*l,y=h+s.subDiv.max*c+w*u,A=d+s.subDiv.max*p+w*_,R=t+s.subDiv.max*i+w*n;s.facetPartitioning[R]=s.facetPartitioning[R]?s.facetPartitioning[R]:new Array,s.facetPartitioning[S]=s.facetPartitioning[S]?s.facetPartitioning[S]:new Array,s.facetPartitioning[y]=s.facetPartitioning[y]?s.facetPartitioning[y]:new Array,s.facetPartitioning[A]=s.facetPartitioning[A]?s.facetPartitioning[A]:new Array,s.facetPartitioning[S].push(r),y!=S&&s.facetPartitioning[y].push(r),A!=y&&A!=S&&s.facetPartitioning[A].push(r),R!=S&&R!=y&&R!=A&&s.facetPartitioning[R].push(r)}if(I&&s&&s.facetPositions){const e=s.depthSortedFacets[r];e.ind=3*r,e.sqDistance=S.DistanceSquared(s.facetPositions[r],O)}i[f]+=u,i[m]+=d,i[g]+=p,i[v]+=u,i[x]+=d,i[T]+=p,i[E]+=u,i[b]+=d,i[C]+=p}for(r=0;r<i.length/3;r++)u=i[3*r],d=i[3*r+1],p=i[3*r+2],_=Math.sqrt(u*u+d*d+p*p),_=0===_?1:_,u/=_,d/=_,p/=_,i[3*r]=u,i[3*r+1]=d,i[3*r+2]=p}static _ComputeSides(e,t,i,s,r,n,o){const a=i.length,l=s.length;let h,c;switch(e=e||As.DEFAULTSIDE){case As.FRONTSIDE:break;case As.BACKSIDE:for(h=0;h<a;h+=3){const e=i[h];i[h]=i[h+2],i[h+2]=e}for(c=0;c<l;c++)s[c]=-s[c];break;case As.DOUBLESIDE:{const e=t.length,u=e/3;for(let i=0;i<e;i++)t[e+i]=t[i];for(h=0;h<a;h+=3)i[h+a]=i[h+2]+u,i[h+1+a]=i[h+1]+u,i[h+2+a]=i[h]+u;for(c=0;c<l;c++)s[l+c]=-s[c];const d=r.length;let p=0;for(p=0;p<d;p++)r[p+d]=r[p];for(n=n||new b(0,0,1,1),o=o||new b(0,0,1,1),p=0,h=0;h<d/2;h++)r[p]=n.x+(n.z-n.x)*r[p],r[p+1]=n.y+(n.w-n.y)*r[p+1],r[p+d]=o.x+(o.z-o.x)*r[p+d],r[p+d+1]=o.y+(o.w-o.y)*r[p+d+1],p+=2;break}}}static Parse(e){const t=new As,i=e.positions;i&&t.set(i,hi.PositionKind);const s=e.normals;s&&t.set(s,hi.NormalKind);const r=e.tangents;r&&t.set(r,hi.TangentKind);const n=e.uvs;n&&t.set(n,hi.UVKind);const o=e.uvs2;o&&t.set(o,hi.UV2Kind);const a=e.uvs3;a&&t.set(a,hi.UV3Kind);const l=e.uvs4;l&&t.set(l,hi.UV4Kind);const h=e.uvs5;h&&t.set(h,hi.UV5Kind);const c=e.uvs6;c&&t.set(c,hi.UV6Kind);const u=e.colors;u&&t.set(F.CheckColors4(u,i.length/3),hi.ColorKind);const d=e.matricesIndices;d&&t.set(d,hi.MatricesIndicesKind);const p=e.matricesWeights;p&&t.set(p,hi.MatricesWeightsKind);const _=e.indices;_&&(t.indices=_);const f=e.materialInfos;if(f){t.materialInfos=[];for(const e of f){const i=new ys;i.indexCount=e.indexCount,i.indexStart=e.indexStart,i.verticesCount=e.verticesCount,i.verticesStart=e.verticesStart,i.materialIndex=e.materialIndex,t.materialInfos.push(i)}}return t}static ImportVertexData(e,t){const i=As.Parse(e);t.setAllVerticesData(i,e.updatable)}}As.FRONTSIDE=0,As.BACKSIDE=1,As.DOUBLESIDE=2,As.DEFAULTSIDE=0,As._UniqueIDGenerator=0,me([pe.filter(((...[e])=>!Array.isArray(e)))],As,"_TransformVector3Coordinates",null),me([pe.filter(((...[e])=>!Array.isArray(e)))],As,"_TransformVector3Normals",null),me([pe.filter(((...[e])=>!Array.isArray(e)))],As,"_TransformVector4Normals",null),me([pe.filter(((...[e])=>!Array.isArray(e)))],As,"_FlipFaces",null);class Rs{static get ForceFullSceneLoadingForIncremental(){return Rs._ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){Rs._ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return Rs._ShowLoadingScreen}static set ShowLoadingScreen(e){Rs._ShowLoadingScreen=e}static get loggingLevel(){return Rs._LoggingLevel}static set loggingLevel(e){Rs._LoggingLevel=e}static get CleanBoneMatrixWeights(){return Rs._CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){Rs._CleanBoneMatrixWeights=e}}Rs._ForceFullSceneLoadingForIncremental=!1,Rs._ShowLoadingScreen=!0,Rs._CleanBoneMatrixWeights=!1,Rs._LoggingLevel=0;class Is{}Is.UseOpenGLOrientationForUV=!1;class Ps{get boundingBias(){return this._boundingBias}set boundingBias(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null)}static CreateGeometryForMesh(e){const t=new Ps(Ps.RandomId(),e.getScene());return t.applyToMesh(e),t}get meshes(){return this._meshes}constructor(e,t,i,s=!1,r=null){this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=t||x.LastCreatedScene,this._scene&&(this.id=e,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=s,i?this.setAllVerticesData(i,s):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),r&&(this.applyToMesh(r),r.computeWorldMatrix(!0)))}get extend(){return this._extend}getScene(){return this._scene}getEngine(){return this._engine}isReady(){return 1===this.delayLoadState||0===this.delayLoadState}get doNotSerialize(){for(let e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0}_rebuild(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable));for(const e in this._vertexBuffers)this._vertexBuffers[e]._rebuild()}setAllVerticesData(e,t){e.applyToGeometry(this,t),this._notifyUpdate()}setVerticesData(e,t,i=!1,s){i&&Array.isArray(t)&&(t=new Float32Array(t));const r=new hi(this._engine,t,e,{updatable:i,postponeInternalCreation:0===this._meshes.length,stride:s,label:"Geometry_"+this.id+"_"+e});this.setVerticesBuffer(r)}removeVerticesData(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()}setVerticesBuffer(e,t=null,i=!0){const s=e.getKind();this._vertexBuffers[s]&&i&&this._vertexBuffers[s].dispose(),e._buffer&&e._buffer._increaseReferences(),this._vertexBuffers[s]=e;const r=this._meshes,n=r.length;if(s===hi.PositionKind){this._totalVertices=null!=t?t:e.totalVertices,this._updateExtend(e.getFloatData()),this._resetPointsArrayCache();const i=this._extend&&this._extend.minimum||new S(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),s=this._extend&&this._extend.maximum||new S(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);for(let e=0;e<n;e++){const t=r[e];t.buildBoundingInfo(i,s),t._createGlobalSubMesh(t.isUnIndexed),t.computeWorldMatrix(!0),t.synchronizeInstances()}}this._notifyUpdate(s)}updateVerticesDataDirectly(e,t,i,s=!1){const r=this.getVertexBuffer(e);r&&(r.updateDirectly(t,i,s),this._notifyUpdate(e))}updateVerticesData(e,t,i=!1){const s=this.getVertexBuffer(e);s&&(s.update(t),e===hi.PositionKind&&this._updateBoundingInfo(i,t),this._notifyUpdate(e))}_updateBoundingInfo(e,t){if(e&&this._updateExtend(t),this._resetPointsArrayCache(),e){const e=this._meshes;for(const t of e){t.hasBoundingInfo?t.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):t.buildBoundingInfo(this._extend.minimum,this._extend.maximum);const e=t.subMeshes;for(const t of e)t.refreshBoundingInfo()}}}_bind(e,t,i,s){if(!e)return;void 0===t&&(t=this._indexBuffer);const r=this.getVertexBuffers();if(!r)return;if(t!=this._indexBuffer||!this._vertexArrayObjects&&!s)return void this._engine.bindBuffers(r,t,e,i);const n=s||this._vertexArrayObjects;n[e.key]||(n[e.key]=this._engine.recordVertexArrayObject(r,t,e,i)),this._engine.bindVertexArrayObject(n[e.key],t)}getTotalVertices(){return this.isReady()?this._totalVertices:0}getVerticesData(e,t,i){const s=this.getVertexBuffer(e);return s?s.getFloatData(this._totalVertices,i||t&&1!==this._meshes.length):null}isVertexBufferUpdatable(e){const t=this._vertexBuffers[e];return!!t&&t.isUpdatable()}getVertexBuffer(e){return this.isReady()?this._vertexBuffers[e]:null}getVertexBuffers(){return this.isReady()?this._vertexBuffers:null}isVerticesDataPresent(e){return this._vertexBuffers?void 0!==this._vertexBuffers[e]:!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)}getVerticesDataKinds(){const e=[];let t;if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e}updateIndices(e,t,i=!1){if(this._indexBuffer)if(this._indexBufferIsUpdatable){const s=e.length!==this._indices.length;if(i||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t),s)for(const e of this._meshes)e._createGlobalSubMesh(!0)}else this.setIndices(e,null,!0)}setIndexBuffer(e,t,i){this._indices=[],this._indexBufferIsUpdatable=!1,this._indexBuffer=e,this._totalVertices=t,this._totalIndices=i,e.is32Bits||(e.is32Bits=this._totalIndices>65535);for(const e of this._meshes)e._createGlobalSubMesh(!0),e.synchronizeInstances();this._notifyUpdate()}setIndices(e,t=null,i=!1){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=i,0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,i)),null!=t&&(this._totalVertices=t);for(const e of this._meshes)e._createGlobalSubMesh(!0),e.synchronizeInstances();this._notifyUpdate()}getTotalIndices(){return this.isReady()?void 0!==this._totalIndices?this._totalIndices:this._indices.length:0}getIndices(e,t){if(!this.isReady())return null;const i=this._indices;return t||e&&1!==this._meshes.length?i.slice():i}getIndexBuffer(){return this.isReady()?this._indexBuffer:null}_releaseVertexArrayObject(e=null){e&&this._vertexArrayObjects&&this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])}releaseForMesh(e,t){const i=this._meshes,s=i.indexOf(e);-1!==s&&(i.splice(s,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,0===i.length&&t&&this.dispose())}applyToMesh(e){if(e._geometry===this)return;const t=e._geometry;t&&t.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();const i=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),i.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo)}_updateExtend(e=null){if(this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!e&&!(e=this.getVerticesData(hi.PositionKind)))return;this._extend=bs(e,0,this._totalVertices,this.boundingBias,3)}}_applyToMesh(e){const t=this._meshes.length;for(const i in this._vertexBuffers)1===t&&this._vertexBuffers[i].create(),i===hi.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(e.isUnIndexed),e._updateBoundingInfo());1===t&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable)),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances()}_notifyUpdate(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(const e of this._meshes)e._markSubMeshesAsAttributesDirty()}load(e,t){2!==this.delayLoadState&&(this.isReady()?t&&t():(this.delayLoadState=2,this._queueLoad(e,t)))}_queueLoad(e,t){this.delayLoadingFile&&(e.addPendingData(this),e._loadFile(this.delayLoadingFile,(i=>{if(!this._delayLoadingFunction)return;this._delayLoadingFunction(JSON.parse(i),this),this.delayLoadState=1,this._delayInfo=[],e.removePendingData(this);const s=this._meshes,r=s.length;for(let e=0;e<r;e++)this._applyToMesh(s[e]);t&&t()}),void 0,!0))}toLeftHanded(){const e=this.getIndices(!1);if(null!=e&&e.length>0){for(let t=0;t<e.length;t+=3){const i=e[t+0];e[t+0]=e[t+2],e[t+2]=i}this.setIndices(e)}const t=this.getVerticesData(hi.PositionKind,!1);if(null!=t&&t.length>0){for(let e=0;e<t.length;e+=3)t[e+2]=-t[e+2];this.setVerticesData(hi.PositionKind,t,!1)}const i=this.getVerticesData(hi.NormalKind,!1);if(null!=i&&i.length>0){for(let e=0;e<i.length;e+=3)i[e+2]=-i[e+2];this.setVerticesData(hi.NormalKind,i,!1)}}_resetPointsArrayCache(){this._positions=null}_generatePointsArray(){if(this._positions)return!0;const e=this.getVerticesData(hi.PositionKind);if(!e||0===e.length)return!1;for(let t=3*this._positionsCache.length,i=this._positionsCache.length;t<e.length;t+=3,++i)this._positionsCache[i]=S.FromArray(e,t);for(let t=0,i=0;t<e.length;t+=3,++i)this._positionsCache[i].set(e[0+t],e[1+t],e[2+t]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,!0}isDisposed(){return this._isDisposed}_disposeVertexArrayObjects(){if(this._vertexArrayObjects){for(const e in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e]);this._vertexArrayObjects={};const e=this._meshes,t=e.length;for(let i=0;i<t;i++)e[i]._invalidateInstanceVertexArrayObject()}}dispose(){const e=this._meshes,t=e.length;let i;for(i=0;i<t;i++)this.releaseForMesh(e[i]);this._meshes.length=0,this._disposeVertexArrayObjects();for(const e in this._vertexBuffers)this._vertexBuffers[e].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){const e=this._parentContainer.geometries.indexOf(this);e>-1&&this._parentContainer.geometries.splice(e,1),this._parentContainer=null}this._isDisposed=!0}copy(e){const t=new As;t.indices=[];const i=this.getIndices();if(i)for(let e=0;e<i.length;e++)t.indices.push(i[e]);let s,r=!1,n=!1;for(s in this._vertexBuffers){const e=this.getVerticesData(s);if(e&&(e instanceof Float32Array?t.set(new Float32Array(e),s):t.set(e.slice(0),s),!n)){const e=this.getVertexBuffer(s);e&&(r=e.isUpdatable(),n=!r)}}const o=new Ps(e,this._scene,t,r);for(s in o.delayLoadState=this.delayLoadState,o.delayLoadingFile=this.delayLoadingFile,o._delayLoadingFunction=this._delayLoadingFunction,this._delayInfo)o._delayInfo=o._delayInfo||[],o._delayInfo.push(s);return o._boundingInfo=new Es(this._extend.minimum,this._extend.maximum),o}serialize(){const e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,j&&j.HasTags(this)&&(e.tags=j.GetTags(this)),e}_toNumberArray(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)}clearCachedData(){this._indices=[],this._resetPointsArrayCache();for(const e in this._vertexBuffers)Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)&&(this._vertexBuffers[e]._buffer._data=null)}serializeVerticeData(){const e=this.serialize();return this.isVerticesDataPresent(hi.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(hi.PositionKind)),this.isVertexBufferUpdatable(hi.PositionKind)&&(e.positions._updatable=!0)),this.isVerticesDataPresent(hi.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(hi.NormalKind)),this.isVertexBufferUpdatable(hi.NormalKind)&&(e.normals._updatable=!0)),this.isVerticesDataPresent(hi.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(hi.TangentKind)),this.isVertexBufferUpdatable(hi.TangentKind)&&(e.tangents._updatable=!0)),this.isVerticesDataPresent(hi.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(hi.UVKind)),this.isVertexBufferUpdatable(hi.UVKind)&&(e.uvs._updatable=!0)),this.isVerticesDataPresent(hi.UV2Kind)&&(e.uvs2=this._toNumberArray(this.getVerticesData(hi.UV2Kind)),this.isVertexBufferUpdatable(hi.UV2Kind)&&(e.uvs2._updatable=!0)),this.isVerticesDataPresent(hi.UV3Kind)&&(e.uvs3=this._toNumberArray(this.getVerticesData(hi.UV3Kind)),this.isVertexBufferUpdatable(hi.UV3Kind)&&(e.uvs3._updatable=!0)),this.isVerticesDataPresent(hi.UV4Kind)&&(e.uvs4=this._toNumberArray(this.getVerticesData(hi.UV4Kind)),this.isVertexBufferUpdatable(hi.UV4Kind)&&(e.uvs4._updatable=!0)),this.isVerticesDataPresent(hi.UV5Kind)&&(e.uvs5=this._toNumberArray(this.getVerticesData(hi.UV5Kind)),this.isVertexBufferUpdatable(hi.UV5Kind)&&(e.uvs5._updatable=!0)),this.isVerticesDataPresent(hi.UV6Kind)&&(e.uvs6=this._toNumberArray(this.getVerticesData(hi.UV6Kind)),this.isVertexBufferUpdatable(hi.UV6Kind)&&(e.uvs6._updatable=!0)),this.isVerticesDataPresent(hi.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(hi.ColorKind)),this.isVertexBufferUpdatable(hi.ColorKind)&&(e.colors._updatable=!0)),this.isVerticesDataPresent(hi.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(hi.MatricesIndicesKind)),e.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(hi.MatricesIndicesKind)&&(e.matricesIndices._updatable=!0)),this.isVerticesDataPresent(hi.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(hi.MatricesWeightsKind)),this.isVertexBufferUpdatable(hi.MatricesWeightsKind)&&(e.matricesWeights._updatable=!0)),e.indices=this._toNumberArray(this.getIndices()),e}static ExtractFromMesh(e,t){const i=e._geometry;return i?i.copy(t):null}static RandomId(){return Ht.RandomId()}static _GetGeometryByLoadedUniqueId(e,t){for(let i=0;i<t.geometries.length;i++)if(t.geometries[i]._loadedUniqueId===e)return t.geometries[i];return null}static _ImportGeometry(e,t){const i=t.getScene(),s=e.geometryUniqueId,r=e.geometryId;if(s||r){const e=s?this._GetGeometryByLoadedUniqueId(s,i):i.getGeometryById(r);e&&e.applyToMesh(t)}else if(e instanceof ArrayBuffer){const i=t._binaryInfo;if(i.positionsAttrDesc&&i.positionsAttrDesc.count>0){const s=new Float32Array(e,i.positionsAttrDesc.offset,i.positionsAttrDesc.count);t.setVerticesData(hi.PositionKind,s,!1)}if(i.normalsAttrDesc&&i.normalsAttrDesc.count>0){const s=new Float32Array(e,i.normalsAttrDesc.offset,i.normalsAttrDesc.count);t.setVerticesData(hi.NormalKind,s,!1)}if(i.tangetsAttrDesc&&i.tangetsAttrDesc.count>0){const s=new Float32Array(e,i.tangetsAttrDesc.offset,i.tangetsAttrDesc.count);t.setVerticesData(hi.TangentKind,s,!1)}if(i.uvsAttrDesc&&i.uvsAttrDesc.count>0){const s=new Float32Array(e,i.uvsAttrDesc.offset,i.uvsAttrDesc.count);if(Is.UseOpenGLOrientationForUV)for(let e=1;e<s.length;e+=2)s[e]=1-s[e];t.setVerticesData(hi.UVKind,s,!1)}if(i.uvs2AttrDesc&&i.uvs2AttrDesc.count>0){const s=new Float32Array(e,i.uvs2AttrDesc.offset,i.uvs2AttrDesc.count);if(Is.UseOpenGLOrientationForUV)for(let e=1;e<s.length;e+=2)s[e]=1-s[e];t.setVerticesData(hi.UV2Kind,s,!1)}if(i.uvs3AttrDesc&&i.uvs3AttrDesc.count>0){const s=new Float32Array(e,i.uvs3AttrDesc.offset,i.uvs3AttrDesc.count);if(Is.UseOpenGLOrientationForUV)for(let e=1;e<s.length;e+=2)s[e]=1-s[e];t.setVerticesData(hi.UV3Kind,s,!1)}if(i.uvs4AttrDesc&&i.uvs4AttrDesc.count>0){const s=new Float32Array(e,i.uvs4AttrDesc.offset,i.uvs4AttrDesc.count);if(Is.UseOpenGLOrientationForUV)for(let e=1;e<s.length;e+=2)s[e]=1-s[e];t.setVerticesData(hi.UV4Kind,s,!1)}if(i.uvs5AttrDesc&&i.uvs5AttrDesc.count>0){const s=new Float32Array(e,i.uvs5AttrDesc.offset,i.uvs5AttrDesc.count);if(Is.UseOpenGLOrientationForUV)for(let e=1;e<s.length;e+=2)s[e]=1-s[e];t.setVerticesData(hi.UV5Kind,s,!1)}if(i.uvs6AttrDesc&&i.uvs6AttrDesc.count>0){const s=new Float32Array(e,i.uvs6AttrDesc.offset,i.uvs6AttrDesc.count);if(Is.UseOpenGLOrientationForUV)for(let e=1;e<s.length;e+=2)s[e]=1-s[e];t.setVerticesData(hi.UV6Kind,s,!1)}if(i.colorsAttrDesc&&i.colorsAttrDesc.count>0){const s=new Float32Array(e,i.colorsAttrDesc.offset,i.colorsAttrDesc.count);t.setVerticesData(hi.ColorKind,s,!1,i.colorsAttrDesc.stride)}if(i.matricesIndicesAttrDesc&&i.matricesIndicesAttrDesc.count>0){const s=new Int32Array(e,i.matricesIndicesAttrDesc.offset,i.matricesIndicesAttrDesc.count),r=[];for(let e=0;e<s.length;e++){const t=s[e];r.push(255&t),r.push((65280&t)>>8),r.push((16711680&t)>>16),r.push(t>>24&255)}t.setVerticesData(hi.MatricesIndicesKind,r,!1)}if(i.matricesIndicesExtraAttrDesc&&i.matricesIndicesExtraAttrDesc.count>0){const s=new Int32Array(e,i.matricesIndicesExtraAttrDesc.offset,i.matricesIndicesExtraAttrDesc.count),r=[];for(let e=0;e<s.length;e++){const t=s[e];r.push(255&t),r.push((65280&t)>>8),r.push((16711680&t)>>16),r.push(t>>24&255)}t.setVerticesData(hi.MatricesIndicesExtraKind,r,!1)}if(i.matricesWeightsAttrDesc&&i.matricesWeightsAttrDesc.count>0){const s=new Float32Array(e,i.matricesWeightsAttrDesc.offset,i.matricesWeightsAttrDesc.count);t.setVerticesData(hi.MatricesWeightsKind,s,!1)}if(i.indicesAttrDesc&&i.indicesAttrDesc.count>0){const s=new Int32Array(e,i.indicesAttrDesc.offset,i.indicesAttrDesc.count);t.setIndices(s,null)}if(i.subMeshesAttrDesc&&i.subMeshesAttrDesc.count>0){const s=new Int32Array(e,i.subMeshesAttrDesc.offset,5*i.subMeshesAttrDesc.count);t.subMeshes=[];for(let e=0;e<i.subMeshesAttrDesc.count;e++){const i=s[5*e+0],r=s[5*e+1],n=s[5*e+2],o=s[5*e+3],a=s[5*e+4];Cs.AddToMesh(i,r,n,o,a,t)}}}else if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(hi.PositionKind,e.positions,e.positions._updatable),t.setVerticesData(hi.NormalKind,e.normals,e.normals._updatable),e.tangents&&t.setVerticesData(hi.TangentKind,e.tangents,e.tangents._updatable),e.uvs&&t.setVerticesData(hi.UVKind,e.uvs,e.uvs._updatable),e.uvs2&&t.setVerticesData(hi.UV2Kind,e.uvs2,e.uvs2._updatable),e.uvs3&&t.setVerticesData(hi.UV3Kind,e.uvs3,e.uvs3._updatable),e.uvs4&&t.setVerticesData(hi.UV4Kind,e.uvs4,e.uvs4._updatable),e.uvs5&&t.setVerticesData(hi.UV5Kind,e.uvs5,e.uvs5._updatable),e.uvs6&&t.setVerticesData(hi.UV6Kind,e.uvs6,e.uvs6._updatable),e.colors&&t.setVerticesData(hi.ColorKind,F.CheckColors4(e.colors,e.positions.length/3),e.colors._updatable),e.matricesIndices)if(e.matricesIndices._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(hi.MatricesIndicesKind,e.matricesIndices,e.matricesIndices._updatable);else{const i=[];for(let t=0;t<e.matricesIndices.length;t++){const s=e.matricesIndices[t];i.push(255&s),i.push((65280&s)>>8),i.push((16711680&s)>>16),i.push(s>>24&255)}t.setVerticesData(hi.MatricesIndicesKind,i,e.matricesIndices._updatable)}if(e.matricesIndicesExtra)if(e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(hi.MatricesIndicesExtraKind,e.matricesIndicesExtra,e.matricesIndicesExtra._updatable);else{const i=[];for(let t=0;t<e.matricesIndicesExtra.length;t++){const s=e.matricesIndicesExtra[t];i.push(255&s),i.push((65280&s)>>8),i.push((16711680&s)>>16),i.push(s>>24&255)}t.setVerticesData(hi.MatricesIndicesExtraKind,i,e.matricesIndicesExtra._updatable)}e.matricesWeights&&(Ps._CleanMatricesWeights(e,t),t.setVerticesData(hi.MatricesWeightsKind,e.matricesWeights,e.matricesWeights._updatable)),e.matricesWeightsExtra&&t.setVerticesData(hi.MatricesWeightsExtraKind,e.matricesWeightsExtra,e.matricesWeights._updatable),t.setIndices(e.indices,null)}if(e.subMeshes){t.subMeshes=[];for(let i=0;i<e.subMeshes.length;i++){const s=e.subMeshes[i];Cs.AddToMesh(s.materialIndex,s.verticesStart,s.verticesCount,s.indexStart,s.indexCount,t)}}t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),t._shouldGenerateFlatShading=!1),t.computeWorldMatrix(!0),i.onMeshImportedObservable.notifyObservers(t)}static _CleanMatricesWeights(e,t){const i=.001;if(!Rs.CleanBoneMatrixWeights)return;let s=0;if(!(e.skeletonId>-1))return;{const i=t.getScene().getLastSkeletonById(e.skeletonId);if(!i)return;s=i.bones.length}const r=t.getVerticesData(hi.MatricesIndicesKind),n=t.getVerticesData(hi.MatricesIndicesExtraKind),o=e.matricesWeights,a=e.matricesWeightsExtra,l=e.numBoneInfluencer,h=o.length;for(let e=0;e<h;e+=4){let t=0,h=-1;for(let s=0;s<4;s++){const r=o[e+s];t+=r,r<i&&h<0&&(h=s)}if(a)for(let s=0;s<4;s++){const r=a[e+s];t+=r,r<i&&h<0&&(h=s+4)}if((h<0||h>l-1)&&(h=l-1),t>i){const i=1/t;for(let t=0;t<4;t++)o[e+t]*=i;if(a)for(let t=0;t<4;t++)a[e+t]*=i}else h>=4?(a[e+h-4]=1-t,n[e+h-4]=s):(o[e+h]=1-t,r[e+h]=s)}t.setVerticesData(hi.MatricesIndicesKind,r),e.matricesWeightsExtra&&t.setVerticesData(hi.MatricesIndicesExtraKind,n)}static Parse(e,t,i){const s=new Ps(e.id,t,void 0,e.updatable);return s._loadedUniqueId=e.uniqueId,j&&j.AddTagsTo(s,e.tags),e.delayLoadingFile?(s.delayLoadState=4,s.delayLoadingFile=i+e.delayLoadingFile,s._boundingInfo=new Es(S.FromArray(e.boundingBoxMinimum),S.FromArray(e.boundingBoxMaximum)),s._delayInfo=[],e.hasUVs&&s._delayInfo.push(hi.UVKind),e.hasUVs2&&s._delayInfo.push(hi.UV2Kind),e.hasUVs3&&s._delayInfo.push(hi.UV3Kind),e.hasUVs4&&s._delayInfo.push(hi.UV4Kind),e.hasUVs5&&s._delayInfo.push(hi.UV5Kind),e.hasUVs6&&s._delayInfo.push(hi.UV6Kind),e.hasColors&&s._delayInfo.push(hi.ColorKind),e.hasMatricesIndices&&s._delayInfo.push(hi.MatricesIndicesKind),e.hasMatricesWeights&&s._delayInfo.push(hi.MatricesWeightsKind),s._delayLoadingFunction=As.ImportVertexData):As.ImportVertexData(e,s),t.pushGeometry(s,!0),s}}class Ms{constructor(e=30){this._enabled=!0,this._rollingFrameTime=new Os(e)}sampleFrame(e=Fe.Now){if(this._enabled){if(null!=this._lastFrameTimeMs){const t=e-this._lastFrameTimeMs;this._rollingFrameTime.add(t)}this._lastFrameTimeMs=e}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const e=this._rollingFrameTime.history(0);return 0===e?0:1e3/e}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class Os{constructor(e){this._samples=new Array(e),this.reset()}add(e){let t;if(this.isSaturated()){const e=this._samples[this._pos];t=e-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(e-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length}history(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;const t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(e){const t=this._samples.length;return(e%t+t)%t}}function Ds(e,t,i=!1,s){switch(e){case 3:{const e=(ArrayBuffer,new Int8Array(t));return s&&e.set(new Int8Array(s)),e}case 0:{const e=(ArrayBuffer,new Uint8Array(t));return s&&e.set(new Uint8Array(s)),e}case 4:{const e=t instanceof ArrayBuffer?new Int16Array(t):new Int16Array(i?t/2:t);return s&&e.set(new Int16Array(s)),e}case 5:case 8:case 9:case 10:case 2:{const e=t instanceof ArrayBuffer?new Uint16Array(t):new Uint16Array(i?t/2:t);return s&&e.set(new Uint16Array(s)),e}case 6:{const e=t instanceof ArrayBuffer?new Int32Array(t):new Int32Array(i?t/4:t);return s&&e.set(new Int32Array(s)),e}case 7:case 11:case 12:case 13:case 14:case 15:{const e=t instanceof ArrayBuffer?new Uint32Array(t):new Uint32Array(i?t/4:t);return s&&e.set(new Uint32Array(s)),e}case 1:{const e=t instanceof ArrayBuffer?new Float32Array(t):new Float32Array(i?t/4:t);return s&&e.set(new Float32Array(s)),e}}const r=(ArrayBuffer,new Uint8Array(t));return s&&r.set(new Uint8Array(s)),r}bt.prototype.setAlphaConstants=function(e,t,i,s){this._alphaState.setAlphaBlendConstants(e,t,i,s)},bt.prototype.setAlphaMode=function(e,t=!1){if(this._alphaMode!==e){switch(e){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0}t||(this.depthCullingState.depthMask=0===e),this._alphaMode=e}else if(!t){const t=0===e;this.depthCullingState.depthMask!==t&&(this.depthCullingState.depthMask=t)}},bt.prototype.getAlphaMode=function(){return this._alphaMode},bt.prototype.setAlphaEquation=function(e){if(this._alphaEquation!==e){switch(e){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774)}this._alphaEquation=e}},bt.prototype.getAlphaEquation=function(){return this._alphaEquation},bt.prototype._readTexturePixelsSync=function(e,t,i,s=-1,r=0,n=null,o=!0,a=!1,l=0,h=0){var c,u;const d=this._gl;if(!d)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const e=d.createFramebuffer();if(!e)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=e}d.bindFramebuffer(d.FRAMEBUFFER,this._dummyFramebuffer),s>-1?d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_CUBE_MAP_POSITIVE_X+s,null===(c=e._hardwareTexture)||void 0===c?void 0:c.underlyingResource,r):d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,null===(u=e._hardwareTexture)||void 0===u?void 0:u.underlyingResource,r);let p=void 0!==e.type?this._getWebGLTextureType(e.type):d.UNSIGNED_BYTE;return a?n||(n=Ds(e.type,4*t*i)):p===d.UNSIGNED_BYTE?(n||(n=new Uint8Array(4*t*i)),p=d.UNSIGNED_BYTE):(n||(n=new Float32Array(4*t*i)),p=d.FLOAT),o&&this.flushFramebuffer(),d.readPixels(l,h,t,i,d.RGBA,p,n),d.bindFramebuffer(d.FRAMEBUFFER,this._currentFramebuffer),n},bt.prototype._readTexturePixels=function(e,t,i,s=-1,r=0,n=null,o=!0,a=!1,l=0,h=0){return Promise.resolve(this._readTexturePixelsSync(e,t,i,s,r,n,o,a,l,h))},bt.prototype.updateDynamicIndexBuffer=function(e,t,i=0){let s;this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(e),s=e.is32Bits?t instanceof Uint32Array?t:new Uint32Array(t):t instanceof Uint16Array?t:new Uint16Array(t),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,s,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},bt.prototype.updateDynamicVertexBuffer=function(e,t,i,s){this.bindArrayBuffer(e),void 0===i&&(i=0);const r=t.byteLength||t.length;void 0===s||s>=r&&0===i?t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,new Float32Array(t)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,t):t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(t).subarray(i,i+s)):(t=t instanceof ArrayBuffer?new Uint8Array(t,i,s):new Uint8Array(t.buffer,t.byteOffset+i,s),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t)),this._resetVertexBufferBinding()};class Ns extends bt{static get NpmPackage(){return bt.NpmPackage}static get Version(){return bt.Version}static get Instances(){return x.Instances}static get LastCreatedEngine(){return x.LastCreatedEngine}static get LastCreatedScene(){return x.LastCreatedScene}_createImageBitmapFromSource(e,t){return new Promise(((i,s)=>{const r=new Image;r.onload=()=>{r.decode().then((()=>{this.createImageBitmap(r,t).then((e=>{i(e)}))}))},r.onerror=()=>{s(`Error loading image ${r.src}`)},r.src=e}))}createImageBitmap(e,t){return createImageBitmap(e,t)}resizeImageBitmap(e,t,i){const s=this.createCanvas(t,i).getContext("2d");if(!s)throw new Error("Unable to get 2d context for resizeImageBitmap");return s.drawImage(e,0,0),s.getImageData(0,0,t,i).data}static MarkAllMaterialsAsDirty(e,t){for(let i=0;i<Ns.Instances.length;i++){const s=Ns.Instances[i];for(let i=0;i<s.scenes.length;i++)s.scenes[i].markAllMaterialsAsDirty(e,t)}}static DefaultLoadingScreenFactory(e){throw $("LoadingScreen")}get _supportsHardwareTextureRescaling(){return!!Ns._RescalePostProcessFactory}get performanceMonitor(){return this._performanceMonitor}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=!0}getInputElement(){return this._renderingCanvas}constructor(e,t,i,s=!1){if(super(e,t,i,s),this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.scenes=[],this._virtualScenes=new Array,this.onNewSceneAddedObservable=new a,this.postProcesses=[],this.isPointerLock=!1,this.onResizeObservable=new a,this.onCanvasBlurObservable=new a,this.onCanvasFocusObservable=new a,this.onCanvasPointerOutObservable=new a,this.onBeginFrameObservable=new a,this.customAnimationFrameRequester=null,this.onEndFrameObservable=new a,this.onBeforeShaderCompilationObservable=new a,this.onAfterShaderCompilationObservable=new a,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this._timeStep=1/60,this._fps=60,this._deltaTime=0,this._drawCalls=new Fi,this.canvasTabIndex=1,this.disablePerformanceMonitorInBackground=!1,this._performanceMonitor=new Ms,this._compatibilityMode=!0,this.currentRenderPassId=0,this._renderPassNames=["main"],Ns.Instances.push(this),e&&(this._features.supportRenderPasses=!0,i=this._creationOptions,e.getContext)){const t=e;this._sharedInit(t)}}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(e){super._sharedInit(e),this._onCanvasFocus=()=>{this.onCanvasFocusObservable.notifyObservers(this)},this._onCanvasBlur=()=>{this.onCanvasBlurObservable.notifyObservers(this)},this._onCanvasContextMenu=e=>{this.disableContextMenu&&e.preventDefault()},e.addEventListener("focus",this._onCanvasFocus),e.addEventListener("blur",this._onCanvasBlur),e.addEventListener("contextmenu",this._onCanvasContextMenu),this._onBlur=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.disable(),this._windowIsBackground=!0},this._onFocus=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.enable(),this._windowIsBackground=!1},this._onCanvasPointerOut=t=>{document.elementFromPoint(t.clientX,t.clientY)!==e&&this.onCanvasPointerOutObservable.notifyObservers(t)};const t=this.getHostWindow();t&&"function"==typeof t.addEventListener&&(t.addEventListener("blur",this._onBlur),t.addEventListener("focus",this._onFocus)),e.addEventListener("pointerout",this._onCanvasPointerOut),this._creationOptions.doNotHandleTouchAction||this._disableTouchAction(),!Ns.audioEngine&&this._creationOptions.audioEngine&&Ns.AudioEngineFactory&&(Ns.audioEngine=Ns.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination())),De()&&(this._onFullscreenChange=()=>{this.isFullscreen=!!document.fullscreenElement,this.isFullscreen&&this._pointerLockRequested&&e&&Ns._RequestPointerlock(e)},document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,!1),this._onPointerLockChange=()=>{this.isPointerLock=document.pointerLockElement===e},document.addEventListener("pointerlockchange",this._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",this._onPointerLockChange,!1)),this.enableOfflineSupport=void 0!==Ns.OfflineProviderFactory,this._deterministicLockstep=!!this._creationOptions.deterministicLockstep,this._lockstepMaxSteps=this._creationOptions.lockstepMaxSteps||0,this._timeStep=this._creationOptions.timeStep||1/60}_verifyPointerLock(){var e;null===(e=this._onPointerLockChange)||void 0===e||e.call(this)}getAspectRatio(e,t=!1){const i=e.viewport;return this.getRenderWidth(t)*i.width/(this.getRenderHeight(t)*i.height)}getScreenAspectRatio(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)}getRenderingCanvasClientRect(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null}getInputElementClientRect(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return 1e3*this._timeStep}generateMipMapsForCubemap(e,t=!0){if(e.generateMipMaps){const i=this._gl;this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,e,!0),i.generateMipmap(i.TEXTURE_CUBE_MAP),t&&this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)}}getDepthWrite(){return this._depthCullingState.depthMask}setDepthWrite(e){this._depthCullingState.depthMask=e}getStencilBuffer(){return this._stencilState.stencilTest}setStencilBuffer(e){this._stencilState.stencilTest=e}getStencilMask(){return this._stencilState.stencilMask}setStencilMask(e){this._stencilState.stencilMask=e}getStencilFunction(){return this._stencilState.stencilFunc}getStencilFunctionReference(){return this._stencilState.stencilFuncRef}getStencilFunctionMask(){return this._stencilState.stencilFuncMask}setStencilFunction(e){this._stencilState.stencilFunc=e}setStencilFunctionReference(e){this._stencilState.stencilFuncRef=e}setStencilFunctionMask(e){this._stencilState.stencilFuncMask=e}getStencilOperationFail(){return this._stencilState.stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilState.stencilOpDepthFail}getStencilOperationPass(){return this._stencilState.stencilOpStencilDepthPass}setStencilOperationFail(e){this._stencilState.stencilOpStencilFail=e}setStencilOperationDepthFail(e){this._stencilState.stencilOpDepthFail=e}setStencilOperationPass(e){this._stencilState.stencilOpStencilDepthPass=e}setDitheringState(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}getDepthFunction(){return this._depthCullingState.depthFunc}setDepthFunction(e){this._depthCullingState.depthFunc=e}setDepthFunctionToGreater(){this.setDepthFunction(516)}setDepthFunctionToGreaterOrEqual(){this.setDepthFunction(518)}setDepthFunctionToLess(){this.setDepthFunction(513)}setDepthFunctionToLessOrEqual(){this.setDepthFunction(515)}cacheStencilState(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()}restoreStencilState(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)}setDirectViewport(e,t,i,s){const r=this._cachedViewport;return this._cachedViewport=null,this._viewport(e,t,i,s),r}scissorClear(e,t,i,s,r){this.enableScissor(e,t,i,s),this.clear(r,!0,!0,!0),this.disableScissor()}enableScissor(e,t,i,s){const r=this._gl;r.enable(r.SCISSOR_TEST),r.scissor(e,t,i,s)}disableScissor(){const e=this._gl;e.disable(e.SCISSOR_TEST)}_reportDrawCall(e=1){this._drawCalls.addCount(e,!1)}_loadFileAsync(e,t,i){return new Promise(((s,r)=>{this._loadFile(e,(e=>{s(e)}),void 0,t,i,((e,t)=>{r(t)}))}))}getVertexShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[0]):null}getFragmentShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[1]):null}setDepthStencilTexture(e,t,i,s){void 0!==e&&(t&&(this._boundUniforms[e]=t),i&&i.depthStencilTexture?this._setTexture(e,i,!1,!0,s):this._setTexture(e,null,void 0,void 0,s))}setTextureFromPostProcess(e,t,i){var s;let r=null;t&&(t._forcedOutputTexture?r=t._forcedOutputTexture:t._textures.data[t._currentRenderTextureInd]&&(r=t._textures.data[t._currentRenderTextureInd])),this._bindTexture(e,null!==(s=null==r?void 0:r.texture)&&void 0!==s?s:null,i)}setTextureFromPostProcessOutput(e,t,i){var s,r;this._bindTexture(e,null!==(r=null===(s=null==t?void 0:t._outputTexture)||void 0===s?void 0:s.texture)&&void 0!==r?r:null,i)}_rebuildBuffers(){for(const e of this.scenes)e.resetCachedMaterial(),e._rebuildGeometries(),e._rebuildTextures();for(const e of this._virtualScenes)e.resetCachedMaterial(),e._rebuildGeometries(),e._rebuildTextures();super._rebuildBuffers()}_renderFrame(){for(let e=0;e<this._activeRenderLoops.length;e++)(0,this._activeRenderLoops[e])()}_cancelFrame(){if(this._renderingQueueLaunched&&this.customAnimationFrameRequester){this._renderingQueueLaunched=!1;const{cancelAnimationFrame:e}=this.customAnimationFrameRequester;e&&e(this.customAnimationFrameRequester.requestID)}else super._cancelFrame()}_renderLoop(){if(!this._contextWasLost){let e=!0;(this.isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(e=!1),e&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0?this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}_renderViews(){return!1}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&Ns._RequestFullscreen(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&Ns._ExitFullscreen()}enterPointerlock(){this._renderingCanvas&&Ns._RequestPointerlock(this._renderingCanvas)}exitPointerlock(){Ns._ExitPointerlock()}beginFrame(){this._measureFps(),this.onBeginFrameObservable.notifyObservers(this),super.beginFrame()}endFrame(){super.endFrame(),this.onEndFrameObservable.notifyObservers(this)}setSize(e,t,i=!1){if(!this._renderingCanvas)return!1;if(!super.setSize(e,t,i))return!1;if(this.scenes){for(let e=0;e<this.scenes.length;e++){const t=this.scenes[e];for(let e=0;e<t.cameras.length;e++)t.cameras[e]._currentRenderId=0}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}_deletePipelineContext(e){const t=e;t&&t.program&&t.transformFeedback&&(this.deleteTransformFeedback(t.transformFeedback),t.transformFeedback=null),super._deletePipelineContext(e)}createShaderProgram(e,t,i,s,r,n=null){r=r||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const o=super.createShaderProgram(e,t,i,s,r,n);return this.onAfterShaderCompilationObservable.notifyObservers(this),o}_createShaderProgram(e,t,i,s,r=null){const n=s.createProgram();if(e.program=n,!n)throw new Error("Unable to create program");if(s.attachShader(n,t),s.attachShader(n,i),this.webGLVersion>1&&r){const t=this.createTransformFeedback();this.bindTransformFeedback(t),this.setTranformFeedbackVaryings(n,r),e.transformFeedback=t}return s.linkProgram(n),this.webGLVersion>1&&r&&this.bindTransformFeedback(null),e.context=s,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),n}_releaseTexture(e){super._releaseTexture(e)}_releaseRenderTargetWrapper(e){super._releaseRenderTargetWrapper(e),this.scenes.forEach((t=>{t.postProcesses.forEach((t=>{t._outputTexture===e&&(t._outputTexture=null)})),t.cameras.forEach((t=>{t._postProcesses.forEach((t=>{t&&t._outputTexture===e&&(t._outputTexture=null)}))}))}))}getRenderPassNames(){return this._renderPassNames}getCurrentRenderPassName(){return this._renderPassNames[this.currentRenderPassId]}createRenderPassId(e){const t=++Ns._RenderPassIdCounter;return this._renderPassNames[t]=null!=e?e:"NONAME",t}releaseRenderPassId(e){this._renderPassNames[e]=void 0;for(let t=0;t<this.scenes.length;++t){const i=this.scenes[t];for(let t=0;t<i.meshes.length;++t){const s=i.meshes[t];if(s.subMeshes)for(let t=0;t<s.subMeshes.length;++t)s.subMeshes[t]._removeDrawWrapper(e)}}}_rescaleTexture(e,t,i,s,r){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const n=this.createRenderTargetTexture({width:t.width,height:t.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});!this._rescalePostProcess&&Ns._RescalePostProcessFactory&&(this._rescalePostProcess=Ns._RescalePostProcessFactory(this)),this._rescalePostProcess&&(this._rescalePostProcess.externalTextureSamplerBinding=!0,this._rescalePostProcess.getEffect().executeWhenCompiled((()=>{this._rescalePostProcess.onApply=function(t){t._bindTexture("textureSampler",e)};let o=i;o||(o=this.scenes[this.scenes.length-1]),o.postProcessManager.directRender([this._rescalePostProcess],n,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,s,0,0,t.width,t.height,0),this.unBindFramebuffer(n),n.dispose(),r&&r()})))}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}wrapWebGLTexture(e,t=!1,i=3,s=0,r=0){const n=new xt(e,this._gl),o=new dt(this,ut.Unknown,!0);return o._hardwareTexture=n,o.baseWidth=s,o.baseHeight=r,o.width=s,o.height=r,o.isReady=!0,o.useMipMaps=t,this.updateTextureSamplingMode(i,o),o}_uploadImageToTexture(e,t,i=0,s=0){const r=this._gl,n=this._getWebGLTextureType(e.type),o=this._getInternalFormat(e.format),a=this._getRGBABufferInternalSizedFormat(e.type,o),l=e.isCube?r.TEXTURE_CUBE_MAP:r.TEXTURE_2D;this._bindTextureDirectly(l,e,!0),this._unpackFlipY(e.invertY);let h=r.TEXTURE_2D;e.isCube&&(h=r.TEXTURE_CUBE_MAP_POSITIVE_X+i),r.texImage2D(h,s,a,o,n,t),this._bindTextureDirectly(l,null,!0)}updateTextureComparisonFunction(e,t){if(1===this.webGLVersion)return void k.Error("WebGL 1 does not support texture comparison.");const i=this._gl;e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,!0),0===t?(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),0===t?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=t}createInstancesBuffer(e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create instance buffer");const i=new gt(t);return i.capacity=e,this.bindArrayBuffer(i),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),i.references=1,i}deleteInstancesBuffer(e){this._gl.deleteBuffer(e)}_clientWaitAsync(e,t=0,i=10){const s=this._gl;return new Promise(((r,n)=>{const o=()=>{const a=s.clientWaitSync(e,t,0);a!=s.WAIT_FAILED?a!=s.TIMEOUT_EXPIRED?r():setTimeout(o,i):n()};o()}))}_readPixelsAsync(e,t,i,s,r,n,o){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const a=this._gl,l=a.createBuffer();a.bindBuffer(a.PIXEL_PACK_BUFFER,l),a.bufferData(a.PIXEL_PACK_BUFFER,o.byteLength,a.STREAM_READ),a.readPixels(e,t,i,s,r,n,0),a.bindBuffer(a.PIXEL_PACK_BUFFER,null);const h=a.fenceSync(a.SYNC_GPU_COMMANDS_COMPLETE,0);return h?(a.flush(),this._clientWaitAsync(h,0,10).then((()=>(a.deleteSync(h),a.bindBuffer(a.PIXEL_PACK_BUFFER,l),a.getBufferSubData(a.PIXEL_PACK_BUFFER,0,o),a.bindBuffer(a.PIXEL_PACK_BUFFER,null),a.deleteBuffer(l),o)))):null}dispose(){for(this.hideLoadingUI(),this.onNewSceneAddedObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(this._rescalePostProcess&&this._rescalePostProcess.dispose();this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();1===x.Instances.length&&Ns.audioEngine&&(Ns.audioEngine.dispose(),Ns.audioEngine=null);const e=this.getHostWindow();e&&"function"==typeof e.removeEventListener&&(e.removeEventListener("blur",this._onBlur),e.removeEventListener("focus",this._onFocus)),this._renderingCanvas&&(this._renderingCanvas.removeEventListener("focus",this._onCanvasFocus),this._renderingCanvas.removeEventListener("blur",this._onCanvasBlur),this._renderingCanvas.removeEventListener("pointerout",this._onCanvasPointerOut),this._renderingCanvas.removeEventListener("contextmenu",this._onCanvasContextMenu)),De()&&(document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange)),super.dispose();const t=x.Instances.indexOf(this);t>=0&&x.Instances.splice(t,1),Ns.Instances.length||x.OnEnginesDisposedObservable.notifyObservers(this),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}_disableTouchAction(){this._renderingCanvas&&this._renderingCanvas.setAttribute&&(this._renderingCanvas.setAttribute("touch-action","none"),this._renderingCanvas.style.touchAction="none",this._renderingCanvas.style.webkitTapHighlightColor="transparent")}displayLoadingUI(){if(!Me())return;const e=this.loadingScreen;e&&e.displayLoadingUI()}hideLoadingUI(){if(!Me())return;const e=this._loadingScreen;e&&e.hideLoadingUI()}get loadingScreen(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=Ns.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen}set loadingScreen(e){this._loadingScreen=e}set loadingUIText(e){this.loadingScreen.loadingUIText=e}set loadingUIBackgroundColor(e){this.loadingScreen.loadingUIBackgroundColor=e}createVideoElement(e){return document.createElement("video")}static _RequestPointerlock(e){if(e.requestPointerLock){const t=e.requestPointerLock();t instanceof Promise?t.then((()=>{e.focus()})).catch((()=>{})):e.focus()}}static _ExitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}static _RequestFullscreen(e){const t=e.requestFullscreen||e.webkitRequestFullscreen;t&&t.call(e)}static _ExitFullscreen(){const e=document;document.exitFullscreen?document.exitFullscreen():e.webkitCancelFullScreen&&e.webkitCancelFullScreen()}getFontOffset(e){const t=document.createElement("span");t.innerHTML="Hg",t.setAttribute("style",`font: ${e} !important`);const i=document.createElement("div");i.style.display="inline-block",i.style.width="1px",i.style.height="0px",i.style.verticalAlign="bottom";const s=document.createElement("div");s.style.whiteSpace="nowrap",s.appendChild(t),s.appendChild(i),document.body.appendChild(s);let r=0,n=0;try{n=i.getBoundingClientRect().top-t.getBoundingClientRect().top,i.style.verticalAlign="baseline",r=i.getBoundingClientRect().top-t.getBoundingClientRect().top}finally{document.body.removeChild(s)}return{ascent:r,height:n,descent:n-r}}}Ns.ALPHA_DISABLE=0,Ns.ALPHA_ADD=1,Ns.ALPHA_COMBINE=2,Ns.ALPHA_SUBTRACT=3,Ns.ALPHA_MULTIPLY=4,Ns.ALPHA_MAXIMIZED=5,Ns.ALPHA_ONEONE=6,Ns.ALPHA_PREMULTIPLIED=7,Ns.ALPHA_PREMULTIPLIED_PORTERDUFF=8,Ns.ALPHA_INTERPOLATE=9,Ns.ALPHA_SCREENMODE=10,Ns.DELAYLOADSTATE_NONE=0,Ns.DELAYLOADSTATE_LOADED=1,Ns.DELAYLOADSTATE_LOADING=2,Ns.DELAYLOADSTATE_NOTLOADED=4,Ns.NEVER=512,Ns.ALWAYS=519,Ns.LESS=513,Ns.EQUAL=514,Ns.LEQUAL=515,Ns.GREATER=516,Ns.GEQUAL=518,Ns.NOTEQUAL=517,Ns.KEEP=7680,Ns.REPLACE=7681,Ns.INCR=7682,Ns.DECR=7683,Ns.INVERT=5386,Ns.INCR_WRAP=34055,Ns.DECR_WRAP=34056,Ns.TEXTURE_CLAMP_ADDRESSMODE=0,Ns.TEXTURE_WRAP_ADDRESSMODE=1,Ns.TEXTURE_MIRROR_ADDRESSMODE=2,Ns.TEXTUREFORMAT_ALPHA=0,Ns.TEXTUREFORMAT_LUMINANCE=1,Ns.TEXTUREFORMAT_LUMINANCE_ALPHA=2,Ns.TEXTUREFORMAT_RGB=4,Ns.TEXTUREFORMAT_RGBA=5,Ns.TEXTUREFORMAT_RED=6,Ns.TEXTUREFORMAT_R=6,Ns.TEXTUREFORMAT_RG=7,Ns.TEXTUREFORMAT_RED_INTEGER=8,Ns.TEXTUREFORMAT_R_INTEGER=8,Ns.TEXTUREFORMAT_RG_INTEGER=9,Ns.TEXTUREFORMAT_RGB_INTEGER=10,Ns.TEXTUREFORMAT_RGBA_INTEGER=11,Ns.TEXTURETYPE_UNSIGNED_BYTE=0,Ns.TEXTURETYPE_UNSIGNED_INT=0,Ns.TEXTURETYPE_FLOAT=1,Ns.TEXTURETYPE_HALF_FLOAT=2,Ns.TEXTURETYPE_BYTE=3,Ns.TEXTURETYPE_SHORT=4,Ns.TEXTURETYPE_UNSIGNED_SHORT=5,Ns.TEXTURETYPE_INT=6,Ns.TEXTURETYPE_UNSIGNED_INTEGER=7,Ns.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,Ns.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,Ns.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,Ns.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,Ns.TEXTURETYPE_UNSIGNED_INT_24_8=12,Ns.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,Ns.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,Ns.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,Ns.TEXTURE_NEAREST_SAMPLINGMODE=1,Ns.TEXTURE_BILINEAR_SAMPLINGMODE=2,Ns.TEXTURE_TRILINEAR_SAMPLINGMODE=3,Ns.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,Ns.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,Ns.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,Ns.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,Ns.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,Ns.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,Ns.TEXTURE_NEAREST_LINEAR=7,Ns.TEXTURE_NEAREST_NEAREST=1,Ns.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,Ns.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,Ns.TEXTURE_LINEAR_LINEAR=2,Ns.TEXTURE_LINEAR_NEAREST=12,Ns.TEXTURE_EXPLICIT_MODE=0,Ns.TEXTURE_SPHERICAL_MODE=1,Ns.TEXTURE_PLANAR_MODE=2,Ns.TEXTURE_CUBIC_MODE=3,Ns.TEXTURE_PROJECTION_MODE=4,Ns.TEXTURE_SKYBOX_MODE=5,Ns.TEXTURE_INVCUBIC_MODE=6,Ns.TEXTURE_EQUIRECTANGULAR_MODE=7,Ns.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,Ns.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,Ns.SCALEMODE_FLOOR=1,Ns.SCALEMODE_NEAREST=2,Ns.SCALEMODE_CEILING=3,Ns._RescalePostProcessFactory=null,Ns._RenderPassIdCounter=0;const Fs=y.Compose(S.One(),C.FromEulerAngles(0,Math.PI,0),S.Zero());class ws extends ve{get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._cache.useBillboardPosition=!!(this._billboardMode&ws.BILLBOARDMODE_USE_POSITION),this._computeUseBillboardPath())}get preserveParentRotationForBillboard(){return this._preserveParentRotationForBillboard}set preserveParentRotationForBillboard(e){e!==this._preserveParentRotationForBillboard&&(this._preserveParentRotationForBillboard=e,this._computeUseBillboardPath())}_computeUseBillboardPath(){this._cache.useBillboardPath=this._billboardMode!==ws.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}get infiniteDistance(){return this._infiniteDistance}set infiniteDistance(e){this._infiniteDistance!==e&&(this._infiniteDistance=e)}constructor(e,t=null,i=!0){super(e,t),this._forward=new S(0,0,1),this._up=new S(0,1,0),this._right=new S(1,0,0),this._position=S.Zero(),this._rotation=S.Zero(),this._rotationQuaternion=null,this._scaling=S.One(),this._transformToBoneReferal=null,this._isAbsoluteSynced=!1,this._billboardMode=ws.BILLBOARDMODE_NONE,this._preserveParentRotationForBillboard=!1,this.scalingDeterminant=1,this._infiniteDistance=!1,this.ignoreNonUniformScaling=!1,this.reIntegrateRotationIntoRotationQuaternion=!1,this._poseMatrix=null,this._localMatrix=y.Zero(),this._usePivotMatrix=!1,this._absolutePosition=S.Zero(),this._absoluteScaling=S.Zero(),this._absoluteRotationQuaternion=C.Identity(),this._pivotMatrix=y.Identity(),this._postMultiplyPivotMatrix=!1,this._isWorldMatrixFrozen=!1,this._indexInSceneTransformNodesArray=-1,this.onAfterWorldMatrixUpdateObservable=new a,this._nonUniformScaling=!1,i&&this.getScene().addTransformNode(this)}getClassName(){return"TransformNode"}get position(){return this._position}set position(e){this._position=e,this._isDirty=!0}isUsingPivotMatrix(){return this._usePivotMatrix}isUsingPostMultiplyPivotMatrix(){return this._postMultiplyPivotMatrix}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._rotationQuaternion=null,this._isDirty=!0}get scaling(){return this._scaling}set scaling(e){this._scaling=e,this._isDirty=!0}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,e&&this._rotation.setAll(0),this._isDirty=!0}get forward(){return S.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}get up(){return S.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}get right(){return S.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}updatePoseMatrix(e){return this._poseMatrix?(this._poseMatrix.copyFrom(e),this):(this._poseMatrix=e.clone(),this)}getPoseMatrix(){return this._poseMatrix||(this._poseMatrix=y.Identity()),this._poseMatrix}_isSynchronized(){const e=this._cache;return!(this._billboardMode!==e.billboardMode||this._billboardMode!==ws.BILLBOARDMODE_NONE||e.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)}_initCache(){super._initCache();const e=this._cache;e.localMatrixUpdated=!1,e.billboardMode=-1,e.infiniteDistance=!1,e.useBillboardPosition=!1,e.useBillboardPath=!1}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}get absoluteRotationQuaternion(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}setPreTransformMatrix(e){return this.setPivotMatrix(e,!1)}setPivotMatrix(e,t=!0){return this._pivotMatrix.copyFrom(e),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=t,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=y.Invert(this._pivotMatrix)),this}getPivotMatrix(){return this._pivotMatrix}instantiateHierarchy(e=null,t,i){const s=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0);s&&i&&i(this,s);for(const e of this.getChildTransformNodes(!0))e.instantiateHierarchy(s,t,i);return s}freezeWorldMatrix(e=null,t=!1){return e?t?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||C.Identity(),e.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=e,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this}unfreezeWorldMatrix(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this}get isWorldMatrixFrozen(){return this._isWorldMatrixFrozen}getAbsolutePosition(){return this.computeWorldMatrix(),this._absolutePosition}setAbsolutePosition(e){if(!e)return this;let t,i,s;if(void 0===e.x){if(arguments.length<3)return this;t=arguments[0],i=arguments[1],s=arguments[2]}else t=e.x,i=e.y,s=e.z;if(this.parent){const e=R.Matrix[0];this.parent.getWorldMatrix().invertToRef(e),S.TransformCoordinatesFromFloatsToRef(t,i,s,e,this.position)}else this.position.x=t,this.position.y=i,this.position.z=s;return this._absolutePosition.copyFrom(e),this}setPositionWithLocalVector(e){return this.computeWorldMatrix(),this.position=S.TransformNormal(e,this._localMatrix),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();const e=R.Matrix[0];return this._localMatrix.invertToRef(e),S.TransformNormal(this.position,e)}locallyTranslate(e){return this.computeWorldMatrix(!0),this.position=S.TransformCoordinates(e,this._localMatrix),this}lookAt(e,t=0,i=0,s=0,r=Gi.LOCAL){const n=ws._LookAtVectorCache,o=r===Gi.LOCAL?this.position:this.getAbsolutePosition();if(e.subtractToRef(o,n),this.setDirection(n,t,i,s),r===Gi.WORLD&&this.parent)if(this.rotationQuaternion){const e=R.Matrix[0];this.rotationQuaternion.toRotationMatrix(e);const t=R.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(t),t.invert(),e.multiplyToRef(t,e),this.rotationQuaternion.fromRotationMatrix(e)}else{const e=R.Quaternion[0];C.FromEulerVectorToRef(this.rotation,e);const t=R.Matrix[0];e.toRotationMatrix(t);const i=R.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(i),i.invert(),t.multiplyToRef(i,t),e.fromRotationMatrix(t),e.toEulerAnglesToRef(this.rotation)}return this}getDirection(e){const t=S.Zero();return this.getDirectionToRef(e,t),t}getDirectionToRef(e,t){return S.TransformNormalToRef(e,this.getWorldMatrix(),t),this}setDirection(e,t=0,i=0,s=0){const r=-Math.atan2(e.z,e.x)+Math.PI/2,n=Math.sqrt(e.x*e.x+e.z*e.z),o=-Math.atan2(e.y,n);return this.rotationQuaternion?C.RotationYawPitchRollToRef(r+t,o+i,s,this.rotationQuaternion):(this.rotation.x=o+i,this.rotation.y=r+t,this.rotation.z=s),this}setPivotPoint(e,t=Gi.LOCAL){0==this.getScene().getRenderId()&&this.computeWorldMatrix(!0);const i=this.getWorldMatrix();if(t==Gi.WORLD){const t=R.Matrix[0];i.invertToRef(t),e=S.TransformCoordinates(e,t)}return this.setPivotMatrix(y.Translation(-e.x,-e.y,-e.z),!0)}getPivotPoint(){const e=S.Zero();return this.getPivotPointToRef(e),e}getPivotPointToRef(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this}getAbsolutePivotPoint(){const e=S.Zero();return this.getAbsolutePivotPointToRef(e),e}getAbsolutePivotPointToRef(e){return this.getPivotPointToRef(e),S.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this}markAsDirty(e){if(this._isDirty)return this;if(this._children)for(const t of this._children)t.markAsDirty(e);return super.markAsDirty(e)}setParent(e,t=!1,i=!1){if(!e&&!this.parent)return this;const s=R.Quaternion[0],r=R.Vector3[0],n=R.Vector3[1],o=R.Matrix[1];y.IdentityToRef(o);const a=R.Matrix[0];this.computeWorldMatrix(!0);let l=this.rotationQuaternion;return l||(l=ws._TmpRotation,C.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,l)),y.ComposeToRef(this.scaling,l,this.position,a),this.parent&&a.multiplyToRef(this.parent.computeWorldMatrix(!0),a),e&&(e.computeWorldMatrix(!0).invertToRef(o),a.multiplyToRef(o,a)),a.decompose(n,s,r,t?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(s):s.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(n),this.position.copyFrom(r),this.parent=e,i&&this.setPivotMatrix(y.Identity()),this}get nonUniformScaling(){return this._nonUniformScaling}_updateNonUniformScalingState(e){return this._nonUniformScaling!==e&&(this._nonUniformScaling=e,!0)}attachToBone(e,t){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=t,this.parent=e,e.getSkeleton().prepare(!0),e.getFinalMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}detachFromBone(e=!1){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,this.parent=e?this._currentParentWhenAttachingToBone:null,this):(e&&(this.parent=this._currentParentWhenAttachingToBone),this)}rotate(e,t,i){let s;if(e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0)),i&&i!==Gi.LOCAL){if(this.parent){const i=this.parent.getWorldMatrix(),s=R.Matrix[0];i.invertToRef(s),e=S.TransformNormal(e,s),i.determinant()<0&&(t*=-1)}s=C.RotationAxisToRef(e,t,ws._RotationAxisCache),s.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}else s=C.RotationAxisToRef(e,t,ws._RotationAxisCache),this.rotationQuaternion.multiplyToRef(s,this.rotationQuaternion);return this}rotateAround(e,t,i){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=C.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));const s=R.Vector3[0],r=R.Vector3[1],n=R.Vector3[2],o=R.Quaternion[0],a=R.Matrix[0],l=R.Matrix[1],h=R.Matrix[2],c=R.Matrix[3];return e.subtractToRef(this.position,s),y.TranslationToRef(s.x,s.y,s.z,a),y.TranslationToRef(-s.x,-s.y,-s.z,l),y.RotationAxisToRef(t,i,h),l.multiplyToRef(h,c),c.multiplyToRef(a,c),c.decompose(r,o,n),this.position.addInPlace(n),o.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(e,t,i){const s=e.scale(t);if(i&&i!==Gi.LOCAL)this.setAbsolutePosition(this.getAbsolutePosition().add(s));else{const e=this.getPositionExpressedInLocalSpace().add(s);this.setPositionWithLocalVector(e)}return this}addRotation(e,t,i){let s;this.rotationQuaternion?s=this.rotationQuaternion:(s=R.Quaternion[1],C.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,s));const r=R.Quaternion[0];return C.RotationYawPitchRollToRef(t,e,i,r),s.multiplyInPlace(r),this.rotationQuaternion||s.toEulerAnglesToRef(this.rotation),this}_getEffectiveParent(){return this.parent}isWorldMatrixCameraDependent(){return this._infiniteDistance&&!this.parent||this._billboardMode!==ws.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}computeWorldMatrix(e=!1,t=null){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;const i=this.getScene().getRenderId();if(!this._isDirty&&!e&&(this._currentRenderId===i||this.isSynchronized()))return this._currentRenderId=i,this._worldMatrix;t=t||this.getScene().activeCamera,this._updateCache();const s=this._cache;s.pivotMatrixUpdated=!1,s.billboardMode=this.billboardMode,s.infiniteDistance=this.infiniteDistance,s.parent=this._parentNode,this._currentRenderId=i,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;const r=this._getEffectiveParent(),n=ws._TmpScaling;let o,a=this._position;if(this._infiniteDistance&&!this.parent&&t){const e=t.getWorldMatrix(),i=new S(e.m[12],e.m[13],e.m[14]);a=ws._TmpTranslation,a.copyFromFloats(this._position.x+i.x,this._position.y+i.y,this._position.z+i.z)}if(n.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant),this._rotationQuaternion?(this._rotationQuaternion._isDirty=!1,o=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion&&this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(C.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))):(o=ws._TmpRotation,C.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,o)),this._usePivotMatrix){const e=R.Matrix[1];y.ScalingToRef(n.x,n.y,n.z,e);const t=R.Matrix[0];o.toRotationMatrix(t),this._pivotMatrix.multiplyToRef(e,R.Matrix[4]),R.Matrix[4].multiplyToRef(t,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(a.x,a.y,a.z)}else y.ComposeToRef(n,o,a,this._localMatrix);if(r&&r.getWorldMatrix){if(e&&r.computeWorldMatrix(e),s.useBillboardPath){if(this._transformToBoneReferal){const e=this.parent;e.getSkeleton().prepare(),e.getFinalMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),R.Matrix[7])}else R.Matrix[7].copyFrom(r.getWorldMatrix());const e=R.Vector3[5],t=R.Vector3[6],i=R.Quaternion[0];R.Matrix[7].decompose(t,i,e),y.ScalingToRef(t.x,t.y,t.z,R.Matrix[7]),R.Matrix[7].setTranslation(e),ws.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(i,e),this._localMatrix.setTranslation(e)),this._localMatrix.multiplyToRef(R.Matrix[7],this._worldMatrix)}else if(this._transformToBoneReferal){const e=this.parent;e.getSkeleton().prepare(),this._localMatrix.multiplyToRef(e.getFinalMatrix(),R.Matrix[6]),R.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)}else this._localMatrix.multiplyToRef(r.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(s.useBillboardPath&&t&&this.billboardMode&&!s.useBillboardPosition){const e=R.Vector3[0];if(this._worldMatrix.getTranslationToRef(e),R.Matrix[1].copyFrom(t.getViewMatrix()),this._scene.useRightHandedSystem&&R.Matrix[1].multiplyToRef(Fs,R.Matrix[1]),R.Matrix[1].setTranslationFromFloats(0,0,0),R.Matrix[1].invertToRef(R.Matrix[0]),(this.billboardMode&ws.BILLBOARDMODE_ALL)!==ws.BILLBOARDMODE_ALL){R.Matrix[0].decompose(void 0,R.Quaternion[0],void 0);const e=R.Vector3[1];R.Quaternion[0].toEulerAnglesToRef(e),(this.billboardMode&ws.BILLBOARDMODE_X)!==ws.BILLBOARDMODE_X&&(e.x=0),(this.billboardMode&ws.BILLBOARDMODE_Y)!==ws.BILLBOARDMODE_Y&&(e.y=0),(this.billboardMode&ws.BILLBOARDMODE_Z)!==ws.BILLBOARDMODE_Z&&(e.z=0),y.RotationYawPitchRollToRef(e.y,e.x,e.z,R.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(R.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(R.Vector3[0])}else if(s.useBillboardPath&&t&&s.useBillboardPosition){const e=R.Vector3[0];this._worldMatrix.getTranslationToRef(e);const i=t.globalPosition;this._worldMatrix.invertToRef(R.Matrix[1]);const s=R.Vector3[1];S.TransformCoordinatesToRef(i,R.Matrix[1],s),s.normalize();const r=-Math.atan2(s.z,s.x)+Math.PI/2,n=Math.sqrt(s.x*s.x+s.z*s.z),o=-Math.atan2(s.y,n);if(C.RotationYawPitchRollToRef(r,o,0,R.Quaternion[0]),(this.billboardMode&ws.BILLBOARDMODE_ALL)!==ws.BILLBOARDMODE_ALL){const e=R.Vector3[1];R.Quaternion[0].toEulerAnglesToRef(e),(this.billboardMode&ws.BILLBOARDMODE_X)!==ws.BILLBOARDMODE_X&&(e.x=0),(this.billboardMode&ws.BILLBOARDMODE_Y)!==ws.BILLBOARDMODE_Y&&(e.y=0),(this.billboardMode&ws.BILLBOARDMODE_Z)!==ws.BILLBOARDMODE_Z&&(e.z=0),y.RotationYawPitchRollToRef(e.y,e.x,e.z,R.Matrix[0])}else y.FromQuaternionToRef(R.Quaternion[0],R.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(R.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(R.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):r&&r._nonUniformScaling?this._updateNonUniformScalingState(r._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=y.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix}resetLocalMatrix(e=!0){if(this.computeWorldMatrix(),e){const e=this.getChildren();for(let t=0;t<e.length;++t){const i=e[t];if(i){i.computeWorldMatrix();const e=R.Matrix[0];i._localMatrix.multiplyToRef(this._localMatrix,e);const t=R.Quaternion[0];e.decompose(i.scaling,t,i.position),i.rotationQuaternion?i.rotationQuaternion.copyFrom(t):t.toEulerAnglesToRef(i.rotation)}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=C.Identity()),this._worldMatrix=y.Identity()}_afterComputeWorldMatrix(){}registerAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this}unregisterAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this}getPositionInCameraSpace(e=null){return e||(e=this.getScene().activeCamera),S.TransformCoordinates(this.getAbsolutePosition(),e.getViewMatrix())}getDistanceToCamera(e=null){return e||(e=this.getScene().activeCamera),this.getAbsolutePosition().subtract(e.globalPosition).length()}clone(e,t,i){const s=de.Clone((()=>new ws(e,this.getScene())),this);if(s.name=e,s.id=e,t&&(s.parent=t),!i){const t=this.getDescendants(!0);for(let i=0;i<t.length;i++){const r=t[i];r.clone&&r.clone(e+"."+r.name,s)}}return s}serialize(e){const t=de.Serialize(this,e);return t.type=this.getClassName(),t.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(t),t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(),t}static Parse(e,t,i){const s=de.Parse((()=>new ws(e.name,t)),e,t,i);return e.localMatrix?s.setPreTransformMatrix(y.FromArray(e.localMatrix)):e.pivotMatrix&&s.setPivotMatrix(y.FromArray(e.pivotMatrix)),s.setEnabled(e.isEnabled),s._waitingParsedUniqueId=e.uniqueId,void 0!==e.parentId&&(s._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),s}getChildTransformNodes(e,t){const i=[];return this._getDescendants(i,e,(e=>(!t||t(e))&&e instanceof ws)),i}dispose(e,t=!1){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){const e=this._parentContainer.transformNodes.indexOf(this);e>-1&&this._parentContainer.transformNodes.splice(e,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),e){const e=this.getChildTransformNodes(!0);for(const t of e)t.parent=null,t.computeWorldMatrix(!0)}super.dispose(e,t)}normalizeToUnitCube(e=!0,t=!1,i){let s=null,r=null;t&&(this.rotationQuaternion?(r=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(s=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));const n=this.getHierarchyBoundingVectors(e,i),o=n.max.subtract(n.min),a=Math.max(o.x,o.y,o.z);if(0===a)return this;const l=1/a;return this.scaling.scaleInPlace(l),t&&(this.rotationQuaternion&&r?this.rotationQuaternion.copyFrom(r):this.rotation&&s&&this.rotation.copyFrom(s)),this}_syncAbsoluteScalingAndRotation(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)}}ws.BILLBOARDMODE_NONE=0,ws.BILLBOARDMODE_X=1,ws.BILLBOARDMODE_Y=2,ws.BILLBOARDMODE_Z=4,ws.BILLBOARDMODE_ALL=7,ws.BILLBOARDMODE_USE_POSITION=128,ws.BillboardUseParentOrientation=!1,ws._TmpRotation=C.Zero(),ws._TmpScaling=S.Zero(),ws._TmpTranslation=S.Zero(),ws._LookAtVectorCache=new S(0,0,0),ws._RotationAxisCache=new C,me([ae("position")],ws.prototype,"_position",void 0),me([ae("rotation")],ws.prototype,"_rotation",void 0),me([ee(10,"rotationQuaternion")],ws.prototype,"_rotationQuaternion",void 0),me([ae("scaling")],ws.prototype,"_scaling",void 0),me([ie("billboardMode")],ws.prototype,"_billboardMode",void 0),me([ie()],ws.prototype,"scalingDeterminant",void 0),me([ie("infiniteDistance")],ws.prototype,"_infiniteDistance",void 0),me([ie()],ws.prototype,"ignoreNonUniformScaling",void 0),me([ie()],ws.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0);class Ls{constructor(){this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new S(0,0,0),this._diffPositionForCollisions=new S(0,0,0),this._collisionResponse=!0}}class Bs{constructor(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=S.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}}class Us{constructor(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new Bs,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=null,this._currentLODIsUpToDate=!1,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._pointerOverDisableMeshTesting=!1,this._meshCollisionData=new Ls,this._enableDistantPicking=!1,this._rawBoundingInfo=null}}class Vs extends ws{static get BILLBOARDMODE_NONE(){return ws.BILLBOARDMODE_NONE}static get BILLBOARDMODE_X(){return ws.BILLBOARDMODE_X}static get BILLBOARDMODE_Y(){return ws.BILLBOARDMODE_Y}static get BILLBOARDMODE_Z(){return ws.BILLBOARDMODE_Z}static get BILLBOARDMODE_ALL(){return ws.BILLBOARDMODE_ALL}static get BILLBOARDMODE_USE_POSITION(){return ws.BILLBOARDMODE_USE_POSITION}get facetNb(){return this._internalAbstractMeshDataInfo._facetData.facetNb}get partitioningSubdivisions(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions}set partitioningSubdivisions(e){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=e}get partitioningBBoxRatio(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio}set partitioningBBoxRatio(e){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=e}get mustDepthSortFacets(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort}set mustDepthSortFacets(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=e}get facetDepthSortFrom(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom}set facetDepthSortFrom(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=e}get collisionRetryCount(){return this._internalAbstractMeshDataInfo._collisionRetryCount}set collisionRetryCount(e){this._internalAbstractMeshDataInfo._collisionRetryCount=e}get isFacetDataEnabled(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled}get morphTargetManager(){return this._internalAbstractMeshDataInfo._morphTargetManager}set morphTargetManager(e){this._internalAbstractMeshDataInfo._morphTargetManager!==e&&(this._internalAbstractMeshDataInfo._morphTargetManager=e,this._syncGeometryWithMorphTargetManager())}get bakedVertexAnimationManager(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager}set bakedVertexAnimationManager(e){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==e&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=e,this._markSubMeshesAsAttributesDirty())}_syncGeometryWithMorphTargetManager(){}_updateNonUniformScalingState(e){return!!super._updateNonUniformScalingState(e)&&(this._markSubMeshesAsMiscDirty(),!0)}get rawBoundingInfo(){return this._internalAbstractMeshDataInfo._rawBoundingInfo}set rawBoundingInfo(e){this._internalAbstractMeshDataInfo._rawBoundingInfo=e}set onCollide(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(e)}set onCollisionPositionChange(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(e)}get visibility(){return this._internalAbstractMeshDataInfo._visibility}set visibility(e){if(this._internalAbstractMeshDataInfo._visibility===e)return;const t=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=e,(1===t&&1!==e||1!==t&&1===e)&&this._markSubMeshesAsDirty((e=>{e.markAsMiscDirty(),e.markAsPrePassDirty()}))}get pointerOverDisableMeshTesting(){return this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting}set pointerOverDisableMeshTesting(e){this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting=e}get renderingGroupId(){return this._internalAbstractMeshDataInfo._renderingGroupId}set renderingGroupId(e){this._internalAbstractMeshDataInfo._renderingGroupId=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){this._internalAbstractMeshDataInfo._material!==e&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=e,e&&e.meshMap&&(e.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(),this._unBindEffect()))}getMaterialForRenderPass(e){var t;return null===(t=this._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===t?void 0:t[e]}setMaterialForRenderPass(e,t){this.resetDrawCache(e),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]),this._internalAbstractMeshDataInfo._materialForRenderPass[e]=t}get receiveShadows(){return this._internalAbstractMeshDataInfo._receiveShadows}set receiveShadows(e){this._internalAbstractMeshDataInfo._receiveShadows!==e&&(this._internalAbstractMeshDataInfo._receiveShadows=e,this._markSubMeshesAsLightDirty())}get hasVertexAlpha(){return this._internalAbstractMeshDataInfo._hasVertexAlpha}set hasVertexAlpha(e){this._internalAbstractMeshDataInfo._hasVertexAlpha!==e&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=e,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())}get useVertexColors(){return this._internalAbstractMeshDataInfo._useVertexColors}set useVertexColors(e){this._internalAbstractMeshDataInfo._useVertexColors!==e&&(this._internalAbstractMeshDataInfo._useVertexColors=e,this._markSubMeshesAsAttributesDirty())}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get numBoneInfluencers(){return this._internalAbstractMeshDataInfo._numBoneInfluencers}set numBoneInfluencers(e){this._internalAbstractMeshDataInfo._numBoneInfluencers!==e&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=e,this._markSubMeshesAsAttributesDirty())}get applyFog(){return this._internalAbstractMeshDataInfo._applyFog}set applyFog(e){this._internalAbstractMeshDataInfo._applyFog!==e&&(this._internalAbstractMeshDataInfo._applyFog=e,this._markSubMeshesAsMiscDirty())}get enableDistantPicking(){return this._internalAbstractMeshDataInfo._enableDistantPicking}set enableDistantPicking(e){this._internalAbstractMeshDataInfo._enableDistantPicking=e}get layerMask(){return this._internalAbstractMeshDataInfo._layerMask}set layerMask(e){e!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=e,this._resyncLightSources())}get collisionMask(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask}set collisionMask(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(e)?-1:e}get collisionResponse(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse}set collisionResponse(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=e}get collisionGroup(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup}set collisionGroup(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(e)?-1:e}get surroundingMeshes(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes}set surroundingMeshes(e){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=e}get lightSources(){return this._lightSources}get _positions(){return null}set skeleton(e){const t=this._internalAbstractMeshDataInfo._skeleton;t&&t.needInitialSkinMatrix&&t._unregisterMeshWithPoseMatrix(this),e&&e.needInitialSkinMatrix&&e._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=e,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()}get skeleton(){return this._internalAbstractMeshDataInfo._skeleton}constructor(e,t=null){switch(super(e,t,!1),this._internalAbstractMeshDataInfo=new Us,this._waitingMaterialId=null,this.cullingStrategy=Vs.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.onCollideObservable=new a,this.onCollisionPositionChangeObservable=new a,this.onMaterialChangedObservable=new a,this.definedFacingForward=!0,this._occlusionQuery=null,this._renderingGroup=null,this.alphaIndex=Number.MAX_VALUE,this.isVisible=!0,this.isPickable=!0,this.isNearPickable=!1,this.isNearGrabbable=!1,this.showSubMeshesBoundingBox=!1,this.isBlocker=!1,this.enablePointerMoveEvents=!1,this.outlineColor=N.Red(),this.outlineWidth=.02,this.overlayColor=N.Red(),this.overlayAlpha=.5,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.alwaysSelectAsActiveMesh=!1,this.doNotSyncBoundingInfo=!1,this.actionManager=null,this.ellipsoid=new S(.5,1,.5),this.ellipsoidOffset=new S(0,0,0),this.edgesWidth=1,this.edgesColor=new F(1,0,0,1),this._edgesRenderer=null,this._masterMesh=null,this._boundingInfo=null,this._boundingInfoIsDirty=!0,this._renderId=0,this._intersectionsInProgress=new Array,this._unIndexed=!1,this._lightSources=new Array,this._waitingData={lods:null,actions:null,freezeWorldMatrix:null},this._bonesTransformMatrices=null,this._transformMatrixTexture=null,this.onRebuildObservable=new a,this._onCollisionPositionChange=(e,t,i=null)=>{t.subtractToRef(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>Ns.CollisionsEpsilon&&this.position.addInPlace(this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),i&&this.onCollideObservable.notifyObservers(i),this.onCollisionPositionChangeObservable.notifyObservers(this.position)},(t=this.getScene()).addMesh(this),this._resyncLightSources(),this._uniformBuffer=new ai(this.getScene().getEngine(),void 0,void 0,e,!this.getScene().getEngine().isWebGPU),this._buildUniformLayout(),t.performancePriority){case ki.Aggressive:this.doNotSyncBoundingInfo=!0;case ki.Intermediate:this.alwaysSelectAsActiveMesh=!0,this.isPickable=!1}}_buildUniformLayout(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()}transferToEffect(e){const t=this._uniformBuffer;t.updateMatrix("world",e),t.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),t.update()}getMeshUniformBuffer(){return this._uniformBuffer}getClassName(){return"AbstractMesh"}toString(e){let t="Name: "+this.name+", isInstance: "+("InstancedMesh"!==this.getClassName()?"YES":"NO");t+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);const i=this._internalAbstractMeshDataInfo._skeleton;return i&&(t+=", skeleton: "+i.name),e&&(t+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],t+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),t}_getEffectiveParent(){return this._masterMesh&&this.billboardMode!==ws.BILLBOARDMODE_NONE?this._masterMesh:super._getEffectiveParent()}_getActionManagerForTrigger(e,t=!0){if(this.actionManager&&(t||this.actionManager.isRecursive)){if(!e)return this.actionManager;if(this.actionManager.hasSpecificTrigger(e))return this.actionManager}return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_rebuild(e=!1){if(this.onRebuildObservable.notifyObservers(this),null!==this._occlusionQuery&&(this._occlusionQuery=null),this.subMeshes)for(const e of this.subMeshes)e._rebuild()}_resyncLightSources(){this._lightSources.length=0;for(const e of this.getScene().lights)e.isEnabled()&&e.canAffectMesh(this)&&this._lightSources.push(e);this._markSubMeshesAsLightDirty()}_resyncLightSource(e){const t=e.isEnabled()&&e.canAffectMesh(this),i=this._lightSources.indexOf(e);let s=!1;if(-1===i){if(!t)return;this._lightSources.push(e)}else{if(t)return;s=!0,this._lightSources.splice(i,1)}this._markSubMeshesAsLightDirty(s)}_unBindEffect(){for(const e of this.subMeshes)e.setEffect(null)}_removeLightSource(e,t){const i=this._lightSources.indexOf(e);-1!==i&&(this._lightSources.splice(i,1),this._markSubMeshesAsLightDirty(t))}_markSubMeshesAsDirty(e){if(this.subMeshes)for(const t of this.subMeshes)for(let i=0;i<t._drawWrappers.length;++i){const s=t._drawWrappers[i];s&&s.defines&&s.defines.markAllAsDirty&&e(s.defines)}}_markSubMeshesAsLightDirty(e=!1){this._markSubMeshesAsDirty((t=>t.markAsLightDirty(e)))}_markSubMeshesAsAttributesDirty(){this._markSubMeshesAsDirty((e=>e.markAsAttributesDirty()))}_markSubMeshesAsMiscDirty(){this._markSubMeshesAsDirty((e=>e.markAsMiscDirty()))}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}resetDrawCache(e){if(this.subMeshes)for(const t of this.subMeshes)t.resetDrawCache(e)}get isBlocked(){return!1}getLOD(e){return this}getTotalVertices(){return 0}getTotalIndices(){return 0}getIndices(){return null}getVerticesData(e){return null}setVerticesData(e,t,i,s){return this}updateVerticesData(e,t,i,s){return this}setIndices(e,t){return this}isVerticesDataPresent(e){return!1}getBoundingInfo(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)}getRawBoundingInfo(){var e;return null!==(e=this.rawBoundingInfo)&&void 0!==e?e:this.getBoundingInfo()}setBoundingInfo(e){return this._boundingInfo=e,this}get hasBoundingInfo(){return null!==this._boundingInfo}buildBoundingInfo(e,t,i){return this._boundingInfo=new Es(e,t,i),this._boundingInfo}normalizeToUnitCube(e=!0,t=!1,i){return super.normalizeToUnitCube(e,t,i)}get useBones(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(hi.MatricesIndicesKind)&&this.isVerticesDataPresent(hi.MatricesWeightsKind)}_preActivate(){}_preActivateForIntermediateRendering(e){}_activate(e,t){return this._renderId=e,!0}_postActivate(){}_freeze(){}_unFreeze(){}getWorldMatrix(){return this._masterMesh&&this.billboardMode===ws.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():super.getWorldMatrix()}_getWorldMatrixDeterminant(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():super._getWorldMatrixDeterminant()}get isAnInstance(){return!1}get hasInstances(){return!1}get hasThinInstances(){return!1}movePOV(e,t,i){return this.position.addInPlace(this.calcMovePOV(e,t,i)),this}calcMovePOV(e,t,i){const s=new y;(this.rotationQuaternion?this.rotationQuaternion:C.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(s);const r=S.Zero(),n=this.definedFacingForward?-1:1;return S.TransformCoordinatesFromFloatsToRef(e*n,t,i*n,s,r),r}rotatePOV(e,t,i){return this.rotation.addInPlace(this.calcRotatePOV(e,t,i)),this}calcRotatePOV(e,t,i){const s=this.definedFacingForward?1:-1;return new S(e*s,t,i*s)}refreshBoundingInfo(e=!1,t=!1){return this._boundingInfo&&this._boundingInfo.isLocked||this._refreshBoundingInfo(this._getPositionData(e,t),null),this}_refreshBoundingInfo(e,t){if(e){const i=bs(e,0,this.getTotalVertices(),t);this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new Es(i.minimum,i.maximum)}if(this.subMeshes)for(let t=0;t<this.subMeshes.length;t++)this.subMeshes[t].refreshBoundingInfo(e);this._updateBoundingInfo()}_getData(e=!1,t=!1,i,s=hi.PositionKind){if((i=null!=i?i:this.getVerticesData(s).slice())&&t&&this.morphTargetManager){let e=0,t=0;for(let r=0;r<i.length;r++){for(let e=0;e<this.morphTargetManager.numTargets;e++){const t=this.morphTargetManager.getTarget(e),n=t.influence;if(n>0){let e=null;switch(s){case hi.PositionKind:e=t.getPositions();break;case hi.NormalKind:e=t.getNormals();break;case hi.TangentKind:e=t.getTangents();break;case hi.UVKind:e=t.getUVs()}e&&(i[r]+=(e[r]-i[r])*n)}}if(e++,s===hi.PositionKind&&this._positions&&3===e){e=0;const s=3*t;this._positions[t++].copyFromFloats(i[s],i[s+1],i[s+2])}}}if(i&&e&&this.skeleton){const e=this.getVerticesData(hi.MatricesIndicesKind),t=this.getVerticesData(hi.MatricesWeightsKind);if(t&&e){const r=this.numBoneInfluencers>4,n=r?this.getVerticesData(hi.MatricesIndicesExtraKind):null,o=r?this.getVerticesData(hi.MatricesWeightsExtraKind):null,a=this.skeleton.getTransformMatrices(this),l=R.Vector3[0],h=R.Matrix[0],c=R.Matrix[1];let u=0;for(let d=0;d<i.length;d+=3,u+=4){let p,_;for(h.reset(),p=0;p<4;p++)_=t[u+p],_>0&&(y.FromFloat32ArrayToRefScaled(a,Math.floor(16*e[u+p]),_,c),h.addToSelf(c));if(r)for(p=0;p<4;p++)_=o[u+p],_>0&&(y.FromFloat32ArrayToRefScaled(a,Math.floor(16*n[u+p]),_,c),h.addToSelf(c));s===hi.NormalKind?S.TransformNormalFromFloatsToRef(i[d],i[d+1],i[d+2],h,l):S.TransformCoordinatesFromFloatsToRef(i[d],i[d+1],i[d+2],h,l),l.toArray(i,d),s===hi.PositionKind&&this._positions&&this._positions[d/3].copyFrom(l)}}}return i}getNormalsData(e=!1,t=!1){return this._getData(e,t,null,hi.NormalKind)}getPositionData(e=!1,t=!1,i){return this._getData(e,t,i,hi.PositionKind)}_getPositionData(e,t){var i;let s=this.getVerticesData(hi.PositionKind);if(this._internalAbstractMeshDataInfo._positions&&(this._internalAbstractMeshDataInfo._positions=null),s&&(e&&this.skeleton||t&&this.morphTargetManager)){if(s=s.slice(),this._generatePointsArray(),this._positions){const e=this._positions;this._internalAbstractMeshDataInfo._positions=new Array(e.length);for(let t=0;t<e.length;t++)this._internalAbstractMeshDataInfo._positions[t]=(null===(i=e[t])||void 0===i?void 0:i.clone())||new S}return this.getPositionData(e,t,s)}return s}_updateBoundingInfo(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new Es(S.Zero(),S.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}_updateSubMeshesBoundingInfo(e){if(!this.subMeshes)return this;const t=this.subMeshes.length;for(let i=0;i<t;i++){const s=this.subMeshes[i];(t>1||!s.IsGlobal)&&s.updateBoundingInfo(e)}return this}_afterComputeWorldMatrix(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)}isInFrustum(e){return this.getBoundingInfo().isInFrustum(e,this.cullingStrategy)}isCompletelyInFrustum(e){return this.getBoundingInfo().isCompletelyInFrustum(e)}intersectsMesh(e,t=!1,i){const s=this.getBoundingInfo(),r=e.getBoundingInfo();if(s.intersects(r,t))return!0;if(i)for(const i of this.getChildMeshes())if(i.intersectsMesh(e,t,!0))return!0;return!1}intersectsPoint(e){return this.getBoundingInfo().intersectsPoint(e)}get checkCollisions(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions}set checkCollisions(e){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=e}get collider(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider}moveWithCollisions(e){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);const t=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=t.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,t.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,e,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId),this}_collideForSubMesh(e,t,i){var s;if(this._generatePointsArray(),!this._positions)return this;if(!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(t)){e._lastColliderTransformMatrix=t.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];const i=e.verticesStart,s=e.verticesStart+e.verticesCount;for(let r=i;r<s;r++)e._lastColliderWorldVertices.push(S.TransformCoordinates(this._positions[r],t))}return i._collide(e._trianglePlanes,e._lastColliderWorldVertices,this.getIndices(),e.indexStart,e.indexStart+e.indexCount,e.verticesStart,!!e.getMaterial(),this,this._shouldConvertRHS(),7===(null===(s=e.getMaterial())||void 0===s?void 0:s.fillMode)),this}_processCollisionsForSubMeshes(e,t){const i=this._scene.getCollidingSubMeshCandidates(this,e),s=i.length;for(let r=0;r<s;r++){const n=i.data[r];s>1&&!n._checkCollision(e)||this._collideForSubMesh(n,t,e)}return this}_shouldConvertRHS(){return!1}_checkCollision(e){if(!this.getBoundingInfo()._checkCollision(e))return this;const t=R.Matrix[0],i=R.Matrix[1];return y.ScalingToRef(1/e._radius.x,1/e._radius.y,1/e._radius.z,t),this.worldMatrixFromCache.multiplyToRef(t,i),this._processCollisionsForSubMeshes(e,i),this}_generatePointsArray(){return!1}intersects(e,t,i,s=!1,r,n=!1){const o=new ci,a=this.getClassName(),l="InstancedLinesMesh"===a||"LinesMesh"===a||"GreasedLineMesh"===a?this.intersectionThreshold:0,h=this.getBoundingInfo();if(!this.subMeshes)return o;if(!(n||e.intersectsSphere(h.boundingSphere,l)&&e.intersectsBox(h.boundingBox,l)))return o;if(s)return o.hit=!n,o.pickedMesh=n?null:this,o.distance=n?0:S.Distance(e.origin,h.boundingSphere.center),o.subMeshId=0,o;if(!this._generatePointsArray())return o;let c=null;const u=this._scene.getIntersectingSubMeshCandidates(this,e),d=u.length;let p=!1;for(let e=0;e<d;e++){const t=u.data[e].getMaterial();if(t&&(7==t.fillMode||0==t.fillMode||1==t.fillMode||2==t.fillMode||4==t.fillMode)){p=!0;break}}if(!p)return o.hit=!0,o.pickedMesh=this,o.distance=S.Distance(e.origin,h.boundingSphere.center),o.subMeshId=-1,o;for(let s=0;s<d;s++){const r=u.data[s];if(d>1&&!n&&!r.canIntersects(e))continue;const o=r.intersects(e,this._positions,this.getIndices(),t,i);if(o&&(t||!c||o.distance<c.distance)&&(c=o,c.subMeshId=s,t))break}if(c){const t=null!=r?r:this.getWorldMatrix(),i=R.Vector3[0],s=R.Vector3[1];S.TransformCoordinatesToRef(e.origin,t,i),e.direction.scaleToRef(c.distance,s);const n=S.TransformNormal(s,t).addInPlace(i);return o.hit=!0,o.distance=S.Distance(i,n),o.pickedPoint=n,o.pickedMesh=this,o.bu=c.bu||0,o.bv=c.bv||0,o.subMeshFaceId=c.faceId,o.faceId=c.faceId+u.data[c.subMeshId].indexStart/(-1!==this.getClassName().indexOf("LinesMesh")?2:3),o.subMeshId=c.subMeshId,o}return o}clone(e,t,i){return null}releaseSubMeshes(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=[];return this}dispose(e,t=!1){let i;const s=this.getScene();for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),s.freeActiveMeshes(),s.freeRenderingGroups(),s.renderingManager.maintainStateBetweenFrames&&s.renderingManager.restoreDispachedFlags(),void 0!==this.actionManager&&null!==this.actionManager&&(this._scene.meshes.some((e=>e!==this&&e.actionManager===this.actionManager))||this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),i=0;i<this._intersectionsInProgress.length;i++){const e=this._intersectionsInProgress[i],t=e._intersectionsInProgress.indexOf(this);e._intersectionsInProgress.splice(t,1)}this._intersectionsInProgress.length=0,s.lights.forEach((e=>{let t=e.includedOnlyMeshes.indexOf(this);-1!==t&&e.includedOnlyMeshes.splice(t,1),t=e.excludedMeshes.indexOf(this),-1!==t&&e.excludedMeshes.splice(t,1);const i=e.getShadowGenerators();if(i){const e=i.values();for(let i=e.next();!0!==i.done;i=e.next()){const e=i.value.getShadowMap();e&&e.renderList&&(t=e.renderList.indexOf(this),-1!==t&&e.renderList.splice(t,1))}}})),"InstancedMesh"===this.getClassName()&&"InstancedLinesMesh"===this.getClassName()||this.releaseSubMeshes();const r=s.getEngine();if(null!==this._occlusionQuery&&(this.isOcclusionQueryInProgress=!1,r.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),r.wipeCaches(),s.removeMesh(this),this._parentContainer){const e=this._parentContainer.meshes.indexOf(this);e>-1&&this._parentContainer.meshes.splice(e,1),this._parentContainer=null}if(t&&this.material&&("MultiMaterial"===this.material.getClassName()?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!e)for(i=0;i<s.particleSystems.length;i++)s.particleSystems[i].emitter===this&&(s.particleSystems[i].dispose(),i--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),super.dispose(e,t)}addChild(e,t=!1){return e.setParent(this,t),this}removeChild(e,t=!1){return e.setParent(null,t),this}_initFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetNormals||(e.facetNormals=[]),e.facetPositions||(e.facetPositions=[]),e.facetPartitioning||(e.facetPartitioning=new Array),e.facetNb=this.getIndices().length/3|0,e.partitioningSubdivisions=e.partitioningSubdivisions?e.partitioningSubdivisions:10,e.partitioningBBoxRatio=e.partitioningBBoxRatio?e.partitioningBBoxRatio:1.01;for(let t=0;t<e.facetNb;t++)e.facetNormals[t]=S.Zero(),e.facetPositions[t]=S.Zero();return e.facetDataEnabled=!0,this}updateFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetDataEnabled||this._initFacetData();const t=this.getVerticesData(hi.PositionKind),i=this.getIndices(),s=this.getVerticesData(hi.NormalKind),r=this.getBoundingInfo();if(e.facetDepthSort&&!e.facetDepthSortEnabled){if(e.facetDepthSortEnabled=!0,i instanceof Uint16Array)e.depthSortedIndices=new Uint16Array(i);else if(i instanceof Uint32Array)e.depthSortedIndices=new Uint32Array(i);else{let t=!1;for(let e=0;e<i.length;e++)if(i[e]>65535){t=!0;break}e.depthSortedIndices=t?new Uint32Array(i):new Uint16Array(i)}if(e.facetDepthSortFunction=function(e,t){return t.sqDistance-e.sqDistance},!e.facetDepthSortFrom){const t=this.getScene().activeCamera;e.facetDepthSortFrom=t?t.position:S.Zero()}e.depthSortedFacets=[];for(let t=0;t<e.facetNb;t++){const i={ind:3*t,sqDistance:0};e.depthSortedFacets.push(i)}e.invertedMatrix=y.Identity(),e.facetDepthSortOrigin=S.Zero()}e.bbSize.x=r.maximum.x-r.minimum.x>u?r.maximum.x-r.minimum.x:u,e.bbSize.y=r.maximum.y-r.minimum.y>u?r.maximum.y-r.minimum.y:u,e.bbSize.z=r.maximum.z-r.minimum.z>u?r.maximum.z-r.minimum.z:u;let n=e.bbSize.x>e.bbSize.y?e.bbSize.x:e.bbSize.y;if(n=n>e.bbSize.z?n:e.bbSize.z,e.subDiv.max=e.partitioningSubdivisions,e.subDiv.X=Math.floor(e.subDiv.max*e.bbSize.x/n),e.subDiv.Y=Math.floor(e.subDiv.max*e.bbSize.y/n),e.subDiv.Z=Math.floor(e.subDiv.max*e.bbSize.z/n),e.subDiv.X=e.subDiv.X<1?1:e.subDiv.X,e.subDiv.Y=e.subDiv.Y<1?1:e.subDiv.Y,e.subDiv.Z=e.subDiv.Z<1?1:e.subDiv.Z,e.facetParameters.facetNormals=this.getFacetLocalNormals(),e.facetParameters.facetPositions=this.getFacetLocalPositions(),e.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),e.facetParameters.bInfo=r,e.facetParameters.bbSize=e.bbSize,e.facetParameters.subDiv=e.subDiv,e.facetParameters.ratio=this.partitioningBBoxRatio,e.facetParameters.depthSort=e.facetDepthSort,e.facetDepthSort&&e.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(e.invertedMatrix),S.TransformCoordinatesToRef(e.facetDepthSortFrom,e.invertedMatrix,e.facetDepthSortOrigin),e.facetParameters.distanceTo=e.facetDepthSortOrigin),e.facetParameters.depthSortedFacets=e.depthSortedFacets,s&&As.ComputeNormals(t,i,s,e.facetParameters),e.facetDepthSort&&e.facetDepthSortEnabled){e.depthSortedFacets.sort(e.facetDepthSortFunction);const t=e.depthSortedIndices.length/3|0;for(let s=0;s<t;s++){const t=e.depthSortedFacets[s].ind;e.depthSortedIndices[3*s]=i[t],e.depthSortedIndices[3*s+1]=i[t+1],e.depthSortedIndices[3*s+2]=i[t+2]}this.updateIndices(e.depthSortedIndices,void 0,!0)}return this}getFacetLocalNormals(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetNormals||this.updateFacetData(),e.facetNormals}getFacetLocalPositions(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPositions||this.updateFacetData(),e.facetPositions}getFacetLocalPartitioning(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPartitioning||this.updateFacetData(),e.facetPartitioning}getFacetPosition(e){const t=S.Zero();return this.getFacetPositionToRef(e,t),t}getFacetPositionToRef(e,t){const i=this.getFacetLocalPositions()[e],s=this.getWorldMatrix();return S.TransformCoordinatesToRef(i,s,t),this}getFacetNormal(e){const t=S.Zero();return this.getFacetNormalToRef(e,t),t}getFacetNormalToRef(e,t){const i=this.getFacetLocalNormals()[e];return S.TransformNormalToRef(i,this.getWorldMatrix(),t),this}getFacetsAtLocalCoordinates(e,t,i){const s=this.getBoundingInfo(),r=this._internalAbstractMeshDataInfo._facetData,n=Math.floor((e-s.minimum.x*r.partitioningBBoxRatio)*r.subDiv.X*r.partitioningBBoxRatio/r.bbSize.x),o=Math.floor((t-s.minimum.y*r.partitioningBBoxRatio)*r.subDiv.Y*r.partitioningBBoxRatio/r.bbSize.y),a=Math.floor((i-s.minimum.z*r.partitioningBBoxRatio)*r.subDiv.Z*r.partitioningBBoxRatio/r.bbSize.z);return n<0||n>r.subDiv.max||o<0||o>r.subDiv.max||a<0||a>r.subDiv.max?null:r.facetPartitioning[n+r.subDiv.max*o+r.subDiv.max*r.subDiv.max*a]}getClosestFacetAtCoordinates(e,t,i,s,r=!1,n=!0){const o=this.getWorldMatrix(),a=R.Matrix[5];o.invertToRef(a);const l=R.Vector3[8];S.TransformCoordinatesFromFloatsToRef(e,t,i,a,l);const h=this.getClosestFacetAtLocalCoordinates(l.x,l.y,l.z,s,r,n);return s&&S.TransformCoordinatesFromFloatsToRef(s.x,s.y,s.z,o,s),h}getClosestFacetAtLocalCoordinates(e,t,i,s,r=!1,n=!0){let o=null,a=0,l=0,h=0,c=0,u=0,d=0,p=0,_=0;const f=this.getFacetLocalPositions(),m=this.getFacetLocalNormals(),g=this.getFacetsAtLocalCoordinates(e,t,i);if(!g)return null;let v,x,T,E=Number.MAX_VALUE,S=E;for(let b=0;b<g.length;b++)v=g[b],x=m[v],T=f[v],c=(e-T.x)*x.x+(t-T.y)*x.y+(i-T.z)*x.z,(!r||r&&n&&c>=0||r&&!n&&c<=0)&&(c=x.x*T.x+x.y*T.y+x.z*T.z,u=-(x.x*e+x.y*t+x.z*i-c)/(x.x*x.x+x.y*x.y+x.z*x.z),d=e+x.x*u,p=t+x.y*u,_=i+x.z*u,a=d-e,l=p-t,h=_-i,S=a*a+l*l+h*h,S<E&&(E=S,o=v,s&&(s.x=d,s.y=p,s.z=_)));return o}getFacetDataParameters(){return this._internalAbstractMeshDataInfo._facetData.facetParameters}disableFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetDataEnabled&&(e.facetDataEnabled=!1,e.facetPositions=[],e.facetNormals=[],e.facetPartitioning=new Array,e.facetParameters=null,e.depthSortedIndices=new Uint32Array(0)),this}updateIndices(e,t,i=!1){return this}createNormals(e){const t=this.getVerticesData(hi.PositionKind),i=this.getIndices();let s;return s=this.isVerticesDataPresent(hi.NormalKind)?this.getVerticesData(hi.NormalKind):[],As.ComputeNormals(t,i,s,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(hi.NormalKind,s,e),this}alignWithNormal(e,t){t||(t=ji.Y);const i=R.Vector3[0],s=R.Vector3[1];return S.CrossToRef(t,e,s),S.CrossToRef(e,s,i),this.rotationQuaternion?C.RotationQuaternionFromAxisToRef(i,e,s,this.rotationQuaternion):S.RotationFromAxisToRef(i,e,s,this.rotation),this}_checkOcclusionQuery(){return!1}disableEdgesRendering(){throw $("EdgesRenderer")}enableEdgesRendering(e,t,i){throw $("EdgesRenderer")}getConnectedParticleSystems(){return this._scene.particleSystems.filter((e=>e.emitter===this))}}function ks(e){-1===e.indexOf("vClipPlane")&&e.push("vClipPlane"),-1===e.indexOf("vClipPlane2")&&e.push("vClipPlane2"),-1===e.indexOf("vClipPlane3")&&e.push("vClipPlane3"),-1===e.indexOf("vClipPlane4")&&e.push("vClipPlane4"),-1===e.indexOf("vClipPlane5")&&e.push("vClipPlane5"),-1===e.indexOf("vClipPlane6")&&e.push("vClipPlane6")}function Gs(e,t,i){var s,r,n,o,a,l;const h=!!(null!==(s=e.clipPlane)&&void 0!==s?s:t.clipPlane),c=!!(null!==(r=e.clipPlane2)&&void 0!==r?r:t.clipPlane2),u=!!(null!==(n=e.clipPlane3)&&void 0!==n?n:t.clipPlane3),d=!!(null!==(o=e.clipPlane4)&&void 0!==o?o:t.clipPlane4),p=!!(null!==(a=e.clipPlane5)&&void 0!==a?a:t.clipPlane5),_=!!(null!==(l=e.clipPlane6)&&void 0!==l?l:t.clipPlane6);h&&i.push("#define CLIPPLANE"),c&&i.push("#define CLIPPLANE2"),u&&i.push("#define CLIPPLANE3"),d&&i.push("#define CLIPPLANE4"),p&&i.push("#define CLIPPLANE5"),_&&i.push("#define CLIPPLANE6")}function zs(e,t,i){var s,r,n,o,a,l;let h=null!==(s=t.clipPlane)&&void 0!==s?s:i.clipPlane;Ws(e,"vClipPlane",h),h=null!==(r=t.clipPlane2)&&void 0!==r?r:i.clipPlane2,Ws(e,"vClipPlane2",h),h=null!==(n=t.clipPlane3)&&void 0!==n?n:i.clipPlane3,Ws(e,"vClipPlane3",h),h=null!==(o=t.clipPlane4)&&void 0!==o?o:i.clipPlane4,Ws(e,"vClipPlane4",h),h=null!==(a=t.clipPlane5)&&void 0!==a?a:i.clipPlane5,Ws(e,"vClipPlane5",h),h=null!==(l=t.clipPlane6)&&void 0!==l?l:i.clipPlane6,Ws(e,"vClipPlane6",h)}function Ws(e,t,i){i&&e.setFloat4(t,i.normal.x,i.normal.y,i.normal.z,i.d)}Vs.OCCLUSION_TYPE_NONE=0,Vs.OCCLUSION_TYPE_OPTIMISTIC=1,Vs.OCCLUSION_TYPE_STRICT=2,Vs.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0,Vs.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1,Vs.CULLINGSTRATEGY_STANDARD=0,Vs.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,Vs.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,Vs.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,m("BABYLON.AbstractMesh",Vs);class Hs{static BindSceneUniformBuffer(e,t){t.bindToEffect(e,"Scene")}static PrepareDefinesForMergedUV(e,t,i){t._needUVs=!0,t[i]=!0,e.optimizeUVAllocation&&e.getTextureMatrix().isIdentityAs3x2()?(t[i+"DIRECTUV"]=e.coordinatesIndex+1,t["MAINUV"+(e.coordinatesIndex+1)]=!0):t[i+"DIRECTUV"]=0}static BindTextureMatrix(e,t,i){const s=e.getTextureMatrix();t.updateMatrix(i+"Matrix",s)}static GetFogState(e,t){return t.fogEnabled&&e.applyFog&&t.fogMode!==Yi.FOGMODE_NONE}static PrepareDefinesForMisc(e,t,i,s,r,n,o,a=!1){o._areMiscDirty&&(o.LOGARITHMICDEPTH=i,o.POINTSIZE=s,o.FOG=r&&this.GetFogState(e,t),o.NONUNIFORMSCALING=e.nonUniformScaling,o.ALPHATEST=n,o.DECAL_AFTER_DETAIL=a)}static PrepareDefinesForCamera(e,t){let i=!1;if(e.activeCamera){const s=t.CAMERA_ORTHOGRAPHIC?1:0,r=t.CAMERA_PERSPECTIVE?1:0,n=e.activeCamera.mode===ps.ORTHOGRAPHIC_CAMERA?1:0,o=e.activeCamera.mode===ps.PERSPECTIVE_CAMERA?1:0;(s^n||r^o)&&(t.CAMERA_ORTHOGRAPHIC=1===n,t.CAMERA_PERSPECTIVE=1===o,i=!0)}return i}static PrepareDefinesForFrameBoundValues(e,t,i,s,r,n=null,o=!1){let a=Hs.PrepareDefinesForCamera(e,s);!1!==n&&(a=function(e,t,i){var s,r,n,o,a,l;let h=!1;const c=!!(null!==(s=e.clipPlane)&&void 0!==s?s:t.clipPlane),u=!!(null!==(r=e.clipPlane2)&&void 0!==r?r:t.clipPlane2),d=!!(null!==(n=e.clipPlane3)&&void 0!==n?n:t.clipPlane3),p=!!(null!==(o=e.clipPlane4)&&void 0!==o?o:t.clipPlane4),_=!!(null!==(a=e.clipPlane5)&&void 0!==a?a:t.clipPlane5),f=!!(null!==(l=e.clipPlane6)&&void 0!==l?l:t.clipPlane6);return i.CLIPPLANE!==c&&(i.CLIPPLANE=c,h=!0),i.CLIPPLANE2!==u&&(i.CLIPPLANE2=u,h=!0),i.CLIPPLANE3!==d&&(i.CLIPPLANE3=d,h=!0),i.CLIPPLANE4!==p&&(i.CLIPPLANE4=p,h=!0),i.CLIPPLANE5!==_&&(i.CLIPPLANE5=_,h=!0),i.CLIPPLANE6!==f&&(i.CLIPPLANE6=f,h=!0),h}(i,e,s)),s.DEPTHPREPASS!==!t.getColorWrite()&&(s.DEPTHPREPASS=!s.DEPTHPREPASS,a=!0),s.INSTANCES!==r&&(s.INSTANCES=r,a=!0),s.THIN_INSTANCES!==o&&(s.THIN_INSTANCES=o,a=!0),a&&s.markAsUnprocessed()}static PrepareDefinesForBones(e,t){if(e.useBones&&e.computeBonesUsingShaders&&e.skeleton){t.NUM_BONE_INFLUENCERS=e.numBoneInfluencers;const i=void 0!==t.BONETEXTURE;if(e.skeleton.isUsingTextureForMatrices&&i)t.BONETEXTURE=!0;else{t.BonesPerMesh=e.skeleton.bones.length+1,t.BONETEXTURE=!i&&void 0;const s=e.getScene().prePassRenderer;if(s&&s.enabled){const i=-1===s.excludedSkinnedMesh.indexOf(e);t.BONES_VELOCITY_ENABLED=i}}}else t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0,void 0!==t.BONETEXTURE&&(t.BONETEXTURE=!1)}static PrepareDefinesForMorphTargets(e,t){const i=e.morphTargetManager;i?(t.MORPHTARGETS_UV=i.supportsUVs&&t.UV1,t.MORPHTARGETS_TANGENT=i.supportsTangents&&t.TANGENT,t.MORPHTARGETS_NORMAL=i.supportsNormals&&t.NORMAL,t.MORPHTARGETS=i.numInfluencers>0,t.NUM_MORPH_INFLUENCERS=i.numInfluencers,t.MORPHTARGETS_TEXTURE=i.isUsingTextureForTargets):(t.MORPHTARGETS_UV=!1,t.MORPHTARGETS_TANGENT=!1,t.MORPHTARGETS_NORMAL=!1,t.MORPHTARGETS=!1,t.NUM_MORPH_INFLUENCERS=0)}static PrepareDefinesForBakedVertexAnimation(e,t){const i=e.bakedVertexAnimationManager;t.BAKED_VERTEX_ANIMATION_TEXTURE=!(!i||!i.isEnabled)}static PrepareDefinesForAttributes(e,t,i,s,r=!1,n=!0,o=!0){if(!t._areAttributesDirty&&t._needNormals===t._normals&&t._needUVs===t._uvs)return!1;t._normals=t._needNormals,t._uvs=t._needUVs,t.NORMAL=t._needNormals&&e.isVerticesDataPresent(hi.NormalKind),t._needNormals&&e.isVerticesDataPresent(hi.TangentKind)&&(t.TANGENT=!0);for(let i=1;i<=6;++i)t["UV"+i]=!!t._needUVs&&e.isVerticesDataPresent(`uv${1===i?"":i}`);if(i){const i=e.useVertexColors&&e.isVerticesDataPresent(hi.ColorKind);t.VERTEXCOLOR=i,t.VERTEXALPHA=e.hasVertexAlpha&&i&&n}return e.isVerticesDataPresent(hi.ColorInstanceKind)&&(e.hasInstances||e.hasThinInstances)&&(t.INSTANCESCOLOR=!0),s&&this.PrepareDefinesForBones(e,t),r&&this.PrepareDefinesForMorphTargets(e,t),o&&this.PrepareDefinesForBakedVertexAnimation(e,t),!0}static PrepareDefinesForMultiview(e,t){if(e.activeCamera){const i=t.MULTIVIEW;t.MULTIVIEW=null!==e.activeCamera.outputRenderTarget&&e.activeCamera.outputRenderTarget.getViewCount()>1,t.MULTIVIEW!=i&&t.markAsUnprocessed()}}static PrepareDefinesForOIT(e,t,i){const s=t.ORDER_INDEPENDENT_TRANSPARENCY,r=t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;t.ORDER_INDEPENDENT_TRANSPARENCY=e.useOrderIndependentTransparency&&i,t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!e.getEngine().getCaps().textureFloatLinearFiltering,s===t.ORDER_INDEPENDENT_TRANSPARENCY&&r===t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS||t.markAsUnprocessed()}static PrepareDefinesForPrePass(e,t,i){const s=t.PREPASS;if(!t._arePrePassDirty)return;const r=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"}];if(e.prePassRenderer&&e.prePassRenderer.enabled&&i){t.PREPASS=!0,t.SCENE_MRT_COUNT=e.prePassRenderer.mrtCount,t.PREPASS_NORMAL_WORLDSPACE=e.prePassRenderer.generateNormalsInWorldSpace;for(let i=0;i<r.length;i++){const s=e.prePassRenderer.getIndex(r[i].type);-1!==s?(t[r[i].define]=!0,t[r[i].index]=s):t[r[i].define]=!1}}else{t.PREPASS=!1;for(let e=0;e<r.length;e++)t[r[e].define]=!1}t.PREPASS!=s&&(t.markAsUnprocessed(),t.markAsImageProcessingDirty())}static PrepareDefinesForLight(e,t,i,s,r,n,o){var a;switch(o.needNormals=!0,void 0===r["LIGHT"+s]&&(o.needRebuild=!0),r["LIGHT"+s]=!0,r["SPOTLIGHT"+s]=!1,r["HEMILIGHT"+s]=!1,r["POINTLIGHT"+s]=!1,r["DIRLIGHT"+s]=!1,i.prepareLightSpecificDefines(r,s),r["LIGHT_FALLOFF_PHYSICAL"+s]=!1,r["LIGHT_FALLOFF_GLTF"+s]=!1,r["LIGHT_FALLOFF_STANDARD"+s]=!1,i.falloffType){case Ui.FALLOFF_GLTF:r["LIGHT_FALLOFF_GLTF"+s]=!0;break;case Ui.FALLOFF_PHYSICAL:r["LIGHT_FALLOFF_PHYSICAL"+s]=!0;break;case Ui.FALLOFF_STANDARD:r["LIGHT_FALLOFF_STANDARD"+s]=!0}if(n&&!i.specular.equalsFloats(0,0,0)&&(o.specularEnabled=!0),r["SHADOW"+s]=!1,r["SHADOWCSM"+s]=!1,r["SHADOWCSMDEBUG"+s]=!1,r["SHADOWCSMNUM_CASCADES"+s]=!1,r["SHADOWCSMUSESHADOWMAXZ"+s]=!1,r["SHADOWCSMNOBLEND"+s]=!1,r["SHADOWCSM_RIGHTHANDED"+s]=!1,r["SHADOWPCF"+s]=!1,r["SHADOWPCSS"+s]=!1,r["SHADOWPOISSON"+s]=!1,r["SHADOWESM"+s]=!1,r["SHADOWCLOSEESM"+s]=!1,r["SHADOWCUBE"+s]=!1,r["SHADOWLOWQUALITY"+s]=!1,r["SHADOWMEDIUMQUALITY"+s]=!1,t&&t.receiveShadows&&e.shadowsEnabled&&i.shadowEnabled){const t=null!==(a=i.getShadowGenerator(e.activeCamera))&&void 0!==a?a:i.getShadowGenerator();if(t){const e=t.getShadowMap();e&&e.renderList&&e.renderList.length>0&&(o.shadowEnabled=!0,t.prepareDefines(r,s))}}i.lightmapMode!=Ui.LIGHTMAP_DEFAULT?(o.lightmapMode=!0,r["LIGHTMAPEXCLUDED"+s]=!0,r["LIGHTMAPNOSPECULAR"+s]=i.lightmapMode==Ui.LIGHTMAP_SHADOWSONLY):(r["LIGHTMAPEXCLUDED"+s]=!1,r["LIGHTMAPNOSPECULAR"+s]=!1)}static PrepareDefinesForLights(e,t,i,s,r=4,n=!1){if(!i._areLightsDirty)return i._needNormals;let o=0;const a={needNormals:i._needNormals,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(e.lightsEnabled&&!n)for(const n of t.lightSources)if(this.PrepareDefinesForLight(e,t,n,o,i,s,a),o++,o===r)break;i.SPECULARTERM=a.specularEnabled,i.SHADOWS=a.shadowEnabled;for(let e=o;e<r;e++)void 0!==i["LIGHT"+e]&&(i["LIGHT"+e]=!1,i["HEMILIGHT"+e]=!1,i["POINTLIGHT"+e]=!1,i["DIRLIGHT"+e]=!1,i["SPOTLIGHT"+e]=!1,i["SHADOW"+e]=!1,i["SHADOWCSM"+e]=!1,i["SHADOWCSMDEBUG"+e]=!1,i["SHADOWCSMNUM_CASCADES"+e]=!1,i["SHADOWCSMUSESHADOWMAXZ"+e]=!1,i["SHADOWCSMNOBLEND"+e]=!1,i["SHADOWCSM_RIGHTHANDED"+e]=!1,i["SHADOWPCF"+e]=!1,i["SHADOWPCSS"+e]=!1,i["SHADOWPOISSON"+e]=!1,i["SHADOWESM"+e]=!1,i["SHADOWCLOSEESM"+e]=!1,i["SHADOWCUBE"+e]=!1,i["SHADOWLOWQUALITY"+e]=!1,i["SHADOWMEDIUMQUALITY"+e]=!1);const l=e.getEngine().getCaps();return void 0===i.SHADOWFLOAT&&(a.needRebuild=!0),i.SHADOWFLOAT=a.shadowEnabled&&(l.textureFloatRender&&l.textureFloatLinearFiltering||l.textureHalfFloatRender&&l.textureHalfFloatLinearFiltering),i.LIGHTMAPEXCLUDED=a.lightmapMode,a.needRebuild&&i.rebuild(),a.needNormals}static PrepareUniformsAndSamplersForLight(e,t,i,s,r=null,n=!1){r&&r.push("Light"+e),n||(t.push("vLightData"+e,"vLightDiffuse"+e,"vLightSpecular"+e,"vLightDirection"+e,"vLightFalloff"+e,"vLightGround"+e,"lightMatrix"+e,"shadowsInfo"+e,"depthValues"+e),i.push("shadowSampler"+e),i.push("depthSampler"+e),t.push("viewFrustumZ"+e,"cascadeBlendFactor"+e,"lightSizeUVCorrection"+e,"depthCorrection"+e,"penumbraDarkness"+e,"frustumLengths"+e),s&&(i.push("projectionLightSampler"+e),t.push("textureProjectionMatrix"+e)))}static PrepareUniformsAndSamplersList(e,t,i,s=4){let r,n=null;if(e.uniformsNames){const o=e;r=o.uniformsNames,n=o.uniformBuffersNames,t=o.samplers,i=o.defines,s=o.maxSimultaneousLights||0}else r=e,t||(t=[]);for(let e=0;e<s&&i["LIGHT"+e];e++)this.PrepareUniformsAndSamplersForLight(e,r,t,i["PROJECTEDLIGHTTEXTURE"+e],n);i.NUM_MORPH_INFLUENCERS&&r.push("morphTargetInfluences"),i.BAKED_VERTEX_ANIMATION_TEXTURE&&(r.push("bakedVertexAnimationSettings"),r.push("bakedVertexAnimationTextureSizeInverted"),r.push("bakedVertexAnimationTime"),t.push("bakedVertexAnimationTexture"))}static HandleFallbacksForShadows(e,t,i=4,s=0){let r=0;for(let n=0;n<i&&e["LIGHT"+n];n++)n>0&&(r=s+n,t.addFallback(r,"LIGHT"+n)),e.SHADOWS||(e["SHADOW"+n]&&t.addFallback(s,"SHADOW"+n),e["SHADOWPCF"+n]&&t.addFallback(s,"SHADOWPCF"+n),e["SHADOWPCSS"+n]&&t.addFallback(s,"SHADOWPCSS"+n),e["SHADOWPOISSON"+n]&&t.addFallback(s,"SHADOWPOISSON"+n),e["SHADOWESM"+n]&&t.addFallback(s,"SHADOWESM"+n),e["SHADOWCLOSEESM"+n]&&t.addFallback(s,"SHADOWCLOSEESM"+n));return r++}static PrepareAttributesForMorphTargetsInfluencers(e,t,i){this._TmpMorphInfluencers.NUM_MORPH_INFLUENCERS=i,this.PrepareAttributesForMorphTargets(e,t,this._TmpMorphInfluencers)}static PrepareAttributesForMorphTargets(e,t,i){const s=i.NUM_MORPH_INFLUENCERS;if(s>0&&x.LastCreatedEngine){const r=x.LastCreatedEngine.getCaps().maxVertexAttribs,n=t.morphTargetManager;if(null==n?void 0:n.isUsingTextureForTargets)return;const o=n&&n.supportsNormals&&i.NORMAL,a=n&&n.supportsTangents&&i.TANGENT,l=n&&n.supportsUVs&&i.UV1;for(let i=0;i<s;i++)e.push(hi.PositionKind+i),o&&e.push(hi.NormalKind+i),a&&e.push(hi.TangentKind+i),l&&e.push(hi.UVKind+"_"+i),e.length>r&&k.Error("Cannot add more vertex attributes for mesh "+t.name)}}static PrepareAttributesForBakedVertexAnimation(e,t,i){i.BAKED_VERTEX_ANIMATION_TEXTURE&&i.INSTANCES&&e.push("bakedVertexAnimationSettingsInstanced")}static PrepareAttributesForBones(e,t,i,s){i.NUM_BONE_INFLUENCERS>0&&(s.addCPUSkinningFallback(0,t),e.push(hi.MatricesIndicesKind),e.push(hi.MatricesWeightsKind),i.NUM_BONE_INFLUENCERS>4&&(e.push(hi.MatricesIndicesExtraKind),e.push(hi.MatricesWeightsExtraKind)))}static PrepareAttributesForInstances(e,t){(t.INSTANCES||t.THIN_INSTANCES)&&this.PushAttributesForInstances(e,!!t.PREPASS_VELOCITY),t.INSTANCESCOLOR&&e.push(hi.ColorInstanceKind)}static PushAttributesForInstances(e,t=!1){e.push("world0"),e.push("world1"),e.push("world2"),e.push("world3"),t&&(e.push("previousWorld0"),e.push("previousWorld1"),e.push("previousWorld2"),e.push("previousWorld3"))}static BindLightProperties(e,t,i){e.transferToEffect(t,i+"")}static BindLight(e,t,i,s,r,n=!0){e._bindLight(t,i,s,r,n)}static BindLights(e,t,i,s,r=4){const n=Math.min(t.lightSources.length,r);for(let r=0;r<n;r++){const n=t.lightSources[r];this.BindLight(n,r,e,i,"boolean"==typeof s?s:s.SPECULARTERM,t.receiveShadows)}}static BindFogParameters(e,t,i,s=!1){e.fogEnabled&&t.applyFog&&e.fogMode!==Yi.FOGMODE_NONE&&(i.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),s?(e.fogColor.toLinearSpaceToRef(this._TempFogColor,e.getEngine().useExactSrgbConversions),i.setColor3("vFogColor",this._TempFogColor)):i.setColor3("vFogColor",e.fogColor))}static BindBonesParameters(e,t,i){if(t&&e&&(e.computeBonesUsingShaders&&t._bonesComputationForcedToCPU&&(e.computeBonesUsingShaders=!1),e.useBones&&e.computeBonesUsingShaders&&e.skeleton)){const s=e.skeleton;if(s.isUsingTextureForMatrices&&t.getUniformIndex("boneTextureWidth")>-1){const i=s.getTransformMatrixTexture(e);t.setTexture("boneSampler",i),t.setFloat("boneTextureWidth",4*(s.bones.length+1))}else{const r=s.getTransformMatrices(e);r&&(t.setMatrices("mBones",r),i&&e.getScene().prePassRenderer&&e.getScene().prePassRenderer.getIndex(2)&&(i.previousBones[e.uniqueId]||(i.previousBones[e.uniqueId]=r.slice()),t.setMatrices("mPreviousBones",i.previousBones[e.uniqueId]),Hs._CopyBonesTransformationMatrices(r,i.previousBones[e.uniqueId])))}}}static _CopyBonesTransformationMatrices(e,t){return t.set(e),t}static BindMorphTargetParameters(e,t){const i=e.morphTargetManager;e&&i&&t.setFloatArray("morphTargetInfluences",i.influences)}static BindLogDepth(e,t,i){if(!e||e.LOGARITHMICDEPTH||e.indexOf&&e.indexOf("LOGARITHMICDEPTH")>=0){const e=i.activeCamera;e.mode===ps.ORTHOGRAPHIC_CAMERA&&k.Error("Logarithmic depth is not compatible with orthographic cameras!",20),t.setFloat("logarithmicDepthConstant",2/(Math.log(e.maxZ+1)/Math.LN2))}}}Hs._TmpMorphInfluencers={NUM_MORPH_INFLUENCERS:0},Hs._TempFogColor=N.Black();class Xs{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=519,this.funcRef=1,this.funcMask=255,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681}get func(){return this._func}set func(e){this._func=e}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef=e}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask=e}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail=e}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail=e}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass=e}get mask(){return this._mask}set mask(e){this._mask=e}get enabled(){return this._enabled}set enabled(e){this._enabled=e}getClassName(){return"MaterialStencilState"}copyTo(e){de.Clone((()=>e),this)}serialize(){return de.Serialize(this)}parse(e,t,i){de.Parse((()=>this),e,t,i)}}var Ys,js,Ks,$s,qs,Qs,Zs,Js,er,tr,ir;me([ie()],Xs.prototype,"func",null),me([ie()],Xs.prototype,"funcRef",null),me([ie()],Xs.prototype,"funcMask",null),me([ie()],Xs.prototype,"opStencilFail",null),me([ie()],Xs.prototype,"opDepthFail",null),me([ie()],Xs.prototype,"opStencilDepthPass",null),me([ie()],Xs.prototype,"mask",null),me([ie()],Xs.prototype,"enabled",null),(js=Ys||(Ys={}))[js.Created=1]="Created",js[js.Disposed=2]="Disposed",js[js.GetDefineNames=4]="GetDefineNames",js[js.PrepareUniformBuffer=8]="PrepareUniformBuffer",js[js.IsReadyForSubMesh=16]="IsReadyForSubMesh",js[js.PrepareDefines=32]="PrepareDefines",js[js.BindForSubMesh=64]="BindForSubMesh",js[js.PrepareEffect=128]="PrepareEffect",js[js.GetAnimatables=256]="GetAnimatables",js[js.GetActiveTextures=512]="GetActiveTextures",js[js.HasTexture=1024]="HasTexture",js[js.FillRenderTargetTextures=2048]="FillRenderTargetTextures",js[js.HasRenderTargetTextures=4096]="HasRenderTargetTextures",js[js.HardBindForSubMesh=8192]="HardBindForSubMesh";class sr{get canRenderToMRT(){return!1}set alpha(e){if(this._alpha===e)return;const t=this._alpha;this._alpha=e,1!==t&&1!==e||this.markAsDirty(sr.MiscDirtyFlag+sr.PrePassDirtyFlag)}get alpha(){return this._alpha}set backFaceCulling(e){this._backFaceCulling!==e&&(this._backFaceCulling=e,this.markAsDirty(sr.TextureDirtyFlag))}get backFaceCulling(){return this._backFaceCulling}set cullBackFaces(e){this._cullBackFaces!==e&&(this._cullBackFaces=e,this.markAsDirty(sr.TextureDirtyFlag))}get cullBackFaces(){return this._cullBackFaces}get blockDirtyMechanism(){return this._blockDirtyMechanism}set blockDirtyMechanism(e){this._blockDirtyMechanism!==e&&(this._blockDirtyMechanism=e,e||this.markDirty())}atomicMaterialsUpdate(e){this.blockDirtyMechanism=!0;try{e(this)}finally{this.blockDirtyMechanism=!1}}get hasRenderTargetTextures(){return this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new a),this._onBindObservable}set onBind(e){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(e)}get onUnBindObservable(){return this._onUnBindObservable||(this._onUnBindObservable=new a),this._onUnBindObservable}get onEffectCreatedObservable(){return this._onEffectCreatedObservable||(this._onEffectCreatedObservable=new a),this._onEffectCreatedObservable}set alphaMode(e){this._alphaMode!==e&&(this._alphaMode=e,this.markAsDirty(sr.TextureDirtyFlag))}get alphaMode(){return this._alphaMode}set needDepthPrePass(e){this._needDepthPrePass!==e&&(this._needDepthPrePass=e,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))}get needDepthPrePass(){return this._needDepthPrePass}get isPrePassCapable(){return!1}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAsDirty(sr.MiscDirtyFlag))}get fogEnabled(){return this._fogEnabled}get wireframe(){switch(this._fillMode){case sr.WireFrameFillMode:case sr.LineListDrawMode:case sr.LineLoopDrawMode:case sr.LineStripDrawMode:return!0}return this._scene.forceWireframe}set wireframe(e){this.fillMode=e?sr.WireFrameFillMode:sr.TriangleFillMode}get pointsCloud(){switch(this._fillMode){case sr.PointFillMode:case sr.PointListDrawMode:return!0}return this._scene.forcePointsCloud}set pointsCloud(e){this.fillMode=e?sr.PointFillMode:sr.TriangleFillMode}get fillMode(){return this._fillMode}set fillMode(e){this._fillMode!==e&&(this._fillMode=e,this.markAsDirty(sr.MiscDirtyFlag))}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){const t=this.getScene().getEngine().getCaps().fragmentDepthSupported;e&&!t&&k.Warn("Logarithmic depth has been requested for a material on a device that doesn't support it."),this._useLogarithmicDepth=e&&t,this._markAllSubMeshesAsMiscDirty()}_getDrawWrapper(){return this._drawWrapper}_setDrawWrapper(e){this._drawWrapper=e}constructor(e,t,i){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this._alpha=1,this._backFaceCulling=!0,this._cullBackFaces=!0,this._blockDirtyMechanism=!1,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this._storeEffectOnSubMeshes=!1,this.animations=null,this.onDisposeObservable=new a,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=2,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new Xs,this._useUBO=!1,this._fillMode=sr.TriangleFillMode,this._cachedDepthWriteState=!1,this._cachedColorWriteState=!1,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=!1,this._eventInfo={},this._callbackPluginEventGeneric=()=>{},this._callbackPluginEventIsReadyForSubMesh=()=>{},this._callbackPluginEventPrepareDefines=()=>{},this._callbackPluginEventPrepareDefinesBeforeAttributes=()=>{},this._callbackPluginEventHardBindForSubMesh=()=>{},this._callbackPluginEventBindForSubMesh=()=>{},this._callbackPluginEventHasRenderTargetTextures=()=>{},this._callbackPluginEventFillRenderTargetTextures=()=>{},this._forceAlphaTest=!1,this._transparencyMode=null,this.name=e;const s=t||x.LastCreatedScene;s&&(this._scene=s,this._dirtyCallbacks={},this._dirtyCallbacks[1]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[2]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[4]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[8]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[16]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[32]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[63]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=e||Ht.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new Tt(this._scene.getEngine(),!1),this._drawWrapper.materialContext=this._materialContext,this._scene.useRightHandedSystem?this.sideOrientation=sr.ClockWiseSideOrientation:this.sideOrientation=sr.CounterClockWiseSideOrientation,this._uniformBuffer=new ai(this._scene.getEngine(),void 0,void 0,e),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,i||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),sr.OnEventObservable.notifyObservers(this,Ys.Created))}toString(e){return"Name: "+this.name}getClassName(){return"Material"}get _isMaterial(){return!0}get isFrozen(){return this.checkReadyOnlyOnce}freeze(){this.markDirty(),this.checkReadyOnlyOnce=!0}unfreeze(){this.markDirty(),this.checkReadyOnlyOnce=!1}isReady(e,t){return!0}isReadyForSubMesh(e,t,i){const s=t.materialDefines;return!!s&&(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=s,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh)}getEffect(){return this._drawWrapper.effect}getScene(){return this._scene}get transparencyMode(){return this._transparencyMode}set transparencyMode(e){this._transparencyMode!==e&&(this._transparencyMode=e,this._forceAlphaTest=e===sr.MATERIAL_ALPHATESTANDBLEND,this._markAllSubMeshesAsTexturesAndMiscDirty())}get _disableAlphaBlending(){return this._transparencyMode===sr.MATERIAL_OPAQUE||this._transparencyMode===sr.MATERIAL_ALPHATEST}needAlphaBlending(){return!this._disableAlphaBlending&&this.alpha<1}needAlphaBlendingForMesh(e){return e.visibility<1||!this._disableAlphaBlending&&(e.hasVertexAlpha||this.needAlphaBlending())}needAlphaTesting(){return!!this._forceAlphaTest}_shouldTurnAlphaTestOn(e){return!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()}getAlphaTestTexture(){return null}markDirty(e=!1){const t=this.getScene().meshes;for(const i of t)if(i.subMeshes)for(const t of i.subMeshes)t.getMaterial()===this&&t.effect&&(t.effect._wasPreviouslyReady=!1,t.effect._wasPreviouslyUsingInstances=null,t.effect._forceRebindOnNextCall=e);e&&this.markAsDirty(sr.AllDirtyFlag)}_preBind(e,t=null){const i=this._scene.getEngine(),s=(null==t?this.sideOrientation:t)===sr.ClockWiseSideOrientation;return i.enableEffect(e||this._getDrawWrapper()),i.setState(this.backFaceCulling,this.zOffset,!1,s,this._scene._mirroredCameraPosition?!this.cullBackFaces:this.cullBackFaces,this.stencil,this.zOffsetUnits),s}bind(e,t){}buildUniformLayout(){const e=this._uniformBuffer;this._eventInfo.ubo=e,this._callbackPluginEventGeneric(Ys.PrepareUniformBuffer,this._eventInfo),e.create(),this._uniformBufferLayoutBuilt=!0}bindForSubMesh(e,t,i){const s=i.effect;s&&(this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),s._forceRebindOnNextCall=!1)}bindOnlyWorldMatrix(e){}bindView(e){this._useUBO?this._needToBindSceneUbo=!0:e.setMatrix("view",this.getScene().getViewMatrix())}bindViewProjection(e){this._useUBO?this._needToBindSceneUbo=!0:(e.setMatrix("viewProjection",this.getScene().getTransformMatrix()),e.setMatrix("projection",this.getScene().getProjectionMatrix()))}bindEyePosition(e,t){this._useUBO?this._needToBindSceneUbo=!0:this._scene.bindEyePosition(e,t)}_afterBind(e,t=null){if(this._scene._cachedMaterial=this,this._needToBindSceneUbo&&t&&(this._needToBindSceneUbo=!1,Hs.BindSceneUniformBuffer(t,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),this._scene._cachedVisibility=e?e.visibility:1,this._onBindObservable&&e&&this._onBindObservable.notifyObservers(e),this.disableDepthWrite){const e=this._scene.getEngine();this._cachedDepthWriteState=e.getDepthWrite(),e.setDepthWrite(!1)}if(this.disableColorWrite){const e=this._scene.getEngine();this._cachedColorWriteState=e.getColorWrite(),e.setColorWrite(!1)}if(0!==this.depthFunction){const e=this._scene.getEngine();this._cachedDepthFunctionState=e.getDepthFunction()||0,e.setDepthFunction(this.depthFunction)}}unbind(){this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),0!==this.depthFunction&&this._scene.getEngine().setDepthFunction(this._cachedDepthFunctionState),this.disableDepthWrite&&this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState),this.disableColorWrite&&this._scene.getEngine().setColorWrite(this._cachedColorWriteState)}getAnimatables(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(Ys.GetAnimatables,this._eventInfo),this._eventInfo.animatables}getActiveTextures(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(Ys.GetActiveTextures,this._eventInfo),this._eventInfo.activeTextures}hasTexture(e){return this._eventInfo.hasTexture=!1,this._eventInfo.texture=e,this._callbackPluginEventGeneric(Ys.HasTexture,this._eventInfo),this._eventInfo.hasTexture}clone(e){return null}_clonePlugins(e,t){const i={};if(this._serializePlugins(i),sr._parsePlugins(i,e,this._scene,t),this.pluginManager)for(const t of this.pluginManager._plugins){const i=e.pluginManager.getPlugin(t.name);t.copyTo(i)}}getBindedMeshes(){if(this.meshMap){const e=[];for(const t in this.meshMap){const i=this.meshMap[t];i&&e.push(i)}return e}return this._scene.meshes.filter((e=>e.material===this))}forceCompilation(e,t,i,s){const r=Object.assign({clipPlane:!1,useInstances:!1},i),n=this.getScene(),o=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;const a=()=>{if(!this._scene||!this._scene.getEngine())return;const i=n.clipPlane;if(r.clipPlane&&(n.clipPlane=new wi(0,0,0,1)),this._storeEffectOnSubMeshes){let i=!0,n=null;if(e.subMeshes){const t=new Cs(0,0,0,0,0,e,void 0,!1,!1);t.materialDefines&&(t.materialDefines._renderId=-1),this.isReadyForSubMesh(e,t,r.useInstances)||(t.effect&&t.effect.getCompilationError()&&t.effect.allFallbacksProcessed()?n=t.effect.getCompilationError():(i=!1,setTimeout(a,16)))}i&&(this.allowShaderHotSwapping=o,n&&s&&s(n),t&&t(this))}else this.isReady()?(this.allowShaderHotSwapping=o,t&&t(this)):setTimeout(a,16);r.clipPlane&&(n.clipPlane=i)};a()}forceCompilationAsync(e,t){return new Promise(((i,s)=>{this.forceCompilation(e,(()=>{i()}),t,(e=>{s(e)}))}))}markAsDirty(e){this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism||(sr._DirtyCallbackArray.length=0,e&sr.TextureDirtyFlag&&sr._DirtyCallbackArray.push(sr._TextureDirtyCallBack),e&sr.LightDirtyFlag&&sr._DirtyCallbackArray.push(sr._LightsDirtyCallBack),e&sr.FresnelDirtyFlag&&sr._DirtyCallbackArray.push(sr._FresnelDirtyCallBack),e&sr.AttributesDirtyFlag&&sr._DirtyCallbackArray.push(sr._AttributeDirtyCallBack),e&sr.MiscDirtyFlag&&sr._DirtyCallbackArray.push(sr._MiscDirtyCallBack),e&sr.PrePassDirtyFlag&&sr._DirtyCallbackArray.push(sr._PrePassDirtyCallBack),sr._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(sr._RunDirtyCallBacks),this.getScene().resetCachedMaterial())}resetDrawCache(){const e=this.getScene().meshes;for(const t of e)if(t.subMeshes)for(const e of t.subMeshes)e.getMaterial()===this&&e.resetDrawCache()}_markAllSubMeshesAsDirty(e){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const t=this.getScene().meshes;for(const i of t)if(i.subMeshes)for(const t of i.subMeshes)if(t.getMaterial(!1)===this)for(const i of t._drawWrappers)i&&i.defines&&i.defines.markAllAsDirty&&this._materialContext===i.materialContext&&e(i.defines)}_markScenePrePassDirty(){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const e=this.getScene().enablePrePassRenderer();e&&e.markAsDirty()}_markAllSubMeshesAsAllDirty(){this._markAllSubMeshesAsDirty(sr._AllDirtyCallBack)}_markAllSubMeshesAsImageProcessingDirty(){this._markAllSubMeshesAsDirty(sr._ImageProcessingDirtyCallBack)}_markAllSubMeshesAsTexturesDirty(){this._markAllSubMeshesAsDirty(sr._TextureDirtyCallBack)}_markAllSubMeshesAsFresnelDirty(){this._markAllSubMeshesAsDirty(sr._FresnelDirtyCallBack)}_markAllSubMeshesAsFresnelAndMiscDirty(){this._markAllSubMeshesAsDirty(sr._FresnelAndMiscDirtyCallBack)}_markAllSubMeshesAsLightsDirty(){this._markAllSubMeshesAsDirty(sr._LightsDirtyCallBack)}_markAllSubMeshesAsAttributesDirty(){this._markAllSubMeshesAsDirty(sr._AttributeDirtyCallBack)}_markAllSubMeshesAsMiscDirty(){this._markAllSubMeshesAsDirty(sr._MiscDirtyCallBack)}_markAllSubMeshesAsPrePassDirty(){this._markAllSubMeshesAsDirty(sr._MiscDirtyCallBack)}_markAllSubMeshesAsTexturesAndMiscDirty(){this._markAllSubMeshesAsDirty(sr._TextureAndMiscDirtyCallBack)}_checkScenePerformancePriority(){if(this._scene.performancePriority!==ki.BackwardCompatible){this.checkReadyOnlyOnce=!0;const e=this._scene.onScenePerformancePriorityChangedObservable.addOnce((()=>{this.checkReadyOnlyOnce=!1}));this.onDisposeObservable.add((()=>{this._scene.onScenePerformancePriorityChangedObservable.remove(e)}))}}setPrePassRenderer(e){return!1}dispose(e,t,i){const s=this.getScene();if(s.stopAnimation(this),s.freeProcessedMaterials(),s.removeMaterial(this),this._eventInfo.forceDisposeTextures=t,this._callbackPluginEventGeneric(Ys.Disposed,this._eventInfo),this._parentContainer){const e=this._parentContainer.materials.indexOf(this);e>-1&&this._parentContainer.materials.splice(e,1),this._parentContainer=null}if(!0!==i)if(this.meshMap)for(const t in this.meshMap){const i=this.meshMap[t];i&&(i.material=null,this.releaseVertexArrayObject(i,e))}else{const t=s.meshes;for(const i of t)i.material!==this||i.sourceMesh||(i.material=null,this.releaseVertexArrayObject(i,e))}this._uniformBuffer.dispose(),e&&this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear(),this._eventInfo&&(this._eventInfo={})}releaseVertexArrayObject(e,t){const i=e.geometry;if(i)if(this._storeEffectOnSubMeshes){if(e.subMeshes)for(const s of e.subMeshes)i._releaseVertexArrayObject(s.effect),t&&s.effect&&s.effect.dispose()}else i._releaseVertexArrayObject(this._drawWrapper.effect)}serialize(){const e=de.Serialize(this);return e.stencil=this.stencil.serialize(),e.uniqueId=this.uniqueId,this._serializePlugins(e),e}_serializePlugins(e){if(e.plugins={},this.pluginManager)for(const t of this.pluginManager._plugins)e.plugins[t.getClassName()]=t.serialize()}static Parse(e,t,i){if(e.customType){if("BABYLON.PBRMaterial"===e.customType&&e.overloadedAlbedo&&(e.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return k.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null}else e.customType="BABYLON.StandardMaterial";const s=Ht.Instantiate(e.customType).Parse(e,t,i);return s._loadedUniqueId=e.uniqueId,s}static _parsePlugins(e,t,i,s){var r;if(e.plugins)for(const n in e.plugins){const o=e.plugins[n];let a=null===(r=t.pluginManager)||void 0===r?void 0:r.getPlugin(o.name);if(!a){const e=Ht.Instantiate("BABYLON."+n);e&&(a=new e(t))}null==a||a.parse(o,i,s)}}}sr.TriangleFillMode=0,sr.WireFrameFillMode=1,sr.PointFillMode=2,sr.PointListDrawMode=3,sr.LineListDrawMode=4,sr.LineLoopDrawMode=5,sr.LineStripDrawMode=6,sr.TriangleStripDrawMode=7,sr.TriangleFanDrawMode=8,sr.ClockWiseSideOrientation=0,sr.CounterClockWiseSideOrientation=1,sr.TextureDirtyFlag=1,sr.LightDirtyFlag=2,sr.FresnelDirtyFlag=4,sr.AttributesDirtyFlag=8,sr.MiscDirtyFlag=16,sr.PrePassDirtyFlag=32,sr.AllDirtyFlag=63,sr.MATERIAL_OPAQUE=0,sr.MATERIAL_ALPHATEST=1,sr.MATERIAL_ALPHABLEND=2,sr.MATERIAL_ALPHATESTANDBLEND=3,sr.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0,sr.MATERIAL_NORMALBLENDMETHOD_RNM=1,sr.OnEventObservable=new a,sr._AllDirtyCallBack=e=>e.markAllAsDirty(),sr._ImageProcessingDirtyCallBack=e=>e.markAsImageProcessingDirty(),sr._TextureDirtyCallBack=e=>e.markAsTexturesDirty(),sr._FresnelDirtyCallBack=e=>e.markAsFresnelDirty(),sr._MiscDirtyCallBack=e=>e.markAsMiscDirty(),sr._PrePassDirtyCallBack=e=>e.markAsPrePassDirty(),sr._LightsDirtyCallBack=e=>e.markAsLightDirty(),sr._AttributeDirtyCallBack=e=>e.markAsAttributesDirty(),sr._FresnelAndMiscDirtyCallBack=e=>{sr._FresnelDirtyCallBack(e),sr._MiscDirtyCallBack(e)},sr._TextureAndMiscDirtyCallBack=e=>{sr._TextureDirtyCallBack(e),sr._MiscDirtyCallBack(e)},sr._DirtyCallbackArray=[],sr._RunDirtyCallBacks=e=>{for(const t of sr._DirtyCallbackArray)t(e)},me([ie()],sr.prototype,"id",void 0),me([ie()],sr.prototype,"uniqueId",void 0),me([ie()],sr.prototype,"name",void 0),me([ie()],sr.prototype,"metadata",void 0),me([ie()],sr.prototype,"checkReadyOnEveryCall",void 0),me([ie()],sr.prototype,"checkReadyOnlyOnce",void 0),me([ie()],sr.prototype,"state",void 0),me([ie("alpha")],sr.prototype,"_alpha",void 0),me([ie("backFaceCulling")],sr.prototype,"_backFaceCulling",void 0),me([ie("cullBackFaces")],sr.prototype,"_cullBackFaces",void 0),me([ie()],sr.prototype,"sideOrientation",void 0),me([ie("alphaMode")],sr.prototype,"_alphaMode",void 0),me([ie()],sr.prototype,"_needDepthPrePass",void 0),me([ie()],sr.prototype,"disableDepthWrite",void 0),me([ie()],sr.prototype,"disableColorWrite",void 0),me([ie()],sr.prototype,"forceDepthWrite",void 0),me([ie()],sr.prototype,"depthFunction",void 0),me([ie()],sr.prototype,"separateCullingPass",void 0),me([ie("fogEnabled")],sr.prototype,"_fogEnabled",void 0),me([ie()],sr.prototype,"pointSize",void 0),me([ie()],sr.prototype,"zOffset",void 0),me([ie()],sr.prototype,"zOffsetUnits",void 0),me([ie()],sr.prototype,"pointsCloud",null),me([ie()],sr.prototype,"fillMode",null),me([ie()],sr.prototype,"useLogarithmicDepth",null),me([ie()],sr.prototype,"transparencyMode",null);class rr extends sr{get subMaterials(){return this._subMaterials}set subMaterials(e){this._subMaterials=e,this._hookArray(e)}getChildren(){return this.subMaterials}constructor(e,t){super(e,t,!0),this._waitingSubMaterialsUniqueIds=[],this.getScene().addMultiMaterial(this),this.subMaterials=[],this._storeEffectOnSubMeshes=!0}_hookArray(e){const t=e.push;e.push=(...i)=>{const s=t.apply(e,i);return this._markAllSubMeshesAsTexturesDirty(),s};const i=e.splice;e.splice=(t,s)=>{const r=i.apply(e,[t,s]);return this._markAllSubMeshesAsTexturesDirty(),r}}getSubMaterial(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]}getActiveTextures(){return super.getActiveTextures().concat(...this.subMaterials.map((e=>e?e.getActiveTextures():[])))}hasTexture(e){var t;if(super.hasTexture(e))return!0;for(let i=0;i<this.subMaterials.length;i++)if(null===(t=this.subMaterials[i])||void 0===t?void 0:t.hasTexture(e))return!0;return!1}getClassName(){return"MultiMaterial"}isReadyForSubMesh(e,t,i){for(let s=0;s<this.subMaterials.length;s++){const r=this.subMaterials[s];if(r){if(r._storeEffectOnSubMeshes){if(!r.isReadyForSubMesh(e,t,i))return!1;continue}if(!r.isReady(e))return!1}}return!0}clone(e,t){const i=new rr(e,this.getScene());for(let s=0;s<this.subMaterials.length;s++){let r=null;const n=this.subMaterials[s];r=t&&n?n.clone(e+"-"+n.name):this.subMaterials[s],i.subMaterials.push(r)}return i}serialize(){const e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,j&&(e.tags=j.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(let t=0;t<this.subMaterials.length;t++){const i=this.subMaterials[t];i?(e.materialsUniqueIds.push(i.uniqueId),e.materials.push(i.id)):(e.materialsUniqueIds.push(null),e.materials.push(null))}return e}dispose(e,t,i){const s=this.getScene();if(!s)return;if(i)for(let i=0;i<this.subMaterials.length;i++){const s=this.subMaterials[i];s&&s.dispose(e,t)}const r=s.multiMaterials.indexOf(this);r>=0&&s.multiMaterials.splice(r,1),super.dispose(e,t)}static ParseMultiMaterial(e,t){const i=new rr(e.name,t);return i.id=e.id,i._loadedUniqueId=e.uniqueId,j&&j.AddTagsTo(i,e.tags),e.materialsUniqueIds?i._waitingSubMaterialsUniqueIds=e.materialsUniqueIds:e.materials.forEach((e=>i.subMaterials.push(t.getLastMaterialById(e)))),i}}m("BABYLON.MultiMaterial",rr);class nr{constructor(e,t){this.distanceOrScreenCoverage=e,this.mesh=t}}class or{}class ar{constructor(){this.visibleInstances={},this.batchCache=new lr,this.batchCacheReplacementModeInFrozenMode=new lr,this.instancesBufferSize=2048}}class lr{constructor(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=[],this.hardwareInstancedRendering=[]}}class hr{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=512,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}}class cr{constructor(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0,this._overrideRenderingFillMode=null}}class ur extends Vs{static _GetDefaultSideOrientation(e){return e||ur.FRONTSIDE}get useLODScreenCoverage(){return this._internalMeshDataInfo._useLODScreenCoverage}set useLODScreenCoverage(e){this._internalMeshDataInfo._useLODScreenCoverage=e,this._sortLODLevels()}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(hi.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(hi.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get onBeforeRenderObservable(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new a),this._internalMeshDataInfo._onBeforeRenderObservable}get onBeforeBindObservable(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new a),this._internalMeshDataInfo._onBeforeBindObservable}get onAfterRenderObservable(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new a),this._internalMeshDataInfo._onAfterRenderObservable}get onBetweenPassObservable(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new a),this._internalMeshDataInfo._onBetweenPassObservable}get onBeforeDrawObservable(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new a),this._internalMeshDataInfo._onBeforeDrawObservable}set onBeforeDraw(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)}get hasInstances(){return this.instances.length>0}get hasThinInstances(){return(this.forcedInstanceCount||this._thinInstanceDataStorage.instancesCount||0)>0}get forcedInstanceCount(){return this._internalMeshDataInfo._forcedInstanceCount}set forcedInstanceCount(e){this._internalMeshDataInfo._forcedInstanceCount=e}get overrideRenderingFillMode(){return this._internalMeshDataInfo._overrideRenderingFillMode}set overrideRenderingFillMode(e){this._internalMeshDataInfo._overrideRenderingFillMode=e}get source(){return this._internalMeshDataInfo._source}get cloneMeshMap(){return this._internalMeshDataInfo.meshMap}get isUnIndexed(){return this._unIndexed}set isUnIndexed(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())}get worldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesData}get previousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesPreviousData}get manualUpdateOfWorldMatrixInstancedBuffer(){return this._instanceDataStorage.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(e){this._instanceDataStorage.manualUpdate=e}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(e){this._instanceDataStorage.previousManualUpdate=e}get forceWorldMatrixInstancedBufferUpdate(){return this._instanceDataStorage.forceMatrixUpdates}set forceWorldMatrixInstancedBufferUpdate(e){this._instanceDataStorage.forceMatrixUpdates=e}constructor(e,t=null,i=null,s=null,r,n=!0){if(super(e,t),this._internalMeshDataInfo=new cr,this.delayLoadState=0,this.instances=[],this._creationDataStorage=null,this._geometry=null,this._instanceDataStorage=new ar,this._thinInstanceDataStorage=new hr,this._shouldGenerateFlatShading=!1,this._originalBuilderSideOrientation=ur.DEFAULTSIDE,this.overrideMaterialSideOrientation=null,this.ignoreCameraMaxZ=!1,t=this.getScene(),this._onBeforeDraw=(e,t,i)=>{e&&i&&(this._uniformBuffer?this.transferToEffect(t):i.bindOnlyWorldMatrix(t))},s){if(s._geometry&&s._geometry.applyToMesh(this),H.DeepCopy(s,this,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo","physicsBody","physicsImpostor"],["_poseMatrix"]),this._internalMeshDataInfo._source=s,t.useClonedMeshMap&&(s._internalMeshDataInfo.meshMap||(s._internalMeshDataInfo.meshMap={}),s._internalMeshDataInfo.meshMap[this.uniqueId]=this),this._originalBuilderSideOrientation=s._originalBuilderSideOrientation,this._creationDataStorage=s._creationDataStorage,s._ranges){const e=s._ranges;for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&e[t]&&this.createAnimationRange(t,e[t].from,e[t].to)}if(s.metadata&&s.metadata.clone?this.metadata=s.metadata.clone():this.metadata=s.metadata,this._internalMetadata=s._internalMetadata,j&&j.HasTags(s)&&j.AddTagsTo(this,j.GetTags(s,!0)),this.setEnabled(s.isEnabled(!1)),this.parent=s.parent,this.setPivotMatrix(s.getPivotMatrix()),this.id=e+"."+s.id,this.material=s.material,!r){const t=s.getDescendants(!0);for(let i=0;i<t.length;i++){const s=t[i];s.clone&&s.clone(e+"."+s.name,this)}}if(s.morphTargetManager&&(this.morphTargetManager=s.morphTargetManager),t.getPhysicsEngine){const e=t.getPhysicsEngine();if(n&&e)if(1===e.getPluginVersion()){const t=e.getImpostorForPhysicsObject(s);t&&(this.physicsImpostor=t.clone(this))}else 2===e.getPluginVersion()&&s.physicsBody&&s.physicsBody.clone(this)}for(let e=0;e<t.particleSystems.length;e++){const i=t.particleSystems[e];i.emitter===s&&i.clone(i.name,this)}this.skeleton=s.skeleton,this.refreshBoundingInfo(!0,!0),this.computeWorldMatrix(!0)}null!==i&&(this.parent=i),this._instanceDataStorage.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this._internalMeshDataInfo._onMeshReadyObserverAdded=e=>{e.unregisterOnNextCall=!0,this.isReady(!0)?this.onMeshReadyObservable.notifyObservers(this):this._internalMeshDataInfo._checkReadinessObserver||(this._internalMeshDataInfo._checkReadinessObserver=this._scene.onBeforeRenderObservable.add((()=>{this.isReady(!0)&&(this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),this._internalMeshDataInfo._checkReadinessObserver=null,this.onMeshReadyObservable.notifyObservers(this))})))},this.onMeshReadyObservable=new a(this._internalMeshDataInfo._onMeshReadyObserverAdded),s&&s.onClonedObservable.notifyObservers(this)}instantiateHierarchy(e=null,t,i){const s=0===this.getTotalVertices()||t&&t.doNotInstantiate&&(!0===t.doNotInstantiate||t.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));s.parent=e||this.parent,s.position=this.position.clone(),s.scaling=this.scaling.clone(),this.rotationQuaternion?s.rotationQuaternion=this.rotationQuaternion.clone():s.rotation=this.rotation.clone(),i&&i(this,s);for(const e of this.getChildTransformNodes(!0))"InstancedMesh"===e.getClassName()&&"Mesh"===s.getClassName()&&e.sourceMesh===this?e.instantiateHierarchy(s,{doNotInstantiate:t&&t.doNotInstantiate||!1,newSourcedMesh:s},i):e.instantiateHierarchy(s,t,i);return s}getClassName(){return"Mesh"}get _isMesh(){return!0}toString(e){let t=super.toString(e);if(t+=", n vertices: "+this.getTotalVertices(),t+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);if(e)if(this._geometry){const e=this.getIndices(),i=this.getVerticesData(hi.PositionKind);i&&e&&(t+=", flat shading: "+(i.length/3===e.length?"YES":"NO"))}else t+=", flat shading: UNKNOWN";return t}_unBindEffect(){super._unBindEffect();for(const e of this.instances)e._unBindEffect()}get hasLODLevels(){return this._internalMeshDataInfo._LODLevels.length>0}getLODLevels(){return this._internalMeshDataInfo._LODLevels}_sortLODLevels(){const e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort(((t,i)=>t.distanceOrScreenCoverage<i.distanceOrScreenCoverage?e:t.distanceOrScreenCoverage>i.distanceOrScreenCoverage?-e:0))}addLODLevel(e,t){if(t&&t._masterMesh)return k.Warn("You cannot use a mesh as LOD level twice"),this;const i=new nr(e,t);return this._internalMeshDataInfo._LODLevels.push(i),t&&(t._masterMesh=this),this._sortLODLevels(),this}getLODLevelAtDistance(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++){const s=t._LODLevels[i];if(s.distanceOrScreenCoverage===e)return s.mesh}return null}removeLODLevel(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++)t._LODLevels[i].mesh===e&&(t._LODLevels.splice(i,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}getLOD(e,t){const i=this._internalMeshDataInfo;if(!i._LODLevels||0===i._LODLevels.length)return this;const s=t||this.getBoundingInfo().boundingSphere,r=e.mode===ps.ORTHOGRAPHIC_CAMERA?e.minZ:s.centerWorld.subtract(e.globalPosition).length();let n=r,o=1;if(i._useLODScreenCoverage){const t=e.screenArea;let i=s.radiusWorld*e.minZ/r;i=i*i*Math.PI,n=i/t,o=-1}if(o*i._LODLevels[i._LODLevels.length-1].distanceOrScreenCoverage>o*n)return this.onLODLevelSelection&&this.onLODLevelSelection(n,this,this),this;for(let e=0;e<i._LODLevels.length;e++){const t=i._LODLevels[e];if(o*t.distanceOrScreenCoverage<o*n){if(t.mesh){if(4===t.mesh.delayLoadState)return t.mesh._checkDelayState(),this;if(2===t.mesh.delayLoadState)return this;t.mesh._preActivate(),t.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(n,this,t.mesh),t.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(n,this,this),this}get geometry(){return this._geometry}getTotalVertices(){return null===this._geometry||void 0===this._geometry?0:this._geometry.getTotalVertices()}getVerticesData(e,t,i,s){var r,n;if(!this._geometry)return null;let o=s||null===(n=null===(r=this._userInstancedBuffersStorage)||void 0===r?void 0:r.vertexBuffers[e])||void 0===n?void 0:n.getFloatData(this.instances.length+1,i||t&&1!==this._geometry.meshes.length);return o||(o=this._geometry.getVerticesData(e,t,i)),o}getVertexBuffer(e,t){var i,s;return this._geometry?null!==(s=t||null===(i=this._userInstancedBuffersStorage)||void 0===i?void 0:i.vertexBuffers[e])&&void 0!==s?s:this._geometry.getVertexBuffer(e):null}isVerticesDataPresent(e,t){var i;return this._geometry?!t&&void 0!==(null===(i=this._userInstancedBuffersStorage)||void 0===i?void 0:i.vertexBuffers[e])||this._geometry.isVerticesDataPresent(e):!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)}isVertexBufferUpdatable(e,t){var i;if(!this._geometry)return!!this._delayInfo&&-1!==this._delayInfo.indexOf(e);if(!t){const t=null===(i=this._userInstancedBuffersStorage)||void 0===i?void 0:i.vertexBuffers[e];if(t)return t.isUpdatable()}return this._geometry.isVertexBufferUpdatable(e)}getVerticesDataKinds(e){if(!this._geometry){const e=[];return this._delayInfo&&this._delayInfo.forEach((function(t){e.push(t)})),e}const t=this._geometry.getVerticesDataKinds();if(!e&&this._userInstancedBuffersStorage)for(const e in this._userInstancedBuffersStorage.vertexBuffers)-1===t.indexOf(e)&&t.push(e);return t}getTotalIndices(){return this._geometry?this._geometry.getTotalIndices():0}getIndices(e,t){return this._geometry?this._geometry.getIndices(e,t):[]}get isBlocked(){return null!==this._masterMesh&&void 0!==this._masterMesh}isReady(e=!1,t=!1){var i,s,r,n,o,a,l;if(2===this.delayLoadState)return!1;if(!super.isReady(e))return!1;if(!this.subMeshes||0===this.subMeshes.length)return!0;if(!e)return!0;const h=this.getEngine(),c=this.getScene(),u=t||h.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();const d=this.material||c.defaultMaterial;if(d)if(d._storeEffectOnSubMeshes)for(const e of this.subMeshes){const t=e.getMaterial();if(t)if(t._storeEffectOnSubMeshes){if(!t.isReadyForSubMesh(this,e,u))return!1}else if(!t.isReady(this,u))return!1}else if(!d.isReady(this,u))return!1;const p=h.currentRenderPassId;for(const e of this.lightSources){const t=e.getShadowGenerators();if(!t)continue;const c=t.values();for(let e=c.next();!0!==e.done;e=c.next()){const t=e.value;if(t&&(!(null===(i=t.getShadowMap())||void 0===i?void 0:i.renderList)||(null===(s=t.getShadowMap())||void 0===s?void 0:s.renderList)&&-1!==(null===(n=null===(r=t.getShadowMap())||void 0===r?void 0:r.renderList)||void 0===n?void 0:n.indexOf(this)))){const e=null!==(o=t.getShadowMap().renderPassIds)&&void 0!==o?o:[h.currentRenderPassId];for(let i=0;i<e.length;++i){h.currentRenderPassId=e[i];for(const e of this.subMeshes)if(!t.isReady(e,u,null!==(l=null===(a=e.getMaterial())||void 0===a?void 0:a.needAlphaBlendingForMesh(this))&&void 0!==l&&l))return h.currentRenderPassId=p,!1}h.currentRenderPassId=p}}}for(const e of this._internalMeshDataInfo._LODLevels)if(e.mesh&&!e.mesh.isReady(u))return!1;return!0}get areNormalsFrozen(){return this._internalMeshDataInfo._areNormalsFrozen}freezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}unfreezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}set overridenInstanceCount(e){this._instanceDataStorage.overridenInstanceCount=e}_preActivate(){const e=this._internalMeshDataInfo,t=this.getScene().getRenderId();return e._preActivateId===t||(e._preActivateId=t,this._instanceDataStorage.visibleInstances=null),this}_preActivateForIntermediateRendering(e){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=e),this}_registerInstanceForRenderId(e,t){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:t,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[t]||(void 0!==this._instanceDataStorage.previousRenderId&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=t,this._instanceDataStorage.visibleInstances[t]=new Array),this._instanceDataStorage.visibleInstances[t].push(e),this}_afterComputeWorldMatrix(){super._afterComputeWorldMatrix(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}_postActivate(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const i=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getPositionData(e,t),i),this}_createGlobalSubMesh(e){const t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){const i=this.getIndices();if(!i)return null;const s=i.length;let r=!1;if(e)r=!0;else for(const e of this.subMeshes){if(e.indexStart+e.indexCount>s){r=!0;break}if(e.verticesStart+e.verticesCount>t){r=!0;break}}if(!r)return this.subMeshes[0]}return this.releaseSubMeshes(),new Cs(0,0,t,0,this.getTotalIndices(),this)}subdivide(e){if(e<1)return;const t=this.getTotalIndices();let i=t/e|0,s=0;for(;i%3!=0;)i++;this.releaseSubMeshes();for(let r=0;r<e&&!(s>=t);r++)Cs.CreateFromIndices(0,s,r===e-1?t-s:i,this,void 0,!1),s+=i;this.refreshBoundingInfo(),this.synchronizeInstances()}setVerticesData(e,t,i=!1,s){if(this._geometry)this._geometry.setVerticesData(e,t,i,s);else{const s=new As;s.set(t,e);const r=this.getScene();new Ps(Ps.RandomId(),r,s,i,this)}return this}removeVerticesData(e){this._geometry&&this._geometry.removeVerticesData(e)}markVerticesDataAsUpdatable(e,t=!0){const i=this.getVertexBuffer(e);i&&i.isUpdatable()!==t&&this.setVerticesData(e,this.getVerticesData(e),t)}setVerticesBuffer(e,t=!0){return this._geometry||(this._geometry=Ps.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,t),this}updateVerticesData(e,t,i,s){return this._geometry?(s?(this.makeGeometryUnique(),this.updateVerticesData(e,t,i,!1)):this._geometry.updateVerticesData(e,t,i),this):this}updateMeshPositions(e,t=!0){const i=this.getVerticesData(hi.PositionKind);if(!i)return this;if(e(i),this.updateVerticesData(hi.PositionKind,i,!1,!1),t){const e=this.getIndices(),t=this.getVerticesData(hi.NormalKind);if(!t)return this;As.ComputeNormals(i,e,t),this.updateVerticesData(hi.NormalKind,t,!1,!1)}return this}makeGeometryUnique(){if(!this._geometry)return this;if(1===this._geometry.meshes.length)return this;const e=this._geometry,t=this._geometry.copy(Ps.RandomId());return e.releaseForMesh(this,!0),t.applyToMesh(this),this}setIndexBuffer(e,t,i){let s=this._geometry;s||(s=new Ps(Ps.RandomId(),this.getScene(),void 0,void 0,this)),s.setIndexBuffer(e,t,i)}setIndices(e,t=null,i=!1){if(this._geometry)this._geometry.setIndices(e,t,i);else{const t=new As;t.indices=e;const s=this.getScene();new Ps(Ps.RandomId(),s,t,i,this)}return this}updateIndices(e,t,i=!1){return this._geometry?(this._geometry.updateIndices(e,t,i),this):this}toLeftHanded(){return this._geometry?(this._geometry.toLeftHanded(),this):this}_bind(e,t,i,s=!0){if(!this._geometry)return this;const r=this.getScene().getEngine();let n;if(this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(t),this._unIndexed)n=null;else switch(this._getRenderingFillMode(i)){case sr.PointFillMode:n=null;break;case sr.WireFrameFillMode:n=e._getLinesIndexBuffer(this.getIndices(),r);break;default:case sr.TriangleFillMode:n=this._geometry.getIndexBuffer()}return s&&this._userInstancedBuffersStorage&&!this.hasThinInstances?this._geometry._bind(t,n,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects):this._geometry._bind(t,n),this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);const s=this.getScene().getEngine();return this._unIndexed||t==sr.PointFillMode?s.drawArraysType(t,e.verticesStart,e.verticesCount,this.forcedInstanceCount||i):t==sr.WireFrameFillMode?s.drawElementsType(t,0,e._linesIndexCount,this.forcedInstanceCount||i):s.drawElementsType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||i),this}registerBeforeRender(e){return this.onBeforeRenderObservable.add(e),this}unregisterBeforeRender(e){return this.onBeforeRenderObservable.removeCallback(e),this}registerAfterRender(e){return this.onAfterRenderObservable.add(e),this}unregisterAfterRender(e){return this.onAfterRenderObservable.removeCallback(e),this}_getInstancesRenderList(e,t=!1){if(this._instanceDataStorage.isFrozen){if(t)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}const i=this.getScene(),s=i._isInIntermediateRendering(),r=s?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,n=this._instanceDataStorage.batchCache;if(n.mustReturn=!1,n.renderSelf[e]=t||!r&&this.isEnabled()&&this.isVisible,n.visibleInstances[e]=null,this._instanceDataStorage.visibleInstances&&!t){const t=this._instanceDataStorage.visibleInstances,r=i.getRenderId(),o=s?t.intermediateDefaultRenderId:t.defaultRenderId;n.visibleInstances[e]=t[r],!n.visibleInstances[e]&&o&&(n.visibleInstances[e]=t[o])}return n.hardwareInstancedRendering[e]=!t&&this._instanceDataStorage.hardwareInstancedRendering&&null!==n.visibleInstances[e]&&void 0!==n.visibleInstances[e],this._instanceDataStorage.previousBatch=n,n}_renderWithInstances(e,t,i,s,r){var n;const o=i.visibleInstances[e._id],a=o?o.length:0,l=this._instanceDataStorage,h=l.instancesBufferSize;let c=l.instancesBuffer,u=l.instancesPreviousBuffer;const d=16*(a+1)*4;for(;l.instancesBufferSize<d;)l.instancesBufferSize*=2;l.instancesData&&h==l.instancesBufferSize||(l.instancesData=new Float32Array(l.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!l.instancesPreviousData||h!=l.instancesBufferSize)&&(l.instancesPreviousData=new Float32Array(l.instancesBufferSize/4));let p=0,_=0;const f=i.renderSelf[e._id],m=!c||h!==l.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!l.instancesPreviousBuffer;if(this._instanceDataStorage.manualUpdate||l.isFrozen&&!m)_=(f?1:0)+a;else{const t=this.getWorldMatrix();if(f&&(this._scene.needsPreviousWorldMatrices&&(l.masterMeshPreviousWorldMatrix?(l.masterMeshPreviousWorldMatrix.copyToArray(l.instancesPreviousData,p),l.masterMeshPreviousWorldMatrix.copyFrom(t)):(l.masterMeshPreviousWorldMatrix=t.clone(),l.masterMeshPreviousWorldMatrix.copyToArray(l.instancesPreviousData,p))),t.copyToArray(l.instancesData,p),p+=16,_++),o){if(ur.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&(null===(n=e.getMaterial())||void 0===n?void 0:n.needAlphaBlendingForMesh(e.getRenderingMesh()))){const e=this._scene.activeCamera.globalPosition;for(let t=0;t<o.length;t++){const i=o[t];i._distanceToCamera=S.Distance(i.getBoundingInfo().boundingSphere.centerWorld,e)}o.sort(((e,t)=>e._distanceToCamera>t._distanceToCamera?-1:e._distanceToCamera<t._distanceToCamera?1:0))}for(let e=0;e<o.length;e++){const t=o[e],i=t.getWorldMatrix();i.copyToArray(l.instancesData,p),this._scene.needsPreviousWorldMatrices&&(t._previousWorldMatrix?(t._previousWorldMatrix.copyToArray(l.instancesPreviousData,p),t._previousWorldMatrix.copyFrom(i)):(t._previousWorldMatrix=i.clone(),t._previousWorldMatrix.copyToArray(l.instancesPreviousData,p))),p+=16,_++}}}return m?(c&&c.dispose(),u&&u.dispose(),c=new li(r,l.instancesData,!0,16,!1,!0),l.instancesBuffer=c,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=c.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=c.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=c.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=c.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(u=new li(r,l.instancesPreviousData,!0,16,!1,!0),l.instancesPreviousBuffer=u,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=u.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=u.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=u.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=u.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):this._instanceDataStorage.isFrozen&&!this._instanceDataStorage.forceMatrixUpdates||(c.updateDirectly(l.instancesData,0,_),!this._scene.needsPreviousWorldMatrices||this._instanceDataStorage.manualUpdate&&!this._instanceDataStorage.previousManualUpdate||u.updateDirectly(l.instancesPreviousData,0,_)),this._processInstancedBuffers(o,f),this.getScene()._activeIndices.addCount(e.indexCount*_,!1),r._currentDrawContext&&(r._currentDrawContext.useInstancing=!0),this._bind(e,s,t),this._draw(e,t,_),!this._scene.needsPreviousWorldMatrices||m||!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.isFrozen&&!this._instanceDataStorage.forceMatrixUpdates||this._instanceDataStorage.previousManualUpdate||u.updateDirectly(l.instancesData,0,_),r.unbindInstanceAttributes(),this}_renderWithThinInstances(e,t,i,s){var r,n;const o=null!==(n=null===(r=this._thinInstanceDataStorage)||void 0===r?void 0:r.instancesCount)&&void 0!==n?n:0;this.getScene()._activeIndices.addCount(e.indexCount*o,!1),s._currentDrawContext&&(s._currentDrawContext.useInstancing=!0),this._bind(e,i,t),this._draw(e,t,o),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,o):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),s.unbindInstanceAttributes()}_processInstancedBuffers(e,t){}_processRendering(e,t,i,s,r,n,o,a){const l=this.getScene(),h=l.getEngine();if(s=this._getRenderingFillMode(s),n&&t.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(t,s,i,h),this;if(n)this._renderWithInstances(t,s,r,i,h);else{h._currentDrawContext&&(h._currentDrawContext.useInstancing=!1);let i=0;r.renderSelf[t._id]&&(o&&o(!1,e.getWorldMatrix(),a),i++,this._draw(t,s,this._instanceDataStorage.overridenInstanceCount));const n=r.visibleInstances[t._id];if(n){const e=n.length;i+=e;for(let i=0;i<e;i++){const e=n[i].getWorldMatrix();o&&o(!0,e,a),this._draw(t,s)}}l._activeIndices.addCount(t.indexCount*i,!1)}return this}_rebuild(e=!1){if(this._instanceDataStorage.instancesBuffer&&(e&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(const t in this._userInstancedBuffersStorage.vertexBuffers){const i=this._userInstancedBuffersStorage.vertexBuffers[t];i&&(e&&i.dispose(),this._userInstancedBuffersStorage.vertexBuffers[t]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,super._rebuild(e)}_freeze(){if(this.subMeshes){for(let e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}_unFreeze(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null}renderWithRenderPassId(e,t,i,s,r=!0){const n=this._scene.getEngine(),o=n.currentRenderPassId;if(void 0!==e&&(n.currentRenderPassId=e),s)(!r||r&&s.isInFrustum(this._scene._frustumPlanes))&&this.render(s,!!t,i);else for(let e=0;e<this.subMeshes.length;e++){const s=this.subMeshes[e];(!r||r&&s.isInFrustum(this._scene._frustumPlanes))&&this.render(s,!!t,i)}return void 0!==e&&(n.currentRenderPassId=o),this}render(e,t,i){var s,r,n,o,a;const l=this.getScene();this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1;const h=null!==(r=null===(s=l.activeCameras)||void 0===s?void 0:s.length)&&void 0!==r?r:0;if((h>1&&l.activeCamera===l.activeCameras[0]||h<=1)&&this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;const c=this._getInstancesRenderList(e._id,!!i);if(c.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const u=l.getEngine();let d=0,p=null;this.ignoreCameraMaxZ&&l.activeCamera&&!l._isInIntermediateRendering()&&(d=l.activeCamera.maxZ,p=l.activeCamera,l.activeCamera.maxZ=0,l.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);const _=e.getRenderingMesh(),f=c.hardwareInstancedRendering[e._id]||_.hasThinInstances||!!this._userInstancedBuffersStorage&&!e.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,m=this._instanceDataStorage,g=e.getMaterial();if(!g)return p&&(p.maxZ=d,l.updateTransformMatrix(!0)),this;if(m.isFrozen&&this._internalMeshDataInfo._effectiveMaterial&&this._internalMeshDataInfo._effectiveMaterial===g){if(g._storeEffectOnSubMeshes&&!(null===(n=e.effect)||void 0===n?void 0:n._wasPreviouslyReady)||!g._storeEffectOnSubMeshes&&!(null===(o=g.getEffect())||void 0===o?void 0:o._wasPreviouslyReady))return p&&(p.maxZ=d,l.updateTransformMatrix(!0)),this}else{if(g._storeEffectOnSubMeshes){if(!g.isReadyForSubMesh(this,e,f))return p&&(p.maxZ=d,l.updateTransformMatrix(!0)),this}else if(!g.isReady(this,f))return p&&(p.maxZ=d,l.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=g}let v;t&&u.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode),v=this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?e._drawWrapper:this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();const x=null!==(a=null==v?void 0:v.effect)&&void 0!==a?a:null;for(const t of l._beforeRenderingMeshStage)t.action(this,e,c,x);if(!v||!x)return p&&(p.maxZ=d,l.updateTransformMatrix(!0)),this;const T=i||this;let E;if(m.isFrozen||!this._internalMeshDataInfo._effectiveMaterial.backFaceCulling&&null===this.overrideMaterialSideOrientation&&!this._internalMeshDataInfo._effectiveMaterial.twoSidedLighting)E=m.sideOrientation;else{const e=T._getWorldMatrixDeterminant();E=this.overrideMaterialSideOrientation,null==E&&(E=this._internalMeshDataInfo._effectiveMaterial.sideOrientation),e<0&&(E=E===sr.ClockWiseSideOrientation?sr.CounterClockWiseSideOrientation:sr.ClockWiseSideOrientation),m.sideOrientation=E}const S=this._internalMeshDataInfo._effectiveMaterial._preBind(v,E);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&u.setDepthWrite(!0);const b=this._internalMeshDataInfo._effectiveMaterial,C=b.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),f||this._bind(e,x,C,!1);const y=T.getWorldMatrix();b._storeEffectOnSubMeshes?b.bindForSubMesh(y,this,e):b.bind(y,this),!b.backFaceCulling&&b.separateCullingPass&&(u.setState(!0,b.zOffset,!1,!S,b.cullBackFaces,b.stencil,b.zOffsetUnits),this._processRendering(this,e,x,C,c,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),u.setState(!0,b.zOffset,!1,S,b.cullBackFaces,b.stencil,b.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,x,C,c,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(const t of l._afterRenderingMeshStage)t.action(this,e,c,x);return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),p&&(p.maxZ=d,l.updateTransformMatrix(!0)),l.performancePriority!==ki.Aggressive||m.isFrozen||this._freeze(),this}cleanMatrixWeights(){this.isVerticesDataPresent(hi.MatricesWeightsKind)&&(this.isVerticesDataPresent(hi.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}_normalizeSkinFourWeights(){const e=this.getVerticesData(hi.MatricesWeightsKind),t=e.length;for(let i=0;i<t;i+=4){const t=e[i]+e[i+1]+e[i+2]+e[i+3];if(0===t)e[i]=1;else{const s=1/t;e[i]*=s,e[i+1]*=s,e[i+2]*=s,e[i+3]*=s}}this.setVerticesData(hi.MatricesWeightsKind,e)}_normalizeSkinWeightsAndExtra(){const e=this.getVerticesData(hi.MatricesWeightsExtraKind),t=this.getVerticesData(hi.MatricesWeightsKind),i=t.length;for(let s=0;s<i;s+=4){let i=t[s]+t[s+1]+t[s+2]+t[s+3];if(i+=e[s]+e[s+1]+e[s+2]+e[s+3],0===i)t[s]=1;else{const r=1/i;t[s]*=r,t[s+1]*=r,t[s+2]*=r,t[s+3]*=r,e[s]*=r,e[s+1]*=r,e[s+2]*=r,e[s+3]*=r}}this.setVerticesData(hi.MatricesWeightsKind,t),this.setVerticesData(hi.MatricesWeightsKind,e)}validateSkinning(){const e=this.getVerticesData(hi.MatricesWeightsExtraKind),t=this.getVerticesData(hi.MatricesWeightsKind);if(null===t||null==this.skeleton)return{skinned:!1,valid:!0,report:"not skinned"};const i=t.length;let s=0,r=0,n=0,o=0;const a=null===e?4:8,l=[];for(let e=0;e<=a;e++)l[e]=0;for(let h=0;h<i;h+=4){let i=t[h],c=i,u=0===c?0:1;for(let r=1;r<a;r++){const n=r<4?t[h+r]:e[h+r-4];n>i&&s++,0!==n&&u++,c+=n,i=n}if(l[u]++,u>n&&(n=u),0===c)r++;else{const i=1/c;let s=0;for(let r=0;r<a;r++)s+=r<4?Math.abs(t[h+r]-t[h+r]*i):Math.abs(e[h+r-4]-e[h+r-4]*i);s>.001&&o++}}const h=this.skeleton.bones.length,c=this.getVerticesData(hi.MatricesIndicesKind),u=this.getVerticesData(hi.MatricesIndicesExtraKind);let d=0;for(let e=0;e<i;e+=4)for(let t=0;t<a;t++){const i=t<4?c[e+t]:u[e+t-4];(i>=h||i<0)&&d++}return{skinned:!0,valid:0===r&&0===o&&0===d,report:"Number of Weights = "+i/4+"\nMaximum influences = "+n+"\nMissing Weights = "+r+"\nNot Sorted = "+s+"\nNot Normalized = "+o+"\nWeightCounts = ["+l+"]\nNumber of bones = "+h+"\nBad Bone Indices = "+d}}_checkDelayState(){const e=this.getScene();return this._geometry?this._geometry.load(e):4===this.delayLoadState&&(this.delayLoadState=2,this._queueLoad(e)),this}_queueLoad(e){e.addPendingData(this);const t=-1!==this.delayLoadingFile.indexOf(".babylonbinarymeshdata");return Ht.LoadFile(this.delayLoadingFile,(t=>{t instanceof ArrayBuffer?this._delayLoadingFunction(t,this):this._delayLoadingFunction(JSON.parse(t),this),this.instances.forEach((e=>{e.refreshBoundingInfo(),e._syncSubMeshes()})),this.delayLoadState=1,e.removePendingData(this)}),(()=>{}),e.offlineProvider,t),this}isInFrustum(e){return 2!==this.delayLoadState&&!!super.isInFrustum(e)&&(this._checkDelayState(),!0)}setMaterialById(e){const t=this.getScene().materials;let i;for(i=t.length-1;i>-1;i--)if(t[i].id===e)return this.material=t[i],this;const s=this.getScene().multiMaterials;for(i=s.length-1;i>-1;i--)if(s[i].id===e)return this.material=s[i],this;return this}getAnimatables(){const e=[];return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}bakeTransformIntoVertices(e){if(!this.isVerticesDataPresent(hi.PositionKind))return this;const t=this.subMeshes.splice(0);this._resetPointsArrayCache();let i=this.getVerticesData(hi.PositionKind);const s=S.Zero();let r;for(r=0;r<i.length;r+=3)S.TransformCoordinatesFromFloatsToRef(i[r],i[r+1],i[r+2],e,s).toArray(i,r);if(this.setVerticesData(hi.PositionKind,i,this.getVertexBuffer(hi.PositionKind).isUpdatable()),this.isVerticesDataPresent(hi.NormalKind)){for(i=this.getVerticesData(hi.NormalKind),r=0;r<i.length;r+=3)S.TransformNormalFromFloatsToRef(i[r],i[r+1],i[r+2],e,s).normalize().toArray(i,r);this.setVerticesData(hi.NormalKind,i,this.getVertexBuffer(hi.NormalKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this}bakeCurrentTransformIntoVertices(e=!0){return this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this}get _positions(){return this._internalAbstractMeshDataInfo._positions?this._internalAbstractMeshDataInfo._positions:this._geometry?this._geometry._positions:null}_resetPointsArrayCache(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}_generatePointsArray(){return!!this._geometry&&this._geometry._generatePointsArray()}clone(e="",t=null,i,s=!0){return new ur(e,this.getScene(),t,this,i,s)}dispose(e,t=!1){this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);const i=this._internalMeshDataInfo;if(i._onBeforeDrawObservable&&i._onBeforeDrawObservable.clear(),i._onBeforeBindObservable&&i._onBeforeBindObservable.clear(),i._onBeforeRenderObservable&&i._onBeforeRenderObservable.clear(),i._onAfterRenderObservable&&i._onAfterRenderObservable.clear(),i._onBetweenPassObservable&&i._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(i.meshMap)for(const e in i.meshMap){const t=i.meshMap[e];t&&(t._internalMeshDataInfo._source=null,i.meshMap[e]=void 0)}i._source&&i._source._internalMeshDataInfo.meshMap&&(i._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{const e=this.getScene().meshes;for(const t of e){const e=t;e._internalMeshDataInfo&&e._internalMeshDataInfo._source&&e._internalMeshDataInfo._source===this&&(e._internalMeshDataInfo._source=null)}}i._source=null,this._instanceDataStorage.visibleInstances={},this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),super.dispose(e,t)}_disposeInstanceSpecificData(){}_disposeThinInstanceSpecificData(){}_invalidateInstanceVertexArrayObject(){}applyDisplacementMap(e,t,i,s,r,n,o=!1){const a=this.getScene();return Ht.LoadImage(e,(e=>{const a=e.width,l=e.height,h=this.getEngine().createCanvas(a,l).getContext("2d");h.drawImage(e,0,0);const c=h.getImageData(0,0,a,l).data;this.applyDisplacementMapFromBuffer(c,a,l,t,i,r,n,o),s&&s(this)}),(()=>{}),a.offlineProvider),this}applyDisplacementMapFromBuffer(e,t,i,s,r,n,o,a=!1){if(!this.isVerticesDataPresent(hi.PositionKind)||!this.isVerticesDataPresent(hi.NormalKind)||!this.isVerticesDataPresent(hi.UVKind))return k.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;const l=this.getVerticesData(hi.PositionKind,!0,!0),h=this.getVerticesData(hi.NormalKind),c=this.getVerticesData(hi.UVKind);let u=S.Zero();const d=S.Zero(),p=E.Zero();n=n||E.Zero(),o=o||new E(1,1);for(let a=0;a<l.length;a+=3){S.FromArrayToRef(l,a,u),S.FromArrayToRef(h,a,d),E.FromArrayToRef(c,a/3*2,p);const _=4*((Math.abs(p.x*o.x+n.x%1)*(t-1)%t|0)+(Math.abs(p.y*o.y+n.y%1)*(i-1)%i|0)*t),f=e[_]/255*.3+e[_+1]/255*.59+e[_+2]/255*.11;d.normalize(),d.scaleInPlace(s+(r-s)*f),u=u.add(d),u.toArray(l,a)}return As.ComputeNormals(l,this.getIndices(),h),a?(this.setVerticesData(hi.PositionKind,l),this.setVerticesData(hi.NormalKind,h),this.setVerticesData(hi.UVKind,c)):(this.updateVerticesData(hi.PositionKind,l),this.updateVerticesData(hi.NormalKind,h)),this}_getFlattenedNormals(e,t){const i=new Float32Array(3*e.length);let s=0;const r=this.overrideMaterialSideOrientation===(this._scene.useRightHandedSystem?1:0);for(let n=0;n<e.length;n+=3){const o=S.FromArray(t,3*e[n]),a=S.FromArray(t,3*e[n+1]),l=S.FromArray(t,3*e[n+2]),h=o.subtract(a),c=l.subtract(a),u=S.Normalize(S.Cross(h,c));r&&u.scaleInPlace(-1);for(let e=0;e<3;e++)i[s++]=u.x,i[s++]=u.y,i[s++]=u.z}return i}_convertToUnIndexedMesh(e=!1){const t=this.getVerticesDataKinds(),i=this.getIndices(),s={},r=(e,t)=>{const s=new Float32Array(i.length*t);let r=0;for(let n=0;n<i.length;n++)for(let o=0;o<t;o++)s[r++]=e[i[n]*t+o];return s},n=this.geometry?this.subMeshes.slice(0):[];for(const e of t)s[e]=this.getVerticesData(e);for(const n of t){const t=this.getVertexBuffer(n),o=t.getStrideSize();if(e&&n===hi.NormalKind){const e=this._getFlattenedNormals(i,s[hi.PositionKind]);this.setVerticesData(hi.NormalKind,e,t.isUpdatable(),o)}else this.setVerticesData(n,r(s[n],o),t.isUpdatable(),o)}if(this.morphTargetManager){for(let t=0;t<this.morphTargetManager.numTargets;t++){const s=this.morphTargetManager.getTarget(t),n=s.getPositions();s.setPositions(r(n,3));const o=s.getNormals();o&&s.setNormals(e?this._getFlattenedNormals(i,n):r(o,3));const a=s.getTangents();a&&s.setTangents(r(a,3));const l=s.getUVs();l&&s.setUVs(r(l,2))}this.morphTargetManager.synchronize()}for(let e=0;e<i.length;e++)i[e]=e;this.setIndices(i),this._unIndexed=!0,this.releaseSubMeshes();for(const e of n)Cs.AddToMesh(e.materialIndex,e.indexStart,e.indexCount,e.indexStart,e.indexCount,this);return this.synchronizeInstances(),this}convertToFlatShadedMesh(){return this._convertToUnIndexedMesh(!0)}convertToUnIndexedMesh(){return this._convertToUnIndexedMesh()}flipFaces(e=!1){const t=As.ExtractFromMesh(this);let i;if(e&&this.isVerticesDataPresent(hi.NormalKind)&&t.normals)for(i=0;i<t.normals.length;i++)t.normals[i]*=-1;if(t.indices){let e;for(i=0;i<t.indices.length;i+=3)e=t.indices[i+1],t.indices[i+1]=t.indices[i+2],t.indices[i+2]=e}return t.applyToMesh(this,this.isVertexBufferUpdatable(hi.PositionKind)),this}increaseVertices(e=1){const t=As.ExtractFromMesh(this),i=t.indices&&!Array.isArray(t.indices)&&Array.from?Array.from(t.indices):t.indices,s=t.positions&&!Array.isArray(t.positions)&&Array.from?Array.from(t.positions):t.positions,r=t.uvs&&!Array.isArray(t.uvs)&&Array.from?Array.from(t.uvs):t.uvs,n=t.normals&&!Array.isArray(t.normals)&&Array.from?Array.from(t.normals):t.normals;if(i&&s){t.indices=i,t.positions=s,r&&(t.uvs=r),n&&(t.normals=n);const o=e+1,a=new Array;for(let e=0;e<o+1;e++)a[e]=new Array;let l,h;const c=new S(0,0,0),u=new S(0,0,0),d=new E(0,0),p=new Array,_=new Array,f=new Array;let m,g,v,x=s.length;r&&(g=r.length),n&&(v=n.length);for(let e=0;e<i.length;e+=3){_[0]=i[e],_[1]=i[e+1],_[2]=i[e+2];for(let e=0;e<3;e++)if(l=_[e],h=_[(e+1)%3],void 0===f[l]&&void 0===f[h]?(f[l]=new Array,f[h]=new Array):(void 0===f[l]&&(f[l]=new Array),void 0===f[h]&&(f[h]=new Array)),void 0===f[l][h]&&void 0===f[h][l]){f[l][h]=[],c.x=(s[3*h]-s[3*l])/o,c.y=(s[3*h+1]-s[3*l+1])/o,c.z=(s[3*h+2]-s[3*l+2])/o,n&&(u.x=(n[3*h]-n[3*l])/o,u.y=(n[3*h+1]-n[3*l+1])/o,u.z=(n[3*h+2]-n[3*l+2])/o),r&&(d.x=(r[2*h]-r[2*l])/o,d.y=(r[2*h+1]-r[2*l+1])/o),f[l][h].push(l);for(let e=1;e<o;e++)f[l][h].push(s.length/3),s[x++]=s[3*l]+e*c.x,s[x++]=s[3*l+1]+e*c.y,s[x++]=s[3*l+2]+e*c.z,n&&(n[v++]=n[3*l]+e*u.x,n[v++]=n[3*l+1]+e*u.y,n[v++]=n[3*l+2]+e*u.z),r&&(r[g++]=r[2*l]+e*d.x,r[g++]=r[2*l+1]+e*d.y);f[l][h].push(h),f[h][l]=new Array,m=f[l][h].length;for(let e=0;e<m;e++)f[h][l][e]=f[l][h][m-1-e]}a[0][0]=i[e],a[1][0]=f[i[e]][i[e+1]][1],a[1][1]=f[i[e]][i[e+2]][1];for(let t=2;t<o;t++){a[t][0]=f[i[e]][i[e+1]][t],a[t][t]=f[i[e]][i[e+2]][t],c.x=(s[3*a[t][t]]-s[3*a[t][0]])/t,c.y=(s[3*a[t][t]+1]-s[3*a[t][0]+1])/t,c.z=(s[3*a[t][t]+2]-s[3*a[t][0]+2])/t,n&&(u.x=(n[3*a[t][t]]-n[3*a[t][0]])/t,u.y=(n[3*a[t][t]+1]-n[3*a[t][0]+1])/t,u.z=(n[3*a[t][t]+2]-n[3*a[t][0]+2])/t),r&&(d.x=(r[2*a[t][t]]-r[2*a[t][0]])/t,d.y=(r[2*a[t][t]+1]-r[2*a[t][0]+1])/t);for(let e=1;e<t;e++)a[t][e]=s.length/3,s[x++]=s[3*a[t][0]]+e*c.x,s[x++]=s[3*a[t][0]+1]+e*c.y,s[x++]=s[3*a[t][0]+2]+e*c.z,n&&(n[v++]=n[3*a[t][0]]+e*u.x,n[v++]=n[3*a[t][0]+1]+e*u.y,n[v++]=n[3*a[t][0]+2]+e*u.z),r&&(r[g++]=r[2*a[t][0]]+e*d.x,r[g++]=r[2*a[t][0]+1]+e*d.y)}a[o]=f[i[e+1]][i[e+2]],p.push(a[0][0],a[1][0],a[1][1]);for(let e=1;e<o;e++){let t;for(t=0;t<e;t++)p.push(a[e][t],a[e+1][t],a[e+1][t+1]),p.push(a[e][t],a[e+1][t+1],a[e][t+1]);p.push(a[e][t],a[e+1][t],a[e+1][t+1])}}t.indices=p,t.applyToMesh(this,this.isVertexBufferUpdatable(hi.PositionKind))}else k.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions")}forceSharedVertices(){const e=As.ExtractFromMesh(this),t=e.uvs,i=e.indices,s=e.positions,r=e.colors,n=e.matricesIndices,o=e.matricesWeights,a=e.matricesIndicesExtra,l=e.matricesWeightsExtra;if(void 0===i||void 0===s||null===i||null===s)k.Warn("VertexData contains empty entries");else{const h=new Array,c=new Array,u=new Array,d=new Array,p=new Array,_=new Array,f=new Array,m=new Array;let g=new Array,v=0;const x={};let T,E;for(let e=0;e<i.length;e+=3){E=[i[e],i[e+1],i[e+2]],g=[];for(let e=0;e<3;e++){g[e]="";for(let t=0;t<3;t++)Math.abs(s[3*E[e]+t])<1e-8&&(s[3*E[e]+t]=0),g[e]+=s[3*E[e]+t]+"|"}if(g[0]!=g[1]&&g[0]!=g[2]&&g[1]!=g[2])for(let e=0;e<3;e++){if(T=x[g[e]],void 0===T){x[g[e]]=v,T=v++;for(let t=0;t<3;t++)h.push(s[3*E[e]+t]);if(null!=r)for(let t=0;t<4;t++)d.push(r[4*E[e]+t]);if(null!=t)for(let i=0;i<2;i++)u.push(t[2*E[e]+i]);if(null!=n)for(let t=0;t<4;t++)p.push(n[4*E[e]+t]);if(null!=o)for(let t=0;t<4;t++)_.push(o[4*E[e]+t]);if(null!=a)for(let t=0;t<4;t++)f.push(a[4*E[e]+t]);if(null!=l)for(let t=0;t<4;t++)m.push(l[4*E[e]+t])}c.push(T)}}const S=new Array;As.ComputeNormals(h,c,S),e.positions=h,e.indices=c,e.normals=S,null!=t&&(e.uvs=u),null!=r&&(e.colors=d),null!=n&&(e.matricesIndices=p),null!=o&&(e.matricesWeights=_),null!=a&&(e.matricesIndicesExtra=f),null!=o&&(e.matricesWeightsExtra=m),e.applyToMesh(this,this.isVertexBufferUpdatable(hi.PositionKind))}}static _instancedMeshFactory(e,t){throw $("InstancedMesh")}static _PhysicsImpostorParser(e,t,i){throw $("PhysicsImpostor")}createInstance(e){return ur._instancedMeshFactory(e,this)}synchronizeInstances(){for(let e=0;e<this.instances.length;e++)this.instances[e]._syncSubMeshes();return this}optimizeIndices(e){const t=this.getIndices(),i=this.getVerticesData(hi.PositionKind);if(!i||!t)return this;const s=[];for(let e=0;e<i.length;e+=3)s.push(S.FromArray(i,e));const r=[];return Xt.SyncAsyncForLoop(s.length,40,(e=>{const t=s.length-1-e,i=s[t];for(let e=0;e<t;++e){const n=s[e];if(i.equals(n)){r[t]=e;break}}}),(()=>{for(let e=0;e<t.length;++e)t[e]=r[t[e]]||t[e];const i=this.subMeshes.slice(0);this.setIndices(t),this.subMeshes=i,e&&e(this)})),this}serialize(e={}){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),j&&j.HasTags(this)&&(e.tags=j.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.checkCollisions=this.checkCollisions,e.isBlocker=this.isBlocker,e.overrideMaterialSideOrientation=this.overrideMaterialSideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;const t=this._geometry;if(t&&this.subMeshes){e.geometryUniqueId=t.uniqueId,e.geometryId=t.id,e.subMeshes=[];for(let t=0;t<this.subMeshes.length;t++){const i=this.subMeshes[t];e.subMeshes.push({materialIndex:i.materialIndex,verticesStart:i.verticesStart,verticesCount:i.verticesCount,indexStart:i.indexStart,indexCount:i.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(fi.NAME_PHYSICSENGINE)){const t=this.getPhysicsImpostor();t&&(e.physicsMass=t.getParam("mass"),e.physicsFriction=t.getParam("friction"),e.physicsRestitution=t.getParam("mass"),e.physicsImpostor=t.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(let t=0;t<this.instances.length;t++){const i=this.instances[t];if(i.doNotSerialize)continue;const s={name:i.name,id:i.id,isEnabled:i.isEnabled(!1),isVisible:i.isVisible,isPickable:i.isPickable,checkCollisions:i.checkCollisions,position:i.position.asArray(),scaling:i.scaling.asArray()};if(i.parent&&i.parent._serializeAsParent(s),i.rotationQuaternion?s.rotationQuaternion=i.rotationQuaternion.asArray():i.rotation&&(s.rotation=i.rotation.asArray()),this.getScene()._getComponent(fi.NAME_PHYSICSENGINE)){const e=i.getPhysicsImpostor();e&&(s.physicsMass=e.getParam("mass"),s.physicsFriction=e.getParam("friction"),s.physicsRestitution=e.getParam("mass"),s.physicsImpostor=e.type)}i.metadata&&(s.metadata=i.metadata),i.actionManager&&(s.actions=i.actionManager.serialize(i.name)),e.instances.push(s),de.AppendSerializedAnimations(i,s),s.ranges=i.serializeAnimationRanges()}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){const t={data:{},sizes:{},strides:{}};for(const e in this._userThinInstanceBuffersStorage.data)t.data[e]=Array.from(this._userThinInstanceBuffersStorage.data[e]),t.sizes[e]=this._userThinInstanceBuffersStorage.sizes[e],t.strides[e]=this._userThinInstanceBuffersStorage.strides[e];e.thinInstances.userThinInstance=t}return de.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name)),e}_syncGeometryWithMorphTargetManager(){if(!this.geometry)return;this._markSubMeshesAsAttributesDirty();const e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices())return k.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),void(this.morphTargetManager=null);if(e.isUsingTextureForTargets)return;for(let t=0;t<e.numInfluencers;t++){const i=e.getActiveTarget(t),s=i.getPositions();if(!s)return void k.Error("Invalid morph target. Target must have positions.");this.geometry.setVerticesData(hi.PositionKind+t,s,!1,3);const r=i.getNormals();r&&this.geometry.setVerticesData(hi.NormalKind+t,r,!1,3);const n=i.getTangents();n&&this.geometry.setVerticesData(hi.TangentKind+t,n,!1,3);const o=i.getUVs();o&&this.geometry.setVerticesData(hi.UVKind+"_"+t,o,!1,2)}}else{let e=0;for(;this.geometry.isVerticesDataPresent(hi.PositionKind+e);)this.geometry.removeVerticesData(hi.PositionKind+e),this.geometry.isVerticesDataPresent(hi.NormalKind+e)&&this.geometry.removeVerticesData(hi.NormalKind+e),this.geometry.isVerticesDataPresent(hi.TangentKind+e)&&this.geometry.removeVerticesData(hi.TangentKind+e),this.geometry.isVerticesDataPresent(hi.UVKind+e)&&this.geometry.removeVerticesData(hi.UVKind+"_"+e),e++}}static Parse(e,t,i){let s;if(s=e.type&&"LinesMesh"===e.type?ur._LinesMeshParser(e,t):e.type&&"GroundMesh"===e.type?ur._GroundMeshParser(e,t):e.type&&"GoldbergMesh"===e.type?ur._GoldbergMeshParser(e,t):e.type&&"GreasedLineMesh"===e.type?ur._GreasedLineMeshParser(e,t):e.type&&"TrailMesh"===e.type?ur._TrailMeshParser(e,t):new ur(e.name,t),s.id=e.id,s._waitingParsedUniqueId=e.uniqueId,j&&j.AddTagsTo(s,e.tags),s.position=S.FromArray(e.position),void 0!==e.metadata&&(s.metadata=e.metadata),e.rotationQuaternion?s.rotationQuaternion=C.FromArray(e.rotationQuaternion):e.rotation&&(s.rotation=S.FromArray(e.rotation)),s.scaling=S.FromArray(e.scaling),e.localMatrix?s.setPreTransformMatrix(y.FromArray(e.localMatrix)):e.pivotMatrix&&s.setPivotMatrix(y.FromArray(e.pivotMatrix)),s.setEnabled(e.isEnabled),s.isVisible=e.isVisible,s.infiniteDistance=e.infiniteDistance,s.showBoundingBox=e.showBoundingBox,s.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,void 0!==e.applyFog&&(s.applyFog=e.applyFog),void 0!==e.pickable&&(s.isPickable=e.pickable),void 0!==e.alphaIndex&&(s.alphaIndex=e.alphaIndex),s.receiveShadows=e.receiveShadows,void 0!==e.billboardMode&&(s.billboardMode=e.billboardMode),void 0!==e.visibility&&(s.visibility=e.visibility),s.checkCollisions=e.checkCollisions,void 0!==e.overrideMaterialSideOrientation&&(s.overrideMaterialSideOrientation=e.overrideMaterialSideOrientation),void 0!==e.isBlocker&&(s.isBlocker=e.isBlocker),s._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(s._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),void 0!==e.parentId&&(s._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),void 0!==e.actions&&(s._waitingData.actions=e.actions),void 0!==e.overlayAlpha&&(s.overlayAlpha=e.overlayAlpha),void 0!==e.overlayColor&&(s.overlayColor=N.FromArray(e.overlayColor)),void 0!==e.renderOverlay&&(s.renderOverlay=e.renderOverlay),s.isUnIndexed=!!e.isUnIndexed,s.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(s.delayLoadState=4,s.delayLoadingFile=i+e.delayLoadingFile,s.buildBoundingInfo(S.FromArray(e.boundingBoxMinimum),S.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(s._binaryInfo=e._binaryInfo),s._delayInfo=[],e.hasUVs&&s._delayInfo.push(hi.UVKind),e.hasUVs2&&s._delayInfo.push(hi.UV2Kind),e.hasUVs3&&s._delayInfo.push(hi.UV3Kind),e.hasUVs4&&s._delayInfo.push(hi.UV4Kind),e.hasUVs5&&s._delayInfo.push(hi.UV5Kind),e.hasUVs6&&s._delayInfo.push(hi.UV6Kind),e.hasColors&&s._delayInfo.push(hi.ColorKind),e.hasMatricesIndices&&s._delayInfo.push(hi.MatricesIndicesKind),e.hasMatricesWeights&&s._delayInfo.push(hi.MatricesWeightsKind),s._delayLoadingFunction=Ps._ImportGeometry,Rs.ForceFullSceneLoadingForIncremental&&s._checkDelayState()):Ps._ImportGeometry(e,s),e.materialUniqueId?s._waitingMaterialId=e.materialUniqueId:e.materialId&&(s._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(s.morphTargetManager=t.getMorphTargetManagerById(e.morphTargetManagerId)),void 0!==e.skeletonId&&null!==e.skeletonId&&(s.skeleton=t.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(s.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(let t=0;t<e.animations.length;t++){const i=e.animations[t],r=g("BABYLON.Animation");r&&s.animations.push(r.Parse(i))}ve.ParseAnimationRanges(s,e,t)}if(e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?s.layerMask=Math.abs(parseInt(e.layerMask)):s.layerMask=268435455,e.physicsImpostor&&ur._PhysicsImpostorParser(t,s,e),e.lodMeshIds&&(s._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(let i=0;i<e.instances.length;i++){const r=e.instances[i],n=s.createInstance(r.name);if(r.id&&(n.id=r.id),j&&(r.tags?j.AddTagsTo(n,r.tags):j.AddTagsTo(n,e.tags)),n.position=S.FromArray(r.position),void 0!==r.metadata&&(n.metadata=r.metadata),void 0!==r.parentId&&(n._waitingParentId=r.parentId),void 0!==r.parentInstanceIndex&&(n._waitingParentInstanceIndex=r.parentInstanceIndex),void 0!==r.isEnabled&&null!==r.isEnabled&&n.setEnabled(r.isEnabled),void 0!==r.isVisible&&null!==r.isVisible&&(n.isVisible=r.isVisible),void 0!==r.isPickable&&null!==r.isPickable&&(n.isPickable=r.isPickable),r.rotationQuaternion?n.rotationQuaternion=C.FromArray(r.rotationQuaternion):r.rotation&&(n.rotation=S.FromArray(r.rotation)),n.scaling=S.FromArray(r.scaling),null!=r.checkCollisions&&null!=r.checkCollisions&&(n.checkCollisions=r.checkCollisions),null!=r.pickable&&null!=r.pickable&&(n.isPickable=r.pickable),null!=r.showBoundingBox&&null!=r.showBoundingBox&&(n.showBoundingBox=r.showBoundingBox),null!=r.showSubMeshesBoundingBox&&null!=r.showSubMeshesBoundingBox&&(n.showSubMeshesBoundingBox=r.showSubMeshesBoundingBox),null!=r.alphaIndex&&null!=r.showSubMeshesBoundingBox&&(n.alphaIndex=r.alphaIndex),r.physicsImpostor&&ur._PhysicsImpostorParser(t,n,r),void 0!==r.actions&&(n._waitingData.actions=r.actions),r.animations){for(let e=0;e<r.animations.length;e++){const t=r.animations[e],i=g("BABYLON.Animation");i&&n.animations.push(i.Parse(t))}ve.ParseAnimationRanges(n,r,t),r.autoAnimate&&t.beginAnimation(n,r.autoAnimateFrom,r.autoAnimateTo,r.autoAnimateLoop,r.autoAnimateSpeed||1)}}if(e.thinInstances){const t=e.thinInstances;if(s.thinInstanceEnablePicking=!!t.enablePicking,t.matrixData?(s.thinInstanceSetBuffer("matrix",new Float32Array(t.matrixData),16,!1),s._thinInstanceDataStorage.matrixBufferSize=t.matrixBufferSize,s._thinInstanceDataStorage.instancesCount=t.instancesCount):s._thinInstanceDataStorage.matrixBufferSize=t.matrixBufferSize,e.thinInstances.userThinInstance){const t=e.thinInstances.userThinInstance;for(const e in t.data)s.thinInstanceSetBuffer(e,new Float32Array(t.data[e]),t.strides[e],!1),s._userThinInstanceBuffersStorage.sizes[e]=t.sizes[e]}}return s}setPositionsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourcePositions){const t=this.getVerticesData(hi.PositionKind);if(!t)return e._sourcePositions;e._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(hi.PositionKind)||this.setVerticesData(hi.PositionKind,t,!0)}return e._sourcePositions}setNormalsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourceNormals){const t=this.getVerticesData(hi.NormalKind);if(!t)return e._sourceNormals;e._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(hi.NormalKind)||this.setVerticesData(hi.NormalKind,t,!0)}return e._sourceNormals}applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(hi.PositionKind))return this;if(!this.isVerticesDataPresent(hi.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(hi.MatricesWeightsKind))return this;const t=this.isVerticesDataPresent(hi.NormalKind),i=this._internalMeshDataInfo;if(!i._sourcePositions){const e=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=e}t&&!i._sourceNormals&&this.setNormalsForCPUSkinning();let s=this.getVerticesData(hi.PositionKind);if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s));let r=this.getVerticesData(hi.NormalKind);if(t){if(!r)return this;r instanceof Float32Array||(r=new Float32Array(r))}const n=this.getVerticesData(hi.MatricesIndicesKind),o=this.getVerticesData(hi.MatricesWeightsKind);if(!o||!n)return this;const a=this.numBoneInfluencers>4,l=a?this.getVerticesData(hi.MatricesIndicesExtraKind):null,h=a?this.getVerticesData(hi.MatricesWeightsExtraKind):null,c=e.getTransformMatrices(this),u=S.Zero(),d=new y,p=new y;let _,f=0;for(let e=0;e<s.length;e+=3,f+=4){let m;for(_=0;_<4;_++)m=o[f+_],m>0&&(y.FromFloat32ArrayToRefScaled(c,Math.floor(16*n[f+_]),m,p),d.addToSelf(p));if(a)for(_=0;_<4;_++)m=h[f+_],m>0&&(y.FromFloat32ArrayToRefScaled(c,Math.floor(16*l[f+_]),m,p),d.addToSelf(p));S.TransformCoordinatesFromFloatsToRef(i._sourcePositions[e],i._sourcePositions[e+1],i._sourcePositions[e+2],d,u),u.toArray(s,e),t&&(S.TransformNormalFromFloatsToRef(i._sourceNormals[e],i._sourceNormals[e+1],i._sourceNormals[e+2],d,u),u.toArray(r,e)),d.reset()}return this.updateVerticesData(hi.PositionKind,s),t&&this.updateVerticesData(hi.NormalKind,r),this}static MinMax(e){let t=null,i=null;return e.forEach((function(e){const s=e.getBoundingInfo().boundingBox;t&&i?(t.minimizeInPlace(s.minimumWorld),i.maximizeInPlace(s.maximumWorld)):(t=s.minimumWorld,i=s.maximumWorld)})),t&&i?{min:t,max:i}:{min:S.Zero(),max:S.Zero()}}static Center(e){const t=e instanceof Array?ur.MinMax(e):e;return S.Center(t.min,t.max)}static MergeMeshes(e,t=!0,i,s,r,n){return cs(ur._MergeMeshesCoroutine(e,t,i,s,r,n,!1))}static MergeMeshesAsync(e,t=!0,i,s,r,n){return us(ur._MergeMeshesCoroutine(e,t,i,s,r,n,!0),function(e=25){let t;return(i,s,r)=>{const n=performance.now();void 0===t||n-t>e?(t=n,setTimeout((()=>{ls(i,s,r)}),0)):ls(i,s,r)}}())}static*_MergeMeshesCoroutine(e,t=!0,i,s,r,n,o){if(0===(e=e.filter(Boolean)).length)return null;let a;if(!i){let t=0;for(a=0;a<e.length;a++)if(t+=e[a].getTotalVertices(),t>=65536)return k.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}n&&(r=!1);const l=new Array,h=new Array,c=new Array,u=e[0].overrideMaterialSideOrientation;for(a=0;a<e.length;a++){const t=e[a];if(t.isAnInstance)return k.Warn("Cannot merge instance meshes."),null;if(u!==t.overrideMaterialSideOrientation)return k.Warn("Cannot merge meshes with different overrideMaterialSideOrientation values."),null;if(r&&c.push(t.getTotalIndices()),n)if(t.material){const e=t.material;if(e instanceof rr){for(let t=0;t<e.subMaterials.length;t++)l.indexOf(e.subMaterials[t])<0&&l.push(e.subMaterials[t]);for(let i=0;i<t.subMeshes.length;i++)h.push(l.indexOf(e.subMaterials[t.subMeshes[i].materialIndex])),c.push(t.subMeshes[i].indexCount)}else{l.indexOf(e)<0&&l.push(e);for(let i=0;i<t.subMeshes.length;i++)h.push(l.indexOf(e)),c.push(t.subMeshes[i].indexCount)}}else for(let e=0;e<t.subMeshes.length;e++)h.push(0),c.push(t.subMeshes[e].indexCount)}const d=e[0],p=e=>{const t=e.computeWorldMatrix(!0);return{vertexData:As.ExtractFromMesh(e,!1,!1),transform:t}},{vertexData:_,transform:f}=p(d);o&&(yield);const m=new Array(e.length-1);for(let t=1;t<e.length;t++)m[t-1]=p(e[t]),o&&(yield);const g=_._mergeCoroutine(f,m,i,o,!t);let v=g.next();for(;!v.done;)o&&(yield),v=g.next();const x=v.value;s||(s=new ur(d.name+"_merged",d.getScene()));const T=x._applyToCoroutine(s,void 0,o);let E=T.next();for(;!E.done;)o&&(yield),E=T.next();if(s.checkCollisions=d.checkCollisions,s.overrideMaterialSideOrientation=d.overrideMaterialSideOrientation,t)for(a=0;a<e.length;a++)e[a].dispose();if(r||n){s.releaseSubMeshes(),a=0;let e=0;for(;a<c.length;)Cs.CreateFromIndices(0,e,c[a],s,void 0,!1),e+=c[a],a++;for(const e of s.subMeshes)e.refreshBoundingInfo();s.computeWorldMatrix(!0)}if(n){const e=new rr(d.name+"_merged",d.getScene());e.subMaterials=l;for(let e=0;e<s.subMeshes.length;e++)s.subMeshes[e].materialIndex=h[e];s.material=e}else s.material=d.material;return s}addInstance(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)}removeInstance(e){const t=e._indexInSourceMeshInstanceArray;if(-1!=t){if(t!==this.instances.length-1){const e=this.instances[this.instances.length-1];this.instances[t]=e,e._indexInSourceMeshInstanceArray=t}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}_shouldConvertRHS(){return this.overrideMaterialSideOrientation===sr.CounterClockWiseSideOrientation}_getRenderingFillMode(e){var t;const i=this.getScene();return i.forcePointsCloud?sr.PointFillMode:i.forceWireframe?sr.WireFrameFillMode:null!==(t=this.overrideRenderingFillMode)&&void 0!==t?t:e}setMaterialByID(e){return this.setMaterialById(e)}static CreateRibbon(e,t,i,s,r,n,o,a,l){throw new Error("Import MeshBuilder to populate this function")}static CreateDisc(e,t,i,s,r,n){throw new Error("Import MeshBuilder to populate this function")}static CreateBox(e,t,i,s,r){throw new Error("Import MeshBuilder to populate this function")}static CreateSphere(e,t,i,s,r,n){throw new Error("Import MeshBuilder to populate this function")}static CreateHemisphere(e,t,i,s){throw new Error("Import MeshBuilder to populate this function")}static CreateCylinder(e,t,i,s,r,n,o,a,l){throw new Error("Import MeshBuilder to populate this function")}static CreateTorus(e,t,i,s,r,n,o){throw new Error("Import MeshBuilder to populate this function")}static CreateTorusKnot(e,t,i,s,r,n,o,a,l,h){throw new Error("Import MeshBuilder to populate this function")}static CreateLines(e,t,i,s,r){throw new Error("Import MeshBuilder to populate this function")}static CreateDashedLines(e,t,i,s,r,n,o,a){throw new Error("Import MeshBuilder to populate this function")}static CreatePolygon(e,t,i,s,r,n,o){throw new Error("Import MeshBuilder to populate this function")}static ExtrudePolygon(e,t,i,s,r,n,o,a){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShape(e,t,i,s,r,n,o,a,l,h){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShapeCustom(e,t,i,s,r,n,o,a,l,h,c,u){throw new Error("Import MeshBuilder to populate this function")}static CreateLathe(e,t,i,s,r,n,o){throw new Error("Import MeshBuilder to populate this function")}static CreatePlane(e,t,i,s,r){throw new Error("Import MeshBuilder to populate this function")}static CreateGround(e,t,i,s,r,n){throw new Error("Import MeshBuilder to populate this function")}static CreateTiledGround(e,t,i,s,r,n,o,a,l){throw new Error("Import MeshBuilder to populate this function")}static CreateGroundFromHeightMap(e,t,i,s,r,n,o,a,l,h,c){throw new Error("Import MeshBuilder to populate this function")}static CreateTube(e,t,i,s,r,n,o,a,l,h){throw new Error("Import MeshBuilder to populate this function")}static CreatePolyhedron(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateIcoSphere(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateDecal(e,t,i,s,r,n){throw new Error("Import MeshBuilder to populate this function")}static CreateCapsule(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static ExtendToGoldberg(e){throw new Error("Import MeshBuilder to populate this function")}}ur.FRONTSIDE=As.FRONTSIDE,ur.BACKSIDE=As.BACKSIDE,ur.DOUBLESIDE=As.DOUBLESIDE,ur.DEFAULTSIDE=As.DEFAULTSIDE,ur.NO_CAP=0,ur.CAP_START=1,ur.CAP_END=2,ur.CAP_ALL=3,ur.NO_FLIP=0,ur.FLIP_TILE=1,ur.ROTATE_TILE=2,ur.FLIP_ROW=3,ur.ROTATE_ROW=4,ur.FLIP_N_ROTATE_TILE=5,ur.FLIP_N_ROTATE_ROW=6,ur.CENTER=0,ur.LEFT=1,ur.RIGHT=2,ur.TOP=3,ur.BOTTOM=4,ur.INSTANCEDMESH_SORT_TRANSPARENT=!1,ur._GroundMeshParser=(e,t)=>{throw $("GroundMesh")},ur._GoldbergMeshParser=(e,t)=>{throw $("GoldbergMesh")},ur._LinesMeshParser=(e,t)=>{throw $("LinesMesh")},ur._GreasedLineMeshParser=(e,t)=>{throw $("GreasedLineMesh")},ur._GreasedLineRibbonMeshParser=(e,t)=>{throw $("GreasedLineRibbonMesh")},ur._TrailMeshParser=(e,t)=>{throw $("TrailMesh")},m("BABYLON.Mesh",ur),ur._instancedMeshFactory=(e,t)=>{const i=new dr(e,t);if(t.instancedBuffers){i.instancedBuffers={};for(const e in t.instancedBuffers)i.instancedBuffers[e]=t.instancedBuffers[e]}return i};class dr extends Vs{constructor(e,t){super(e,t.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,t.addInstance(this),this._sourceMesh=t,this._unIndexed=t._unIndexed,this.position.copyFrom(t.position),this.rotation.copyFrom(t.rotation),this.scaling.copyFrom(t.scaling),t.rotationQuaternion&&(this.rotationQuaternion=t.rotationQuaternion.clone()),this.animations=t.animations.slice();for(const e of t.getAnimationRanges())null!=e&&this.createAnimationRange(e.name,e.from,e.to);this.infiniteDistance=t.infiniteDistance,this.setPivotMatrix(t.getPivotMatrix()),this.refreshBoundingInfo(!0,!0),this._syncSubMeshes()}getClassName(){return"InstancedMesh"}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}set receiveShadows(e){var t;(null===(t=this._sourceMesh)||void 0===t?void 0:t.receiveShadows)!==e&&Ht.Warn("Setting receiveShadows on an instanced mesh has no effect")}get material(){return this._sourceMesh.material}set material(e){var t;(null===(t=this._sourceMesh)||void 0===t?void 0:t.material)!==e&&Ht.Warn("Setting material on an instanced mesh has no effect")}get visibility(){return this._sourceMesh.visibility}set visibility(e){var t;(null===(t=this._sourceMesh)||void 0===t?void 0:t.visibility)!==e&&Ht.Warn("Setting visibility on an instanced mesh has no effect")}get skeleton(){return this._sourceMesh.skeleton}set skeleton(e){var t;(null===(t=this._sourceMesh)||void 0===t?void 0:t.skeleton)!==e&&Ht.Warn("Setting skeleton on an instanced mesh has no effect")}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(e){this._sourceMesh&&e!==this._sourceMesh.renderingGroupId&&k.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}createInstance(e){return this._sourceMesh.createInstance(e)}isReady(e=!1){return this._sourceMesh.isReady(e,!0)}getVerticesData(e,t,i){return this._sourceMesh.getVerticesData(e,t,i)}setVerticesData(e,t,i,s){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,t,i,s),this.sourceMesh}updateVerticesData(e,t,i,s){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,t,i,s),this.sourceMesh}setIndices(e,t=null){return this.sourceMesh&&this.sourceMesh.setIndices(e,t),this.sourceMesh}isVerticesDataPresent(e){return this._sourceMesh.isVerticesDataPresent(e)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const i=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getPositionData(e,t),i),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(e,t){if(super._activate(e,t),this._sourceMesh.subMeshes||k.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),t){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}getWorldMatrix(){if(this._currentLOD&&this._currentLOD.billboardMode!==ws.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new y);const e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,R.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(R.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(e){if(!e)return this;const t=this.sourceMesh.getLODLevels();if(t&&0!==t.length){const t=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,t.boundingSphere)}else this._currentLOD=this.sourceMesh;return this._currentLOD}_preActivateForIntermediateRendering(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(e,t=null,i,s){const r=(s||this._sourceMesh).createInstance(e);if(H.DeepCopy(this,r,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo"],[]),this.refreshBoundingInfo(),t&&(r.parent=t),!i)for(let e=0;e<this.getScene().meshes.length;e++){const t=this.getScene().meshes[e];t.parent===this&&t.clone(t.name,r)}return r.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(r),r}dispose(e,t=!1){this._sourceMesh.removeInstance(this),super.dispose(e,t)}_serializeAsParent(e){super._serializeAsParent(e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray}instantiateHierarchy(e=null,t,i){const s=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0,t&&t.newSourcedMesh);s&&i&&i(this,s);for(const e of this.getChildTransformNodes(!0))e.instantiateHierarchy(s,t,i);return s}}ur.prototype.registerInstancedBuffer=function(e,t){var i,s;if(null===(s=null===(i=this._userInstancedBuffersStorage)||void 0===i?void 0:i.vertexBuffers[e])||void 0===s||s.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(const e of this.instances)e.instancedBuffers={}}this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this.instancedBuffers[e]=null,this._userInstancedBuffersStorage.strides[e]=t,this._userInstancedBuffersStorage.sizes[e]=32*t,this._userInstancedBuffersStorage.data[e]=new Float32Array(this._userInstancedBuffersStorage.sizes[e]),this._userInstancedBuffersStorage.vertexBuffers[e]=new hi(this.getEngine(),this._userInstancedBuffersStorage.data[e],e,!0,!1,t,!0);for(const t of this.instances)t.instancedBuffers[e]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()},ur.prototype._processInstancedBuffers=function(e,t){const i=e?e.length:0;for(const s in this.instancedBuffers){let r=this._userInstancedBuffersStorage.sizes[s];const n=this._userInstancedBuffersStorage.strides[s],o=(i+1)*n;for(;r<o;)r*=2;this._userInstancedBuffersStorage.data[s].length!=r&&(this._userInstancedBuffersStorage.data[s]=new Float32Array(r),this._userInstancedBuffersStorage.sizes[s]=r,this._userInstancedBuffersStorage.vertexBuffers[s]&&(this._userInstancedBuffersStorage.vertexBuffers[s].dispose(),this._userInstancedBuffersStorage.vertexBuffers[s]=null));const a=this._userInstancedBuffersStorage.data[s];let l=0;if(t){const e=this.instancedBuffers[s];e.toArray?e.toArray(a,l):e.copyToArray?e.copyToArray(a,l):a[l]=e,l+=n}for(let t=0;t<i;t++){const i=e[t].instancedBuffers[s];i.toArray?i.toArray(a,l):i.copyToArray?i.copyToArray(a,l):a[l]=i,l+=n}this._userInstancedBuffersStorage.vertexBuffers[s]?this._userInstancedBuffersStorage.vertexBuffers[s].updateDirectly(a,0):(this._userInstancedBuffersStorage.vertexBuffers[s]=new hi(this.getEngine(),this._userInstancedBuffersStorage.data[s],s,!0,!1,n,!0),this._invalidateInstanceVertexArrayObject())}},ur.prototype._invalidateInstanceVertexArrayObject=function(){if(this._userInstancedBuffersStorage&&void 0!==this._userInstancedBuffersStorage.vertexArrayObjects){for(const e in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[e]);this._userInstancedBuffersStorage.vertexArrayObjects={}}},ur.prototype._disposeInstanceSpecificData=function(){for(this._instanceDataStorage.instancesBuffer&&(this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(const e in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[e]&&this._userInstancedBuffersStorage.vertexBuffers[e].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};class pr extends ve{get range(){return this._range}set range(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)}get intensityMode(){return this._intensityMode}set intensityMode(e){this._intensityMode=e,this._computePhotometricScale()}get radius(){return this._radius}set radius(e){this._radius=e,this._computePhotometricScale()}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())}get includedOnlyMeshes(){return this._includedOnlyMeshes}set includedOnlyMeshes(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)}get excludedMeshes(){return this._excludedMeshes}set excludedMeshes(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)}get excludeWithLayerMask(){return this._excludeWithLayerMask}set excludeWithLayerMask(e){this._excludeWithLayerMask=e,this._resyncMeshes()}get includeOnlyWithLayerMask(){return this._includeOnlyWithLayerMask}set includeOnlyWithLayerMask(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()}get lightmapMode(){return this._lightmapMode}set lightmapMode(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())}constructor(e,t){super(e,t),this.diffuse=new N(1,1,1),this.specular=new N(1,1,1),this.falloffType=pr.FALLOFF_DEFAULT,this.intensity=1,this._range=Number.MAX_VALUE,this._inverseSquaredRange=0,this._photometricScale=1,this._intensityMode=pr.INTENSITYMODE_AUTOMATIC,this._radius=1e-5,this.renderPriority=0,this._shadowEnabled=!0,this._excludeWithLayerMask=0,this._includeOnlyWithLayerMask=0,this._lightmapMode=0,this._shadowGenerators=null,this._excludedMeshesIds=new Array,this._includedOnlyMeshesIds=new Array,this._isLight=!0,this.getScene().addLight(this),this._uniformBuffer=new ai(this.getScene().getEngine(),void 0,void 0,e),this._buildUniformLayout(),this.includedOnlyMeshes=[],this.excludedMeshes=[],this._resyncMeshes()}transferTexturesToEffect(e,t){return this}_bindLight(e,t,i,s,r=!0){var n;const o=e.toString();let a=!1;if(this._uniformBuffer.bindToEffect(i,"Light"+o),this._renderId!==t.getRenderId()||this._lastUseSpecular!==s||!this._uniformBuffer.useUbo){this._renderId=t.getRenderId(),this._lastUseSpecular=s;const e=this.getScaledIntensity();this.transferToEffect(i,o),this.diffuse.scaleToRef(e,w.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",w.Color3[0],this.range,o),s&&(this.specular.scaleToRef(e,w.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",w.Color3[1],this.radius,o)),a=!0}if(this.transferTexturesToEffect(i,o),t.shadowsEnabled&&this.shadowEnabled&&r){const e=null!==(n=this.getShadowGenerator(t.activeCamera))&&void 0!==n?n:this.getShadowGenerator();e&&(e.bindShadowLight(o,i),a=!0)}a?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()}getClassName(){return"Light"}toString(e){let t="Name: "+this.name;if(t+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}_syncParentEnabledState(){super._syncParentEnabledState(),this.isDisposed()||this._resyncMeshes()}setEnabled(e){super.setEnabled(e),this._resyncMeshes()}getShadowGenerator(e=null){var t;return null===this._shadowGenerators?null:null!==(t=this._shadowGenerators.get(e))&&void 0!==t?t:null}getShadowGenerators(){return this._shadowGenerators}getAbsolutePosition(){return S.Zero()}canAffectMesh(e){return!(e&&(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&-1===this.includedOnlyMeshes.indexOf(e)||this.excludedMeshes&&this.excludedMeshes.length>0&&-1!==this.excludedMeshes.indexOf(e)||!(0===this.includeOnlyWithLayerMask||this.includeOnlyWithLayerMask&e.layerMask)||0!==this.excludeWithLayerMask&&this.excludeWithLayerMask&e.layerMask))}dispose(e,t=!1){if(this._shadowGenerators){const e=this._shadowGenerators.values();for(let t=e.next();!0!==t.done;t=e.next())t.value.dispose();this._shadowGenerators=null}if(this.getScene().stopAnimation(this),this._parentContainer){const e=this._parentContainer.lights.indexOf(this);e>-1&&this._parentContainer.lights.splice(e,1),this._parentContainer=null}for(const e of this.getScene().meshes)e._removeLightSource(this,!0);this._uniformBuffer.dispose(),this.getScene().removeLight(this),super.dispose(e,t)}getTypeID(){return 0}getScaledIntensity(){return this._photometricScale*this.intensity}clone(e,t=null){const i=pr.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!i)return null;const s=de.Clone(i,this);return e&&(s.name=e),t&&(s.parent=t),s.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(s),s}serialize(){const e=de.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0&&(e.excludedMeshesIds=[],this.excludedMeshes.forEach((t=>{e.excludedMeshesIds.push(t.id)}))),this.includedOnlyMeshes.length>0&&(e.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach((t=>{e.includedOnlyMeshesIds.push(t.id)}))),de.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}static GetConstructorFromName(e,t,i){return ve.Construct("Light_Type_"+e,t,i)||null}static Parse(e,t){const i=pr.GetConstructorFromName(e.type,e.name,t);if(!i)return null;const s=de.Parse(i,e,t);if(e.excludedMeshesIds&&(s._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(s._includedOnlyMeshesIds=e.includedOnlyMeshesIds),void 0!==e.parentId&&(s._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),void 0!==e.falloffType&&(s.falloffType=e.falloffType),void 0!==e.lightmapMode&&(s.lightmapMode=e.lightmapMode),e.animations){for(let t=0;t<e.animations.length;t++){const i=e.animations[t],r=g("BABYLON.Animation");r&&s.animations.push(r.Parse(i))}ve.ParseAnimationRanges(s,e,t)}return e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),void 0!==e.isEnabled&&s.setEnabled(e.isEnabled),s}_hookArrayForExcluded(e){const t=e.push;e.push=(...i)=>{const s=t.apply(e,i);for(const e of i)e._resyncLightSource(this);return s};const i=e.splice;e.splice=(t,s)=>{const r=i.apply(e,[t,s]);for(const e of r)e._resyncLightSource(this);return r};for(const t of e)t._resyncLightSource(this)}_hookArrayForIncludedOnly(e){const t=e.push;e.push=(...i)=>{const s=t.apply(e,i);return this._resyncMeshes(),s};const i=e.splice;e.splice=(t,s)=>{const r=i.apply(e,[t,s]);return this._resyncMeshes(),r},this._resyncMeshes()}_resyncMeshes(){for(const e of this.getScene().meshes)e._resyncLightSource(this)}_markMeshesAsLightDirty(){for(const e of this.getScene().meshes)-1!==e.lightSources.indexOf(this)&&e._markSubMeshesAsLightDirty()}_computePhotometricScale(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()}_getPhotometricScale(){let e=0;const t=this.getTypeID();let i=this.intensityMode;switch(i===pr.INTENSITYMODE_AUTOMATIC&&(i=t===pr.LIGHTTYPEID_DIRECTIONALLIGHT?pr.INTENSITYMODE_ILLUMINANCE:pr.INTENSITYMODE_LUMINOUSINTENSITY),t){case pr.LIGHTTYPEID_POINTLIGHT:case pr.LIGHTTYPEID_SPOTLIGHT:switch(i){case pr.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case pr.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case pr.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius}break;case pr.LIGHTTYPEID_DIRECTIONALLIGHT:switch(i){case pr.INTENSITYMODE_ILLUMINANCE:e=1;break;case pr.INTENSITYMODE_LUMINANCE:{let t=this.radius;t=Math.max(t,.001),e=2*Math.PI*(1-Math.cos(t));break}}break;case pr.LIGHTTYPEID_HEMISPHERICLIGHT:e=1}return e}_reorderLightsInScene(){const e=this.getScene();0!=this._renderPriority&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()}}pr.FALLOFF_DEFAULT=Ui.FALLOFF_DEFAULT,pr.FALLOFF_PHYSICAL=Ui.FALLOFF_PHYSICAL,pr.FALLOFF_GLTF=Ui.FALLOFF_GLTF,pr.FALLOFF_STANDARD=Ui.FALLOFF_STANDARD,pr.LIGHTMAP_DEFAULT=Ui.LIGHTMAP_DEFAULT,pr.LIGHTMAP_SPECULAR=Ui.LIGHTMAP_SPECULAR,pr.LIGHTMAP_SHADOWSONLY=Ui.LIGHTMAP_SHADOWSONLY,pr.INTENSITYMODE_AUTOMATIC=Ui.INTENSITYMODE_AUTOMATIC,pr.INTENSITYMODE_LUMINOUSPOWER=Ui.INTENSITYMODE_LUMINOUSPOWER,pr.INTENSITYMODE_LUMINOUSINTENSITY=Ui.INTENSITYMODE_LUMINOUSINTENSITY,pr.INTENSITYMODE_ILLUMINANCE=Ui.INTENSITYMODE_ILLUMINANCE,pr.INTENSITYMODE_LUMINANCE=Ui.INTENSITYMODE_LUMINANCE,pr.LIGHTTYPEID_POINTLIGHT=Ui.LIGHTTYPEID_POINTLIGHT,pr.LIGHTTYPEID_DIRECTIONALLIGHT=Ui.LIGHTTYPEID_DIRECTIONALLIGHT,pr.LIGHTTYPEID_SPOTLIGHT=Ui.LIGHTTYPEID_SPOTLIGHT,pr.LIGHTTYPEID_HEMISPHERICLIGHT=Ui.LIGHTTYPEID_HEMISPHERICLIGHT,me([re()],pr.prototype,"diffuse",void 0),me([re()],pr.prototype,"specular",void 0),me([ie()],pr.prototype,"falloffType",void 0),me([ie()],pr.prototype,"intensity",void 0),me([ie()],pr.prototype,"range",null),me([ie()],pr.prototype,"intensityMode",null),me([ie()],pr.prototype,"radius",null),me([ie()],pr.prototype,"_renderPriority",void 0),me([te("_reorderLightsInScene")],pr.prototype,"renderPriority",void 0),me([ie("shadowEnabled")],pr.prototype,"_shadowEnabled",void 0),me([ie("excludeWithLayerMask")],pr.prototype,"_excludeWithLayerMask",void 0),me([ie("includeOnlyWithLayerMask")],pr.prototype,"_includeOnlyWithLayerMask",void 0),me([ie("lightmapMode")],pr.prototype,"_lightmapMode",void 0);class _r extends s{}class fr{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}dispose(){this.rootNodes.slice(0).forEach((e=>{e.dispose()})),this.rootNodes.length=0,this.skeletons.slice(0).forEach((e=>{e.dispose()})),this.skeletons.length=0,this.animationGroups.slice(0).forEach((e=>{e.dispose()})),this.animationGroups.length=0}}class mr extends s{constructor(e){super(),this._wasAddedToScene=!1,(e=e||x.LastCreatedScene)&&(this.scene=e,this.sounds=[],this.effectLayers=[],this.layers=[],this.lensFlareSystems=[],this.proceduralTextures=[],this.reflectionProbes=[],e.onDisposeObservable.add((()=>{this._wasAddedToScene||this.dispose()})),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add((()=>{for(const e of this.geometries)e._rebuild();for(const e of this.meshes)e._rebuild();for(const e of this.particleSystems)e.rebuild();for(const e of this.textures)e._rebuild()})))}_topologicalSort(e){const t=new Map;for(const i of e)t.set(i.uniqueId,i);const i={dependsOn:new Map,dependedBy:new Map};for(const t of e){const e=t.uniqueId;i.dependsOn.set(e,new Set),i.dependedBy.set(e,new Set)}for(const s of e){const e=s.uniqueId,r=i.dependsOn.get(e);if(s instanceof dr){const n=s.sourceMesh;t.has(n.uniqueId)&&(r.add(n.uniqueId),i.dependedBy.get(n.uniqueId).add(e))}const n=i.dependedBy.get(e);for(const r of s.getDescendants()){const s=r.uniqueId;t.has(s)&&(n.add(s),i.dependsOn.get(s).add(e))}}const s=[],r=[];for(const s of e){const e=s.uniqueId;0===i.dependsOn.get(e).size&&(r.push(s),t.delete(e))}const n=r;for(;n.length>0;){const e=n.shift();s.push(e);const r=i.dependedBy.get(e.uniqueId);for(const s of Array.from(r.values())){const r=i.dependsOn.get(s);r.delete(e.uniqueId),0===r.size&&t.get(s)&&(n.push(t.get(s)),t.delete(s))}}return t.size>0&&(console.error("SceneSerializer._topologicalSort: There were unvisited nodes:"),t.forEach((e=>console.error(e.name)))),s}_addNodeAndDescendantsToList(e,t,i,s){if(i&&(!s||s(i))&&!t.has(i.uniqueId)){e.push(i),t.add(i.uniqueId);for(const r of i.getDescendants(!0))this._addNodeAndDescendantsToList(e,t,r,s)}}_isNodeInContainer(e){return e instanceof ur&&-1!==this.meshes.indexOf(e)||e instanceof ws&&-1!==this.transformNodes.indexOf(e)||e instanceof pr&&-1!==this.lights.indexOf(e)||e instanceof ps&&-1!==this.cameras.indexOf(e)}_isValidHierarchy(){for(const e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return k.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return k.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return k.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return k.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;return!0}instantiateModelsToScene(e,t=!1,i){this._isValidHierarchy()||Ht.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");const s={},r={},n=new fr,o=[],a=[],l=Object.assign({doNotInstantiate:!0},i),h=[],c=new Set;for(const e of this.transformNodes)null===e.parent&&this._addNodeAndDescendantsToList(h,c,e,l.predicate);for(const e of this.meshes)null===e.parent&&this._addNodeAndDescendantsToList(h,c,e,l.predicate);const u=this._topologicalSort(h),d=(i,o)=>{if(((t,i)=>{if(s[t.uniqueId]=i.uniqueId,r[i.uniqueId]=i,e&&(i.name=e(t.name)),i instanceof ur){const e=i;if(e.morphTargetManager){const i=t.morphTargetManager;e.morphTargetManager=i.clone();for(let t=0;t<i.numTargets;t++){const n=i.getTarget(t),o=e.morphTargetManager.getTarget(t);s[n.uniqueId]=o.uniqueId,r[o.uniqueId]=o}}}})(i,o),i.parent){const e=s[i.parent.uniqueId],t=r[e];o.parent=t||i.parent}if(o.position&&i.position&&o.position.copyFrom(i.position),o.rotationQuaternion&&i.rotationQuaternion&&o.rotationQuaternion.copyFrom(i.rotationQuaternion),o.rotation&&i.rotation&&o.rotation.copyFrom(i.rotation),o.scaling&&i.scaling&&o.scaling.copyFrom(i.scaling),o.material){const n=o;if(n.material)if(t){const t=i.material;if(-1===a.indexOf(t)){let i=t.clone(e?e(t.name):"Clone of "+t.name);if(a.push(t),s[t.uniqueId]=i.uniqueId,r[i.uniqueId]=i,"MultiMaterial"===t.getClassName()){const n=t;for(const t of n.subMaterials)t&&(i=t.clone(e?e(t.name):"Clone of "+t.name),a.push(t),s[t.uniqueId]=i.uniqueId,r[i.uniqueId]=i);n.subMaterials=n.subMaterials.map((e=>e&&r[s[e.uniqueId]]))}}"InstancedMesh"!==n.getClassName()&&(n.material=r[s[t.uniqueId]])}else"MultiMaterial"===n.material.getClassName()?-1===this.scene.multiMaterials.indexOf(n.material)&&this.scene.addMultiMaterial(n.material):-1===this.scene.materials.indexOf(n.material)&&this.scene.addMaterial(n.material)}null===o.parent&&n.rootNodes.push(o)};return u.forEach((e=>{if("InstancedMesh"===e.getClassName()){const t=e,i=t.sourceMesh,n=s[i.uniqueId],o=("number"==typeof n?r[n]:i).createInstance(t.name);d(t,o)}else{let t=!0;"TransformNode"===e.getClassName()||"Node"===e.getClassName()||e.skeleton||!e.getTotalVertices||0===e.getTotalVertices()?t=!1:l.doNotInstantiate&&(t="function"==typeof l.doNotInstantiate?!l.doNotInstantiate(e):!l.doNotInstantiate);const i=t?e.createInstance(`instance of ${e.name}`):e.clone(`Clone of ${e.name}`,null,!0);if(!i)throw new Error(`Could not clone or instantiate node on Asset Container ${e.name}`);d(e,i)}})),this.skeletons.forEach((t=>{if(l.predicate&&!l.predicate(t))return;const i=t.clone(e?e(t.name):"Clone of "+t.name);for(const e of this.meshes)if(e.skeleton===t&&!e.isAnInstance){const t=r[s[e.uniqueId]];if(!t||t.isAnInstance)continue;if(t.skeleton=i,-1!==o.indexOf(i))continue;o.push(i);for(const e of i.bones)e._linkedTransformNode&&(e._linkedTransformNode=r[s[e._linkedTransformNode.uniqueId]])}n.skeletons.push(i)})),this.animationGroups.forEach((t=>{if(l.predicate&&!l.predicate(t))return;const i=t.clone(e?e(t.name):"Clone of "+t.name,(e=>r[s[e.uniqueId]]||e));n.animationGroups.push(i)})),n}addAllToScene(){if(!this._wasAddedToScene){this._isValidHierarchy()||Ht.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(const e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){const t=[];this.cameras.forEach((i=>{e&&!e(i)||(this.scene.addCamera(i),t.push(i))})),this.lights.forEach((i=>{e&&!e(i)||(this.scene.addLight(i),t.push(i))})),this.meshes.forEach((i=>{e&&!e(i)||(this.scene.addMesh(i),t.push(i))})),this.skeletons.forEach((t=>{e&&!e(t)||this.scene.addSkeleton(t)})),this.animations.forEach((t=>{e&&!e(t)||this.scene.addAnimation(t)})),this.animationGroups.forEach((t=>{e&&!e(t)||this.scene.addAnimationGroup(t)})),this.multiMaterials.forEach((t=>{e&&!e(t)||this.scene.addMultiMaterial(t)})),this.materials.forEach((t=>{e&&!e(t)||this.scene.addMaterial(t)})),this.morphTargetManagers.forEach((t=>{e&&!e(t)||this.scene.addMorphTargetManager(t)})),this.geometries.forEach((t=>{e&&!e(t)||this.scene.addGeometry(t)})),this.transformNodes.forEach((i=>{e&&!e(i)||(this.scene.addTransformNode(i),t.push(i))})),this.actionManagers.forEach((t=>{e&&!e(t)||this.scene.addActionManager(t)})),this.textures.forEach((t=>{e&&!e(t)||this.scene.addTexture(t)})),this.reflectionProbes.forEach((t=>{e&&!e(t)||this.scene.addReflectionProbe(t)}));for(const e of t)e.parent&&-1===this.scene.getNodes().indexOf(e.parent)&&(e.setParent?e.setParent(null):e.parent=null)}removeAllFromScene(){this._isValidHierarchy()||Ht.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this)}removeFromScene(e=null){this.cameras.forEach((t=>{e&&!e(t)||this.scene.removeCamera(t)})),this.lights.forEach((t=>{e&&!e(t)||this.scene.removeLight(t)})),this.meshes.forEach((t=>{e&&!e(t)||this.scene.removeMesh(t,!0)})),this.skeletons.forEach((t=>{e&&!e(t)||this.scene.removeSkeleton(t)})),this.animations.forEach((t=>{e&&!e(t)||this.scene.removeAnimation(t)})),this.animationGroups.forEach((t=>{e&&!e(t)||this.scene.removeAnimationGroup(t)})),this.multiMaterials.forEach((t=>{e&&!e(t)||this.scene.removeMultiMaterial(t)})),this.materials.forEach((t=>{e&&!e(t)||this.scene.removeMaterial(t)})),this.morphTargetManagers.forEach((t=>{e&&!e(t)||this.scene.removeMorphTargetManager(t)})),this.geometries.forEach((t=>{e&&!e(t)||this.scene.removeGeometry(t)})),this.transformNodes.forEach((t=>{e&&!e(t)||this.scene.removeTransformNode(t)})),this.actionManagers.forEach((t=>{e&&!e(t)||this.scene.removeActionManager(t)})),this.textures.forEach((t=>{e&&!e(t)||this.scene.removeTexture(t)})),this.reflectionProbes.forEach((t=>{e&&!e(t)||this.scene.removeReflectionProbe(t)}))}dispose(){this.cameras.slice(0).forEach((e=>{e.dispose()})),this.cameras.length=0,this.lights.slice(0).forEach((e=>{e.dispose()})),this.lights.length=0,this.meshes.slice(0).forEach((e=>{e.dispose()})),this.meshes.length=0,this.skeletons.slice(0).forEach((e=>{e.dispose()})),this.skeletons.length=0,this.animationGroups.slice(0).forEach((e=>{e.dispose()})),this.animationGroups.length=0,this.multiMaterials.slice(0).forEach((e=>{e.dispose()})),this.multiMaterials.length=0,this.materials.slice(0).forEach((e=>{e.dispose()})),this.materials.length=0,this.geometries.slice(0).forEach((e=>{e.dispose()})),this.geometries.length=0,this.transformNodes.slice(0).forEach((e=>{e.dispose()})),this.transformNodes.length=0,this.actionManagers.slice(0).forEach((e=>{e.dispose()})),this.actionManagers.length=0,this.textures.slice(0).forEach((e=>{e.dispose()})),this.textures.length=0,this.reflectionProbes.slice(0).forEach((e=>{e.dispose()})),this.reflectionProbes.length=0,this.morphTargetManagers.slice(0).forEach((e=>{e.dispose()})),this.morphTargetManagers.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,t,i){if(e&&t)for(const s of e){let e=!0;if(i)for(const t of i)if(s===t){e=!1;break}e&&(t.push(s),s._parentContainer=this)}}moveAllFromScene(e){this._wasAddedToScene=!1,void 0===e&&(e=new _r);for(const t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||("_environmentTexture"===t?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){const e=new ur("assetContainerRootMesh",this.scene);return this.meshes.forEach((t=>{t.parent||e.addChild(t)})),this.meshes.unshift(e),e}mergeAnimationsTo(e=x.LastCreatedScene,t,i=null){if(!e)return k.Error("No scene available to merge animations to"),[];const s=i||(t=>{let i=null;const s=t.animations.length?t.animations[0].targetProperty:"",r=t.name.split(".").join("").split("_primitive")[0];switch(s){case"position":case"rotationQuaternion":i=e.getTransformNodeByName(t.name)||e.getTransformNodeByName(r);break;case"influence":i=e.getMorphTargetByName(t.name)||e.getMorphTargetByName(r);break;default:i=e.getNodeByName(t.name)||e.getNodeByName(r)}return i});this.getNodes().forEach((e=>{const t=s(e);if(null!==t){for(const i of e.animations){const e=t.animations.filter((e=>e.targetProperty===i.targetProperty));for(const i of e){const e=t.animations.indexOf(i,0);e>-1&&t.animations.splice(e,1)}}t.animations=t.animations.concat(e.animations)}}));const r=[];return this.animationGroups.slice().forEach((e=>{r.push(e.clone(e.name,s)),e.animatables.forEach((e=>{e.stop()}))})),t.forEach((t=>{const i=s(t.target);i&&(e.beginAnimation(i,t.fromFrame,t.toFrame,t.loopAnimation,t.speedRatio,t.onAnimationEnd?t.onAnimationEnd:void 0,void 0,!0,void 0,t.onAnimationLoop?t.onAnimationLoop:void 0),e.stopAnimation(t.target))})),r}populateRootNodes(){this.rootNodes.length=0,this.meshes.forEach((e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)})),this.transformNodes.forEach((e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)})),this.lights.forEach((e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)})),this.cameras.forEach((e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)}))}addAllAssetsToContainer(e){if(!e)return;const t=[],i=new Set;for(t.push(e);t.length>0;){const e=t.pop();if(e instanceof ur?(e.geometry&&-1===this.geometries.indexOf(e.geometry)&&this.geometries.push(e.geometry),this.meshes.push(e)):e instanceof ws?this.transformNodes.push(e):e instanceof pr?this.lights.push(e):e instanceof ps&&this.cameras.push(e),e instanceof Vs){if(e.material&&-1===this.materials.indexOf(e.material)){this.materials.push(e.material);for(const t of e.material.getActiveTextures())-1===this.textures.indexOf(t)&&this.textures.push(t)}e.skeleton&&-1===this.skeletons.indexOf(e.skeleton)&&this.skeletons.push(e.skeleton),e.morphTargetManager&&-1===this.morphTargetManagers.indexOf(e.morphTargetManager)&&this.morphTargetManagers.push(e.morphTargetManager)}for(const s of e.getChildren())i.has(s)||t.push(s);i.add(e)}this.populateRootNodes()}}Ns.AudioEngineFactory=(e,t,i)=>new gr(e,t,i);class gr{get audioContext(){return this._audioContextInitialized||this._initializeAudioContext(),this._audioContext}constructor(e=null,t=null,i=null){if(this._audioContext=null,this._audioContextInitialized=!1,this._muteButton=null,this._audioDestination=null,this.canUseWebAudio=!1,this.WarnedWebAudioUnsupported=!1,this.isMP3supported=!1,this.isOGGsupported=!1,this.unlocked=!1,this.useCustomUnlockedButton=!1,this.onAudioUnlockedObservable=new a,this.onAudioLockedObservable=new a,this._tryToRun=!1,this._onResize=()=>{this._moveButtonToTopLeft()},!Me())return;void 0!==window.AudioContext&&(this.canUseWebAudio=!0);const s=document.createElement("audio");this._hostElement=e,this._audioContext=t,this._audioDestination=i;try{s&&s.canPlayType&&(s.canPlayType('audio/mpeg; codecs="mp3"').replace(/^no$/,"")||s.canPlayType("audio/mp3").replace(/^no$/,""))&&(this.isMP3supported=!0)}catch(e){}try{s&&s.canPlayType&&s.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")&&(this.isOGGsupported=!0)}catch(e){}}lock(){this._triggerSuspendedState()}unlock(){var e,t;"running"!==(null===(e=this._audioContext)||void 0===e?void 0:e.state)?this._tryToRun?null===(t=this._audioContext)||void 0===t||t.suspend().then((()=>{this._tryToRun=!1,this._triggerRunningState()})):this._triggerRunningState():this._hideMuteButton()}_resumeAudioContext(){var e;return(null===(e=this._audioContext)||void 0===e?void 0:e.resume)?this._audioContext.resume():Promise.resolve()}_initializeAudioContext(){try{this.canUseWebAudio&&(this._audioContext||(this._audioContext=new AudioContext),this.masterGain=this._audioContext.createGain(),this.masterGain.gain.value=1,this._audioDestination||(this._audioDestination=this._audioContext.destination),this.masterGain.connect(this._audioDestination),this._audioContextInitialized=!0,"running"===this._audioContext.state&&this._triggerRunningState())}catch(e){this.canUseWebAudio=!1,k.Error("Web Audio: "+e.message)}}_triggerRunningState(){this._tryToRun||(this._tryToRun=!0,this._resumeAudioContext().then((()=>{this._tryToRun=!1,this._muteButton&&this._hideMuteButton(),this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this)})).catch((()=>{this._tryToRun=!1,this.unlocked=!1})))}_triggerSuspendedState(){this.unlocked=!1,this.onAudioLockedObservable.notifyObservers(this),this._displayMuteButton()}_displayMuteButton(){if(this.useCustomUnlockedButton||this._muteButton)return;this._muteButton=document.createElement("BUTTON"),this._muteButton.className="babylonUnmuteIcon",this._muteButton.id="babylonUnmuteIconBtn",this._muteButton.title="Unmute";const e=".babylonUnmuteIcon { position: absolute; left: 20px; top: 20px; height: 40px; width: 60px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E":"https://cdn.babylonjs.com/Assets/audio.png")+");  background-size: 80%; background-repeat:no-repeat; background-position: center; background-position-y: 4px; border: none; outline: none; transition: transform 0.125s ease-out; cursor: pointer; z-index: 9999; } .babylonUnmuteIcon:hover { transform: scale(1.05) } .babylonUnmuteIcon:active { background-color: rgba(51,51,51,1) }",t=document.createElement("style");t.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(t),document.body.appendChild(this._muteButton),this._moveButtonToTopLeft(),this._muteButton.addEventListener("touchend",(()=>{this._triggerRunningState()}),!0),this._muteButton.addEventListener("click",(()=>{this.unlock()}),!0),window.addEventListener("resize",this._onResize)}_moveButtonToTopLeft(){this._hostElement&&this._muteButton&&(this._muteButton.style.top=this._hostElement.offsetTop+20+"px",this._muteButton.style.left=this._hostElement.offsetLeft+20+"px")}_hideMuteButton(){this._muteButton&&(document.body.removeChild(this._muteButton),this._muteButton=null)}dispose(){this.canUseWebAudio&&this._audioContextInitialized&&(this._connectedAnalyser&&this._audioContext&&(this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser.dispose(),this.masterGain.disconnect(),this.masterGain.connect(this._audioContext.destination),this._connectedAnalyser=null),this.masterGain.gain.value=1),this.WarnedWebAudioUnsupported=!1,this._hideMuteButton(),window.removeEventListener("resize",this._onResize),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear()}getGlobalVolume(){return this.canUseWebAudio&&this._audioContextInitialized?this.masterGain.gain.value:-1}setGlobalVolume(e){this.canUseWebAudio&&this._audioContextInitialized&&(this.masterGain.gain.value=e)}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this.canUseWebAudio&&this._audioContextInitialized&&this._audioContext&&(this._connectedAnalyser=e,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._audioContext.destination))}}class vr{get loop(){return this._loop}set loop(e){e!==this._loop&&(this._loop=e,this.updateOptions({loop:e}))}get currentTime(){var e;if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;if((null===(e=Ns.audioEngine)||void 0===e?void 0:e.audioContext)&&(this.isPlaying||this.isPaused)){const e=this.isPaused?0:Ns.audioEngine.audioContext.currentTime-this._startTime;return this._currentTime+e}return 0}get spatialSound(){return this._spatialSound}set spatialSound(e){if(e==this._spatialSound)return;const t=this.isPlaying;this.pause(),e?(this._spatialSound=e,this._updateSpatialParameters()):this._disableSpatialSound(),t&&this.play()}constructor(e,t,i,s=null,r){var n,o,l,h,c;if(this.autoplay=!1,this._loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new a,this._spatialSound=!1,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._currentTime=0,this._position=S.Zero(),this._localDirection=new S(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=e,i=i||x.LastCreatedScene)if(this._scene=i,vr._SceneComponentInitialization(i),this._readyToPlayCallback=s,this._customAttenuationFunction=(e,t,i,s,r)=>t<i?e*(1-t/i):0,r&&(this.autoplay=r.autoplay||!1,this._loop=r.loop||!1,void 0!==r.volume&&(this._volume=r.volume),this._spatialSound=null!==(n=r.spatialSound)&&void 0!==n&&n,this.maxDistance=null!==(o=r.maxDistance)&&void 0!==o?o:100,this.useCustomAttenuation=null!==(l=r.useCustomAttenuation)&&void 0!==l&&l,this.rolloffFactor=r.rolloffFactor||1,this.refDistance=r.refDistance||1,this.distanceModel=r.distanceModel||"linear",this._playbackRate=r.playbackRate||1,this._streaming=null!==(h=r.streaming)&&void 0!==h&&h,this._length=r.length,this._offset=r.offset),(null===(c=Ns.audioEngine)||void 0===c?void 0:c.canUseWebAudio)&&Ns.audioEngine.audioContext){this._soundGain=Ns.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this._spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);let e=!0;if(t)try{"string"==typeof t?(this._urlType="String",this._url=t):t instanceof ArrayBuffer?this._urlType="ArrayBuffer":t instanceof HTMLMediaElement?this._urlType="MediaElement":t instanceof MediaStream?this._urlType="MediaStream":t instanceof AudioBuffer?this._urlType="AudioBuffer":Array.isArray(t)&&(this._urlType="Array");let i=[],s=!1;switch(this._urlType){case"MediaElement":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=Ns.audioEngine.audioContext.createMediaElementSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=Ns.audioEngine.audioContext.createMediaStreamSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":t.byteLength>0&&(s=!0,this._soundLoaded(t));break;case"AudioBuffer":this._audioBufferLoaded(t);break;case"String":i.push(t);case"Array":0===i.length&&(i=t);for(let e=0;e<i.length;e++){const t=i[e];if(s=r&&r.skipCodecCheck||-1!==t.indexOf(".mp3",t.length-4)&&Ns.audioEngine.isMP3supported||-1!==t.indexOf(".ogg",t.length-4)&&Ns.audioEngine.isOGGsupported||-1!==t.indexOf(".wav",t.length-4)||-1!==t.indexOf(".m4a",t.length-4)||-1!==t.indexOf(".mp4",t.length-4)||-1!==t.indexOf("blob:"),s){this._streaming?(this._htmlAudioElement=new Audio(t),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,Ht.SetCorsBehavior(t,this._htmlAudioElement),this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",(()=>{this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback()})),document.body.appendChild(this._htmlAudioElement),this._htmlAudioElement.load()):this._scene._loadFile(t,(e=>{this._soundLoaded(e)}),void 0,!0,!0,(e=>{e&&k.Error("XHR "+e.status+" error on: "+t+"."),k.Error("Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}));break}}break;default:e=!1}e?s||(this._isReadyToPlay=!0,this._readyToPlayCallback&&setTimeout((()=>{this._readyToPlayCallback&&this._readyToPlayCallback()}),1e3)):k.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch(e){k.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),Ns.audioEngine&&!Ns.audioEngine.WarnedWebAudioUnsupported&&(k.Error("Web Audio is not supported by your browser."),Ns.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&setTimeout((()=>{this._readyToPlayCallback&&this._readyToPlayCallback()}),1e3)}dispose(){var e;(null===(e=Ns.audioEngine)||void 0===e?void 0:e.canUseWebAudio)&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,-1===this.soundTrackId?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement)),this._streamingSource&&this._streamingSource.disconnect(),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null),this._clearTimeoutsAndObservers())}isReady(){return this._isReadyToPlay}getClassName(){return"Sound"}_audioBufferLoaded(e){var t;(null===(t=Ns.audioEngine)||void 0===t?void 0:t.audioContext)&&(this._audioBuffer=e,this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback())}_soundLoaded(e){var t;(null===(t=Ns.audioEngine)||void 0===t?void 0:t.audioContext)&&Ns.audioEngine.audioContext.decodeAudioData(e,(e=>{this._audioBufferLoaded(e)}),(e=>{k.Error("Error while decoding audio data for: "+this.name+" / Error: "+e)}))}setAudioBuffer(e){var t;(null===(t=Ns.audioEngine)||void 0===t?void 0:t.canUseWebAudio)&&(this._audioBuffer=e,this._isReadyToPlay=!0)}updateOptions(e){var t,i,s,r,n,o,a,l,h,c,u;e&&(this.loop=null!==(t=e.loop)&&void 0!==t?t:this.loop,this.maxDistance=null!==(i=e.maxDistance)&&void 0!==i?i:this.maxDistance,this.useCustomAttenuation=null!==(s=e.useCustomAttenuation)&&void 0!==s?s:this.useCustomAttenuation,this.rolloffFactor=null!==(r=e.rolloffFactor)&&void 0!==r?r:this.rolloffFactor,this.refDistance=null!==(n=e.refDistance)&&void 0!==n?n:this.refDistance,this.distanceModel=null!==(o=e.distanceModel)&&void 0!==o?o:this.distanceModel,this._playbackRate=null!==(a=e.playbackRate)&&void 0!==a?a:this._playbackRate,this._length=null!==(l=e.length)&&void 0!==l?l:void 0,this.spatialSound=null!==(h=e.spatialSound)&&void 0!==h?h:this._spatialSound,this._setOffset(null!==(c=e.offset)&&void 0!==c?c:void 0),this.setVolume(null!==(u=e.volume)&&void 0!==u?u:this._volume),this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),void 0!==this._offset&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),void 0!==this._length&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(0|this._offset)+this._length))))}_createSpatialParameters(){var e,t;(null===(e=Ns.audioEngine)||void 0===e?void 0:e.canUseWebAudio)&&Ns.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=null!==(t=this._soundPanner)&&void 0!==t?t:Ns.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))}_disableSpatialSound(){var e;this._spatialSound&&(this._inputAudioNode=this._soundGain,null===(e=this._soundPanner)||void 0===e||e.disconnect(),this._soundPanner=null,this._spatialSound=!1)}_updateSpatialParameters(){this._spatialSound&&(this._soundPanner?this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel):this._createSpatialParameters())}switchPanningModelToHRTF(){this._panningModel="HRTF",this._switchPanningModel()}switchPanningModelToEqualPower(){this._panningModel="equalpower",this._switchPanningModel()}_switchPanningModel(){var e;(null===(e=Ns.audioEngine)||void 0===e?void 0:e.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)}connectToSoundTrackAudioNode(e){var t;(null===(t=Ns.audioEngine)||void 0===t?void 0:t.canUseWebAudio)&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(e),this._isOutputConnected=!0)}setDirectionalCone(e,t,i){t<e?k.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle."):(this._coneInnerAngle=e,this._coneOuterAngle=t,this._coneOuterGain=i,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length)))}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){var t;if(e!=this._coneInnerAngle){if(this._coneOuterAngle<e)return void k.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneInnerAngle=e,(null===(t=Ns.audioEngine)||void 0===t?void 0:t.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){var t;if(e!=this._coneOuterAngle){if(e<this._coneInnerAngle)return void k.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneOuterAngle=e,(null===(t=Ns.audioEngine)||void 0===t?void 0:t.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}}setPosition(e){var t;e.equals(this._position)||(this._position.copyFrom(e),(null===(t=Ns.audioEngine)||void 0===t?void 0:t.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z))}setLocalDirectionToMesh(e){var t;this._localDirection=e,(null===(t=Ns.audioEngine)||void 0===t?void 0:t.canUseWebAudio)&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()}_updateDirection(){if(!this._connectedTransformNode||!this._soundPanner)return;const e=this._connectedTransformNode.getWorldMatrix(),t=S.TransformNormal(this._localDirection,e);t.normalize(),this._soundPanner.orientationX.value=t.x,this._soundPanner.orientationY.value=t.y,this._soundPanner.orientationZ.value=t.z}updateDistanceFromListener(){var e;if((null===(e=Ns.audioEngine)||void 0===e?void 0:e.canUseWebAudio)&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){const e=this._scene.audioListenerPositionProvider?this._connectedTransformNode.position.subtract(this._scene.audioListenerPositionProvider()).length():this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,e,this.maxDistance,this.refDistance,this.rolloffFactor)}}setAttenuationFunction(e){this._customAttenuationFunction=e}play(e,t,i){var s,r,n,o;if(this._isReadyToPlay&&this._scene.audioEnabled&&(null===(s=Ns.audioEngine)||void 0===s?void 0:s.audioContext))try{this._clearTimeoutsAndObservers();let s=e?(null===(r=Ns.audioEngine)||void 0===r?void 0:r.audioContext.currentTime)+e:null===(n=Ns.audioEngine)||void 0===n?void 0:n.audioContext.currentTime;if(this._soundSource&&this._streamingSource||this._spatialSound&&this._soundPanner&&(isNaN(this._position.x)||isNaN(this._position.y)||isNaN(this._position.z)||(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(this._streamingSource||(this._streamingSource=Ns.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=()=>{this._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode),this._htmlAudioElement){const e=()=>{var t,i;if(null===(t=Ns.audioEngine)||void 0===t?void 0:t.unlocked){const t=this._htmlAudioElement.play();void 0!==t&&t.catch((()=>{var t,i;null===(t=Ns.audioEngine)||void 0===t||t.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=null===(i=Ns.audioEngine)||void 0===i?void 0:i.onAudioUnlockedObservable.addOnce((()=>{e()})))}))}else(this.loop||this.autoplay)&&(this._audioUnlockedObserver=null===(i=Ns.audioEngine)||void 0===i?void 0:i.onAudioUnlockedObservable.addOnce((()=>{e()})))};e()}}else{const r=()=>{var r,n,o,a;if(null===(r=Ns.audioEngine)||void 0===r?void 0:r.audioContext){if(i=i||this._length,void 0!==t&&this._setOffset(t),this._soundSource){const e=this._soundSource;e.onended=()=>{e.disconnect()}}if(this._soundSource=null===(n=Ns.audioEngine)||void 0===n?void 0:n.audioContext.createBufferSource(),this._soundSource&&this._inputAudioNode){this._soundSource.buffer=this._audioBuffer,this._soundSource.connect(this._inputAudioNode),this._soundSource.loop=this.loop,void 0!==t&&(this._soundSource.loopStart=t),void 0!==i&&(this._soundSource.loopEnd=(0|t)+i),this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.onended=()=>{this._onended()},s=e?(null===(o=Ns.audioEngine)||void 0===o?void 0:o.audioContext.currentTime)+e:Ns.audioEngine.audioContext.currentTime;const r=((this.isPaused?this.currentTime:0)+(null!==(a=this._offset)&&void 0!==a?a:0))%this._soundSource.buffer.duration;this._soundSource.start(s,r,this.loop?void 0:i)}}};"suspended"===(null===(o=Ns.audioEngine)||void 0===o?void 0:o.audioContext.state)?this._tryToPlayTimeout=setTimeout((()=>{var e;"suspended"===(null===(e=Ns.audioEngine)||void 0===e?void 0:e.audioContext.state)?(Ns.audioEngine.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=Ns.audioEngine.onAudioUnlockedObservable.addOnce((()=>{r()})))):r()}),500):r()}this._startTime=s,this.isPlaying=!0,this.isPaused=!1}catch(e){k.Error("Error while trying to play audio: "+this.name+", "+e.message)}}_onended(){this.isPlaying=!1,this._startTime=0,this._currentTime=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)}stop(e){var t;if(this.isPlaying)if(this._clearTimeoutsAndObservers(),this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):this._streamingSource.disconnect(),this.isPlaying=!1;else if((null===(t=Ns.audioEngine)||void 0===t?void 0:t.audioContext)&&this._soundSource){const t=e?Ns.audioEngine.audioContext.currentTime+e:void 0;this._soundSource.onended=()=>{this.isPlaying=!1,this.isPaused=!1,this._startTime=0,this._currentTime=0,this._soundSource&&(this._soundSource.onended=()=>{}),this._onended()},this._soundSource.stop(t)}else this.isPlaying=!1;else this.isPaused&&(this.isPaused=!1,this._startTime=0,this._currentTime=0)}pause(){var e;this.isPlaying&&(this._clearTimeoutsAndObservers(),this._streaming?(this._htmlAudioElement?this._htmlAudioElement.pause():this._streamingSource.disconnect(),this.isPlaying=!1,this.isPaused=!0):(null===(e=Ns.audioEngine)||void 0===e?void 0:e.audioContext)&&this._soundSource&&(this._soundSource.onended=()=>{},this._soundSource.stop(),this.isPlaying=!1,this.isPaused=!0,this._currentTime+=Ns.audioEngine.audioContext.currentTime-this._startTime))}setVolume(e,t){var i;(null===(i=Ns.audioEngine)||void 0===i?void 0:i.canUseWebAudio)&&this._soundGain&&(t&&Ns.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(Ns.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,Ns.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(e,Ns.audioEngine.audioContext.currentTime+t)):this._soundGain.gain.value=e),this._volume=e}setPlaybackRate(e){this._playbackRate=e,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))}getPlaybackRate(){return this._playbackRate}getVolume(){return this._volume}attachToMesh(e){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=e,this._spatialSound||(this._spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=e=>this._onRegisterAfterWorldMatrixUpdate(e),this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)}detachFromMesh(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)}_onRegisterAfterWorldMatrixUpdate(e){var t;if(e.getBoundingInfo){const t=e.getBoundingInfo();this.setPosition(t.boundingSphere.centerWorld)}else this.setPosition(e.absolutePosition);(null===(t=Ns.audioEngine)||void 0===t?void 0:t.canUseWebAudio)&&this._isDirectional&&this.isPlaying&&this._updateDirection()}clone(){if(this._streaming)return null;{const e=()=>{this._isReadyToPlay?(i._audioBuffer=this.getAudioBuffer(),i._isReadyToPlay=!0,i.autoplay&&i.play(0,this._offset,this._length)):setTimeout(e,300)},t={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},i=new vr(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,t);return this.useCustomAttenuation&&i.setAttenuationFunction(this._customAttenuationFunction),i.setPosition(this._position),i.setPlaybackRate(this._playbackRate),e(),i}}getAudioBuffer(){return this._audioBuffer}getSoundSource(){return this._soundSource}getSoundGain(){return this._soundGain}serialize(){const e={name:this.name,url:this._url,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this._spatialSound&&(this._connectedTransformNode&&(e.connectedMeshId=this._connectedTransformNode.id),e.position=this._position.asArray(),e.refDistance=this.refDistance,e.distanceModel=this.distanceModel,e.isDirectional=this._isDirectional,e.localDirectionToMesh=this._localDirection.asArray(),e.coneInnerAngle=this._coneInnerAngle,e.coneOuterAngle=this._coneOuterAngle,e.coneOuterGain=this._coneOuterGain),e}static Parse(e,t,i,s){const r=e.name;let n;n=e.url?i+e.url:i+r;const o={autoplay:e.autoplay,loop:e.loop,volume:e.volume,spatialSound:e.spatialSound,maxDistance:e.maxDistance,rolloffFactor:e.rolloffFactor,refDistance:e.refDistance,distanceModel:e.distanceModel,playbackRate:e.playbackRate};let a;if(s){const e=()=>{s._isReadyToPlay?(a._audioBuffer=s.getAudioBuffer(),a._isReadyToPlay=!0,a.autoplay&&a.play(0,a._offset,a._length)):setTimeout(e,300)};a=new vr(r,new ArrayBuffer(0),t,null,o),e()}else a=new vr(r,n,t,(()=>{t.removePendingData(a)}),o),t.addPendingData(a);if(e.position){const t=S.FromArray(e.position);a.setPosition(t)}if(e.isDirectional&&(a.setDirectionalCone(e.coneInnerAngle||360,e.coneOuterAngle||360,e.coneOuterGain||0),e.localDirectionToMesh)){const t=S.FromArray(e.localDirectionToMesh);a.setLocalDirectionToMesh(t)}if(e.connectedMeshId){const i=t.getMeshById(e.connectedMeshId);i&&a.attachToMesh(i)}return e.metadata&&(a.metadata=e.metadata),a}_setOffset(e){this._offset!==e&&(this.isPaused&&(this.stop(),this.isPaused=!1),this._offset=e)}_clearTimeoutsAndObservers(){var e;this._tryToPlayTimeout&&(clearTimeout(this._tryToPlayTimeout),this._tryToPlayTimeout=null),this._audioUnlockedObserver&&(null===(e=Ns.audioEngine)||void 0===e||e.onAudioUnlockedObservable.remove(this._audioUnlockedObserver),this._audioUnlockedObserver=null)}}vr._SceneComponentInitialization=e=>{throw $("AudioSceneComponent")};class xr{constructor(e,t={}){this.id=-1,this._isInitialized=!1,(e=e||x.LastCreatedScene)&&(this._scene=e,this.soundCollection=[],this._options=t,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1))}_initializeSoundTrackAudioGraph(){var e;(null===(e=Ns.audioEngine)||void 0===e?void 0:e.canUseWebAudio)&&Ns.audioEngine.audioContext&&(this._outputAudioNode=Ns.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(Ns.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=!0)}dispose(){if(Ns.audioEngine&&Ns.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}}addSound(e){var t;this._isInitialized||this._initializeSoundTrackAudioGraph(),(null===(t=Ns.audioEngine)||void 0===t?void 0:t.canUseWebAudio)&&this._outputAudioNode&&e.connectToSoundTrackAudioNode(this._outputAudioNode),void 0!==e.soundTrackId&&(-1===e.soundTrackId?this._scene.mainSoundTrack.removeSound(e):this._scene.soundTracks&&this._scene.soundTracks[e.soundTrackId].removeSound(e)),this.soundCollection.push(e),e.soundTrackId=this.id}removeSound(e){const t=this.soundCollection.indexOf(e);-1!==t&&this.soundCollection.splice(t,1)}setVolume(e){var t;(null===(t=Ns.audioEngine)||void 0===t?void 0:t.canUseWebAudio)&&this._outputAudioNode&&(this._outputAudioNode.gain.value=e)}switchPanningModelToHRTF(){var e;if(null===(e=Ns.audioEngine)||void 0===e?void 0:e.canUseWebAudio)for(let e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToHRTF()}switchPanningModelToEqualPower(){var e;if(null===(e=Ns.audioEngine)||void 0===e?void 0:e.canUseWebAudio)for(let e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToEqualPower()}connectToAnalyser(e){var t;this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,(null===(t=Ns.audioEngine)||void 0===t?void 0:t.canUseWebAudio)&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,Ns.audioEngine.masterGain))}}s.AddParser(fi.NAME_AUDIO,((e,t,i,s)=>{var r;let n,o=[];if(i.sounds=i.sounds||[],void 0!==e.sounds&&null!==e.sounds)for(let a=0,l=e.sounds.length;a<l;a++){const l=e.sounds[a];(null===(r=Ns.audioEngine)||void 0===r?void 0:r.canUseWebAudio)?(l.url||(l.url=l.name),o[l.url]?i.sounds.push(vr.Parse(l,t,s,o[l.url])):(n=vr.Parse(l,t,s),o[l.url]=n,i.sounds.push(n))):i.sounds.push(new vr(l.name,null,t))}o=[]})),Object.defineProperty(Yi.prototype,"mainSoundTrack",{get:function(){let e=this._getComponent(fi.NAME_AUDIO);return e||(e=new Tr(this),this._addComponent(e)),this._mainSoundTrack||(this._mainSoundTrack=new xr(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0}),Yi.prototype.getSoundByName=function(e){let t;for(t=0;t<this.mainSoundTrack.soundCollection.length;t++)if(this.mainSoundTrack.soundCollection[t].name===e)return this.mainSoundTrack.soundCollection[t];if(this.soundTracks)for(let i=0;i<this.soundTracks.length;i++)for(t=0;t<this.soundTracks[i].soundCollection.length;t++)if(this.soundTracks[i].soundCollection[t].name===e)return this.soundTracks[i].soundCollection[t];return null},Object.defineProperty(Yi.prototype,"audioEnabled",{get:function(){let e=this._getComponent(fi.NAME_AUDIO);return e||(e=new Tr(this),this._addComponent(e)),e.audioEnabled},set:function(e){let t=this._getComponent(fi.NAME_AUDIO);t||(t=new Tr(this),this._addComponent(t)),e?t.enableAudio():t.disableAudio()},enumerable:!0,configurable:!0}),Object.defineProperty(Yi.prototype,"headphone",{get:function(){let e=this._getComponent(fi.NAME_AUDIO);return e||(e=new Tr(this),this._addComponent(e)),e.headphone},set:function(e){let t=this._getComponent(fi.NAME_AUDIO);t||(t=new Tr(this),this._addComponent(t)),e?t.switchAudioModeForHeadphones():t.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0}),Object.defineProperty(Yi.prototype,"audioListenerPositionProvider",{get:function(){let e=this._getComponent(fi.NAME_AUDIO);return e||(e=new Tr(this),this._addComponent(e)),e.audioListenerPositionProvider},set:function(e){let t=this._getComponent(fi.NAME_AUDIO);if(t||(t=new Tr(this),this._addComponent(t)),e&&"function"!=typeof e)throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");t.audioListenerPositionProvider=e},enumerable:!0,configurable:!0}),Object.defineProperty(Yi.prototype,"audioListenerRotationProvider",{get:function(){let e=this._getComponent(fi.NAME_AUDIO);return e||(e=new Tr(this),this._addComponent(e)),e.audioListenerRotationProvider},set:function(e){let t=this._getComponent(fi.NAME_AUDIO);if(t||(t=new Tr(this),this._addComponent(t)),e&&"function"!=typeof e)throw new Error("The value passed to [Scene.audioListenerRotationProvider] must be a function that returns a Vector3");t.audioListenerRotationProvider=e},enumerable:!0,configurable:!0}),Object.defineProperty(Yi.prototype,"audioPositioningRefreshRate",{get:function(){let e=this._getComponent(fi.NAME_AUDIO);return e||(e=new Tr(this),this._addComponent(e)),e.audioPositioningRefreshRate},set:function(e){let t=this._getComponent(fi.NAME_AUDIO);t||(t=new Tr(this),this._addComponent(t)),t.audioPositioningRefreshRate=e},enumerable:!0,configurable:!0});class Tr{get audioEnabled(){return this._audioEnabled}get headphone(){return this._headphone}constructor(e){this.name=fi.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this.audioListenerPositionProvider=null,this.audioListenerRotationProvider=null,this._cachedCameraDirection=new S,this._cachedCameraPosition=new S,this._lastCheck=0,this._invertMatrixTemp=new y,this._cameraDirectionTemp=new S,(e=e||x.LastCreatedScene)&&(this.scene=e,e.soundTracks=[],e.sounds=[])}register(){this.scene._afterRenderStage.registerStep(fi.STEP_AFTERRENDER_AUDIO,this,this._afterRender)}rebuild(){}serialize(e){if(e.sounds=[],this.scene.soundTracks)for(let t=0;t<this.scene.soundTracks.length;t++){const i=this.scene.soundTracks[t];for(let t=0;t<i.soundCollection.length;t++)e.sounds.push(i.soundCollection[t].serialize())}}addFromContainer(e){e.sounds&&e.sounds.forEach((e=>{e.play(),e.autoplay=!0,this.scene.mainSoundTrack.addSound(e)}))}removeFromContainer(e,t=!1){e.sounds&&e.sounds.forEach((e=>{e.stop(),e.autoplay=!1,this.scene.mainSoundTrack.removeSound(e),t&&e.dispose()}))}dispose(){const e=this.scene;if(e._mainSoundTrack&&e.mainSoundTrack.dispose(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].dispose()}disableAudio(){const e=this.scene;let t;for(this._audioEnabled=!1,Ns.audioEngine&&Ns.audioEngine.audioContext&&Ns.audioEngine.audioContext.suspend(),t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].pause();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].pause()}enableAudio(){const e=this.scene;let t;for(this._audioEnabled=!0,Ns.audioEngine&&Ns.audioEngine.audioContext&&Ns.audioEngine.audioContext.resume(),t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].isPaused&&e.mainSoundTrack.soundCollection[t].play();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].isPaused&&e.soundTracks[t].soundCollection[i].play()}switchAudioModeForHeadphones(){const e=this.scene;if(this._headphone=!0,e.mainSoundTrack.switchPanningModelToHRTF(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToHRTF()}switchAudioModeForNormalSpeakers(){const e=this.scene;if(this._headphone=!1,e.mainSoundTrack.switchPanningModelToEqualPower(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToEqualPower()}_afterRender(){const e=Fe.Now;if(this._lastCheck&&e-this._lastCheck<this.audioPositioningRefreshRate)return;this._lastCheck=e;const t=this.scene;if(!this._audioEnabled||!t._mainSoundTrack||!t.soundTracks||0===t._mainSoundTrack.soundCollection.length&&1===t.soundTracks.length)return;const i=Ns.audioEngine;if(i&&i.audioContext){let e,s=t.activeCamera;if(t.activeCameras&&t.activeCameras.length>0&&(s=t.activeCameras[0]),this.audioListenerPositionProvider){const e=this.audioListenerPositionProvider();i.audioContext.listener.setPosition(e.x||0,e.y||0,e.z||0)}else s?this._cachedCameraPosition.equals(s.globalPosition)||(this._cachedCameraPosition.copyFrom(s.globalPosition),i.audioContext.listener.setPosition(s.globalPosition.x,s.globalPosition.y,s.globalPosition.z)):i.audioContext.listener.setPosition(0,0,0);if(this.audioListenerRotationProvider){const e=this.audioListenerRotationProvider();i.audioContext.listener.setOrientation(e.x||0,e.y||0,e.z||0,0,1,0)}else s?(s.rigCameras&&s.rigCameras.length>0&&(s=s.rigCameras[0]),s.getViewMatrix().invertToRef(this._invertMatrixTemp),S.TransformNormalToRef(Tr._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),isNaN(this._cameraDirectionTemp.x)||isNaN(this._cameraDirectionTemp.y)||isNaN(this._cameraDirectionTemp.z)||this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),i.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0))):i.audioContext.listener.setOrientation(0,0,0,0,1,0);for(e=0;e<t.mainSoundTrack.soundCollection.length;e++){const i=t.mainSoundTrack.soundCollection[e];i.useCustomAttenuation&&i.updateDistanceFromListener()}if(t.soundTracks)for(e=0;e<t.soundTracks.length;e++)for(let i=0;i<t.soundTracks[e].soundCollection.length;i++){const s=t.soundTracks[e].soundCollection[i];s.useCustomAttenuation&&s.updateDistanceFromListener()}}}}Tr._CameraDirection=new S(0,0,-1),vr._SceneComponentInitialization=e=>{let t=e._getComponent(fi.NAME_AUDIO);t||(t=new Tr(e),e._addComponent(t))};class Er{constructor(e,t,i){if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],t.length!==i.length)throw new Error("Sounds length does not equal weights length");this.loop=e,this._weights=i;let s=0;for(const e of i)s+=e;const r=s>0?1/s:0;for(let e=0;e<this._weights.length;e++)this._weights[e]*=r;this._sounds=t;for(const e of this._sounds)e.onEndedObservable.add((()=>{this._onended()}))}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){if(e!==this._coneInnerAngle){if(this._coneOuterAngle<e)return void k.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneInnerAngle=e;for(const t of this._sounds)t.directionalConeInnerAngle=e}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){if(e!==this._coneOuterAngle){if(e<this._coneInnerAngle)return void k.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneOuterAngle=e;for(const t of this._sounds)t.directionalConeOuterAngle=e}}get volume(){return this._volume}set volume(e){if(e!==this._volume)for(const t of this._sounds)t.setVolume(e)}_onended(){void 0!==this._currentIndex&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1}pause(){this.isPaused=!0,void 0!==this._currentIndex&&this._sounds[this._currentIndex].pause()}stop(){this.isPlaying=!1,void 0!==this._currentIndex&&this._sounds[this._currentIndex].stop()}play(e){if(!this.isPaused){this.stop();const e=Math.random();let t=0;for(let i=0;i<this._weights.length;i++)if(t+=this._weights[i],e<=t){this._currentIndex=i;break}}const t=this._sounds[this._currentIndex];t.isReady()?t.play(0,this.isPaused?void 0:e):t.autoplay=!0,this.isPlaying=!0,this.isPaused=!1}}class Sr{constructor(e){this._texture=null,this._isEnabled=!0,this.isEnabled=!0,this.time=0,(e=e||x.LastCreatedScene)&&(this._scene=e,this.animationParameters=new b(0,0,0,30))}_markSubMeshesAsAttributesDirty(){for(const e of this._scene.meshes)e.bakedVertexAnimationManager===this&&e._markSubMeshesAsAttributesDirty()}bind(e,t=!1){if(!this._texture||!this._isEnabled)return;const i=this._texture.getSize();e.setFloat2("bakedVertexAnimationTextureSizeInverted",1/i.width,1/i.height),e.setFloat("bakedVertexAnimationTime",this.time),t||e.setVector4("bakedVertexAnimationSettings",this.animationParameters),e.setTexture("bakedVertexAnimationTexture",this._texture)}clone(){const e=new Sr(this._scene);return this.copyTo(e),e}setAnimationParameters(e,t,i=0,s=30){this.animationParameters=new b(e,t,i,s)}dispose(e){var t;e&&(null===(t=this._texture)||void 0===t||t.dispose())}getClassName(){return"BakedVertexAnimationManager"}copyTo(e){de.Clone((()=>e),this)}serialize(){return de.Serialize(this)}parse(e,t,i){de.Parse((()=>this),e,t,i)}}me([se(),te("_markSubMeshesAsAttributesDirty")],Sr.prototype,"texture",void 0),me([ie(),te("_markSubMeshesAsAttributesDirty")],Sr.prototype,"isEnabled",void 0),me([ie()],Sr.prototype,"animationParameters",void 0),me([ie()],Sr.prototype,"time",void 0);class br{get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get coordinatesMode(){return 0}get isCube(){return!!this._texture&&this._texture.isCube}set isCube(e){this._texture&&(this._texture.isCube=e)}get is3D(){return!!this._texture&&this._texture.is3D}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return!!this._texture&&this._texture.is2DArray}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}getClassName(){return"ThinTexture"}static _IsRenderTargetWrapper(e){return void 0!==(null==e?void 0:e._shareDepth)}constructor(e){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=xe.Zero(),this._cachedBaseSize=xe.Zero(),this._initialSamplingMode=2,this._texture=br._IsRenderTargetWrapper(e)?e.texture:e,this._texture&&(this._engine=this._texture.getEngine())}isReady(){return 4===this.delayLoadState?(this.delayLoad(),!1):!!this._texture&&this._texture.isReady}delayLoad(){}getInternalTexture(){return this._texture}getSize(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize}getBaseSize(){return this.isReady()&&this._texture?this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize):(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize)}get samplingMode(){return this._texture?this._texture.samplingMode:this._initialSamplingMode}updateSamplingMode(e){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture)}releaseInternalTexture(){this._texture&&(this._texture.dispose(),this._texture=null)}dispose(){this._texture&&(this.releaseInternalTexture(),this._engine=null)}}class Cr extends br{set hasAlpha(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))))}get hasAlpha(){return this._hasAlpha}set getAlphaFromRGB(e){this._getAlphaFromRGB!==e&&(this._getAlphaFromRGB=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))))}get getAlphaFromRGB(){return this._getAlphaFromRGB}set coordinatesIndex(e){this._coordinatesIndex!==e&&(this._coordinatesIndex=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))))}get coordinatesIndex(){return this._coordinatesIndex}set coordinatesMode(e){this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))))}get coordinatesMode(){return this._coordinatesMode}get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get isCube(){return this._texture?this._texture.isCube:this._isCube}set isCube(e){this._texture?this._texture.isCube=e:this._isCube=e}get is3D(){return!!this._texture&&this._texture.is3D}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return!!this._texture&&this._texture.is2DArray}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}get gammaSpace(){return this._texture?(null===this._texture._gammaSpace&&(this._texture._gammaSpace=this._gammaSpace),this._texture._gammaSpace&&!this._texture._useSRGBBuffer):this._gammaSpace}set gammaSpace(e){var t;if(this._texture){if(this._texture._gammaSpace===e)return;this._texture._gammaSpace=e}else{if(this._gammaSpace===e)return;this._gammaSpace=e}null===(t=this.getScene())||void 0===t||t.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this)))}get isRGBD(){return null!=this._texture&&this._texture._isRGBD}set isRGBD(e){var t;e!==this.isRGBD&&(this._texture&&(this._texture._isRGBD=e),null===(t=this.getScene())||void 0===t||t.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))))}get noMipmap(){return!1}get lodGenerationOffset(){return this._texture?this._texture._lodGenerationOffset:0}set lodGenerationOffset(e){this._texture&&(this._texture._lodGenerationOffset=e)}get lodGenerationScale(){return this._texture?this._texture._lodGenerationScale:0}set lodGenerationScale(e){this._texture&&(this._texture._lodGenerationScale=e)}get linearSpecularLOD(){return!!this._texture&&this._texture._linearSpecularLOD}set linearSpecularLOD(e){this._texture&&(this._texture._linearSpecularLOD=e)}get irradianceTexture(){return this._texture?this._texture._irradianceTexture:null}set irradianceTexture(e){this._texture&&(this._texture._irradianceTexture=e)}get uid(){return this._uid||(this._uid=Wt()),this._uid}toString(){return this.name}getClassName(){return"BaseTexture"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get isBlocking(){return!0}get loadingError(){return this._loadingError}get errorObject(){return this._errorObject}constructor(e,t=null){super(null),this.metadata=null,this.reservedDataStore=null,this._hasAlpha=!1,this._getAlphaFromRGB=!1,this.level=1,this._coordinatesIndex=0,this.optimizeUVAllocation=!0,this._coordinatesMode=0,this.wrapR=1,this.anisotropicFilteringLevel=Cr.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this._isCube=!1,this._gammaSpace=!0,this.invertZ=!1,this.lodLevelInAlpha=!1,this.isRenderTarget=!1,this._prefiltered=!1,this._forceSerialize=!1,this.animations=[],this.onDisposeObservable=new a,this._onDisposeObserver=null,this._scene=null,this._uid=null,this._parentContainer=null,this._loadingError=!1,e?Cr._IsScene(e)?this._scene=e:this._engine=e:this._scene=x.LastCreatedScene,this._scene&&(this.uniqueId=this._scene.getUniqueId(),this._scene.addTexture(this),this._engine=this._scene.getEngine()),this._texture=t,this._uid=null}getScene(){return this._scene}_getEngine(){return this._engine}checkTransformsAreIdentical(e){return null!==e}getTextureMatrix(){return y.IdentityReadOnly}getReflectionTextureMatrix(){return y.IdentityReadOnly}getRefractionTextureMatrix(){return this.getReflectionTextureMatrix()}isReadyOrNotBlocking(){return!this.isBlocking||this.isReady()||this.loadingError}scale(e){}get canRescale(){return!1}_getFromCache(e,t,i,s,r,n){const o=this._getEngine();if(!o)return null;const a=o._getUseSRGBBuffer(!!r,t),l=o.getLoadedTexturesCache();for(let o=0;o<l.length;o++){const h=l[o];if(!(void 0!==r&&a!==h._useSRGBBuffer||void 0!==s&&s!==h.invertY||h.url!==e||h.generateMipMaps!==!t||i&&i!==h.samplingMode||void 0!==n&&n!==h.isCube))return h.incrementReferences(),h}return null}_rebuild(){}clone(){return null}get textureType(){return this._texture&&void 0!==this._texture.type?this._texture.type:0}get textureFormat(){return this._texture&&void 0!==this._texture.format?this._texture.format:5}_markAllSubMeshesAsTexturesDirty(){const e=this.getScene();e&&e.markAllMaterialsAsDirty(1)}readPixels(e=0,t=0,i=null,s=!0,r=!1,n=0,o=0,a=Number.MAX_VALUE,l=Number.MAX_VALUE){if(!this._texture)return null;const h=this._getEngine();if(!h)return null;const c=this.getSize();let u=c.width,d=c.height;0!==t&&(u/=Math.pow(2,t),d/=Math.pow(2,t),u=Math.round(u),d=Math.round(d)),a=Math.min(u,a),l=Math.min(d,l);try{return this._texture.isCube?h._readTexturePixels(this._texture,a,l,e,t,i,s,r,n,o):h._readTexturePixels(this._texture,a,l,-1,t,i,s,r,n,o)}catch(e){return null}}_readPixelsSync(e=0,t=0,i=null,s=!0,r=!1){if(!this._texture)return null;const n=this.getSize();let o=n.width,a=n.height;const l=this._getEngine();if(!l)return null;0!=t&&(o/=Math.pow(2,t),a/=Math.pow(2,t),o=Math.round(o),a=Math.round(a));try{return this._texture.isCube?l._readTexturePixelsSync(this._texture,o,a,e,t,i,s,r):l._readTexturePixelsSync(this._texture,o,a,-1,t,i,s,r)}catch(e){return null}}get _lodTextureHigh(){return this._texture?this._texture._lodTextureHigh:null}get _lodTextureMid(){return this._texture?this._texture._lodTextureMid:null}get _lodTextureLow(){return this._texture?this._texture._lodTextureLow:null}dispose(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);const e=this._scene.textures.indexOf(this);if(e>=0&&this._scene.textures.splice(e,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){const e=this._parentContainer.textures.indexOf(this);e>-1&&this._parentContainer.textures.splice(e,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,super.dispose()}serialize(e=!1){if(!this.name&&!e)return null;const t=de.Serialize(this);return de.AppendSerializedAnimations(this,t),t}static WhenAllReady(e,t){let i=e.length;if(0!==i)for(let s=0;s<e.length;s++){const r=e[s];if(r.isReady())0==--i&&t();else{const e=r.onLoadObservable;e?e.addOnce((()=>{0==--i&&t()})):0==--i&&t()}}else t()}static _IsScene(e){return"Scene"===e.getClassName()}}function yr(e,t,i=!1){const s=t.width,r=t.height;if(e instanceof Float32Array){let t=e.byteLength/e.BYTES_PER_ELEMENT;const i=new Uint8Array(t);for(;--t>=0;){let s=e[t];s<0?s=0:s>1&&(s=1),i[t]=255*s}e=i}const n=document.createElement("canvas");n.width=s,n.height=r;const o=n.getContext("2d");if(!o)return null;const a=o.createImageData(s,r);if(a.data.set(e),o.putImageData(a,0,0),i){const e=document.createElement("canvas");e.width=s,e.height=r;const t=e.getContext("2d");return t?(t.translate(0,r),t.scale(1,-1),t.drawImage(n,0,0),e.toDataURL("image/png")):null}return n.toDataURL("image/png")}Cr.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4,me([ie()],Cr.prototype,"uniqueId",void 0),me([ie()],Cr.prototype,"name",void 0),me([ie()],Cr.prototype,"metadata",void 0),me([ie("hasAlpha")],Cr.prototype,"_hasAlpha",void 0),me([ie("getAlphaFromRGB")],Cr.prototype,"_getAlphaFromRGB",void 0),me([ie()],Cr.prototype,"level",void 0),me([ie("coordinatesIndex")],Cr.prototype,"_coordinatesIndex",void 0),me([ie()],Cr.prototype,"optimizeUVAllocation",void 0),me([ie("coordinatesMode")],Cr.prototype,"_coordinatesMode",void 0),me([ie()],Cr.prototype,"wrapU",null),me([ie()],Cr.prototype,"wrapV",null),me([ie()],Cr.prototype,"wrapR",void 0),me([ie()],Cr.prototype,"anisotropicFilteringLevel",void 0),me([ie()],Cr.prototype,"isCube",null),me([ie()],Cr.prototype,"is3D",null),me([ie()],Cr.prototype,"is2DArray",null),me([ie()],Cr.prototype,"gammaSpace",null),me([ie()],Cr.prototype,"invertZ",void 0),me([ie()],Cr.prototype,"lodLevelInAlpha",void 0),me([ie()],Cr.prototype,"lodGenerationOffset",null),me([ie()],Cr.prototype,"lodGenerationScale",null),me([ie()],Cr.prototype,"linearSpecularLOD",null),me([se()],Cr.prototype,"irradianceTexture",null),me([ie()],Cr.prototype,"isRenderTarget",void 0);class Ar extends Cr{static _CreateVideoTexture(e,t,i,s=!1,r=!1,n=Ar.TRILINEAR_SAMPLINGMODE,o={},a,l=5){throw $("VideoTexture")}get noMipmap(){return this._noMipmap}get mimeType(){return this._mimeType}set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}get invertY(){return this._invertY}constructor(e,t,i,s,r=Ar.TRILINEAR_SAMPLINGMODE,n=null,o=null,l=null,h=!1,c,u,d,p,_){var f,m,g,v,x,T,E,S,b,C;let y;super(t),this.url=null,this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.uRotationCenter=.5,this.vRotationCenter=.5,this.wRotationCenter=.5,this.homogeneousRotationInUVTransform=!1,this.inspectableCustomProperties=null,this._noMipmap=!1,this._invertY=!1,this._rowGenerationMatrix=null,this._cachedTextureMatrix=null,this._projectionModeMatrix=null,this._t0=null,this._t1=null,this._t2=null,this._cachedUOffset=-1,this._cachedVOffset=-1,this._cachedUScale=0,this._cachedVScale=0,this._cachedUAng=-1,this._cachedVAng=-1,this._cachedWAng=-1,this._cachedReflectionProjectionMatrixId=-1,this._cachedURotationCenter=-1,this._cachedVRotationCenter=-1,this._cachedWRotationCenter=-1,this._cachedHomogeneousRotationInUVTransform=!1,this._cachedReflectionTextureMatrix=null,this._cachedReflectionUOffset=-1,this._cachedReflectionVOffset=-1,this._cachedReflectionUScale=0,this._cachedReflectionVScale=0,this._cachedReflectionCoordinatesMode=-1,this._buffer=null,this._deleteBuffer=!1,this._format=null,this._delayedOnLoad=null,this._delayedOnError=null,this.onLoadObservable=new a,this._isBlocking=!0,this.name=e||"",this.url=e;let A=!1,R=null,I=!0;"object"==typeof i&&null!==i?(y=null!==(f=i.noMipmap)&&void 0!==f&&f,s=null!==(m=i.invertY)&&void 0!==m?m:!Is.UseOpenGLOrientationForUV,r=null!==(g=i.samplingMode)&&void 0!==g?g:Ar.TRILINEAR_SAMPLINGMODE,n=null!==(v=i.onLoad)&&void 0!==v?v:null,o=null!==(x=i.onError)&&void 0!==x?x:null,l=null!==(T=i.buffer)&&void 0!==T?T:null,h=null!==(E=i.deleteBuffer)&&void 0!==E&&E,c=i.format,u=i.mimeType,d=i.loaderOptions,p=i.creationFlags,A=null!==(S=i.useSRGBBuffer)&&void 0!==S&&S,R=null!==(b=i.internalTexture)&&void 0!==b?b:null,I=null!==(C=i.gammaSpace)&&void 0!==C?C:I):y=!!i,this._gammaSpace=I,this._noMipmap=y,this._invertY=void 0===s?!Is.UseOpenGLOrientationForUV:s,this._initialSamplingMode=r,this._buffer=l,this._deleteBuffer=h,this._mimeType=u,this._loaderOptions=d,this._creationFlags=p,this._useSRGBBuffer=A,this._forcedExtension=_,c&&(this._format=c);const P=this.getScene(),M=this._getEngine();if(!M)return;M.onBeforeTextureInitObservable.notifyObservers(this);const O=()=>{this._texture&&(this._texture._invertVScale&&(this.vScale*=-1,this.vOffset+=1),null!==this._texture._cachedWrapU&&(this.wrapU=this._texture._cachedWrapU,this._texture._cachedWrapU=null),null!==this._texture._cachedWrapV&&(this.wrapV=this._texture._cachedWrapV,this._texture._cachedWrapV=null),null!==this._texture._cachedWrapR&&(this.wrapR=this._texture._cachedWrapR,this._texture._cachedWrapR=null)),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this),n&&n(),!this.isBlocking&&P&&P.resetCachedMaterial()},D=(e,t)=>{this._loadingError=!0,this._errorObject={message:e,exception:t},o&&o(e,t),Ar.OnTextureLoadErrorObservable.notifyObservers(this)};if(!this.url&&!R)return this._delayedOnLoad=O,void(this._delayedOnError=D);if(this._texture=null!=R?R:this._getFromCache(this.url,y,r,this._invertY,A,this.isCube),this._texture)if(this._texture.isReady)Ct.SetImmediate((()=>O()));else{const e=this._texture.onLoadedObservable.add(O);this._texture.onErrorObservable.add((t=>{var i;D(t.message,t.exception),null===(i=this._texture)||void 0===i||i.onLoadedObservable.remove(e)}))}else if(P&&P.useDelayedTextureLoading)this.delayLoadState=4,this._delayedOnLoad=O,this._delayedOnError=D;else{try{this._texture=M.createTexture(this.url,y,this._invertY,P,r,O,D,this._buffer,void 0,this._format,this._forcedExtension,u,d,p,A)}catch(e){throw D("error loading",e),e}h&&(this._buffer=null)}}updateURL(e,t=null,i,s){this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1,(e=>e.hasTexture(this)))),this.name&&!this.name.startsWith("data:")||(this.name=e),this.url=e,this._buffer=t,this._forcedExtension=s,this.delayLoadState=4,i&&(this._delayedOnLoad=i),this.delayLoad()}delayLoad(){if(4!==this.delayLoadState)return;const e=this.getScene();e&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer,this.isCube),this._texture?this._delayedOnLoad&&(this._texture.isReady?Ct.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=e.getEngine().createTexture(this.url,this._noMipmap,this._invertY,e,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}_prepareRowForTextureGeneration(e,t,i,s){e*=this._cachedUScale,t*=this._cachedVScale,e-=this.uRotationCenter*this._cachedUScale,t-=this.vRotationCenter*this._cachedVScale,i-=this.wRotationCenter,S.TransformCoordinatesFromFloatsToRef(e,t,i,this._rowGenerationMatrix,s),s.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,s.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,s.z+=this.wRotationCenter}checkTransformsAreIdentical(e){return null!==e&&this.uOffset===e.uOffset&&this.vOffset===e.vOffset&&this.uScale===e.uScale&&this.vScale===e.vScale&&this.uAng===e.uAng&&this.vAng===e.vAng&&this.wAng===e.wAng}getTextureMatrix(e=1){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*e===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*e,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,this._cachedTextureMatrix&&this._rowGenerationMatrix||(this._cachedTextureMatrix=y.Zero(),this._rowGenerationMatrix=new y,this._t0=S.Zero(),this._t1=S.Zero(),this._t2=S.Zero()),y.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(y.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,R.Matrix[0]),y.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,R.Matrix[1]),y.ScalingToRef(this._cachedUScale,this._cachedVScale,0,R.Matrix[2]),y.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,R.Matrix[3]),R.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(R.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(R.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(R.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),y.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));const t=this.getScene();return t?(this.optimizeUVAllocation&&t.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))),this._cachedTextureMatrix):this._cachedTextureMatrix}getReflectionTextureMatrix(){const e=this.getScene();if(!e)return this._cachedReflectionTextureMatrix;if(this.uOffset===this._cachedReflectionUOffset&&this.vOffset===this._cachedReflectionVOffset&&this.uScale===this._cachedReflectionUScale&&this.vScale===this._cachedReflectionVScale&&this.coordinatesMode===this._cachedReflectionCoordinatesMode){if(this.coordinatesMode!==Ar.PROJECTION_MODE)return this._cachedReflectionTextureMatrix;if(this._cachedReflectionProjectionMatrixId===e.getProjectionMatrix().updateFlag)return this._cachedReflectionTextureMatrix}this._cachedReflectionTextureMatrix||(this._cachedReflectionTextureMatrix=y.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=y.Zero());const t=this._cachedReflectionCoordinatesMode!==this.coordinatesMode;switch(this._cachedReflectionUOffset=this.uOffset,this._cachedReflectionVOffset=this.vOffset,this._cachedReflectionUScale=this.uScale,this._cachedReflectionVScale=this.vScale,this._cachedReflectionCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case Ar.PLANAR_MODE:y.IdentityToRef(this._cachedReflectionTextureMatrix),this._cachedReflectionTextureMatrix[0]=this.uScale,this._cachedReflectionTextureMatrix[5]=this.vScale,this._cachedReflectionTextureMatrix[12]=this.uOffset,this._cachedReflectionTextureMatrix[13]=this.vOffset;break;case Ar.PROJECTION_MODE:{y.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);const t=e.getProjectionMatrix();this._cachedReflectionProjectionMatrixId=t.updateFlag,t.multiplyToRef(this._projectionModeMatrix,this._cachedReflectionTextureMatrix);break}default:y.IdentityToRef(this._cachedReflectionTextureMatrix)}return t&&e.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))),this._cachedReflectionTextureMatrix}clone(){const e={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return de.Clone((()=>new Ar(this._texture?this._texture.url:null,this.getScene(),e)),this)}serialize(){var e,t;const i=this.name;Ar.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");const s=super.serialize(Ar._SerializeInternalTextureUniqueId);return s?((Ar.SerializeBuffers||Ar.ForceSerializeBuffers)&&("string"==typeof this._buffer&&"data:"===this._buffer.substr(0,5)?(s.base64String=this._buffer,s.name=s.name.replace("data:","")):this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array?s.base64String="data:image/png;base64,"+Ve(this._buffer):(Ar.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(s.base64String=!this._engine||this._engine._features.supportSyncTextureRead?function(e,t=0,i=0){const s=e.getInternalTexture();if(!s)return null;const r=e._readPixelsSync(t,i);return r?yr(r,e.getSize(),s.invertY):null}(this):async function(e,t=0,i=0){const s=e.getInternalTexture();if(!s)return null;const r=await e.readPixels(t,i);return r?yr(r,e.getSize(),s.invertY):null}(this))),s.invertY=this._invertY,s.samplingMode=this.samplingMode,s._creationFlags=this._creationFlags,s._useSRGBBuffer=this._useSRGBBuffer,Ar._SerializeInternalTextureUniqueId&&(s.internalTextureUniqueId=null!==(t=null===(e=this._texture)||void 0===e?void 0:e.uniqueId)&&void 0!==t?t:void 0),s.noMipmap=this._noMipmap,this.name=i,s):null}getClassName(){return"Texture"}dispose(){super.dispose(),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null,this._buffer=null}static Parse(e,t,i){if(e.customType){const s=zt.Instantiate(e.customType).Parse(e,t,i);return e.samplingMode&&s.updateSamplingMode&&s._samplingMode&&s._samplingMode!==e.samplingMode&&s.updateSamplingMode(e.samplingMode),s}if(e.isCube&&!e.isRenderTarget)return Ar._CubeTextureParser(e,t,i);const s=void 0!==e.internalTextureUniqueId;if(!e.name&&!e.isRenderTarget&&!s)return null;let r;if(s){const i=t.getEngine().getLoadedTexturesCache();for(const t of i)if(t.uniqueId===e.internalTextureUniqueId){r=t;break}}const n=t=>{var i;if(t&&t._texture&&(t._texture._cachedWrapU=null,t._texture._cachedWrapV=null,t._texture._cachedWrapR=null),e.samplingMode){const i=e.samplingMode;t&&t.samplingMode!==i&&t.updateSamplingMode(i)}if(t&&e.animations)for(let i=0;i<e.animations.length;i++){const s=e.animations[i],r=g("BABYLON.Animation");r&&t.animations.push(r.Parse(s))}s&&!r&&(null===(i=null==t?void 0:t._texture)||void 0===i||i._setUniqueId(e.internalTextureUniqueId))};return de.Parse((()=>{var s,o,a;let l=!0;if(e.noMipmap&&(l=!1),e.mirrorPlane){const i=Ar._CreateMirror(e.name,e.renderTargetSize,t,l);return i._waitingRenderList=e.renderList,i.mirrorPlane=wi.FromArray(e.mirrorPlane),n(i),i}if(e.isRenderTarget){let i=null;if(e.isCube){if(t.reflectionProbes)for(let i=0;i<t.reflectionProbes.length;i++){const s=t.reflectionProbes[i];if(s.name===e.name)return s.cubeTexture}}else i=Ar._CreateRenderTargetTexture(e.name,e.renderTargetSize,t,l,null!==(s=e._creationFlags)&&void 0!==s?s:0),i._waitingRenderList=e.renderList;return n(i),i}if(e.isVideo){const s=Ar._CreateVideoTexture(i+(e.url||e.name),i+(e.src||e.url),t,l,e.invertY,e.samplingMode,e.settings||{});return n(s),s}{let s;if(e.base64String&&!r)s=Ar.CreateFromBase64String(e.base64String,e.base64String,t,!l,e.invertY,e.samplingMode,(()=>{n(s)}),null!==(o=e._creationFlags)&&void 0!==o?o:0,null!==(a=e._useSRGBBuffer)&&void 0!==a&&a),s.name=e.name;else{let o;o=e.name&&(e.name.indexOf("://")>0||e.name.startsWith("data:"))?e.name:i+e.name,e.url&&(e.url.startsWith("data:")||Ar.UseSerializedUrlIfAny)&&(o=e.url);const a={noMipmap:!l,invertY:e.invertY,samplingMode:e.samplingMode,onLoad:()=>{n(s)},internalTexture:r};s=new Ar(o,t,a)}return s}}),e,t)}static CreateFromBase64String(e,t,i,s,r,n=Ar.TRILINEAR_SAMPLINGMODE,o=null,a=null,l=5,h){return new Ar("data:"+t,i,s,r,n,o,a,e,!1,l,void 0,void 0,h)}static LoadFromDataString(e,t,i,s=!1,r,n=!0,o=Ar.TRILINEAR_SAMPLINGMODE,a=null,l=null,h=5,c){return"data:"!==e.substr(0,5)&&(e="data:"+e),new Ar(e,i,r,n,o,a,l,t,s,h,void 0,void 0,c)}}function Rr(e,t,i,s){let r,n=1;1===s?r=new Float32Array(t*i*4):2===s?(r=new Uint16Array(t*i*4),n=15360):r=7===s?new Uint32Array(t*i*4):new Uint8Array(t*i*4);for(let s=0;s<t;s++)for(let o=0;o<i;o++){const i=3*(o*t+s),a=4*(o*t+s);r[a+0]=e[i+0],r[a+1]=e[i+1],r[a+2]=e[i+2],r[a+3]=n}return r}function Ir(e){return function(t,i,s,r,n,o,a,l,h=null,c=0){const u=e?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,d=e?ut.Raw3D:ut.Raw2DArray,p=new dt(this,d);p.baseWidth=i,p.baseHeight=s,p.baseDepth=r,p.width=i,p.height=s,p.depth=r,p.format=n,p.type=c,p.generateMipMaps=o,p.samplingMode=l,e?p.is3D=!0:p.is2DArray=!0,this._doNotHandleContextLost||(p._bufferView=t),e?this.updateRawTexture3D(p,t,n,a,h,c):this.updateRawTexture2DArray(p,t,n,a,h,c),this._bindTextureDirectly(u,p,!0);const _=this._getSamplingParameters(l,o);return this._gl.texParameteri(u,this._gl.TEXTURE_MAG_FILTER,_.mag),this._gl.texParameteri(u,this._gl.TEXTURE_MIN_FILTER,_.min),o&&this._gl.generateMipmap(u),this._bindTextureDirectly(u,null),this._internalTexturesCache.push(p),p}}function Pr(e){return function(t,i,s,r,n=null,o=0){const a=e?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,l=this._getWebGLTextureType(o),h=this._getInternalFormat(s),c=this._getRGBABufferInternalSizedFormat(o,s);this._bindTextureDirectly(a,t,!0),this._unpackFlipY(void 0===r||!!r),this._doNotHandleContextLost||(t._bufferView=i,t.format=s,t.invertY=r,t._compression=n),t.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),n&&i?this._gl.compressedTexImage3D(a,0,this.getCaps().s3tc[n],t.width,t.height,t.depth,0,i):this._gl.texImage3D(a,0,c,t.width,t.height,t.depth,0,h,l,i),t.generateMipMaps&&this._gl.generateMipmap(a),this._bindTextureDirectly(a,null),t.isReady=!0}}Ar.SerializeBuffers=!0,Ar.ForceSerializeBuffers=!1,Ar.OnTextureLoadErrorObservable=new a,Ar._SerializeInternalTextureUniqueId=!1,Ar._CubeTextureParser=(e,t,i)=>{throw $("CubeTexture")},Ar._CreateMirror=(e,t,i,s)=>{throw $("MirrorTexture")},Ar._CreateRenderTargetTexture=(e,t,i,s,r)=>{throw $("RenderTargetTexture")},Ar.NEAREST_SAMPLINGMODE=1,Ar.NEAREST_NEAREST_MIPLINEAR=8,Ar.BILINEAR_SAMPLINGMODE=2,Ar.LINEAR_LINEAR_MIPNEAREST=11,Ar.TRILINEAR_SAMPLINGMODE=3,Ar.LINEAR_LINEAR_MIPLINEAR=3,Ar.NEAREST_NEAREST_MIPNEAREST=4,Ar.NEAREST_LINEAR_MIPNEAREST=5,Ar.NEAREST_LINEAR_MIPLINEAR=6,Ar.NEAREST_LINEAR=7,Ar.NEAREST_NEAREST=1,Ar.LINEAR_NEAREST_MIPNEAREST=9,Ar.LINEAR_NEAREST_MIPLINEAR=10,Ar.LINEAR_LINEAR=2,Ar.LINEAR_NEAREST=12,Ar.EXPLICIT_MODE=0,Ar.SPHERICAL_MODE=1,Ar.PLANAR_MODE=2,Ar.CUBIC_MODE=3,Ar.PROJECTION_MODE=4,Ar.SKYBOX_MODE=5,Ar.INVCUBIC_MODE=6,Ar.EQUIRECTANGULAR_MODE=7,Ar.FIXED_EQUIRECTANGULAR_MODE=8,Ar.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,Ar.CLAMP_ADDRESSMODE=0,Ar.WRAP_ADDRESSMODE=1,Ar.MIRROR_ADDRESSMODE=2,Ar.UseSerializedUrlIfAny=!1,me([ie()],Ar.prototype,"url",void 0),me([ie()],Ar.prototype,"uOffset",void 0),me([ie()],Ar.prototype,"vOffset",void 0),me([ie()],Ar.prototype,"uScale",void 0),me([ie()],Ar.prototype,"vScale",void 0),me([ie()],Ar.prototype,"uAng",void 0),me([ie()],Ar.prototype,"vAng",void 0),me([ie()],Ar.prototype,"wAng",void 0),me([ie()],Ar.prototype,"uRotationCenter",void 0),me([ie()],Ar.prototype,"vRotationCenter",void 0),me([ie()],Ar.prototype,"wRotationCenter",void 0),me([ie()],Ar.prototype,"homogeneousRotationInUVTransform",void 0),me([ie()],Ar.prototype,"isBlocking",null),m("BABYLON.Texture",Ar),de._TextureParser=Ar.Parse,bt.prototype.updateRawTexture=function(e,t,i,s,r=null,n=0,o=!1){if(!e)return;const a=this._getRGBABufferInternalSizedFormat(n,i,o),l=this._getInternalFormat(i),h=this._getWebGLTextureType(n);this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._unpackFlipY(void 0===s||!!s),this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.type=n,e.invertY=s,e._compression=r),e.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),r&&t?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[r],e.width,e.height,0,t):this._gl.texImage2D(this._gl.TEXTURE_2D,0,a,e.width,e.height,0,l,h,t),e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),e.isReady=!0},bt.prototype.createRawTexture=function(e,t,i,s,r,n,o,a=null,l=0,h=0,c=!1){const u=new dt(this,ut.Raw);u.baseWidth=t,u.baseHeight=i,u.width=t,u.height=i,u.format=s,u.generateMipMaps=r,u.samplingMode=o,u.invertY=n,u._compression=a,u.type=l,u._useSRGBBuffer=this._getUseSRGBBuffer(c,!r),this._doNotHandleContextLost||(u._bufferView=e),this.updateRawTexture(u,e,s,n,a,l,u._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,u,!0);const d=this._getSamplingParameters(o,r);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,d.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,d.min),r&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(u),u},bt.prototype.createRawCubeTexture=function(e,t,i,s,r,n,o,a=null){const l=this._gl,h=new dt(this,ut.CubeRaw);h.isCube=!0,h.format=i,h.type=s,this._doNotHandleContextLost||(h._bufferViewArray=e);const c=this._getWebGLTextureType(s);let u=this._getInternalFormat(i);u===l.RGB&&(u=l.RGBA),c!==l.FLOAT||this._caps.textureFloatLinearFiltering?c!==this._gl.HALF_FLOAT_OES||this._caps.textureHalfFloatLinearFiltering?c!==l.FLOAT||this._caps.textureFloatRender?c!==l.HALF_FLOAT||this._caps.colorBufferFloat||(r=!1,k.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(r=!1,k.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(r=!1,o=1,k.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(r=!1,o=1,k.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively."));const d=t,p=d;if(h.width=d,h.height=p,h.invertY=n,h._compression=a,!this.needPOTTextures||Ht.IsExponentOfTwo(h.width)&&Ht.IsExponentOfTwo(h.height)||(r=!1),e)this.updateRawCubeTexture(h,e,i,s,n,a);else{const e=this._getRGBABufferInternalSizedFormat(s),t=0;this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,h,!0);for(let i=0;i<6;i++)a?l.compressedTexImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+i,t,this.getCaps().s3tc[a],h.width,h.height,0,void 0):l.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+i,t,e,h.width,h.height,0,u,c,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,h,!0),e&&r&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const _=this._getSamplingParameters(o,r);return l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,_.mag),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,_.min),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null),h.generateMipMaps=r,h.samplingMode=o,h.isReady=!0,h},bt.prototype.updateRawCubeTexture=function(e,t,i,s,r,n=null,o=0){e._bufferViewArray=t,e.format=i,e.type=s,e.invertY=r,e._compression=n;const a=this._gl,l=this._getWebGLTextureType(s);let h=this._getInternalFormat(i);const c=this._getRGBABufferInternalSizedFormat(s);let u=!1;h===a.RGB&&(h=a.RGBA,u=!0),this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,e,!0),this._unpackFlipY(void 0===r||!!r),e.width%4!=0&&a.pixelStorei(a.UNPACK_ALIGNMENT,1);for(let i=0;i<6;i++){let r=t[i];n?a.compressedTexImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+i,o,this.getCaps().s3tc[n],e.width,e.height,0,r):(u&&(r=Rr(r,e.width,e.height,s)),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+i,o,c,e.width,e.height,0,h,l,r))}(!this.needPOTTextures||Ht.IsExponentOfTwo(e.width)&&Ht.IsExponentOfTwo(e.height))&&e.generateMipMaps&&0===o&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),e.isReady=!0},bt.prototype.createRawCubeTextureFromUrl=function(e,t,i,s,r,n,o,a,l=null,h=null,c=3,u=!1){const d=this._gl,p=this.createRawCubeTexture(null,i,s,r,!n,u,c,null);null==t||t.addPendingData(p),p.url=e,p.isReady=!1,this._internalTexturesCache.push(p);const _=e=>{const i=p.width,n=o(e);if(n){if(a){const e=this._getWebGLTextureType(r);let t=this._getInternalFormat(s);const o=this._getRGBABufferInternalSizedFormat(r);let l=!1;t===d.RGB&&(t=d.RGBA,l=!0),this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,p,!0),this._unpackFlipY(!1);const h=a(n);for(let s=0;s<h.length;s++){const n=i>>s;for(let i=0;i<6;i++){let a=h[s][i];l&&(a=Rr(a,n,n,r)),d.texImage2D(i,s,o,n,n,0,t,e,a)}}this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(p,n,s,r,u);p.isReady=!0,null==t||t.removePendingData(p),p.onLoadedObservable.notifyObservers(p),p.onLoadedObservable.clear(),l&&l()}};return this._loadFile(e,(e=>{_(e)}),void 0,null==t?void 0:t.offlineProvider,!0,((e,i)=>{null==t||t.removePendingData(p),h&&e&&h(e.status+" "+e.statusText,i)})),p},bt.prototype.createRawTexture2DArray=Ir(!1),bt.prototype.createRawTexture3D=Ir(!0),bt.prototype.updateRawTexture2DArray=Pr(!1),bt.prototype.updateRawTexture3D=Pr(!0);class Mr extends Ar{constructor(e,t,i,s,r,n=!0,o=!1,a=3,l=0,h,c){super(null,r,!n,o,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,h),this.format=s,this._engine&&(this._engine._caps.textureFloatLinearFiltering||1!==l||(a=1),this._engine._caps.textureHalfFloatLinearFiltering||2!==l||(a=1),this._texture=this._engine.createRawTexture(e,t,i,s,n,o,a,null,l,null!=h?h:0,null!=c&&c),this.wrapU=Ar.CLAMP_ADDRESSMODE,this.wrapV=Ar.CLAMP_ADDRESSMODE)}update(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer)}static CreateLuminanceTexture(e,t,i,s,r=!0,n=!1,o=3){return new Mr(e,t,i,1,s,r,n,o)}static CreateLuminanceAlphaTexture(e,t,i,s,r=!0,n=!1,o=3){return new Mr(e,t,i,2,s,r,n,o)}static CreateAlphaTexture(e,t,i,s,r=!0,n=!1,o=3){return new Mr(e,t,i,0,s,r,n,o)}static CreateRGBTexture(e,t,i,s,r=!0,n=!1,o=3,a=0,l=0,h=!1){return new Mr(e,t,i,4,s,r,n,o,a,l,h)}static CreateRGBATexture(e,t,i,s,r=!0,n=!1,o=3,a=0,l=0,h=!1){return new Mr(e,t,i,5,s,r,n,o,a,l,h)}static CreateRGBAStorageTexture(e,t,i,s,r=!0,n=!1,o=3,a=0,l=!1){return new Mr(e,t,i,5,s,r,n,o,a,1,l)}static CreateRTexture(e,t,i,s,r=!0,n=!1,o=Ar.TRILINEAR_SAMPLINGMODE,a=1){return new Mr(e,t,i,6,s,r,n,o,a)}static CreateRStorageTexture(e,t,i,s,r=!0,n=!1,o=Ar.TRILINEAR_SAMPLINGMODE,a=1){return new Mr(e,t,i,6,s,r,n,o,a,1)}}class Or{constructor(){this._zoomStopsAnimation=!1,this._idleRotationSpeed=.05,this._idleRotationWaitTime=2e3,this._idleRotationSpinupTime=2e3,this.targetAlpha=null,this._isPointerDown=!1,this._lastFrameTime=null,this._lastInteractionTime=-1/0,this._cameraRotationSpeed=0,this._lastFrameRadius=0}get name(){return"AutoRotation"}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set idleRotationSpeed(e){this._idleRotationSpeed=e}get idleRotationSpeed(){return this._idleRotationSpeed}set idleRotationWaitTime(e){this._idleRotationWaitTime=e}get idleRotationWaitTime(){return this._idleRotationWaitTime}set idleRotationSpinupTime(e){this._idleRotationSpinupTime=e}get idleRotationSpinupTime(){return this._idleRotationSpinupTime}get rotationInProgress(){return Math.abs(this._cameraRotationSpeed)>0}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();this._onPrePointerObservableObserver=t.onPrePointerObservable.add((e=>{e.type!==gi.POINTERDOWN?e.type===gi.POINTERUP&&(this._isPointerDown=!1):this._isPointerDown=!0})),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add((()=>{if(this._reachTargetAlpha())return;const e=Fe.Now;let t=0;null!=this._lastFrameTime&&(t=e-this._lastFrameTime),this._lastFrameTime=e,this._applyUserInteraction();const i=e-this._lastInteractionTime-this._idleRotationWaitTime,s=Math.max(Math.min(i/this._idleRotationSpinupTime,1),0);this._cameraRotationSpeed=this._idleRotationSpeed*s,this._attachedCamera&&(this._attachedCamera.alpha-=this._cameraRotationSpeed*(t/1e3))}))}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._attachedCamera=null}resetLastInteractionTime(e){this._lastInteractionTime=null!=e?e:Fe.Now}_reachTargetAlpha(){return!(!this._attachedCamera||!this.targetAlpha)&&Math.abs(this._attachedCamera.alpha-this.targetAlpha)<u}_userIsZooming(){return!!this._attachedCamera&&0!==this._attachedCamera.inertialRadiusOffset}_shouldAnimationStopForInteraction(){if(!this._attachedCamera)return!1;let e=!1;return this._lastFrameRadius===this._attachedCamera.radius&&0!==this._attachedCamera.inertialRadiusOffset&&(e=!0),this._lastFrameRadius=this._attachedCamera.radius,this._zoomStopsAnimation?e:this._userIsZooming()}_applyUserInteraction(){this._userIsMoving()&&!this._shouldAnimationStopForInteraction()&&(this._lastInteractionTime=Fe.Now)}_userIsMoving(){return!!this._attachedCamera&&(0!==this._attachedCamera.inertialAlphaOffset||0!==this._attachedCamera.inertialBetaOffset||0!==this._attachedCamera.inertialRadiusOffset||0!==this._attachedCamera.inertialPanningX||0!==this._attachedCamera.inertialPanningY||this._isPointerDown)}}class Dr{constructor(){this.transitionDuration=450,this.lowerRadiusTransitionRange=2,this.upperRadiusTransitionRange=-2,this._autoTransitionRange=!1,this._radiusIsAnimating=!1,this._radiusBounceTransition=null,this._animatables=new Array}get name(){return"Bouncing"}get autoTransitionRange(){return this._autoTransitionRange}set autoTransitionRange(e){if(this._autoTransitionRange===e)return;this._autoTransitionRange=e;const t=this._attachedCamera;t&&(e?this._onMeshTargetChangedObserver=t.onMeshTargetChangedObservable.add((e=>{if(!e)return;e.computeWorldMatrix(!0);const t=e.getBoundingInfo().diagonalLength;this.lowerRadiusTransitionRange=.05*t,this.upperRadiusTransitionRange=.05*t})):this._onMeshTargetChangedObserver&&t.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver))}init(){}attach(e){this._attachedCamera=e,this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add((()=>{this._attachedCamera&&(this._isRadiusAtLimit(this._attachedCamera.lowerRadiusLimit)&&this._applyBoundRadiusAnimation(this.lowerRadiusTransitionRange),this._isRadiusAtLimit(this._attachedCamera.upperRadiusLimit)&&this._applyBoundRadiusAnimation(this.upperRadiusTransitionRange))}))}detach(){this._attachedCamera&&(this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null)}_isRadiusAtLimit(e){return!!this._attachedCamera&&this._attachedCamera.radius===e&&!this._radiusIsAnimating}_applyBoundRadiusAnimation(e){if(!this._attachedCamera)return;this._radiusBounceTransition||(Dr.EasingFunction.setEasingMode(Dr.EasingMode),this._radiusBounceTransition=Ie.CreateAnimation("radius",Ie.ANIMATIONTYPE_FLOAT,60,Dr.EasingFunction)),this._cachedWheelPrecision=this._attachedCamera.wheelPrecision,this._attachedCamera.wheelPrecision=1/0,this._attachedCamera.inertialRadiusOffset=0,this.stopAllAnimations(),this._radiusIsAnimating=!0;const t=Ie.TransitionTo("radius",this._attachedCamera.radius+e,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,(()=>this._clearAnimationLocks()));t&&this._animatables.push(t)}_clearAnimationLocks(){this._radiusIsAnimating=!1,this._attachedCamera&&(this._attachedCamera.wheelPrecision=this._cachedWheelPrecision)}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0].onAnimationEnd=null,this._animatables[0].stop(),this._animatables.shift()}}Dr.EasingFunction=new class extends ts{constructor(e=1){super(),this.amplitude=e}easeInCore(e){const t=Math.max(0,this.amplitude);return Math.pow(e,3)-e*t*Math.sin(3.141592653589793*e)}}(.3),Dr.EasingMode=ts.EASINGMODE_EASEOUT;class Nr{constructor(){this.onTargetFramingAnimationEndObservable=new a,this._mode=Nr.FitFrustumSidesMode,this._radiusScale=1,this._positionScale=.5,this._defaultElevation=.3,this._elevationReturnTime=1500,this._elevationReturnWaitTime=1e3,this._zoomStopsAnimation=!1,this._framingTime=1500,this.autoCorrectCameraLimitsAndSensibility=!0,this._isPointerDown=!1,this._lastInteractionTime=-1/0,this._animatables=new Array,this._betaIsAnimating=!1}get name(){return"Framing"}set mode(e){this._mode=e}get mode(){return this._mode}set radiusScale(e){this._radiusScale=e}get radiusScale(){return this._radiusScale}set positionScale(e){this._positionScale=e}get positionScale(){return this._positionScale}set defaultElevation(e){this._defaultElevation=e}get defaultElevation(){return this._defaultElevation}set elevationReturnTime(e){this._elevationReturnTime=e}get elevationReturnTime(){return this._elevationReturnTime}set elevationReturnWaitTime(e){this._elevationReturnWaitTime=e}get elevationReturnWaitTime(){return this._elevationReturnWaitTime}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set framingTime(e){this._framingTime=e}get framingTime(){return this._framingTime}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();Nr.EasingFunction.setEasingMode(Nr.EasingMode),this._onPrePointerObservableObserver=t.onPrePointerObservable.add((e=>{e.type!==gi.POINTERDOWN?e.type===gi.POINTERUP&&(this._isPointerDown=!1):this._isPointerDown=!0})),this._onMeshTargetChangedObserver=e.onMeshTargetChangedObservable.add((e=>{e&&this.zoomOnMesh(e,void 0,(()=>{this.onTargetFramingAnimationEndObservable.notifyObservers()}))})),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add((()=>{this._applyUserInteraction(),this._maintainCameraAboveGround()}))}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null}zoomOnMesh(e,t=!1,i=null){e.computeWorldMatrix(!0);const s=e.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(s.minimumWorld,s.maximumWorld,t,i)}zoomOnMeshHierarchy(e,t=!1,i=null){e.computeWorldMatrix(!0);const s=e.getHierarchyBoundingVectors(!0);this.zoomOnBoundingInfo(s.min,s.max,t,i)}zoomOnMeshesHierarchy(e,t=!1,i=null){const s=new S(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r=new S(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let t=0;t<e.length;t++){const i=e[t].getHierarchyBoundingVectors(!0);S.CheckExtends(i.min,s,r),S.CheckExtends(i.max,s,r)}this.zoomOnBoundingInfo(s,r,t,i)}zoomOnBoundingInfo(e,t,i=!1,s=null){let r;if(!this._attachedCamera)return!1;const n=e.y,o=n+(t.y-n)*this._positionScale,a=t.subtract(e).scale(.5);if(i)r=new S(0,o,0);else{const t=e.add(a);r=new S(t.x,o,t.z)}this._vectorTransition||(this._vectorTransition=Ie.CreateAnimation("target",Ie.ANIMATIONTYPE_VECTOR3,60,Nr.EasingFunction)),this._betaIsAnimating=!0;let l=Ie.TransitionTo("target",r,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime);l&&this._animatables.push(l);let h=0;if(this._mode===Nr.FitFrustumSidesMode){const i=this._calculateLowerRadiusFromModelBoundingSphere(e,t);this.autoCorrectCameraLimitsAndSensibility&&(this._attachedCamera.lowerRadiusLimit=a.length()+this._attachedCamera.minZ),h=i}else this._mode===Nr.IgnoreBoundsSizeMode&&(h=this._calculateLowerRadiusFromModelBoundingSphere(e,t),this.autoCorrectCameraLimitsAndSensibility&&null===this._attachedCamera.lowerRadiusLimit&&(this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ));if(this.autoCorrectCameraLimitsAndSensibility){const i=t.subtract(e).length();this._attachedCamera.panningSensibility=5e3/i,this._attachedCamera.wheelPrecision=100/h}return this._radiusTransition||(this._radiusTransition=Ie.CreateAnimation("radius",Ie.ANIMATIONTYPE_FLOAT,60,Nr.EasingFunction)),l=Ie.TransitionTo("radius",h,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,(()=>{this.stopAllAnimations(),s&&s(),this._attachedCamera&&this._attachedCamera.useInputToRestoreState&&this._attachedCamera.storeState()})),l&&this._animatables.push(l),!0}_calculateLowerRadiusFromModelBoundingSphere(e,t){const i=this._attachedCamera;if(!i)return 0;let s=i._calculateLowerRadiusFromModelBoundingSphere(e,t,this._radiusScale);return i.lowerRadiusLimit&&this._mode===Nr.IgnoreBoundsSizeMode&&(s=s<i.lowerRadiusLimit?i.lowerRadiusLimit:s),i.upperRadiusLimit&&(s=s>i.upperRadiusLimit?i.upperRadiusLimit:s),s}_maintainCameraAboveGround(){if(this._elevationReturnTime<0)return;const e=Fe.Now-this._lastInteractionTime,t=.5*Math.PI-this._defaultElevation,i=.5*Math.PI;if(this._attachedCamera&&!this._betaIsAnimating&&this._attachedCamera.beta>i&&e>=this._elevationReturnWaitTime){this._betaIsAnimating=!0,this.stopAllAnimations(),this._betaTransition||(this._betaTransition=Ie.CreateAnimation("beta",Ie.ANIMATIONTYPE_FLOAT,60,Nr.EasingFunction));const e=Ie.TransitionTo("beta",t,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,(()=>{this._clearAnimationLocks(),this.stopAllAnimations()}));e&&this._animatables.push(e)}}_clearAnimationLocks(){this._betaIsAnimating=!1}_applyUserInteraction(){this.isUserIsMoving&&(this._lastInteractionTime=Fe.Now,this.stopAllAnimations(),this._clearAnimationLocks())}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0]&&(this._animatables[0].onAnimationEnd=null,this._animatables[0].stop()),this._animatables.shift()}get isUserIsMoving(){return!!this._attachedCamera&&(0!==this._attachedCamera.inertialAlphaOffset||0!==this._attachedCamera.inertialBetaOffset||0!==this._attachedCamera.inertialRadiusOffset||0!==this._attachedCamera.inertialPanningX||0!==this._attachedCamera.inertialPanningY||this._isPointerDown)}}Nr.EasingFunction=new class extends ts{constructor(e=2){super(),this.exponent=e}easeInCore(e){return this.exponent<=0?e:(Math.exp(this.exponent*e)-1)/(Math.exp(this.exponent)-1)}},Nr.EasingMode=ts.EASINGMODE_EASEINOUT,Nr.IgnoreBoundsSizeMode=0,Nr.FitFrustumSidesMode=1;class Fr{constructor(e,t,i=Number.MAX_VALUE){this.origin=e,this.direction=t,this.length=i}clone(){return new Fr(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(e,t,i=0){const s=Fr._TmpVector3[0].copyFromFloats(e.x-i,e.y-i,e.z-i),r=Fr._TmpVector3[1].copyFromFloats(t.x+i,t.y+i,t.z+i);let n,o,a,l,h=0,c=Number.MAX_VALUE;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<s.x||this.origin.x>r.x)return!1}else if(n=1/this.direction.x,o=(s.x-this.origin.x)*n,a=(r.x-this.origin.x)*n,a===-1/0&&(a=1/0),o>a&&(l=o,o=a,a=l),h=Math.max(o,h),c=Math.min(a,c),h>c)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<s.y||this.origin.y>r.y)return!1}else if(n=1/this.direction.y,o=(s.y-this.origin.y)*n,a=(r.y-this.origin.y)*n,a===-1/0&&(a=1/0),o>a&&(l=o,o=a,a=l),h=Math.max(o,h),c=Math.min(a,c),h>c)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<s.z||this.origin.z>r.z)return!1}else if(n=1/this.direction.z,o=(s.z-this.origin.z)*n,a=(r.z-this.origin.z)*n,a===-1/0&&(a=1/0),o>a&&(l=o,o=a,a=l),h=Math.max(o,h),c=Math.min(a,c),h>c)return!1;return!0}intersectsBox(e,t=0){return this.intersectsBoxMinMax(e.minimum,e.maximum,t)}intersectsSphere(e,t=0){const i=e.center.x-this.origin.x,s=e.center.y-this.origin.y,r=e.center.z-this.origin.z,n=i*i+s*s+r*r,o=e.radius+t,a=o*o;if(n<=a)return!0;const l=i*this.direction.x+s*this.direction.y+r*this.direction.z;return!(l<0)&&n-l*l<=a}intersectsTriangle(e,t,i){const s=Fr._TmpVector3[0],r=Fr._TmpVector3[1],n=Fr._TmpVector3[2],o=Fr._TmpVector3[3],a=Fr._TmpVector3[4];t.subtractToRef(e,s),i.subtractToRef(e,r),S.CrossToRef(this.direction,r,n);const l=S.Dot(s,n);if(0===l)return null;const h=1/l;this.origin.subtractToRef(e,o);const c=S.Dot(o,n)*h;if(c<0||c>1)return null;S.CrossToRef(o,s,a);const u=S.Dot(this.direction,a)*h;if(u<0||c+u>1)return null;const d=S.Dot(r,a)*h;return d>this.length?null:new _s(1-c-u,c,d)}intersectsPlane(e){let t;const i=S.Dot(e.normal,this.direction);if(Math.abs(i)<9.99999997475243e-7)return null;{const s=S.Dot(e.normal,this.origin);return t=(-e.d-s)/i,t<0?t<-9.99999997475243e-7?null:0:t}}intersectsAxis(e,t=0){switch(e){case"y":{const e=(this.origin.y-t)/this.direction.y;return e>0?null:new S(this.origin.x+this.direction.x*-e,t,this.origin.z+this.direction.z*-e)}case"x":{const e=(this.origin.x-t)/this.direction.x;return e>0?null:new S(t,this.origin.y+this.direction.y*-e,this.origin.z+this.direction.z*-e)}case"z":{const e=(this.origin.z-t)/this.direction.z;return e>0?null:new S(this.origin.x+this.direction.x*-e,this.origin.y+this.direction.y*-e,t)}default:return null}}intersectsMesh(e,t,i,s=!1,r,n=!1){const o=R.Matrix[0];return e.getWorldMatrix().invertToRef(o),this._tmpRay?Fr.TransformToRef(this,o,this._tmpRay):this._tmpRay=Fr.Transform(this,o),e.intersects(this._tmpRay,t,i,s,r,n)}intersectsMeshes(e,t,i){i?i.length=0:i=[];for(let s=0;s<e.length;s++){const r=this.intersectsMesh(e[s],t);r.hit&&i.push(r)}return i.sort(this._comparePickingInfo),i}_comparePickingInfo(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}intersectionSegment(e,t,i){const s=this.origin,r=R.Vector3[0],n=R.Vector3[1],o=R.Vector3[2],a=R.Vector3[3];t.subtractToRef(e,r),this.direction.scaleToRef(Fr._Rayl,o),s.addToRef(o,n),e.subtractToRef(s,a);const l=S.Dot(r,r),h=S.Dot(r,o),c=S.Dot(o,o),u=S.Dot(r,a),d=S.Dot(o,a),p=l*c-h*h;let _,f,m=p,g=p;p<Fr._Smallnum?(_=0,m=1,f=d,g=c):(_=h*d-c*u,f=l*d-h*u,_<0?(_=0,f=d,g=c):_>m&&(_=m,f=d+h,g=c)),f<0?(f=0,-u<0?_=0:-u>l?_=m:(_=-u,m=l)):f>g&&(f=g,-u+h<0?_=0:-u+h>l?_=m:(_=-u+h,m=l));const v=Math.abs(_)<Fr._Smallnum?0:_/m,x=Math.abs(f)<Fr._Smallnum?0:f/g,T=R.Vector3[4];o.scaleToRef(x,T);const E=R.Vector3[5];r.scaleToRef(v,E),E.addInPlace(a);const b=R.Vector3[6];return E.subtractToRef(T,b),x>0&&x<=this.length&&b.lengthSquared()<i*i?E.length():-1}update(e,t,i,s,r,n,o,a=!1){if(a){Fr._RayDistant||(Fr._RayDistant=Fr.Zero()),Fr._RayDistant.unprojectRayToRef(e,t,i,s,y.IdentityReadOnly,n,o);const a=R.Matrix[0];r.invertToRef(a),Fr.TransformToRef(Fr._RayDistant,a,this)}else this.unprojectRayToRef(e,t,i,s,r,n,o);return this}static Zero(){return new Fr(S.Zero(),S.Zero())}static CreateNew(e,t,i,s,r,n,o){return Fr.Zero().update(e,t,i,s,r,n,o)}static CreateNewFromTo(e,t,i=y.IdentityReadOnly){const s=t.subtract(e),r=Math.sqrt(s.x*s.x+s.y*s.y+s.z*s.z);return s.normalize(),Fr.Transform(new Fr(e,s,r),i)}static Transform(e,t){const i=new Fr(new S(0,0,0),new S(0,0,0));return Fr.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){S.TransformCoordinatesToRef(e.origin,t,i.origin),S.TransformNormalToRef(e.direction,t,i.direction),i.length=e.length;const s=i.direction,r=s.length();if(0!==r&&1!==r){const e=1/r;s.x*=e,s.y*=e,s.z*=e,i.length*=r}}unprojectRayToRef(e,t,i,s,r,n,o){const a=R.Matrix[0];r.multiplyToRef(n,a),a.multiplyToRef(o,a),a.invert();const l=x.LastCreatedEngine,h=R.Vector3[0];h.x=e/i*2-1,h.y=-(t/s*2-1),h.z=(null==l?void 0:l.useReverseDepthBuffer)?1:(null==l?void 0:l.isNDCHalfZRange)?0:-1;const c=R.Vector3[1].copyFromFloats(h.x,h.y,1-1e-8),u=R.Vector3[2],d=R.Vector3[3];S._UnprojectFromInvertedMatrixToRef(h,a,u),S._UnprojectFromInvertedMatrixToRef(c,a,d),this.origin.copyFrom(u),d.subtractToRef(u,this.direction),this.direction.normalize()}}Fr._TmpVector3=d.BuildArray(6,S.Zero),Fr._RayDistant=Fr.Zero(),Fr._Smallnum=1e-8,Fr._Rayl=1e9,Yi.prototype.createPickingRay=function(e,t,i,s,r=!1){const n=Fr.Zero();return this.createPickingRayToRef(e,t,i,n,s,r),n},Yi.prototype.createPickingRayToRef=function(e,t,i,s,r,n=!1,o=!1){const a=this.getEngine();if(!r&&!(r=this.activeCamera))return this;const l=r.viewport,h=a.getRenderHeight(),{x:c,y:u,width:d,height:p}=l.toGlobal(a.getRenderWidth(),h),_=1/a.getHardwareScalingLevel();return e=e*_-c,t=t*_-(h-u-p),s.update(e,t,d,p,i||y.IdentityReadOnly,n?y.IdentityReadOnly:r.getViewMatrix(),r.getProjectionMatrix(),o),this},Yi.prototype.createPickingRayInCameraSpace=function(e,t,i){const s=Fr.Zero();return this.createPickingRayInCameraSpaceToRef(e,t,s,i),s},Yi.prototype.createPickingRayInCameraSpaceToRef=function(e,t,i,s){if(!ci)return this;const r=this.getEngine();if(!s&&!(s=this.activeCamera))throw new Error("Active camera not set");const n=s.viewport,o=r.getRenderHeight(),{x:a,y:l,width:h,height:c}=n.toGlobal(r.getRenderWidth(),o),u=y.Identity(),d=1/r.getHardwareScalingLevel();return e=e*d-a,t=t*d-(o-l-c),i.update(e,t,h,c,u,u,s.getProjectionMatrix()),this},Yi.prototype._internalPickForMesh=function(e,t,i,s,r,n,o,a){const l=t(s,i.enableDistantPicking),h=i.intersects(l,r,o,n,s,a);return h&&h.hit?!r&&null!=e&&h.distance>=e.distance?null:h:null},Yi.prototype._internalPick=function(e,t,i,s,r){let n=null;const o=!!(this.activeCameras&&this.activeCameras.length>1&&this.cameraToUseForPointers!==this.activeCamera),a=this.cameraToUseForPointers||this.activeCamera;for(let l=0;l<this.meshes.length;l++){const h=this.meshes[l];if(t){if(!t(h))continue}else if(!h.isEnabled()||!h.isVisible||!h.isPickable)continue;const c=o&&h.isWorldMatrixCameraDependent(),u=h.computeWorldMatrix(c,a);if(h.hasThinInstances&&h.thinInstanceEnablePicking){const t=this._internalPickForMesh(n,e,h,u,!0,!0,r);if(t){if(s)return t;const o=R.Matrix[1],a=h.thinInstanceGetWorldMatrices();for(let t=0;t<a.length;t++){a[t].multiplyToRef(u,o);const l=this._internalPickForMesh(n,e,h,o,i,s,r,!0);if(l&&(n=l,n.thinInstanceIndex=t,i))return n}}}else{const t=this._internalPickForMesh(n,e,h,u,i,s,r);if(t&&(n=t,i))return n}}return n||new ci},Yi.prototype._internalMultiPick=function(e,t,i){if(!ci)return null;const s=[],r=!!(this.activeCameras&&this.activeCameras.length>1&&this.cameraToUseForPointers!==this.activeCamera),n=this.cameraToUseForPointers||this.activeCamera;for(let o=0;o<this.meshes.length;o++){const a=this.meshes[o];if(t){if(!t(a))continue}else if(!a.isEnabled()||!a.isVisible||!a.isPickable)continue;const l=r&&a.isWorldMatrixCameraDependent(),h=a.computeWorldMatrix(l,n);if(a.hasThinInstances&&a.thinInstanceEnablePicking){if(this._internalPickForMesh(null,e,a,h,!0,!0,i)){const t=R.Matrix[1],r=a.thinInstanceGetWorldMatrices();for(let n=0;n<r.length;n++){r[n].multiplyToRef(h,t);const o=this._internalPickForMesh(null,e,a,t,!1,!1,i,!0);o&&(o.thinInstanceIndex=n,s.push(o))}}}else{const t=this._internalPickForMesh(null,e,a,h,!1,!1,i);t&&s.push(t)}}return s},Yi.prototype.pickWithBoundingInfo=function(e,t,i,s,r){if(!ci)return null;const n=this._internalPick((i=>(this._tempPickingRay||(this._tempPickingRay=Fr.Zero()),this.createPickingRayToRef(e,t,i,this._tempPickingRay,r||null),this._tempPickingRay)),i,s,!0);return n&&(n.ray=this.createPickingRay(e,t,y.Identity(),r||null)),n},Object.defineProperty(Yi.prototype,"_pickingAvailable",{get:()=>!0,enumerable:!1,configurable:!1}),Yi.prototype.pick=function(e,t,i,s,r,n,o=!1){const a=this._internalPick(((i,s)=>(this._tempPickingRay||(this._tempPickingRay=Fr.Zero()),this.createPickingRayToRef(e,t,i,this._tempPickingRay,r||null,!1,s),this._tempPickingRay)),i,s,!1,n);return a&&(a.ray=this.createPickingRay(e,t,y.Identity(),r||null)),a},Yi.prototype.pickWithRay=function(e,t,i,s){const r=this._internalPick((t=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=y.Identity()),t.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=Fr.Zero()),Fr.TransformToRef(e,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform)),t,i,!1,s);return r&&(r.ray=e),r},Yi.prototype.multiPick=function(e,t,i,s,r){return this._internalMultiPick((i=>this.createPickingRay(e,t,i,s||null)),i,r)},Yi.prototype.multiPickWithRay=function(e,t,i){return this._internalMultiPick((t=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=y.Identity()),t.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=Fr.Zero()),Fr.TransformToRef(e,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform)),t,i)},ps.prototype.getForwardRay=function(e=100,t,i){return this.getForwardRayToRef(new Fr(S.Zero(),S.Zero(),e),e,t,i)},ps.prototype.getForwardRayToRef=function(e,t=100,i,s){i||(i=this.getWorldMatrix()),e.length=t,s?e.origin.copyFrom(s):e.origin.copyFrom(this.position);const r=R.Vector3[2];r.set(0,0,this._scene.useRightHandedSystem?-1:1);const n=R.Vector3[3];return S.TransformNormalToRef(r,i,n),S.NormalizeToRef(n,e.direction),e};class wr{static _RemoveAndStorePivotPoint(e){e&&0===wr._PivotCached&&(e.getPivotPointToRef(wr._OldPivotPoint),wr._PivotPostMultiplyPivotMatrix=e._postMultiplyPivotMatrix,wr._OldPivotPoint.equalsToFloats(0,0,0)||(e.setPivotMatrix(y.IdentityReadOnly),wr._OldPivotPoint.subtractToRef(e.getPivotPoint(),wr._PivotTranslation),wr._PivotTmpVector.copyFromFloats(1,1,1),wr._PivotTmpVector.subtractInPlace(e.scaling),wr._PivotTmpVector.multiplyInPlace(wr._PivotTranslation),e.position.addInPlace(wr._PivotTmpVector))),wr._PivotCached++}static _RestorePivotPoint(e){e&&!wr._OldPivotPoint.equalsToFloats(0,0,0)&&1===wr._PivotCached&&(e.setPivotPoint(wr._OldPivotPoint),e._postMultiplyPivotMatrix=wr._PivotPostMultiplyPivotMatrix,wr._PivotTmpVector.copyFromFloats(1,1,1),wr._PivotTmpVector.subtractInPlace(e.scaling),wr._PivotTmpVector.multiplyInPlace(wr._PivotTranslation),e.position.subtractInPlace(wr._PivotTmpVector)),this._PivotCached--}}function Lr(e){const t=[],i=[],s=[],r=[],n=e.width||e.size||1,o=e.height||e.size||1,a=0===e.sideOrientation?0:e.sideOrientation||As.DEFAULTSIDE,l=n/2,h=o/2;i.push(-l,-h,0),s.push(0,0,-1),r.push(0,Is.UseOpenGLOrientationForUV?1:0),i.push(l,-h,0),s.push(0,0,-1),r.push(1,Is.UseOpenGLOrientationForUV?1:0),i.push(l,h,0),s.push(0,0,-1),r.push(1,Is.UseOpenGLOrientationForUV?0:1),i.push(-l,h,0),s.push(0,0,-1),r.push(0,Is.UseOpenGLOrientationForUV?0:1),t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),As._ComputeSides(a,i,t,s,r,e.frontUVs,e.backUVs);const c=new As;return c.indices=t,c.positions=i,c.normals=s,c.uvs=r,c}function Br(e,t={},i=null){const s=new ur(e,i);return t.sideOrientation=ur._GetDefaultSideOrientation(t.sideOrientation),s._originalBuilderSideOrientation=t.sideOrientation,Lr(t).applyToMesh(s,t.updatable),t.sourcePlane&&(s.translate(t.sourcePlane.normal,-t.sourcePlane.d),s.setDirection(t.sourcePlane.normal.scale(-1))),s}wr._PivotCached=0,wr._OldPivotPoint=new S,wr._PivotTranslation=new S,wr._PivotTmpVector=new S,wr._PivotPostMultiplyPivotMatrix=!1,As.CreatePlane=Lr,ur.CreatePlane=(e,t,i,s,r)=>Br(e,{size:t,width:t,height:t,sideOrientation:r,updatable:s},i);class Ur{get currentDraggingPointerID(){return this.currentDraggingPointerId}set currentDraggingPointerID(e){this.currentDraggingPointerId=e}set enabled(e){e!=this._enabled&&this.onEnabledObservable.notifyObservers(e),this._enabled=e}get enabled(){return this._enabled}get options(){return this._options}set options(e){this._options=e}constructor(e){this._useAlternatePickedPointAboveMaxDragAngleDragSpeed=-1.1,this._activeDragButton=-1,this.maxDragAngle=0,this.dragButtons=[0,1,2],this._useAlternatePickedPointAboveMaxDragAngle=!1,this.currentDraggingPointerId=-1,this.dragging=!1,this.dragDeltaRatio=.2,this.updateDragPlane=!0,this._debugMode=!1,this._moving=!1,this.onDragObservable=new a,this.onDragStartObservable=new a,this.onDragEndObservable=new a,this.onEnabledObservable=new a,this.moveAttached=!0,this._enabled=!0,this.startAndReleaseDragOnPointerEvents=!0,this.detachCameraControls=!0,this.useObjectOrientationForDragging=!0,this.validateDrag=e=>!0,this._tmpVector=new S(0,0,0),this._alternatePickedPoint=new S(0,0,0),this._worldDragAxis=new S(0,0,0),this._targetPosition=new S(0,0,0),this._attachedToElement=!1,this._startDragRay=new Fr(new S,new S),this._lastPointerRay={},this._dragDelta=new S,this._pointA=new S(0,0,0),this._pointC=new S(0,0,0),this._localAxis=new S(0,0,0),this._lookAt=new S(0,0,0),this._options=e||{};let t=0;if(this._options.dragAxis&&t++,this._options.dragPlaneNormal&&t++,t>1)throw"Multiple drag modes specified in dragBehavior options. Only one expected"}get name(){return"PointerDrag"}init(){}attach(e,t){this._scene=e.getScene(),e.isNearGrabbable=!0,this.attachedNode=e,Ur._PlaneScene||(this._debugMode?Ur._PlaneScene=this._scene:(Ur._PlaneScene=new Yi(this._scene.getEngine(),{virtual:!0}),Ur._PlaneScene.detachControl(),this._scene.onDisposeObservable.addOnce((()=>{Ur._PlaneScene.dispose(),Ur._PlaneScene=null})))),this._dragPlane=Br("pointerDragPlane",{size:this._debugMode?1:1e4,updatable:!1,sideOrientation:ur.DOUBLESIDE},Ur._PlaneScene),this.lastDragPosition=new S(0,0,0);const i=t||(e=>this.attachedNode==e||e.isDescendantOf(this.attachedNode));this._pointerObserver=this._scene.onPointerObservable.add((e=>{if(this.enabled){if(e.type==gi.POINTERDOWN)this.startAndReleaseDragOnPointerEvents&&!this.dragging&&e.pickInfo&&e.pickInfo.hit&&e.pickInfo.pickedMesh&&e.pickInfo.pickedPoint&&e.pickInfo.ray&&i(e.pickInfo.pickedMesh)&&-1===this._activeDragButton&&-1!==this.dragButtons.indexOf(e.event.button)&&(this._activeDragButton=e.event.button,this._activePointerInfo=e,this._startDrag(e.event.pointerId,e.pickInfo.ray,e.pickInfo.pickedPoint));else if(e.type==gi.POINTERUP)!this.startAndReleaseDragOnPointerEvents||this.currentDraggingPointerId!=e.event.pointerId||this._activeDragButton!==e.event.button&&-1!==this._activeDragButton||this.releaseDrag();else if(e.type==gi.POINTERMOVE){const t=e.event.pointerId;if(this.currentDraggingPointerId===Ur._AnyMouseId&&t!==Ur._AnyMouseId){const i=e.event;("mouse"===i.pointerType||!this._scene.getEngine().hostInformation.isMobile&&i instanceof MouseEvent)&&(this._lastPointerRay[this.currentDraggingPointerId]&&(this._lastPointerRay[t]=this._lastPointerRay[this.currentDraggingPointerId],delete this._lastPointerRay[this.currentDraggingPointerId]),this.currentDraggingPointerId=t)}this._lastPointerRay[t]||(this._lastPointerRay[t]=new Fr(new S,new S)),e.pickInfo&&e.pickInfo.ray&&(this._lastPointerRay[t].origin.copyFrom(e.pickInfo.ray.origin),this._lastPointerRay[t].direction.copyFrom(e.pickInfo.ray.direction),this.currentDraggingPointerId==t&&this.dragging&&this._moveDrag(e.pickInfo.ray))}}else this._attachedToElement&&this.releaseDrag()})),this._beforeRenderObserver=this._scene.onBeforeRenderObservable.add((()=>{if(this._moving&&this.moveAttached){let e=!1;wr._RemoveAndStorePivotPoint(this.attachedNode),this._targetPosition.subtractToRef(this.attachedNode.absolutePosition,this._tmpVector),this._tmpVector.scaleInPlace(this.dragDeltaRatio),this.attachedNode.getAbsolutePosition().addToRef(this._tmpVector,this._tmpVector),this.validateDrag(this._tmpVector)&&(this.attachedNode.setAbsolutePosition(this._tmpVector),e=!0),wr._RestorePivotPoint(this.attachedNode),e&&this.attachedNode.computeWorldMatrix()}}))}releaseDrag(){if(this.dragging&&(this.dragging=!1,this.onDragEndObservable.notifyObservers({dragPlanePoint:this.lastDragPosition,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo})),this.currentDraggingPointerId=-1,this._activeDragButton=-1,this._activePointerInfo=null,this._moving=!1,this.detachCameraControls&&this._attachedToElement&&this._scene.activeCamera&&!this._scene.activeCamera.leftCamera){if("ArcRotateCamera"===this._scene.activeCamera.getClassName()){const e=this._scene.activeCamera;e.attachControl(!e.inputs||e.inputs.noPreventDefault,e._useCtrlForPanning,e._panningMouseButton)}else this._scene.activeCamera.attachControl(!this._scene.activeCamera.inputs||this._scene.activeCamera.inputs.noPreventDefault);this._attachedToElement=!1}}startDrag(e=Ur._AnyMouseId,t,i){this._startDrag(e,t,i);let s=this._lastPointerRay[e];e===Ur._AnyMouseId&&(s=this._lastPointerRay[Object.keys(this._lastPointerRay)[0]]),s&&this._moveDrag(s)}_startDrag(e,t,i){if(!this._scene.activeCamera||this.dragging||!this.attachedNode)return;wr._RemoveAndStorePivotPoint(this.attachedNode),t?(this._startDragRay.direction.copyFrom(t.direction),this._startDragRay.origin.copyFrom(t.origin)):(this._startDragRay.origin.copyFrom(this._scene.activeCamera.position),this.attachedNode.getWorldMatrix().getTranslationToRef(this._tmpVector),this._tmpVector.subtractToRef(this._scene.activeCamera.position,this._startDragRay.direction)),this._updateDragPlanePosition(this._startDragRay,i||this._tmpVector);const s=this._pickWithRayOnDragPlane(this._startDragRay);s?(this.dragging=!0,this.currentDraggingPointerId=e,this.lastDragPosition.copyFrom(s),this.onDragStartObservable.notifyObservers({dragPlanePoint:s,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo}),this._targetPosition.copyFrom(this.attachedNode.getAbsolutePosition()),this.detachCameraControls&&this._scene.activeCamera&&this._scene.activeCamera.inputs&&!this._scene.activeCamera.leftCamera&&(this._scene.activeCamera.inputs.attachedToElement?(this._scene.activeCamera.detachControl(),this._attachedToElement=!0):this._attachedToElement=!1)):this.releaseDrag(),wr._RestorePivotPoint(this.attachedNode)}_moveDrag(e){this._moving=!0;const t=this._pickWithRayOnDragPlane(e);if(t){wr._RemoveAndStorePivotPoint(this.attachedNode),this.updateDragPlane&&this._updateDragPlanePosition(e,t);let i=0;this._options.dragAxis?(this.useObjectOrientationForDragging?S.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._worldDragAxis):this._worldDragAxis.copyFrom(this._options.dragAxis),t.subtractToRef(this.lastDragPosition,this._tmpVector),i=S.Dot(this._tmpVector,this._worldDragAxis),this._worldDragAxis.scaleToRef(i,this._dragDelta)):(i=this._dragDelta.length(),t.subtractToRef(this.lastDragPosition,this._dragDelta)),this._targetPosition.addInPlace(this._dragDelta),this.onDragObservable.notifyObservers({dragDistance:i,delta:this._dragDelta,dragPlanePoint:t,dragPlaneNormal:this._dragPlane.forward,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo}),this.lastDragPosition.copyFrom(t),wr._RestorePivotPoint(this.attachedNode)}}_pickWithRayOnDragPlane(e){if(!e)return null;let t=Math.acos(S.Dot(this._dragPlane.forward,e.direction));if(t>Math.PI/2&&(t=Math.PI-t),this.maxDragAngle>0&&t>this.maxDragAngle){if(this._useAlternatePickedPointAboveMaxDragAngle){this._tmpVector.copyFrom(e.direction),this.attachedNode.absolutePosition.subtractToRef(e.origin,this._alternatePickedPoint),this._alternatePickedPoint.normalize(),this._alternatePickedPoint.scaleInPlace(this._useAlternatePickedPointAboveMaxDragAngleDragSpeed*S.Dot(this._alternatePickedPoint,this._tmpVector)),this._tmpVector.addInPlace(this._alternatePickedPoint);const t=S.Dot(this._dragPlane.forward,this._tmpVector);return this._dragPlane.forward.scaleToRef(-t,this._alternatePickedPoint),this._alternatePickedPoint.addInPlace(this._tmpVector),this._alternatePickedPoint.addInPlace(this.attachedNode.absolutePosition),this._alternatePickedPoint}return null}const i=this._dragPlane.forward,s=this._dragPlane.position,r=e.direction.dot(i);if(Math.abs(r)<u)return null;s.subtractToRef(e.origin,R.Vector3[0]);const n=R.Vector3[0].dot(i)/r;return n<0?null:(e.direction.scaleToRef(n,R.Vector3[0]),e.origin.add(R.Vector3[0]))}_updateDragPlanePosition(e,t){this._pointA.copyFrom(t),this._options.dragAxis?(this.useObjectOrientationForDragging?S.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragAxis),e.origin.subtractToRef(this._pointA,this._pointC),this._pointC.normalize(),Math.abs(S.Dot(this._localAxis,this._pointC))>.999?Math.abs(S.Dot(S.UpReadOnly,this._pointC))>.999?this._lookAt.copyFrom(S.Right()):this._lookAt.copyFrom(S.UpReadOnly):(S.CrossToRef(this._localAxis,this._pointC,this._lookAt),S.CrossToRef(this._localAxis,this._lookAt,this._lookAt),this._lookAt.normalize()),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._lookAt,this._lookAt),this._dragPlane.lookAt(this._lookAt)):this._options.dragPlaneNormal?(this.useObjectOrientationForDragging?S.TransformCoordinatesToRef(this._options.dragPlaneNormal,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragPlaneNormal),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._localAxis,this._lookAt),this._dragPlane.lookAt(this._lookAt)):(this._dragPlane.position.copyFrom(this._pointA),this._dragPlane.lookAt(e.origin)),this._dragPlane.position.copyFrom(this.attachedNode.getAbsolutePosition()),this._dragPlane.computeWorldMatrix(!0)}detach(){this._lastPointerRay={},this.attachedNode&&(this.attachedNode.isNearGrabbable=!1),this._pointerObserver&&this._scene.onPointerObservable.remove(this._pointerObserver),this._beforeRenderObserver&&this._scene.onBeforeRenderObservable.remove(this._beforeRenderObserver),this._dragPlane&&this._dragPlane.dispose(),this.releaseDrag()}}Ur._AnyMouseId=-2;class Vr{}Vr.ANCHOR_SYSTEM="xr-anchor-system",Vr.BACKGROUND_REMOVER="xr-background-remover",Vr.HIT_TEST="xr-hit-test",Vr.MESH_DETECTION="xr-mesh-detection",Vr.PHYSICS_CONTROLLERS="xr-physics-controller",Vr.PLANE_DETECTION="xr-plane-detection",Vr.POINTER_SELECTION="xr-controller-pointer-selection",Vr.TELEPORTATION="xr-controller-teleportation",Vr.FEATURE_POINTS="xr-feature-points",Vr.HAND_TRACKING="xr-hand-tracking",Vr.IMAGE_TRACKING="xr-image-tracking",Vr.NEAR_INTERACTION="xr-near-interaction",Vr.DOM_OVERLAY="xr-dom-overlay",Vr.MOVEMENT="xr-controller-movement",Vr.LIGHT_ESTIMATION="xr-light-estimation",Vr.EYE_TRACKING="xr-eye-tracking",Vr.WALKING_LOCOMOTION="xr-walking-locomotion",Vr.LAYERS="xr-layers",Vr.DEPTH_SENSING="xr-depth-sensing",Vr.SPACE_WARP="xr-space-warp",Vr.RAW_CAMERA_ACCESS="xr-raw-camera-access";class kr{constructor(e){this._xrSessionManager=e,this._features={},this._xrSessionManager.onXRSessionInit.add((()=>{this.getEnabledFeatures().forEach((e=>{const t=this._features[e];!t.enabled||t.featureImplementation.attached||t.featureImplementation.disableAutoAttach||this.attachFeature(e)}))})),this._xrSessionManager.onXRSessionEnded.add((()=>{this.getEnabledFeatures().forEach((e=>{const t=this._features[e];t.enabled&&t.featureImplementation.attached&&this.detachFeature(e)}))}))}static AddWebXRFeature(e,t,i=1,s=!1){this._AvailableFeatures[e]=this._AvailableFeatures[e]||{latest:i},i>this._AvailableFeatures[e].latest&&(this._AvailableFeatures[e].latest=i),s&&(this._AvailableFeatures[e].stable=i),this._AvailableFeatures[e][i]=t}static ConstructFeature(e,t=1,i,s){const r=this._AvailableFeatures[e][t];if(!r)throw new Error("feature not found");return r(i,s)}static GetAvailableFeatures(){return Object.keys(this._AvailableFeatures)}static GetAvailableVersions(e){return Object.keys(this._AvailableFeatures[e])}static GetLatestVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].latest||-1}static GetStableVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].stable||-1}attachFeature(e){const t=this._features[e];t&&t.enabled&&!t.featureImplementation.attached&&t.featureImplementation.attach()}detachFeature(e){const t=this._features[e];t&&t.featureImplementation.attached&&t.featureImplementation.detach()}disableFeature(e){const t="string"==typeof e?e:e.Name,i=this._features[t];return!(!i||!i.enabled||(i.enabled=!1,this.detachFeature(t),i.featureImplementation.dispose(),delete this._features[t],0))}dispose(){this.getEnabledFeatures().forEach((e=>{this.disableFeature(e)}))}enableFeature(e,t="latest",i={},s=!0,r=!0){const n="string"==typeof e?e:e.Name;let o=0;if("string"==typeof t){if(!t)throw new Error(`Error in provided version - ${n} (${t})`);if(o="stable"===t?kr.GetStableVersionOfFeature(n):"latest"===t?kr.GetLatestVersionOfFeature(n):+t,-1===o||isNaN(o))throw new Error(`feature not found - ${n} (${t})`)}else o=t;const a=kr._ConflictingFeatures[n];if(void 0!==a&&-1!==this.getEnabledFeatures().indexOf(a))throw new Error(`Feature ${n} cannot be enabled while ${a} is enabled.`);const l=this._features[n],h=kr.ConstructFeature(n,o,this._xrSessionManager,i);if(!h)throw new Error(`feature not found - ${n}`);l&&this.disableFeature(n);const c=h();if(c.dependsOn){const e=c.dependsOn.every((e=>!!this._features[e]));if(!e)throw new Error(`Dependant features missing. Make sure the following features are enabled - ${c.dependsOn.join(", ")}`)}if(c.isCompatible())return this._features[n]={featureImplementation:c,enabled:!0,version:o,required:r},s?this._xrSessionManager.session&&!this._features[n].featureImplementation.attached&&this.attachFeature(n):this._features[n].featureImplementation.disableAutoAttach=!0,this._features[n].featureImplementation;if(r)throw new Error("required feature not compatible");return Ht.Warn(`Feature ${n} not compatible with the current environment/browser and was not enabled.`),c}getEnabledFeature(e){return this._features[e]&&this._features[e].featureImplementation}getEnabledFeatures(){return Object.keys(this._features)}async _extendXRSessionInitObject(e){const t=this.getEnabledFeatures();for(const i of t){const t=this._features[i],s=t.featureImplementation.xrNativeFeatureName;if(s&&(t.required?(e.requiredFeatures=e.requiredFeatures||[],-1===e.requiredFeatures.indexOf(s)&&e.requiredFeatures.push(s)):(e.optionalFeatures=e.optionalFeatures||[],-1===e.optionalFeatures.indexOf(s)&&e.optionalFeatures.push(s))),t.featureImplementation.getXRSessionInitExtension){const i=await t.featureImplementation.getXRSessionInitExtension();e=Object.assign(Object.assign({},e),i)}}return e}}kr._AvailableFeatures={},kr._ConflictingFeatures={[Vr.TELEPORTATION]:Vr.MOVEMENT,[Vr.MOVEMENT]:Vr.TELEPORTATION};class Gr{constructor(e){this._xrSessionManager=e,this._attached=!1,this._removeOnDetach=[],this.isDisposed=!1,this.disableAutoAttach=!1,this.xrNativeFeatureName="",this.onFeatureAttachObservable=new a,this.onFeatureDetachObservable=new a}get attached(){return this._attached}attach(e){if(this.isDisposed)return!1;if(e)this.attached&&this.detach();else if(this.attached)return!1;return this._attached=!0,this._addNewAttachObserver(this._xrSessionManager.onXRFrameObservable,(e=>this._onXRFrame(e))),this.onFeatureAttachObservable.notifyObservers(this),!0}detach(){return this._attached?(this._attached=!1,this._removeOnDetach.forEach((e=>{e.observable.remove(e.observer)})),this.onFeatureDetachObservable.notifyObservers(this),!0):(this.disableAutoAttach=!0,!1)}dispose(){this.detach(),this.isDisposed=!0,this.onFeatureAttachObservable.clear(),this.onFeatureDetachObservable.clear()}isCompatible(){return!0}_addNewAttachObserver(e,t){this._removeOnDetach.push({observable:e,observer:e.add(t)})}}class zr{constructor(e,t){this.type=e,this.jointData=t,t.nativeParams=t.nativeParams||{}}get physicsJoint(){return this._physicsJoint}set physicsJoint(e){this._physicsJoint,this._physicsJoint=e}set physicsPlugin(e){this._physicsPlugin=e}executeNativeFunction(e){e(this._physicsPlugin.world,this._physicsJoint)}}zr.DistanceJoint=0,zr.HingeJoint=1,zr.BallAndSocketJoint=2,zr.WheelJoint=3,zr.SliderJoint=4,zr.PrismaticJoint=5,zr.UniversalJoint=6,zr.Hinge2Joint=zr.WheelJoint,zr.PointToPointJoint=8,zr.SpringJoint=9,zr.LockJoint=10,ur._PhysicsImpostorParser=function(e,t,i){return new Wr(t,i.physicsImpostor,{mass:i.physicsMass,friction:i.physicsFriction,restitution:i.physicsRestitution},e)};class Wr{get isDisposed(){return this._isDisposed}get mass(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyMass(this):0}set mass(e){this.setMass(e)}get friction(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyFriction(this):0}set friction(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,e)}get restitution(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this):0}set restitution(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,e)}get pressure(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.setBodyPressure?e.getBodyPressure(this):0}set pressure(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyPressure&&t.setBodyPressure(this,e)}get stiffness(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyStiffness?e.getBodyStiffness(this):0}set stiffness(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyStiffness&&t.setBodyStiffness(this,e)}get velocityIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyVelocityIterations?e.getBodyVelocityIterations(this):0}set velocityIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyVelocityIterations&&t.setBodyVelocityIterations(this,e)}get positionIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyPositionIterations?e.getBodyPositionIterations(this):0}set positionIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyPositionIterations&&t.setBodyPositionIterations(this,e)}constructor(e,t,i={mass:0},s){this.object=e,this.type=t,this._options=i,this._scene=s,this._pluginData={},this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=new Array,this._onAfterPhysicsStepCallbacks=new Array,this._onPhysicsCollideCallbacks=[],this._deltaPosition=S.Zero(),this._isDisposed=!1,this.soft=!1,this.segments=0,this._tmpQuat=new C,this._tmpQuat2=new C,this.beforeStep=()=>{this._physicsEngine&&(this.object.translate(this._deltaPosition,-1),this._deltaRotationConjugated&&this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotationConjugated,this.object.rotationQuaternion),this.object.computeWorldMatrix(!1),this.object.parent&&this.object.rotationQuaternion?(this.getParentsRotation(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this._tmpQuat)):this._tmpQuat.copyFrom(this.object.rotationQuaternion||new C),this._options.disableBidirectionalTransformation||this.object.rotationQuaternion&&this._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(this,this.object.getAbsolutePosition(),this._tmpQuat),this._onBeforePhysicsStepCallbacks.forEach((e=>{e(this)})))},this.afterStep=()=>{this._physicsEngine&&(this._onAfterPhysicsStepCallbacks.forEach((e=>{e(this)})),this._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(this),this.object.parent&&this.object.rotationQuaternion&&(this.getParentsRotation(),this._tmpQuat.conjugateInPlace(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this.object.rotationQuaternion)),this.object.setAbsolutePosition(this.object.position),this._deltaRotation?(this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotation,this.object.rotationQuaternion),this._deltaPosition.applyRotationQuaternionToRef(this._deltaRotation,Wr._TmpVecs[0]),this.object.translate(Wr._TmpVecs[0],1)):this.object.translate(this._deltaPosition,1),this.object.computeWorldMatrix(!0))},this.onCollideEvent=null,this.onCollide=e=>{if(!this._onPhysicsCollideCallbacks.length&&!this.onCollideEvent)return;if(!this._physicsEngine)return;const t=this._physicsEngine.getImpostorWithPhysicsBody(e.body);t&&(this.onCollideEvent&&this.onCollideEvent(this,t),this._onPhysicsCollideCallbacks.filter((e=>-1!==e.otherImpostors.indexOf(t))).forEach((i=>{i.callback(this,t,e.point,e.distance,e.impulse,e.normal)})))},this.object?(this.object.parent&&0!==i.mass&&k.Warn("A physics impostor has been created for an object which has a parent. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&e.getScene&&(this._scene=e.getScene()),this._scene&&(this.type>100&&(this.soft=!0),this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotation?this.object.rotationQuaternion=C.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):this.object.rotationQuaternion=new C),this._options.mass=void 0===i.mass?0:i.mass,this._options.friction=void 0===i.friction?.2:i.friction,this._options.restitution=void 0===i.restitution?.2:i.restitution,this.soft&&(this._options.mass=this._options.mass>0?this._options.mass:1,this._options.pressure=void 0===i.pressure?200:i.pressure,this._options.stiffness=void 0===i.stiffness?1:i.stiffness,this._options.velocityIterations=void 0===i.velocityIterations?20:i.velocityIterations,this._options.positionIterations=void 0===i.positionIterations?20:i.positionIterations,this._options.fixedPoints=void 0===i.fixedPoints?0:i.fixedPoints,this._options.margin=void 0===i.margin?0:i.margin,this._options.damping=void 0===i.damping?0:i.damping,this._options.path=void 0===i.path?null:i.path,this._options.shape=void 0===i.shape?null:i.shape),this._joints=[],!this.object.parent||this._options.ignoreParent?this._init():this.object.parent.physicsImpostor&&k.Warn("You must affect impostors to children before affecting impostor to parent.")):k.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors."))):k.Error("No object was provided. A physics object is obligatory")}_init(){this._physicsEngine&&(this._physicsEngine.removeImpostor(this),this.physicsBody=null,this._parent=this._parent||this._getPhysicsParent(),this._isDisposed||this.parent&&!this._options.ignoreParent||this._physicsEngine.addImpostor(this))}_getPhysicsParent(){return this.object.parent instanceof Vs?this.object.parent.physicsImpostor:null}isBodyInitRequired(){return this._bodyUpdateRequired||!this._physicsBody&&(!this._parent||!!this._options.ignoreParent)}setScalingUpdated(){this.forceUpdate()}forceUpdate(){this._init(),this.parent&&!this._options.ignoreParent&&this.parent.forceUpdate()}get physicsBody(){return this._parent&&!this._options.ignoreParent?this._parent.physicsBody:this._physicsBody}get parent(){return!this._options.ignoreParent&&this._parent?this._parent:null}set parent(e){this._parent=e}set physicsBody(e){this._physicsBody&&this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this),this._physicsBody=e,this.resetUpdateFlags()}resetUpdateFlags(){this._bodyUpdateRequired=!1}getObjectExtents(){if(this.object.getBoundingInfo){const e=this.object.rotationQuaternion,t=this.object.scaling.clone();this.object.rotationQuaternion=Wr.IDENTITY_QUATERNION;const i=this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0);i&&i.decompose(t,void 0,void 0);const s=this.object.getBoundingInfo().boundingBox.extendSize.scale(2).multiplyInPlace(t);return s.x=Math.abs(s.x),s.y=Math.abs(s.y),s.z=Math.abs(s.z),this.object.rotationQuaternion=e,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),s}return Wr.DEFAULT_OBJECT_SIZE}getObjectCenter(){return this.object.getBoundingInfo?this.object.getBoundingInfo().boundingBox.centerWorld:this.object.position}getParam(e){return this._options[e]}setParam(e,t){this._options[e]=t,this._bodyUpdateRequired=!0}setMass(e){this.getParam("mass")!==e&&this.setParam("mass",e),this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyMass(this,e)}getLinearVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this):S.Zero()}setLinearVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,e)}getAngularVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this):S.Zero()}setAngularVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,e)}executeNativeFunction(e){this._physicsEngine&&e(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)}registerBeforePhysicsStep(e){this._onBeforePhysicsStepCallbacks.push(e)}unregisterBeforePhysicsStep(e){const t=this._onBeforePhysicsStepCallbacks.indexOf(e);t>-1?this._onBeforePhysicsStepCallbacks.splice(t,1):k.Warn("Function to remove was not found")}registerAfterPhysicsStep(e){this._onAfterPhysicsStepCallbacks.push(e)}unregisterAfterPhysicsStep(e){const t=this._onAfterPhysicsStepCallbacks.indexOf(e);t>-1?this._onAfterPhysicsStepCallbacks.splice(t,1):k.Warn("Function to remove was not found")}registerOnPhysicsCollide(e,t){const i=e instanceof Array?e:[e];this._onPhysicsCollideCallbacks.push({callback:t,otherImpostors:i})}unregisterOnPhysicsCollide(e,t){const i=e instanceof Array?e:[e];let s=-1;this._onPhysicsCollideCallbacks.some(((e,r)=>{if(e.callback===t&&e.otherImpostors.length===i.length){const t=e.otherImpostors.every((e=>i.indexOf(e)>-1));return t&&(s=r),t}return!1}))?this._onPhysicsCollideCallbacks.splice(s,1):k.Warn("Function to remove was not found")}getParentsRotation(){let e=this.object.parent;for(this._tmpQuat.copyFromFloats(0,0,0,1);e;)e.rotationQuaternion?this._tmpQuat2.copyFrom(e.rotationQuaternion):C.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,this._tmpQuat2),this._tmpQuat.multiplyToRef(this._tmpQuat2,this._tmpQuat),e=e.parent;return this._tmpQuat}applyForce(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyForce(this,e,t),this}applyImpulse(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyImpulse(this,e,t),this}createJoint(e,t,i){const s=new zr(t,i);return this.addJoint(e,s),this}addJoint(e,t){return this._joints.push({otherImpostor:e,joint:t}),this._physicsEngine&&this._physicsEngine.addJoint(this,e,t),this}addAnchor(e,t,i,s,r){if(!this._physicsEngine)return this;const n=this._physicsEngine.getPhysicsPlugin();return n.appendAnchor?(this._physicsEngine&&n.appendAnchor(this,e,t,i,s,r),this):this}addHook(e,t,i,s){if(!this._physicsEngine)return this;const r=this._physicsEngine.getPhysicsPlugin();return r.appendAnchor?(this._physicsEngine&&r.appendHook(this,e,t,i,s),this):this}sleep(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().sleepBody(this),this}wakeUp(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().wakeUpBody(this),this}clone(e){return e?new Wr(e,this.type,this._options,this._scene):null}dispose(){this._physicsEngine&&(this._joints.forEach((e=>{this._physicsEngine&&this._physicsEngine.removeJoint(this,e.otherImpostor,e.joint)})),this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate(),this._isDisposed=!0)}setDeltaPosition(e){this._deltaPosition.copyFrom(e)}setDeltaRotation(e){this._deltaRotation||(this._deltaRotation=new C),this._deltaRotation.copyFrom(e),this._deltaRotationConjugated=this._deltaRotation.conjugate()}getBoxSizeToRef(e){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,e),this}getRadius(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getRadius(this):0}syncBoneWithImpostor(e,t,i,s,r){const n=Wr._TmpVecs[0],o=this.object;if(o.rotationQuaternion)if(r){const i=Wr._TmpQuat;o.rotationQuaternion.multiplyToRef(r,i),e.setRotationQuaternion(i,Gi.WORLD,t)}else e.setRotationQuaternion(o.rotationQuaternion,Gi.WORLD,t);n.x=0,n.y=0,n.z=0,i&&(n.x=i.x,n.y=i.y,n.z=i.z,e.getDirectionToRef(n,t,n),null==s&&(s=i.length()),n.x*=s,n.y*=s,n.z*=s),e.getParent()?(n.addInPlace(o.getAbsolutePosition()),e.setAbsolutePosition(n,t)):(t.setAbsolutePosition(o.getAbsolutePosition()),t.position.x-=n.x,t.position.y-=n.y,t.position.z-=n.z)}syncImpostorWithBone(e,t,i,s,r,n){const o=this.object;if(o.rotationQuaternion)if(r){const i=Wr._TmpQuat;e.getRotationQuaternionToRef(Gi.WORLD,t,i),i.multiplyToRef(r,o.rotationQuaternion)}else e.getRotationQuaternionToRef(Gi.WORLD,t,o.rotationQuaternion);const a=Wr._TmpVecs[0],l=Wr._TmpVecs[1];n||((n=Wr._TmpVecs[2]).x=0,n.y=1,n.z=0),e.getDirectionToRef(n,t,l),e.getAbsolutePositionToRef(t,a),null==s&&i&&(s=i.length()),null!=s&&(a.x+=l.x*s,a.y+=l.y*s,a.z+=l.z*s),o.setAbsolutePosition(a)}}Wr.DEFAULT_OBJECT_SIZE=new S(1,1,1),Wr.IDENTITY_QUATERNION=C.Identity(),Wr._TmpVecs=d.BuildArray(3,S.Zero),Wr._TmpQuat=C.Identity(),Wr.NoImpostor=0,Wr.SphereImpostor=1,Wr.BoxImpostor=2,Wr.PlaneImpostor=3,Wr.MeshImpostor=4,Wr.CapsuleImpostor=6,Wr.CylinderImpostor=7,Wr.ParticleImpostor=8,Wr.HeightmapImpostor=9,Wr.ConvexHullImpostor=10,Wr.CustomImpostor=100,Wr.RopeImpostor=101,Wr.ClothImpostor=102,Wr.SoftbodyImpostor=103,function(e){e[e.Clean=0]="Clean",e[e.Stop=1]="Stop",e[e.Sync=2]="Sync",e[e.NoSync=3]="NoSync"}(Ks||(Ks={}));class Hr{static get ForceFullSceneLoadingForIncremental(){return Rs.ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){Rs.ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return Rs.ShowLoadingScreen}static set ShowLoadingScreen(e){Rs.ShowLoadingScreen=e}static get loggingLevel(){return Rs.loggingLevel}static set loggingLevel(e){Rs.loggingLevel=e}static get CleanBoneMatrixWeights(){return Rs.CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){Rs.CleanBoneMatrixWeights=e}static GetDefaultPlugin(){return Hr._RegisteredPlugins[".babylon"]}static _GetPluginForExtension(e){return Hr._RegisteredPlugins[e]||(k.Warn("Unable to find a plugin to load "+e+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),Hr.GetDefaultPlugin())}static _GetPluginForDirectLoad(e){for(const t in Hr._RegisteredPlugins){const i=Hr._RegisteredPlugins[t].plugin;if(i.canDirectLoad&&i.canDirectLoad(e))return Hr._RegisteredPlugins[t]}return Hr.GetDefaultPlugin()}static _GetPluginForFilename(e){const t=e.indexOf("?");-1!==t&&(e=e.substring(0,t));const i=e.lastIndexOf("."),s=e.substring(i,e.length).toLowerCase();return Hr._GetPluginForExtension(s)}static _GetDirectLoad(e){return"data:"===e.substr(0,5)?e.substr(5):null}static _FormatErrorMessage(e,t,i){let s="Unable to load from "+(e.rawData?"binary data":e.url);return t?s+=`: ${t}`:i&&(s+=`: ${i}`),s}static _LoadData(e,t,i,s,r,n,o,a){const l=Hr._GetDirectLoad(e.url);if(e.rawData&&!o)throw"When using ArrayBufferView to load data the file extension must be provided.";const h=o?Hr._GetPluginForExtension(o):l?Hr._GetPluginForDirectLoad(e.url):Hr._GetPluginForFilename(e.url);if(e.rawData&&!h.isBinary)throw"Loading from ArrayBufferView can not be used with plugins that don't support binary loading.";let c;if(c=void 0!==h.plugin.createPlugin?h.plugin.createPlugin():h.plugin,!c)throw"The loader plugin corresponding to the file type you are trying to load has not been found. If using es6, please import the plugin you wish to use before.";if(Hr.OnPluginActivatedObservable.notifyObservers(c),l&&(c.canDirectLoad&&c.canDirectLoad(e.url)||!Bt(e.url))){if(c.directLoad){const e=c.directLoad(t,l);e.then?e.then((e=>{i(c,e)})).catch((e=>{r("Error in directLoad of _loadData: "+e,e)})):i(c,e)}else i(c,l);return c}const u=h.isBinary,d=(e,s)=>{t.isDisposed?r("Scene has been disposed"):i(c,e,s)};let p=null,_=!1;const f=c.onDisposeObservable;f&&f.add((()=>{_=!0,p&&(p.abort(),p=null),n()}));const m=()=>{if(_)return;const i=(e,t)=>{r(null==e?void 0:e.statusText,t)};if(!c.loadFile&&e.rawData)throw"Plugin does not support loading ArrayBufferView.";p=c.loadFile?c.loadFile(t,e.rawData||e.file||e.url,e.rootUrl,d,s,u,i,a):t._loadFile(e.file||e.url,d,s,!0,u,i)},g=t.getEngine();let v=g.enableOfflineSupport;if(v){let i=!1;for(const s of t.disableOfflineSupportExceptionRules)if(s.test(e.url)){i=!0;break}v=!i}return v&&Ns.OfflineProviderFactory?t.offlineProvider=Ns.OfflineProviderFactory(e.url,m,g.disableManifestCheck):m(),c}static _GetFileInfo(e,t){let i,s,r=null,n=null;if(t)if(t.name){const e=t;i=`file:${e.name}`,s=e.name,r=e}else if(ArrayBuffer.isView(t))i="",s="arrayBuffer",n=t;else if("string"==typeof t&&t.startsWith("data:"))i=t,s="";else{const r=t;if("/"===r.substr(0,1))return Ht.Error("Wrong sceneFilename parameter"),null;i=e+r,s=r}else i=e,s=Ht.GetFilename(e),e=Ht.GetFolderPath(e);return{url:i,rootUrl:e,name:s,file:r,rawData:n}}static GetPluginForExtension(e){return Hr._GetPluginForExtension(e).plugin}static IsPluginForExtensionAvailable(e){return!!Hr._RegisteredPlugins[e]}static RegisterPlugin(e){if("string"==typeof e.extensions){const t=e.extensions;Hr._RegisteredPlugins[t.toLowerCase()]={plugin:e,isBinary:!1}}else{const t=e.extensions;Object.keys(t).forEach((i=>{Hr._RegisteredPlugins[i.toLowerCase()]={plugin:e,isBinary:t[i].isBinary}}))}}static ImportMesh(e,t,i="",s=x.LastCreatedScene,r=null,n=null,o=null,a=null,l=""){if(!s)return k.Error("No scene available to import mesh to"),null;const h=Hr._GetFileInfo(t,i);if(!h)return null;const c={};s.addPendingData(c);const u=()=>{s.removePendingData(c)},d=(e,t)=>{const i=Hr._FormatErrorMessage(h,e,t);o?o(s,i,new Ue(i,Be,t)):k.Error(i),u()},p=n?e=>{try{n(e)}catch(e){d("Error in onProgress callback: "+e,e)}}:void 0,_=(e,t,i,n,o,a,l)=>{if(s.importedMeshesFiles.push(h.url),r)try{r(e,t,i,n,o,a,l)}catch(e){d("Error in onSuccess callback: "+e,e)}s.removePendingData(c)};return Hr._LoadData(h,s,((t,i,r)=>{if(t.rewriteRootURL&&(h.rootUrl=t.rewriteRootURL(h.rootUrl,r)),t.importMesh){const r=[],n=[],o=[];if(!t.importMesh(e,s,i,h.rootUrl,r,n,o,d))return;s.loadingPluginName=t.name,_(r,n,o,[],[],[],[])}else t.importMeshAsync(e,s,i,h.rootUrl,p,h.name).then((e=>{s.loadingPluginName=t.name,_(e.meshes,e.particleSystems,e.skeletons,e.animationGroups,e.transformNodes,e.geometries,e.lights)})).catch((e=>{d(e.message,e)}))}),p,d,u,a,l)}static ImportMeshAsync(e,t,i="",s=x.LastCreatedScene,r=null,n=null,o=""){return new Promise(((a,l)=>{Hr.ImportMesh(e,t,i,s,((e,t,i,s,r,n,o)=>{a({meshes:e,particleSystems:t,skeletons:i,animationGroups:s,transformNodes:r,geometries:n,lights:o})}),r,((e,t,i)=>{l(i||new Error(t))}),n,o)}))}static Load(e,t="",i=x.LastCreatedEngine,s=null,r=null,n=null,o=null,a=""){return i?Hr.Append(e,t,new Yi(i),s,r,n,o,a):(Ht.Error("No engine available"),null)}static LoadAsync(e,t="",i=x.LastCreatedEngine,s=null,r=null,n=""){return new Promise(((o,a)=>{Hr.Load(e,t,i,(e=>{o(e)}),s,((e,t,i)=>{a(i||new Error(t))}),r,n)}))}static Append(e,t="",i=x.LastCreatedScene,s=null,r=null,n=null,o=null,a=""){if(!i)return k.Error("No scene available to append to"),null;const l=Hr._GetFileInfo(e,t);if(!l)return null;const h={};i.addPendingData(h);const c=()=>{i.removePendingData(h)};Hr.ShowLoadingScreen&&!this._ShowingLoadingScreen&&(this._ShowingLoadingScreen=!0,i.getEngine().displayLoadingUI(),i.executeWhenReady((()=>{i.getEngine().hideLoadingUI(),this._ShowingLoadingScreen=!1})));const u=(e,t)=>{const s=Hr._FormatErrorMessage(l,e,t);n?n(i,s,new Ue(s,Be,t)):k.Error(s),c()},d=r?e=>{try{r(e)}catch(e){u("Error in onProgress callback",e)}}:void 0,p=()=>{if(s)try{s(i)}catch(e){u("Error in onSuccess callback",e)}i.removePendingData(h)};return Hr._LoadData(l,i,((e,t)=>{if(e.load){if(!e.load(i,t,l.rootUrl,u))return;i.loadingPluginName=e.name,p()}else e.loadAsync(i,t,l.rootUrl,d,l.name).then((()=>{i.loadingPluginName=e.name,p()})).catch((e=>{u(e.message,e)}))}),d,u,c,o,a)}static AppendAsync(e,t="",i=x.LastCreatedScene,s=null,r=null,n=""){return new Promise(((o,a)=>{Hr.Append(e,t,i,(e=>{o(e)}),s,((e,t,i)=>{a(i||new Error(t))}),r,n)}))}static LoadAssetContainer(e,t="",i=x.LastCreatedScene,s=null,r=null,n=null,o=null,a=""){if(!i)return k.Error("No scene available to load asset container to"),null;const l=Hr._GetFileInfo(e,t);if(!l)return null;const h={};i.addPendingData(h);const c=()=>{i.removePendingData(h)},u=(e,t)=>{const s=Hr._FormatErrorMessage(l,e,t);n?n(i,s,new Ue(s,Be,t)):k.Error(s),c()},d=r?e=>{try{r(e)}catch(e){u("Error in onProgress callback",e)}}:void 0,p=e=>{if(s)try{s(e)}catch(e){u("Error in onSuccess callback",e)}i.removePendingData(h)};return Hr._LoadData(l,i,((e,t)=>{if(e.loadAssetContainer){const s=e.loadAssetContainer(i,t,l.rootUrl,u);if(!s)return;s.populateRootNodes(),i.loadingPluginName=e.name,p(s)}else e.loadAssetContainerAsync?e.loadAssetContainerAsync(i,t,l.rootUrl,d,l.name).then((t=>{t.populateRootNodes(),i.loadingPluginName=e.name,p(t)})).catch((e=>{u(e.message,e)})):u("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")}),d,u,c,o,a)}static LoadAssetContainerAsync(e,t="",i=x.LastCreatedScene,s=null,r=null){return new Promise(((n,o)=>{Hr.LoadAssetContainer(e,t,i,(e=>{n(e)}),s,((e,t,i)=>{o(i||new Error(t))}),r)}))}static ImportAnimations(e,t="",i=x.LastCreatedScene,s=!0,r=Ks.Clean,n=null,o=null,a=null,l=null,h=null){if(!i)return void k.Error("No scene available to load animations to");if(s){for(const e of i.animatables)e.reset();i.stopAllAnimations(),i.animationGroups.slice().forEach((e=>{e.dispose()})),i.getNodes().forEach((e=>{e.animations&&(e.animations=[])}))}else switch(r){case Ks.Clean:i.animationGroups.slice().forEach((e=>{e.dispose()}));break;case Ks.Stop:i.animationGroups.forEach((e=>{e.stop()}));break;case Ks.Sync:i.animationGroups.forEach((e=>{e.reset(),e.restart()}));break;case Ks.NoSync:break;default:return void k.Error("Unknown animation group loading mode value '"+r+"'")}const c=i.animatables.length;this.LoadAssetContainer(e,t,i,(e=>{e.mergeAnimationsTo(i,i.animatables.slice(c),n),e.dispose(),i.onAnimationFileImportedObservable.notifyObservers(i),o&&o(i)}),a,l,h)}static ImportAnimationsAsync(e,t="",i=x.LastCreatedScene,s=!0,r=Ks.Clean,n=null,o=null,a=null,l=null,h=null){return new Promise(((o,l)=>{Hr.ImportAnimations(e,t,i,s,r,n,(e=>{o(e)}),a,((e,t,i)=>{l(i||new Error(t))}),h)}))}}Hr.NO_LOGGING=0,Hr.MINIMAL_LOGGING=1,Hr.SUMMARY_LOGGING=2,Hr.DETAILED_LOGGING=3,Hr.OnPluginActivatedObservable=new a,Hr._RegisteredPlugins={},Hr._ShowingLoadingScreen=!1;class Xr extends sr{constructor(e,t,i=!0){super(e,t),this._normalMatrix=new y,this._storeEffectOnSubMeshes=i}getEffect(){return this._storeEffectOnSubMeshes?this._activeEffect:super.getEffect()}isReady(e,t){return!!e&&(!this._storeEffectOnSubMeshes||!e.subMeshes||0===e.subMeshes.length||this.isReadyForSubMesh(e,e.subMeshes[0],t))}_isReadyForSubMesh(e){const t=e.materialDefines;return!(this.checkReadyOnEveryCall||!e.effect||!t||t._renderId!==this.getScene().getRenderId())}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindOnlyNormalMatrix(e){this._activeEffect.setMatrix("normalMatrix",e)}bind(e,t){t&&this.bindForSubMesh(e,t,t.subMeshes[0])}_afterBind(e,t=null){super._afterBind(e,t),this.getScene()._cachedEffect=t,t&&(t._forceRebindOnNextCall=!1)}_mustRebind(e,t,i=1){return e.isCachedMaterialInvalid(this,t,i)}dispose(e,t,i){this._activeEffect=void 0,super.dispose(e,t,i)}}!function(e){e[e.Float=1]="Float",e[e.Int=2]="Int",e[e.Vector2=4]="Vector2",e[e.Vector3=8]="Vector3",e[e.Vector4=16]="Vector4",e[e.Color3=32]="Color3",e[e.Color4=64]="Color4",e[e.Matrix=128]="Matrix",e[e.Object=256]="Object",e[e.AutoDetect=1024]="AutoDetect",e[e.BasedOnInput=2048]="BasedOnInput",e[e.All=4095]="All"}($s||($s={})),function(e){e[e.Vertex=1]="Vertex",e[e.Fragment=2]="Fragment",e[e.Neutral=4]="Neutral",e[e.VertexAndFragment=3]="VertexAndFragment"}(qs||(qs={}));class Yr{constructor(){this.supportUniformBuffers=!1,this.attributes=[],this.uniforms=[],this.constants=[],this.samplers=[],this.functions={},this.extensions={},this.prePassOutput={},this.counters={},this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}finalize(e){const t=e.sharedData.emitComments,i=this.target===qs.Fragment;this.compilationString=`\n${t?"//Entry point\n":""}void main(void) {\n${this.compilationString}`,this._constantDeclaration&&(this.compilationString=`\n${t?"//Constants\n":""}${this._constantDeclaration}\n${this.compilationString}`);let s="";for(const e in this.functions)s+=this.functions[e]+"\n";this.compilationString=`\n${s}\n${this.compilationString}`,!i&&this._varyingTransfer&&(this.compilationString=`${this.compilationString}\n${this._varyingTransfer}`),this._injectAtEnd&&(this.compilationString=`${this.compilationString}\n${this._injectAtEnd}`),this.compilationString=`${this.compilationString}\n}`,this.sharedData.varyingDeclaration&&(this.compilationString=`\n${t?"//Varyings\n":""}${this.sharedData.varyingDeclaration}\n${this.compilationString}`),this._samplerDeclaration&&(this.compilationString=`\n${t?"//Samplers\n":""}${this._samplerDeclaration}\n${this.compilationString}`),this._uniformDeclaration&&(this.compilationString=`\n${t?"//Uniforms\n":""}${this._uniformDeclaration}\n${this.compilationString}`),this._attributeDeclaration&&!i&&(this.compilationString=`\n${t?"//Attributes\n":""}${this._attributeDeclaration}\n${this.compilationString}`),this.compilationString="precision highp float;\n"+this.compilationString,this.compilationString="#if defined(WEBGL2) || defines(WEBGPU)\nprecision highp sampler2DArray;\n#endif\n"+this.compilationString,i&&(this.compilationString="#if defined(PREPASS)\r\n#extension GL_EXT_draw_buffers : require\r\nlayout(location = 0) out highp vec4 glFragData[SCENE_MRT_COUNT];\r\nhighp vec4 gl_FragColor;\r\n#endif\r\n"+this.compilationString);for(const e in this.extensions){const t=this.extensions[e];this.compilationString=`\n${t}\n${this.compilationString}`}this._builtCompilationString=this.compilationString}get _repeatableContentAnchor(){return`###___ANCHOR${this._repeatableContentAnchorIndex++}___###`}_getFreeVariableName(e){return e=e.replace(/[^a-zA-Z_]+/g,""),void 0===this.sharedData.variableNames[e]?(this.sharedData.variableNames[e]=0,"output"===e||"texture"===e?e+this.sharedData.variableNames[e]:e):(this.sharedData.variableNames[e]++,e+this.sharedData.variableNames[e])}_getFreeDefineName(e){return void 0===this.sharedData.defineNames[e]?this.sharedData.defineNames[e]=0:this.sharedData.defineNames[e]++,e+this.sharedData.defineNames[e]}_excludeVariableName(e){this.sharedData.variableNames[e]=0}_emit2DSampler(e){this.samplers.indexOf(e)<0&&(this._samplerDeclaration+=`uniform sampler2D ${e};\n`,this.samplers.push(e))}_emit2DArraySampler(e){this.samplers.indexOf(e)<0&&(this._samplerDeclaration+=`uniform sampler2DArray ${e};\n`,this.samplers.push(e))}_getGLType(e){switch(e){case $s.Float:return"float";case $s.Int:return"int";case $s.Vector2:return"vec2";case $s.Color3:case $s.Vector3:return"vec3";case $s.Color4:case $s.Vector4:return"vec4";case $s.Matrix:return"mat4"}return""}_emitExtension(e,t,i=""){this.extensions[e]||(i&&(t=`#if ${i}\n${t}\n#endif`),this.extensions[e]=t)}_emitFunction(e,t,i){this.functions[e]||(this.sharedData.emitComments&&(t=i+"\n"+t),this.functions[e]=t)}_emitCodeFromInclude(e,t,i){if(i&&i.repeatKey)return`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]\n`;let s=ot.IncludesShadersStore[e]+"\n";if(this.sharedData.emitComments&&(s=t+"\n"+s),!i)return s;if(i.replaceStrings)for(let e=0;e<i.replaceStrings.length;e++){const t=i.replaceStrings[e];s=s.replace(t.search,t.replace)}return s}_emitFunctionFromInclude(e,t,i,s=""){const r=e+s;if(!this.functions[r]){if(!i||!(i.removeAttributes||i.removeUniforms||i.removeVaryings||i.removeIfDef||i.replaceStrings))return i&&i.repeatKey?this.functions[r]=`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]\n`:this.functions[r]=`#include<${e}>${(null==i?void 0:i.substitutionVars)?"("+(null==i?void 0:i.substitutionVars)+")":""}\n`,void(this.sharedData.emitComments&&(this.functions[r]=t+"\n"+this.functions[r]));if(this.functions[r]=ot.IncludesShadersStore[e],this.sharedData.emitComments&&(this.functions[r]=t+"\n"+this.functions[r]),i.removeIfDef&&(this.functions[r]=this.functions[r].replace(/^\s*?#ifdef.+$/gm,""),this.functions[r]=this.functions[r].replace(/^\s*?#endif.*$/gm,""),this.functions[r]=this.functions[r].replace(/^\s*?#else.*$/gm,""),this.functions[r]=this.functions[r].replace(/^\s*?#elif.*$/gm,"")),i.removeAttributes&&(this.functions[r]=this.functions[r].replace(/\s*?attribute .+?;/g,"\n")),i.removeUniforms&&(this.functions[r]=this.functions[r].replace(/\s*?uniform .*?;/g,"\n")),i.removeVaryings&&(this.functions[r]=this.functions[r].replace(/\s*?(varying|in) .+?;/g,"\n")),i.replaceStrings)for(let e=0;e<i.replaceStrings.length;e++){const t=i.replaceStrings[e];this.functions[r]=this.functions[r].replace(t.search,t.replace)}}}_registerTempVariable(e){return-1===this.sharedData.temps.indexOf(e)&&(this.sharedData.temps.push(e),!0)}_emitVaryingFromString(e,t,i="",s=!1){return-1===this.sharedData.varyings.indexOf(e)&&(this.sharedData.varyings.push(e),i&&(i.startsWith("defined(")?this.sharedData.varyingDeclaration+=`#if ${i}\n`:this.sharedData.varyingDeclaration+=`${s?"#ifndef":"#ifdef"} ${i}\n`),this.sharedData.varyingDeclaration+=`varying ${t} ${e};\n`,i&&(this.sharedData.varyingDeclaration+="#endif\n"),!0)}_emitUniformFromString(e,t,i="",s=!1){-1===this.uniforms.indexOf(e)&&(this.uniforms.push(e),i&&(i.startsWith("defined(")?this._uniformDeclaration+=`#if ${i}\n`:this._uniformDeclaration+=`${s?"#ifndef":"#ifdef"} ${i}\n`),this._uniformDeclaration+=`uniform ${t} ${e};\n`,i&&(this._uniformDeclaration+="#endif\n"))}_emitFloat(e){return e.toString()===e.toFixed(0)?`${e}.0`:e.toString()}}class jr{constructor(){this.temps=[],this.varyings=[],this.varyingDeclaration="",this.inputBlocks=[],this.textureBlocks=[],this.bindableBlocks=[],this.forcedBindableBlocks=[],this.blocksWithFallbacks=[],this.blocksWithDefines=[],this.repeatableContentBlocks=[],this.dynamicUniformBlocks=[],this.blockingBlocks=[],this.animatedInputs=[],this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:new Array},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}emitErrors(){let e="";this.checks.emitVertex||this.allowEmptyVertexProgram||(e+="NodeMaterial does not have a vertex output. You need to at least add a block that generates a glPosition value.\n"),this.checks.emitFragment||(e+="NodeMaterial does not have a fragment output. You need to at least add a block that generates a glFragColor value.\n");for(const t of this.checks.notConnectedNonOptionalInputs)e+=`input ${t.name} from block ${t.ownerBlock.name}[${t.ownerBlock.getClassName()}] is not connected and is not optional.\n`;if(e)throw"Build of NodeMaterial failed:\n"+e}}!function(e){e[e.Compatible=0]="Compatible",e[e.TypeIncompatible=1]="TypeIncompatible",e[e.TargetIncompatible=2]="TargetIncompatible",e[e.HierarchyIssue=3]="HierarchyIssue"}(Qs||(Qs={})),function(e){e[e.Input=0]="Input",e[e.Output=1]="Output"}(Zs||(Zs={}));class Kr{static AreEquivalentTypes(e,t){switch(e){case $s.Vector3:if(t===$s.Color3)return!0;break;case $s.Vector4:if(t===$s.Color4)return!0;break;case $s.Color3:if(t===$s.Vector3)return!0;break;case $s.Color4:if(t===$s.Vector4)return!0}return!1}get direction(){return this._direction}get associatedVariableName(){return this._ownerBlock.isInput?this._ownerBlock.associatedVariableName:this._enforceAssociatedVariableName&&this._associatedVariableName||!this._connectedPoint?this._associatedVariableName:this._connectedPoint.associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get innerType(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type}get type(){if(this._type===$s.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource&&this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type}if(this._type===$s.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._type=e}get target(){return this._prioritizeVertex&&this._ownerBlock?this._target!==qs.VertexAndFragment?this._target:this._ownerBlock.target===qs.Fragment?qs.Fragment:qs.Vertex:this._target}set target(e){this._target=e}get isConnected(){return null!==this.connectedPoint||this.hasEndpoints}get isConnectedToInputBlock(){return null!==this.connectedPoint&&this.connectedPoint.ownerBlock.isInput}get connectInputBlock(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return 0===this._endpoints.length?[]:this._endpoints.map((e=>e.ownerBlock))}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get isDirectlyConnectedToVertexOutput(){if(!this.hasEndpoints)return!1;for(const e of this._endpoints){if(e.ownerBlock.target===qs.Vertex)return!0;if((e.ownerBlock.target===qs.Neutral||e.ownerBlock.target===qs.VertexAndFragment)&&e.ownerBlock.outputs.some((e=>e.isDirectlyConnectedToVertexOutput)))return!0}return!1}get isConnectedInVertexShader(){if(this.target===qs.Vertex)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints){if(e.ownerBlock.target===qs.Vertex)return!0;if(e.target===qs.Vertex)return!0;if((e.ownerBlock.target===qs.Neutral||e.ownerBlock.target===qs.VertexAndFragment)&&e.ownerBlock.outputs.some((e=>e.isConnectedInVertexShader)))return!0}return!1}get isConnectedInFragmentShader(){if(this.target===qs.Fragment)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints){if(e.ownerBlock.target===qs.Fragment)return!0;if((e.ownerBlock.target===qs.Neutral||e.ownerBlock.target===qs.VertexAndFragment)&&e.ownerBlock.isConnectedInFragmentShader())return!0}return!1}createCustomInputBlock(){return null}constructor(e,t,i){this._connectedPoint=null,this._endpoints=new Array,this._typeConnectionSource=null,this._defaultConnectionPointType=null,this._linkedConnectionSource=null,this._acceptedConnectionPointType=null,this._type=$s.Float,this._enforceAssociatedVariableName=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new a,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._prioritizeVertex=!1,this._target=qs.VertexAndFragment,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeMaterialConnectionPoint"}canConnectTo(e){return this.checkCompatibilityState(e)===Qs.Compatible}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(t.target===qs.Fragment){if(i.target===qs.Vertex)return Qs.TargetIncompatible;for(const e of i.outputs)if(e.ownerBlock.target!=qs.Neutral&&e.isConnectedInVertexShader)return Qs.TargetIncompatible}if(this.type!==e.type&&e.innerType!==$s.AutoDetect)return Kr.AreEquivalentTypes(this.type,e.type)||e.acceptedConnectionPointTypes&&-1!==e.acceptedConnectionPointTypes.indexOf(this.type)||e._acceptedConnectionPointType&&Kr.AreEquivalentTypes(e._acceptedConnectionPointType.type,this.type)?Qs.Compatible:Qs.TypeIncompatible;if(e.excludedConnectionPointTypes&&-1!==e.excludedConnectionPointTypes.indexOf(this.type))return Qs.TypeIncompatible;let s=i,r=t;return this.direction===Zs.Input&&(s=t,r=i),s.isAnAncestorOf(r)?Qs.HierarchyIssue:Qs.Compatible}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this._enforceAssociatedVariableName=!1,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return-1===t||(this._endpoints.splice(t,1),e._connectedPoint=null,this._enforceAssociatedVariableName=!1,e._enforceAssociatedVariableName=!1),this}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<$s.All;)e&t||this.excludedConnectionPointTypes.push(t),t<<=1}serialize(e=!0){const t={};return t.name=this.name,t.displayName=this.displayName,e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear()}}class $r{get name(){return this._name}set name(e){this.validateBlockName(e)&&(this._name=e)}get isUnique(){return this._isUnique}get isFinalMerger(){return this._isFinalMerger}get isInput(){return this._isInput}get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get buildId(){return this._buildId}set buildId(e){this._buildId=e}get target(){return this._target}set target(e){this._target&e||(this._target=e)}get inputs(){return this._inputs}get outputs(){return this._outputs}getInputByName(e){const t=this._inputs.filter((t=>t.name===e));return t.length?t[0]:null}getOutputByName(e){const t=this._outputs.filter((t=>t.name===e));return t.length?t[0]:null}constructor(e,t=qs.Vertex,i=!1){this._isFinalMerger=!1,this._isInput=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._name="",this._isUnique=!1,this.inputsAreExclusive=!1,this._codeVariableName="",this._inputs=new Array,this._outputs=new Array,this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this._target=t,this._originalTargetIsNeutral=t===qs.Neutral,this._isFinalMerger=i,this._isInput="InputBlock"===this.getClassName(),this._isTeleportOut="NodeMaterialTeleportOutBlock"===this.getClassName(),this._isTeleportIn="NodeMaterialTeleportInBlock"===this.getClassName(),this._name=e,this.uniqueId=Bi.UniqueId}_setInitialTarget(e){this._target=e,this._originalTargetIsNeutral=e===qs.Neutral}initialize(e){}bind(e,t,i,s){}_declareOutput(e,t){return`${t._getGLType(e.type)} ${e.associatedVariableName}`}_writeVariable(e){return e.connectedPoint?`${e.associatedVariableName}`:"0."}_writeFloat(e){let t=e.toString();return-1===t.indexOf(".")&&(t+=".0"),`${t}`}getClassName(){return"NodeMaterialBlock"}isConnectedInFragmentShader(){return this.outputs.some((e=>e.isConnectedInFragmentShader))}registerInput(e,t,i=!1,s,r){return(r=null!=r?r:new Kr(e,this,Zs.Input)).type=t,r.isOptional=i,s&&(r.target=s),this._inputs.push(r),this}registerOutput(e,t,i,s){return(s=null!=s?s:new Kr(e,this,Zs.Output)).type=t,i&&(s.target=i),this._outputs.push(s),this}getFirstAvailableInput(e=null){for(const t of this._inputs)if(!(t.connectedPoint||e&&e.type!==t.type&&t.type!==$s.AutoDetect))return t;return null}getFirstAvailableOutput(e=null){for(const t of this._outputs)if(!e||!e.target||e.target===qs.Neutral||e.target&t.target)return t;return null}getSiblingOutput(e){const t=this._outputs.indexOf(e);return-1===t||t>=this._outputs.length?null:this._outputs[t+1]}isAnAncestorOf(e){for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints){if(i.ownerBlock===e)return!0;if(i.ownerBlock.isAnAncestorOf(e))return!0}return!1}connectTo(e,t){if(0===this._outputs.length)return;let i=t&&t.output?this.getOutputByName(t.output):this.getFirstAvailableOutput(e),s=!0;for(;s;){const r=t&&t.input?e.getInputByName(t.input):e.getFirstAvailableInput(i);if(i&&r&&i.canConnectTo(r))i.connectTo(r),s=!1;else{if(!i)throw"Unable to find a compatible match";i=this.getSiblingOutput(i)}}return this}_buildBlock(e){}updateUniformsAndSamples(e,t,i,s){}provideFallbacks(e,t){}initializeDefines(e,t,i,s=!1){}prepareDefines(e,t,i,s=!1,r){}autoConfigure(e,t=()=>!0){}replaceRepeatableContent(e,t,i,s){}get willBeGeneratedIntoVertexShaderFromFragmentShader(){return!(this.isInput||this.isFinalMerger||this._outputs.some((e=>e.isDirectlyConnectedToVertexOutput))||this.target===qs.Vertex||this.target!==qs.VertexAndFragment&&this.target!==qs.Neutral||!this._outputs.some((e=>e.isConnectedInVertexShader)))}isReady(e,t,i,s=!1){return!0}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[t]._linkedConnectionSource=this._inputs[e]}_processBuild(e,t,i,s){e.build(t,s);const r=null!=t._vertexState,n=e._buildTarget===qs.Vertex&&e.target!==qs.VertexAndFragment;if(r&&(!(e.target&e._buildTarget)||!(e.target&i.target)||this.target!==qs.VertexAndFragment&&n)&&(!e.isInput&&t.target!==e._buildTarget||e.isInput&&e.isAttribute&&!e._noContextSwitch)){const e=i.connectedPoint;t._vertexState._emitVaryingFromString("v_"+e.associatedVariableName,t._getGLType(e.type))&&(t._vertexState.compilationString+=`${"v_"+e.associatedVariableName} = ${e.associatedVariableName};\n`),i.associatedVariableName="v_"+e.associatedVariableName,i._enforceAssociatedVariableName=!0}}validateBlockName(e){const t=["position","normal","tangent","particle_positionw","uv","uv2","uv3","uv4","uv5","uv6","position2d","particle_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"];for(const i of t)if(e===i)return!1;return!0}_customBuildStep(e,t){}build(e,t){if(this._buildId===e.sharedData.buildId)return!0;if(!this.isInput)for(const t of this._outputs)t.associatedVariableName||(t.associatedVariableName=e._getFreeVariableName(t.name));for(const i of this._inputs){if(!i.connectedPoint){i.isOptional||e.sharedData.checks.notConnectedNonOptionalInputs.push(i);continue}if(this.target!==qs.Neutral){if(!(i.target&this.target))continue;if(!(i.target&e.target))continue}const s=i.connectedPoint.ownerBlock;s&&s!==this&&this._processBuild(s,e,i,t)}if(this._customBuildStep(e,t),this._buildId===e.sharedData.buildId)return!0;if(e.sharedData.verbose&&console.log(`${e.target===qs.Vertex?"Vertex shader":"Fragment shader"}: Building ${this.name} [${this.getClassName()}]`),this.isFinalMerger)switch(e.target){case qs.Vertex:e.sharedData.checks.emitVertex=!0;break;case qs.Fragment:e.sharedData.checks.emitFragment=!0}!this.isInput&&e.sharedData.emitComments&&(e.compilationString+=`\n//${this.name}\n`),this._buildBlock(e),this._buildId=e.sharedData.buildId,this._buildTarget=e.target;for(const i of this._outputs)if(i.target&e.target)for(const s of i.endpoints){const i=s.ownerBlock;i&&i.target&e.target&&-1!==t.indexOf(i)&&this._processBuild(i,e,s,t)}return!1}_inputRename(e){return e}_outputRename(e){return e}_dumpPropertiesCode(){const e=this._codeVariableName;return`${e}.visibleInInspector = ${this.visibleInInspector};\n${e}.visibleOnFrame = ${this.visibleOnFrame};\n${e}.target = ${this.target};\n`}_dumpCode(e,t){t.push(this);const i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||`${this.getClassName()}_${this.uniqueId}`,-1!==e.indexOf(this._codeVariableName)){let t=0;do{t++,this._codeVariableName=i+t}while(-1!==e.indexOf(this._codeVariableName))}e.push(this._codeVariableName);let s=`\n// ${this.getClassName()}\n`;this.comments&&(s+=`// ${this.comments}\n`),s+=`var ${this._codeVariableName} = new BABYLON.${this.getClassName()}("${this.name}");\n`,s+=this._dumpPropertiesCode();for(const i of this.inputs){if(!i.isConnected)continue;const r=i.connectedPoint.ownerBlock;-1===t.indexOf(r)&&(s+=r._dumpCode(e,t))}for(const i of this.outputs)if(i.hasEndpoints)for(const r of i.endpoints){const i=r.ownerBlock;i&&-1===t.indexOf(i)&&(s+=i._dumpCode(e,t))}return s}_dumpCodeForOutputConnections(e){let t="";if(-1!==e.indexOf(this))return t;e.push(this);for(const i of this.inputs){if(!i.isConnected)continue;const s=i.connectedPoint,r=s.ownerBlock;t+=r._dumpCodeForOutputConnections(e),t+=`${r._codeVariableName}.${r._outputRename(s.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});\n`}return t}clone(e,t=""){const i=this.serialize(),s=g(i.customType);if(s){const r=new s;return r._deserialize(i,e,t),r}return null}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.comments=this.comments,e.visibleInInspector=this.visibleInInspector,e.visibleOnFrame=this.visibleOnFrame,e.target=this.target,e.inputs=[],e.outputs=[];for(const t of this.inputs)e.inputs.push(t.serialize());for(const t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e,t,i){var s;this.name=e.name,this.comments=e.comments,this.visibleInInspector=!!e.visibleInInspector,this.visibleOnFrame=!!e.visibleOnFrame,this._target=null!==(s=e.target)&&void 0!==s?s:this.target,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const t=e.inputs,i=e.outputs;t&&t.forEach(((e,t)=>{e.displayName&&(this.inputs[t].displayName=e.displayName),e.isExposedOnFrame&&(this.inputs[t].isExposedOnFrame=e.isExposedOnFrame,this.inputs[t].exposedPortPosition=e.exposedPortPosition)})),i&&i.forEach(((e,t)=>{e.displayName&&(this.outputs[t].displayName=e.displayName),e.isExposedOnFrame&&(this.outputs[t].isExposedOnFrame=e.isExposedOnFrame,this.outputs[t].exposedPortPosition=e.exposedPortPosition)}))}dispose(){for(const e of this.inputs)e.dispose();for(const e of this.outputs)e.dispose()}}class qr extends $r{constructor(e){super(e,qs.Neutral),this.complementW=1,this.complementZ=0,this.target=qs.Vertex,this.registerInput("vector",$s.AutoDetect),this.registerInput("transform",$s.Matrix),this.registerOutput("output",$s.Vector4),this.registerOutput("xyz",$s.Vector3),this._inputs[0].onConnectionObservable.add((e=>{if(e.ownerBlock.isInput){const t=e.ownerBlock;"normal"!==t.name&&"tangent"!==t.name||(this.complementW=0)}}))}getClassName(){return"TransformBlock"}get vector(){return this._inputs[0]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}get transform(){return this._inputs[1]}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.transform;if(t.connectedPoint){if(0===this.complementW){const s=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",s),e.sharedData.blocksWithDefines.push(this);const r=e._getFreeVariableName(`${i.associatedVariableName}_NUS`);switch(e.compilationString+=`mat3 ${r} = mat3(${i.associatedVariableName});\n`,e.compilationString+="#ifdef NONUNIFORMSCALING\n",e.compilationString+=`${r} = transposeMat3(inverseMat3(${r}));\n`,e.compilationString+="#endif\n",t.connectedPoint.type){case $s.Vector2:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${r} * vec3(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}), ${this._writeFloat(this.complementW)});\n`;break;case $s.Vector3:case $s.Color3:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${r} * ${t.associatedVariableName}, ${this._writeFloat(this.complementW)});\n`;break;default:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${r} * ${t.associatedVariableName}.xyz, ${this._writeFloat(this.complementW)});\n`}}else{const s=i.associatedVariableName;switch(t.connectedPoint.type){case $s.Vector2:e.compilationString+=this._declareOutput(this.output,e)+` = ${s} * vec4(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}, ${this._writeFloat(this.complementW)});\n`;break;case $s.Vector3:case $s.Color3:e.compilationString+=this._declareOutput(this.output,e)+` = ${s} * vec4(${t.associatedVariableName}, ${this._writeFloat(this.complementW)});\n`;break;default:e.compilationString+=this._declareOutput(this.output,e)+` = ${s} * ${t.associatedVariableName};\n`}}this.xyz.hasEndpoints&&(e.compilationString+=this._declareOutput(this.xyz,e)+` = ${this.output.associatedVariableName}.xyz;\n`)}return this}prepareDefines(e,t,i){e.nonUniformScaling&&i.setValue("NONUNIFORMSCALING",!0)}serialize(){const e=super.serialize();return e.complementZ=this.complementZ,e.complementW=this.complementW,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.complementZ=void 0!==e.complementZ?e.complementZ:0,this.complementW=void 0!==e.complementW?e.complementW:1}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.complementZ = ${this.complementZ};\n`;return e+=`${this._codeVariableName}.complementW = ${this.complementW};\n`,e}}m("BABYLON.TransformBlock",qr);class Qr extends $r{constructor(e){super(e,qs.Vertex,!0),this.registerInput("vector",$s.Vector4)}getClassName(){return"VertexOutputBlock"}get vector(){return this._inputs[0]}_isLogarithmicDepthEnabled(e,t){if(t)return!0;for(const t of e)if(t.useLogarithmicDepth)return!0;return!1}_buildBlock(e){super._buildBlock(e);const t=this.vector;return e.compilationString+=`gl_Position = ${t.associatedVariableName};\n`,this._isLogarithmicDepthEnabled(e.sharedData.fragmentOutputNodes,e.sharedData.nodeMaterial.useLogarithmicDepth)&&(e._emitUniformFromString("logarithmicDepthConstant","float"),e._emitVaryingFromString("vFragmentDepth","float"),e.compilationString+="vFragmentDepth = 1.0 + gl_Position.w;\n",e.compilationString+="gl_Position.z = log2(max(0.000001, vFragmentDepth)) * logarithmicDepthConstant;\n"),this}}function Zr(e,t=Js.Boolean,i="PROPERTIES",s){return(r,n)=>{let o=r._propStore;o||(o=[],r._propStore=o),o.push({propertyName:n,displayName:e,type:t,groupName:i,options:null!=s?s:{}})}}m("BABYLON.VertexOutputBlock",Qr),function(e){e[e.Boolean=0]="Boolean",e[e.Float=1]="Float",e[e.Int=2]="Int",e[e.Vector2=3]="Vector2",e[e.List=4]="List"}(Js||(Js={}));class Jr extends $r{constructor(e){super(e,qs.Fragment,!0),this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this.useLogarithmicDepth=!1,this.registerInput("rgba",$s.Color4,!0),this.registerInput("rgb",$s.AutoDetect,!0),this.registerInput("a",$s.Float,!0),this.rgb.addExcludedConnectionPointFromAllowedTypes($s.Color3|$s.Vector3|$s.Float)}getClassName(){return"FragmentOutputBlock"}initialize(e){e._excludeVariableName("logarithmicDepthConstant"),e._excludeVariableName("vFragmentDepth")}get rgba(){return this._inputs[0]}get rgb(){return this._inputs[1]}get a(){return this._inputs[2]}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToLinearSpace,!0),i.setValue(this._gammaDefineName,this.convertToGammaSpace,!0)}bind(e,t,i){(this.useLogarithmicDepth||t.useLogarithmicDepth)&&i&&Hs.BindLogDepth(void 0,e,i.getScene())}_buildBlock(e){super._buildBlock(e);const t=this.rgba,i=this.rgb,s=this.a;e.sharedData.hints.needAlphaBlending=t.isConnected||s.isConnected,e.sharedData.blocksWithDefines.push(this),(this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth)&&(e._emitUniformFromString("logarithmicDepthConstant","float"),e._emitVaryingFromString("vFragmentDepth","float"),e.sharedData.bindableBlocks.push(this)),this._linearDefineName=e._getFreeDefineName("CONVERTTOLINEAR"),this._gammaDefineName=e._getFreeDefineName("CONVERTTOGAMMA");const r=`//${this.name}`;if(e._emitFunctionFromInclude("helperFunctions",r),t.connectedPoint)s.isConnected?e.compilationString+=`gl_FragColor = vec4(${t.associatedVariableName}.rgb, ${s.associatedVariableName});\n`:e.compilationString+=`gl_FragColor = ${t.associatedVariableName};\n`;else if(i.connectedPoint){let t="1.0";s.connectedPoint&&(t=s.associatedVariableName),i.connectedPoint.type===$s.Float?e.compilationString+=`gl_FragColor = vec4(${i.associatedVariableName}, ${i.associatedVariableName}, ${i.associatedVariableName}, ${t});\n`:e.compilationString+=`gl_FragColor = vec4(${i.associatedVariableName}, ${t});\n`}else e.sharedData.checks.notConnectedNonOptionalInputs.push(t);return e.compilationString+=`#ifdef ${this._linearDefineName}\n`,e.compilationString+="gl_FragColor = toLinearSpace(gl_FragColor);\n",e.compilationString+="#endif\n",e.compilationString+=`#ifdef ${this._gammaDefineName}\n`,e.compilationString+="gl_FragColor = toGammaSpace(gl_FragColor);\n",e.compilationString+="#endif\n",(this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth)&&(e.compilationString+="gl_FragDepthEXT = log2(vFragmentDepth) * logarithmicDepthConstant * 0.5;\n"),e.compilationString+="#if defined(PREPASS)\r\n",e.compilationString+="gl_FragData[0] = gl_FragColor;\r\n",e.compilationString+="#endif\r\n",this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\n`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\n`,e+=`${this._codeVariableName}.useLogarithmicDepth = ${this.useLogarithmicDepth};\n`,e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.useLogarithmicDepth=this.useLogarithmicDepth,e}_deserialize(e,t,i){var s;super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=e.convertToLinearSpace,this.useLogarithmicDepth=null!==(s=e.useLogarithmicDepth)&&void 0!==s&&s}}me([Zr("Convert to gamma space",Js.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Jr.prototype,"convertToGammaSpace",void 0),me([Zr("Convert to linear space",Js.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Jr.prototype,"convertToLinearSpace",void 0),me([Zr("Use logarithmic depth",Js.Boolean,"PROPERTIES")],Jr.prototype,"useLogarithmicDepth",void 0),m("BABYLON.FragmentOutputBlock",Jr),function(e){e[e.Uniform=0]="Uniform",e[e.Attribute=1]="Attribute",e[e.Varying=2]="Varying",e[e.Undefined=3]="Undefined"}(er||(er={})),function(e){e[e.World=1]="World",e[e.View=2]="View",e[e.Projection=3]="Projection",e[e.ViewProjection=4]="ViewProjection",e[e.WorldView=5]="WorldView",e[e.WorldViewProjection=6]="WorldViewProjection",e[e.CameraPosition=7]="CameraPosition",e[e.FogColor=8]="FogColor",e[e.DeltaTime=9]="DeltaTime",e[e.CameraParameters=10]="CameraParameters",e[e.MaterialAlpha=11]="MaterialAlpha"}(tr||(tr={})),function(e){e[e.None=0]="None",e[e.Time=1]="Time",e[e.RealTime=2]="RealTime"}(ir||(ir={}));const en={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW"},tn={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0},sn={particle_texturemask:!0};class rn extends $r{get type(){if(this._type===$s.AutoDetect){if(this.isUniform&&null!=this.value){if(!isNaN(this.value))return this._type=$s.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=$s.Vector2,this._type;case"Vector3":return this._type=$s.Vector3,this._type;case"Vector4":return this._type=$s.Vector4,this._type;case"Color3":return this._type=$s.Color3,this._type;case"Color4":return this._type=$s.Color4,this._type;case"Matrix":return this._type=$s.Matrix,this._type}}if(this.isAttribute)switch(this.name){case"position":case"normal":case"particle_positionw":return this._type=$s.Vector3,this._type;case"uv":case"uv2":case"uv3":case"uv4":case"uv5":case"uv6":case"position2d":case"particle_uv":return this._type=$s.Vector2,this._type;case"matricesIndices":case"matricesWeights":case"matricesIndicesExtra":case"matricesWeightsExtra":case"world0":case"world1":case"world2":case"world3":case"tangent":return this._type=$s.Vector4,this._type;case"color":case"instanceColor":case"particle_color":case"particle_texturemask":return this._type=$s.Color4,this._type}if(this.isSystemValue)switch(this._systemValue){case tr.World:case tr.WorldView:case tr.WorldViewProjection:case tr.View:case tr.ViewProjection:case tr.Projection:return this._type=$s.Matrix,this._type;case tr.CameraPosition:return this._type=$s.Vector3,this._type;case tr.FogColor:return this._type=$s.Color3,this._type;case tr.DeltaTime:case tr.MaterialAlpha:return this._type=$s.Float,this._type;case tr.CameraParameters:return this._type=$s.Vector4,this._type}}return this._type}constructor(e,t=qs.Vertex,i=$s.AutoDetect){super(e,t,!1),this._mode=er.Undefined,this._animationType=ir.None,this.min=0,this.max=0,this.isBoolean=!1,this.matrixMode=0,this._systemValue=null,this.isConstant=!1,this.groupInInspector="",this.onValueChangedObservable=new a,this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._type=i,this.setDefaultValue(),this.registerOutput("output",i)}validateBlockName(e){return!!this.isAttribute||super.validateBlockName(e)}get output(){return this._outputs[0]}setAsAttribute(e){return this._mode=er.Attribute,e&&(this.name=e),this}setAsSystemValue(e){return this.systemValue=e,this}get value(){return this._storedValue}set value(e){this.type===$s.Float&&(this.isBoolean?e=e?1:0:this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e))),this._storedValue=e,this._mode=er.Uniform,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e,this._mode=er.Uniform}get associatedVariableName(){return this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get animationType(){return this._animationType}set animationType(e){this._animationType=e}get isUndefined(){return this._mode===er.Undefined}get isUniform(){return this._mode===er.Uniform}set isUniform(e){this._mode=e?er.Uniform:er.Undefined,this.associatedVariableName=""}get isAttribute(){return this._mode===er.Attribute}set isAttribute(e){this._mode=e?er.Attribute:er.Undefined,this.associatedVariableName=""}get isVarying(){return this._mode===er.Varying}set isVarying(e){this._mode=e?er.Varying:er.Undefined,this.associatedVariableName=""}get isSystemValue(){return null!=this._systemValue}get systemValue(){return this._systemValue}set systemValue(e){this._mode=er.Uniform,this.associatedVariableName="",this._systemValue=e}getClassName(){return"InputBlock"}animate(e){switch(this._animationType){case ir.Time:this.type===$s.Float&&(this.value+=.01*e.getAnimationRatio());break;case ir.RealTime:this.type===$s.Float&&(this.value=(Fe.Now-e.getEngine().startTime)/1e3)}}_emitDefine(e){return"!"===e[0]?`#ifndef ${e.substring(1)}\n`:`#ifdef ${e}\n`}initialize(){this.associatedVariableName=""}setDefaultValue(){switch(this.type){case $s.Float:this.value=0;break;case $s.Vector2:this.value=E.Zero();break;case $s.Vector3:this.value=S.Zero();break;case $s.Vector4:this.value=b.Zero();break;case $s.Color3:this.value=N.White();break;case $s.Color4:this.value=new F(1,1,1,1);break;case $s.Matrix:this.value=y.Identity()}}_emitConstant(e){switch(this.type){case $s.Float:return`${e._emitFloat(this.value)}`;case $s.Vector2:return`vec2(${this.value.x}, ${this.value.y})`;case $s.Vector3:return`vec3(${this.value.x}, ${this.value.y}, ${this.value.z})`;case $s.Vector4:return`vec4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;case $s.Color3:return w.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&w.Color3[0].toGammaSpaceToRef(w.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&w.Color3[0].toLinearSpaceToRef(w.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec3(${w.Color3[0].r}, ${w.Color3[0].g}, ${w.Color3[0].b})`;case $s.Color4:return w.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&w.Color4[0].toGammaSpaceToRef(w.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&w.Color4[0].toLinearSpaceToRef(w.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec4(${w.Color4[0].r}, ${w.Color4[0].g}, ${w.Color4[0].b}, ${w.Color4[0].a})`}return""}get _noContextSwitch(){return tn[this.name]}_emit(e,t){var i;if(this.isUniform){if(this.associatedVariableName||(this.associatedVariableName=e._getFreeVariableName("u_"+this.name)),this.isConstant){if(-1!==e.constants.indexOf(this.associatedVariableName))return;return e.constants.push(this.associatedVariableName),void(e._constantDeclaration+=this._declareOutput(this.output,e)+` = ${this._emitConstant(e)};\n`)}if(-1!==e.uniforms.indexOf(this.associatedVariableName))return;e.uniforms.push(this.associatedVariableName),t&&(e._uniformDeclaration+=this._emitDefine(t)),e._uniformDeclaration+=`uniform ${e._getGLType(this.type)} ${this.associatedVariableName};\n`,t&&(e._uniformDeclaration+="#endif\n");const i=e.sharedData.hints;if(null!==this._systemValue&&void 0!==this._systemValue)switch(this._systemValue){case tr.WorldView:i.needWorldViewMatrix=!0;break;case tr.WorldViewProjection:i.needWorldViewProjectionMatrix=!0}else this._animationType!==ir.None&&e.sharedData.animatedInputs.push(this)}else if(this.isAttribute){if(this.associatedVariableName=null!==(i=en[this.name])&&void 0!==i?i:this.name,this.target===qs.Vertex&&e._vertexState)return void(tn[this.name]?sn[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),t):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),t):this._emit(e._vertexState,t));if(-1!==e.attributes.indexOf(this.associatedVariableName))return;e.attributes.push(this.associatedVariableName),tn[this.name]?sn[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),t):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),t):(t&&(e._attributeDeclaration+=this._emitDefine(t)),e._attributeDeclaration+=`attribute ${e._getGLType(this.type)} ${this.associatedVariableName};\n`,t&&(e._attributeDeclaration+="#endif\n"))}}_transmitWorld(e,t,i,s){if(!this._systemValue)return;const r=this.associatedVariableName;switch(this._systemValue){case tr.World:e.setMatrix(r,t);break;case tr.WorldView:e.setMatrix(r,i);break;case tr.WorldViewProjection:e.setMatrix(r,s)}}_transmit(e,t,i){if(this.isAttribute)return;const s=this.associatedVariableName;if(this._systemValue){switch(this._systemValue){case tr.World:case tr.WorldView:case tr.WorldViewProjection:return;case tr.View:e.setMatrix(s,t.getViewMatrix());break;case tr.Projection:e.setMatrix(s,t.getProjectionMatrix());break;case tr.ViewProjection:e.setMatrix(s,t.getTransformMatrix());break;case tr.CameraPosition:t.bindEyePosition(e,s,!0);break;case tr.FogColor:e.setColor3(s,t.fogColor);break;case tr.DeltaTime:e.setFloat(s,t.deltaTime/1e3);break;case tr.CameraParameters:t.activeCamera&&e.setFloat4(s,t.getEngine().hasOriginBottomLeft?-1:1,t.activeCamera.minZ,t.activeCamera.maxZ,1/t.activeCamera.maxZ);break;case tr.MaterialAlpha:e.setFloat(s,i.alpha)}return}const r=this._valueCallback?this._valueCallback():this._storedValue;if(null!==r)switch(this.type){case $s.Float:e.setFloat(s,r);break;case $s.Int:e.setInt(s,r);break;case $s.Color3:w.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&w.Color3[0].toGammaSpaceToRef(w.Color3[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&w.Color3[0].toLinearSpaceToRef(w.Color3[0],t.getEngine().useExactSrgbConversions),e.setColor3(s,w.Color3[0]);break;case $s.Color4:w.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&w.Color4[0].toGammaSpaceToRef(w.Color4[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&w.Color4[0].toLinearSpaceToRef(w.Color4[0],t.getEngine().useExactSrgbConversions),e.setDirectColor4(s,w.Color4[0]);break;case $s.Vector2:e.setVector2(s,r);break;case $s.Vector3:e.setVector3(s,r);break;case $s.Vector4:e.setVector4(s,r);break;case $s.Matrix:e.setMatrix(s,r)}}_buildBlock(e){super._buildBlock(e),(this.isUniform||this.isSystemValue)&&e.sharedData.inputBlocks.push(this),this._emit(e)}_dumpPropertiesCode(){const e=this._codeVariableName;if(this.isAttribute)return super._dumpPropertiesCode()+`${e}.setAsAttribute("${this.name}");\n`;if(this.isSystemValue)return super._dumpPropertiesCode()+`${e}.setAsSystemValue(BABYLON.NodeMaterialSystemValues.${tr[this._systemValue]});\n`;if(this.isUniform){const t=[];let i="";switch(this.type){case $s.Float:i=`${this.value}`;break;case $s.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case $s.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case $s.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;break;case $s.Color3:i=`new BABYLON.Color3(${this.value.r}, ${this.value.g}, ${this.value.b})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case $s.Color4:i=`new BABYLON.Color4(${this.value.r}, ${this.value.g}, ${this.value.b}, ${this.value.a})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case $s.Matrix:i=`BABYLON.Matrix.FromArray([${this.value.m}])`}return t.push(`${e}.value = ${i}`),this.type===$s.Float&&t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`,`${e}.isBoolean = ${this.isBoolean}`,`${e}.matrixMode = ${this.matrixMode}`,`${e}.animationType = BABYLON.AnimatedInputBlockTypes.${ir[this.animationType]}`),t.push(`${e}.isConstant = ${this.isConstant}`),t.push(""),super._dumpPropertiesCode()+t.join(";\n")}return super._dumpPropertiesCode()}dispose(){this.onValueChangedObservable.clear(),super.dispose()}serialize(){const e=super.serialize();return e.type=this.type,e.mode=this._mode,e.systemValue=this._systemValue,e.animationType=this._animationType,e.min=this.min,e.max=this.max,e.isBoolean=this.isBoolean,e.matrixMode=this.matrixMode,e.isConstant=this.isConstant,e.groupInInspector=this.groupInInspector,e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,null!=this._storedValue&&this._mode===er.Uniform&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e,t,i){if(this._mode=e.mode,super._deserialize(e,t,i),this._type=e.type,this._systemValue=e.systemValue||e.wellKnownValue,this._animationType=e.animationType,this.min=e.min||0,this.max=e.max||0,this.isBoolean=!!e.isBoolean,this.matrixMode=e.matrixMode||0,this.isConstant=!!e.isConstant,this.groupInInspector=e.groupInInspector||"",this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,"tangent"===e.name&&e.mode===er.Attribute&&e.type===$s.Vector3&&(this._type=$s.Vector4),e.valueType)if("number"===e.valueType)this._storedValue=e.value;else{const t=g(e.valueType);t&&(this._storedValue=t.FromArray(e.value))}}}m("BABYLON.InputBlock",rn);class nn extends $r{constructor(e){super(e,qs.VertexAndFragment),this._samplerName="textureSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",$s.AutoDetect,!1,qs.VertexAndFragment),this.registerOutput("rgba",$s.Color4,qs.Neutral),this.registerOutput("rgb",$s.Color3,qs.Neutral),this.registerOutput("r",$s.Float,qs.Neutral),this.registerOutput("g",$s.Float,qs.Neutral),this.registerOutput("b",$s.Float,qs.Neutral),this.registerOutput("a",$s.Float,qs.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes($s.Vector2|$s.Vector3|$s.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"CurrentScreenBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("textureSampler")}get target(){return this.uv.isConnected?this.uv.sourceBlock.isInput?qs.VertexAndFragment:qs.Fragment:qs.VertexAndFragment}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,"vec2")),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,"vec2"),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\n`,this._outputs.some((e=>e.isConnectedInVertexShader))){this._writeTextureRead(e,!0);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,t.name,!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===qs.Fragment)return;e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName});\n`}else this.uv.ownerBlock.target!==qs.Fragment?e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this._mainUVName});\n`:e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName});\n`}_writeOutput(e,t,i,s=!1){if(s){if(e.target===qs.Fragment)return;e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\n`}else this.uv.ownerBlock.target!==qs.Fragment?(e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\n`,e.compilationString+=`#ifdef ${this._linearDefineName}\n`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\n`,e.compilationString+="#endif\n",e.compilationString+=`#ifdef ${this._gammaDefineName}\n`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\n`,e.compilationString+="#endif\n"):e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\n`}_buildBlock(e){if(super._buildBlock(e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.blockingBlocks.indexOf(this)<0&&e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.indexOf(this)<0&&e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.indexOf(this)<0&&e.sharedData.blocksWithDefines.push(this),e.target!==qs.Fragment)return e._emit2DSampler(this._samplerName),void this._injectVertexCode(e);if(!this._outputs.some((e=>e.isConnectedInFragmentShader)))return;e._emit2DSampler(this._samplerName),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,t.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=Ar.Parse(e.texture,t,i))}}m("BABYLON.CurrentScreenBlock",nn);class on extends $r{constructor(e){super(e,qs.Fragment),this._samplerName="diffuseSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",$s.AutoDetect,!1,qs.VertexAndFragment),this.registerOutput("rgba",$s.Color4,qs.Neutral),this.registerOutput("rgb",$s.Color3,qs.Neutral),this.registerOutput("r",$s.Float,qs.Neutral),this.registerOutput("g",$s.Float,qs.Neutral),this.registerOutput("b",$s.Float,qs.Neutral),this.registerOutput("a",$s.Float,qs.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes($s.Vector2|$s.Vector3|$s.Vector4)}getClassName(){return"ParticleTextureBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("diffuseSampler")}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"particle_uv"===e.name&&t(e)));i||(i=new rn("uv"),i.setAsAttribute("particle_uv")),i.output.connectTo(this.uv)}}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_writeOutput(e,t,i){e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\n`,e.compilationString+=`#ifdef ${this._linearDefineName}\n`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\n`,e.compilationString+="#endif\n",e.compilationString+=`#ifdef ${this._gammaDefineName}\n`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\n`,e.compilationString+="#endif\n"}_buildBlock(e){if(super._buildBlock(e),e.target===qs.Vertex)return;this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this.uv.associatedVariableName});\n`;for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,t.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=Ar.Parse(e.texture,t,i))}}m("BABYLON.ParticleTextureBlock",on);class an extends $r{constructor(e){super(e,qs.Fragment),this._isUnique=!0,this.registerInput("color",$s.Color4,!1,qs.Fragment),this.registerOutput("rampColor",$s.Color4,qs.Fragment)}getClassName(){return"ParticleRampGradientBlock"}get color(){return this._inputs[0]}get rampColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("remapRanges"),e._excludeVariableName("rampSampler"),e._excludeVariableName("baseColor"),e._excludeVariableName("alpha"),e._excludeVariableName("remappedColorIndex"),e._excludeVariableName("rampColor"),e._excludeVariableName("finalAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==qs.Vertex)return e._emit2DSampler("rampSampler"),e._emitVaryingFromString("remapRanges","vec4","RAMPGRADIENT"),e.compilationString+=`\n            #ifdef RAMPGRADIENT\n                vec4 baseColor = ${this.color.associatedVariableName};\n                float alpha = ${this.color.associatedVariableName}.a;\n\n                float remappedColorIndex = clamp((alpha - remapRanges.x) / remapRanges.y, 0.0, 1.0);\n\n                vec4 rampColor = texture2D(rampSampler, vec2(1.0 - remappedColorIndex, 0.));\n                baseColor.rgb *= rampColor.rgb;\n\n                // Remapped alpha\n                float finalAlpha = baseColor.a;\n                baseColor.a = clamp((alpha * rampColor.a - remapRanges.z) / remapRanges.w, 0.0, 1.0);\n\n                ${this._declareOutput(this.rampColor,e)} = baseColor;\n            #else\n                ${this._declareOutput(this.rampColor,e)} = ${this.color.associatedVariableName};\n            #endif\n        `,this}}m("BABYLON.ParticleRampGradientBlock",an);class ln extends $r{constructor(e){super(e,qs.Fragment),this._isUnique=!0,this.registerInput("color",$s.Color4,!1,qs.Fragment),this.registerInput("alphaTexture",$s.Float,!1,qs.Fragment),this.registerInput("alphaColor",$s.Float,!1,qs.Fragment),this.registerOutput("blendColor",$s.Color4,qs.Fragment)}getClassName(){return"ParticleBlendMultiplyBlock"}get color(){return this._inputs[0]}get alphaTexture(){return this._inputs[1]}get alphaColor(){return this._inputs[2]}get blendColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("sourceAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==qs.Vertex)return e.compilationString+=`\n            #ifdef BLENDMULTIPLYMODE\n                ${this._declareOutput(this.blendColor,e)};\n                float sourceAlpha = ${this.alphaColor.associatedVariableName} * ${this.alphaTexture.associatedVariableName};\n                ${this.blendColor.associatedVariableName}.rgb = ${this.color.associatedVariableName}.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha);\n                ${this.blendColor.associatedVariableName}.a = ${this.color.associatedVariableName}.a;\n            #else\n                ${this._declareOutput(this.blendColor,e)} = ${this.color.associatedVariableName};\n            #endif\n        `,this}}m("BABYLON.ParticleBlendMultiplyBlock",ln);class hn{constructor(){this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null}unBindMesh(){this._mesh=null}addFallback(e,t){this._defines[e]||(e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e),this._defines[e]=new Array),this._defines[e].push(t)}addCPUSkinningFallback(e,t){this._mesh=t,e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e)}get hasMoreFallbacks(){return this._currentRank<=this._maxRank}reduce(e,t){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=!1,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),t._bonesComputationForcedToCPU=!0;const i=this._mesh.getScene();for(let e=0;e<i.meshes.length;e++){const s=i.meshes[e];if(s.material){if(s.computeBonesUsingShaders&&0!==s.numBoneInfluencers)if(s.material.getEffect()===t)s.computeBonesUsingShaders=!1;else if(s.subMeshes)for(const e of s.subMeshes)if(e.effect===t){s.computeBonesUsingShaders=!1;break}}else!this._mesh.material&&s.computeBonesUsingShaders&&s.numBoneInfluencers>0&&(s.computeBonesUsingShaders=!1)}}else{const t=this._defines[this._currentRank];if(t)for(let i=0;i<t.length;i++)e=e.replace("#define "+t[i],"");this._currentRank++}return e}}nt.ShadersStore.postprocessVertexShader="attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";class cn{get depthStencilTexture(){return this._depthStencilTexture}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get size(){return this.width}get width(){return this._size.width||this._size}get height(){return this._size.height||this._size}get layers(){return this._size.layers||0}get texture(){var e,t;return null!==(t=null===(e=this._textures)||void 0===e?void 0:e[0])&&void 0!==t?t:null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}get samples(){return this._samples}setSamples(e,t=!0,i=!1){if(this.samples===e&&!i)return e;const s=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,e,t):this._engine.updateRenderTargetTextureSampleCount(this,e);return this._samples=e,s}constructor(e,t,i,s,r){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this._isMulti=e,this._isCube=t,this._size=i,this._engine=s,this._depthStencilTexture=null,this.label=r}setTextures(e){Array.isArray(e)?this._textures=e:this._textures=e?[e]:null}setTexture(e,t=0,i=!0){this._textures||(this._textures=[]),this._textures[t]!==e&&(this._textures[t]&&i&&this._textures[t].dispose(),this._textures[t]=e)}setLayerAndFaceIndices(e,t){this._layerIndices=e,this._faceIndices=t}setLayerAndFaceIndex(e=0,t,i){this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),void 0!==t&&t>=0&&(this._layerIndices[e]=t),void 0!==i&&i>=0&&(this._faceIndices[e]=i)}createDepthStencilTexture(e=0,t=!0,i=!1,s=1,r=14,n){var o;return null===(o=this._depthStencilTexture)||void 0===o||o.dispose(),this._depthStencilTextureWithStencil=i,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:t,comparisonFunction:e,generateStencil:i,isCube:this._isCube,samples:s,depthTextureFormat:r,label:n},this),this._depthStencilTexture}_shareDepth(e){this._depthStencilTexture&&(e._depthStencilTexture&&e._depthStencilTexture.dispose(),e._depthStencilTexture=this._depthStencilTexture,this._depthStencilTexture.incrementReferences())}_swapAndDie(e){this.texture&&this.texture._swapAndDie(e),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){var e,t,i,s,r,n,o,a;let l=null;if(this._isMulti){const i=this.textures;if(i&&i.length>0){let s=!1,r=i.length;const n=i[i.length-1]._source;n!==ut.Depth&&n!==ut.DepthStencil||(s=!0,r--);const o=[],a=[],h=[],c=[],u=[],d=[],p=[],_={};for(let s=0;s<r;++s){const r=i[s];o.push(r.samplingMode),a.push(r.type),h.push(r.format),void 0!==_[r.uniqueId]?(c.push(-1),p.push(0)):(_[r.uniqueId]=s,r.is2DArray?(c.push(35866),p.push(r.depth)):r.isCube?(c.push(34067),p.push(0)):r.is3D?(c.push(32879),p.push(r.depth)):(c.push(3553),p.push(0))),this._faceIndices&&u.push(null!==(e=this._faceIndices[s])&&void 0!==e?e:0),this._layerIndices&&d.push(null!==(t=this._layerIndices[s])&&void 0!==t?t:0)}const f={samplingModes:o,generateMipMaps:i[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:s,types:a,formats:h,textureCount:r,targetTypes:c,faceIndex:u,layerIndex:d,layerCounts:p},m={width:this.width,height:this.height};l=this._engine.createMultipleRenderTarget(m,f);for(let e=0;e<r;++e){if(-1!==c[e])continue;const t=_[i[e].uniqueId];l.setTexture(l.textures[t],e)}}}else{const e={};if(e.generateDepthBuffer=this._generateDepthBuffer,e.generateMipMaps=null!==(s=null===(i=this.texture)||void 0===i?void 0:i.generateMipMaps)&&void 0!==s&&s,e.generateStencilBuffer=this._generateStencilBuffer,e.samplingMode=null===(r=this.texture)||void 0===r?void 0:r.samplingMode,e.type=null===(n=this.texture)||void 0===n?void 0:n.type,e.format=null===(o=this.texture)||void 0===o?void 0:o.format,this.isCube)l=this._engine.createRenderTargetCubeTexture(this.width,e);else{const t={width:this.width,height:this.height,layers:this.is2DArray?null===(a=this.texture)||void 0===a?void 0:a.depth:void 0};l=this._engine.createRenderTargetTexture(t,e)}l.texture.isReady=!0}return l}_swapRenderTargetWrapper(e){if(this._textures&&e._textures)for(let t=0;t<this._textures.length;++t)this._textures[t]._swapAndDie(e._textures[t],!1),e._textures[t].isReady=!0;this._depthStencilTexture&&e._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(e._depthStencilTexture),e._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const e=this._cloneRenderTargetWrapper();if(e){if(this._depthStencilTexture){const t=this._depthStencilTexture.samplingMode,i=2===t||3===t||11===t;e.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,i,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples)}this.samples>1&&e.setSamples(this.samples),e._swapRenderTargetWrapper(this),e.dispose()}}releaseTextures(){var e,t;if(this._textures)for(let i=0;null!==(t=i<(null===(e=this._textures)||void 0===e?void 0:e.length))&&void 0!==t&&t;++i)this._textures[i].dispose();this._textures=null}dispose(e=!1){var t;e||(null===(t=this._depthStencilTexture)||void 0===t||t.dispose(),this._depthStencilTexture=null,this.releaseTextures()),this._engine._releaseRenderTargetWrapper(this)}}class un extends cn{constructor(e,t,i,s,r){super(e,t,i,s),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._disposeOnlyFramebuffers=!1,this._currentLOD=0,this._context=r}_cloneRenderTargetWrapper(){let e=null;return this._colorTextureArray&&this._depthStencilTextureArray?(e=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),e.texture.isReady=!0):e=super._cloneRenderTargetWrapper(),e}_swapRenderTargetWrapper(e){super._swapRenderTargetWrapper(e),e._framebuffer=this._framebuffer,e._depthStencilBuffer=this._depthStencilBuffer,e._MSAAFramebuffer=this._MSAAFramebuffer,e._colorTextureArray=this._colorTextureArray,e._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}_shareDepth(e){super._shareDepth(e);const t=this._context,i=this._depthStencilBuffer,s=e._MSAAFramebuffer||e._framebuffer;e._depthStencilBuffer&&e._depthStencilBuffer!==i&&t.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=i;const r=e._generateStencilBuffer?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;this._engine._bindUnboundFramebuffer(s),t.framebufferRenderbuffer(t.FRAMEBUFFER,r,t.RENDERBUFFER,i),this._engine._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(e,t=0,i,s=0){var r,n,o,a;if(!e._hardwareTexture)return;const l=this._framebuffer,h=this._engine._currentFramebuffer;if(this._engine._bindUnboundFramebuffer(l),this._engine.webGLVersion>1){const l=this._context,h=l["COLOR_ATTACHMENT"+t];e.is2DArray||e.is3D?(i=null!==(n=null!=i?i:null===(r=this.layerIndices)||void 0===r?void 0:r[t])&&void 0!==n?n:0,l.framebufferTextureLayer(l.FRAMEBUFFER,h,e._hardwareTexture.underlyingResource,s,i)):e.isCube?(i=null!==(a=null!=i?i:null===(o=this.faceIndices)||void 0===o?void 0:o[t])&&void 0!==a?a:0,l.framebufferTexture2D(l.FRAMEBUFFER,h,l.TEXTURE_CUBE_MAP_POSITIVE_X+i,e._hardwareTexture.underlyingResource,s)):l.framebufferTexture2D(l.FRAMEBUFFER,h,l.TEXTURE_2D,e._hardwareTexture.underlyingResource,s)}else{const r=this._context,n=r["COLOR_ATTACHMENT"+t+"_WEBGL"],o=void 0!==i?r.TEXTURE_CUBE_MAP_POSITIVE_X+i:r.TEXTURE_2D;r.framebufferTexture2D(r.FRAMEBUFFER,n,o,e._hardwareTexture.underlyingResource,s)}this._engine._bindUnboundFramebuffer(h)}setTexture(e,t=0,i=!0){super.setTexture(e,t,i),this._bindTextureRenderTarget(e,t)}setLayerAndFaceIndices(e,t){var i,s;if(super.setLayerAndFaceIndices(e,t),!this.textures||!this.layerIndices||!this.faceIndices)return;const r=null!==(s=null===(i=this._attachments)||void 0===i?void 0:i.length)&&void 0!==s?s:this.textures.length;for(let e=0;e<r;e++){const t=this.textures[e];t&&(t.is2DArray||t.is3D?this._bindTextureRenderTarget(t,e,this.layerIndices[e]):t.isCube?this._bindTextureRenderTarget(t,e,this.faceIndices[e]):this._bindTextureRenderTarget(t,e))}}setLayerAndFaceIndex(e=0,t,i){if(super.setLayerAndFaceIndex(e,t,i),!this.textures||!this.layerIndices||!this.faceIndices)return;const s=this.textures[e];s.is2DArray||s.is3D?this._bindTextureRenderTarget(this.textures[e],e,this.layerIndices[e]):s.isCube&&this._bindTextureRenderTarget(this.textures[e],e,this.faceIndices[e])}dispose(e=this._disposeOnlyFramebuffers){const t=this._context;e||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(t.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(t.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(t.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(e)}}bt.prototype._createHardwareRenderTargetWrapper=function(e,t,i){const s=new un(e,t,i,this,this._gl);return this._renderTargetWrapperCache.push(s),s},bt.prototype.createRenderTargetTexture=function(e,t){var i,s;const r=this._createHardwareRenderTargetWrapper(!1,!1,e);let n,o=!0,a=!1,l=!1,h=1;void 0!==t&&"object"==typeof t&&(o=null===(i=t.generateDepthBuffer)||void 0===i||i,a=!!t.generateStencilBuffer,l=!!t.noColorAttachment,n=t.colorAttachment,h=null!==(s=t.samples)&&void 0!==s?s:1);const c=n||(l?null:this._createInternalTexture(e,t,!0,ut.RenderTarget)),u=e.width||e,d=e.height||e,p=this._currentFramebuffer,_=this._gl,f=_.createFramebuffer();return this._bindUnboundFramebuffer(f),r._depthStencilBuffer=this._setupFramebufferDepthAttachments(a,o,u,d),c&&!c.is2DArray&&_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_2D,c._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(p),r._framebuffer=f,r._generateDepthBuffer=o,r._generateStencilBuffer=a,r.setTextures(c),this.updateRenderTargetTextureSampleCount(r,h),r},bt.prototype.createDepthStencilTexture=function(e,t,i){if(t.isCube){const s=e.width||e;return this._createDepthStencilCubeTexture(s,t,i)}return this._createDepthStencilTexture(e,t,i)},bt.prototype._createDepthStencilTexture=function(e,t,i){const s=this._gl,r=e.layers||0,n=0!==r?s.TEXTURE_2D_ARRAY:s.TEXTURE_2D,o=new dt(this,ut.DepthStencil);if(!this._caps.depthTextureExtension)return k.Error("Depth texture is not supported by your browser or hardware."),o;const a=Object.assign({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},t);if(this._bindTextureDirectly(n,o,!0),this._setupDepthStencilTexture(o,e,a.generateStencil,0!==a.comparisonFunction&&a.bilinearFiltering,a.comparisonFunction,a.samples),void 0!==a.depthTextureFormat){if(15!==a.depthTextureFormat&&16!==a.depthTextureFormat&&17!==a.depthTextureFormat&&13!==a.depthTextureFormat&&14!==a.depthTextureFormat&&18!==a.depthTextureFormat)return k.Error("Depth texture format is not supported."),o;o.format=a.depthTextureFormat}else o.format=a.generateStencil?13:16;const l=17===o.format||13===o.format||18===o.format;i._depthStencilTexture=o,i._depthStencilTextureWithStencil=l;let h=s.UNSIGNED_INT;15===o.format?h=s.UNSIGNED_SHORT:17===o.format||13===o.format?h=s.UNSIGNED_INT_24_8:14===o.format?h=s.FLOAT:18===o.format&&(h=s.FLOAT_32_UNSIGNED_INT_24_8_REV);const c=l?s.DEPTH_STENCIL:s.DEPTH_COMPONENT;let u=c;this.webGLVersion>1&&(15===o.format?u=s.DEPTH_COMPONENT16:16===o.format?u=s.DEPTH_COMPONENT24:17===o.format||13===o.format?u=s.DEPTH24_STENCIL8:14===o.format?u=s.DEPTH_COMPONENT32F:18===o.format&&(u=s.DEPTH32F_STENCIL8)),o.is2DArray?s.texImage3D(n,0,u,o.width,o.height,r,0,c,h,null):s.texImage2D(n,0,u,o.width,o.height,0,c,h,null),this._bindTextureDirectly(n,null),this._internalTexturesCache.push(o);const d=i;if(d._depthStencilBuffer){const e=this._currentFramebuffer;this._bindUnboundFramebuffer(d._framebuffer),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,null),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,null),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.STENCIL_ATTACHMENT,s.RENDERBUFFER,null),this._bindUnboundFramebuffer(e),s.deleteRenderbuffer(d._depthStencilBuffer),d._depthStencilBuffer=null}return o},bt.prototype.updateRenderTargetTextureSampleCount=function(e,t){if(this.webGLVersion<2||!e||!e.texture)return 1;if(e.samples===t)return t;const i=this._gl;t=Math.min(t,this.getCaps().maxMSAASamples),e._depthStencilBuffer&&(i.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=null),e._MSAAFramebuffer&&(i.deleteFramebuffer(e._MSAAFramebuffer),e._MSAAFramebuffer=null);const s=e.texture._hardwareTexture;if(s.releaseMSAARenderBuffers(),t>1&&"function"==typeof i.renderbufferStorageMultisample){const r=i.createFramebuffer();if(!r)throw new Error("Unable to create multi sampled framebuffer");e._MSAAFramebuffer=r,this._bindUnboundFramebuffer(e._MSAAFramebuffer);const n=this._createRenderBuffer(e.texture.width,e.texture.height,t,-1,this._getRGBABufferInternalSizedFormat(e.texture.type,e.texture.format,e.texture._useSRGBBuffer),i.COLOR_ATTACHMENT0,!1);if(!n)throw new Error("Unable to create multi sampled framebuffer");s.addMSAARenderBuffer(n)}else this._bindUnboundFramebuffer(e._framebuffer);return e.texture.samples=t,e._samples=t,e._depthStencilBuffer=this._setupFramebufferDepthAttachments(e._generateStencilBuffer,e._generateDepthBuffer,e.texture.width,e.texture.height,t),this._bindUnboundFramebuffer(null),t};class dn{static RegisterShaderCodeProcessing(e,t){t?dn._CustomShaderCodeProcessing[null!=e?e:""]=t:delete dn._CustomShaderCodeProcessing[null!=e?e:""]}static _GetShaderCodeProcessing(e){var t;return null!==(t=dn._CustomShaderCodeProcessing[e])&&void 0!==t?t:dn._CustomShaderCodeProcessing[""]}get samples(){return this._samples}set samples(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach((e=>{e.setSamples(this._samples)}))}getEffectName(){return this._fragmentUrl}set onActivate(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}set onSizeChanged(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}set onApply(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(e){this._forcedOutputTexture=e}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(e,t,i,s,r,n,o=1,l,h,c=null,u=0,d="postprocess",p,_=!1,f=5,m=qe.GLSL){var g,v,x,T,S,b,C,y,A,R,I,P;this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.forceAutoClearInAlphaMode=!1,this.alphaMode=0,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new Yt(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new E(1,1),this._texelSize=E.Zero(),this.onActivateObservable=new a,this.onSizeChangedObservable=new a,this.onApplyObservable=new a,this.onBeforeRenderObservable=new a,this.onAfterRenderObservable=new a,this.name=e;let M=1,O=null;if(i&&!Array.isArray(i)){const e=i;i=null!==(g=e.uniforms)&&void 0!==g?g:null,s=null!==(v=e.samplers)&&void 0!==v?v:null,M=null!==(x=e.size)&&void 0!==x?x:1,n=null!==(T=e.camera)&&void 0!==T?T:null,o=null!==(S=e.samplingMode)&&void 0!==S?S:1,l=e.engine,h=e.reusable,c=null!==(b=e.defines)&&void 0!==b?b:null,u=null!==(C=e.textureType)&&void 0!==C?C:0,d=null!==(y=e.vertexUrl)&&void 0!==y?y:"postprocess",p=e.indexParameters,_=null!==(A=e.blockCompilation)&&void 0!==A&&A,f=null!==(R=e.textureFormat)&&void 0!==R?R:5,m=null!==(I=e.shaderLanguage)&&void 0!==I?I:qe.GLSL,O=null!==(P=e.uniformBuffers)&&void 0!==P?P:null}else r&&(M="number"==typeof r?r:{width:r.width,height:r.height});null!=n?(this._camera=n,this._scene=n.getScene(),n.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):l&&(this._engine=l,this._engine.postProcesses.push(this)),this._options=M,this.renderTargetSamplingMode=o||1,this._reusable=h||!1,this._textureType=u,this._textureFormat=f,this._shaderLanguage=m,this._samplers=s||[],this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=d,this._parameters=i||[],this._parameters.push("scale"),this._uniformBuffers=O||[],this._indexParameters=p,this._drawWrapper=new Tt(this._engine),_||this.updateEffect(c)}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._drawWrapper.effect}shareOutputWith(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}useOwnOutput(){0==this._textures.length&&(this._textures=new Yt(2)),this._shareOutputWithPostProcess=null}updateEffect(e=null,t=null,i=null,s,r,n,o,a){var l,h;const c=dn._GetShaderCodeProcessing(this.name);if(null==c?void 0:c.defineCustomBindings){const s=null!==(l=null==t?void 0:t.slice())&&void 0!==l?l:[];s.push(...this._parameters);const r=null!==(h=null==i?void 0:i.slice())&&void 0!==h?h:[];r.push(...this._samplers),e=c.defineCustomBindings(this.name,e,s,r),t=s,i=r}this._postProcessDefines=e,this._drawWrapper.effect=this._engine.createEffect({vertex:null!=o?o:this._vertexUrl,fragment:null!=a?a:this._fragmentUrl},{attributes:["position"],uniformsNames:t||this._parameters,uniformBuffersNames:this._uniformBuffers,samplers:i||this._samplers,defines:null!==e?e:"",fallbacks:null,onCompiled:null!=r?r:null,onError:null!=n?n:null,indexParameters:s||this._indexParameters,processCodeAfterIncludes:(null==c?void 0:c.processCodeAfterIncludes)?(e,t)=>c.processCodeAfterIncludes(this.name,e,t):null,processFinalCode:(null==c?void 0:c.processFinalCode)?(e,t)=>c.processFinalCode(this.name,e,t):null,shaderLanguage:this._shaderLanguage},this._engine)}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(e,t,i=0){for(let s=0;s<this._textureCache.length;s++)if(this._textureCache[s].texture.width===e.width&&this._textureCache[s].texture.height===e.height&&this._textureCache[s].postProcessChannel===i&&this._textureCache[s].texture._generateDepthBuffer===t.generateDepthBuffer&&this._textureCache[s].texture.samples===t.samples)return this._textureCache[s].texture;const s=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:s,postProcessChannel:i,lastUsedRenderId:-1}),s}_flushTextureCache(){const e=this._renderId;for(let t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){let e=!1;for(let i=0;i<this._textures.length;i++)if(this._textures.data[i]===this._textureCache[t].texture){e=!0;break}e||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}}resize(e,t,i=null,s=!1,r=!1){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;let n=null;if(i)for(let e=0;e<i._postProcesses.length;e++)if(null!==i._postProcesses[e]){n=i._postProcesses[e];break}const o={width:this.width,height:this.height},a={generateMipMaps:s,generateDepthBuffer:r||n===this,generateStencilBuffer:(r||n===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(o,a,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(o,a,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let e;if(this._shareOutputWithPostProcess)e=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)e=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{let t;e=this.inputTexture;for(let i=0;i<this._textureCache.length;i++)if(this._textureCache[i].texture===e){t=this._textureCache[i];break}t&&(t.lastUsedRenderId=this._renderId)}return e}activate(e,t=null,i){var s,r;const n=(e=e||this._camera).getScene(),o=n.getEngine(),a=o.getCaps().maxTextureSize,l=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0,h=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0;let c=this._options.width||l,u=this._options.height||h;const d=7!==this.renderTargetSamplingMode&&1!==this.renderTargetSamplingMode&&2!==this.renderTargetSamplingMode;let p=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const e=o.currentViewport;e&&(c*=e.width,u*=e.height)}(d||this.alwaysForcePOT)&&(this._options.width||(c=o.needPOTTextures?Ns.GetExponentOfTwo(c,a,this.scaleMode):c),this._options.height||(u=o.needPOTTextures?Ns.GetExponentOfTwo(u,a,this.scaleMode):u)),this.width===c&&this.height===u&&(p=this._getTarget())||this.resize(c,u,e,d,i),this._textures.forEach((e=>{e.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(e,this.samples)})),this._flushTextureCache(),this._renderId++}return p||(p=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(l/c,h/u),this._engine.bindFramebuffer(p,0,l,h,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(p,0,void 0,void 0,this.forceFullscreenViewport)),null===(r=(s=this._engine)._debugInsertMarker)||void 0===r||r.call(s,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(e),this.autoClear&&(0===this.alphaMode||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:n.clearColor,n._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),p}get isSupported(){return this._drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){var e,t;return null!==(t=null===(e=this._drawWrapper.effect)||void 0===e?void 0:e.isReady())&&void 0!==t&&t}apply(){var e,t,i;if(!(null===(e=this._drawWrapper.effect)||void 0===e?void 0:e.isReady()))return null;let s;return this._engine.enableEffect(this._drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._engine.setAlphaMode(this.alphaMode),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),s=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this.externalTextureSamplerBinding||this._drawWrapper.effect._bindTexture("textureSampler",null==s?void 0:s.texture),this._drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._drawWrapper.effect),null===(i=null===(t=dn._GetShaderCodeProcessing(this.name))||void 0===t?void 0:t.bindCustomBindings)||void 0===i||i.call(t,this.name,this._drawWrapper.effect),this._drawWrapper.effect}_disposeTextures(){this._shareOutputWithPostProcess||this._forcedOutputTexture?this._disposeTextureCache():(this._disposeTextureCache(),this._textures.dispose())}_disposeTextureCache(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}setPrePassRenderer(e){return!!this._prePassEffectConfiguration&&(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0)}dispose(e){let t;if(e=e||this._camera,this._disposeTextures(),this._scene&&(t=this._scene.postProcesses.indexOf(this),-1!==t&&this._scene.postProcesses.splice(t,1)),this._parentContainer){const e=this._parentContainer.postProcesses.indexOf(this);e>-1&&this._parentContainer.postProcesses.splice(e,1),this._parentContainer=null}if(t=this._engine.postProcesses.indexOf(this),-1!==t&&this._engine.postProcesses.splice(t,1),e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),0===t&&e._postProcesses.length>0){const e=this._camera._getFirstPostProcess();e&&e.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear()}}serialize(){const e=de.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}clone(){const e=this.serialize();e._engine=this._engine,e.cameraId=null;const t=dn.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null}static Parse(e,t,i){const s=g(e.customType);if(!s||!s._Parse)return null;const r=t?t.getCameraById(e.cameraId):null;return s._Parse(e,r,t,i)}static _Parse(e,t,i,s){return de.Parse((()=>new dn(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat)),e,i,s)}}dn._CustomShaderCodeProcessing={},me([ie()],dn.prototype,"uniqueId",void 0),me([ie()],dn.prototype,"name",void 0),me([ie()],dn.prototype,"width",void 0),me([ie()],dn.prototype,"height",void 0),me([ie()],dn.prototype,"renderTargetSamplingMode",void 0),me([he()],dn.prototype,"clearColor",void 0),me([ie()],dn.prototype,"autoClear",void 0),me([ie()],dn.prototype,"forceAutoClearInAlphaMode",void 0),me([ie()],dn.prototype,"alphaMode",void 0),me([ie()],dn.prototype,"alphaConstants",void 0),me([ie()],dn.prototype,"enablePixelPerfectMode",void 0),me([ie()],dn.prototype,"forceFullscreenViewport",void 0),me([ie()],dn.prototype,"scaleMode",void 0),me([ie()],dn.prototype,"alwaysForcePOT",void 0),me([ie("samples")],dn.prototype,"_samples",void 0),me([ie()],dn.prototype,"adaptScaleToCurrentViewport",void 0),m("BABYLON.PostProcess",dn);class pn extends $r{constructor(e){super(e,qs.Neutral),this.xSwizzle="x",this.ySwizzle="y",this.zSwizzle="z",this.wSwizzle="w",this.registerInput("xyzw ",$s.Vector4,!0),this.registerInput("xyz ",$s.Vector3,!0),this.registerInput("xy ",$s.Vector2,!0),this.registerInput("zw ",$s.Vector2,!0),this.registerInput("x",$s.Float,!0),this.registerInput("y",$s.Float,!0),this.registerInput("z",$s.Float,!0),this.registerInput("w",$s.Float,!0),this.registerOutput("xyzw",$s.Vector4),this.registerOutput("xyz",$s.Vector3),this.registerOutput("xy",$s.Vector2),this.registerOutput("zw",$s.Vector2)}getClassName(){return"VectorMergerBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get x(){return this._inputs[4]}get y(){return this._inputs[5]}get z(){return this._inputs[6]}get w(){return this._inputs[7]}get xyzw(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xy(){return this.xyOut}get xyz(){return this.xyzOut}_inputRename(e){return"xyzw "===e?"xyzwIn":"xyz "===e?"xyzIn":"xy "===e?"xyIn":"zw "===e?"zwIn":e}_buildSwizzle(e){return"."+(this.xSwizzle+this.ySwizzle+this.zSwizzle+this.wSwizzle).substr(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.x,i=this.y,s=this.z,r=this.w,n=this.xyIn,o=this.zwIn,a=this.xyzIn,l=this.xyzwIn,h=this._outputs[0],c=this._outputs[1],u=this._outputs[2],d=this._outputs[3];return l.isConnected?(h.hasEndpoints&&(e.compilationString+=this._declareOutput(h,e)+` = ${l.associatedVariableName}${this._buildSwizzle(4)};\n`),c.hasEndpoints&&(e.compilationString+=this._declareOutput(c,e)+` = ${l.associatedVariableName}${this._buildSwizzle(3)};\n`),u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+` = ${l.associatedVariableName}${this._buildSwizzle(2)};\n`)):a.isConnected?(h.hasEndpoints&&(e.compilationString+=this._declareOutput(h,e)+` = vec4(${a.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(4)};\n`),c.hasEndpoints&&(e.compilationString+=this._declareOutput(c,e)+` = ${a.associatedVariableName}${this._buildSwizzle(3)};\n`),u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};\n`)):n.isConnected?(h.hasEndpoints&&(o.isConnected?e.compilationString+=this._declareOutput(h,e)+` = vec4(${n.associatedVariableName}, ${o.associatedVariableName})${this._buildSwizzle(4)};\n`:e.compilationString+=this._declareOutput(h,e)+` = vec4(${n.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(4)};\n`),c.hasEndpoints&&(e.compilationString+=this._declareOutput(c,e)+` = vec3(${n.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(3)};\n`),u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+` = ${n.associatedVariableName}${this._buildSwizzle(2)};\n`),d.hasEndpoints&&(o.isConnected?e.compilationString+=this._declareOutput(d,e)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};\n`:e.compilationString+=this._declareOutput(d,e)+` = vec2(${s.isConnected?this._writeVariable(s):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(2)};\n`)):(h.hasEndpoints&&(o.isConnected?e.compilationString+=this._declareOutput(h,e)+` = vec4(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${o.associatedVariableName})${this._buildSwizzle(4)};\n`:e.compilationString+=this._declareOutput(h,e)+` = vec4(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(4)};\n`),c.hasEndpoints&&(e.compilationString+=this._declareOutput(c,e)+` = vec3(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(3)};\n`),u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+` = vec2(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"})${this._buildSwizzle(2)};\n`),d.hasEndpoints&&(o.isConnected?e.compilationString+=this._declareOutput(d,e)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};\n`:e.compilationString+=this._declareOutput(d,e)+` = vec2(${s.isConnected?this._writeVariable(s):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(2)};\n`)),this}serialize(){const e=super.serialize();return e.xSwizzle=this.xSwizzle,e.ySwizzle=this.ySwizzle,e.zSwizzle=this.zSwizzle,e.wSwizzle=this.wSwizzle,e}_deserialize(e,t,i){var s,r,n,o;super._deserialize(e,t,i),this.xSwizzle=null!==(s=e.xSwizzle)&&void 0!==s?s:"x",this.ySwizzle=null!==(r=e.ySwizzle)&&void 0!==r?r:"y",this.zSwizzle=null!==(n=e.zSwizzle)&&void 0!==n?n:"z",this.wSwizzle=null!==(o=e.wSwizzle)&&void 0!==o?o:"w"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.xSwizzle = "${this.xSwizzle}";\n`,e+=`${this._codeVariableName}.ySwizzle = "${this.ySwizzle}";\n`,e+=`${this._codeVariableName}.zSwizzle = "${this.zSwizzle}";\n`,e+=`${this._codeVariableName}.wSwizzle = "${this.wSwizzle}";\n`,e}}m("BABYLON.VectorMergerBlock",pn);class _n extends $r{constructor(e){super(e,qs.Neutral),this.sourceRange=new E(-1,1),this.targetRange=new E(0,1),this.registerInput("input",$s.AutoDetect),this.registerInput("sourceMin",$s.Float,!0),this.registerInput("sourceMax",$s.Float,!0),this.registerInput("targetMin",$s.Float,!0),this.registerInput("targetMax",$s.Float,!0),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"RemapBlock"}get input(){return this._inputs[0]}get sourceMin(){return this._inputs[1]}get sourceMax(){return this._inputs[2]}get targetMin(){return this._inputs[3]}get targetMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),s=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),r=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),n=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=this._declareOutput(t,e)+` = ${r} + (${this._inputs[0].associatedVariableName} - ${i}) * (${n} - ${r}) / (${s} - ${i});\n`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.sourceRange = new BABYLON.Vector2(${this.sourceRange.x}, ${this.sourceRange.y});\n`;return e+=`${this._codeVariableName}.targetRange = new BABYLON.Vector2(${this.targetRange.x}, ${this.targetRange.y});\n`,e}serialize(){const e=super.serialize();return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.sourceRange=E.FromArray(e.sourceRange),this.targetRange=E.FromArray(e.targetRange)}}me([Zr("From",Js.Vector2)],_n.prototype,"sourceRange",void 0),me([Zr("To",Js.Vector2)],_n.prototype,"targetRange",void 0),m("BABYLON.RemapBlock",_n);class fn extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("left",$s.AutoDetect),this.registerInput("right",$s.AutoDetect),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].acceptedConnectionPointTypes.push($s.Float),this._inputs[1].acceptedConnectionPointTypes.push($s.Float)}getClassName(){return"MultiplyBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.left.associatedVariableName} * ${this.right.associatedVariableName};\n`,this}}var mn;m("BABYLON.MultiplyBlock",fn),function(e){e[e.Material=0]="Material",e[e.PostProcess=1]="PostProcess",e[e.Particle=2]="Particle",e[e.ProceduralTexture=3]="ProceduralTexture"}(mn||(mn={}));class gn{constructor(){this.direction1=new S(0,1,0),this.direction2=new S(0,1,0),this.minEmitBox=new S(-.5,-.5,-.5),this.maxEmitBox=new S(.5,.5,.5)}startDirectionFunction(e,t,i,s){const r=l.RandomRange(this.direction1.x,this.direction2.x),n=l.RandomRange(this.direction1.y,this.direction2.y),o=l.RandomRange(this.direction1.z,this.direction2.z);if(s)return t.x=r,t.y=n,void(t.z=o);S.TransformNormalFromFloatsToRef(r,n,o,e,t)}startPositionFunction(e,t,i,s){const r=l.RandomRange(this.minEmitBox.x,this.maxEmitBox.x),n=l.RandomRange(this.minEmitBox.y,this.maxEmitBox.y),o=l.RandomRange(this.minEmitBox.z,this.maxEmitBox.z);if(s)return t.x=r,t.y=n,void(t.z=o);S.TransformCoordinatesFromFloatsToRef(r,n,o,e,t)}clone(){const e=new gn;return H.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2),e.setVector3("minEmitBox",this.minEmitBox),e.setVector3("maxEmitBox",this.maxEmitBox)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3),e.addUniform("minEmitBox",3),e.addUniform("maxEmitBox",3)}getEffectDefines(){return"#define BOXEMITTER"}getClassName(){return"BoxParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.minEmitBox=this.minEmitBox.asArray(),e.maxEmitBox=this.maxEmitBox.asArray(),e}parse(e){S.FromArrayToRef(e.direction1,0,this.direction1),S.FromArrayToRef(e.direction2,0,this.direction2),S.FromArrayToRef(e.minEmitBox,0,this.minEmitBox),S.FromArrayToRef(e.maxEmitBox,0,this.maxEmitBox)}}class vn{get radius(){return this._radius}set radius(e){this._radius=e,this._buildHeight()}get angle(){return this._angle}set angle(e){this._angle=e,this._buildHeight()}_buildHeight(){0!==this._angle?this._height=this._radius/Math.tan(this._angle/2):this._height=1}constructor(e=1,t=Math.PI,i=0){this.directionRandomizer=i,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=t,this.radius=e}startDirectionFunction(e,t,i,s){s?R.Vector3[0].copyFrom(i._localPosition).normalize():i.position.subtractToRef(e.getTranslation(),R.Vector3[0]).normalize();const r=l.RandomRange(0,this.directionRandomizer),n=l.RandomRange(0,this.directionRandomizer),o=l.RandomRange(0,this.directionRandomizer);t.x=R.Vector3[0].x+r,t.y=R.Vector3[0].y+n,t.z=R.Vector3[0].z+o,t.normalize()}startPositionFunction(e,t,i,s){const r=l.RandomRange(0,2*Math.PI);let n;this.emitFromSpawnPointOnly?n=1e-4:(n=l.RandomRange(0,this.heightRange),n=1-n*n);let o=this._radius-l.RandomRange(0,this._radius*this.radiusRange);o*=n;const a=o*Math.sin(r),h=o*Math.cos(r),c=n*this._height;if(s)return t.x=a,t.y=c,void(t.z=h);S.TransformCoordinatesFromFloatsToRef(a,c,h,e,t)}clone(){const e=new vn(this._radius,this._angle,this.directionRandomizer);return H.DeepCopy(this,e),e}applyToShader(e){e.setFloat2("radius",this._radius,this.radiusRange),e.setFloat("coneAngle",this._angle),e.setFloat2("height",this._height,this.heightRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",2),e.addUniform("coneAngle",1),e.addUniform("height",2),e.addUniform("directionRandomizer",1)}getEffectDefines(){let e="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(e+="\n#define CONEEMITTERSPAWNPOINT"),e}getClassName(){return"ConeParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this._radius,e.angle=this._angle,e.directionRandomizer=this.directionRandomizer,e.radiusRange=this.radiusRange,e.heightRange=this.heightRange,e.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,e}parse(e){this.radius=e.radius,this.angle=e.angle,this.directionRandomizer=e.directionRandomizer,this.radiusRange=void 0!==e.radiusRange?e.radiusRange:1,this.heightRange=void 0!==e.radiusRange?e.heightRange:1,this.emitFromSpawnPointOnly=void 0!==e.emitFromSpawnPointOnly&&e.emitFromSpawnPointOnly}}class xn{constructor(e=1,t=1,i=1,s=0){this.radius=e,this.height=t,this.radiusRange=i,this.directionRandomizer=s,this._tempVector=S.Zero()}startDirectionFunction(e,t,i,s,r){i.position.subtractToRef(e.getTranslation(),this._tempVector),this._tempVector.normalize(),S.TransformNormalToRef(this._tempVector,r,this._tempVector);const n=l.RandomRange(-this.directionRandomizer/2,this.directionRandomizer/2);let o=Math.atan2(this._tempVector.x,this._tempVector.z);o+=l.RandomRange(-Math.PI/2,Math.PI/2)*this.directionRandomizer,this._tempVector.y=n,this._tempVector.x=Math.sin(o),this._tempVector.z=Math.cos(o),this._tempVector.normalize(),s?t.copyFrom(this._tempVector):S.TransformNormalFromFloatsToRef(this._tempVector.x,this._tempVector.y,this._tempVector.z,e,t)}startPositionFunction(e,t,i,s){const r=l.RandomRange(-this.height/2,this.height/2),n=l.RandomRange(0,2*Math.PI),o=l.RandomRange((1-this.radiusRange)*(1-this.radiusRange),1),a=Math.sqrt(o)*this.radius,h=a*Math.cos(n),c=a*Math.sin(n);s?t.copyFromFloats(h,r,c):S.TransformCoordinatesFromFloatsToRef(h,r,c,e,t)}clone(){const e=new xn(this.radius,this.directionRandomizer);return H.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define CYLINDEREMITTER"}getClassName(){return"CylinderParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.height=this.height,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.height=e.height,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class Tn extends xn{constructor(e=1,t=1,i=1,s=new S(0,1,0),r=new S(0,1,0)){super(e,t,i),this.direction1=s,this.direction2=r}startDirectionFunction(e,t){const i=l.RandomRange(this.direction1.x,this.direction2.x),s=l.RandomRange(this.direction1.y,this.direction2.y),r=l.RandomRange(this.direction1.z,this.direction2.z);S.TransformNormalFromFloatsToRef(i,s,r,e,t)}clone(){const e=new Tn(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return H.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define CYLINDEREMITTER\n#define DIRECTEDCYLINDEREMITTER"}getClassName(){return"CylinderDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}class En{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,s){const r=i.position.subtract(e.getTranslation()).normalize(),n=l.RandomRange(0,this.directionRandomizer),o=l.RandomRange(0,this.directionRandomizer),a=l.RandomRange(0,this.directionRandomizer);r.x+=n,r.y+=o,r.z+=a,r.normalize(),s?t.copyFrom(r):S.TransformNormalFromFloatsToRef(r.x,r.y,r.z,e,t)}startPositionFunction(e,t,i,s){const r=this.radius-l.RandomRange(0,this.radius*this.radiusRange),n=l.RandomRange(0,1),o=l.RandomRange(0,2*Math.PI),a=Math.acos(2*n-1),h=r*Math.cos(o)*Math.sin(a),c=r*Math.cos(a),u=r*Math.sin(o)*Math.sin(a);s?t.copyFromFloats(h,Math.abs(c),u):S.TransformCoordinatesFromFloatsToRef(h,Math.abs(c),u,e,t)}clone(){const e=new En(this.radius,this.directionRandomizer);return H.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define HEMISPHERICEMITTER"}getClassName(){return"HemisphericParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class Sn{constructor(){this.direction1=new S(0,1,0),this.direction2=new S(0,1,0)}startDirectionFunction(e,t,i,s){const r=l.RandomRange(this.direction1.x,this.direction2.x),n=l.RandomRange(this.direction1.y,this.direction2.y),o=l.RandomRange(this.direction1.z,this.direction2.z);s?t.copyFromFloats(r,n,o):S.TransformNormalFromFloatsToRef(r,n,o,e,t)}startPositionFunction(e,t,i,s){s?t.copyFromFloats(0,0,0):S.TransformCoordinatesFromFloatsToRef(0,0,0,e,t)}clone(){const e=new Sn;return H.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define POINTEMITTER"}getClassName(){return"PointParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){S.FromArrayToRef(e.direction1,0,this.direction1),S.FromArrayToRef(e.direction2,0,this.direction2)}}class bn{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,s){const r=i.position.subtract(e.getTranslation()).normalize(),n=l.RandomRange(0,this.directionRandomizer),o=l.RandomRange(0,this.directionRandomizer),a=l.RandomRange(0,this.directionRandomizer);r.x+=n,r.y+=o,r.z+=a,r.normalize(),s?t.copyFrom(r):S.TransformNormalFromFloatsToRef(r.x,r.y,r.z,e,t)}startPositionFunction(e,t,i,s){const r=this.radius-l.RandomRange(0,this.radius*this.radiusRange),n=l.RandomRange(0,1),o=l.RandomRange(0,2*Math.PI),a=Math.acos(2*n-1),h=r*Math.cos(o)*Math.sin(a),c=r*Math.cos(a),u=r*Math.sin(o)*Math.sin(a);s?t.copyFromFloats(h,c,u):S.TransformCoordinatesFromFloatsToRef(h,c,u,e,t)}clone(){const e=new bn(this.radius,this.directionRandomizer);return H.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define SPHEREEMITTER"}getClassName(){return"SphereParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class Cn extends bn{constructor(e=1,t=new S(0,1,0),i=new S(0,1,0)){super(e),this.direction1=t,this.direction2=i}startDirectionFunction(e,t){const i=l.RandomRange(this.direction1.x,this.direction2.x),s=l.RandomRange(this.direction1.y,this.direction2.y),r=l.RandomRange(this.direction1.z,this.direction2.z);S.TransformNormalFromFloatsToRef(i,s,r,e,t)}clone(){const e=new Cn(this.radius,this.direction1,this.direction2);return H.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define SPHEREEMITTER\n#define DIRECTEDSPHEREEMITTER"}getClassName(){return"SphereDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}class yn{constructor(){this.particlePositionGenerator=()=>{},this.particleDestinationGenerator=()=>{}}startDirectionFunction(e,t,i,s){const r=R.Vector3[0];if(this.particleDestinationGenerator){this.particleDestinationGenerator(-1,i,r);const e=R.Vector3[1];r.subtractToRef(i.position,e),e.scaleToRef(1/i.lifeTime,r)}else r.set(0,0,0);s?t.copyFrom(r):S.TransformNormalToRef(r,e,t)}startPositionFunction(e,t,i,s){const r=R.Vector3[0];this.particlePositionGenerator?this.particlePositionGenerator(-1,i,r):r.set(0,0,0),s?t.copyFrom(r):S.TransformCoordinatesToRef(r,e,t)}clone(){const e=new yn;return H.DeepCopy(this,e),e}applyToShader(e){}buildUniformLayout(e){}getEffectDefines(){return"#define CUSTOMEMITTER"}getClassName(){return"CustomParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e}parse(e){}}class An{get mesh(){return this._mesh}set mesh(e){this._mesh!==e&&(this._mesh=e,e?(this._indices=e.getIndices(),this._positions=e.getVerticesData(hi.PositionKind),this._normals=e.getVerticesData(hi.NormalKind)):(this._indices=null,this._positions=null,this._normals=null))}constructor(e=null){this._indices=null,this._positions=null,this._normals=null,this._storedNormal=S.Zero(),this._mesh=null,this.direction1=new S(0,1,0),this.direction2=new S(0,1,0),this.useMeshNormalsForDirection=!0,this.mesh=e}startDirectionFunction(e,t,i,s){if(this.useMeshNormalsForDirection&&this._normals)return void S.TransformNormalToRef(this._storedNormal,e,t);const r=l.RandomRange(this.direction1.x,this.direction2.x),n=l.RandomRange(this.direction1.y,this.direction2.y),o=l.RandomRange(this.direction1.z,this.direction2.z);s?t.copyFromFloats(r,n,o):S.TransformNormalFromFloatsToRef(r,n,o,e,t)}startPositionFunction(e,t,i,s){if(!this._indices||!this._positions)return;const r=3*Math.random()*(this._indices.length/3)|0,n=Math.random(),o=Math.random()*(1-n),a=1-n-o,l=this._indices[r],h=this._indices[r+1],c=this._indices[r+2],u=R.Vector3[0],d=R.Vector3[1],p=R.Vector3[2],_=R.Vector3[3];S.FromArrayToRef(this._positions,3*l,u),S.FromArrayToRef(this._positions,3*h,d),S.FromArrayToRef(this._positions,3*c,p),_.x=n*u.x+o*d.x+a*p.x,_.y=n*u.y+o*d.y+a*p.y,_.z=n*u.z+o*d.z+a*p.z,s?t.copyFromFloats(_.x,_.y,_.z):S.TransformCoordinatesFromFloatsToRef(_.x,_.y,_.z,e,t),this.useMeshNormalsForDirection&&this._normals&&(S.FromArrayToRef(this._normals,3*l,u),S.FromArrayToRef(this._normals,3*h,d),S.FromArrayToRef(this._normals,3*c,p),this._storedNormal.x=n*u.x+o*d.x+a*p.x,this._storedNormal.y=n*u.y+o*d.y+a*p.y,this._storedNormal.z=n*u.z+o*d.z+a*p.z)}clone(){const e=new An(this.mesh);return H.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return""}getClassName(){return"MeshParticleEmitter"}serialize(){var e;const t={};return t.type=this.getClassName(),t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t.meshId=null===(e=this.mesh)||void 0===e?void 0:e.id,t.useMeshNormalsForDirection=this.useMeshNormalsForDirection,t}parse(e,t){S.FromArrayToRef(e.direction1,0,this.direction1),S.FromArrayToRef(e.direction2,0,this.direction2),e.meshId&&t&&(this.mesh=t.getLastMeshById(e.meshId)),this.useMeshNormalsForDirection=e.useMeshNormalsForDirection}}class Rn{get noiseTexture(){return this._noiseTexture}set noiseTexture(e){this._noiseTexture!==e&&(this._noiseTexture=e,this._reset())}get isAnimationSheetEnabled(){return this._isAnimationSheetEnabled}set isAnimationSheetEnabled(e){this._isAnimationSheetEnabled!=e&&(this._isAnimationSheetEnabled=e,this._reset())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported}getScene(){return this._scene}_hasTargetStopDurationDependantGradient(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0}getDragGradients(){return this._dragGradients}getLimitVelocityGradients(){return this._limitVelocityGradients}getColorGradients(){return this._colorGradients}getSizeGradients(){return this._sizeGradients}getColorRemapGradients(){return this._colorRemapGradients}getAlphaRemapGradients(){return this._alphaRemapGradients}getLifeTimeGradients(){return this._lifeTimeGradients}getAngularSpeedGradients(){return this._angularSpeedGradients}getVelocityGradients(){return this._velocityGradients}getStartSizeGradients(){return this._startSizeGradients}getEmitRateGradients(){return this._emitRateGradients}get direction1(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:S.Zero()}set direction1(e){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=e)}get direction2(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:S.Zero()}set direction2(e){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=e)}get minEmitBox(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:S.Zero()}set minEmitBox(e){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=e)}get maxEmitBox(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:S.Zero()}set maxEmitBox(e){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=e)}get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._reset())}get isBillboardBased(){return this._isBillboardBased}set isBillboardBased(e){this._isBillboardBased!==e&&(this._isBillboardBased=e,this._reset())}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(!e&&this._scene?this._imageProcessingConfiguration=this._scene.imageProcessingConfiguration:this._imageProcessingConfiguration=e)}_reset(){}_removeGradientAndTexture(e,t,i){if(!t)return this;let s=0;for(const i of t){if(i.gradient===e){t.splice(s,1);break}s++}return i&&i.dispose(),this}constructor(e){this.animations=[],this.renderingGroupId=0,this.emitter=S.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this._wasDispatched=!1,this._rootUrl="",this.noiseStrength=new S(10,10,10),this.onAnimationEnd=null,this.blendMode=Rn.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new E(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new S(0,0,0),this._useLogarithmicDepth=!1,this.gravity=S.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new F(1,1,1,1),this.color2=new F(1,1,1,1),this.colorDead=new F(0,0,0,1),this.textureMask=new F(1,1,1,1),this._isSubEmitter=!1,this._billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new Qt,this.id=e,this.name=e}createPointEmitter(e,t){const i=new Sn;return i.direction1=e,i.direction2=t,this.particleEmitterType=i,i}createHemisphericEmitter(e=1,t=1){const i=new En(e,t);return this.particleEmitterType=i,i}createSphereEmitter(e=1,t=1){const i=new bn(e,t);return this.particleEmitterType=i,i}createDirectedSphereEmitter(e=1,t=new S(0,1,0),i=new S(0,1,0)){const s=new Cn(e,t,i);return this.particleEmitterType=s,s}createCylinderEmitter(e=1,t=1,i=1,s=0){const r=new xn(e,t,i,s);return this.particleEmitterType=r,r}createDirectedCylinderEmitter(e=1,t=1,i=1,s=new S(0,1,0),r=new S(0,1,0)){const n=new Tn(e,t,i,s,r);return this.particleEmitterType=n,n}createConeEmitter(e=1,t=Math.PI/4){const i=new vn(e,t);return this.particleEmitterType=i,i}createBoxEmitter(e,t,i,s){const r=new gn;return this.particleEmitterType=r,this.direction1=e,this.direction2=t,this.minEmitBox=i,this.maxEmitBox=s,r}}Rn.BLENDMODE_ONEONE=0,Rn.BLENDMODE_STANDARD=1,Rn.BLENDMODE_ADD=2,Rn.BLENDMODE_MULTIPLY=3,Rn.BLENDMODE_MULTIPLYADD=4;class In extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("rgba",$s.Color4,!0),this.registerInput("rgb ",$s.Color3,!0),this.registerOutput("rgb",$s.Color3),this.registerOutput("r",$s.Float),this.registerOutput("g",$s.Float),this.registerOutput("b",$s.Float),this.registerOutput("a",$s.Float),this.inputsAreExclusive=!0}getClassName(){return"ColorSplitterBlock"}get rgba(){return this._inputs[0]}get rgbIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get r(){return this._outputs[1]}get g(){return this._outputs[2]}get b(){return this._outputs[3]}get a(){return this._outputs[4]}_inputRename(e){return"rgb "===e?"rgbIn":e}_outputRename(e){return"rgb"===e?"rgbOut":e}_buildBlock(e){super._buildBlock(e);const t=this.rgba.isConnected?this.rgba:this.rgbIn;if(!t.isConnected)return;const i=this._outputs[0],s=this._outputs[1],r=this._outputs[2],n=this._outputs[3],o=this._outputs[4];return i.hasEndpoints&&(e.compilationString+=this._declareOutput(i,e)+` = ${t.associatedVariableName}.rgb;\n`),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+` = ${t.associatedVariableName}.r;\n`),r.hasEndpoints&&(e.compilationString+=this._declareOutput(r,e)+` = ${t.associatedVariableName}.g;\n`),n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = ${t.associatedVariableName}.b;\n`),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = ${t.associatedVariableName}.a;\n`),this}}m("BABYLON.ColorSplitterBlock",In),bt.prototype.createRenderTargetCubeTexture=function(e,t){const i=this._createHardwareRenderTargetWrapper(!1,!0,e),s=Object.assign({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5},t);s.generateStencilBuffer=s.generateDepthBuffer&&s.generateStencilBuffer,(1!==s.type||this._caps.textureFloatLinearFiltering)&&(2!==s.type||this._caps.textureHalfFloatLinearFiltering)||(s.samplingMode=1);const r=this._gl,n=new dt(this,ut.RenderTarget);this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,n,!0);const o=this._getSamplingParameters(s.samplingMode,s.generateMipMaps);1!==s.type||this._caps.textureFloat||(s.type=0,k.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MAG_FILTER,o.mag),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MIN_FILTER,o.min),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE);for(let t=0;t<6;t++)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,this._getRGBABufferInternalSizedFormat(s.type,s.format),e,e,0,this._getInternalFormat(s.format),this._getWebGLTextureType(s.type),null);const a=r.createFramebuffer();return this._bindUnboundFramebuffer(a),i._depthStencilBuffer=this._setupFramebufferDepthAttachments(s.generateStencilBuffer,s.generateDepthBuffer,e,e),s.generateMipMaps&&r.generateMipmap(r.TEXTURE_CUBE_MAP),this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),i._framebuffer=a,i._generateDepthBuffer=s.generateDepthBuffer,i._generateStencilBuffer=s.generateStencilBuffer,n.width=e,n.height=e,n.isReady=!0,n.isCube=!0,n.samples=1,n.generateMipMaps=s.generateMipMaps,n.samplingMode=s.samplingMode,n.type=s.type,n.format=s.format,this._internalTexturesCache.push(n),i.setTextures(n),i};const Pn={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class Mn{constructor(e,t=Pn){var i,s;this._fullscreenViewport=new ds(0,0,1,1);const r=null!==(i=t.positions)&&void 0!==i?i:Pn.positions,n=null!==(s=t.indices)&&void 0!==s?s:Pn.indices;this.engine=e,this._vertexBuffers={[hi.PositionKind]:new hi(e,r,hi.PositionKind,!1,!1,2)},this._indexBuffer=e.createIndexBuffer(n),this._onContextRestoredObserver=e.onContextRestoredObservable.add((()=>{this._indexBuffer=e.createIndexBuffer(n);for(const e in this._vertexBuffers)this._vertexBuffers[e]._rebuild()}))}setViewport(e=this._fullscreenViewport){this.engine.setViewport(e)}bindBuffers(e){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)}applyEffectWrapper(e){this.engine.setState(!0),this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(e._drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.engine.depthCullingState.depthTest,this._savedStateStencilTest=this.engine.stencilState.stencilTest}restoreStates(){this.engine.depthCullingState.depthTest=this._savedStateDepthTest,this.engine.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.engine.drawElementsType(0,0,6)}_isRenderTargetTexture(e){return void 0!==e.renderTarget}render(e,t=null){if(!e.effect.isReady())return;this.saveStates(),this.setViewport();const i=null===t?null:this._isRenderTargetTexture(t)?t.renderTarget:t;i&&this.engine.bindFramebuffer(i),this.applyEffectWrapper(e),this.draw(),i&&this.engine.unBindFramebuffer(i),this.restoreStates()}dispose(){const e=this._vertexBuffers[hi.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[hi.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class On{get effect(){return this._drawWrapper.effect}set effect(e){this._drawWrapper.effect=e}constructor(e){let t;this.onApplyObservable=new a;const i=e.uniformNames||[];e.vertexShader?t={fragmentSource:e.fragmentShader,vertexSource:e.vertexShader,spectorName:e.name||"effectWrapper"}:(i.push("scale"),t={fragmentSource:e.fragmentShader,vertex:"postprocess",spectorName:e.name||"effectWrapper"},this.onApplyObservable.add((()=>{this.effect.setFloat2("scale",1,1)})));const s=e.defines?e.defines.join("\n"):"";this._drawWrapper=new Tt(e.engine),e.useShaderStore?(t.fragment=t.fragmentSource,t.vertex||(t.vertex=t.vertexSource),delete t.fragmentSource,delete t.vertexSource,this.effect=e.engine.createEffect(t,e.attributeNames||["position"],i,e.samplerNames,s,void 0,e.onCompiled,void 0,void 0,e.shaderLanguage)):(this.effect=new ot(t,e.attributeNames||["position"],i,e.samplerNames,e.engine,s,void 0,e.onCompiled,void 0,void 0,void 0,e.shaderLanguage),this._onContextRestoredObserver=e.engine.onContextRestoredObservable.add((()=>{this.effect._pipelineContext=null,this.effect._wasPreviouslyReady=!1,this.effect._prepareEffect()})))}dispose(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.effect.dispose()}}const Dn="passPixelShader",Nn="varying vec2 vUV;uniform sampler2D textureSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=texture2D(textureSampler,vUV);}";nt.ShadersStore[Dn]=Nn;const Fn=Dn,wn=Nn;class Ln{static _CreateDumpRenderer(){if(!Ln._DumpToolsEngine){let e,t=null;const i={preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1};try{e=new OffscreenCanvas(100,100),t=new bt(e,!1,i)}catch(s){e=document.createElement("canvas"),t=new bt(e,!1,i)}t.getCaps().parallelShaderCompile=void 0;const s=new Mn(t),r=new On({engine:t,name:Fn,fragmentShader:wn,samplerNames:["textureSampler"]});Ln._DumpToolsEngine={canvas:e,engine:t,renderer:s,wrapper:r}}return Ln._DumpToolsEngine}static async DumpFramebuffer(e,t,i,s,r="image/png",n,o){const a=await i.readPixels(0,0,e,t),l=new Uint8Array(a.buffer);Ln.DumpData(e,t,l,s,r,n,!0,void 0,o)}static DumpDataAsync(e,t,i,s="image/png",r,n=!1,o=!1,a){return new Promise((l=>{Ln.DumpData(e,t,i,(e=>l(e)),s,r,n,o,a)}))}static DumpData(e,t,i,s,r="image/png",n,o=!1,a=!1,h){const c=Ln._CreateDumpRenderer();if(c.engine.setSize(e,t,!0),i instanceof Float32Array){const e=new Uint8Array(i.length);let t=i.length;for(;t--;){const s=i[t];e[t]=Math.round(255*l.Clamp(s))}i=e}const u=c.engine.createRawTexture(i,e,t,5,!1,!o,1);c.renderer.setViewport(),c.renderer.applyEffectWrapper(c.wrapper),c.wrapper.effect._bindTexture("textureSampler",u),c.renderer.draw(),a?Ht.ToBlob(c.canvas,(e=>{const t=new FileReader;t.onload=e=>{const t=e.target.result;s&&s(t)},t.readAsArrayBuffer(e)}),r,h):Ht.EncodeScreenshotCanvasData(c.canvas,s,r,n,h),u.dispose()}static Dispose(){Ln._DumpToolsEngine&&(Ln._DumpToolsEngine.wrapper.dispose(),Ln._DumpToolsEngine.renderer.dispose(),Ln._DumpToolsEngine.engine.dispose()),Ln._DumpToolsEngine=null}}Ht.DumpData=Ln.DumpData,Ht.DumpDataAsync=Ln.DumpDataAsync,Ht.DumpFramebuffer=Ln.DumpFramebuffer;class Bn extends Ar{get renderList(){return this._renderList}set renderList(e){this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),e&&(this._unObserveRenderList=_(e,this._renderListHasChanged)),this._renderList=e}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(e){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}set onClear(e){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(e)}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(e,t){let i;i=Array.isArray(e)?e:[e];for(let e=0;e<i.length;++e)for(let s=0;s<this._renderPassIds.length;++s)i[e].setMaterialForRenderPass(this._renderPassIds[s],void 0!==t?Array.isArray(t)?t[s]:t:void 0)}get isMulti(){var e,t;return null!==(t=null===(e=this._renderTarget)||void 0===e?void 0:e.isMulti)&&void 0!==t&&t}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var e,t;return null!==(t=null===(e=this._renderTarget)||void 0===e?void 0:e._depthStencilTexture)&&void 0!==t?t:null}constructor(e,t,i,s=!1,r=!0,n=0,o=!1,l=Ar.TRILINEAR_SAMPLINGMODE,h=!0,c=!1,u=!1,d=5,p=!1,_,f,m=!1,g=!1){var v,x,T,E,b,C,A;let R,I=!0;if("object"==typeof s){const e=s;s=!!e.generateMipMaps,r=null===(v=e.doNotChangeAspectRatio)||void 0===v||v,n=null!==(x=e.type)&&void 0!==x?x:0,o=!!e.isCube,l=null!==(T=e.samplingMode)&&void 0!==T?T:Ar.TRILINEAR_SAMPLINGMODE,h=null===(E=e.generateDepthBuffer)||void 0===E||E,c=!!e.generateStencilBuffer,u=!!e.isMulti,d=null!==(b=e.format)&&void 0!==b?b:5,p=!!e.delayAllocation,_=e.samples,f=e.creationFlags,m=!!e.noColorAttachment,g=!!e.useSRGBBuffer,R=e.colorAttachment,I=null!==(C=e.gammaSpace)&&void 0!==C?C:I}if(super(null,i,!s,void 0,l,void 0,void 0,void 0,void 0,d),this._unObserveRenderList=null,this._renderListHasChanged=(e,t)=>{var i;const s=this._renderList?this._renderList.length:0;(0===t&&s>0||0===s)&&(null===(i=this.getScene())||void 0===i||i.meshes.forEach((e=>{e._markSubMeshesAsLightDirty()})))},this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new a,this.onAfterUnbindObservable=new a,this.onBeforeRenderObservable=new a,this.onAfterRenderObservable=new a,this.onClearObservable=new a,this.onResizeObservable=new a,this._cleared=!1,this.skipInitialClear=!1,this._currentRefreshId=-1,this._refreshRate=1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this.boundingBoxPosition=S.Zero(),!(i=this.getScene()))return;const P=this.getScene().getEngine();this._gammaSpace=I,this._coordinatesMode=Ar.PROJECTION_MODE,this.renderList=[],this.name=e,this.isRenderTarget=!0,this._initialSizeParameter=t,this._renderPassIds=[],this._isCubeData=o,this._processSizeParameter(t),this.renderPassId=this._renderPassIds[0],this._resizeObserver=P.onResizeObservable.add((()=>{})),this._generateMipMaps=!!s,this._doNotChangeAspectRatio=r,this._renderingManager=new _i(i),this._renderingManager._useSceneAutoClearSetup=!0,u||(this._renderTargetOptions={generateMipMaps:s,type:n,format:null!==(A=this._format)&&void 0!==A?A:void 0,samplingMode:this.samplingMode,generateDepthBuffer:h,generateStencilBuffer:c,samples:_,creationFlags:f,noColorAttachment:m,useSRGBBuffer:g,colorAttachment:R,label:this.name},this.samplingMode===Ar.NEAREST_SAMPLINGMODE&&(this.wrapU=Ar.CLAMP_ADDRESSMODE,this.wrapV=Ar.CLAMP_ADDRESSMODE),p||(o?(this._renderTarget=i.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=Ar.INVCUBIC_MODE,this._textureMatrix=y.Identity()):this._renderTarget=i.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==_&&(this.samples=_)))}createDepthStencilTexture(e=0,t=!0,i=!1,s=1,r=14){var n;null===(n=this._renderTarget)||void 0===n||n.createDepthStencilTexture(e,t,i,s,r)}_releaseRenderPassId(){if(this._scene){const e=this._scene.getEngine();for(let t=0;t<this._renderPassIds.length;++t)e.releaseRenderPassId(this._renderPassIds[t])}this._renderPassIds=[]}_createRenderPassId(){this._releaseRenderPassId();const e=this._scene.getEngine(),t=this._isCubeData?6:this.getRenderLayers()||1;for(let i=0;i<t;++i)this._renderPassIds[i]=e.createRenderPassId(`RenderTargetTexture - ${this.name}#${i}`)}_processSizeParameter(e,t=!0){if(e.ratio){this._sizeRatio=e.ratio;const t=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(t.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(t.getRenderHeight(),this._sizeRatio)}}else this._size=e;t&&this._createRenderPassId()}get samples(){var e,t;return null!==(t=null===(e=this._renderTarget)||void 0===e?void 0:e.samples)&&void 0!==t?t:this._samples}set samples(e){this._renderTarget&&(this._samples=this._renderTarget.setSamples(e))}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}addPostProcess(e){if(!this._postProcessManager){const e=this.getScene();if(!e)return;this._postProcessManager=new ui(e),this._postProcesses=new Array}this._postProcesses.push(e),this._postProcesses[0].autoClear=!1}clearPostProcesses(e=!1){if(this._postProcesses){if(e)for(const e of this._postProcesses)e.dispose();this._postProcesses=[]}}removePostProcess(e){if(!this._postProcesses)return;const t=this._postProcesses.indexOf(e);-1!==t&&(this._postProcesses.splice(t,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}_shouldRender(){return-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){return this._size.layers||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(e){const t=Math.max(1,this.getRenderSize()*e);this.resize(t)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(e){var t;const i=this.isCube;null===(t=this._renderTarget)||void 0===t||t.dispose(),this._renderTarget=null;const s=this.getScene();s&&(this._processSizeParameter(e,!1),this._renderTarget=i?s.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):s.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==this._renderTargetOptions.samples&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(e=!1,t=!1){this._render(e,t)}isReadyForRendering(){return this._render(!1,!1,!0)}_render(e=!1,t=!1,i=!1){var s;const r=this.getScene();if(!r)return i;const n=r.getEngine();if(void 0!==this.useCameraPostProcesses&&(e=this.useCameraPostProcesses),this._waitingRenderList){this.renderList=[];for(let e=0;e<this._waitingRenderList.length;e++){const t=this._waitingRenderList[e],i=r.getMeshById(t);i&&this.renderList.push(i)}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const e=this.getScene();if(!e)return i;const t=e.meshes;for(let e=0;e<t.length;e++){const i=t[e];this.renderListPredicate(i)&&this.renderList.push(i)}}const o=n.currentRenderPassId;this.onBeforeBindObservable.notifyObservers(this);const a=null!==(s=this.activeCamera)&&void 0!==s?s:r.activeCamera,l=r.activeCamera;a&&(a!==r.activeCamera&&(r.setTransformMatrix(a.getViewMatrix(),a.getProjectionMatrix(!0)),r.activeCamera=a),n.setViewport(a.rigParent?a.rigParent.viewport:a.viewport,this.getRenderWidth(),this.getRenderHeight())),this._defaultRenderListPrepared=!1;let h=i;if(i){r.getViewMatrix()||r.updateTransformMatrix();const e=this.is2DArray?this.getRenderLayers():this.isCube?6:1;for(let t=0;t<e&&h;t++){let e=null;const s=this.renderList?this.renderList:r.getActiveMeshes().data,o=this.renderList?this.renderList.length:r.getActiveMeshes().length;n.currentRenderPassId=this._renderPassIds[t],this.onBeforeRenderObservable.notifyObservers(t),this.getCustomRenderList&&(e=this.getCustomRenderList(t,s,o)),e||(e=s),this._doNotChangeAspectRatio||r.updateTransformMatrix(!0);for(let t=0;t<e.length&&h;++t){const s=e[t];if(s.isEnabled()&&!s.isBlocked&&s.isVisible&&s.subMeshes)if(this.customIsReadyFunction){if(!this.customIsReadyFunction(s,this.refreshRate,i)){h=!1;continue}}else if(!s.isReady(!0)){h=!1;continue}}this.onAfterRenderObservable.notifyObservers(t),(this.is2DArray||this.isCube)&&(r.incrementRenderId(),r.resetCachedMaterial())}}else if(this.is2DArray&&!this.isMulti)for(let i=0;i<this.getRenderLayers();i++)this._renderToTarget(0,e,t,i,a),r.incrementRenderId(),r.resetCachedMaterial();else if(this.isCube&&!this.isMulti)for(let i=0;i<6;i++)this._renderToTarget(i,e,t,void 0,a),r.incrementRenderId(),r.resetCachedMaterial();else this._renderToTarget(0,e,t,void 0,a);return this.onAfterUnbindObservable.notifyObservers(this),n.currentRenderPassId=o,l&&(r.activeCamera=l,(r.getEngine().scenes.length>1||this.activeCamera&&this.activeCamera!==r.activeCamera)&&r.setTransformMatrix(r.activeCamera.getViewMatrix(),r.activeCamera.getProjectionMatrix(!0)),n.setViewport(r.activeCamera.viewport)),r.resetCachedMaterial(),h}_bestReflectionRenderTargetDimension(e,t){const i=e*t,s=Ns.NearestPOT(i+16384/(128+i));return Math.min(Ns.FloorPOT(e),s)}_prepareRenderingManager(e,t,i,s){const r=this.getScene();if(!r)return;this._renderingManager.reset();const n=r.getRenderId();for(let o=0;o<t;o++){const t=e[o];if(t&&!t.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(t,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!t.isReady(0===this.refreshRate)){this.resetRefreshCounter();continue}if(!t._internalAbstractMeshDataInfo._currentLODIsUpToDate&&r.activeCamera&&(t._internalAbstractMeshDataInfo._currentLOD=r.customLODSelector?r.customLODSelector(t,this.activeCamera||r.activeCamera):t.getLOD(this.activeCamera||r.activeCamera),t._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0),!t._internalAbstractMeshDataInfo._currentLOD)continue;let e,o=t._internalAbstractMeshDataInfo._currentLOD;if(o._preActivateForIntermediateRendering(n),e=!(!s||!i||t.layerMask&i.layerMask),t.isEnabled()&&t.isVisible&&t.subMeshes&&!e&&(o!==t&&o._activate(n,!0),t._activate(n,!0)&&t.subMeshes.length)){t.isAnInstance?t._internalAbstractMeshDataInfo._actAsRegularMesh&&(o=t):o._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,o._internalAbstractMeshDataInfo._isActiveIntermediate=!0;for(let e=0;e<o.subMeshes.length;e++){const t=o.subMeshes[e];this._renderingManager.dispatch(t,o)}}}}for(let e=0;e<r.particleSystems.length;e++){const t=r.particleSystems[e],i=t.emitter;t.isStarted()&&i&&(!i.position||i.isEnabled())&&this._renderingManager.dispatchParticles(t)}}_bindFrameBuffer(e=0,t=0){const i=this.getScene();if(!i)return;const s=i.getEngine();this._renderTarget&&s.bindFramebuffer(this._renderTarget,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,0,t)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindFramebuffer(this._renderTarget,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(t)}))}_prepareFrame(e,t,i,s){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):s&&e.postProcessManager._prepareFrame(this._texture)||this._bindFrameBuffer(t,i)}_renderToTarget(e,t,i,s=0,r=null){var n,o,a,l,h,c;const u=this.getScene();if(!u)return;const d=u.getEngine();if(null===(n=d._debugPushGroup)||void 0===n||n.call(d,`render to face #${e} layer #${s}`,1),this._prepareFrame(u,e,s,t),this.is2DArray?(d.currentRenderPassId=this._renderPassIds[s],this.onBeforeRenderObservable.notifyObservers(s)):(d.currentRenderPassId=this._renderPassIds[e],this.onBeforeRenderObservable.notifyObservers(e)),d.snapshotRendering&&1===d.snapshotRenderingMode)this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(d):this.skipInitialClear||d.clear(this.clearColor||u.clearColor,!0,!0,!0);else{let n=null;const c=this.renderList?this.renderList:u.getActiveMeshes().data,p=this.renderList?this.renderList.length:u.getActiveMeshes().length;this.getCustomRenderList&&(n=this.getCustomRenderList(this.is2DArray?s:e,c,p)),n?this._prepareRenderingManager(n,n.length,r,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(c,p,r,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),n=c);for(const t of u._beforeRenderTargetClearStage)t.action(this,e,s);this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(d):this.skipInitialClear||d.clear(this.clearColor||u.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||u.updateTransformMatrix(!0);for(const t of u._beforeRenderTargetDrawStage)t.action(this,e,s);this._renderingManager.render(this.customRenderFunction,n,this.renderParticles,this.renderSprites);for(const t of u._afterRenderTargetDrawStage)t.action(this,e,s);const _=null!==(a=null===(o=this._texture)||void 0===o?void 0:o.generateMipMaps)&&void 0!==a&&a;this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,null!==(l=this._renderTarget)&&void 0!==l?l:void 0,e,this._postProcesses,this.ignoreCameraViewport):t&&u.postProcessManager._finalizeFrame(!1,null!==(h=this._renderTarget)&&void 0!==h?h:void 0,e);for(const t of u._afterRenderTargetPostProcessStage)t.action(this,e,s);this._texture&&(this._texture.generateMipMaps=_),this._doNotChangeAspectRatio||u.updateTransformMatrix(!0),i&&Ln.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),d)}this._unbindFrameBuffer(d,e),this._texture&&this.isCube&&5===e&&d.generateMipMapsForCubemap(this._texture),null===(c=d._debugPopGroup)||void 0===c||c.call(d,1)}setRenderingOrder(e,t=null,i=null,s=null){this._renderingManager.setRenderingOrder(e,t,i,s)}setRenderingAutoClearDepthStencil(e,t){this._renderingManager.setRenderingAutoClearDepthStencil(e,t),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const e=this.getSize(),t=new Bn(this.name,e,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,this.renderList&&(t.renderList=this.renderList.slice(0)),t}serialize(){if(!this.name)return null;const e=super.serialize();if(e.renderTargetSize=this.getRenderSize(),e.renderList=[],this.renderList)for(let t=0;t<this.renderList.length;t++)e.renderList.push(this.renderList[t].id);return e}disposeFramebufferObjects(){var e;null===(e=this._renderTarget)||void 0===e||e.dispose(!0)}releaseInternalTexture(){var e;null===(e=this._renderTarget)||void 0===e||e.releaseTextures(),this._texture=null}dispose(){var e;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterRenderObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this.onBeforeRenderObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._releaseRenderPassId(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.renderList=null;const t=this.getScene();if(!t)return;let i=t.customRenderTargets.indexOf(this);i>=0&&t.customRenderTargets.splice(i,1);for(const e of t.cameras)i=e.customRenderTargets.indexOf(this),i>=0&&e.customRenderTargets.splice(i,1);null===(e=this._renderTarget)||void 0===e||e.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this.refreshRate===Bn.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=Bn.REFRESHRATE_RENDER_ONCE),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}getViewCount(){return 1}}Bn.REFRESHRATE_RENDER_ONCE=0,Bn.REFRESHRATE_RENDER_ONEVERYFRAME=1,Bn.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,Ar._CreateRenderTargetTexture=(e,t,i,s,r)=>new Bn(e,t,i,s);class Un{constructor(e){this.name=fi.NAME_PROCEDURALTEXTURE,this.scene=e,this.scene.proceduralTextures=[]}register(){this.scene._beforeClearStage.registerStep(fi.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this._beforeClear)}rebuild(){}dispose(){}_beforeClear(){if(this.scene.proceduralTexturesEnabled){Ht.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(let e=0;e<this.scene.proceduralTextures.length;e++){const t=this.scene.proceduralTextures[e];t._shouldRender()&&t.render()}Ht.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0)}}}nt.ShadersStore.proceduralVertexShader="attribute vec2 position;varying vec2 vPosition;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvPosition=position;vUV=position*madd+madd;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";class Vn extends Ar{constructor(e,t,i,s,r=null,n=!0,o=!1,l=0){super(null,s,!n),this.isEnabled=!0,this.autoClear=!0,this.onGeneratedObservable=new a,this.onBeforeGenerationObservable=new a,this.nodeMaterialSource=null,this._textures={},this._currentRefreshId=-1,this._frameId=-1,this._refreshRate=1,this._vertexBuffers={},this._uniforms=new Array,this._samplers=new Array,this._floats={},this._ints={},this._floatsArrays={},this._colors3={},this._colors4={},this._vectors2={},this._vectors3={},this._matrices={},this._fallbackTextureUsed=!1,this._cachedDefines=null,this._contentUpdateId=-1,this._rtWrapper=null;let h=(s=this.getScene()||x.LastCreatedScene)._getComponent(fi.NAME_PROCEDURALTEXTURE);h||(h=new Un(s),s._addComponent(h)),s.proceduralTextures.push(this),this._fullEngine=s.getEngine(),this.name=e,this.isRenderTarget=!0,this._size=t,this._textureType=l,this._generateMipMaps=n,this._drawWrapper=new Tt(this._fullEngine),this.setFragment(i),this._fallbackTexture=r;const c=this._createRtWrapper(o,t,n,l);this._texture=c.texture;const u=[];u.push(1,1),u.push(-1,1),u.push(-1,-1),u.push(1,-1),this._vertexBuffers[hi.PositionKind]=new hi(this._fullEngine,u,hi.PositionKind,!1,!1,2),this._createIndexBuffer()}_createRtWrapper(e,t,i,s){return e?(this._rtWrapper=this._fullEngine.createRenderTargetCubeTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:s}),this.setFloat("face",0)):this._rtWrapper=this._fullEngine.createRenderTargetTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:s}),this._rtWrapper}getEffect(){return this._drawWrapper.effect}_setEffect(e){this._drawWrapper.effect=e}getContent(){return this._contentData&&this._frameId===this._contentUpdateId||(this._contentData?this._contentData.then((e=>{this._contentData=this.readPixels(0,0,e),this._contentUpdateId=this._frameId})):(this._contentData=this.readPixels(0,0),this._contentUpdateId=this._frameId)),this._contentData}_createIndexBuffer(){const e=this._fullEngine,t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){const e=this._vertexBuffers[hi.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===Bn.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=Bn.REFRESHRATE_RENDER_ONCE)}reset(){var e;null===(e=this._drawWrapper.effect)||void 0===e||e.dispose(),this._drawWrapper.effect=null,this._cachedDefines=null}_getDefines(){return""}executeWhenReady(e){if(this.isReady())return void e(this);const t=this.getEffect();t&&t.executeWhenCompiled((()=>{e(this)}))}isReady(){const e=this._fullEngine;if(this.nodeMaterialSource)return this._drawWrapper.effect.isReady();if(!this._fragment)return!1;if(this._fallbackTextureUsed)return!0;if(!this._texture)return!1;const t=this._getDefines();if(this._drawWrapper.effect&&t===this._cachedDefines&&this._drawWrapper.effect.isReady())return!0;const i={vertex:"procedural",fragmentElement:this._fragment.fragmentElement,fragmentSource:this._fragment.fragmentSource,fragment:"string"==typeof this._fragment?this._fragment:void 0};return this._cachedDefines!==t&&(this._cachedDefines=t,this._drawWrapper.effect=e.createEffect(i,[hi.PositionKind],this._uniforms,this._samplers,t,void 0,void 0,(()=>{var e;null===(e=this._rtWrapper)||void 0===e||e.dispose(),this._rtWrapper=this._texture=null,this._fallbackTexture&&(this._texture=this._fallbackTexture._texture,this._texture&&this._texture.incrementReferences()),this._fallbackTextureUsed=!0}))),this._drawWrapper.effect.isReady()}resetRefreshCounter(){this._currentRefreshId=-1}setFragment(e){this._fragment=e}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}_shouldRender(){return this.isEnabled&&this.isReady()&&this._texture?!this._fallbackTextureUsed&&(-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,this._frameId++,!0):(this._currentRefreshId++,!1)):(this._texture&&(this._texture.isReady=!1),!1)}getRenderSize(){return this._size}resize(e,t){if(this._fallbackTextureUsed||!this._rtWrapper||!this._texture)return;const i=this._texture.isCube;this._rtWrapper.dispose();const s=this._createRtWrapper(i,e,t,this._textureType);this._texture=s.texture,this._size=e,this._generateMipMaps=t}_checkUniform(e){-1===this._uniforms.indexOf(e)&&this._uniforms.push(e)}setTexture(e,t){return-1===this._samplers.indexOf(e)&&this._samplers.push(e),this._textures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}render(e){var t,i;const s=this.getScene();if(!s)return;const r=this._fullEngine;if(r.enableEffect(this._drawWrapper),this.onBeforeGenerationObservable.notifyObservers(this),r.setState(!1),!this.nodeMaterialSource){for(const e in this._textures)this._drawWrapper.effect.setTexture(e,this._textures[e]);for(const e in this._ints)this._drawWrapper.effect.setInt(e,this._ints[e]);for(const e in this._floats)this._drawWrapper.effect.setFloat(e,this._floats[e]);for(const e in this._floatsArrays)this._drawWrapper.effect.setArray(e,this._floatsArrays[e]);for(const e in this._colors3)this._drawWrapper.effect.setColor3(e,this._colors3[e]);for(const e in this._colors4){const t=this._colors4[e];this._drawWrapper.effect.setFloat4(e,t.r,t.g,t.b,t.a)}for(const e in this._vectors2)this._drawWrapper.effect.setVector2(e,this._vectors2[e]);for(const e in this._vectors3)this._drawWrapper.effect.setVector3(e,this._vectors3[e]);for(const e in this._matrices)this._drawWrapper.effect.setMatrix(e,this._matrices[e])}if(!this._texture||!this._rtWrapper)return;null===(t=r._debugPushGroup)||void 0===t||t.call(r,`procedural texture generation for ${this.name}`,1);const n=r.currentViewport;if(this.isCube)for(let e=0;e<6;e++)r.bindFramebuffer(this._rtWrapper,e,void 0,void 0,!0),r.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._drawWrapper.effect.setFloat("face",e),this.autoClear&&r.clear(s.clearColor,!0,!1,!1),r.drawElementsType(sr.TriangleFillMode,0,6);else r.bindFramebuffer(this._rtWrapper,0,void 0,void 0,!0),r.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this.autoClear&&r.clear(s.clearColor,!0,!1,!1),r.drawElementsType(sr.TriangleFillMode,0,6);r.unBindFramebuffer(this._rtWrapper,this.isCube),n&&r.setViewport(n),this.isCube&&r.generateMipMapsForCubemap(this._texture),null===(i=r._debugPopGroup)||void 0===i||i.call(r,1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this)}clone(){const e=this.getSize(),t=new Vn(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t}dispose(){const e=this.getScene();if(!e)return;const t=e.proceduralTextures.indexOf(this);t>=0&&e.proceduralTextures.splice(t,1);const i=this._vertexBuffers[hi.PositionKind];i&&(i.dispose(),this._vertexBuffers[hi.PositionKind]=null),this._indexBuffer&&this._fullEngine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),super.dispose()}}var kn;me([ie()],Vn.prototype,"isEnabled",void 0),me([ie()],Vn.prototype,"autoClear",void 0),me([ie()],Vn.prototype,"_generateMipMaps",void 0),me([ie()],Vn.prototype,"_size",void 0),me([ie()],Vn.prototype,"refreshRate",null),m("BABYLON.ProceduralTexture",Vn),function(e){e[e.Cos=0]="Cos",e[e.Sin=1]="Sin",e[e.Abs=2]="Abs",e[e.Exp=3]="Exp",e[e.Exp2=4]="Exp2",e[e.Round=5]="Round",e[e.Floor=6]="Floor",e[e.Ceiling=7]="Ceiling",e[e.Sqrt=8]="Sqrt",e[e.Log=9]="Log",e[e.Tan=10]="Tan",e[e.ArcTan=11]="ArcTan",e[e.ArcCos=12]="ArcCos",e[e.ArcSin=13]="ArcSin",e[e.Fract=14]="Fract",e[e.Sign=15]="Sign",e[e.Radians=16]="Radians",e[e.Degrees=17]="Degrees"}(kn||(kn={}));class Gn extends $r{constructor(e){super(e,qs.Neutral),this.operation=kn.Cos,this.registerInput("input",$s.AutoDetect),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"TrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];let i="";switch(this.operation){case kn.Cos:i="cos";break;case kn.Sin:i="sin";break;case kn.Abs:i="abs";break;case kn.Exp:i="exp";break;case kn.Exp2:i="exp2";break;case kn.Round:i="round";break;case kn.Floor:i="floor";break;case kn.Ceiling:i="ceil";break;case kn.Sqrt:i="sqrt";break;case kn.Log:i="log";break;case kn.Tan:i="tan";break;case kn.ArcTan:i="atan";break;case kn.ArcCos:i="acos";break;case kn.ArcSin:i="asin";break;case kn.Fract:i="fract";break;case kn.Sign:i="sign";break;case kn.Radians:i="radians";break;case kn.Degrees:i="degrees"}return e.compilationString+=this._declareOutput(t,e)+` = ${i}(${this.input.associatedVariableName});\n`,this}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.TrigonometryBlockOperations.${kn[this.operation]};\n`}}m("BABYLON.TrigonometryBlock",Gn);const zn={effect:null,subMesh:null};class Wn extends $t{constructor(){super(),this.NORMAL=!1,this.TANGENT=!1,this.VERTEXCOLOR_NME=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.PREPASS=!1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.EXPOSURE=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.BUMPDIRECTUV=0,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.rebuild()}setValue(e,t,i=!1){void 0===this[e]&&this._keys.push(e),i&&this[e]!==t&&this.markAsUnprocessed(),this[e]=t}}class Hn extends Xr{static _BlockIsTextureBlock(e){return"TextureBlock"===e.getClassName()||"ReflectionTextureBaseBlock"===e.getClassName()||"RefractionBlock"===e.getClassName()||"CurrentScreenBlock"===e.getClassName()||"ParticleTextureBlock"===e.getClassName()||"ImageSourceBlock"===e.getClassName()||"TriPlanarBlock"===e.getClassName()||"BiPlanarBlock"===e.getClassName()||"PrePassTextureBlock"===e.getClassName()}_getGlobalNodeMaterialEditor(){return"undefined"!=typeof NODEEDITOR?NODEEDITOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.NodeEditor?BABYLON:void 0}get options(){return this._options}set options(e){this._options=e}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get mode(){return this._mode}set mode(e){this._mode=e}get buildId(){return this._buildId}set buildId(e){this._buildId=e}constructor(e,t,i={}){super(e,t||x.LastCreatedScene),this._buildId=Hn._BuildIdGenerator++,this._buildWasSuccessful=!1,this._cachedWorldViewMatrix=new y,this._cachedWorldViewProjectionMatrix=new y,this._optimizers=new Array,this._animationFrame=-1,this.BJSNODEMATERIALEDITOR=this._getGlobalNodeMaterialEditor(),this.editorData=null,this.ignoreAlpha=!1,this.maxSimultaneousLights=4,this.onBuildObservable=new a,this._vertexOutputNodes=new Array,this._fragmentOutputNodes=new Array,this.attachedBlocks=[],this._mode=mn.Material,this.forceAlphaBlending=!1,this._options=Object.assign({emitComments:!1},i),this._attachImageProcessingConfiguration(null)}getClassName(){return"NodeMaterial"}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._markAllSubMeshesAsImageProcessingDirty()}))))}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e){if(t)return Ht.Warn("More than one block was found with the name `"+e+"`"),t;t=i}return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getInputBlockByPredicate(e){for(const t of this.attachedBlocks)if(t.isInput&&e(t))return t;return null}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}registerOptimizer(e){if(!(this._optimizers.indexOf(e)>-1))return this._optimizers.push(e),this}unregisterOptimizer(e){const t=this._optimizers.indexOf(e);if(-1!==t)return this._optimizers.splice(t,1),this}addOutputNode(e){if(null===e.target)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return e.target&qs.Vertex&&this._addVertexOutputNode(e),e.target&qs.Fragment&&this._addFragmentOutputNode(e),this}removeOutputNode(e){return null===e.target||(e.target&qs.Vertex&&this._removeVertexOutputNode(e),e.target&qs.Fragment&&this._removeFragmentOutputNode(e)),this}_addVertexOutputNode(e){if(-1===this._vertexOutputNodes.indexOf(e))return e.target=qs.Vertex,this._vertexOutputNodes.push(e),this}_removeVertexOutputNode(e){const t=this._vertexOutputNodes.indexOf(e);if(-1!==t)return this._vertexOutputNodes.splice(t,1),this}_addFragmentOutputNode(e){if(-1===this._fragmentOutputNodes.indexOf(e))return e.target=qs.Fragment,this._fragmentOutputNodes.push(e),this}_removeFragmentOutputNode(e){const t=this._fragmentOutputNodes.indexOf(e);if(-1!==t)return this._fragmentOutputNodes.splice(t,1),this}needAlphaBlending(){return!this.ignoreAlpha&&(this.forceAlphaBlending||this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending)}needAlphaTesting(){return this._sharedData&&this._sharedData.hints.needAlphaTesting}_processInitializeOnLink(e,t,i,s=!0){(e.target===qs.VertexAndFragment||t.target===qs.Fragment&&e.target===qs.Vertex&&e._preparationId!==this._buildId)&&i.push(e),this._initializeBlock(e,t,i,s)}_initializeBlock(e,t,i,s=!0){if(e.initialize(t),s&&e.autoConfigure(this),e._preparationId=this._buildId,-1===this.attachedBlocks.indexOf(e)){if(e.isUnique){const t=e.getClassName();for(const e of this.attachedBlocks)if(e.getClassName()===t)throw`Cannot have multiple blocks of type ${t} in the same NodeMaterial`}this.attachedBlocks.push(e)}for(const r of e.inputs){r.associatedVariableName="";const n=r.connectedPoint;if(n){const r=n.ownerBlock;r!==e&&this._processInitializeOnLink(r,t,i,s)}}if(e.isTeleportOut){const r=e;r.entryPoint&&this._processInitializeOnLink(r.entryPoint,t,i,s)}for(const t of e.outputs)t.associatedVariableName=""}_resetDualBlocks(e,t){e.target===qs.VertexAndFragment&&(e.buildId=t);for(const i of e.inputs){const s=i.connectedPoint;if(s){const i=s.ownerBlock;i!==e&&this._resetDualBlocks(i,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._resetDualBlocks(i.entryPoint,t)}}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e.isFinalMerger&&this.removeOutputNode(e)}build(e=!1,t=!0,i=!1){this._vertexCompilationState||i||(i=!0),this._buildWasSuccessful=!1;const s=this.getScene().getEngine(),r=this._mode===mn.Particle;if(0===this._vertexOutputNodes.length&&!r)throw"You must define at least one vertexOutputNode";if(0===this._fragmentOutputNodes.length)throw"You must define at least one fragmentOutputNode";this._vertexCompilationState=new Yr,this._vertexCompilationState.supportUniformBuffers=s.supportsUniformBuffers,this._vertexCompilationState.target=qs.Vertex,this._fragmentCompilationState=new Yr,this._fragmentCompilationState.supportUniformBuffers=s.supportsUniformBuffers,this._fragmentCompilationState.target=qs.Fragment,this._sharedData=new jr,this._sharedData.nodeMaterial=this,this._sharedData.fragmentOutputNodes=this._fragmentOutputNodes,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=r;const n=[],o=[];for(const e of this._vertexOutputNodes)n.push(e),this._initializeBlock(e,this._vertexCompilationState,o,i);for(const e of this._fragmentOutputNodes)o.push(e),this._initializeBlock(e,this._fragmentCompilationState,n,i);this.optimize();for(const e of n)e.build(this._vertexCompilationState,n);this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState;for(const e of o)this._resetDualBlocks(e,this._buildId-1);for(const e of o)e.build(this._fragmentCompilationState,o);this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),t&&(this._buildId=Hn._BuildIdGenerator++),this._sharedData.emitErrors(),e&&(console.log("Vertex shader:"),console.log(this._vertexCompilationState.compilationString),console.log("Fragment shader:"),console.log(this._fragmentCompilationState.compilationString)),this._buildWasSuccessful=!0,this.onBuildObservable.notifyObservers(this);const a=this.getScene().meshes;for(const e of a)if(e.subMeshes)for(const t of e.subMeshes){if(t.getMaterial()!==this)continue;if(!t.materialDefines)continue;const e=t.materialDefines;e.markAllAsDirty(),e.reset()}this.prePassTextureInputs.length&&this.getScene().enablePrePassRenderer();const l=this.getScene().prePassRenderer;l&&l.markAsDirty()}optimize(){for(const e of this._optimizers)e.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}_prepareDefinesForAttributes(e,t){const i=t.NORMAL,s=t.TANGENT,r=t.VERTEXCOLOR_NME;t.NORMAL=e.isVerticesDataPresent(hi.NormalKind),t.TANGENT=e.isVerticesDataPresent(hi.TangentKind);const n=e.useVertexColors&&e.isVerticesDataPresent(hi.ColorKind);t.VERTEXCOLOR_NME=n;let o=!1;for(let i=1;i<=6;++i){const s=t["UV"+i];t["UV"+i]=e.isVerticesDataPresent(`uv${1===i?"":i}`),o=o||t["UV"+i]!==s}const a=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;Hs.PrepareDefinesForPrePass(this.getScene(),t,!a),(i!==t.NORMAL||s!==t.TANGENT||r!==t.VERTEXCOLOR_NME||o)&&t.markAsAttributesDirty()}get isPrePassCapable(){return!0}get prePassTextureOutputs(){const e=this.getBlockByPredicate((e=>"PrePassOutputBlock"===e.getClassName())),t=[4];return e?(this.prePassTextureInputs.length||(e.viewDepth.isConnected&&t.push(5),e.viewNormal.isConnected&&t.push(6),e.worldPosition.isConnected&&t.push(1)),t):t}get prePassTextureInputs(){const e=this.getAllTextureBlocks().filter((e=>"PrePassTextureBlock"===e.getClassName())),t=[];for(const i of e)i.position.isConnected&&!t.includes(1)&&t.push(1),i.depth.isConnected&&!t.includes(5)&&t.push(5),i.normal.isConnected&&!t.includes(6)&&t.push(6);return t}setPrePassRenderer(e){const t=this.prePassTextureInputs.concat(this.prePassTextureOutputs);if(e&&t.length>1){let i=e.getEffectConfiguration("nodeMaterial");i||(i=e.addEffectConfiguration({enabled:!0,needsImageProcessing:!1,name:"nodeMaterial",texturesRequired:[]}));for(const e of t)i.texturesRequired.includes(e)||i.texturesRequired.push(e);i.enabled=!0}return t.length>1}createPostProcess(e,t=1,i=1,s,r,n=0,o=5){return this.mode!==mn.PostProcess?(console.log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,t,i,s,r,n,o)}createEffectForPostProcess(e){this._createEffectForPostProcess(e)}_createEffectForPostProcess(e,t,i=1,s=1,r,n,o=0,a=5){let l=this.name+this._buildId;const h=new Wn,c=new Vs(l+"PostProcess",this.getScene());let u=this._buildId;return this._processDefines(c,h),ot.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),e?e.updateEffect(h.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,l,l):e=new dn(this.name+"PostProcess",l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,i,t,s,r,n,h.toString(),o,l,{maxSimultaneousLights:this.maxSimultaneousLights},!1,a),e.nodeMaterialSource=this,e.onApplyObservable.add((t=>{u!==this._buildId&&(delete ot.ShadersStore[l+"VertexShader"],delete ot.ShadersStore[l+"PixelShader"],l=this.name+this._buildId,h.markAllAsDirty(),u=this._buildId),this._processDefines(c,h)&&(ot.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),Ct.SetImmediate((()=>e.updateEffect(h.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,l,l)))),this._checkInternals(t)})),e}createProceduralTexture(e,t){if(this.mode!==mn.ProceduralTexture)return console.log("Incompatible material mode"),null;let i=this.name+this._buildId;const s=new Vn(i,e,null,t),r=new Vs(i+"Procedural",this.getScene());r.reservedDataStore={hidden:!0};const n=new Wn,o=this._processDefines(r,n);ot.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString);let a=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[hi.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString(),null==o?void 0:o.fallbacks,void 0);s.nodeMaterialSource=this,s._setEffect(a);let l=this._buildId;return s.onBeforeGenerationObservable.add((()=>{l!==this._buildId&&(delete ot.ShadersStore[i+"VertexShader"],delete ot.ShadersStore[i+"PixelShader"],i=this.name+this._buildId,n.markAllAsDirty(),l=this._buildId);const e=this._processDefines(r,n);e&&(ot.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),Ct.SetImmediate((()=>{a=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[hi.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString(),null==e?void 0:e.fallbacks,void 0),s._setEffect(a)}))),this._checkInternals(a)})),s}_createEffectForParticles(e,t,i,s,r,n,o,a=""){let l=this.name+this._buildId+"_"+t;n||(n=new Wn),o||(o=this.getScene().getMeshByName(this.name+"Particle"))||((o=new Vs(this.name+"Particle",this.getScene())).reservedDataStore={hidden:!0});let h=this._buildId;const c=[];let u=a;if(!r){const a=this._processDefines(o,n);ot.RegisterShader(l,this._fragmentCompilationState._builtCompilationString),e.fillDefines(c,t),u=c.join("\n"),r=this.getScene().getEngine().createEffectForParticles(l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString()+"\n"+u,null==a?void 0:a.fallbacks,i,s,e),e.setCustomEffect(r,t)}r.onBindObservable.add((r=>{h!==this._buildId&&(delete ot.ShadersStore[l+"PixelShader"],l=this.name+this._buildId+"_"+t,n.markAllAsDirty(),h=this._buildId),c.length=0,e.fillDefines(c,t);const d=c.join("\n");d!==u&&(n.markAllAsDirty(),u=d);const p=this._processDefines(o,n);if(p)return ot.RegisterShader(l,this._fragmentCompilationState._builtCompilationString),r=this.getScene().getEngine().createEffectForParticles(l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString()+"\n"+u,null==p?void 0:p.fallbacks,i,s,e),e.setCustomEffect(r,t),void this._createEffectForParticles(e,t,i,s,r,n,o,a);this._checkInternals(r)}))}_checkInternals(e){if(this._sharedData.animatedInputs){const e=this.getScene(),t=e.getFrameId();if(this._animationFrame!==t){for(const t of this._sharedData.animatedInputs)t.animate(e);this._animationFrame=t}}for(const t of this._sharedData.bindableBlocks)t.bind(e,this);for(const t of this._sharedData.inputBlocks)t._transmit(e,this.getScene(),this)}createEffectForParticles(e,t,i){this.mode===mn.Particle?(this._createEffectForParticles(e,Rn.BLENDMODE_ONEONE,t,i),this._createEffectForParticles(e,Rn.BLENDMODE_MULTIPLY,t,i)):console.log("Incompatible material mode")}createAsShadowDepthWrapper(e){this.mode===mn.Material?e.shadowDepthWrapper=new BABYLON.ShadowDepthWrapper(this,this.getScene()):console.log("Incompatible material mode")}_processDefines(e,t,i=!1,s){let r=null;const n=this.getScene();if(Hs.PrepareDefinesForCamera(n,t)&&t.markAsMiscDirty(),this._sharedData.blocksWithDefines.forEach((s=>{s.initializeDefines(e,this,t,i)})),this._sharedData.blocksWithDefines.forEach((r=>{r.prepareDefines(e,this,t,i,s)})),t.isDirty){const i=t._areLightsDisposed;t.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString,this._sharedData.repeatableContentBlocks.forEach((i=>{i.replaceRepeatableContent(this._vertexCompilationState,this._fragmentCompilationState,e,t)}));const s=[];this._sharedData.dynamicUniformBlocks.forEach((e=>{e.updateUniformsAndSamples(this._vertexCompilationState,this,t,s)}));const n=this._vertexCompilationState.uniforms;this._fragmentCompilationState.uniforms.forEach((e=>{-1===n.indexOf(e)&&n.push(e)}));const o=this._vertexCompilationState.samplers;this._fragmentCompilationState.samplers.forEach((e=>{-1===o.indexOf(e)&&o.push(e)}));const a=new hn;this._sharedData.blocksWithFallbacks.forEach((t=>{t.provideFallbacks(e,a)})),r={lightDisposed:i,uniformBuffers:s,mergedUniforms:n,mergedSamplers:o,fallbacks:a}}return r}isReadyForSubMesh(e,t,i=!1){if(!this._buildWasSuccessful)return!1;const s=this.getScene();if(this._sharedData.animatedInputs){const e=s.getFrameId();if(this._animationFrame!==e){for(const e of this._sharedData.animatedInputs)e.animate(s);this._animationFrame=e}}if(t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new Wn);const r=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const n=s.getEngine();if(this._prepareDefinesForAttributes(e,r),this._sharedData.blockingBlocks.some((t=>!t.isReady(e,this,r,i))))return!1;const o=this._processDefines(e,r,i,t);if(o){const e=t.effect,i=r.toString();let a=n.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:o.mergedUniforms,uniformBuffersNames:o.uniformBuffers,samplers:o.mergedSamplers,defines:i,fallbacks:o.fallbacks,onCompiled:this.onCompiled,onError:this.onError,multiTarget:r.PREPASS,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:r.NUM_MORPH_INFLUENCERS}},n);if(a)if(this._onEffectCreatedObservable&&(zn.effect=a,zn.subMesh=t,this._onEffectCreatedObservable.notifyObservers(zn)),this.allowShaderHotSwapping&&e&&!a.isReady()){if(a=e,r.markAsUnprocessed(),o.lightDisposed)return r._areLightsDisposed=!0,!1}else s.resetCachedMaterial(),t.setEffect(a,r,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(r._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),0))}get compiledShaders(){return`// Vertex shader\n${this._vertexCompilationState.compilationString}\n\n// Fragment shader\n${this._fragmentCompilationState.compilationString}`}bindOnlyWorldMatrix(e){const t=this.getScene();if(!this._activeEffect)return;const i=this._sharedData.hints;i.needWorldViewMatrix&&e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),i.needWorldViewProjectionMatrix&&e.multiplyToRef(t.getTransformMatrix(),this._cachedWorldViewProjectionMatrix);for(const t of this._sharedData.inputBlocks)t._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}bindForSubMesh(e,t,i){const s=this.getScene(),r=i.effect;if(!r)return;this._activeEffect=r,this.bindOnlyWorldMatrix(e);const n=this._mustRebind(s,r,t.visibility),o=this._sharedData;if(n){for(const e of o.bindableBlocks)e.bind(r,this,t,i);for(const e of o.forcedBindableBlocks)e.bind(r,this,t,i);for(const e of o.inputBlocks)e._transmit(r,s,this)}else if(!this.isFrozen)for(const e of o.forcedBindableBlocks)e.bind(r,this,t,i);this._afterBind(t,this._activeEffect)}getActiveTextures(){const e=super.getActiveTextures();return this._sharedData&&e.push(...this._sharedData.textureBlocks.filter((e=>e.texture)).map((e=>e.texture))),e}getTextureBlocks(){return this._sharedData?this._sharedData.textureBlocks:[]}getAllTextureBlocks(){const e=[];for(const t of this.attachedBlocks)Hn._BlockIsTextureBlock(t)&&e.push(t);return e}hasTexture(e){if(super.hasTexture(e))return!0;if(!this._sharedData)return!1;for(const t of this._sharedData.textureBlocks)if(t.texture===e)return!0;return!1}dispose(e,t,i){if(t)for(const e of this.getTextureBlocks().filter((e=>e.texture)).map((e=>e.texture)))e.dispose();for(const e of this.attachedBlocks)e.dispose();this.attachedBlocks.length=0,this._sharedData=null,this._vertexCompilationState=null,this._fragmentCompilationState=null,this.onBuildObservable.clear(),this._imageProcessingObserver&&(this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingObserver=null),super.dispose(e,t,i)}_createNodeEditor(e){const t=Object.assign({nodeMaterial:this},e);this.BJSNODEMATERIALEDITOR.NodeEditor.Show(t)}edit(e){return new Promise((t=>{if(this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),void 0===this.BJSNODEMATERIALEDITOR){const i=e&&e.editorURL?e.editorURL:Hn.EditorURL;Ht.LoadBabylonScript(i,(()=>{this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),this._createNodeEditor(null==e?void 0:e.nodeEditorConfig),t()}))}else this._createNodeEditor(null==e?void 0:e.nodeEditorConfig),t()}))}clear(){this._vertexOutputNodes.length=0,this._fragmentOutputNodes.length=0,this.attachedBlocks.length=0}setToDefault(){this.clear(),this.editorData=null;const e=new rn("Position");e.setAsAttribute("position");const t=new rn("World");t.setAsSystemValue(tr.World);const i=new qr("WorldPos");e.connectTo(i),t.connectTo(i);const s=new rn("ViewProjection");s.setAsSystemValue(tr.ViewProjection);const r=new qr("WorldPos * ViewProjectionTransform");i.connectTo(r),s.connectTo(r);const n=new Qr("VertexOutput");r.connectTo(n);const o=new rn("color");o.value=new F(.8,.8,.8,1);const a=new Jr("FragmentOutput");o.connectTo(a),this.addOutputNode(n),this.addOutputNode(a),this._mode=mn.Material}setToDefaultPostProcess(){this.clear(),this.editorData=null;const e=new rn("Position");e.setAsAttribute("position2d");const t=new rn("Constant1");t.isConstant=!0,t.value=1;const i=new pn("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const s=new Qr("VertexOutput");i.connectTo(s);const r=new rn("Scale");r.visibleInInspector=!0,r.value=new E(1,1);const n=new _n("uv0");e.connectTo(n);const o=new fn("UV scale");n.connectTo(o),r.connectTo(o);const a=new nn("CurrentScreen");o.connectTo(a),a.texture=new Ar("https://assets.babylonjs.com/nme/currentScreenPostProcess.png",this.getScene());const l=new Jr("FragmentOutput");a.connectTo(l,{output:"rgba"}),this.addOutputNode(s),this.addOutputNode(l),this._mode=mn.PostProcess}setToDefaultProceduralTexture(){this.clear(),this.editorData=null;const e=new rn("Position");e.setAsAttribute("position2d");const t=new rn("Constant1");t.isConstant=!0,t.value=1;const i=new pn("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const s=new Qr("VertexOutput");i.connectTo(s);const r=new rn("Time");r.value=0,r.min=0,r.max=0,r.isBoolean=!1,r.matrixMode=0,r.animationType=ir.Time,r.isConstant=!1;const n=new rn("Color3");n.value=new N(1,1,1),n.isConstant=!1;const o=new Jr("FragmentOutput"),a=new pn("VectorMerger");a.visibleInInspector=!1;const l=new Gn("Cos");l.operation=kn.Cos,e.connectTo(a),r.output.connectTo(l.input),l.output.connectTo(a.z),a.xyzOut.connectTo(o.rgb),this.addOutputNode(s),this.addOutputNode(o),this._mode=mn.ProceduralTexture}setToDefaultParticle(){this.clear(),this.editorData=null;const e=new rn("uv");e.setAsAttribute("particle_uv");const t=new on("ParticleTexture");e.connectTo(t);const i=new rn("Color");i.setAsAttribute("particle_color");const s=new fn("Texture * Color");t.connectTo(s),i.connectTo(s);const r=new an("ParticleRampGradient");s.connectTo(r);const n=new In("ColorSplitter");i.connectTo(n);const o=new ln("ParticleBlendMultiply");r.connectTo(o),t.connectTo(o,{output:"a"}),n.connectTo(o,{output:"a"});const a=new Jr("FragmentOutput");o.connectTo(a),this.addOutputNode(a),this._mode=mn.Particle}async loadAsync(e,t=""){return Hn.ParseFromFileAsync("",e,this.getScene(),t,!0,this)}_gatherBlocks(e,t){if(-1===t.indexOf(e)){t.push(e);for(const i of e.inputs){const s=i.connectedPoint;if(s){const i=s.ownerBlock;i!==e&&this._gatherBlocks(i,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._gatherBlocks(i.entryPoint,t)}}}generateCode(){let e=[];const t=[],i=["const","var","let"];for(const e of this._vertexOutputNodes)this._gatherBlocks(e,t);const s=[];for(const e of this._fragmentOutputNodes)this._gatherBlocks(e,s);let r=`var nodeMaterial = new BABYLON.NodeMaterial("${this.name||"node material"}");\n`;r+=`nodeMaterial.mode = BABYLON.NodeMaterialModes.${mn[this.mode]};\n`;for(const s of t)s.isInput&&-1===e.indexOf(s)&&(r+=s._dumpCode(i,e));for(const t of s)t.isInput&&-1===e.indexOf(t)&&(r+=t._dumpCode(i,e));e=[],r+="\n// Connections\n";for(const t of this._vertexOutputNodes)r+=t._dumpCodeForOutputConnections(e);for(const t of this._fragmentOutputNodes)r+=t._dumpCodeForOutputConnections(e);r+="\n// Output nodes\n";for(const e of this._vertexOutputNodes)r+=`nodeMaterial.addOutputNode(${e._codeVariableName});\n`;for(const e of this._fragmentOutputNodes)r+=`nodeMaterial.addOutputNode(${e._codeVariableName});\n`;return r+="nodeMaterial.build();\n",r}serialize(e){const t=e?{}:de.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];if(e)i=e;else{t.customType="BABYLON.NodeMaterial",t.outputNodes=[];for(const e of this._vertexOutputNodes)this._gatherBlocks(e,i),t.outputNodes.push(e.uniqueId);for(const e of this._fragmentOutputNodes)this._gatherBlocks(e,i),-1===t.outputNodes.indexOf(e.uniqueId)&&t.outputNodes.push(e.uniqueId)}t.blocks=[];for(const e of i)t.blocks.push(e.serialize());if(!e)for(const e of this.attachedBlocks)-1===i.indexOf(e)&&t.blocks.push(e.serialize());return t}_restoreConnections(e,t,i){for(const s of e.outputs)for(const r of t.blocks){const n=i[r.id];if(n)for(const o of r.inputs)if(i[o.targetBlockId]!==e||o.targetConnectionName!==s.name);else{const e=n.getInputByName(o.inputName);if(!e||e.isConnected)continue;s.connectTo(e,!0),this._restoreConnections(n,t,i)}}}parseSerializedObject(e,t="",i=!1){var s;i||this.clear();const r={};for(const i of e.blocks){const e=g(i.customType);if(e){const s=new e;s._deserialize(i,this.getScene(),t),r[i.id]=s,this.attachedBlocks.push(s)}}for(const e of this.attachedBlocks)if(e.isTeleportOut){const t=e,i=t._tempEntryPointUniqueId;i&&r[i].attachToEndpoint(t)}for(let t=0;t<e.blocks.length;t++){const s=r[e.blocks[t].id];s&&(s.inputs.length&&!i||this._restoreConnections(s,e,r))}if(e.outputNodes)for(const t of e.outputNodes)this.addOutputNode(r[t]);if(e.locations||e.editorData&&e.editorData.locations){const t=e.locations||e.editorData.locations;for(const e of t)r[e.blockId]&&(e.blockId=r[e.blockId].uniqueId);i&&this.editorData&&this.editorData.locations&&t.concat(this.editorData.locations),e.locations?this.editorData={locations:t}:(this.editorData=e.editorData,this.editorData.locations=t);const s=[];for(const e in r)s[e]=r[e].uniqueId;this.editorData.map=s}this.comment=e.comment,void 0!==e.forceAlphaBlending&&(this.forceAlphaBlending=e.forceAlphaBlending),i||(this._mode=null!==(s=e.mode)&&void 0!==s?s:mn.Material)}loadFromSerialization(e,t="",i=!1){this.parseSerializedObject(e,t,i)}clone(e,t=!1){const i=this.serialize(),s=de.Clone((()=>new Hn(e,this.getScene(),this.options)),this);return s.id=e,s.name=e,s.parseSerializedObject(i),s._buildId=this._buildId,s.build(!1,!t),s}whenTexturesReadyAsync(){const e=[];return this.getActiveTextures().forEach((t=>{const i=t.getInternalTexture();i&&!i.isReady&&e.push(new Promise(((e,t)=>{i.onLoadedObservable.addOnce((()=>{e()})),i.onErrorObservable.addOnce((e=>{t(e)}))})))})),Promise.all(e)}static Parse(e,t,i=""){const s=de.Parse((()=>new Hn(e.name,t)),e,t,i);return s.parseSerializedObject(e,i),s.build(),s}static async ParseFromFileAsync(e,t,i,s="",r=!1,n){const o=null!=n?n:new Hn(e,i),a=await i._loadFileAsync(t),l=JSON.parse(a);return o.parseSerializedObject(l,s),r||o.build(),o}static ParseFromSnippetAsync(e,t=x.LastCreatedScene,i="",s,r=!1,n=!1){return"_BLANK"===e?Promise.resolve(Hn.CreateDefault("blank",t)):new Promise(((o,a)=>{const l=new Te;l.addEventListener("readystatechange",(()=>{if(4==l.readyState)if(200==l.status){const h=JSON.parse(JSON.parse(l.responseText).jsonPayload),c=JSON.parse(h.nodeMaterial);s||((s=de.Parse((()=>new Hn(e,t)),c,t,i)).uniqueId=t.getUniqueId()),s.parseSerializedObject(c),s.snippetId=e;try{r||s.build()}catch(e){a(e)}n?s.whenTexturesReadyAsync().then((()=>{o(s)})).catch((e=>{a(e)})):o(s)}else a("Unable to load the snippet "+e)})),l.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),l.send()}))}static CreateDefault(e,t){const i=new Hn(e,t);return i.setToDefault(),i.build(),i}}function Xn(e){const t=e.sideOrientation||As.DEFAULTSIDE,i=e.radius||1,s=void 0===e.flat||e.flat,r=0|(e.subdivisions||4),n=e.radiusX||i,o=e.radiusY||i,a=e.radiusZ||i,l=(1+Math.sqrt(5))/2,h=[-1,l,-0,1,l,0,-1,-l,0,1,-l,0,0,-1,-l,0,1,-l,0,-1,l,0,1,l,l,0,1,l,0,-1,-l,0,1,-l,0,-1],c=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1],u=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11],d=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4],p=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0],_=[],f=[],m=[],g=[];let v=0;const x=new Array(3),T=new Array(3);let b;for(b=0;b<3;b++)x[b]=S.Zero(),T[b]=E.Zero();for(let e=0;e<20;e++){for(b=0;b<3;b++){const t=c[3*e+b];x[b].copyFromFloats(h[3*u[t]],h[3*u[t]+1],h[3*u[t]+2]),x[b].normalize(),T[b].copyFromFloats(.134765625*d[2*t]+.05859375+-.0390625*p[e],.2333984375*d[2*t+1]+.025390625+.01953125*p[e])}const t=(e,t,i,l)=>{const h=S.Lerp(x[0],x[2],t/r),c=S.Lerp(x[1],x[2],t/r),u=r===t?x[2]:S.Lerp(h,c,e/(r-t));let d;if(u.normalize(),s){const e=S.Lerp(x[0],x[2],l/r),t=S.Lerp(x[1],x[2],l/r);d=S.Lerp(e,t,i/(r-l))}else d=new S(u.x,u.y,u.z);d.x/=n,d.y/=o,d.z/=a,d.normalize();const p=E.Lerp(T[0],T[2],t/r),b=E.Lerp(T[1],T[2],t/r),C=r===t?T[2]:E.Lerp(p,b,e/(r-t));f.push(u.x*n,u.y*o,u.z*a),m.push(d.x,d.y,d.z),g.push(C.x,Is.UseOpenGLOrientationForUV?1-C.y:C.y),_.push(v),v++};for(let e=0;e<r;e++)for(let i=0;i+e<r;i++)t(i,e,i+1/3,e+1/3),t(i+1,e,i+1/3,e+1/3),t(i,e+1,i+1/3,e+1/3),i+e+1<r&&(t(i+1,e,i+2/3,e+2/3),t(i+1,e+1,i+2/3,e+2/3),t(i,e+1,i+2/3,e+2/3))}As._ComputeSides(t,f,_,m,g,e.frontUVs,e.backUVs);const C=new As;return C.indices=_,C.positions=f,C.normals=m,C.uvs=g,C}function Yn(e,t={},i=null){const s=new ur(e,i);return t.sideOrientation=ur._GetDefaultSideOrientation(t.sideOrientation),s._originalBuilderSideOrientation=t.sideOrientation,Xn(t).applyToMesh(s,t.updatable),s}var jn,Kn,$n;Hn._BuildIdGenerator=0,Hn.EditorURL=`${Ht._DefaultCdnUrl}/v${Ns.Version}/nodeEditor/babylon.nodeEditor.js`,Hn.SnippetUrl="https://snippet.babylonjs.com",Hn.IgnoreTexturesAtLoadTime=!1,me([ie()],Hn.prototype,"ignoreAlpha",void 0),me([ie()],Hn.prototype,"maxSimultaneousLights",void 0),me([ie("mode")],Hn.prototype,"_mode",void 0),me([ie("comment")],Hn.prototype,"comment",void 0),me([ie()],Hn.prototype,"forceAlphaBlending",void 0),m("BABYLON.NodeMaterial",Hn),As.CreateIcoSphere=Xn,ur.CreateIcoSphere=(e,t,i)=>Yn(e,t,i),function(e){e.WRIST="wrist",e.THUMB="thumb",e.INDEX="index",e.MIDDLE="middle",e.RING="ring",e.LITTLE="little"}(jn||(jn={})),($n=Kn||(Kn={})).WRIST="wrist",$n.THUMB_METACARPAL="thumb-metacarpal",$n.THUMB_PHALANX_PROXIMAL="thumb-phalanx-proximal",$n.THUMB_PHALANX_DISTAL="thumb-phalanx-distal",$n.THUMB_TIP="thumb-tip",$n.INDEX_FINGER_METACARPAL="index-finger-metacarpal",$n.INDEX_FINGER_PHALANX_PROXIMAL="index-finger-phalanx-proximal",$n.INDEX_FINGER_PHALANX_INTERMEDIATE="index-finger-phalanx-intermediate",$n.INDEX_FINGER_PHALANX_DISTAL="index-finger-phalanx-distal",$n.INDEX_FINGER_TIP="index-finger-tip",$n.MIDDLE_FINGER_METACARPAL="middle-finger-metacarpal",$n.MIDDLE_FINGER_PHALANX_PROXIMAL="middle-finger-phalanx-proximal",$n.MIDDLE_FINGER_PHALANX_INTERMEDIATE="middle-finger-phalanx-intermediate",$n.MIDDLE_FINGER_PHALANX_DISTAL="middle-finger-phalanx-distal",$n.MIDDLE_FINGER_TIP="middle-finger-tip",$n.RING_FINGER_METACARPAL="ring-finger-metacarpal",$n.RING_FINGER_PHALANX_PROXIMAL="ring-finger-phalanx-proximal",$n.RING_FINGER_PHALANX_INTERMEDIATE="ring-finger-phalanx-intermediate",$n.RING_FINGER_PHALANX_DISTAL="ring-finger-phalanx-distal",$n.RING_FINGER_TIP="ring-finger-tip",$n.PINKY_FINGER_METACARPAL="pinky-finger-metacarpal",$n.PINKY_FINGER_PHALANX_PROXIMAL="pinky-finger-phalanx-proximal",$n.PINKY_FINGER_PHALANX_INTERMEDIATE="pinky-finger-phalanx-intermediate",$n.PINKY_FINGER_PHALANX_DISTAL="pinky-finger-phalanx-distal",$n.PINKY_FINGER_TIP="pinky-finger-tip";const qn=[Kn.WRIST,Kn.THUMB_METACARPAL,Kn.THUMB_PHALANX_PROXIMAL,Kn.THUMB_PHALANX_DISTAL,Kn.THUMB_TIP,Kn.INDEX_FINGER_METACARPAL,Kn.INDEX_FINGER_PHALANX_PROXIMAL,Kn.INDEX_FINGER_PHALANX_INTERMEDIATE,Kn.INDEX_FINGER_PHALANX_DISTAL,Kn.INDEX_FINGER_TIP,Kn.MIDDLE_FINGER_METACARPAL,Kn.MIDDLE_FINGER_PHALANX_PROXIMAL,Kn.MIDDLE_FINGER_PHALANX_INTERMEDIATE,Kn.MIDDLE_FINGER_PHALANX_DISTAL,Kn.MIDDLE_FINGER_TIP,Kn.RING_FINGER_METACARPAL,Kn.RING_FINGER_PHALANX_PROXIMAL,Kn.RING_FINGER_PHALANX_INTERMEDIATE,Kn.RING_FINGER_PHALANX_DISTAL,Kn.RING_FINGER_TIP,Kn.PINKY_FINGER_METACARPAL,Kn.PINKY_FINGER_PHALANX_PROXIMAL,Kn.PINKY_FINGER_PHALANX_INTERMEDIATE,Kn.PINKY_FINGER_PHALANX_DISTAL,Kn.PINKY_FINGER_TIP],Qn={[jn.WRIST]:[Kn.WRIST],[jn.THUMB]:[Kn.THUMB_METACARPAL,Kn.THUMB_PHALANX_PROXIMAL,Kn.THUMB_PHALANX_DISTAL,Kn.THUMB_TIP],[jn.INDEX]:[Kn.INDEX_FINGER_METACARPAL,Kn.INDEX_FINGER_PHALANX_PROXIMAL,Kn.INDEX_FINGER_PHALANX_INTERMEDIATE,Kn.INDEX_FINGER_PHALANX_DISTAL,Kn.INDEX_FINGER_TIP],[jn.MIDDLE]:[Kn.MIDDLE_FINGER_METACARPAL,Kn.MIDDLE_FINGER_PHALANX_PROXIMAL,Kn.MIDDLE_FINGER_PHALANX_INTERMEDIATE,Kn.MIDDLE_FINGER_PHALANX_DISTAL,Kn.MIDDLE_FINGER_TIP],[jn.RING]:[Kn.RING_FINGER_METACARPAL,Kn.RING_FINGER_PHALANX_PROXIMAL,Kn.RING_FINGER_PHALANX_INTERMEDIATE,Kn.RING_FINGER_PHALANX_DISTAL,Kn.RING_FINGER_TIP],[jn.LITTLE]:[Kn.PINKY_FINGER_METACARPAL,Kn.PINKY_FINGER_PHALANX_PROXIMAL,Kn.PINKY_FINGER_PHALANX_INTERMEDIATE,Kn.PINKY_FINGER_PHALANX_DISTAL,Kn.PINKY_FINGER_TIP]};class Zn{get handMesh(){return this._handMesh}getHandPartMeshes(e){return Qn[e].map((e=>this._jointMeshes[qn.indexOf(e)]))}getJointMesh(e){return this._jointMeshes[qn.indexOf(e)]}constructor(e,t,i,s,r=!1,n=!1,o=1){this.xrController=e,this._jointMeshes=t,this._handMesh=i,this.rigMapping=s,this._leftHandedMeshes=r,this._jointsInvisible=n,this._jointScaleFactor=o,this._jointTransforms=new Array(qn.length),this._jointTransformMatrices=new Float32Array(16*qn.length),this._tempJointMatrix=new y,this._jointRadii=new Float32Array(qn.length),this._scene=t[0].getScene();for(let e=0;e<this._jointTransforms.length;e++)(this._jointTransforms[e]=new ws(qn[e],this._scene)).rotationQuaternion=new C,t[e].rotationQuaternion=new C;i&&this.setHandMesh(i,s),this.xrController.motionController&&(this.xrController.motionController.rootMesh?this.xrController.motionController.rootMesh.setEnabled(!1):this.xrController.motionController.onModelLoadedObservable.add((e=>{e.rootMesh&&e.rootMesh.setEnabled(!1)}))),this.xrController.onMotionControllerInitObservable.add((e=>{e.onModelLoadedObservable.add((e=>{e.rootMesh&&e.rootMesh.setEnabled(!1)})),e.rootMesh&&e.rootMesh.setEnabled(!1)}))}setHandMesh(e,t){if(this._handMesh=e,e.alwaysSelectAsActiveMesh=!0,e.getChildMeshes().forEach((e=>e.alwaysSelectAsActiveMesh=!0)),this._handMesh.skeleton){const e=this._handMesh.skeleton;qn.forEach(((i,s)=>{const r=e.getBoneIndexByName(t?t[i]:i);-1!==r&&e.bones[r].linkTransformNode(this._jointTransforms[s])}))}}updateFromXRFrame(e,t){const i=this.xrController.inputSource.hand;if(!i)return;const s=i,r=qn.map((e=>s[e]||i.get(e)));let n=!1;if(e.fillPoses&&e.fillJointRadii)n=e.fillPoses(r,t,this._jointTransformMatrices)&&e.fillJointRadii(r,this._jointRadii);else if(e.getJointPose){n=!0;for(let i=0;i<r.length;i++){const s=e.getJointPose(r[i],t);if(!s){n=!1;break}this._jointTransformMatrices.set(s.transform.matrix,16*i),this._jointRadii[i]=s.radius||.008}}n&&(qn.forEach(((e,t)=>{const i=this._jointTransforms[t];y.FromArrayToRef(this._jointTransformMatrices,16*t,this._tempJointMatrix),this._tempJointMatrix.decompose(void 0,i.rotationQuaternion,i.position);const s=this._jointRadii[t]*this._jointScaleFactor,r=this._jointMeshes[t];r.isVisible=!this._handMesh&&!this._jointsInvisible,r.position.copyFrom(i.position),r.rotationQuaternion.copyFrom(i.rotationQuaternion),r.scaling.setAll(s),this._scene.useRightHandedSystem||(r.position.z*=-1,r.rotationQuaternion.z*=-1,r.rotationQuaternion.w*=-1,this._leftHandedMeshes&&this._handMesh&&(i.position.z*=-1,i.rotationQuaternion.z*=-1,i.rotationQuaternion.w*=-1))})),this._handMesh&&(this._handMesh.isVisible=!0))}dispose(){this._handMesh&&(this._handMesh.isVisible=!1)}}class Jn extends Gr{static _GenerateTrackedJointMeshes(e){const t={};return["left","right"].map((i=>{var s,r,n,o,a;const l=[],h=(null===(s=e.jointMeshes)||void 0===s?void 0:s.sourceMesh)||Yn("jointParent",Jn._ICOSPHERE_PARAMS);h.isVisible=!!(null===(r=e.jointMeshes)||void 0===r?void 0:r.keepOriginalVisible);for(let t=0;t<qn.length;++t){let s=h.createInstance(`${i}-handJoint-${t}`);if(null===(n=e.jointMeshes)||void 0===n?void 0:n.onHandJointMeshGenerated){const r=e.jointMeshes.onHandJointMeshGenerated(s,t,i);r&&r!==s&&(s.dispose(),s=r)}if(s.isPickable=!1,null===(o=e.jointMeshes)||void 0===o?void 0:o.enablePhysics){const t=(null===(a=e.jointMeshes)||void 0===a?void 0:a.physicsProps)||{};s.scaling.setAll(.02);const i=void 0!==t.impostorType?t.impostorType:Wr.SphereImpostor;s.physicsImpostor=new Wr(s,i,Object.assign({mass:0},t))}s.rotationQuaternion=new C,s.isVisible=!1,l.push(s)}t[i]=l})),{left:t.left,right:t.right}}static _GenerateDefaultHandMeshesAsync(e,t){return new Promise((async i=>{var s,r,n,o,a;const l={};(null===(r=null===(s=Jn._RightHandGLB)||void 0===s?void 0:s.meshes[1])||void 0===r?void 0:r.isDisposed())&&(Jn._RightHandGLB=null),(null===(o=null===(n=Jn._LeftHandGLB)||void 0===n?void 0:n.meshes[1])||void 0===o?void 0:o.isDisposed())&&(Jn._LeftHandGLB=null);const h=!(!Jn._RightHandGLB||!Jn._LeftHandGLB),c=await Promise.all([Jn._RightHandGLB||Hr.ImportMeshAsync("",Jn.DEFAULT_HAND_MODEL_BASE_URL,Jn.DEFAULT_HAND_MODEL_RIGHT_FILENAME,e),Jn._LeftHandGLB||Hr.ImportMeshAsync("",Jn.DEFAULT_HAND_MODEL_BASE_URL,Jn.DEFAULT_HAND_MODEL_LEFT_FILENAME,e)]);Jn._RightHandGLB=c[0],Jn._LeftHandGLB=c[1];const u=new Hn("handShader",e,{emitComments:!1});await u.loadAsync(Jn.DEFAULT_HAND_MODEL_SHADER_URL),u.needDepthPrePass=!0,u.transparencyMode=sr.MATERIAL_ALPHABLEND,u.alphaMode=2,u.build(!1);const d=Object.assign({base:N.FromInts(116,63,203),fresnel:N.FromInts(149,102,229),fingerColor:N.FromInts(177,130,255),tipFresnel:N.FromInts(220,200,255)},null===(a=null==t?void 0:t.handMeshes)||void 0===a?void 0:a.customColors),p={base:u.getBlockByName("baseColor"),fresnel:u.getBlockByName("fresnelColor"),fingerColor:u.getBlockByName("fingerColor"),tipFresnel:u.getBlockByName("tipFresnelColor")};p.base.value=d.base,p.fresnel.value=d.fresnel,p.fingerColor.value=d.fingerColor,p.tipFresnel.value=d.tipFresnel,["left","right"].forEach((t=>{const i="left"==t?Jn._LeftHandGLB:Jn._RightHandGLB;if(!i)throw new Error("Could not load hand model");const s=i.meshes[1];s._internalAbstractMeshDataInfo._computeBonesUsingShaders=!0,s.material=u.clone(`${t}HandShaderClone`,!0),s.isVisible=!1,l[t]=s,h||e.useRightHandedSystem||i.meshes[1].rotate(ji.Y,Math.PI)})),u.dispose(),i({left:l.left,right:l.right})}))}static _GenerateDefaultHandMeshRigMapping(e){const t="right"==e?"R":"L";return{[Kn.WRIST]:`wrist_${t}`,[Kn.THUMB_METACARPAL]:`thumb_metacarpal_${t}`,[Kn.THUMB_PHALANX_PROXIMAL]:`thumb_proxPhalanx_${t}`,[Kn.THUMB_PHALANX_DISTAL]:`thumb_distPhalanx_${t}`,[Kn.THUMB_TIP]:`thumb_tip_${t}`,[Kn.INDEX_FINGER_METACARPAL]:`index_metacarpal_${t}`,[Kn.INDEX_FINGER_PHALANX_PROXIMAL]:`index_proxPhalanx_${t}`,[Kn.INDEX_FINGER_PHALANX_INTERMEDIATE]:`index_intPhalanx_${t}`,[Kn.INDEX_FINGER_PHALANX_DISTAL]:`index_distPhalanx_${t}`,[Kn.INDEX_FINGER_TIP]:`index_tip_${t}`,[Kn.MIDDLE_FINGER_METACARPAL]:`middle_metacarpal_${t}`,[Kn.MIDDLE_FINGER_PHALANX_PROXIMAL]:`middle_proxPhalanx_${t}`,[Kn.MIDDLE_FINGER_PHALANX_INTERMEDIATE]:`middle_intPhalanx_${t}`,[Kn.MIDDLE_FINGER_PHALANX_DISTAL]:`middle_distPhalanx_${t}`,[Kn.MIDDLE_FINGER_TIP]:`middle_tip_${t}`,[Kn.RING_FINGER_METACARPAL]:`ring_metacarpal_${t}`,[Kn.RING_FINGER_PHALANX_PROXIMAL]:`ring_proxPhalanx_${t}`,[Kn.RING_FINGER_PHALANX_INTERMEDIATE]:`ring_intPhalanx_${t}`,[Kn.RING_FINGER_PHALANX_DISTAL]:`ring_distPhalanx_${t}`,[Kn.RING_FINGER_TIP]:`ring_tip_${t}`,[Kn.PINKY_FINGER_METACARPAL]:`little_metacarpal_${t}`,[Kn.PINKY_FINGER_PHALANX_PROXIMAL]:`little_proxPhalanx_${t}`,[Kn.PINKY_FINGER_PHALANX_INTERMEDIATE]:`little_intPhalanx_${t}`,[Kn.PINKY_FINGER_PHALANX_DISTAL]:`little_distPhalanx_${t}`,[Kn.PINKY_FINGER_TIP]:`little_tip_${t}`}}isCompatible(){return"undefined"!=typeof XRHand}getHandByControllerId(e){return this._attachedHands[e]}getHandByHandedness(e){return"none"==e?null:this._trackingHands[e]}constructor(e,t){super(e),this.options=t,this._attachedHands={},this._trackingHands={left:null,right:null},this._handResources={jointMeshes:null,handMeshes:null,rigMappings:null},this.onHandAddedObservable=new a,this.onHandRemovedObservable=new a,this._attachHand=e=>{var t,i,s;if(!e.inputSource.hand||"none"==e.inputSource.handedness||!this._handResources.jointMeshes)return;const r=e.inputSource.handedness,n=new Zn(e,this._handResources.jointMeshes[r],this._handResources.handMeshes&&this._handResources.handMeshes[r],this._handResources.rigMappings&&this._handResources.rigMappings[r],null===(t=this.options.handMeshes)||void 0===t?void 0:t.meshesUseLeftHandedCoordinates,null===(i=this.options.jointMeshes)||void 0===i?void 0:i.invisible,null===(s=this.options.jointMeshes)||void 0===s?void 0:s.scaleFactor);this._attachedHands[e.uniqueId]=n,this._trackingHands[r]=n,this.onHandAddedObservable.notifyObservers(n)},this._detachHand=e=>{this._detachHandById(e.uniqueId)},this.xrNativeFeatureName="hand-tracking";const i=t.jointMeshes;if(i&&(void 0!==i.disableDefaultHandMesh&&(t.handMeshes=t.handMeshes||{},t.handMeshes.disableDefaultMeshes=i.disableDefaultHandMesh),void 0!==i.handMeshes&&(t.handMeshes=t.handMeshes||{},t.handMeshes.customMeshes=i.handMeshes),void 0!==i.leftHandedSystemMeshes&&(t.handMeshes=t.handMeshes||{},t.handMeshes.meshesUseLeftHandedCoordinates=i.leftHandedSystemMeshes),void 0!==i.rigMapping)){t.handMeshes=t.handMeshes||{};const e={},s={};[[i.rigMapping.left,e],[i.rigMapping.right,s]].forEach((e=>{const t=e[0],i=e[1];t.forEach(((e,t)=>{i[qn[t]]=e}))})),t.handMeshes.customRigMappings={left:e,right:s}}}attach(){var e,t,i,s;return!!super.attach()&&(this._handResources={jointMeshes:Jn._GenerateTrackedJointMeshes(this.options),handMeshes:(null===(e=this.options.handMeshes)||void 0===e?void 0:e.customMeshes)||null,rigMappings:(null===(t=this.options.handMeshes)||void 0===t?void 0:t.customRigMappings)||null},(null===(i=this.options.handMeshes)||void 0===i?void 0:i.customMeshes)||(null===(s=this.options.handMeshes)||void 0===s?void 0:s.disableDefaultMeshes)||Jn._GenerateDefaultHandMeshesAsync(x.LastCreatedScene,this.options).then((e=>{var t,i;this._handResources.handMeshes=e,this._handResources.rigMappings={left:Jn._GenerateDefaultHandMeshRigMapping("left"),right:Jn._GenerateDefaultHandMeshRigMapping("right")},null===(t=this._trackingHands.left)||void 0===t||t.setHandMesh(this._handResources.handMeshes.left,this._handResources.rigMappings.left),null===(i=this._trackingHands.right)||void 0===i||i.setHandMesh(this._handResources.handMeshes.right,this._handResources.rigMappings.right)})),this.options.xrInput.controllers.forEach(this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerAddedObservable,this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerRemovedObservable,this._detachHand),!0)}_onXRFrame(e){var t,i;null===(t=this._trackingHands.left)||void 0===t||t.updateFromXRFrame(e,this._xrSessionManager.referenceSpace),null===(i=this._trackingHands.right)||void 0===i||i.updateFromXRFrame(e,this._xrSessionManager.referenceSpace)}_detachHandById(e){var t;const i=this.getHandByControllerId(e);if(i){const s="left"==i.xrController.inputSource.handedness?"left":"right";(null===(t=this._trackingHands[s])||void 0===t?void 0:t.xrController.uniqueId)===e&&(this._trackingHands[s]=null),this.onHandRemovedObservable.notifyObservers(i),i.dispose(),delete this._attachedHands[e]}}detach(){return!!super.detach()&&(Object.keys(this._attachedHands).forEach((e=>this._detachHandById(e))),!0)}dispose(){var e;super.dispose(),this.onHandAddedObservable.clear(),this.onHandRemovedObservable.clear(),this._handResources.handMeshes&&!(null===(e=this.options.handMeshes)||void 0===e?void 0:e.customMeshes)&&(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),Jn._RightHandGLB=null,Jn._LeftHandGLB=null),this._handResources.jointMeshes&&(this._handResources.jointMeshes.left.forEach((e=>e.dispose())),this._handResources.jointMeshes.right.forEach((e=>e.dispose())))}}var eo,to,io;Jn.Name=Vr.HAND_TRACKING,Jn.Version=1,Jn.DEFAULT_HAND_MODEL_BASE_URL="https://assets.babylonjs.com/meshes/HandMeshes/",Jn.DEFAULT_HAND_MODEL_RIGHT_FILENAME="r_hand_rhs.glb",Jn.DEFAULT_HAND_MODEL_LEFT_FILENAME="l_hand_rhs.glb",Jn.DEFAULT_HAND_MODEL_SHADER_URL="https://assets.babylonjs.com/meshes/HandMeshes/handsShader.json",Jn._ICOSPHERE_PARAMS={radius:.5,flat:!1,subdivisions:2},Jn._RightHandGLB=null,Jn._LeftHandGLB=null,kr.AddWebXRFeature(Jn.Name,((e,t)=>()=>new Jn(e,t)),Jn.Version,!1),function(e){e[e.ABOVE_FINGER_TIPS=0]="ABOVE_FINGER_TIPS",e[e.RADIAL_SIDE=1]="RADIAL_SIDE",e[e.ULNAR_SIDE=2]="ULNAR_SIDE",e[e.BELOW_WRIST=3]="BELOW_WRIST"}(eo||(eo={})),function(e){e[e.LOOK_AT_CAMERA=0]="LOOK_AT_CAMERA",e[e.HAND_ROTATION=1]="HAND_ROTATION"}(to||(to={})),function(e){e[e.ALWAYS_VISIBLE=0]="ALWAYS_VISIBLE",e[e.PALM_UP=1]="PALM_UP",e[e.GAZE_FOCUS=2]="GAZE_FOCUS",e[e.PALM_AND_GAZE=3]="PALM_AND_GAZE"}(io||(io={}));class so{get maxAngle(){return this._maxAngle}set maxAngle(e){this._setMaxAngle(e)}constructor(e,t,i){this.targetPosition=S.Zero(),this.poleTargetPosition=S.Zero(),this.poleTargetLocalOffset=S.Zero(),this.poleAngle=0,this.slerpAmount=1,this._bone1Quat=C.Identity(),this._bone1Mat=y.Identity(),this._bone2Ang=Math.PI,this._maxAngle=Math.PI,this._rightHandedSystem=!1,this._bendAxis=S.Right(),this._slerping=!1,this._adjustRoll=0,this._notEnoughInformation=!1,this._bone2=t;const s=t.getParent();if(!s)return this._notEnoughInformation=!0,void k.Error("BoneIKController: bone must have a parent for IK to work.");if(this._bone1=s,0===this._bone2.children.length&&!this._bone2.length)return this._notEnoughInformation=!0,void k.Error("BoneIKController: bone must not be a leaf or it should have a length for IK to work.");this.mesh=e,t.getSkeleton().computeAbsoluteMatrices();const r=t.getPosition();if(t.getAbsoluteMatrix().determinant()>0&&(this._rightHandedSystem=!0,this._bendAxis.x=0,this._bendAxis.y=0,this._bendAxis.z=-1,r.x>r.y&&r.x>r.z&&(this._adjustRoll=.5*Math.PI,this._bendAxis.z=1)),this._bone1.length&&this._bone2.length){const e=this._bone1.getScale(),t=this._bone2.getScale();this._bone1Length=this._bone1.length*e.y*this.mesh.scaling.y,this._bone2Length=this._bone2.length*t.y*this.mesh.scaling.y}else if(this._bone2.children[0]){e.computeWorldMatrix(!0);const t=this._bone2.children[0].getAbsolutePosition(e),i=this._bone2.getAbsolutePosition(e),s=this._bone1.getAbsolutePosition(e);this._bone2Length=S.Distance(t,i),this._bone1Length=S.Distance(i,s)}else{e.computeWorldMatrix(!0);const t=this._bone2.getScale();this._bone2Length=this._bone2.length*t.y*this.mesh.scaling.y;const i=this._bone2.getAbsolutePosition(e),s=this._bone1.getAbsolutePosition(e);this._bone1Length=S.Distance(i,s)}this._bone1.getRotationMatrixToRef(Gi.WORLD,e,this._bone1Mat),this.maxAngle=Math.PI,i&&(i.targetMesh&&(this.targetMesh=i.targetMesh,this.targetMesh.computeWorldMatrix(!0)),i.poleTargetMesh?(this.poleTargetMesh=i.poleTargetMesh,this.poleTargetMesh.computeWorldMatrix(!0)):i.poleTargetBone?this.poleTargetBone=i.poleTargetBone:this._bone1.getParent()&&(this.poleTargetBone=this._bone1.getParent()),i.poleTargetLocalOffset&&this.poleTargetLocalOffset.copyFrom(i.poleTargetLocalOffset),i.poleAngle&&(this.poleAngle=i.poleAngle),i.bendAxis&&this._bendAxis.copyFrom(i.bendAxis),i.maxAngle&&(this.maxAngle=i.maxAngle),i.slerpAmount&&(this.slerpAmount=i.slerpAmount))}_setMaxAngle(e){e<0&&(e=0),(e>Math.PI||null==e)&&(e=Math.PI),this._maxAngle=e;const t=this._bone1Length,i=this._bone2Length;this._maxReach=Math.sqrt(t*t+i*i-2*t*i*Math.cos(e))}update(){if(this._notEnoughInformation)return;const e=this.targetPosition,t=this.poleTargetPosition,i=so._TmpMats[0],s=so._TmpMats[1];this.targetMesh&&e.copyFrom(this.targetMesh.getAbsolutePosition()),this.poleTargetBone?this.poleTargetBone.getAbsolutePositionFromLocalToRef(this.poleTargetLocalOffset,this.mesh,t):this.poleTargetMesh&&S.TransformCoordinatesToRef(this.poleTargetLocalOffset,this.poleTargetMesh.getWorldMatrix(),t);const r=so._TmpVecs[0],n=so._TmpVecs[1],o=so._TmpVecs[2],a=so._TmpVecs[3],l=so._TmpVecs[4],h=so._TmpQuat;this._bone1.getAbsolutePositionToRef(this.mesh,r),t.subtractToRef(r,l),0==l.x&&0==l.y&&0==l.z?l.y=1:l.normalize(),e.subtractToRef(r,a),a.normalize(),S.CrossToRef(a,l,n),n.normalize(),S.CrossToRef(a,n,o),o.normalize(),y.FromXYZAxesToRef(o,a,n,i);const c=this._bone1Length,u=this._bone2Length;let d=S.Distance(r,e);this._maxReach>0&&(d=Math.min(this._maxReach,d));let p=(u*u+d*d-c*c)/(2*u*d),_=(d*d+c*c-u*u)/(2*d*c);p>1&&(p=1),_>1&&(_=1),p<-1&&(p=-1),_<-1&&(_=-1);const f=Math.acos(p),m=Math.acos(_);let g=-f-m;if(this._rightHandedSystem)y.RotationYawPitchRollToRef(0,0,this._adjustRoll,s),s.multiplyToRef(i,i),y.RotationAxisToRef(this._bendAxis,m,s),s.multiplyToRef(i,i);else{const e=so._TmpVecs[5];e.copyFrom(this._bendAxis),e.x*=-1,y.RotationAxisToRef(e,-m,s),s.multiplyToRef(i,i)}this.poleAngle&&(y.RotationAxisToRef(a,this.poleAngle,s),i.multiplyToRef(s,i)),this._bone1&&(this.slerpAmount<1?(this._slerping||C.FromRotationMatrixToRef(this._bone1Mat,this._bone1Quat),C.FromRotationMatrixToRef(i,h),C.SlerpToRef(this._bone1Quat,h,this.slerpAmount,this._bone1Quat),g=this._bone2Ang*(1-this.slerpAmount)+g*this.slerpAmount,this._bone1.setRotationQuaternion(this._bone1Quat,Gi.WORLD,this.mesh),this._slerping=!0):(this._bone1.setRotationMatrix(i,Gi.WORLD,this.mesh),this._bone1Mat.copyFrom(i),this._slerping=!1),this._updateLinkedTransformRotation(this._bone1)),this._bone2.setAxisAngle(this._bendAxis,g,Gi.LOCAL),this._updateLinkedTransformRotation(this._bone2),this._bone2Ang=g}_updateLinkedTransformRotation(e){e._linkedTransformNode&&(e._linkedTransformNode.rotationQuaternion||(e._linkedTransformNode.rotationQuaternion=new C),e.getRotationQuaternionToRef(Gi.LOCAL,null,e._linkedTransformNode.rotationQuaternion))}}so._TmpVecs=[S.Zero(),S.Zero(),S.Zero(),S.Zero(),S.Zero(),S.Zero()],so._TmpQuat=C.Identity(),so._TmpMats=[y.Identity(),y.Identity()];class ro{get minYaw(){return this._minYaw}set minYaw(e){this._minYaw=e,this._minYawSin=Math.sin(e),this._minYawCos=Math.cos(e),null!=this._maxYaw&&(this._midYawConstraint=.5*this._getAngleDiff(this._minYaw,this._maxYaw)+this._minYaw,this._yawRange=this._maxYaw-this._minYaw)}get maxYaw(){return this._maxYaw}set maxYaw(e){this._maxYaw=e,this._maxYawSin=Math.sin(e),this._maxYawCos=Math.cos(e),null!=this._minYaw&&(this._midYawConstraint=.5*this._getAngleDiff(this._minYaw,this._maxYaw)+this._minYaw,this._yawRange=this._maxYaw-this._minYaw)}get minPitch(){return this._minPitch}set minPitch(e){this._minPitch=e,this._minPitchTan=Math.tan(e)}get maxPitch(){return this._maxPitch}set maxPitch(e){this._maxPitch=e,this._maxPitchTan=Math.tan(e)}constructor(e,t,i,s){if(this.upAxis=S.Up(),this.upAxisSpace=Gi.LOCAL,this.adjustYaw=0,this.adjustPitch=0,this.adjustRoll=0,this.slerpAmount=1,this._boneQuat=C.Identity(),this._slerping=!1,this._firstFrameSkipped=!1,this._fowardAxis=S.Forward(),this.useAbsoluteValueForYaw=!1,this.mesh=e,this.bone=t,this.target=i,s){if(s.adjustYaw&&(this.adjustYaw=s.adjustYaw),s.adjustPitch&&(this.adjustPitch=s.adjustPitch),s.adjustRoll&&(this.adjustRoll=s.adjustRoll),null!=s.maxYaw?this.maxYaw=s.maxYaw:this.maxYaw=Math.PI,null!=s.minYaw?this.minYaw=s.minYaw:this.minYaw=-Math.PI,null!=s.maxPitch?this.maxPitch=s.maxPitch:this.maxPitch=Math.PI,null!=s.minPitch?this.minPitch=s.minPitch:this.minPitch=-Math.PI,null!=s.slerpAmount&&(this.slerpAmount=s.slerpAmount),null!=s.upAxis&&(this.upAxis=s.upAxis),null!=s.upAxisSpace&&(this.upAxisSpace=s.upAxisSpace),null!=s.yawAxis||null!=s.pitchAxis){let e=ji.Y,t=ji.X;null!=s.yawAxis&&(e=s.yawAxis.clone(),e.normalize()),null!=s.pitchAxis&&(t=s.pitchAxis.clone(),t.normalize());const i=S.Cross(t,e);this._transformYawPitch=y.Identity(),y.FromXYZAxesToRef(t,e,i,this._transformYawPitch),this._transformYawPitchInv=this._transformYawPitch.clone(),this._transformYawPitch.invert()}void 0!==s.useAbsoluteValueForYaw&&(this.useAbsoluteValueForYaw=s.useAbsoluteValueForYaw)}t.getParent()||this.upAxisSpace!=Gi.BONE||(this.upAxisSpace=Gi.LOCAL)}update(){if(this.slerpAmount<1&&!this._firstFrameSkipped)return void(this._firstFrameSkipped=!0);const e=this.bone,t=ro._TmpVecs[0];e.getAbsolutePositionToRef(this.mesh,t);let i=this.target;const s=ro._TmpMats[0],r=ro._TmpMats[1],n=this.mesh,o=e.getParent(),a=ro._TmpVecs[1];a.copyFrom(this.upAxis),this.upAxisSpace==Gi.BONE&&o?(this._transformYawPitch&&S.TransformCoordinatesToRef(a,this._transformYawPitchInv,a),o.getDirectionToRef(a,this.mesh,a)):this.upAxisSpace==Gi.LOCAL&&(n.getDirectionToRef(a,a),1==n.scaling.x&&1==n.scaling.y&&1==n.scaling.z||a.normalize());let l=!1,h=!1;if(this._maxYaw==Math.PI&&this._minYaw==-Math.PI||(l=!0),this._maxPitch==Math.PI&&this._minPitch==-Math.PI||(h=!0),l||h){const e=ro._TmpMats[2],s=ro._TmpMats[3];if(this.upAxisSpace==Gi.BONE&&1==a.y&&o)o.getRotationMatrixToRef(Gi.WORLD,this.mesh,e);else if(this.upAxisSpace!=Gi.LOCAL||1!=a.y||o){let t=ro._TmpVecs[2];t.copyFrom(this._fowardAxis),this._transformYawPitch&&S.TransformCoordinatesToRef(t,this._transformYawPitchInv,t),o?o.getDirectionToRef(t,this.mesh,t):n.getDirectionToRef(t,t);const i=S.Cross(a,t);i.normalize(),t=S.Cross(i,a),y.FromXYZAxesToRef(i,a,t,e)}else e.copyFrom(n.getWorldMatrix());e.invertToRef(s);let r=null;if(h){const n=ro._TmpVecs[3];i.subtractToRef(t,n),S.TransformCoordinatesToRef(n,s,n),r=Math.sqrt(n.x*n.x+n.z*n.z);const o=Math.atan2(n.y,r);let a=o;o>this._maxPitch?(n.y=this._maxPitchTan*r,a=this._maxPitch):o<this._minPitch&&(n.y=this._minPitchTan*r,a=this._minPitch),o!=a&&(S.TransformCoordinatesToRef(n,e,n),n.addInPlace(t),i=n)}if(l){const n=ro._TmpVecs[4];i.subtractToRef(t,n),S.TransformCoordinatesToRef(n,s,n);const o=Math.atan2(n.x,n.z),a=this.useAbsoluteValueForYaw?Math.abs(o):o;let l=o;if((a>this._maxYaw||a<this._minYaw)&&(null==r&&(r=Math.sqrt(n.x*n.x+n.z*n.z)),this._yawRange>Math.PI?this._isAngleBetween(o,this._maxYaw,this._midYawConstraint)?(n.z=this._maxYawCos*r,n.x=this._maxYawSin*r,l=this._maxYaw):this._isAngleBetween(o,this._midYawConstraint,this._minYaw)&&(n.z=this._minYawCos*r,n.x=this._minYawSin*r,l=this._minYaw):a>this._maxYaw?(n.z=this._maxYawCos*r,n.x=this._maxYawSin*r,o<0&&this.useAbsoluteValueForYaw&&(n.x*=-1),l=this._maxYaw):a<this._minYaw&&(n.z=this._minYawCos*r,n.x=this._minYawSin*r,o<0&&this.useAbsoluteValueForYaw&&(n.x*=-1),l=this._minYaw)),this._slerping&&this._yawRange>Math.PI){const e=ro._TmpVecs[8];e.copyFrom(ji.Z),this._transformYawPitch&&S.TransformCoordinatesToRef(e,this._transformYawPitchInv,e);const t=ro._TmpMats[4];this._boneQuat.toRotationMatrix(t),this.mesh.getWorldMatrix().multiplyToRef(t,t),S.TransformCoordinatesToRef(e,t,e),S.TransformCoordinatesToRef(e,s,e);const i=Math.atan2(e.x,e.z);if(this._getAngleBetween(i,o)>this._getAngleBetween(i,this._midYawConstraint)){null==r&&(r=Math.sqrt(n.x*n.x+n.z*n.z));const e=this._getAngleBetween(i,this._maxYaw);this._getAngleBetween(i,this._minYaw)<e?(l=i+.75*Math.PI,n.z=Math.cos(l)*r,n.x=Math.sin(l)*r):(l=i-.75*Math.PI,n.z=Math.cos(l)*r,n.x=Math.sin(l)*r)}}o!=l&&(S.TransformCoordinatesToRef(n,e,n),n.addInPlace(t),i=n)}}const c=ro._TmpVecs[5],u=ro._TmpVecs[6],d=ro._TmpVecs[7],p=ro._TmpQuat;i.subtractToRef(t,c),c.normalize(),S.CrossToRef(a,c,u),u.normalize(),S.CrossToRef(c,u,d),d.normalize(),y.FromXYZAxesToRef(u,d,c,s),0===u.x&&0===u.y&&0===u.z||0===d.x&&0===d.y&&0===d.z||0===c.x&&0===c.y&&0===c.z||((this.adjustYaw||this.adjustPitch||this.adjustRoll)&&(y.RotationYawPitchRollToRef(this.adjustYaw,this.adjustPitch,this.adjustRoll,r),r.multiplyToRef(s,s)),this.slerpAmount<1?(this._slerping||this.bone.getRotationQuaternionToRef(Gi.WORLD,this.mesh,this._boneQuat),this._transformYawPitch&&this._transformYawPitch.multiplyToRef(s,s),C.FromRotationMatrixToRef(s,p),C.SlerpToRef(this._boneQuat,p,this.slerpAmount,this._boneQuat),this.bone.setRotationQuaternion(this._boneQuat,Gi.WORLD,this.mesh),this._slerping=!0):(this._transformYawPitch&&this._transformYawPitch.multiplyToRef(s,s),this.bone.setRotationMatrix(s,Gi.WORLD,this.mesh),this._slerping=!1),this._updateLinkedTransformRotation())}_getAngleDiff(e,t){let i=t-e;return i%=2*Math.PI,i>Math.PI?i-=2*Math.PI:i<-Math.PI&&(i+=2*Math.PI),i}_getAngleBetween(e,t){let i=0;return i=(e=(e%=2*Math.PI)<0?e+2*Math.PI:e)<(t=(t%=2*Math.PI)<0?t+2*Math.PI:t)?t-e:e-t,i>Math.PI&&(i=2*Math.PI-i),i}_isAngleBetween(e,t,i){if(e=(e%=2*Math.PI)<0?e+2*Math.PI:e,(t=(t%=2*Math.PI)<0?t+2*Math.PI:t)<(i=(i%=2*Math.PI)<0?i+2*Math.PI:i)){if(e>t&&e<i)return!0}else if(e>i&&e<t)return!0;return!1}_updateLinkedTransformRotation(){const e=this.bone;e._linkedTransformNode&&(e._linkedTransformNode.rotationQuaternion||(e._linkedTransformNode.rotationQuaternion=new C),e.getRotationQuaternionToRef(Gi.LOCAL,null,e._linkedTransformNode.rotationQuaternion))}}ro._TmpVecs=d.BuildArray(10,S.Zero),ro._TmpQuat=C.Identity(),ro._TmpMats=d.BuildArray(5,y.Identity);class no{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(e,t,i){this.name=e,this.id=t,this.bones=[],this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=y.Identity(),this._currentRenderId=-1,this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new a,this.bones=[],this._scene=i||x.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;const s=this._scene.getEngine().getCaps();this._canUseTextureForBones=s.textureFloat&&s.maxVertexTextureImageUnits>0}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter((e=>!e.getParent()))}getTransformMatrices(e){return this.needInitialSkinMatrix?(e._bonesTransformMatrices||this.prepare(),e._bonesTransformMatrices):(this._transformMatrices&&!this._isDirty||this.prepare(),this._transformMatrices)}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let t=`Name: ${this.name}, nBones: ${this.bones.length}`;if(t+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,e){t+=", Ranges: {";let e=!0;for(const i in this._ranges)e&&(t+=", ",e=!1),t+=i;t+="}"}return t}getBoneIndexByName(e){for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].name===e)return t;return-1}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=new fe(e,t,i);for(let s=0,r=this.bones.length;s<r;s++)this.bones[s].animations[0]&&this.bones[s].animations[0].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,s=this.bones.length;i<s;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}copyAnimationRange(e,t,i=!1){if(this._ranges[t]||!e.getAnimationRange(t))return!1;let s=!0;const r=this._getHighestAnimationFrame()+1,n={},o=e.bones;let a,l;for(l=0,a=o.length;l<a;l++)n[o[l].name]=o[l];this.bones.length!==o.length&&(k.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${o.length}`),s=!1);const h=i&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(l=0,a=this.bones.length;l<a;l++){const e=this.bones[l].name,o=n[e];o?s=s&&this.bones[l].copyAnimationRange(o,t,r,i,h):(k.Warn("copyAnimationRange: not same rig, missing source bone "+e),s=!1)}const c=e.getAnimationRange(t);return c&&(this._ranges[t]=new fe(t,c.from+r,c.to+r)),s}returnToRest(){for(const e of this.bones)-1!==e._index&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].animations[0]){const i=this.bones[t].animations[0].getHighestFrame();e<i&&(e=i)}return e}beginAnimation(e,t,i,s){const r=this.getAnimationRange(e);return r?this._scene.beginAnimation(this,r.from,r.to,t,i,s):null}static MakeAnimationAdditive(e,t=0,i){const s=e.getAnimationRange(i);if(!s)return null;const r=e._scene.getAllAnimatablesByTarget(e);let n=null;for(let e=0;e<r.length;e++){const t=r[e];if(t.fromFrame===(null==s?void 0:s.from)&&t.toFrame===(null==s?void 0:s.to)){n=t;break}}const o=e.getAnimatables();for(let e=0;e<o.length;e++){const s=o[e].animations;if(s)for(let e=0;e<s.length;e++)Ie.MakeAnimationAdditive(s[e],t,i)}return n&&(n.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){const t=this._meshesWithPoseMatrix.indexOf(e);t>-1&&this._meshesWithPoseMatrix.splice(t,1)}_computeTransformMatrices(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let i=0;i<this.bones.length;i++){const s=this.bones[i];s._childUpdateId++;const r=s.getParent();if(r?s.getLocalMatrix().multiplyToRef(r.getFinalMatrix(),s.getFinalMatrix()):t?s.getLocalMatrix().multiplyToRef(t,s.getFinalMatrix()):s.getFinalMatrix().copyFrom(s.getLocalMatrix()),-1!==s._index){const t=null===s._index?i:s._index;s.getAbsoluteInverseBindMatrix().multiplyToArray(s.getFinalMatrix(),e,16*t)}}this._identity.copyToArray(e,16*this.bones.length)}prepare(e=!1){if(!e){const e=this.getScene().getRenderId();if(this._currentRenderId===e)return;this._currentRenderId=e}if(this._numBonesWithLinkedTransformNode>0)for(const e of this.bones)if(e._linkedTransformNode){const t=e._linkedTransformNode;e.position=t.position,t.rotationQuaternion?e.rotationQuaternion=t.rotationQuaternion:e.rotation=t.rotation,e.scaling=t.scaling}if(this.needInitialSkinMatrix)for(const e of this._meshesWithPoseMatrix){const t=e.getPoseMatrix();let i=this._isDirty;if(e._bonesTransformMatrices&&e._bonesTransformMatrices.length===16*(this.bones.length+1)||(e._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),i=!0),i){if(this._synchronizedWithMesh!==e){this._synchronizedWithMesh=e;for(const e of this.bones)e.getParent()||(e.getBindMatrix().multiplyToRef(t,R.Matrix[1]),e._updateAbsoluteBindMatrices(R.Matrix[1]));if(this.isUsingTextureForMatrices){const t=4*(this.bones.length+1);e._transformMatrixTexture&&e._transformMatrixTexture.getSize().width===t||(e._transformMatrixTexture&&e._transformMatrixTexture.dispose(),e._transformMatrixTexture=Mr.CreateRGBATexture(e._bonesTransformMatrices,4*(this.bones.length+1),1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(e._bonesTransformMatrices,t),this.isUsingTextureForMatrices&&e._transformMatrixTexture&&e._transformMatrixTexture.update(e._bonesTransformMatrices)}}else{if(!this._isDirty)return;this._transformMatrices&&this._transformMatrices.length===16*(this.bones.length+1)||(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=Mr.CreateRGBATexture(this._transformMatrices,4*(this.bones.length+1),1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(e,t){const i=new no(e,t||e,this._scene);i.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let e=0;e<this.bones.length;e++){const t=this.bones[e];let s=null;const r=t.getParent();if(r){const e=this.bones.indexOf(r);s=i.bones[e]}const n=new Ki(t.name,i,s,t.getBindMatrix().clone(),t.getRestMatrix().clone());n._index=t._index,t._linkedTransformNode&&n.linkTransformNode(t._linkedTransformNode),H.DeepCopy(t.animations,n.animations)}if(this._ranges){i._ranges={};for(const e in this._ranges){const t=this._ranges[e];t&&(i._ranges[e]=t.clone())}}return this._isDirty=!0,i.prepare(!0),i}enableBlending(e=.01){this.bones.forEach((t=>{t.animations.forEach((t=>{t.enableBlending=!0,t.blendingSpeed=e}))}))}dispose(){if(this._meshesWithPoseMatrix.length=0,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){const e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){var e;const t={};t.name=this.name,t.id=this.id,this.dimensionsAtRest&&(t.dimensionsAtRest=this.dimensionsAtRest.asArray()),t.bones=[],t.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let i=0;i<this.bones.length;i++){const s=this.bones[i],r=s.getParent(),n={parentBoneIndex:r?this.bones.indexOf(r):-1,index:s.getIndex(),name:s.name,id:s.id,matrix:s.getBindMatrix().toArray(),rest:s.getRestMatrix().toArray(),linkedTransformNodeId:null===(e=s.getTransformNode())||void 0===e?void 0:e.id};t.bones.push(n),s.length&&(n.length=s.length),s.metadata&&(n.metadata=s.metadata),s.animations&&s.animations.length>0&&(n.animation=s.animations[0].serialize()),t.ranges=[];for(const e in this._ranges){const i=this._ranges[e];if(!i)continue;const s={};s.name=e,s.from=i.from,s.to=i.to,t.ranges.push(s)}}return t}static Parse(e,t){const i=new no(e.name,e.id,t);let s;for(e.dimensionsAtRest&&(i.dimensionsAtRest=S.FromArray(e.dimensionsAtRest)),i.needInitialSkinMatrix=e.needInitialSkinMatrix,s=0;s<e.bones.length;s++){const t=e.bones[s],r=e.bones[s].index;let n=null;t.parentBoneIndex>-1&&(n=i.bones[t.parentBoneIndex]);const o=t.rest?y.FromArray(t.rest):null,a=new Ki(t.name,i,n,y.FromArray(t.matrix),o,null,r);void 0!==t.id&&null!==t.id&&(a.id=t.id),t.length&&(a.length=t.length),t.metadata&&(a.metadata=t.metadata),t.animation&&a.animations.push(Ie.Parse(t.animation)),void 0!==t.linkedTransformNodeId&&null!==t.linkedTransformNodeId&&(i._hasWaitingData=!0,a._waitingTransformNodeId=t.linkedTransformNodeId)}if(e.ranges)for(s=0;s<e.ranges.length;s++){const t=e.ranges[s];i.createAnimationRange(t.name,t.from,t.to)}return i}computeAbsoluteMatrices(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteMatrices(),this._absoluteTransformIsDirty=!1)}computeAbsoluteTransforms(e=!1){this.computeAbsoluteMatrices(e)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){const e=[],t=new Array(this.bones.length);for(let i=0;i<this.bones.length;i++)this._sortBones(i,e,t);this.bones=e}_sortBones(e,t,i){if(i[e])return;i[e]=!0;const s=this.bones[e];if(!s)return;void 0===s._index&&(s._index=e);const r=s.getParent();r&&this._sortBones(this.bones.indexOf(r),t,i),t.push(s)}setCurrentPoseAsRest(){this.bones.forEach((e=>{e.setCurrentPoseAsRest()}))}}class oo{constructor(e,t,i=3,s){this._engine=e,this._label=s,this._engine._storageBuffers.push(this),this._create(t,i)}_create(e,t){this._bufferSize=e,this._creationFlags=t,this._buffer=this._engine.createStorageBuffer(e,t,this._label)}_rebuild(){this._create(this._bufferSize,this._creationFlags)}getBuffer(){return this._buffer}update(e,t,i){this._buffer&&this._engine.updateStorageBuffer(this._buffer,e,t,i)}read(e,t,i){return this._engine.readFromStorageBuffer(this._buffer,e,t,i)}dispose(){const e=this._engine._storageBuffers,t=e.indexOf(this);-1!==t&&(e[t]=e[e.length-1],e.pop()),this._engine._releaseBuffer(this._buffer),this._buffer=null}}const ao=(()=>{const e=new Uint8Array(4);return!!((new Uint32Array(e.buffer)[0]=1)&e[0])})();Object.defineProperty(hi.prototype,"effectiveByteStride",{get:function(){return this._alignedBuffer&&this._alignedBuffer.byteStride||this.byteStride},enumerable:!0,configurable:!0}),Object.defineProperty(hi.prototype,"effectiveByteOffset",{get:function(){return this._alignedBuffer?0:this.byteOffset},enumerable:!0,configurable:!0}),Object.defineProperty(hi.prototype,"effectiveBuffer",{get:function(){return this._alignedBuffer&&this._alignedBuffer.getBuffer()||this._buffer.getBuffer()},enumerable:!0,configurable:!0}),hi.prototype._rebuild=function(){var e,t;null===(e=this._buffer)||void 0===e||e._rebuild(),null===(t=this._alignedBuffer)||void 0===t||t._rebuild()},hi.prototype.dispose=function(){var e;this._ownsBuffer&&this._buffer.dispose(),null===(e=this._alignedBuffer)||void 0===e||e.dispose(),this._alignedBuffer=void 0,this._isDisposed=!0},hi.prototype._alignBuffer=function(){var e,t;const i=this._buffer.getData();if(!this.engine._features.forceVertexBufferStrideMultiple4Bytes||this.byteStride%4==0||!i)return;const s=hi.GetTypeByteLength(this.type),r=this.byteStride+3&-4,n=r/s,o=this.totalVertices,a=o*r/s;let l,h;if(Array.isArray(i)){const e=new Float32Array(i);l=new DataView(e.buffer,e.byteOffset,e.byteLength)}else l=i instanceof ArrayBuffer?new DataView(i,0,i.byteLength):new DataView(i.buffer,i.byteOffset,i.byteLength);h=this.type===hi.BYTE?new Int8Array(a):this.type===hi.UNSIGNED_BYTE?new Uint8Array(a):this.type===hi.SHORT?new Int16Array(a):this.type===hi.UNSIGNED_SHORT?new Uint16Array(a):this.type===hi.INT?new Int32Array(a):this.type===hi.UNSIGNED_INT?new Uint32Array(a):new Float32Array(a);const c=this.getSize();let u=this.byteOffset;for(let e=0;e<o;++e){for(let t=0;t<c;++t)switch(this.type){case hi.BYTE:h[e*n+t]=l.getInt8(u+t);break;case hi.UNSIGNED_BYTE:h[e*n+t]=l.getUint8(u+t);break;case hi.SHORT:h[e*n+t]=l.getInt16(u+2*t,ao);break;case hi.UNSIGNED_SHORT:h[e*n+t]=l.getUint16(u+2*t,ao);break;case hi.INT:h[e*n+t]=l.getInt32(u+4*t,ao);break;case hi.UNSIGNED_INT:h[e*n+t]=l.getUint32(u+4*t,ao);break;case hi.FLOAT:h[e*n+t]=l.getFloat32(u+4*t,ao)}u+=this.byteStride}null===(e=this._alignedBuffer)||void 0===e||e.dispose(),this._alignedBuffer=new li(this.engine,h,!1,r,!1,this.getIsInstanced(),!0,this.instanceDivisor,(null!==(t=this._label)&&void 0!==t?t:"VertexBuffer")+"_aligned")};class lo{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new a,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}attachControl(e){e=Ht.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==gi.POINTERWHEEL)return;const i=t.event,s=i.deltaMode===Ci.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*s*i.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*s*i.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*s*i.deltaZ/this._normalize,i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,gi.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}me([ie()],lo.prototype,"wheelPrecisionX",void 0),me([ie()],lo.prototype,"wheelPrecisionY",void 0),me([ie()],lo.prototype,"wheelPrecisionZ",void 0);class ho{constructor(){this._currentActiveButton=-1,this.buttons=[0,1,2]}attachControl(e){e=Ht.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();let s=0,r=null;this._pointA=null,this._pointB=null,this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._pointerInput=n=>{var o,a;const l=n.event,h="touch"===l.pointerType;if(n.type!==gi.POINTERMOVE&&-1===this.buttons.indexOf(l.button))return;const c=l.target;if(this._altKey=l.altKey,this._ctrlKey=l.ctrlKey,this._metaKey=l.metaKey,this._shiftKey=l.shiftKey,this._buttonsPressed=l.buttons,t.isPointerLock){const e=l.movementX,t=l.movementY;this.onTouch(null,e,t),this._pointA=null,this._pointB=null}else{if(n.type!==gi.POINTERDOWN&&h&&(null===(o=this._pointA)||void 0===o?void 0:o.pointerId)!==l.pointerId&&(null===(a=this._pointB)||void 0===a?void 0:a.pointerId)!==l.pointerId)return;if(n.type!==gi.POINTERDOWN||-1!==this._currentActiveButton&&!h)if(n.type===gi.POINTERDOUBLETAP)this.onDoubleTap(l.pointerType);else if(n.type!==gi.POINTERUP||this._currentActiveButton!==l.button&&!h){if(n.type===gi.POINTERMOVE)if(e||l.preventDefault(),this._pointA&&null===this._pointB){const e=l.clientX-this._pointA.x,t=l.clientY-this._pointA.y;this.onTouch(this._pointA,e,t),this._pointA.x=l.clientX,this._pointA.y=l.clientY}else if(this._pointA&&this._pointB){const e=this._pointA.pointerId===l.pointerId?this._pointA:this._pointB;e.x=l.clientX,e.y=l.clientY;const t=this._pointA.x-this._pointB.x,i=this._pointA.y-this._pointB.y,o=t*t+i*i,a={x:(this._pointA.x+this._pointB.x)/2,y:(this._pointA.y+this._pointB.y)/2,pointerId:l.pointerId,type:n.type};this.onMultiTouch(this._pointA,this._pointB,s,o,r,a),r=a,s=o}}else{try{null==c||c.releasePointerCapture(l.pointerId)}catch(e){}h||(this._pointB=null),t._badOS?this._pointA=this._pointB=null:this._pointB&&this._pointA&&this._pointA.pointerId==l.pointerId?(this._pointA=this._pointB,this._pointB=null):this._pointA&&this._pointB&&this._pointB.pointerId==l.pointerId?this._pointB=null:this._pointA=this._pointB=null,(0!==s||r)&&(this.onMultiTouch(this._pointA,this._pointB,s,0,r,null),s=0,r=null),this._currentActiveButton=-1,this.onButtonUp(l),e||l.preventDefault()}else{try{null==c||c.setPointerCapture(l.pointerId)}catch(e){}if(null===this._pointA)this._pointA={x:l.clientX,y:l.clientY,pointerId:l.pointerId,type:l.pointerType};else{if(null!==this._pointB)return;this._pointB={x:l.clientX,y:l.clientY,pointerId:l.pointerId,type:l.pointerType}}-1!==this._currentActiveButton||h||(this._currentActiveButton=l.button),this.onButtonDown(l),e||(l.preventDefault(),i&&i.focus())}}},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,gi.POINTERDOWN|gi.POINTERUP|gi.POINTERMOVE|gi.POINTERDOUBLETAP),this._onLostFocus=()=>{this._pointA=this._pointB=null,s=0,r=null,this.onLostFocus()},this._contextMenuBind=e=>this.onContextMenu(e),i&&i.addEventListener("contextmenu",this._contextMenuBind,!1);const n=this.camera.getScene().getEngine().getHostWindow();n&&Ht.RegisterTopRootEvents(n,[{name:"blur",handler:this._onLostFocus}])}detachControl(){if(this._onLostFocus){const e=this.camera.getScene().getEngine().getHostWindow();e&&Ht.UnregisterTopRootEvents(e,[{name:"blur",handler:this._onLostFocus}])}if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._contextMenuBind){const e=this.camera.getScene().getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this._onLostFocus=null}this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._currentActiveButton=-1}getClassName(){return"BaseCameraPointersInput"}getSimpleName(){return"pointers"}onDoubleTap(e){}onTouch(e,t,i){}onMultiTouch(e,t,i,s,r,n){}onContextMenu(e){e.preventDefault()}onButtonDown(e){}onButtonUp(e){}onLostFocus(){}}me([ie()],ho.prototype,"buttons",void 0);var co,uo,po,_o,fo,mo,go={};class vo{constructor(e){this.attachedToElement=!1,this.attached={},this.camera=e,this.checkInputs=()=>{}}add(e){const t=e.getSimpleName();this.attached[t]?k.Warn("camera input of type "+t+" already exists on camera"):(this.attached[t]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedToElement&&e.attachControl(this.noPreventDefault))}remove(e){for(const t in this.attached){const i=this.attached[t];if(i===e)return i.detachControl(),i.camera=null,delete this.attached[t],void this.rebuildInputCheck()}}removeByType(e){for(const t in this.attached){const i=this.attached[t];i.getClassName()===e&&(i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck())}}_addCheckInputs(e){const t=this.checkInputs;return()=>{t(),e()}}attachInput(e){this.attachedToElement&&e.attachControl(this.noPreventDefault)}attachElement(e=!1){if(!this.attachedToElement){e=!ps.ForceAttachControlToAlwaysPreventDefault&&e,this.attachedToElement=!0,this.noPreventDefault=e;for(const t in this.attached)this.attached[t].attachControl(e)}}detachElement(e=!1){for(const t in this.attached)this.attached[t].detachControl(),e&&(this.attached[t].camera=null);this.attachedToElement=!1}rebuildInputCheck(){this.checkInputs=()=>{};for(const e in this.attached){const t=this.attached[e];t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t)))}}clear(){this.attachedToElement&&this.detachElement(!0),this.attached={},this.attachedToElement=!1,this.checkInputs=()=>{}}serialize(e){const t={};for(const e in this.attached){const i=this.attached[e],s=de.Serialize(i);t[i.getClassName()]=s}e.inputsmgr=t}parse(e){const t=e.inputsmgr;if(t){this.clear();for(const e in t){const i=go[e];if(i){const s=t[e],r=de.Parse((()=>new i),s,null);this.add(r)}}}else for(const t in this.attached){const i=go[this.attached[t].getClassName()];if(i){const s=de.Parse((()=>new i),e,null);this.remove(this.attached[t]),this.add(s)}}}}class xo{get isConnected(){return this._isConnected}constructor(e,t,i,s=0,r=1,n=2,o=3){this.id=e,this.index=t,this.browserGamepad=i,this._leftStick={x:0,y:0},this._rightStick={x:0,y:0},this._isConnected=!0,this._invertLeftStickY=!1,this.type=xo.GAMEPAD,this._leftStickAxisX=s,this._leftStickAxisY=r,this._rightStickAxisX=n,this._rightStickAxisY=o,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}onleftstickchanged(e){this._onleftstickchanged=e}onrightstickchanged(e){this._onrightstickchanged=e}get leftStick(){return this._leftStick}set leftStick(e){!this._onleftstickchanged||this._leftStick.x===e.x&&this._leftStick.y===e.y||this._onleftstickchanged(e),this._leftStick=e}get rightStick(){return this._rightStick}set rightStick(e){!this._onrightstickchanged||this._rightStick.x===e.x&&this._rightStick.y===e.y||this._onrightstickchanged(e),this._rightStick=e}update(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]},this._invertLeftStickY&&(this.leftStick.y*=-1)),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}dispose(){}}xo.GAMEPAD=0,xo.GENERIC=1,xo.XBOX=2,xo.POSE_ENABLED=3,xo.DUALSHOCK=4;class To extends xo{onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}constructor(e,t,i){super(e,t,i),this.onButtonDownObservable=new a,this.onButtonUpObservable=new a,this.type=xo.GENERIC,this._buttons=new Array(i.buttons.length)}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}update(){super.update();for(let e=0;e<this._buttons.length;e++)this._buttons[e]=this._setButtonValue(this.browserGamepad.buttons[e].value,this._buttons[e],e)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear()}}class Eo{constructor(){this.gamepadRotationSensibility=80,this.gamepadMoveSensibility=40,this._yAxisScale=1}get invertYAxis(){return 1!==this._yAxisScale}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add((e=>{e.type!==xo.POSE_ENABLED&&(this.gamepad&&e.type!==xo.XBOX||(this.gamepad=e))})),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add((e=>{this.gamepad===e&&(this.gamepad=null)})),this.gamepad=e.getGamepadByType(xo.XBOX)}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad){const e=this.camera,t=this.gamepad.rightStick;if(t){if(0!=t.x){const i=t.x/this.gamepadRotationSensibility;0!=i&&Math.abs(i)>.005&&(e.inertialAlphaOffset+=i)}if(0!=t.y){const i=t.y/this.gamepadRotationSensibility*this._yAxisScale;0!=i&&Math.abs(i)>.005&&(e.inertialBetaOffset+=i)}}const i=this.gamepad.leftStick;if(i&&0!=i.y){const e=i.y/this.gamepadMoveSensibility;0!=e&&Math.abs(e)>.005&&(this.camera.inertialRadiusOffset-=e)}}}getClassName(){return"ArcRotateCameraGamepadInput"}getSimpleName(){return"gamepad"}}me([ie()],Eo.prototype,"gamepadRotationSensibility",void 0),me([ie()],Eo.prototype,"gamepadMoveSensibility",void 0),go.ArcRotateCameraGamepadInput=Eo;class So{constructor(){this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysReset=[220],this.panningSensibility=50,this.zoomingSensibility=25,this.useAltToZoom=!0,this.angularSpeed=.01,this._keys=new Array}attachControl(e){e=Ht.BackCompatCameraNoPreventDefault(arguments),this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add((()=>{this._keys.length=0})),this._onKeyboardObserver=this._scene.onKeyboardObservable.add((t=>{const i=t.event;if(!i.metaKey)if(t.type===Ei.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysReset.indexOf(i.keyCode))&&(-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysReset.indexOf(i.keyCode)){const t=this._keys.indexOf(i.keyCode);t>=0&&this._keys.splice(t,1),i.preventDefault&&(e||i.preventDefault())}})))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];-1!==this.keysLeft.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX-=1/this.panningSensibility:e.inertialAlphaOffset-=this.angularSpeed:-1!==this.keysUp.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY+=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset+=1/this.zoomingSensibility:e.inertialBetaOffset-=this.angularSpeed:-1!==this.keysRight.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX+=1/this.panningSensibility:e.inertialAlphaOffset+=this.angularSpeed:-1!==this.keysDown.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY-=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset-=1/this.zoomingSensibility:e.inertialBetaOffset+=this.angularSpeed:-1!==this.keysReset.indexOf(i)&&e.useInputToRestoreState&&e.restoreState()}}}getClassName(){return"ArcRotateCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}}me([ie()],So.prototype,"keysUp",void 0),me([ie()],So.prototype,"keysDown",void 0),me([ie()],So.prototype,"keysLeft",void 0),me([ie()],So.prototype,"keysRight",void 0),me([ie()],So.prototype,"keysReset",void 0),me([ie()],So.prototype,"panningSensibility",void 0),me([ie()],So.prototype,"zoomingSensibility",void 0),me([ie()],So.prototype,"useAltToZoom",void 0),me([ie()],So.prototype,"angularSpeed",void 0),go.ArcRotateCameraKeyboardMoveInput=So;class bo{constructor(){this.wheelPrecision=3,this.zoomToMouseLocation=!1,this.wheelDeltaPercentage=0,this.customComputeDeltaFromMouseWheel=null,this._viewOffset=new S(0,0,0),this._globalOffset=new S(0,0,0),this._inertialPanning=S.Zero()}_computeDeltaFromMouseWheelLegacyEvent(e,t){let i=0;const s=.01*e*this.wheelDeltaPercentage*t;return i=e>0?s/(1+this.wheelDeltaPercentage):s*(1+this.wheelDeltaPercentage),i}attachControl(e){e=Ht.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==gi.POINTERWHEEL)return;const i=t.event;let s=0;const r=i.deltaMode===Ci.DOM_DELTA_LINE?40:1,n=-i.deltaY*r;if(this.customComputeDeltaFromMouseWheel)s=this.customComputeDeltaFromMouseWheel(n,this,i);else if(this.wheelDeltaPercentage){if(s=this._computeDeltaFromMouseWheelLegacyEvent(n,this.camera.radius),s>0){let e=this.camera.radius,t=this.camera.inertialRadiusOffset+s;for(let i=0;i<20&&Math.abs(t)>.001;i++)e-=t,t*=this.camera.inertia;e=l.Clamp(e,0,Number.MAX_VALUE),s=this._computeDeltaFromMouseWheelLegacyEvent(n,e)}}else s=n/(40*this.wheelPrecision);s&&(this.zoomToMouseLocation?(this._hitPlane||this._updateHitPlane(),this._zoomToMouse(s)):this.camera.inertialRadiusOffset+=s),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,gi.POINTERWHEEL),this.zoomToMouseLocation&&this._inertialPanning.setAll(0)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}checkInputs(){if(!this.zoomToMouseLocation)return;const e=this.camera;0+e.inertialAlphaOffset+e.inertialBetaOffset+e.inertialRadiusOffset&&(this._updateHitPlane(),e.target.addInPlace(this._inertialPanning),this._inertialPanning.scaleInPlace(e.inertia),this._zeroIfClose(this._inertialPanning))}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}_updateHitPlane(){const e=this.camera,t=e.target.subtract(e.position);this._hitPlane=wi.FromPositionAndNormal(e.target,t)}_getPosition(){var e;const t=this.camera,i=t.getScene(),s=i.createPickingRay(i.pointerX,i.pointerY,y.Identity(),t,!1);0===t.targetScreenOffset.x&&0===t.targetScreenOffset.y||(this._viewOffset.set(t.targetScreenOffset.x,t.targetScreenOffset.y,0),t.getViewMatrix().invertToRef(t._cameraTransformMatrix),this._globalOffset=S.TransformNormal(this._viewOffset,t._cameraTransformMatrix),s.origin.addInPlace(this._globalOffset));let r=0;return this._hitPlane&&(r=null!==(e=s.intersectsPlane(this._hitPlane))&&void 0!==e?e:0),s.origin.addInPlace(s.direction.scaleInPlace(r))}_zoomToMouse(e){var t,i;const s=this.camera,r=1-s.inertia;if(s.lowerRadiusLimit){const i=null!==(t=s.lowerRadiusLimit)&&void 0!==t?t:0;s.radius-(s.inertialRadiusOffset+e)/r<i&&(e=(s.radius-i)*r-s.inertialRadiusOffset)}if(s.upperRadiusLimit){const t=null!==(i=s.upperRadiusLimit)&&void 0!==i?i:0;s.radius-(s.inertialRadiusOffset+e)/r>t&&(e=(s.radius-t)*r-s.inertialRadiusOffset)}const n=e/r/s.radius,o=this._getPosition(),a=R.Vector3[6];o.subtractToRef(s.target,a),a.scaleInPlace(n),a.scaleInPlace(r),this._inertialPanning.addInPlace(a),s.inertialRadiusOffset+=e}_zeroIfClose(e){Math.abs(e.x)<u&&(e.x=0),Math.abs(e.y)<u&&(e.y=0),Math.abs(e.z)<u&&(e.z=0)}}me([ie()],bo.prototype,"wheelPrecision",void 0),me([ie()],bo.prototype,"zoomToMouseLocation",void 0),me([ie()],bo.prototype,"wheelDeltaPercentage",void 0),go.ArcRotateCameraMouseWheelInput=bo;class Co extends ho{constructor(){super(...arguments),this.buttons=[0,1,2],this.angularSensibilityX=1e3,this.angularSensibilityY=1e3,this.pinchPrecision=12,this.pinchDeltaPercentage=0,this.useNaturalPinchZoom=!1,this.pinchZoom=!0,this.panningSensibility=1e3,this.multiTouchPanning=!0,this.multiTouchPanAndZoom=!0,this.pinchInwards=!0,this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}getClassName(){return"ArcRotateCameraPointersInput"}_computeMultiTouchPanning(e,t){if(0!==this.panningSensibility&&e&&t){const i=t.x-e.x,s=t.y-e.y;this.camera.inertialPanningX+=-i/this.panningSensibility,this.camera.inertialPanningY+=s/this.panningSensibility}}_computePinchZoom(e,t){const i=this.camera.radius||Co.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=i*Math.sqrt(e)/Math.sqrt(t):this.pinchDeltaPercentage?this.camera.inertialRadiusOffset+=.001*(t-e)*i*this.pinchDeltaPercentage:this.camera.inertialRadiusOffset+=(t-e)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2)}onTouch(e,t,i){0!==this.panningSensibility&&(this._ctrlKey&&this.camera._useCtrlForPanning||this._isPanClick)?(this.camera.inertialPanningX+=-t/this.panningSensibility,this.camera.inertialPanningY+=i/this.panningSensibility):(this.camera.inertialAlphaOffset-=t/this.angularSensibilityX,this.camera.inertialBetaOffset-=i/this.angularSensibilityY)}onDoubleTap(){this.camera.useInputToRestoreState&&this.camera.restoreState()}onMultiTouch(e,t,i,s,r,n){0===i&&null===r||0===s&&null===n||(this.multiTouchPanAndZoom?(this._computePinchZoom(i,s),this._computeMultiTouchPanning(r,n)):this.multiTouchPanning&&this.pinchZoom?(this._twoFingerActivityCount++,this._isPinching||this._twoFingerActivityCount<20&&Math.abs(Math.sqrt(s)-Math.sqrt(i))>this.camera.pinchToPanMaxDistance?(this._computePinchZoom(i,s),this._isPinching=!0):this._computeMultiTouchPanning(r,n)):this.multiTouchPanning?this._computeMultiTouchPanning(r,n):this.pinchZoom&&this._computePinchZoom(i,s))}onButtonDown(e){this._isPanClick=e.button===this.camera._panningMouseButton}onButtonUp(e){this._twoFingerActivityCount=0,this._isPinching=!1}onLostFocus(){this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}}Co.MinimumRadiusForPinch=.001,me([ie()],Co.prototype,"buttons",void 0),me([ie()],Co.prototype,"angularSensibilityX",void 0),me([ie()],Co.prototype,"angularSensibilityY",void 0),me([ie()],Co.prototype,"pinchPrecision",void 0),me([ie()],Co.prototype,"pinchDeltaPercentage",void 0),me([ie()],Co.prototype,"useNaturalPinchZoom",void 0),me([ie()],Co.prototype,"pinchZoom",void 0),me([ie()],Co.prototype,"panningSensibility",void 0),me([ie()],Co.prototype,"multiTouchPanning",void 0),me([ie()],Co.prototype,"multiTouchPanAndZoom",void 0),go.ArcRotateCameraPointersInput=Co;class yo extends vo{constructor(e){super(e)}addMouseWheel(){return this.add(new bo),this}addPointers(){return this.add(new Co),this}addKeyboard(){return this.add(new So),this}}yo.prototype.addVRDeviceOrientation=function(){return this.add(new Ao),this};class Ao{constructor(){this.alphaCorrection=1,this.gammaCorrection=1,this._alpha=0,this._gamma=0,this._dirty=!1,this._deviceOrientationHandler=e=>this._onOrientationEvent(e)}attachControl(e){e=Ht.BackCompatCameraNoPreventDefault(arguments),this.camera.attachControl(e);const t=this.camera.getScene().getEngine().getHostWindow();t&&("undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((e=>{"granted"===e?t.addEventListener("deviceorientation",this._deviceOrientationHandler):Ht.Warn("Permission not granted.")})).catch((e=>{Ht.Error(e)})):t.addEventListener("deviceorientation",this._deviceOrientationHandler))}_onOrientationEvent(e){null!==e.alpha&&(this._alpha=(0|+e.alpha)*this.alphaCorrection),null!==e.gamma&&(this._gamma=(0|+e.gamma)*this.gammaCorrection),this._dirty=!0}checkInputs(){this._dirty&&(this._dirty=!1,this._gamma<0&&(this._gamma=180+this._gamma),this.camera.alpha=-this._alpha/180*Math.PI%Math.PI*2,this.camera.beta=this._gamma/180*Math.PI)}detachControl(){window.removeEventListener("deviceorientation",this._deviceOrientationHandler)}getClassName(){return"ArcRotateCameraVRDeviceOrientationInput"}getSimpleName(){return"VRDeviceOrientation"}}go.ArcRotateCameraVRDeviceOrientationInput=Ao;class Ro{constructor(){this.keysForward=[87],this.keysBackward=[83],this.keysUp=[69],this.keysDown=[81],this.keysRight=[68],this.keysLeft=[65],this._keys=new Array}attachControl(e){e=Ht.BackCompatCameraNoPreventDefault(arguments),this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add((()=>{this._keys.length=0})),this._onKeyboardObserver=this._scene.onKeyboardObservable.add((t=>{const i=t.event;if(t.type===Ei.KEYDOWN)-1===this.keysForward.indexOf(i.keyCode)&&-1===this.keysBackward.indexOf(i.keyCode)&&-1===this.keysUp.indexOf(i.keyCode)&&-1===this.keysDown.indexOf(i.keyCode)&&-1===this.keysLeft.indexOf(i.keyCode)&&-1===this.keysRight.indexOf(i.keyCode)||(-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),e||i.preventDefault());else if(-1!==this.keysForward.indexOf(i.keyCode)||-1!==this.keysBackward.indexOf(i.keyCode)||-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)){const t=this._keys.indexOf(i.keyCode);t>=0&&this._keys.splice(t,1),e||i.preventDefault()}})))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}getClassName(){return"FlyCameraKeyboardInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],s=e._computeLocalCameraSpeed();-1!==this.keysForward.indexOf(i)?e._localDirection.copyFromFloats(0,0,s):-1!==this.keysBackward.indexOf(i)?e._localDirection.copyFromFloats(0,0,-s):-1!==this.keysUp.indexOf(i)?e._localDirection.copyFromFloats(0,s,0):-1!==this.keysDown.indexOf(i)?e._localDirection.copyFromFloats(0,-s,0):-1!==this.keysRight.indexOf(i)?e._localDirection.copyFromFloats(s,0,0):-1!==this.keysLeft.indexOf(i)&&e._localDirection.copyFromFloats(-s,0,0),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),S.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}}me([ie()],Ro.prototype,"keysForward",void 0),me([ie()],Ro.prototype,"keysBackward",void 0),me([ie()],Ro.prototype,"keysUp",void 0),me([ie()],Ro.prototype,"keysDown",void 0),me([ie()],Ro.prototype,"keysRight",void 0),me([ie()],Ro.prototype,"keysLeft",void 0),go.FlyCameraKeyboardInput=Ro;class Io{constructor(){this.buttons=[0,1,2],this.buttonsYaw=[-1,0,1],this.buttonsPitch=[-1,0,1],this.buttonsRoll=[2],this.activeButton=-1,this.angularSensibility=1e3,this._previousPosition=null}attachControl(e){e=Ht.BackCompatCameraNoPreventDefault(arguments),this._noPreventDefault=e,this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver((e=>{this._pointerInput(e)}),gi.POINTERDOWN|gi.POINTERUP|gi.POINTERMOVE),this._rollObserver=this.camera.getScene().onBeforeRenderObservable.add((()=>{this.camera.rollCorrect&&this.camera.restoreRoll(this.camera.rollCorrect)}))}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this.camera.getScene().onBeforeRenderObservable.remove(this._rollObserver),this._observer=null,this._rollObserver=null,this._previousPosition=null,this._noPreventDefault=void 0)}getClassName(){return"FlyCameraMouseInput"}getSimpleName(){return"mouse"}_pointerInput(e){const t=e.event,i=this.camera.getEngine();if(!this.touchEnabled&&"touch"===t.pointerType)return;if(e.type!==gi.POINTERMOVE&&-1===this.buttons.indexOf(t.button))return;const s=t.target;if(e.type===gi.POINTERDOWN){try{null==s||s.setPointerCapture(t.pointerId)}catch(t){}this._previousPosition={x:t.clientX,y:t.clientY},this.activeButton=t.button,this._noPreventDefault||(t.preventDefault(),this._element.focus()),i.isPointerLock&&this._onMouseMove(e.event)}else if(e.type===gi.POINTERUP){try{null==s||s.releasePointerCapture(t.pointerId)}catch(t){}this.activeButton=-1,this._previousPosition=null,this._noPreventDefault||t.preventDefault()}else if(e.type===gi.POINTERMOVE){if(!this._previousPosition)return void(i.isPointerLock&&this._onMouseMove(e.event));const s=t.clientX-this._previousPosition.x,r=t.clientY-this._previousPosition.y;this._rotateCamera(s,r),this._previousPosition={x:t.clientX,y:t.clientY},this._noPreventDefault||t.preventDefault()}}_onMouseMove(e){if(!this.camera.getEngine().isPointerLock)return;const t=e.movementX,i=e.movementY;this._rotateCamera(t,i),this._previousPosition=null,this._noPreventDefault||e.preventDefault()}_rotateCamera(e,t){const i=this.camera,s=(e*=i._calculateHandednessMultiplier())/this.angularSensibility,r=t/this.angularSensibility,n=C.RotationYawPitchRoll(i.rotation.y,i.rotation.x,i.rotation.z);let o;if(this.buttonsPitch.some((e=>e===this.activeButton))&&(o=C.RotationAxis(ji.X,r),n.multiplyInPlace(o)),this.buttonsYaw.some((e=>e===this.activeButton))){o=C.RotationAxis(ji.Y,s),n.multiplyInPlace(o);const e=i.bankedTurnLimit+i._trackRoll;if(i.bankedTurn&&-e<i.rotation.z&&i.rotation.z<e){const e=i.bankedTurnMultiplier*-s;o=C.RotationAxis(ji.Z,e),n.multiplyInPlace(o)}}this.buttonsRoll.some((e=>e===this.activeButton))&&(o=C.RotationAxis(ji.Z,-s),i._trackRoll-=s,n.multiplyInPlace(o)),n.toEulerAnglesToRef(i.rotation)}}me([ie()],Io.prototype,"buttons",void 0),me([ie()],Io.prototype,"angularSensibility",void 0),go.FlyCameraMouseInput=Io;class Po{constructor(){this.keysHeightOffsetIncr=[38],this.keysHeightOffsetDecr=[40],this.keysHeightOffsetModifierAlt=!1,this.keysHeightOffsetModifierCtrl=!1,this.keysHeightOffsetModifierShift=!1,this.keysRotationOffsetIncr=[37],this.keysRotationOffsetDecr=[39],this.keysRotationOffsetModifierAlt=!1,this.keysRotationOffsetModifierCtrl=!1,this.keysRotationOffsetModifierShift=!1,this.keysRadiusIncr=[40],this.keysRadiusDecr=[38],this.keysRadiusModifierAlt=!0,this.keysRadiusModifierCtrl=!1,this.keysRadiusModifierShift=!1,this.heightSensibility=1,this.rotationSensibility=1,this.radiusSensibility=1,this._keys=new Array}attachControl(e){e=Ht.BackCompatCameraNoPreventDefault(arguments),this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add((()=>{this._keys.length=0})),this._onKeyboardObserver=this._scene.onKeyboardObservable.add((t=>{const i=t.event;if(!i.metaKey)if(t.type===Ei.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,this._shiftPressed=i.shiftKey,(-1!==this.keysHeightOffsetIncr.indexOf(i.keyCode)||-1!==this.keysHeightOffsetDecr.indexOf(i.keyCode)||-1!==this.keysRotationOffsetIncr.indexOf(i.keyCode)||-1!==this.keysRotationOffsetDecr.indexOf(i.keyCode)||-1!==this.keysRadiusIncr.indexOf(i.keyCode)||-1!==this.keysRadiusDecr.indexOf(i.keyCode))&&(-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(-1!==this.keysHeightOffsetIncr.indexOf(i.keyCode)||-1!==this.keysHeightOffsetDecr.indexOf(i.keyCode)||-1!==this.keysRotationOffsetIncr.indexOf(i.keyCode)||-1!==this.keysRotationOffsetDecr.indexOf(i.keyCode)||-1!==this.keysRadiusIncr.indexOf(i.keyCode)||-1!==this.keysRadiusDecr.indexOf(i.keyCode)){const t=this._keys.indexOf(i.keyCode);t>=0&&this._keys.splice(t,1),i.preventDefault&&(e||i.preventDefault())}})))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){this._onKeyboardObserver&&this._keys.forEach((e=>{-1!==this.keysHeightOffsetIncr.indexOf(e)&&this._modifierHeightOffset()?this.camera.heightOffset+=this.heightSensibility:-1!==this.keysHeightOffsetDecr.indexOf(e)&&this._modifierHeightOffset()?this.camera.heightOffset-=this.heightSensibility:-1!==this.keysRotationOffsetIncr.indexOf(e)&&this._modifierRotationOffset()?(this.camera.rotationOffset+=this.rotationSensibility,this.camera.rotationOffset%=360):-1!==this.keysRotationOffsetDecr.indexOf(e)&&this._modifierRotationOffset()?(this.camera.rotationOffset-=this.rotationSensibility,this.camera.rotationOffset%=360):-1!==this.keysRadiusIncr.indexOf(e)&&this._modifierRadius()?this.camera.radius+=this.radiusSensibility:-1!==this.keysRadiusDecr.indexOf(e)&&this._modifierRadius()&&(this.camera.radius-=this.radiusSensibility)}))}getClassName(){return"FollowCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}_modifierHeightOffset(){return this.keysHeightOffsetModifierAlt===this._altPressed&&this.keysHeightOffsetModifierCtrl===this._ctrlPressed&&this.keysHeightOffsetModifierShift===this._shiftPressed}_modifierRotationOffset(){return this.keysRotationOffsetModifierAlt===this._altPressed&&this.keysRotationOffsetModifierCtrl===this._ctrlPressed&&this.keysRotationOffsetModifierShift===this._shiftPressed}_modifierRadius(){return this.keysRadiusModifierAlt===this._altPressed&&this.keysRadiusModifierCtrl===this._ctrlPressed&&this.keysRadiusModifierShift===this._shiftPressed}}me([ie()],Po.prototype,"keysHeightOffsetIncr",void 0),me([ie()],Po.prototype,"keysHeightOffsetDecr",void 0),me([ie()],Po.prototype,"keysHeightOffsetModifierAlt",void 0),me([ie()],Po.prototype,"keysHeightOffsetModifierCtrl",void 0),me([ie()],Po.prototype,"keysHeightOffsetModifierShift",void 0),me([ie()],Po.prototype,"keysRotationOffsetIncr",void 0),me([ie()],Po.prototype,"keysRotationOffsetDecr",void 0),me([ie()],Po.prototype,"keysRotationOffsetModifierAlt",void 0),me([ie()],Po.prototype,"keysRotationOffsetModifierCtrl",void 0),me([ie()],Po.prototype,"keysRotationOffsetModifierShift",void 0),me([ie()],Po.prototype,"keysRadiusIncr",void 0),me([ie()],Po.prototype,"keysRadiusDecr",void 0),me([ie()],Po.prototype,"keysRadiusModifierAlt",void 0),me([ie()],Po.prototype,"keysRadiusModifierCtrl",void 0),me([ie()],Po.prototype,"keysRadiusModifierShift",void 0),me([ie()],Po.prototype,"heightSensibility",void 0),me([ie()],Po.prototype,"rotationSensibility",void 0),me([ie()],Po.prototype,"radiusSensibility",void 0),go.FollowCameraKeyboardMoveInput=Po;class Mo{constructor(){this.axisControlRadius=!0,this.axisControlHeight=!1,this.axisControlRotation=!1,this.wheelPrecision=3,this.wheelDeltaPercentage=0}attachControl(e){e=Ht.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==gi.POINTERWHEEL)return;const i=t.event;let s=0;const r=Math.max(-1,Math.min(1,i.deltaY));this.wheelDeltaPercentage?(console.assert(this.axisControlRadius+this.axisControlHeight+this.axisControlRotation<=1,"wheelDeltaPercentage only usable when mouse wheel controls ONE axis. Currently enabled: axisControlRadius: "+this.axisControlRadius+", axisControlHeightOffset: "+this.axisControlHeight+", axisControlRotationOffset: "+this.axisControlRotation),this.axisControlRadius?s=.01*r*this.wheelDeltaPercentage*this.camera.radius:this.axisControlHeight?s=.01*r*this.wheelDeltaPercentage*this.camera.heightOffset:this.axisControlRotation&&(s=.01*r*this.wheelDeltaPercentage*this.camera.rotationOffset)):s=r*this.wheelPrecision,s&&(this.axisControlRadius?this.camera.radius+=s:this.axisControlHeight?this.camera.heightOffset-=s:this.axisControlRotation&&(this.camera.rotationOffset-=s)),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,gi.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}me([ie()],Mo.prototype,"axisControlRadius",void 0),me([ie()],Mo.prototype,"axisControlHeight",void 0),me([ie()],Mo.prototype,"axisControlRotation",void 0),me([ie()],Mo.prototype,"wheelPrecision",void 0),me([ie()],Mo.prototype,"wheelDeltaPercentage",void 0),go.FollowCameraMouseWheelInput=Mo;class Oo extends ho{constructor(){super(...arguments),this.angularSensibilityX=1,this.angularSensibilityY=1,this.pinchPrecision=1e4,this.pinchDeltaPercentage=0,this.axisXControlRadius=!1,this.axisXControlHeight=!1,this.axisXControlRotation=!0,this.axisYControlRadius=!1,this.axisYControlHeight=!0,this.axisYControlRotation=!1,this.axisPinchControlRadius=!0,this.axisPinchControlHeight=!1,this.axisPinchControlRotation=!1,this.warningEnable=!0,this._warningCounter=0}getClassName(){return"FollowCameraPointersInput"}onTouch(e,t,i){this._warning(),this.axisXControlRotation?this.camera.rotationOffset+=t/this.angularSensibilityX:this.axisYControlRotation&&(this.camera.rotationOffset+=i/this.angularSensibilityX),this.axisXControlHeight?this.camera.heightOffset+=t/this.angularSensibilityY:this.axisYControlHeight&&(this.camera.heightOffset+=i/this.angularSensibilityY),this.axisXControlRadius?this.camera.radius-=t/this.angularSensibilityY:this.axisYControlRadius&&(this.camera.radius-=i/this.angularSensibilityY)}onMultiTouch(e,t,i,s,r,n){if(0===i&&null===r)return;if(0===s&&null===n)return;let o=(s-i)/(this.pinchPrecision*(this.angularSensibilityX+this.angularSensibilityY)/2);this.pinchDeltaPercentage?(o*=.01*this.pinchDeltaPercentage,this.axisPinchControlRotation&&(this.camera.rotationOffset+=o*this.camera.rotationOffset),this.axisPinchControlHeight&&(this.camera.heightOffset+=o*this.camera.heightOffset),this.axisPinchControlRadius&&(this.camera.radius-=o*this.camera.radius)):(this.axisPinchControlRotation&&(this.camera.rotationOffset+=o),this.axisPinchControlHeight&&(this.camera.heightOffset+=o),this.axisPinchControlRadius&&(this.camera.radius-=o))}_warning(){if(!this.warningEnable||this._warningCounter++%100!=0)return;const e="It probably only makes sense to control ONE camera property with each pointer axis. Set 'warningEnable = false' if you are sure. Currently enabled: ";console.assert(this.axisXControlRotation+this.axisXControlHeight+this.axisXControlRadius<=1,e+"axisXControlRotation: "+this.axisXControlRotation+", axisXControlHeight: "+this.axisXControlHeight+", axisXControlRadius: "+this.axisXControlRadius),console.assert(this.axisYControlRotation+this.axisYControlHeight+this.axisYControlRadius<=1,e+"axisYControlRotation: "+this.axisYControlRotation+", axisYControlHeight: "+this.axisYControlHeight+", axisYControlRadius: "+this.axisYControlRadius),console.assert(this.axisPinchControlRotation+this.axisPinchControlHeight+this.axisPinchControlRadius<=1,e+"axisPinchControlRotation: "+this.axisPinchControlRotation+", axisPinchControlHeight: "+this.axisPinchControlHeight+", axisPinchControlRadius: "+this.axisPinchControlRadius)}}me([ie()],Oo.prototype,"angularSensibilityX",void 0),me([ie()],Oo.prototype,"angularSensibilityY",void 0),me([ie()],Oo.prototype,"pinchPrecision",void 0),me([ie()],Oo.prototype,"pinchDeltaPercentage",void 0),me([ie()],Oo.prototype,"axisXControlRadius",void 0),me([ie()],Oo.prototype,"axisXControlHeight",void 0),me([ie()],Oo.prototype,"axisXControlRotation",void 0),me([ie()],Oo.prototype,"axisYControlRadius",void 0),me([ie()],Oo.prototype,"axisYControlHeight",void 0),me([ie()],Oo.prototype,"axisYControlRotation",void 0),me([ie()],Oo.prototype,"axisPinchControlRadius",void 0),me([ie()],Oo.prototype,"axisPinchControlHeight",void 0),me([ie()],Oo.prototype,"axisPinchControlRotation",void 0),go.FollowCameraPointersInput=Oo;class Do{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this.keysRotateUp=[],this.keysRotateDown=[],this._keys=new Array}attachControl(e){e=Ht.BackCompatCameraNoPreventDefault(arguments),this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add((()=>{this._keys.length=0})),this._onKeyboardObserver=this._scene.onKeyboardObservable.add((t=>{const i=t.event;if(!i.metaKey)if(t.type===Ei.KEYDOWN)-1===this.keysUp.indexOf(i.keyCode)&&-1===this.keysDown.indexOf(i.keyCode)&&-1===this.keysLeft.indexOf(i.keyCode)&&-1===this.keysRight.indexOf(i.keyCode)&&-1===this.keysUpward.indexOf(i.keyCode)&&-1===this.keysDownward.indexOf(i.keyCode)&&-1===this.keysRotateLeft.indexOf(i.keyCode)&&-1===this.keysRotateRight.indexOf(i.keyCode)&&-1===this.keysRotateUp.indexOf(i.keyCode)&&-1===this.keysRotateDown.indexOf(i.keyCode)||(-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),e||i.preventDefault());else if(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysUpward.indexOf(i.keyCode)||-1!==this.keysDownward.indexOf(i.keyCode)||-1!==this.keysRotateLeft.indexOf(i.keyCode)||-1!==this.keysRotateRight.indexOf(i.keyCode)||-1!==this.keysRotateUp.indexOf(i.keyCode)||-1!==this.keysRotateDown.indexOf(i.keyCode)){const t=this._keys.indexOf(i.keyCode);t>=0&&this._keys.splice(t,1),e||i.preventDefault()}})))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],s=e._computeLocalCameraSpeed();-1!==this.keysLeft.indexOf(i)?e._localDirection.copyFromFloats(-s,0,0):-1!==this.keysUp.indexOf(i)?e._localDirection.copyFromFloats(0,0,s):-1!==this.keysRight.indexOf(i)?e._localDirection.copyFromFloats(s,0,0):-1!==this.keysDown.indexOf(i)?e._localDirection.copyFromFloats(0,0,-s):-1!==this.keysUpward.indexOf(i)?e._localDirection.copyFromFloats(0,s,0):-1!==this.keysDownward.indexOf(i)?e._localDirection.copyFromFloats(0,-s,0):-1!==this.keysRotateLeft.indexOf(i)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):-1!==this.keysRotateRight.indexOf(i)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()):-1!==this.keysRotateUp.indexOf(i)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x-=this._getLocalRotation()):-1!==this.keysRotateDown.indexOf(i)&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),S.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}_getLocalRotation(){const e=this.camera._calculateHandednessMultiplier();return this.rotationSpeed*this._engine.getDeltaTime()/1e3*e}}me([ie()],Do.prototype,"keysUp",void 0),me([ie()],Do.prototype,"keysUpward",void 0),me([ie()],Do.prototype,"keysDown",void 0),me([ie()],Do.prototype,"keysDownward",void 0),me([ie()],Do.prototype,"keysLeft",void 0),me([ie()],Do.prototype,"keysRight",void 0),me([ie()],Do.prototype,"rotationSpeed",void 0),me([ie()],Do.prototype,"keysRotateLeft",void 0),me([ie()],Do.prototype,"keysRotateRight",void 0),me([ie()],Do.prototype,"keysRotateUp",void 0),me([ie()],Do.prototype,"keysRotateDown",void 0),go.FreeCameraKeyboardMoveInput=Do;class No{constructor(e=!0){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new a,this._allowCameraRotation=!0,this._currentActiveButton=-1,this._activePointerId=-1}attachControl(e){e=Ht.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();this._pointerInput||(this._pointerInput=s=>{const r=s.event,n="touch"===r.pointerType;if(!this.touchEnabled&&n)return;if(s.type!==gi.POINTERMOVE&&-1===this.buttons.indexOf(r.button))return;const o=r.target;if(s.type===gi.POINTERDOWN){if(n&&-1!==this._activePointerId||!n&&-1!==this._currentActiveButton)return;this._activePointerId=r.pointerId;try{null==o||o.setPointerCapture(r.pointerId)}catch(e){}-1===this._currentActiveButton&&(this._currentActiveButton=r.button),this._previousPosition={x:r.clientX,y:r.clientY},e||(r.preventDefault(),i&&i.focus()),t.isPointerLock&&this._onMouseMove&&this._onMouseMove(s.event)}else if(s.type===gi.POINTERUP){if(n&&this._activePointerId!==r.pointerId||!n&&this._currentActiveButton!==r.button)return;try{null==o||o.releasePointerCapture(r.pointerId)}catch(e){}this._currentActiveButton=-1,this._previousPosition=null,e||r.preventDefault(),this._activePointerId=-1}else if(s.type===gi.POINTERMOVE&&(this._activePointerId===r.pointerId||!n))if(t.isPointerLock&&this._onMouseMove)this._onMouseMove(s.event);else if(this._previousPosition){const t=this.camera._calculateHandednessMultiplier(),i=(r.clientX-this._previousPosition.x)*t,s=r.clientY-this._previousPosition.y;this._allowCameraRotation&&(this.camera.cameraRotation.y+=i/this.angularSensibility,this.camera.cameraRotation.x+=s/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:i,offsetY:s}),this._previousPosition={x:r.clientX,y:r.clientY},e||r.preventDefault()}}),this._onMouseMove=i=>{if(!t.isPointerLock)return;const s=this.camera._calculateHandednessMultiplier(),r=i.movementX*s;this.camera.cameraRotation.y+=r/this.angularSensibility;const n=i.movementY;this.camera.cameraRotation.x+=n/this.angularSensibility,this._previousPosition=null,e||i.preventDefault()},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,gi.POINTERDOWN|gi.POINTERUP|gi.POINTERMOVE),i&&(this._contextMenuBind=e=>this.onContextMenu(e),i.addEventListener("contextmenu",this._contextMenuBind,!1))}onContextMenu(e){e.preventDefault()}detachControl(){if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._contextMenuBind){const e=this.camera.getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._activePointerId=-1,this._currentActiveButton=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}}me([ie()],No.prototype,"buttons",void 0),me([ie()],No.prototype,"angularSensibility",void 0),go.FreeCameraMouseInput=No,function(e){e[e.MoveRelative=0]="MoveRelative",e[e.RotateRelative=1]="RotateRelative",e[e.MoveScene=2]="MoveScene"}(co||(co={}));class Fo extends lo{constructor(){super(...arguments),this._moveRelative=S.Zero(),this._rotateRelative=S.Zero(),this._moveScene=S.Zero(),this._wheelXAction=co.MoveRelative,this._wheelXActionCoordinate=zi.X,this._wheelYAction=co.MoveRelative,this._wheelYActionCoordinate=zi.Z,this._wheelZAction=null,this._wheelZActionCoordinate=null}getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){null===e&&this._wheelXAction!==co.MoveRelative||(this._wheelXAction=co.MoveRelative,this._wheelXActionCoordinate=e)}get wheelXMoveRelative(){return this._wheelXAction!==co.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){null===e&&this._wheelYAction!==co.MoveRelative||(this._wheelYAction=co.MoveRelative,this._wheelYActionCoordinate=e)}get wheelYMoveRelative(){return this._wheelYAction!==co.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){null===e&&this._wheelZAction!==co.MoveRelative||(this._wheelZAction=co.MoveRelative,this._wheelZActionCoordinate=e)}get wheelZMoveRelative(){return this._wheelZAction!==co.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){null===e&&this._wheelXAction!==co.RotateRelative||(this._wheelXAction=co.RotateRelative,this._wheelXActionCoordinate=e)}get wheelXRotateRelative(){return this._wheelXAction!==co.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){null===e&&this._wheelYAction!==co.RotateRelative||(this._wheelYAction=co.RotateRelative,this._wheelYActionCoordinate=e)}get wheelYRotateRelative(){return this._wheelYAction!==co.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){null===e&&this._wheelZAction!==co.RotateRelative||(this._wheelZAction=co.RotateRelative,this._wheelZActionCoordinate=e)}get wheelZRotateRelative(){return this._wheelZAction!==co.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){null===e&&this._wheelXAction!==co.MoveScene||(this._wheelXAction=co.MoveScene,this._wheelXActionCoordinate=e)}get wheelXMoveScene(){return this._wheelXAction!==co.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){null===e&&this._wheelYAction!==co.MoveScene||(this._wheelYAction=co.MoveScene,this._wheelYActionCoordinate=e)}get wheelYMoveScene(){return this._wheelYAction!==co.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){null===e&&this._wheelZAction!==co.MoveScene||(this._wheelZAction=co.MoveScene,this._wheelZActionCoordinate=e)}get wheelZMoveScene(){return this._wheelZAction!==co.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(0===this._wheelDeltaX&&0===this._wheelDeltaY&&0==this._wheelDeltaZ)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);const e=y.Zero();this.camera.getViewMatrix().invertToRef(e);const t=S.Zero();S.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(e,t,i){if(0===e)return;if(null===t||null===i)return;let s=null;switch(t){case co.MoveRelative:s=this._moveRelative;break;case co.RotateRelative:s=this._rotateRelative;break;case co.MoveScene:s=this._moveScene}switch(i){case zi.X:s.set(e,0,0);break;case zi.Y:s.set(0,e,0);break;case zi.Z:s.set(0,0,e)}}}me([ie()],Fo.prototype,"wheelXMoveRelative",null),me([ie()],Fo.prototype,"wheelYMoveRelative",null),me([ie()],Fo.prototype,"wheelZMoveRelative",null),me([ie()],Fo.prototype,"wheelXRotateRelative",null),me([ie()],Fo.prototype,"wheelYRotateRelative",null),me([ie()],Fo.prototype,"wheelZRotateRelative",null),me([ie()],Fo.prototype,"wheelXMoveScene",null),me([ie()],Fo.prototype,"wheelYMoveScene",null),me([ie()],Fo.prototype,"wheelZMoveScene",null),go.FreeCameraMouseWheelInput=Fo;class wo{constructor(e=!1){this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=Ht.IsSafari()}attachControl(e){e=Ht.BackCompatCameraNoPreventDefault(arguments);let t=null;if(void 0===this._pointerInput&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null},this._pointerInput=i=>{const s=i.event,r="mouse"===s.pointerType||this._isSafari&&void 0===s.pointerType;if(this.allowMouse||!r)if(i.type===gi.POINTERDOWN){if(e||s.preventDefault(),this._pointerPressed.push(s.pointerId),1!==this._pointerPressed.length)return;t={x:s.clientX,y:s.clientY}}else if(i.type===gi.POINTERUP){e||s.preventDefault();const i=this._pointerPressed.indexOf(s.pointerId);if(-1===i)return;if(this._pointerPressed.splice(i,1),0!=i)return;t=null,this._offsetX=null,this._offsetY=null}else if(i.type===gi.POINTERMOVE){if(e||s.preventDefault(),!t)return;if(0!=this._pointerPressed.indexOf(s.pointerId))return;this._offsetX=s.clientX-t.x,this._offsetY=-(s.clientY-t.y)}}),this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,gi.POINTERDOWN|gi.POINTERUP|gi.POINTERMOVE),this._onLostFocus){const e=this.camera.getEngine().getInputElement();e&&e.addEventListener("blur",this._onLostFocus)}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null),this._onLostFocus){const e=this.camera.getEngine().getInputElement();e&&e.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}}checkInputs(){if(null===this._offsetX||null===this._offsetY)return;if(0===this._offsetX&&0===this._offsetY)return;const e=this.camera,t=e._calculateHandednessMultiplier();if(e.cameraRotation.y=t*this._offsetX/this.touchAngularSensibility,this.singleFingerRotate&&1===this._pointerPressed.length||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{const t=e._computeLocalCameraSpeed(),i=new S(0,0,0!==this.touchMoveSensibility?t*this._offsetY/this.touchMoveSensibility:0);y.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(S.TransformCoordinates(i,e._cameraRotationMatrix))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}}me([ie()],wo.prototype,"touchAngularSensibility",void 0),me([ie()],wo.prototype,"touchMoveSensibility",void 0),go.FreeCameraTouchInput=wo;class Lo extends vo{constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null}addKeyboard(){return this.add(new Do),this}addMouse(e=!0){return this._mouseInput||(this._mouseInput=new No(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new Fo,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new wo),this}clear(){super.clear(),this._mouseInput=null}}Lo.prototype.addDeviceOrientation=function(e){return this._deviceOrientationInput||(this._deviceOrientationInput=new Bo,e&&(this._deviceOrientationInput.smoothFactor=e),this.add(this._deviceOrientationInput)),this};class Bo{static WaitForOrientationChangeAsync(e){return new Promise(((t,i)=>{let s=!1;const r=()=>{window.removeEventListener("deviceorientation",r),s=!0,t()};e&&setTimeout((()=>{s||(window.removeEventListener("deviceorientation",r),i("WaitForOrientationChangeAsync timed out"))}),e),"undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((e=>{"granted"==e?window.addEventListener("deviceorientation",r):Ht.Warn("Permission not granted.")})).catch((e=>{Ht.Error(e)})):window.addEventListener("deviceorientation",r)}))}constructor(){this._screenOrientationAngle=0,this._screenQuaternion=new C,this._alpha=0,this._beta=0,this._gamma=0,this.smoothFactor=0,this._onDeviceOrientationChangedObservable=new a,this._orientationChanged=()=>{this._screenOrientationAngle=void 0!==window.orientation?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,this._screenOrientationAngle=-Ht.ToRadians(this._screenOrientationAngle/2),this._screenQuaternion.copyFromFloats(0,Math.sin(this._screenOrientationAngle),0,Math.cos(this._screenOrientationAngle))},this._deviceOrientation=e=>{this.smoothFactor?(this._alpha=null!==e.alpha?Ht.SmoothAngleChange(this._alpha,e.alpha,this.smoothFactor):0,this._beta=null!==e.beta?Ht.SmoothAngleChange(this._beta,e.beta,this.smoothFactor):0,this._gamma=null!==e.gamma?Ht.SmoothAngleChange(this._gamma,e.gamma,this.smoothFactor):0):(this._alpha=null!==e.alpha?e.alpha:0,this._beta=null!==e.beta?e.beta:0,this._gamma=null!==e.gamma?e.gamma:0),null!==e.alpha&&this._onDeviceOrientationChangedObservable.notifyObservers()},this._constantTranform=new C(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._orientationChanged()}get camera(){return this._camera}set camera(e){this._camera=e,null==this._camera||this._camera.rotationQuaternion||(this._camera.rotationQuaternion=new C),this._camera&&this._camera.onDisposeObservable.add((()=>{this._onDeviceOrientationChangedObservable.clear()}))}attachControl(){const e=this.camera.getScene().getEngine().getHostWindow();if(e){const t=()=>{e.addEventListener("orientationchange",this._orientationChanged),e.addEventListener("deviceorientation",this._deviceOrientation),this._orientationChanged()};"undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((e=>{"granted"===e?t():Ht.Warn("Permission not granted.")})).catch((e=>{Ht.Error(e)})):t()}}detachControl(){window.removeEventListener("orientationchange",this._orientationChanged),window.removeEventListener("deviceorientation",this._deviceOrientation),this._alpha=0}checkInputs(){this._alpha&&(C.RotationYawPitchRollToRef(Ht.ToRadians(this._alpha),Ht.ToRadians(this._beta),-Ht.ToRadians(this._gamma),this.camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTranform),this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)}getClassName(){return"FreeCameraDeviceOrientationInput"}getSimpleName(){return"deviceOrientation"}}go.FreeCameraDeviceOrientationInput=Bo;class Uo{constructor(){this.gamepadAngularSensibility=200,this.gamepadMoveSensibility=40,this.deadzoneDelta=.1,this._yAxisScale=1,this._cameraTransform=y.Identity(),this._deltaTransform=S.Zero(),this._vector3=S.Zero(),this._vector2=E.Zero()}get invertYAxis(){return 1!==this._yAxisScale}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add((e=>{e.type!==xo.POSE_ENABLED&&(this.gamepad&&e.type!==xo.XBOX||(this.gamepad=e))})),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add((e=>{this.gamepad===e&&(this.gamepad=null)})),this.gamepad=e.getGamepadByType(xo.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad&&this.gamepad.leftStick){const e=this.camera,t=this.gamepad.leftStick;0!==this.gamepadMoveSensibility&&(t.x=Math.abs(t.x)>this.deadzoneDelta?t.x/this.gamepadMoveSensibility:0,t.y=Math.abs(t.y)>this.deadzoneDelta?t.y/this.gamepadMoveSensibility:0);let i=this.gamepad.rightStick;i&&0!==this.gamepadAngularSensibility?(i.x=Math.abs(i.x)>this.deadzoneDelta?i.x/this.gamepadAngularSensibility:0,i.y=(Math.abs(i.y)>this.deadzoneDelta?i.y/this.gamepadAngularSensibility:0)*this._yAxisScale):i={x:0,y:0},e.rotationQuaternion?e.rotationQuaternion.toRotationMatrix(this._cameraTransform):y.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,this._cameraTransform);const s=50*e._computeLocalCameraSpeed();this._vector3.copyFromFloats(t.x*s,0,-t.y*s),S.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform),e.cameraDirection.addInPlace(this._deltaTransform),this._vector2.copyFromFloats(i.y,i.x),e.cameraRotation.addInPlace(this._vector2)}}getClassName(){return"FreeCameraGamepadInput"}getSimpleName(){return"gamepad"}}me([ie()],Uo.prototype,"gamepadAngularSensibility",void 0),me([ie()],Uo.prototype,"gamepadMoveSensibility",void 0),go.FreeCameraGamepadInput=Uo,function(e){e[e.X=0]="X",e[e.Y=1]="Y",e[e.Z=2]="Z"}(uo||(uo={}));class Vo{static _GetDefaultOptions(){return{puckSize:40,containerSize:60,color:"cyan",puckImage:void 0,containerImage:void 0,position:void 0,alwaysVisible:!1,limitToContainer:!1}}constructor(e,t){this._released=!1;const i=Object.assign(Object.assign({},Vo._GetDefaultOptions()),t);if(this._leftJoystick=!!e,Vo._GlobalJoystickIndex++,this._axisTargetedByLeftAndRight=uo.X,this._axisTargetedByUpAndDown=uo.Y,this.reverseLeftRight=!1,this.reverseUpDown=!1,this._touches=new Kt,this.deltaPosition=S.Zero(),this._joystickSensibility=25,this._inversedSensibility=1/(this._joystickSensibility/1e3),this._onResize=()=>{Vo._VJCanvasWidth=window.innerWidth,Vo._VJCanvasHeight=window.innerHeight,Vo.Canvas&&(Vo.Canvas.width=Vo._VJCanvasWidth,Vo.Canvas.height=Vo._VJCanvasHeight),Vo._HalfWidth=Vo._VJCanvasWidth/2},!Vo.Canvas){window.addEventListener("resize",this._onResize,!1),Vo.Canvas=document.createElement("canvas"),Vo._VJCanvasWidth=window.innerWidth,Vo._VJCanvasHeight=window.innerHeight,Vo.Canvas.width=window.innerWidth,Vo.Canvas.height=window.innerHeight,Vo.Canvas.style.width="100%",Vo.Canvas.style.height="100%",Vo.Canvas.style.position="absolute",Vo.Canvas.style.backgroundColor="transparent",Vo.Canvas.style.top="0px",Vo.Canvas.style.left="0px",Vo.Canvas.style.zIndex="5",Vo.Canvas.style.touchAction="none",Vo.Canvas.setAttribute("touch-action","none");const e=Vo.Canvas.getContext("2d");if(!e)throw new Error("Unable to create canvas for virtual joystick");Vo._VJCanvasContext=e,Vo._VJCanvasContext.strokeStyle="#ffffff",Vo._VJCanvasContext.lineWidth=2,document.body.appendChild(Vo.Canvas)}Vo._HalfWidth=Vo.Canvas.width/2,this.pressed=!1,this.limitToContainer=i.limitToContainer,this._joystickColor=i.color,this.containerSize=i.containerSize,this.puckSize=i.puckSize,i.position&&this.setPosition(i.position.x,i.position.y),i.puckImage&&this.setPuckImage(i.puckImage),i.containerImage&&this.setContainerImage(i.containerImage),i.alwaysVisible&&Vo._AlwaysVisibleSticks++,this.alwaysVisible=i.alwaysVisible,this._joystickPointerId=-1,this._joystickPointerPos=new E(0,0),this._joystickPreviousPointerPos=new E(0,0),this._joystickPointerStartPos=new E(0,0),this._deltaJoystickVector=new E(0,0),this._onPointerDownHandlerRef=e=>{this._onPointerDown(e)},this._onPointerMoveHandlerRef=e=>{this._onPointerMove(e)},this._onPointerUpHandlerRef=e=>{this._onPointerUp(e)},Vo.Canvas.addEventListener("pointerdown",this._onPointerDownHandlerRef,!1),Vo.Canvas.addEventListener("pointermove",this._onPointerMoveHandlerRef,!1),Vo.Canvas.addEventListener("pointerup",this._onPointerUpHandlerRef,!1),Vo.Canvas.addEventListener("pointerout",this._onPointerUpHandlerRef,!1),Vo.Canvas.addEventListener("contextmenu",(e=>{e.preventDefault()}),!1),requestAnimationFrame((()=>{this._drawVirtualJoystick()}))}setJoystickSensibility(e){this._joystickSensibility=e,this._inversedSensibility=1/(this._joystickSensibility/1e3)}_onPointerDown(e){let t;e.preventDefault(),t=!0===this._leftJoystick?e.clientX<Vo._HalfWidth:e.clientX>Vo._HalfWidth,t&&this._joystickPointerId<0?(this._joystickPointerId=e.pointerId,this._joystickPosition?(this._joystickPointerStartPos=this._joystickPosition.clone(),this._joystickPointerPos=this._joystickPosition.clone(),this._joystickPreviousPointerPos=this._joystickPosition.clone(),this._onPointerMove(e)):(this._joystickPointerStartPos.x=e.clientX,this._joystickPointerStartPos.y=e.clientY,this._joystickPointerPos=this._joystickPointerStartPos.clone(),this._joystickPreviousPointerPos=this._joystickPointerStartPos.clone()),this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this.pressed=!0,this._touches.add(e.pointerId.toString(),e)):Vo._GlobalJoystickIndex<2&&this._action&&(this._action(),this._touches.add(e.pointerId.toString(),{x:e.clientX,y:e.clientY,prevX:e.clientX,prevY:e.clientY}))}_onPointerMove(e){if(this._joystickPointerId==e.pointerId){if(this.limitToContainer){const t=new E(e.clientX-this._joystickPointerStartPos.x,e.clientY-this._joystickPointerStartPos.y),i=t.length();i>this.containerSize&&t.scaleInPlace(this.containerSize/i),this._joystickPointerPos.x=this._joystickPointerStartPos.x+t.x,this._joystickPointerPos.y=this._joystickPointerStartPos.y+t.y}else this._joystickPointerPos.x=e.clientX,this._joystickPointerPos.y=e.clientY;this._deltaJoystickVector=this._joystickPointerPos.clone(),this._deltaJoystickVector=this._deltaJoystickVector.subtract(this._joystickPointerStartPos),0<Vo._AlwaysVisibleSticks&&(this._leftJoystick?this._joystickPointerPos.x=Math.min(Vo._HalfWidth,this._joystickPointerPos.x):this._joystickPointerPos.x=Math.max(Vo._HalfWidth,this._joystickPointerPos.x));const t=(this.reverseLeftRight?-1:1)*this._deltaJoystickVector.x/this._inversedSensibility;switch(this._axisTargetedByLeftAndRight){case uo.X:this.deltaPosition.x=Math.min(1,Math.max(-1,t));break;case uo.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,t));break;case uo.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,t))}const i=(this.reverseUpDown?1:-1)*this._deltaJoystickVector.y/this._inversedSensibility;switch(this._axisTargetedByUpAndDown){case uo.X:this.deltaPosition.x=Math.min(1,Math.max(-1,i));break;case uo.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,i));break;case uo.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,i))}}else{const t=this._touches.get(e.pointerId.toString());t&&(t.x=e.clientX,t.y=e.clientY)}}_onPointerUp(e){if(this._joystickPointerId==e.pointerId)this._clearPreviousDraw(),this._joystickPointerId=-1,this.pressed=!1;else{const t=this._touches.get(e.pointerId.toString());t&&Vo._VJCanvasContext.clearRect(t.prevX-44,t.prevY-44,88,88)}this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this._touches.remove(e.pointerId.toString())}setJoystickColor(e){this._joystickColor=e}set containerSize(e){this._joystickContainerSize=e,this._clearContainerSize=~~(2.1*this._joystickContainerSize),this._clearContainerSizeOffset=~~(this._clearContainerSize/2)}get containerSize(){return this._joystickContainerSize}set puckSize(e){this._joystickPuckSize=e,this._clearPuckSize=~~(2.1*this._joystickPuckSize),this._clearPuckSizeOffset=~~(this._clearPuckSize/2)}get puckSize(){return this._joystickPuckSize}clearPosition(){this.alwaysVisible=!1,this._joystickPosition=null}set alwaysVisible(e){this._alwaysVisible!==e&&(e&&this._joystickPosition?(Vo._AlwaysVisibleSticks++,this._alwaysVisible=!0):(Vo._AlwaysVisibleSticks--,this._alwaysVisible=!1))}get alwaysVisible(){return this._alwaysVisible}setPosition(e,t){this._joystickPointerStartPos&&this._clearPreviousDraw(),this._joystickPosition=new E(e,t)}setActionOnTouch(e){this._action=e}setAxisForLeftRight(e){switch(e){case uo.X:case uo.Y:case uo.Z:this._axisTargetedByLeftAndRight=e;break;default:this._axisTargetedByLeftAndRight=uo.X}}setAxisForUpDown(e){switch(e){case uo.X:case uo.Y:case uo.Z:this._axisTargetedByUpAndDown=e;break;default:this._axisTargetedByUpAndDown=uo.Y}}_clearPreviousDraw(){const e=this._joystickPosition||this._joystickPointerStartPos;Vo._VJCanvasContext.clearRect(e.x-this._clearContainerSizeOffset,e.y-this._clearContainerSizeOffset,this._clearContainerSize,this._clearContainerSize),Vo._VJCanvasContext.clearRect(this._joystickPreviousPointerPos.x-this._clearPuckSizeOffset-1,this._joystickPreviousPointerPos.y-this._clearPuckSizeOffset-1,this._clearPuckSize+2,this._clearPuckSize+2)}setContainerImage(e){const t=new Image;t.src=e,t.onload=()=>this._containerImage=t}setPuckImage(e){const t=new Image;t.src=e,t.onload=()=>this._puckImage=t}_drawContainer(){const e=this._joystickPosition||this._joystickPointerStartPos;this._clearPreviousDraw(),this._containerImage?Vo._VJCanvasContext.drawImage(this._containerImage,e.x-this.containerSize,e.y-this.containerSize,2*this.containerSize,2*this.containerSize):(Vo._VJCanvasContext.beginPath(),Vo._VJCanvasContext.strokeStyle=this._joystickColor,Vo._VJCanvasContext.lineWidth=2,Vo._VJCanvasContext.arc(e.x,e.y,this.containerSize,0,2*Math.PI,!0),Vo._VJCanvasContext.stroke(),Vo._VJCanvasContext.closePath(),Vo._VJCanvasContext.beginPath(),Vo._VJCanvasContext.lineWidth=6,Vo._VJCanvasContext.strokeStyle=this._joystickColor,Vo._VJCanvasContext.arc(e.x,e.y,this.puckSize,0,2*Math.PI,!0),Vo._VJCanvasContext.stroke(),Vo._VJCanvasContext.closePath())}_drawPuck(){this._puckImage?Vo._VJCanvasContext.drawImage(this._puckImage,this._joystickPointerPos.x-this.puckSize,this._joystickPointerPos.y-this.puckSize,2*this.puckSize,2*this.puckSize):(Vo._VJCanvasContext.beginPath(),Vo._VJCanvasContext.strokeStyle=this._joystickColor,Vo._VJCanvasContext.lineWidth=2,Vo._VJCanvasContext.arc(this._joystickPointerPos.x,this._joystickPointerPos.y,this.puckSize,0,2*Math.PI,!0),Vo._VJCanvasContext.stroke(),Vo._VJCanvasContext.closePath())}_drawVirtualJoystick(){this._released||(this.alwaysVisible&&this._drawContainer(),this.pressed&&this._touches.forEach(((e,t)=>{t.pointerId===this._joystickPointerId?(this.alwaysVisible||this._drawContainer(),this._drawPuck(),this._joystickPreviousPointerPos=this._joystickPointerPos.clone()):(Vo._VJCanvasContext.clearRect(t.prevX-44,t.prevY-44,88,88),Vo._VJCanvasContext.beginPath(),Vo._VJCanvasContext.fillStyle="white",Vo._VJCanvasContext.beginPath(),Vo._VJCanvasContext.strokeStyle="red",Vo._VJCanvasContext.lineWidth=6,Vo._VJCanvasContext.arc(t.x,t.y,40,0,2*Math.PI,!0),Vo._VJCanvasContext.stroke(),Vo._VJCanvasContext.closePath(),t.prevX=t.x,t.prevY=t.y)})),requestAnimationFrame((()=>{this._drawVirtualJoystick()})))}releaseCanvas(){Vo.Canvas&&(Vo.Canvas.removeEventListener("pointerdown",this._onPointerDownHandlerRef),Vo.Canvas.removeEventListener("pointermove",this._onPointerMoveHandlerRef),Vo.Canvas.removeEventListener("pointerup",this._onPointerUpHandlerRef),Vo.Canvas.removeEventListener("pointerout",this._onPointerUpHandlerRef),window.removeEventListener("resize",this._onResize),document.body.removeChild(Vo.Canvas),Vo.Canvas=null),this._released=!0}}Vo._GlobalJoystickIndex=0,Vo._AlwaysVisibleSticks=0,Lo.prototype.addVirtualJoystick=function(){return this.add(new ko),this};class ko{getLeftJoystick(){return this._leftjoystick}getRightJoystick(){return this._rightjoystick}checkInputs(){if(this._leftjoystick){const e=this.camera,t=50*e._computeLocalCameraSpeed(),i=y.RotationYawPitchRoll(e.rotation.y,e.rotation.x,0),s=S.TransformCoordinates(new S(this._leftjoystick.deltaPosition.x*t,this._leftjoystick.deltaPosition.y*t,this._leftjoystick.deltaPosition.z*t),i);e.cameraDirection=e.cameraDirection.add(s),e.cameraRotation=e.cameraRotation.addVector3(this._rightjoystick.deltaPosition),this._leftjoystick.pressed||(this._leftjoystick.deltaPosition=this._leftjoystick.deltaPosition.scale(.9)),this._rightjoystick.pressed||(this._rightjoystick.deltaPosition=this._rightjoystick.deltaPosition.scale(.9))}}attachControl(){this._leftjoystick=new Vo(!0),this._leftjoystick.setAxisForUpDown(uo.Z),this._leftjoystick.setAxisForLeftRight(uo.X),this._leftjoystick.setJoystickSensibility(.15),this._rightjoystick=new Vo(!1),this._rightjoystick.setAxisForUpDown(uo.X),this._rightjoystick.setAxisForLeftRight(uo.Y),this._rightjoystick.reverseUpDown=!0,this._rightjoystick.setJoystickSensibility(.05),this._rightjoystick.setJoystickColor("yellow")}detachControl(){this._leftjoystick.releaseCanvas(),this._rightjoystick.releaseCanvas()}getClassName(){return"FreeCameraVirtualJoystickInput"}getSimpleName(){return"virtualJoystick"}}go.FreeCameraVirtualJoystickInput=ko;class Go extends ps{constructor(e,t,i,s=!0){super(e,t,i,s),this._tmpUpVector=S.Zero(),this._tmpTargetVector=S.Zero(),this.cameraDirection=new S(0,0,0),this.cameraRotation=new E(0,0),this.ignoreParentScaling=!1,this.updateUpVectorFromRotation=!1,this._tmpQuaternion=new C,this.rotation=new S(0,0,0),this.speed=2,this.noRotationConstraint=!1,this.invertRotation=!1,this.inverseRotationSpeed=.2,this.lockedTarget=null,this._currentTarget=S.Zero(),this._initialFocalDistance=1,this._viewMatrix=y.Zero(),this._camMatrix=y.Zero(),this._cameraTransformMatrix=y.Zero(),this._cameraRotationMatrix=y.Zero(),this._referencePoint=new S(0,0,1),this._transformedReferencePoint=S.Zero(),this._deferredPositionUpdate=new S,this._deferredRotationQuaternionUpdate=new C,this._deferredRotationUpdate=new S,this._deferredUpdated=!1,this._deferOnly=!1,this._defaultUp=S.Up(),this._cachedRotationZ=0,this._cachedQuaternionRotationZ=0}getFrontPosition(e){this.getWorldMatrix();const t=this.getTarget().subtract(this.position);return t.normalize(),t.scaleInPlace(e),this.globalPosition.add(t)}_getLockedTargetPosition(){if(!this.lockedTarget)return null;if(this.lockedTarget.absolutePosition){const e=this.lockedTarget;e.computeWorldMatrix().getTranslationToRef(e.absolutePosition)}return this.lockedTarget.absolutePosition||this.lockedTarget}storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),super.storeState()}_restoreStateValues(){return!!super._restoreStateValues()&&(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0)}_initCache(){super._initCache(),this._cache.lockedTarget=new S(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new S(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new C(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}_updateCache(e){e||super._updateCache();const t=this._getLockedTargetPosition();t?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(t):this._cache.lockedTarget=t.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}_isSynchronizedViewMatrix(){if(!super._isSynchronizedViewMatrix())return!1;const e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))}_computeLocalCameraSpeed(){const e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(100*e.getFps()))}setTarget(e){this.upVector.normalize(),this._initialFocalDistance=e.subtract(this.position).length(),this.position.z===e.z&&(this.position.z+=u),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),y.LookAtLHToRef(this.position,e,this._defaultUp,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);const t=e.subtract(this.position);t.x>=0?this.rotation.y=-Math.atan(t.z/t.x)+Math.PI/2:this.rotation.y=-Math.atan(t.z/t.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&C.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}get target(){return this.getTarget()}set target(e){this.setTarget(e)}getTarget(){return this._currentTarget}_decideIfNeedsToMove(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){if(this.parent)return this.parent.getWorldMatrix().invertToRef(R.Matrix[0]),S.TransformNormalToRef(this.cameraDirection,R.Matrix[0],R.Vector3[0]),this._deferredPositionUpdate.addInPlace(R.Vector3[0]),void(this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate));this._deferredPositionUpdate.addInPlace(this.cameraDirection),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate)}_checkInputs(){const e=this.invertRotation?-this.inverseRotationSpeed:1,t=this._decideIfNeedsToMove(),i=this.cameraRotation.x||this.cameraRotation.y;if(this._deferredUpdated=!1,this._deferredRotationUpdate.copyFrom(this.rotation),this._deferredPositionUpdate.copyFrom(this.position),this.rotationQuaternion&&this._deferredRotationQuaternionUpdate.copyFrom(this.rotationQuaternion),t&&this._updatePosition(),i){if(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this._deferredRotationUpdate),this._deferredRotationUpdate.x+=this.cameraRotation.x*e,this._deferredRotationUpdate.y+=this.cameraRotation.y*e,!this.noRotationConstraint){const e=1.570796;this._deferredRotationUpdate.x>e&&(this._deferredRotationUpdate.x=e),this._deferredRotationUpdate.x<-e&&(this._deferredRotationUpdate.x=-e)}this._deferOnly?this._deferredUpdated=!0:this.rotation.copyFrom(this._deferredRotationUpdate),this.rotationQuaternion&&this._deferredRotationUpdate.lengthSquared()&&(C.RotationYawPitchRollToRef(this._deferredRotationUpdate.y,this._deferredRotationUpdate.x,this._deferredRotationUpdate.z,this._deferredRotationQuaternionUpdate),this._deferOnly?this._deferredUpdated=!0:this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate))}t&&(Math.abs(this.cameraDirection.x)<this.speed*u&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*u&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*u&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),i&&(Math.abs(this.cameraRotation.x)<this.speed*u&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*u&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),super._checkInputs()}_updateCameraRotationMatrix(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):y.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}_rotateUpVectorWithCameraRotationMatrix(){return S.TransformNormalToRef(this._defaultUp,this._cameraRotationMatrix,this.upVector),this}_getViewMatrix(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),S.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?ji.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(C.FromEulerVectorToRef(this.rotation,this._tmpQuaternion),ji.Y.rotateByQuaternionToRef(this._tmpQuaternion,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix}_computeViewMatrix(e,t,i){if(this.ignoreParentScaling){if(this.parent){const s=this.parent.getWorldMatrix();S.TransformCoordinatesToRef(e,s,this._globalPosition),S.TransformCoordinatesToRef(t,s,this._tmpTargetVector),S.TransformNormalToRef(i,s,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e),this._tmpTargetVector.copyFrom(t),this._tmpUpVector.copyFrom(i);this.getScene().useRightHandedSystem?y.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):y.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix)}else if(this.getScene().useRightHandedSystem?y.LookAtRHToRef(e,t,i,this._viewMatrix):y.LookAtLHToRef(e,t,i,this._viewMatrix),this.parent){const e=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(e,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e)}createRigCamera(e,t){if(this.cameraRigMode!==ps.RIG_MODE_NONE){const t=new Go(e,this.position.clone(),this.getScene());return t.isRigCamera=!0,t.rigParent=this,this.cameraRigMode===ps.RIG_MODE_VR&&(this.rotationQuaternion||(this.rotationQuaternion=new C),t._cameraRigParams={},t.rotationQuaternion=new C),t.mode=this.mode,t.orthoLeft=this.orthoLeft,t.orthoRight=this.orthoRight,t.orthoTop=this.orthoTop,t.orthoBottom=this.orthoBottom,t}return null}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case ps.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case ps.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case ps.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case ps.RIG_MODE_STEREOSCOPIC_OVERUNDER:case ps.RIG_MODE_STEREOSCOPIC_INTERLACED:{const i=this.cameraRigMode===ps.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,s=this.cameraRigMode===ps.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*i,e),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*s,t);break}case ps.RIG_MODE_VR:e.rotationQuaternion?(e.rotationQuaternion.copyFrom(this.rotationQuaternion),t.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.rotation.copyFrom(this.rotation),t.rotation.copyFrom(this.rotation)),e.position.copyFrom(this.position),t.position.copyFrom(this.position)}super._updateRigCameras()}_getRigCamPositionAndTarget(e,t){this.getTarget().subtractToRef(this.position,Go._TargetFocalPoint),Go._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);const i=Go._TargetFocalPoint.addInPlace(this.position);y.TranslationToRef(-i.x,-i.y,-i.z,Go._TargetTransformMatrix),Go._TargetTransformMatrix.multiplyToRef(y.RotationAxis(t.upVector,e),Go._RigCamTransformMatrix),y.TranslationToRef(i.x,i.y,i.z,Go._TargetTransformMatrix),Go._RigCamTransformMatrix.multiplyToRef(Go._TargetTransformMatrix,Go._RigCamTransformMatrix),S.TransformCoordinatesToRef(this.position,Go._RigCamTransformMatrix,t.position),t.setTarget(i)}getClassName(){return"TargetCamera"}}Go._RigCamTransformMatrix=new y,Go._TargetTransformMatrix=new y,Go._TargetFocalPoint=new S,me([ae()],Go.prototype,"rotation",void 0),me([ie()],Go.prototype,"speed",void 0),me([le("lockedTargetId")],Go.prototype,"lockedTarget",void 0);class zo extends Go{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysUpward(){const e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){const t=this.inputs.attached.keyboard;t&&(t.keysUpward=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysDownward(){const e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){const t=this.inputs.attached.keyboard;t&&(t.keysDownward=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get keysRotateLeft(){const e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e)}get keysRotateRight(){const e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e)}get keysRotateUp(){const e=this.inputs.attached.keyboard;return e?e.keysRotateUp:[]}set keysRotateUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateUp=e)}get keysRotateDown(){const e=this.inputs.attached.keyboard;return e?e.keysRotateDown:[]}set keysRotateDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateDown=e)}constructor(e,t,i,s=!0){super(e,t,i,s),this.ellipsoid=new S(.5,1,.5),this.ellipsoidOffset=new S(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this._needMoveForGravity=!1,this._oldPosition=S.Zero(),this._diffPosition=S.Zero(),this._newPosition=S.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(e,t,i=null)=>{this._newPosition.copyFrom(t),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>Ns.CollisionsEpsilon&&(this.position.addToRef(this._diffPosition,this._deferredPositionUpdate),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate),this.onCollide&&i&&this.onCollide(i))},this.inputs=new Lo(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=Ht.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new S(0,0,0),this.cameraRotation=new E(0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;t=this.parent?S.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let s=e;this.applyGravity&&(s=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,s,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=S.Zero(),this._transformedDirection=S.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}}me([ae()],zo.prototype,"ellipsoid",void 0),me([ae()],zo.prototype,"ellipsoidOffset",void 0),me([ie()],zo.prototype,"checkCollisions",void 0),me([ie()],zo.prototype,"applyGravity",void 0),ve.AddNodeConstructor("TouchCamera",((e,t)=>()=>new Wo(e,S.Zero(),t)));class Wo extends zo{get touchAngularSensibility(){const e=this.inputs.attached.touch;return e?e.touchAngularSensibility:0}set touchAngularSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchAngularSensibility=e)}get touchMoveSensibility(){const e=this.inputs.attached.touch;return e?e.touchMoveSensibility:0}set touchMoveSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addTouch(),this._setupInputs()}getClassName(){return"TouchCamera"}_setupInputs(){const e=this.inputs.attached.touch,t=this.inputs.attached.mouse;t?t.touchEnabled=!1:e.allowMouse=!0}}ve.AddNodeConstructor("ArcRotateCamera",((e,t)=>()=>new Ho(e,0,0,1,S.Zero(),t)));class Ho extends Go{get target(){return this._target}set target(e){this.setTarget(e)}get targetHost(){return this._targetHost}set targetHost(e){e&&this.setTarget(e)}getTarget(){return this.target}get position(){return this._position}set position(e){this.setPosition(e)}set upVector(e){this._upToYMatrix||(this._yToUpMatrix=new y,this._upToYMatrix=new y,this._upVector=S.Zero()),e.normalize(),this._upVector.copyFrom(e),this.setMatUp()}get upVector(){return this._upVector}setMatUp(){y.RotationAlignToRef(S.UpReadOnly,this._upVector,this._yToUpMatrix),y.RotationAlignToRef(this._upVector,S.UpReadOnly,this._upToYMatrix)}get angularSensibilityX(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityX:0}set angularSensibilityX(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityX=e)}get angularSensibilityY(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityY:0}set angularSensibilityY(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityY=e)}get pinchPrecision(){const e=this.inputs.attached.pointers;return e?e.pinchPrecision:0}set pinchPrecision(e){const t=this.inputs.attached.pointers;t&&(t.pinchPrecision=e)}get pinchDeltaPercentage(){const e=this.inputs.attached.pointers;return e?e.pinchDeltaPercentage:0}set pinchDeltaPercentage(e){const t=this.inputs.attached.pointers;t&&(t.pinchDeltaPercentage=e)}get useNaturalPinchZoom(){const e=this.inputs.attached.pointers;return!!e&&e.useNaturalPinchZoom}set useNaturalPinchZoom(e){const t=this.inputs.attached.pointers;t&&(t.useNaturalPinchZoom=e)}get panningSensibility(){const e=this.inputs.attached.pointers;return e?e.panningSensibility:0}set panningSensibility(e){const t=this.inputs.attached.pointers;t&&(t.panningSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get wheelPrecision(){const e=this.inputs.attached.mousewheel;return e?e.wheelPrecision:0}set wheelPrecision(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelPrecision=e)}get zoomToMouseLocation(){const e=this.inputs.attached.mousewheel;return!!e&&e.zoomToMouseLocation}set zoomToMouseLocation(e){const t=this.inputs.attached.mousewheel;t&&(t.zoomToMouseLocation=e)}get wheelDeltaPercentage(){const e=this.inputs.attached.mousewheel;return e?e.wheelDeltaPercentage:0}set wheelDeltaPercentage(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelDeltaPercentage=e)}get bouncingBehavior(){return this._bouncingBehavior}get useBouncingBehavior(){return null!=this._bouncingBehavior}set useBouncingBehavior(e){e!==this.useBouncingBehavior&&(e?(this._bouncingBehavior=new Dr,this.addBehavior(this._bouncingBehavior)):this._bouncingBehavior&&(this.removeBehavior(this._bouncingBehavior),this._bouncingBehavior=null))}get framingBehavior(){return this._framingBehavior}get useFramingBehavior(){return null!=this._framingBehavior}set useFramingBehavior(e){e!==this.useFramingBehavior&&(e?(this._framingBehavior=new Nr,this.addBehavior(this._framingBehavior)):this._framingBehavior&&(this.removeBehavior(this._framingBehavior),this._framingBehavior=null))}get autoRotationBehavior(){return this._autoRotationBehavior}get useAutoRotationBehavior(){return null!=this._autoRotationBehavior}set useAutoRotationBehavior(e){e!==this.useAutoRotationBehavior&&(e?(this._autoRotationBehavior=new Or,this.addBehavior(this._autoRotationBehavior)):this._autoRotationBehavior&&(this.removeBehavior(this._autoRotationBehavior),this._autoRotationBehavior=null))}constructor(e,t,i,s,r,n,o=!0){super(e,S.Zero(),n,o),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI-.01,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.inertialPanningX=0,this.inertialPanningY=0,this.pinchToPanMaxDistance=20,this.panningDistanceLimit=null,this.panningOriginTarget=S.Zero(),this.panningInertia=.9,this.zoomOnFactor=1,this.targetScreenOffset=E.Zero(),this.allowUpsideDown=!0,this.useInputToRestoreState=!0,this._viewMatrix=new y,this.panningAxis=new S(1,1,0),this._transformedDirection=new S,this.mapPanning=!1,this.onMeshTargetChangedObservable=new a,this.checkCollisions=!1,this.collisionRadius=new S(.5,.5,.5),this._previousPosition=S.Zero(),this._collisionVelocity=S.Zero(),this._newPosition=S.Zero(),this._computationVector=S.Zero(),this._onCollisionPositionChange=(e,t,i=null)=>{i?(this.setPosition(t),this.onCollide&&this.onCollide(i)):this._previousPosition.copyFrom(this._position);const s=Math.cos(this.alpha),r=Math.sin(this.alpha),n=Math.cos(this.beta);let o=Math.sin(this.beta);0===o&&(o=1e-4);const a=this._getTargetPosition();this._computationVector.copyFromFloats(this.radius*s*o,this.radius*n,this.radius*r*o),a.addToRef(this._computationVector,this._newPosition),this._position.copyFrom(this._newPosition);let l=this.upVector;this.allowUpsideDown&&this.beta<0&&(l=l.clone(),l=l.negate()),this._computeViewMatrix(this._position,a,l),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y),this._collisionTriggered=!1},this._target=S.Zero(),r&&this.setTarget(r),this.alpha=t,this.beta=i,this.radius=s,this.getViewMatrix(),this.inputs=new yo(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_initCache(){super._initCache(),this._cache._target=new S(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0,this._cache.targetScreenOffset=E.Zero()}_updateCache(e){e||super._updateCache(),this._cache._target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius,this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)}_getTargetPosition(){if(this._targetHost&&this._targetHost.getAbsolutePosition){const e=this._targetHost.getAbsolutePosition();this._targetBoundingCenter?e.addToRef(this._targetBoundingCenter,this._target):this._target.copyFrom(e)}return this._getLockedTargetPosition()||this._target}storeState(){return this._storedAlpha=this.alpha,this._storedBeta=this.beta,this._storedRadius=this.radius,this._storedTarget=this._getTargetPosition().clone(),this._storedTargetScreenOffset=this.targetScreenOffset.clone(),super.storeState()}_restoreStateValues(){return!!super._restoreStateValues()&&(this.setTarget(this._storedTarget.clone()),this.alpha=this._storedAlpha,this.beta=this._storedBeta,this.radius=this._storedRadius,this.targetScreenOffset=this._storedTargetScreenOffset.clone(),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0)}_isSynchronizedViewMatrix(){return!!super._isSynchronizedViewMatrix()&&this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset)}attachControl(e,t,i=!0,s=2){const r=arguments;t=Ht.BackCompatCameraNoPreventDefault(r),this._useCtrlForPanning=i,this._panningMouseButton=s,"boolean"==typeof r[0]&&(r.length>1&&(this._useCtrlForPanning=r[1]),r.length>2&&(this._panningMouseButton=r[2])),this.inputs.attachElement(t),this._reset=()=>{this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){if(!this._collisionTriggered){if(this.inputs.checkInputs(),0!==this.inertialAlphaOffset||0!==this.inertialBetaOffset||0!==this.inertialRadiusOffset){const e=this.invertRotation?-1:1,t=this._calculateHandednessMultiplier();let i=this.inertialAlphaOffset*t;this.beta<=0&&(i*=-1),this.alpha+=i*e,this.beta+=this.inertialBetaOffset*e,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<u&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<u&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<this.speed*u&&(this.inertialRadiusOffset=0)}if(0!==this.inertialPanningX||0!==this.inertialPanningY){const e=new S(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);if(this._viewMatrix.invertToRef(this._cameraTransformMatrix),e.multiplyInPlace(this.panningAxis),S.TransformNormalToRef(e,this._cameraTransformMatrix,this._transformedDirection),this.mapPanning){const e=this.upVector,t=S.CrossToRef(this._transformedDirection,e,this._transformedDirection);S.CrossToRef(e,t,this._transformedDirection)}else this.panningAxis.y||(this._transformedDirection.y=0);this._targetHost||(this.panningDistanceLimit?(this._transformedDirection.addInPlace(this._target),S.DistanceSquared(this._transformedDirection,this.panningOriginTarget)<=this.panningDistanceLimit*this.panningDistanceLimit&&this._target.copyFrom(this._transformedDirection)):this._target.addInPlace(this._transformedDirection)),this.inertialPanningX*=this.panningInertia,this.inertialPanningY*=this.panningInertia,Math.abs(this.inertialPanningX)<this.speed*u&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<this.speed*u&&(this.inertialPanningY=0)}this._checkLimits(),super._checkInputs()}}_checkLimits(){null===this.lowerBetaLimit||void 0===this.lowerBetaLimit?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),null===this.upperBetaLimit||void 0===this.upperBetaLimit?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),null!==this.lowerAlphaLimit&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),null!==this.upperAlphaLimit&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),null!==this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit,this.inertialRadiusOffset=0),null!==this.upperRadiusLimit&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit,this.inertialRadiusOffset=0)}rebuildAnglesAndRadius(){this._position.subtractToRef(this._getTargetPosition(),this._computationVector),0===this._upVector.x&&1===this._upVector.y&&0===this._upVector.z||S.TransformCoordinatesToRef(this._computationVector,this._upToYMatrix,this._computationVector),this.radius=this._computationVector.length(),0===this.radius&&(this.radius=1e-4);const e=this.alpha;0===this._computationVector.x&&0===this._computationVector.z?this.alpha=Math.PI/2:this.alpha=Math.acos(this._computationVector.x/Math.sqrt(Math.pow(this._computationVector.x,2)+Math.pow(this._computationVector.z,2))),this._computationVector.z<0&&(this.alpha=2*Math.PI-this.alpha);const t=Math.round((e-this.alpha)/(2*Math.PI));this.alpha+=2*t*Math.PI,this.beta=Math.acos(this._computationVector.y/this.radius),this._checkLimits()}setPosition(e){this._position.equals(e)||(this._position.copyFrom(e),this.rebuildAnglesAndRadius())}setTarget(e,t=!1,i=!1,s=!1){var r;if(s=null!==(r=this.overrideCloneAlphaBetaRadius)&&void 0!==r?r:s,e.getBoundingInfo)this._targetBoundingCenter=t?e.getBoundingInfo().boundingBox.centerWorld.clone():null,e.computeWorldMatrix(),this._targetHost=e,this._target=this._getTargetPosition(),this.onMeshTargetChangedObservable.notifyObservers(this._targetHost);else{const t=e,s=this._getTargetPosition();if(s&&!i&&s.equals(t))return;this._targetHost=null,this._target=t,this._targetBoundingCenter=null,this.onMeshTargetChangedObservable.notifyObservers(null)}s||this.rebuildAnglesAndRadius()}_getViewMatrix(){const e=Math.cos(this.alpha),t=Math.sin(this.alpha),i=Math.cos(this.beta);let s=Math.sin(this.beta);0===s&&(s=1e-4),0===this.radius&&(this.radius=1e-4);const r=this._getTargetPosition();if(this._computationVector.copyFromFloats(this.radius*e*s,this.radius*i,this.radius*t*s),0===this._upVector.x&&1===this._upVector.y&&0===this._upVector.z||S.TransformCoordinatesToRef(this._computationVector,this._yToUpMatrix,this._computationVector),r.addToRef(this._computationVector,this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions){const e=this.getScene().collisionCoordinator;this._collider||(this._collider=e.createCollider()),this._collider._radius=this.collisionRadius,this._newPosition.subtractToRef(this._position,this._collisionVelocity),this._collisionTriggered=!0,e.getNewPosition(this._position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}else{this._position.copyFrom(this._newPosition);let e=this.upVector;this.allowUpsideDown&&s<0&&(e=e.negate()),this._computeViewMatrix(this._position,r,e),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y)}return this._currentTarget=r,this._viewMatrix}zoomOn(e,t=!1){e=e||this.getScene().meshes;const i=ur.MinMax(e);let s=this._calculateLowerRadiusFromModelBoundingSphere(i.min,i.max);s=Math.max(Math.min(s,this.upperRadiusLimit||Number.MAX_VALUE),this.lowerRadiusLimit||0),this.radius=s*this.zoomOnFactor,this.focusOn({min:i.min,max:i.max,distance:s},t)}focusOn(e,t=!1){let i,s;if(void 0===e.min){const t=e||this.getScene().meshes;i=ur.MinMax(t),s=S.Distance(i.min,i.max)}else i=e,s=e.distance;this._target=ur.Center(i),t||(this.maxZ=2*s)}createRigCamera(e,t){let i=0;switch(this.cameraRigMode){case ps.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case ps.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case ps.RIG_MODE_STEREOSCOPIC_OVERUNDER:case ps.RIG_MODE_STEREOSCOPIC_INTERLACED:case ps.RIG_MODE_VR:i=this._cameraRigParams.stereoHalfAngle*(0===t?1:-1);break;case ps.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:i=this._cameraRigParams.stereoHalfAngle*(0===t?-1:1)}const s=new Ho(e,this.alpha+i,this.beta,this.radius,this._target,this.getScene());return s._cameraRigParams={},s.isRigCamera=!0,s.rigParent=this,s.upVector=this.upVector,s.mode=this.mode,s.orthoLeft=this.orthoLeft,s.orthoRight=this.orthoRight,s.orthoBottom=this.orthoBottom,s.orthoTop=this.orthoTop,s}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(e.beta=t.beta=this.beta,this.cameraRigMode){case ps.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case ps.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case ps.RIG_MODE_STEREOSCOPIC_OVERUNDER:case ps.RIG_MODE_STEREOSCOPIC_INTERLACED:case ps.RIG_MODE_VR:e.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case ps.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:e.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle}super._updateRigCameras()}_calculateLowerRadiusFromModelBoundingSphere(e,t,i=1){const s=S.Distance(e,t),r=this.getScene().getEngine().getAspectRatio(this),n=Math.tan(this.fov/2),o=n*r,a=.5*s*i,l=a*Math.sqrt(1+1/(o*o)),h=a*Math.sqrt(1+1/(n*n));return Math.max(l,h)}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"ArcRotateCamera"}}me([ie()],Ho.prototype,"alpha",void 0),me([ie()],Ho.prototype,"beta",void 0),me([ie()],Ho.prototype,"radius",void 0),me([ie()],Ho.prototype,"overrideCloneAlphaBetaRadius",void 0),me([ae("target")],Ho.prototype,"_target",void 0),me([le("targetHost")],Ho.prototype,"_targetHost",void 0),me([ie()],Ho.prototype,"inertialAlphaOffset",void 0),me([ie()],Ho.prototype,"inertialBetaOffset",void 0),me([ie()],Ho.prototype,"inertialRadiusOffset",void 0),me([ie()],Ho.prototype,"lowerAlphaLimit",void 0),me([ie()],Ho.prototype,"upperAlphaLimit",void 0),me([ie()],Ho.prototype,"lowerBetaLimit",void 0),me([ie()],Ho.prototype,"upperBetaLimit",void 0),me([ie()],Ho.prototype,"lowerRadiusLimit",void 0),me([ie()],Ho.prototype,"upperRadiusLimit",void 0),me([ie()],Ho.prototype,"inertialPanningX",void 0),me([ie()],Ho.prototype,"inertialPanningY",void 0),me([ie()],Ho.prototype,"pinchToPanMaxDistance",void 0),me([ie()],Ho.prototype,"panningDistanceLimit",void 0),me([ae()],Ho.prototype,"panningOriginTarget",void 0),me([ie()],Ho.prototype,"panningInertia",void 0),me([ie()],Ho.prototype,"zoomToMouseLocation",null),me([ie()],Ho.prototype,"zoomOnFactor",void 0),me([oe()],Ho.prototype,"targetScreenOffset",void 0),me([ie()],Ho.prototype,"allowUpsideDown",void 0),me([ie()],Ho.prototype,"useInputToRestoreState",void 0),ve.AddNodeConstructor("DeviceOrientationCamera",((e,t)=>()=>new Xo(e,S.Zero(),t)));class Xo extends zo{constructor(e,t,i){super(e,t,i),this._tmpDragQuaternion=new C,this._disablePointerInputWhenUsingDeviceOrientation=!0,this._dragFactor=0,this._quaternionCache=new C,this.inputs.addDeviceOrientation(),this.inputs._deviceOrientationInput&&this.inputs._deviceOrientationInput._onDeviceOrientationChangedObservable.addOnce((()=>{this._disablePointerInputWhenUsingDeviceOrientation&&this.inputs._mouseInput&&(this.inputs._mouseInput._allowCameraRotation=!1,this.inputs._mouseInput.onPointerMovedObservable.add((e=>{0!=this._dragFactor&&(this._initialQuaternion||(this._initialQuaternion=new C),C.FromEulerAnglesToRef(0,e.offsetX*this._dragFactor,0,this._tmpDragQuaternion),this._initialQuaternion.multiplyToRef(this._tmpDragQuaternion,this._initialQuaternion))})))}))}get disablePointerInputWhenUsingDeviceOrientation(){return this._disablePointerInputWhenUsingDeviceOrientation}set disablePointerInputWhenUsingDeviceOrientation(e){this._disablePointerInputWhenUsingDeviceOrientation=e}enableHorizontalDragging(e=1/300){this._dragFactor=e}getClassName(){return"DeviceOrientationCamera"}_checkInputs(){super._checkInputs(),this._quaternionCache.copyFrom(this.rotationQuaternion),this._initialQuaternion&&this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}resetToCurrentRotation(e=ji.Y){this.rotationQuaternion&&(this._initialQuaternion||(this._initialQuaternion=new C),this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion),["x","y","z"].forEach((t=>{e[t]?this._initialQuaternion[t]*=-1:this._initialQuaternion[t]=0})),this._initialQuaternion.normalize(),this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion))}}class Yo extends vo{constructor(e){super(e)}addKeyboard(){return this.add(new Ro),this}addMouse(){return this.add(new Io),this}}class jo extends Go{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysForward(){const e=this.inputs.attached.keyboard;return e?e.keysForward:[]}set keysForward(e){const t=this.inputs.attached.keyboard;t&&(t.keysForward=e)}get keysBackward(){const e=this.inputs.attached.keyboard;return e?e.keysBackward:[]}set keysBackward(e){const t=this.inputs.attached.keyboard;t&&(t.keysBackward=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}constructor(e,t,i,s=!0){super(e,t,i,s),this.ellipsoid=new S(1,1,1),this.ellipsoidOffset=new S(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this.cameraDirection=S.Zero(),this._trackRoll=0,this.rollCorrect=100,this.bankedTurn=!1,this.bankedTurnLimit=Math.PI/2,this.bankedTurnMultiplier=1,this._needMoveForGravity=!1,this._oldPosition=S.Zero(),this._diffPosition=S.Zero(),this._newPosition=S.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(e,t,i=null)=>{(e=>{this._newPosition.copyFrom(e),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>Ns.CollisionsEpsilon&&(this.position.addInPlace(this._diffPosition),this.onCollide&&i&&this.onCollide(i))})(t)},this.inputs=new Yo(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=Ht.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new S(0,0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;t=this.parent?S.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let s=e;this.applyGravity&&(s=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,s,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=S.Zero(),this._transformedDirection=S.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}restoreRoll(e){const t=this._trackRoll,i=t-this.rotation.z;Math.abs(i)>=.001&&(this.rotation.z+=i/e,Math.abs(t-this.rotation.z)<=.001&&(this.rotation.z=t))}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FlyCamera"}}me([ae()],jo.prototype,"ellipsoid",void 0),me([ae()],jo.prototype,"ellipsoidOffset",void 0),me([ie()],jo.prototype,"checkCollisions",void 0),me([ie()],jo.prototype,"applyGravity",void 0);class Ko extends vo{constructor(e){super(e)}addKeyboard(){return this.add(new Po),this}addMouseWheel(){return this.add(new Mo),this}addPointers(){return this.add(new Oo),this}addVRDeviceOrientation(){return console.warn("DeviceOrientation support not yet implemented for FollowCamera."),this}}ve.AddNodeConstructor("FollowCamera",((e,t)=>()=>new $o(e,S.Zero(),t))),ve.AddNodeConstructor("ArcFollowCamera",((e,t)=>()=>new qo(e,0,0,1,null,t)));class $o extends Go{constructor(e,t,i,s=null){super(e,t,i),this.radius=12,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.rotationOffset=0,this.lowerRotationOffsetLimit=null,this.upperRotationOffsetLimit=null,this.heightOffset=4,this.lowerHeightOffsetLimit=null,this.upperHeightOffsetLimit=null,this.cameraAcceleration=.05,this.maxCameraSpeed=20,this.lockedTarget=s,this.inputs=new Ko(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_follow(e){if(!e)return;const t=R.Matrix[0];e.absoluteRotationQuaternion.toRotationMatrix(t);const i=Math.atan2(t.m[8],t.m[10]),s=Ht.ToRadians(this.rotationOffset)+i,r=e.getAbsolutePosition(),n=r.x+Math.sin(s)*this.radius,o=r.z+Math.cos(s)*this.radius,a=n-this.position.x,l=r.y+this.heightOffset-this.position.y,h=o-this.position.z;let c=a*this.cameraAcceleration*2,u=l*this.cameraAcceleration,d=h*this.cameraAcceleration*2;(c>this.maxCameraSpeed||c<-this.maxCameraSpeed)&&(c=c<1?-this.maxCameraSpeed:this.maxCameraSpeed),(u>this.maxCameraSpeed||u<-this.maxCameraSpeed)&&(u=u<1?-this.maxCameraSpeed:this.maxCameraSpeed),(d>this.maxCameraSpeed||d<-this.maxCameraSpeed)&&(d=d<1?-this.maxCameraSpeed:this.maxCameraSpeed),this.position=new S(this.position.x+c,this.position.y+u,this.position.z+d),this.setTarget(r)}attachControl(e,t){t=Ht.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t),this._reset=()=>{}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){this.inputs.checkInputs(),this._checkLimits(),super._checkInputs(),this.lockedTarget&&this._follow(this.lockedTarget)}_checkLimits(){null!==this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit),null!==this.upperRadiusLimit&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit),null!==this.lowerHeightOffsetLimit&&this.heightOffset<this.lowerHeightOffsetLimit&&(this.heightOffset=this.lowerHeightOffsetLimit),null!==this.upperHeightOffsetLimit&&this.heightOffset>this.upperHeightOffsetLimit&&(this.heightOffset=this.upperHeightOffsetLimit),null!==this.lowerRotationOffsetLimit&&this.rotationOffset<this.lowerRotationOffsetLimit&&(this.rotationOffset=this.lowerRotationOffsetLimit),null!==this.upperRotationOffsetLimit&&this.rotationOffset>this.upperRotationOffsetLimit&&(this.rotationOffset=this.upperRotationOffsetLimit)}getClassName(){return"FollowCamera"}}me([ie()],$o.prototype,"radius",void 0),me([ie()],$o.prototype,"lowerRadiusLimit",void 0),me([ie()],$o.prototype,"upperRadiusLimit",void 0),me([ie()],$o.prototype,"rotationOffset",void 0),me([ie()],$o.prototype,"lowerRotationOffsetLimit",void 0),me([ie()],$o.prototype,"upperRotationOffsetLimit",void 0),me([ie()],$o.prototype,"heightOffset",void 0),me([ie()],$o.prototype,"lowerHeightOffsetLimit",void 0),me([ie()],$o.prototype,"upperHeightOffsetLimit",void 0),me([ie()],$o.prototype,"cameraAcceleration",void 0),me([ie()],$o.prototype,"maxCameraSpeed",void 0),me([le("lockedTargetId")],$o.prototype,"lockedTarget",void 0);class qo extends Go{constructor(e,t,i,s,r,n){super(e,S.Zero(),n),this.alpha=t,this.beta=i,this.radius=s,this._cartesianCoordinates=S.Zero(),this.setMeshTarget(r)}setMeshTarget(e){this._meshTarget=e,this._follow()}_follow(){if(!this._meshTarget)return;this._cartesianCoordinates.x=this.radius*Math.cos(this.alpha)*Math.cos(this.beta),this._cartesianCoordinates.y=this.radius*Math.sin(this.beta),this._cartesianCoordinates.z=this.radius*Math.sin(this.alpha)*Math.cos(this.beta);const e=this._meshTarget.getAbsolutePosition();this.position=e.add(this._cartesianCoordinates),this.setTarget(e)}_checkInputs(){super._checkInputs(),this._follow()}getClassName(){return"ArcFollowCamera"}}!function(e){e[e.A=0]="A",e[e.B=1]="B",e[e.X=2]="X",e[e.Y=3]="Y",e[e.LB=4]="LB",e[e.RB=5]="RB",e[e.Back=8]="Back",e[e.Start=9]="Start",e[e.LeftStick=10]="LeftStick",e[e.RightStick=11]="RightStick"}(po||(po={})),function(e){e[e.Up=12]="Up",e[e.Down=13]="Down",e[e.Left=14]="Left",e[e.Right=15]="Right"}(_o||(_o={}));class Qo extends xo{constructor(e,t,i,s=!1){super(e,t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new a,this.onButtonUpObservable=new a,this.onPadDownObservable=new a,this.onPadUpObservable=new a,this._buttonA=0,this._buttonB=0,this._buttonX=0,this._buttonY=0,this._buttonBack=0,this._buttonStart=0,this._buttonLB=0,this._buttonRB=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this._isXboxOnePad=!1,this.type=xo.XBOX,this._isXboxOnePad=s}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(1===e&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),0===e&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonA(){return this._buttonA}set buttonA(e){this._buttonA=this._setButtonValue(e,this._buttonA,po.A)}get buttonB(){return this._buttonB}set buttonB(e){this._buttonB=this._setButtonValue(e,this._buttonB,po.B)}get buttonX(){return this._buttonX}set buttonX(e){this._buttonX=this._setButtonValue(e,this._buttonX,po.X)}get buttonY(){return this._buttonY}set buttonY(e){this._buttonY=this._setButtonValue(e,this._buttonY,po.Y)}get buttonStart(){return this._buttonStart}set buttonStart(e){this._buttonStart=this._setButtonValue(e,this._buttonStart,po.Start)}get buttonBack(){return this._buttonBack}set buttonBack(e){this._buttonBack=this._setButtonValue(e,this._buttonBack,po.Back)}get buttonLB(){return this._buttonLB}set buttonLB(e){this._buttonLB=this._setButtonValue(e,this._buttonLB,po.LB)}get buttonRB(){return this._buttonRB}set buttonRB(e){this._buttonRB=this._setButtonValue(e,this._buttonRB,po.RB)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,po.LeftStick)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,po.RightStick)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,_o.Up)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,_o.Down)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,_o.Left)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,_o.Right)}update(){super.update(),this._isXboxOnePad,this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}!function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.Share=8]="Share",e[e.Options=9]="Options",e[e.LeftStick=10]="LeftStick",e[e.RightStick=11]="RightStick"}(fo||(fo={})),function(e){e[e.Up=12]="Up",e[e.Down=13]="Down",e[e.Left=14]="Left",e[e.Right=15]="Right"}(mo||(mo={}));class Zo extends xo{constructor(e,t,i){super(e.replace("STANDARD GAMEPAD","SONY PLAYSTATION DUALSHOCK"),t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new a,this.onButtonUpObservable=new a,this.onPadDownObservable=new a,this.onPadUpObservable=new a,this._buttonCross=0,this._buttonCircle=0,this._buttonSquare=0,this._buttonTriangle=0,this._buttonShare=0,this._buttonOptions=0,this._buttonL1=0,this._buttonR1=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this.type=xo.DUALSHOCK}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(1===e&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),0===e&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonCross(){return this._buttonCross}set buttonCross(e){this._buttonCross=this._setButtonValue(e,this._buttonCross,fo.Cross)}get buttonCircle(){return this._buttonCircle}set buttonCircle(e){this._buttonCircle=this._setButtonValue(e,this._buttonCircle,fo.Circle)}get buttonSquare(){return this._buttonSquare}set buttonSquare(e){this._buttonSquare=this._setButtonValue(e,this._buttonSquare,fo.Square)}get buttonTriangle(){return this._buttonTriangle}set buttonTriangle(e){this._buttonTriangle=this._setButtonValue(e,this._buttonTriangle,fo.Triangle)}get buttonOptions(){return this._buttonOptions}set buttonOptions(e){this._buttonOptions=this._setButtonValue(e,this._buttonOptions,fo.Options)}get buttonShare(){return this._buttonShare}set buttonShare(e){this._buttonShare=this._setButtonValue(e,this._buttonShare,fo.Share)}get buttonL1(){return this._buttonL1}set buttonL1(e){this._buttonL1=this._setButtonValue(e,this._buttonL1,fo.L1)}get buttonR1(){return this._buttonR1}set buttonR1(e){this._buttonR1=this._setButtonValue(e,this._buttonR1,fo.R1)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,fo.LeftStick)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,fo.RightStick)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,mo.Up)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,mo.Down)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,mo.Left)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,mo.Right)}update(){super.update(),this.buttonCross=this.browserGamepad.buttons[0].value,this.buttonCircle=this.browserGamepad.buttons[1].value,this.buttonSquare=this.browserGamepad.buttons[2].value,this.buttonTriangle=this.browserGamepad.buttons[3].value,this.buttonL1=this.browserGamepad.buttons[4].value,this.buttonR1=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonShare=this.browserGamepad.buttons[8].value,this.buttonOptions=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}class Jo{constructor(e){if(this._scene=e,this._babylonGamepads=[],this._oneGamepadConnected=!1,this._isMonitoring=!1,this.onGamepadDisconnectedObservable=new a,Me()?(this._gamepadEventSupported="GamepadEvent"in window,this._gamepadSupport=navigator&&navigator.getGamepads):this._gamepadEventSupported=!1,this.onGamepadConnectedObservable=new a((e=>{for(const t in this._babylonGamepads){const i=this._babylonGamepads[t];i&&i._isConnected&&this.onGamepadConnectedObservable.notifyObserver(e,i)}})),this._onGamepadConnectedEvent=e=>{const t=e.gamepad;if(t.index in this._babylonGamepads&&this._babylonGamepads[t.index].isConnected)return;let i;this._babylonGamepads[t.index]?(i=this._babylonGamepads[t.index],i.browserGamepad=t,i._isConnected=!0):i=this._addNewGamepad(t),this.onGamepadConnectedObservable.notifyObservers(i),this._startMonitoringGamepads()},this._onGamepadDisconnectedEvent=e=>{const t=e.gamepad;for(const e in this._babylonGamepads)if(this._babylonGamepads[e].index===t.index){const t=this._babylonGamepads[e];t._isConnected=!1,this.onGamepadDisconnectedObservable.notifyObservers(t),t.dispose&&t.dispose();break}},this._gamepadSupport)if(this._updateGamepadObjects(),this._babylonGamepads.length&&this._startMonitoringGamepads(),this._gamepadEventSupported){const e=this._scene?this._scene.getEngine().getHostWindow():window;e&&(e.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),e.addEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent,!1))}else this._startMonitoringGamepads()}get gamepads(){return this._babylonGamepads}getGamepadByType(e=xo.XBOX){for(const t of this._babylonGamepads)if(t&&t.type===e)return t;return null}dispose(){this._gamepadEventSupported&&(this._onGamepadConnectedEvent&&window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent),this._onGamepadDisconnectedEvent&&window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent),this._onGamepadConnectedEvent=null,this._onGamepadDisconnectedEvent=null),this._babylonGamepads.forEach((e=>{e.dispose()})),this.onGamepadConnectedObservable.clear(),this.onGamepadDisconnectedObservable.clear(),this._oneGamepadConnected=!1,this._stopMonitoringGamepads(),this._babylonGamepads=[]}_addNewGamepad(e){let t;this._oneGamepadConnected||(this._oneGamepadConnected=!0);const i=-1!==e.id.search("054c")&&-1===e.id.search("0ce6"),s=-1!==e.id.search("Xbox One");return t=s||-1!==e.id.search("Xbox 360")||-1!==e.id.search("xinput")||-1!==e.id.search("045e")&&-1===e.id.search("Surface Dock")?new Qo(e.id,e.index,e,s):i?new Zo(e.id,e.index,e):new To(e.id,e.index,e),this._babylonGamepads[t.index]=t,t}_startMonitoringGamepads(){this._isMonitoring||(this._isMonitoring=!0,this._checkGamepadsStatus())}_stopMonitoringGamepads(){this._isMonitoring=!1}_checkGamepadsStatus(){this._updateGamepadObjects();for(const e in this._babylonGamepads){const t=this._babylonGamepads[e];if(t&&t.isConnected)try{t.update()}catch(e){-1===this._loggedErrors.indexOf(t.index)&&(Ht.Warn(`Error updating gamepad ${t.id}`),this._loggedErrors.push(t.index))}}this._isMonitoring&&Ns.QueueNewFrame((()=>{this._checkGamepadsStatus()}))}_updateGamepadObjects(){const e=navigator.getGamepads?navigator.getGamepads():[];for(let t=0;t<e.length;t++){const i=e[t];if(i)if(this._babylonGamepads[i.index])this._babylonGamepads[t].browserGamepad=i,this._babylonGamepads[t].isConnected||(this._babylonGamepads[t]._isConnected=!0,this.onGamepadConnectedObservable.notifyObservers(this._babylonGamepads[t]));else{const e=this._addNewGamepad(i);this.onGamepadConnectedObservable.notifyObservers(e)}}}}Object.defineProperty(Yi.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new Jo(this);let e=this._getComponent(fi.NAME_GAMEPAD);e||(e=new ea(this),this._addComponent(e))}return this._gamepadManager},enumerable:!0,configurable:!0}),Lo.prototype.addGamepad=function(){return this.add(new Uo),this},yo.prototype.addGamepad=function(){return this.add(new Eo),this};class ea{constructor(e){this.name=fi.NAME_GAMEPAD,this.scene=e}register(){this.scene._beforeCameraUpdateStage.registerStep(fi.STEP_BEFORECAMERAUPDATE_GAMEPAD,this,this._beforeCameraUpdate)}rebuild(){}dispose(){const e=this.scene._gamepadManager;e&&(e.dispose(),this.scene._gamepadManager=null)}_beforeCameraUpdate(){const e=this.scene._gamepadManager;e&&e._isMonitoring&&e._checkGamepadsStatus()}}ve.AddNodeConstructor("FreeCamera",((e,t)=>()=>new ta(e,S.Zero(),t)));class ta extends Wo{get gamepadAngularSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadAngularSensibility:0}set gamepadAngularSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadAngularSensibility=e)}get gamepadMoveSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadMoveSensibility:0}set gamepadMoveSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addGamepad()}getClassName(){return"UniversalCamera"}}ps._CreateDefaultParsedCamera=(e,t)=>new ta(e,S.Zero(),t),ve.AddNodeConstructor("GamepadCamera",((e,t)=>()=>new ia(e,S.Zero(),t)));class ia extends ta{constructor(e,t,i){super(e,t,i)}getClassName(){return"GamepadCamera"}}nt.ShadersStore.passCubePixelShader="varying vec2 vUV;uniform samplerCube textureSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec2 uv=vUV*2.0-1.0;\n#ifdef POSITIVEX\ngl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x));\n#endif\n#ifdef NEGATIVEX\ngl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x));\n#endif\n#ifdef POSITIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x));\n#endif\n#ifdef NEGATIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x));\n#endif\n#ifdef POSITIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,1.001));\n#endif\n#ifdef NEGATIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,-1.001));\n#endif\n}";class sa extends dn{getClassName(){return"PassPostProcess"}constructor(e,t,i=null,s,r,n,o=0,a=!1){super(e,"pass",null,null,t,i,s,r,n,void 0,o,void 0,null,a)}static _Parse(e,t,i,s){return de.Parse((()=>new sa(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable)),e,i,s)}}m("BABYLON.PassPostProcess",sa),Ns._RescalePostProcessFactory=e=>new sa("rescale",1,null,2,e,!1,0);nt.ShadersStore.anaglyphPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D leftSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 leftFrag=texture2D(leftSampler,vUV);leftFrag=vec4(1.0,leftFrag.g,leftFrag.b,1.0);vec4 rightFrag=texture2D(textureSampler,vUV);rightFrag=vec4(rightFrag.r,1.0,1.0,1.0);gl_FragColor=vec4(rightFrag.rgb*leftFrag.rgb,1.0);}";class ra extends dn{getClassName(){return"AnaglyphPostProcess"}constructor(e,t,i,s,r,n){super(e,"anaglyph",null,["leftSampler"],t,i[1],s,r,n),this._passedProcess=i[0]._rigPostProcess,this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("leftSampler",this._passedProcess)}))}}function na(e){e._rigCameras[0]._rigPostProcess=new sa(e.name+"_passthru",1,e._rigCameras[0]),e._rigCameras[1]._rigPostProcess=new ra(e.name+"_anaglyph",1,e._rigCameras)}m("BABYLON.AnaglyphPostProcess",ra),ve.AddNodeConstructor("AnaglyphArcRotateCamera",((e,t,i)=>()=>new oa(e,0,0,1,S.Zero(),i.interaxial_distance,t)));class oa extends Ho{constructor(e,t,i,s,r,n,o){super(e,t,i,s,r,o),this._setRigMode=()=>na(this),this.interaxialDistance=n,this.setCameraRigMode(ps.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:n})}getClassName(){return"AnaglyphArcRotateCamera"}}ve.AddNodeConstructor("AnaglyphFreeCamera",((e,t,i)=>()=>new aa(e,S.Zero(),i.interaxial_distance,t)));class aa extends zo{constructor(e,t,i,s){super(e,t,s),this._setRigMode=()=>na(this),this.interaxialDistance=i,this.setCameraRigMode(ps.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphFreeCamera"}}ve.AddNodeConstructor("AnaglyphGamepadCamera",((e,t,i)=>()=>new la(e,S.Zero(),i.interaxial_distance,t)));class la extends ia{constructor(e,t,i,s){super(e,t,s),this._setRigMode=()=>na(this),this.interaxialDistance=i,this.setCameraRigMode(ps.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphGamepadCamera"}}ve.AddNodeConstructor("AnaglyphUniversalCamera",((e,t,i)=>()=>new ha(e,S.Zero(),i.interaxial_distance,t)));class ha extends ta{constructor(e,t,i,s){super(e,t,s),this._setRigMode=()=>na(this),this.interaxialDistance=i,this.setCameraRigMode(ps.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphUniversalCamera"}}nt.ShadersStore.stereoscopicInterlacePixelShader="const vec3 TWO=vec3(2.0,2.0,2.0);varying vec2 vUV;uniform sampler2D camASampler;uniform sampler2D textureSampler;uniform vec2 stepSize;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{bool useCamA;bool useCamB;vec2 texCoord1;vec2 texCoord2;vec3 frag1;vec3 frag2;\n#ifdef IS_STEREOSCOPIC_HORIZ\nuseCamB=vUV.x>0.5;useCamA=!useCamB;texCoord1=vec2(useCamB ? (vUV.x-0.5)*2.0 : vUV.x*2.0,vUV.y);texCoord2=vec2(texCoord1.x+stepSize.x,vUV.y);\n#else\n#ifdef IS_STEREOSCOPIC_INTERLACED\nfloat rowNum=floor(vUV.y/stepSize.y);useCamA=mod(rowNum,2.0)==1.0;useCamB=mod(rowNum,2.0)==0.0;texCoord1=vec2(vUV.x,vUV.y);texCoord2=vec2(vUV.x,vUV.y);\n#else\nuseCamB=vUV.y>0.5;useCamA=!useCamB;texCoord1=vec2(vUV.x,useCamB ? (vUV.y-0.5)*2.0 : vUV.y*2.0);texCoord2=vec2(vUV.x,texCoord1.y+stepSize.y);\n#endif\n#endif\nif (useCamB){frag1=texture2D(textureSampler,texCoord1).rgb;frag2=texture2D(textureSampler,texCoord2).rgb;}else if (useCamA){frag1=texture2D(camASampler ,texCoord1).rgb;frag2=texture2D(camASampler ,texCoord2).rgb;}else {discard;}\ngl_FragColor=vec4((frag1+frag2)/TWO,1.0);}\n";class ca extends dn{getClassName(){return"StereoscopicInterlacePostProcessI"}constructor(e,t,i,s,r,n,o){super(e,"stereoscopicInterlace",["stepSize"],["camASampler"],1,t[1],r,n,o,s?"#define IS_STEREOSCOPIC_INTERLACED 1":i?"#define IS_STEREOSCOPIC_HORIZ 1":void 0),this._passedProcess=t[0]._rigPostProcess,this._stepSize=new E(1/this.width,1/this.height),this.onSizeChangedObservable.add((()=>{this._stepSize=new E(1/this.width,1/this.height)})),this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("camASampler",this._passedProcess),e.setFloat2("stepSize",this._stepSize.x,this._stepSize.y)}))}}function ua(e){const t=e.cameraRigMode===ps.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL||e.cameraRigMode===ps.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED,i=e.cameraRigMode===ps.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED;e.cameraRigMode===ps.RIG_MODE_STEREOSCOPIC_INTERLACED?(e._rigCameras[0]._rigPostProcess=new sa(e.name+"_passthru",1,e._rigCameras[0]),e._rigCameras[1]._rigPostProcess=new ca(e.name+"_stereoInterlace",e._rigCameras,!1,!0)):(e._rigCameras[i?1:0].viewport=new ds(0,0,t?.5:1,t?1:.5),e._rigCameras[i?0:1].viewport=new ds(t?.5:0,t?0:.5,t?.5:1,t?1:.5))}ve.AddNodeConstructor("StereoscopicArcRotateCamera",((e,t,i)=>()=>new da(e,0,0,1,S.Zero(),i.interaxial_distance,i.isStereoscopicSideBySide,t)));class da extends Ho{constructor(e,t,i,s,r,n,o,a){super(e,t,i,s,r,a),this._setRigMode=()=>ua(this),this.interaxialDistance=n,this.isStereoscopicSideBySide=o,this.setCameraRigMode(o?ps.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:ps.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:n})}getClassName(){return"StereoscopicArcRotateCamera"}}ve.AddNodeConstructor("StereoscopicFreeCamera",((e,t,i)=>()=>new pa(e,S.Zero(),i.interaxial_distance,i.isStereoscopicSideBySide,t)));class pa extends zo{constructor(e,t,i,s,r){super(e,t,r),this._setRigMode=()=>ua(this),this.interaxialDistance=i,this.isStereoscopicSideBySide=s,this.setCameraRigMode(s?ps.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:ps.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicFreeCamera"}}ve.AddNodeConstructor("StereoscopicGamepadCamera",((e,t,i)=>()=>new _a(e,S.Zero(),i.interaxial_distance,i.isStereoscopicSideBySide,t)));class _a extends ia{constructor(e,t,i,s,r){super(e,t,r),this._setRigMode=()=>ua(this),this.interaxialDistance=i,this.isStereoscopicSideBySide=s,this.setCameraRigMode(s?ps.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:ps.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicGamepadCamera"}}ve.AddNodeConstructor("StereoscopicFreeCamera",((e,t,i)=>()=>new fa(e,S.Zero(),i.interaxial_distance,i.isStereoscopicSideBySide,t)));class fa extends ta{constructor(e,t,i,s,r){super(e,t,r),this._setRigMode=()=>ua(this),this.interaxialDistance=i,this.isStereoscopicSideBySide=s,this.setCameraRigMode(s?ps.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:ps.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicUniversalCamera"}}ve.AddNodeConstructor("VirtualJoysticksCamera",((e,t)=>()=>new ma(e,S.Zero(),t)));class ma extends zo{constructor(e,t,i){super(e,t,i),this.inputs.addVirtualJoystick()}getClassName(){return"VirtualJoysticksCamera"}}class ga{constructor(){this.compensateDistortion=!0,this.multiviewEnabled=!1}get aspectRatio(){return this.hResolution/(2*this.vResolution)}get aspectRatioFov(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))}get leftHMatrix(){const e=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return y.Translation(e,0,0)}get rightHMatrix(){const e=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return y.Translation(-e,0,0)}get leftPreViewMatrix(){return y.Translation(.5*this.interpupillaryDistance,0,0)}get rightPreViewMatrix(){return y.Translation(-.5*this.interpupillaryDistance,0,0)}static GetDefault(){const e=new ga;return e.hResolution=1280,e.vResolution=800,e.hScreenSize=.149759993,e.vScreenSize=.0935999975,e.vScreenCenter=.0467999987,e.eyeToScreenDistance=.0410000011,e.lensSeparationDistance=.063500002,e.interpupillaryDistance=.064000003,e.distortionK=[1,.219999999,.239999995,0],e.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0],e.postProcessScaleFactor=1.714605507808412,e.lensCenterOffset=.151976421,e}}nt.ShadersStore.vrDistortionCorrectionPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 LensCenter;uniform vec2 Scale;uniform vec2 ScaleIn;uniform vec4 HmdWarpParam;vec2 HmdWarp(vec2 in01) {vec2 theta=(in01-LensCenter)*ScaleIn; \nfloat rSq=theta.x*theta.x+theta.y*theta.y;vec2 rvector=theta*(HmdWarpParam.x+HmdWarpParam.y*rSq+HmdWarpParam.z*rSq*rSq+HmdWarpParam.w*rSq*rSq*rSq);return LensCenter+Scale*rvector;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec2 tc=HmdWarp(vUV);if (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)\ngl_FragColor=vec4(0.0,0.0,0.0,0.0);else{gl_FragColor=texture2D(textureSampler,tc);}}";class va extends dn{getClassName(){return"VRDistortionCorrectionPostProcess"}constructor(e,t,i,s){super(e,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,s.postProcessScaleFactor,t,Ar.BILINEAR_SAMPLINGMODE),this._isRightEye=i,this._distortionFactors=s.distortionK,this._postProcessScaleFactor=s.postProcessScaleFactor,this._lensCenterOffset=s.lensCenterOffset,this.adaptScaleToCurrentViewport=!0,this.onSizeChangedObservable.add((()=>{this._scaleIn=new E(2,2/this.aspectRatio),this._scaleFactor=new E(1/this._postProcessScaleFactor*.5,1/this._postProcessScaleFactor*.5*this.aspectRatio),this._lensCenter=new E(this._isRightEye?.5-.5*this._lensCenterOffset:.5+.5*this._lensCenterOffset,.5)})),this.onApplyObservable.add((e=>{e.setFloat2("LensCenter",this._lensCenter.x,this._lensCenter.y),e.setFloat2("Scale",this._scaleFactor.x,this._scaleFactor.y),e.setFloat2("ScaleIn",this._scaleIn.x,this._scaleIn.y),e.setFloat4("HmdWarpParam",this._distortionFactors[0],this._distortionFactors[1],this._distortionFactors[2],this._distortionFactors[3])}))}}nt.ShadersStore.vrMultiviewToSingleviewPixelShader="precision mediump sampler2DArray;varying vec2 vUV;uniform sampler2DArray multiviewSampler;uniform int imageIndex;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{gl_FragColor=texture2D(multiviewSampler,vec3(vUV,imageIndex));}";class xa extends Bn{set samples(e){this._samples=e}get samples(){return this._samples}constructor(e,t=512){super("multiview rtt",t,e,!1,!0,0,!1,void 0,!1,!1,!0,void 0,!0),this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight()),this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,this.samples=this._getEngine().getCaps().maxSamples||this.samples,this._texture.samples=this._samples}_bindFrameBuffer(){this._renderTarget&&this.getScene().getEngine().bindMultiviewFramebuffer(this._renderTarget)}getViewCount(){return 2}}function Ta(e,t){const i=new ai(e,void 0,!0,t);return i.addUniform("viewProjection",16),i.addUniform("viewProjectionR",16),i.addUniform("view",16),i.addUniform("projection",16),i.addUniform("vEyePosition",4),i}Ns.prototype.createMultiviewRenderTargetTexture=function(e,t,i,s){const r=this._gl;if(!this.getCaps().multiview)throw"Multiview is not supported";const n=this._createHardwareRenderTargetWrapper(!1,!1,{width:e,height:t});n._framebuffer=r.createFramebuffer();const o=new dt(this,ut.Unknown,!0);return o.width=e,o.height=t,o.isMultiview=!0,i||(i=r.createTexture(),r.bindTexture(r.TEXTURE_2D_ARRAY,i),r.texStorage3D(r.TEXTURE_2D_ARRAY,1,r.RGBA8,e,t,2)),n._colorTextureArray=i,s||(s=r.createTexture(),r.bindTexture(r.TEXTURE_2D_ARRAY,s),r.texStorage3D(r.TEXTURE_2D_ARRAY,1,r.DEPTH24_STENCIL8,e,t,2)),n._depthStencilTextureArray=s,o.isReady=!0,n.setTextures(o),n._depthStencilTexture=o,n},Ns.prototype.bindMultiviewFramebuffer=function(e){const t=e,i=this._gl,s=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(t,void 0,void 0,void 0,!0),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,t._framebuffer),!t._colorTextureArray||!t._depthStencilTextureArray)throw"Invalid multiview frame buffer";this.getCaps().oculusMultiview?(s.framebufferTextureMultisampleMultiviewOVR(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0,t._colorTextureArray,0,t.samples,0,2),s.framebufferTextureMultisampleMultiviewOVR(i.DRAW_FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,t._depthStencilTextureArray,0,t.samples,0,2)):(s.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0,t._colorTextureArray,0,0,2),s.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,t._depthStencilTextureArray,0,0,2))},Ns.prototype.bindSpaceWarpFramebuffer=function(e){const t=e,i=this._gl,s=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(t,void 0,void 0,void 0,!0),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,t._framebuffer),!t._colorTextureArray||!t._depthStencilTextureArray)throw new Error("Invalid Space Warp framebuffer");s.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0,t._colorTextureArray,0,0,2),s.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.DEPTH_ATTACHMENT,t._depthStencilTextureArray,0,0,2)},ps.prototype._useMultiviewToSingleView=!1,ps.prototype._multiviewTexture=null,ps.prototype._resizeOrCreateMultiviewTexture=function(e,t){this._multiviewTexture?this._multiviewTexture.getRenderWidth()==e&&this._multiviewTexture.getRenderHeight()==t||(this._multiviewTexture.dispose(),this._multiviewTexture=new xa(this.getScene(),{width:e,height:t})):this._multiviewTexture=new xa(this.getScene(),{width:e,height:t})};const Ea=Yi.prototype.createSceneUniformBuffer;Yi.prototype._transformMatrixR=y.Zero(),Yi.prototype._multiviewSceneUbo=null,Yi.prototype._createMultiviewUbo=function(){this._multiviewSceneUbo=Ta(this.getEngine(),"scene_multiview")},Yi.prototype.createSceneUniformBuffer=function(e){return this._multiviewSceneUbo?Ta(this.getEngine(),e):Ea.bind(this)(e)},Yi.prototype._updateMultiviewUbo=function(e,t){e&&t&&e.multiplyToRef(t,this._transformMatrixR),e&&t&&(e.multiplyToRef(t,R.Matrix[0]),Li.GetRightPlaneToRef(R.Matrix[0],this._frustumPlanes[3])),this._multiviewSceneUbo&&(this._multiviewSceneUbo.updateMatrix("viewProjection",this.getTransformMatrix()),this._multiviewSceneUbo.updateMatrix("viewProjectionR",this._transformMatrixR),this._multiviewSceneUbo.updateMatrix("view",this._viewMatrix),this._multiviewSceneUbo.updateMatrix("projection",this._projectionMatrix))},Yi.prototype._renderMultiviewToSingleView=function(e){e._resizeOrCreateMultiviewTexture(e._rigPostProcess&&e._rigPostProcess&&e._rigPostProcess.width>0?e._rigPostProcess.width:this.getEngine().getRenderWidth(!0),e._rigPostProcess&&e._rigPostProcess&&e._rigPostProcess.height>0?e._rigPostProcess.height:this.getEngine().getRenderHeight(!0)),this._multiviewSceneUbo||this._createMultiviewUbo(),e.outputRenderTarget=e._multiviewTexture,this._renderForCamera(e),e.outputRenderTarget=null;for(let t=0;t<e._rigCameras.length;t++){const i=this.getEngine();this._activeCamera=e._rigCameras[t],i.setViewport(this._activeCamera.viewport),this.postProcessManager&&(this.postProcessManager._prepareFrame(),this.postProcessManager._finalizeFrame(this._activeCamera.isIntermediate))}};class Sa extends dn{getClassName(){return"VRMultiviewToSingleviewPostProcess"}constructor(e,t,i){super(e,"vrMultiviewToSingleview",["imageIndex"],["multiviewSampler"],i,t,Ar.BILINEAR_SAMPLINGMODE);const s=null!=t?t:this.getCamera();this.onSizeChangedObservable.add((()=>{})),this.onApplyObservable.add((e=>{s._scene.activeCamera&&s._scene.activeCamera.isLeftCamera?e.setInt("imageIndex",0):e.setInt("imageIndex",1),e.setTexture("multiviewSampler",s._multiviewTexture)}))}}function ba(e,t){const i=t.vrCameraMetrics||ga.GetDefault();e._rigCameras[0]._cameraRigParams.vrMetrics=i,e._rigCameras[0].viewport=new ds(0,0,.5,1),e._rigCameras[0]._cameraRigParams.vrWorkMatrix=new y,e._rigCameras[0]._cameraRigParams.vrHMatrix=i.leftHMatrix,e._rigCameras[0]._cameraRigParams.vrPreViewMatrix=i.leftPreViewMatrix,e._rigCameras[0].getProjectionMatrix=e._rigCameras[0]._getVRProjectionMatrix,e._rigCameras[1]._cameraRigParams.vrMetrics=i,e._rigCameras[1].viewport=new ds(.5,0,.5,1),e._rigCameras[1]._cameraRigParams.vrWorkMatrix=new y,e._rigCameras[1]._cameraRigParams.vrHMatrix=i.rightHMatrix,e._rigCameras[1]._cameraRigParams.vrPreViewMatrix=i.rightPreViewMatrix,e._rigCameras[1].getProjectionMatrix=e._rigCameras[1]._getVRProjectionMatrix,i.multiviewEnabled&&(e.getScene().getEngine().getCaps().multiview?(e._useMultiviewToSingleView=!0,e._rigPostProcess=new Sa("VRMultiviewToSingleview",e,i.postProcessScaleFactor)):(k.Warn("Multiview is not supported, falling back to standard rendering"),i.multiviewEnabled=!1)),i.compensateDistortion&&(e._rigCameras[0]._rigPostProcess=new va("VR_Distort_Compensation_Left",e._rigCameras[0],!1,i),e._rigCameras[1]._rigPostProcess=new va("VR_Distort_Compensation_Right",e._rigCameras[1],!0,i))}ve.AddNodeConstructor("VRDeviceOrientationArcRotateCamera",((e,t)=>()=>new Ca(e,0,0,1,S.Zero(),t)));class Ca extends Ho{constructor(e,t,i,s,r,n,o=!0,a=ga.GetDefault()){super(e,t,i,s,r,n),this._setRigMode=e=>ba(this,e),a.compensateDistortion=o,this.setCameraRigMode(ps.RIG_MODE_VR,{vrCameraMetrics:a}),this.inputs.addVRDeviceOrientation()}getClassName(){return"VRDeviceOrientationArcRotateCamera"}}ve.AddNodeConstructor("VRDeviceOrientationFreeCamera",((e,t)=>()=>new ya(e,S.Zero(),t)));class ya extends Xo{constructor(e,t,i,s=!0,r=ga.GetDefault()){super(e,t,i),this._setRigMode=e=>ba(this,e),r.compensateDistortion=s,this.setCameraRigMode(ps.RIG_MODE_VR,{vrCameraMetrics:r})}getClassName(){return"VRDeviceOrientationFreeCamera"}}ve.AddNodeConstructor("VRDeviceOrientationGamepadCamera",((e,t)=>()=>new Aa(e,S.Zero(),t)));class Aa extends ya{constructor(e,t,i,s=!0,r=ga.GetDefault()){super(e,t,i,s,r),this._setRigMode=e=>ba(this,e),this.inputs.addGamepad()}getClassName(){return"VRDeviceOrientationGamepadCamera"}}class Ra{constructor(){this.previousWorldMatrices={},this.previousBones={}}static AddUniforms(e){e.push("previousWorld","previousViewProjection","mPreviousBones")}static AddSamplers(e){}bindForSubMesh(e,t,i,s,r){if(t.prePassRenderer&&t.prePassRenderer.enabled&&t.prePassRenderer.currentRTisSceneRT&&-1!==t.prePassRenderer.getIndex(2)){this.previousWorldMatrices[i.uniqueId]||(this.previousWorldMatrices[i.uniqueId]=s.clone()),this.previousViewProjection||(this.previousViewProjection=t.getTransformMatrix().clone(),this.currentViewProjection=t.getTransformMatrix().clone());const r=t.getEngine();this.currentViewProjection.updateFlag!==t.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=r.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(t.getTransformMatrix())):this._lastUpdateFrameId!==r.frameId&&(this._lastUpdateFrameId=r.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),e.setMatrix("previousWorld",this.previousWorldMatrices[i.uniqueId]),e.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[i.uniqueId]=s.clone()}}}class Ia{static get DiffuseTextureEnabled(){return this._DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){this._DiffuseTextureEnabled!==e&&(this._DiffuseTextureEnabled=e,Ns.MarkAllMaterialsAsDirty(1))}static get DetailTextureEnabled(){return this._DetailTextureEnabled}static set DetailTextureEnabled(e){this._DetailTextureEnabled!==e&&(this._DetailTextureEnabled=e,Ns.MarkAllMaterialsAsDirty(1))}static get DecalMapEnabled(){return this._DecalMapEnabled}static set DecalMapEnabled(e){this._DecalMapEnabled!==e&&(this._DecalMapEnabled=e,Ns.MarkAllMaterialsAsDirty(1))}static get AmbientTextureEnabled(){return this._AmbientTextureEnabled}static set AmbientTextureEnabled(e){this._AmbientTextureEnabled!==e&&(this._AmbientTextureEnabled=e,Ns.MarkAllMaterialsAsDirty(1))}static get OpacityTextureEnabled(){return this._OpacityTextureEnabled}static set OpacityTextureEnabled(e){this._OpacityTextureEnabled!==e&&(this._OpacityTextureEnabled=e,Ns.MarkAllMaterialsAsDirty(1))}static get ReflectionTextureEnabled(){return this._ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){this._ReflectionTextureEnabled!==e&&(this._ReflectionTextureEnabled=e,Ns.MarkAllMaterialsAsDirty(1))}static get EmissiveTextureEnabled(){return this._EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){this._EmissiveTextureEnabled!==e&&(this._EmissiveTextureEnabled=e,Ns.MarkAllMaterialsAsDirty(1))}static get SpecularTextureEnabled(){return this._SpecularTextureEnabled}static set SpecularTextureEnabled(e){this._SpecularTextureEnabled!==e&&(this._SpecularTextureEnabled=e,Ns.MarkAllMaterialsAsDirty(1))}static get BumpTextureEnabled(){return this._BumpTextureEnabled}static set BumpTextureEnabled(e){this._BumpTextureEnabled!==e&&(this._BumpTextureEnabled=e,Ns.MarkAllMaterialsAsDirty(1))}static get LightmapTextureEnabled(){return this._LightmapTextureEnabled}static set LightmapTextureEnabled(e){this._LightmapTextureEnabled!==e&&(this._LightmapTextureEnabled=e,Ns.MarkAllMaterialsAsDirty(1))}static get RefractionTextureEnabled(){return this._RefractionTextureEnabled}static set RefractionTextureEnabled(e){this._RefractionTextureEnabled!==e&&(this._RefractionTextureEnabled=e,Ns.MarkAllMaterialsAsDirty(1))}static get ColorGradingTextureEnabled(){return this._ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){this._ColorGradingTextureEnabled!==e&&(this._ColorGradingTextureEnabled=e,Ns.MarkAllMaterialsAsDirty(1))}static get FresnelEnabled(){return this._FresnelEnabled}static set FresnelEnabled(e){this._FresnelEnabled!==e&&(this._FresnelEnabled=e,Ns.MarkAllMaterialsAsDirty(4))}static get ClearCoatTextureEnabled(){return this._ClearCoatTextureEnabled}static set ClearCoatTextureEnabled(e){this._ClearCoatTextureEnabled!==e&&(this._ClearCoatTextureEnabled=e,Ns.MarkAllMaterialsAsDirty(1))}static get ClearCoatBumpTextureEnabled(){return this._ClearCoatBumpTextureEnabled}static set ClearCoatBumpTextureEnabled(e){this._ClearCoatBumpTextureEnabled!==e&&(this._ClearCoatBumpTextureEnabled=e,Ns.MarkAllMaterialsAsDirty(1))}static get ClearCoatTintTextureEnabled(){return this._ClearCoatTintTextureEnabled}static set ClearCoatTintTextureEnabled(e){this._ClearCoatTintTextureEnabled!==e&&(this._ClearCoatTintTextureEnabled=e,Ns.MarkAllMaterialsAsDirty(1))}static get SheenTextureEnabled(){return this._SheenTextureEnabled}static set SheenTextureEnabled(e){this._SheenTextureEnabled!==e&&(this._SheenTextureEnabled=e,Ns.MarkAllMaterialsAsDirty(1))}static get AnisotropicTextureEnabled(){return this._AnisotropicTextureEnabled}static set AnisotropicTextureEnabled(e){this._AnisotropicTextureEnabled!==e&&(this._AnisotropicTextureEnabled=e,Ns.MarkAllMaterialsAsDirty(1))}static get ThicknessTextureEnabled(){return this._ThicknessTextureEnabled}static set ThicknessTextureEnabled(e){this._ThicknessTextureEnabled!==e&&(this._ThicknessTextureEnabled=e,Ns.MarkAllMaterialsAsDirty(1))}static get RefractionIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set RefractionIntensityTextureEnabled(e){this._RefractionIntensityTextureEnabled!==e&&(this._RefractionIntensityTextureEnabled=e,Ns.MarkAllMaterialsAsDirty(1))}static get TranslucencyIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set TranslucencyIntensityTextureEnabled(e){this._TranslucencyIntensityTextureEnabled!==e&&(this._TranslucencyIntensityTextureEnabled=e,Ns.MarkAllMaterialsAsDirty(1))}static get IridescenceTextureEnabled(){return this._IridescenceTextureEnabled}static set IridescenceTextureEnabled(e){this._IridescenceTextureEnabled!==e&&(this._IridescenceTextureEnabled=e,Ns.MarkAllMaterialsAsDirty(1))}}Ia._DiffuseTextureEnabled=!0,Ia._DetailTextureEnabled=!0,Ia._DecalMapEnabled=!0,Ia._AmbientTextureEnabled=!0,Ia._OpacityTextureEnabled=!0,Ia._ReflectionTextureEnabled=!0,Ia._EmissiveTextureEnabled=!0,Ia._SpecularTextureEnabled=!0,Ia._BumpTextureEnabled=!0,Ia._LightmapTextureEnabled=!0,Ia._RefractionTextureEnabled=!0,Ia._ColorGradingTextureEnabled=!0,Ia._FresnelEnabled=!0,Ia._ClearCoatTextureEnabled=!0,Ia._ClearCoatBumpTextureEnabled=!0,Ia._ClearCoatTintTextureEnabled=!0,Ia._SheenTextureEnabled=!0,Ia._AnisotropicTextureEnabled=!0,Ia._ThicknessTextureEnabled=!0,Ia._RefractionIntensityTextureEnabled=!0,Ia._TranslucencyIntensityTextureEnabled=!0,Ia._IridescenceTextureEnabled=!0;nt.IncludesShadersStore.decalFragmentDeclaration="#ifdef DECAL\nuniform vec4 vDecalInfos;\n#endif\n";nt.IncludesShadersStore.defaultFragmentDeclaration="uniform vec4 vEyePosition;uniform vec4 vDiffuseColor;\n#ifdef SPECULARTERM\nuniform vec4 vSpecularColor;\n#endif\nuniform vec3 vEmissiveColor;uniform vec3 vAmbientColor;uniform float visibility;\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY \nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;\n#endif\n#ifdef ALPHATEST\nuniform float alphaCutOff;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\n#ifndef REFRACTIONMAP_3D\nuniform mat4 refractionMatrix;\n#endif\n#ifdef REFRACTIONFRESNEL\nuniform vec4 refractionLeftColor;uniform vec4 refractionRightColor;\n#endif\n#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)\nuniform vec3 vRefractionPosition;uniform vec3 vRefractionSize; \n#endif\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;\n#endif\n#ifdef DIFFUSEFRESNEL\nuniform vec4 diffuseLeftColor;uniform vec4 diffuseRightColor;\n#endif\n#ifdef OPACITYFRESNEL\nuniform vec4 opacityParts;\n#endif\n#ifdef EMISSIVEFRESNEL\nuniform vec4 emissiveLeftColor;uniform vec4 emissiveRightColor;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)\nuniform mat4 reflectionMatrix;\n#endif\n#ifndef REFLECTIONMAP_SKYBOX\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;uniform vec3 vReflectionSize; \n#endif\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 reflectionLeftColor;uniform vec4 reflectionRightColor;\n#endif\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\n#endif\n#include<decalFragmentDeclaration>\n#define ADDITIONAL_FRAGMENT_DECLARATION\n";nt.IncludesShadersStore.sceneUboDeclaration="layout(std140,column_major) uniform;uniform Scene {mat4 viewProjection;\n#ifdef MULTIVIEW\nmat4 viewProjectionR;\n#endif \nmat4 view;mat4 projection;vec4 vEyePosition;};\n";nt.IncludesShadersStore.meshUboDeclaration="#ifdef WEBGL2\nuniform mat4 world;uniform float visibility;\n#else\nlayout(std140,column_major) uniform;uniform Mesh\n{mat4 world;float visibility;};\n#endif\n#define WORLD_UBO\n";nt.IncludesShadersStore.defaultUboDeclaration="layout(std140,column_major) uniform;uniform Material\n{vec4 diffuseLeftColor;vec4 diffuseRightColor;vec4 opacityParts;vec4 reflectionLeftColor;vec4 reflectionRightColor;vec4 refractionLeftColor;vec4 refractionRightColor;vec4 emissiveLeftColor;vec4 emissiveRightColor;vec2 vDiffuseInfos;vec2 vAmbientInfos;vec2 vOpacityInfos;vec2 vReflectionInfos;vec3 vReflectionPosition;vec3 vReflectionSize;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec2 vSpecularInfos;vec3 vBumpInfos;mat4 diffuseMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 reflectionMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 specularMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;float pointSize;float alphaCutOff;mat4 refractionMatrix;vec4 vRefractionInfos;vec3 vRefractionPosition;vec3 vRefractionSize;vec4 vSpecularColor;vec3 vEmissiveColor;vec4 vDiffuseColor;vec3 vAmbientColor;\n#define ADDITIONAL_UBO_DECLARATION\n};\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";nt.IncludesShadersStore.prePassDeclaration="#ifdef PREPASS\n#extension GL_EXT_draw_buffers : require\nlayout(location=0) out highp vec4 glFragData[{X}];highp vec4 gl_FragColor;\n#ifdef PREPASS_DEPTH\nvarying highp vec3 vViewPos;\n#endif\n#ifdef PREPASS_VELOCITY\nvarying highp vec4 vCurrentPosition;varying highp vec4 vPreviousPosition;\n#endif\n#endif\n";nt.IncludesShadersStore.oitDeclaration="#ifdef ORDER_INDEPENDENT_TRANSPARENCY\n#extension GL_EXT_draw_buffers : require\nlayout(location=0) out vec2 depth; \nlayout(location=1) out vec4 frontColor;layout(location=2) out vec4 backColor;\n#define MAX_DEPTH 99999.0\nhighp vec4 gl_FragColor;uniform sampler2D oitDepthSampler;uniform sampler2D oitFrontColorSampler;\n#endif\n";nt.IncludesShadersStore.mainUVVaryingDeclaration="#ifdef MAINUV{X}\nvarying vec2 vMainUV{X};\n#endif\n";nt.IncludesShadersStore.helperFunctions="const float PI=3.1415926535897932384626433832795;const float RECIPROCAL_PI=0.3183098861837907;const float RECIPROCAL_PI2=0.15915494309189535;const float HALF_MIN=5.96046448e-08; \nconst float LinearEncodePowerApprox=2.2;const float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;const vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);const float Epsilon=0.0000001;\n#define saturate(x) clamp(x,0.0,1.0)\n#define absEps(x) abs(x)+Epsilon\n#define maxEps(x) max(x,Epsilon)\n#define saturateEps(x) clamp(x,Epsilon,1.0)\nmat3 transposeMat3(mat3 inMatrix) {vec3 i0=inMatrix[0];vec3 i1=inMatrix[1];vec3 i2=inMatrix[2];mat3 outMatrix=mat3(\nvec3(i0.x,i1.x,i2.x),\nvec3(i0.y,i1.y,i2.y),\nvec3(i0.z,i1.z,i2.z)\n);return outMatrix;}\nmat3 inverseMat3(mat3 inMatrix) {float a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];float a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];float a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];float b01=a22*a11-a12*a21;float b11=-a22*a10+a12*a20;float b21=a21*a10-a11*a20;float det=a00*b01+a01*b11+a02*b21;return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),\nb11,(a22*a00-a02*a20),(-a12*a00+a02*a10),\nb21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;}\n#if USE_EXACT_SRGB_CONVERSIONS\nvec3 toLinearSpaceExact(vec3 color)\n{vec3 nearZeroSection=0.0773993808*color;vec3 remainingSection=pow(0.947867299*(color+vec3(0.055)),vec3(2.4));\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nreturn mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.04045)));\n#else\nreturn\nvec3(\ncolor.r<=0.04045 ? nearZeroSection.r : remainingSection.r,\ncolor.g<=0.04045 ? nearZeroSection.g : remainingSection.g,\ncolor.b<=0.04045 ? nearZeroSection.b : remainingSection.b);\n#endif\n}\nvec3 toGammaSpaceExact(vec3 color)\n{vec3 nearZeroSection=12.92*color;vec3 remainingSection=1.055*pow(color,vec3(0.41666))-vec3(0.055);\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nreturn mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.0031308)));\n#else\nreturn\nvec3(\ncolor.r<=0.0031308 ? nearZeroSection.r : remainingSection.r,\ncolor.g<=0.0031308 ? nearZeroSection.g : remainingSection.g,\ncolor.b<=0.0031308 ? nearZeroSection.b : remainingSection.b);\n#endif\n}\n#endif\nfloat toLinearSpace(float color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nfloat nearZeroSection=0.0773993808*color;float remainingSection=pow(0.947867299*(color+0.055),2.4);return color<=0.04045 ? nearZeroSection : remainingSection;\n#else\nreturn pow(color,LinearEncodePowerApprox);\n#endif\n}\nvec3 toLinearSpace(vec3 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toLinearSpaceExact(color);\n#else\nreturn pow(color,vec3(LinearEncodePowerApprox));\n#endif\n}\nvec4 toLinearSpace(vec4 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4(toLinearSpaceExact(color.rgb),color.a);\n#else\nreturn vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);\n#endif\n}\nfloat toGammaSpace(float color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nfloat nearZeroSection=12.92*color;float remainingSection=1.055*pow(color,0.41666)-0.055;return color<=0.0031308 ? nearZeroSection : remainingSection;\n#else\nreturn pow(color,GammaEncodePowerApprox);\n#endif\n}\nvec3 toGammaSpace(vec3 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toGammaSpaceExact(color);\n#else\nreturn pow(color,vec3(GammaEncodePowerApprox));\n#endif\n}\nvec4 toGammaSpace(vec4 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4(toGammaSpaceExact(color.rgb),color.a);\n#else\nreturn vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);\n#endif\n}\nfloat square(float value)\n{return value*value;}\nvec3 square(vec3 value)\n{return value*value;}\nfloat pow5(float value) {float sq=value*value;return sq*sq*value;}\nfloat getLuminance(vec3 color)\n{return clamp(dot(color,LuminanceEncodeApprox),0.,1.);}\nfloat getRand(vec2 seed) {return fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);}\nfloat dither(vec2 seed,float varianceAmount) {float rand=getRand(seed);float normVariance=varianceAmount/255.0;float dither=mix(-normVariance,normVariance,rand);return dither;}\nconst float rgbdMaxRange=255.0;vec4 toRGBD(vec3 color) {float maxRGB=maxEps(max(color.r,max(color.g,color.b)));float D =max(rgbdMaxRange/maxRGB,1.);D =clamp(floor(D)/255.0,0.,1.);vec3 rgb=color.rgb*D;rgb=toGammaSpace(rgb);return vec4(clamp(rgb,0.,1.),D); }\nvec3 fromRGBD(vec4 rgbd) {rgbd.rgb=toLinearSpace(rgbd.rgb);return rgbd.rgb/rgbd.a;}\nvec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {vec3 invOrigVec=vec3(1.0,1.0,1.0)/origVec;vec3 halfSize=cubeSize*0.5;vec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;vec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;vec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);float distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);vec3 intersectPositionWS=vertexPos+origVec*distance;return intersectPositionWS-cubePos;}\n";nt.IncludesShadersStore.lightFragmentDeclaration="#ifdef LIGHT{X}\nuniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec4 vLightSpecular{X};\n#else\nvec4 vLightSpecular{X}=vec4(0.);\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};uniform highp sampler2DArray depthSampler{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};\n#else\nuniform highp sampler2DArray shadowSampler{X};\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nconst vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]\n(\nvec3 ( 1.5,0.0,0.0 ),\nvec3 ( 0.0,1.5,0.0 ),\nvec3 ( 0.0,0.0,5.5 ),\nvec3 ( 1.5,0.0,5.5 ),\nvec3 ( 1.5,1.5,0.0 ),\nvec3 ( 1.0,1.0,1.0 ),\nvec3 ( 0.0,1.0,5.5 ),\nvec3 ( 0.5,3.5,0.75 )\n);vec3 shadowDebug{X};\n#endif\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nint index{X}=-1;\n#else\nint index{X}=SHADOWCSMNUM_CASCADES{X}-1;\n#endif\nfloat diff{X}=0.;\n#elif defined(SHADOWCUBE{X})\nuniform samplerCube shadowSampler{X};\n#else\nvarying vec4 vPositionFromLight{X};varying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowSampler{X};uniform highp sampler2D depthSampler{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowSampler{X};\n#else\nuniform sampler2D shadowSampler{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\nuniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};\n#elif defined(POINTLIGHT{X})\nuniform vec4 vLightFalloff{X};\n#elif defined(HEMILIGHT{X})\nuniform vec3 vLightGround{X};\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightSampler{X};\n#endif\n#endif\n";nt.IncludesShadersStore.lightUboDeclaration="#ifdef LIGHT{X}\nuniform Light{X}\n{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;\n#ifdef SPOTLIGHT{X}\nvec4 vLightDirection;vec4 vLightFalloff;\n#elif defined(POINTLIGHT{X})\nvec4 vLightFalloff;\n#elif defined(HEMILIGHT{X})\nvec3 vLightGround;\n#endif\nvec4 shadowsInfo;vec2 depthValues;} light{X};\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightSampler{X};\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};uniform highp sampler2DArray depthSampler{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};\n#else\nuniform highp sampler2DArray shadowSampler{X};\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nconst vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]\n(\nvec3 ( 1.5,0.0,0.0 ),\nvec3 ( 0.0,1.5,0.0 ),\nvec3 ( 0.0,0.0,5.5 ),\nvec3 ( 1.5,0.0,5.5 ),\nvec3 ( 1.5,1.5,0.0 ),\nvec3 ( 1.0,1.0,1.0 ),\nvec3 ( 0.0,1.0,5.5 ),\nvec3 ( 0.5,3.5,0.75 )\n);vec3 shadowDebug{X};\n#endif\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nint index{X}=-1;\n#else\nint index{X}=SHADOWCSMNUM_CASCADES{X}-1;\n#endif\nfloat diff{X}=0.;\n#elif defined(SHADOWCUBE{X})\nuniform samplerCube shadowSampler{X}; \n#else\nvarying vec4 vPositionFromLight{X};varying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowSampler{X};uniform highp sampler2D depthSampler{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowSampler{X};\n#else\nuniform sampler2D shadowSampler{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\n#endif\n#endif\n";nt.IncludesShadersStore.lightsFragmentFunctions="struct lightingInfo\n{vec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef NDOTL\nfloat ndl;\n#endif\n};lightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {lightingInfo result;vec3 lightVectorW;float attenuation=1.0;if (lightData.w==0.)\n{vec3 direction=lightData.xyz-vPositionW;attenuation=max(0.,1.0-length(direction)/range);lightVectorW=normalize(direction);}\nelse\n{lightVectorW=normalize(-lightData.xyz);}\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;}\nlightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {lightingInfo result;vec3 direction=lightData.xyz-vPositionW;vec3 lightVectorW=normalize(direction);float attenuation=max(0.,1.0-length(direction)/range);float cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));if (cosAngle>=lightDirection.w)\n{cosAngle=max(0.,pow(cosAngle,lightData.w));attenuation*=cosAngle;float ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;}\nresult.diffuse=vec3(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;}\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {lightingInfo result;float ndl=dot(vNormal,lightData.xyz)*0.5+0.5;\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=mix(groundColor,diffuseColor,ndl);\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightData.xyz);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor;\n#endif\nreturn result;}\n#define inline\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return textureColor;}";nt.IncludesShadersStore.shadowsFragmentFunctions="#ifdef SHADOWS\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)\n#else\n#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)\n#endif\n#ifndef SHADOWFLOAT\nfloat unpack(vec4 color)\n{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}\n#endif\nfloat computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)\n{float mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));return mix(value,1.0,mask);}\n#define inline\nfloat computeShadowCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)\n{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadow=textureCube(shadowSampler,directionToLight).x;\n#endif\nreturn depth>shadow ? darkness : 1.0;}\n#define inline\nfloat computeShadowWithPoissonSamplingCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)\n{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;float visibility=1.;vec3 poissonDisk[4];poissonDisk[0]=vec3(-1.0,1.0,-1.0);poissonDisk[1]=vec3(1.0,-1.0,-1.0);poissonDisk[2]=vec3(-1.0,-1.0,-1.0);poissonDisk[3]=vec3(1.0,-1.0,1.0);\n#ifndef SHADOWFLOAT\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;\n#else\nif (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;\n#endif\nreturn min(1.0,visibility+darkness);}\n#define inline\nfloat computeShadowWithESMCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return esm;}\n#define inline\nfloat computeShadowWithCloseESMCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return esm;}\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define inline\nfloat computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);vec3 uvLayer=vec3(uv.x,uv.y,layer);float shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(texture2D(shadowSampler,uvLayer));\n#else\nfloat shadow=texture2D(shadowSampler,uvLayer).x;\n#endif\nreturn shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}\n#endif\n#define inline\nfloat computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{float shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadow=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nreturn shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}}\n#define inline\nfloat computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{float shadowPixelDepth=clamp(depthMetric,0.,1.0);float visibility=1.;vec2 poissonDisk[4];poissonDisk[0]=vec2(-0.94201624,-0.39906216);poissonDisk[1]=vec2(0.94558609,-0.76890725);poissonDisk[2]=vec2(-0.094184101,-0.92938870);poissonDisk[3]=vec2(0.34495938,0.29387760);\n#ifndef SHADOWFLOAT\nif (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;\n#else\nif (TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;\n#endif\nreturn computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{float shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{float shadowPixelDepth=clamp(depthMetric,0.,1.0); \n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}\n#ifdef IS_NDC_HALF_ZRANGE\n#define ZINCLIP clipSpace.z\n#else\n#define ZINCLIP uvDepth.z\n#endif\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define GREATEST_LESS_THAN_ONE 0.99999994\n/* disable_uniformity_analysis */\n#define inline\nfloat computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float shadow=texture2D(shadowSampler,uvDepthLayer);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\n#define inline\nfloat computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\n#define inline\nfloat computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));shadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));shadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));shadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\n#define inline\nfloat computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float shadow=TEXTUREFUNC(shadowSampler,uvDepth,0.);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw2.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow+=uvw2.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z),0.);shadow+=uvw0.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z),0.);shadow+=uvw1.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z),0.);shadow+=uvw2.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z),0.);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\nconst vec3 PoissonSamplers32[64]=vec3[64](\nvec3(0.06407013,0.05409927,0.),\nvec3(0.7366577,0.5789394,0.),\nvec3(-0.6270542,-0.5320278,0.),\nvec3(-0.4096107,0.8411095,0.),\nvec3(0.6849564,-0.4990818,0.),\nvec3(-0.874181,-0.04579735,0.),\nvec3(0.9989998,0.0009880066,0.),\nvec3(-0.004920578,-0.9151649,0.),\nvec3(0.1805763,0.9747483,0.),\nvec3(-0.2138451,0.2635818,0.),\nvec3(0.109845,0.3884785,0.),\nvec3(0.06876755,-0.3581074,0.),\nvec3(0.374073,-0.7661266,0.),\nvec3(0.3079132,-0.1216763,0.),\nvec3(-0.3794335,-0.8271583,0.),\nvec3(-0.203878,-0.07715034,0.),\nvec3(0.5912697,0.1469799,0.),\nvec3(-0.88069,0.3031784,0.),\nvec3(0.5040108,0.8283722,0.),\nvec3(-0.5844124,0.5494877,0.),\nvec3(0.6017799,-0.1726654,0.),\nvec3(-0.5554981,0.1559997,0.),\nvec3(-0.3016369,-0.3900928,0.),\nvec3(-0.5550632,-0.1723762,0.),\nvec3(0.925029,0.2995041,0.),\nvec3(-0.2473137,0.5538505,0.),\nvec3(0.9183037,-0.2862392,0.),\nvec3(0.2469421,0.6718712,0.),\nvec3(0.3916397,-0.4328209,0.),\nvec3(-0.03576927,-0.6220032,0.),\nvec3(-0.04661255,0.7995201,0.),\nvec3(0.4402924,0.3640312,0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.)\n);const vec3 PoissonSamplers64[64]=vec3[64](\nvec3(-0.613392,0.617481,0.),\nvec3(0.170019,-0.040254,0.),\nvec3(-0.299417,0.791925,0.),\nvec3(0.645680,0.493210,0.),\nvec3(-0.651784,0.717887,0.),\nvec3(0.421003,0.027070,0.),\nvec3(-0.817194,-0.271096,0.),\nvec3(-0.705374,-0.668203,0.),\nvec3(0.977050,-0.108615,0.),\nvec3(0.063326,0.142369,0.),\nvec3(0.203528,0.214331,0.),\nvec3(-0.667531,0.326090,0.),\nvec3(-0.098422,-0.295755,0.),\nvec3(-0.885922,0.215369,0.),\nvec3(0.566637,0.605213,0.),\nvec3(0.039766,-0.396100,0.),\nvec3(0.751946,0.453352,0.),\nvec3(0.078707,-0.715323,0.),\nvec3(-0.075838,-0.529344,0.),\nvec3(0.724479,-0.580798,0.),\nvec3(0.222999,-0.215125,0.),\nvec3(-0.467574,-0.405438,0.),\nvec3(-0.248268,-0.814753,0.),\nvec3(0.354411,-0.887570,0.),\nvec3(0.175817,0.382366,0.),\nvec3(0.487472,-0.063082,0.),\nvec3(-0.084078,0.898312,0.),\nvec3(0.488876,-0.783441,0.),\nvec3(0.470016,0.217933,0.),\nvec3(-0.696890,-0.549791,0.),\nvec3(-0.149693,0.605762,0.),\nvec3(0.034211,0.979980,0.),\nvec3(0.503098,-0.308878,0.),\nvec3(-0.016205,-0.872921,0.),\nvec3(0.385784,-0.393902,0.),\nvec3(-0.146886,-0.859249,0.),\nvec3(0.643361,0.164098,0.),\nvec3(0.634388,-0.049471,0.),\nvec3(-0.688894,0.007843,0.),\nvec3(0.464034,-0.188818,0.),\nvec3(-0.440840,0.137486,0.),\nvec3(0.364483,0.511704,0.),\nvec3(0.034028,0.325968,0.),\nvec3(0.099094,-0.308023,0.),\nvec3(0.693960,-0.366253,0.),\nvec3(0.678884,-0.204688,0.),\nvec3(0.001801,0.780328,0.),\nvec3(0.145177,-0.898984,0.),\nvec3(0.062655,-0.611866,0.),\nvec3(0.315226,-0.604297,0.),\nvec3(-0.780145,0.486251,0.),\nvec3(-0.371868,0.882138,0.),\nvec3(0.200476,0.494430,0.),\nvec3(-0.494552,-0.711051,0.),\nvec3(0.612476,0.705252,0.),\nvec3(-0.578845,-0.768792,0.),\nvec3(-0.772454,-0.090976,0.),\nvec3(0.504440,0.372295,0.),\nvec3(0.155736,0.065157,0.),\nvec3(0.391522,0.849605,0.),\nvec3(-0.620106,-0.328104,0.),\nvec3(0.789239,-0.419965,0.),\nvec3(-0.545396,0.538133,0.),\nvec3(-0.178564,-0.596057,0.)\n);\n#define inline\nfloat computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}\nfloat avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);vec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec4 offset=vec4(poissonSamplers[i],0.);offset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);shadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);}\nshadow/=float(pcfTapCount);shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));shadow=mix(darkness,1.,shadow);if (numBlocker<1.0) {return 1.0;}\nelse\n{return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=TEXTUREFUNC(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0.).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}\nif (numBlocker<1.0) {return 1.0;}\nelse\n{float avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);float filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec3 offset=poissonSamplers[i];offset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);shadow+=TEXTUREFUNC(shadowSampler,uvDepth+offset*filterRadius,0.);}\nshadow/=float(pcfTapCount);shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}}\n#define inline\nfloat computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);}\n#define inline\nfloat computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);}\n#define inline\nfloat computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);}\n#define inline\nfloat computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\n#define inline\nfloat computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\n#define inline\nfloat computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\n#endif\n#endif\n";nt.IncludesShadersStore.samplerFragmentDeclaration="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying vec2 v_VARYINGNAME_UV;\n#endif\nuniform sampler2D _SAMPLERNAME_Sampler;\n#endif\n";nt.IncludesShadersStore.fresnelFunction="#ifdef FRESNEL\nfloat computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)\n{float fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);return clamp(fresnelTerm,0.,1.);}\n#endif\n";nt.IncludesShadersStore.reflectionFunction="vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)\n{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0); }\nvec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)\n{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(1.0-s,t,0); }\nvec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{vec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);vec3 r=normalize(reflect(cameraToVertex,worldNormal));r=vec3(reflectionMatrix*vec4(r,0));float lon=atan(r.z,r.x);float lat=acos(r.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0);}\nvec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)\n{vec3 viewDir=normalize(vec3(view*worldPos));vec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));vec3 r=reflect(viewDir,viewNormal);r=vec3(reflectionMatrix*vec4(r,0));r.z=r.z-1.0;float m=2.0*length(r);return vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);}\nvec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{vec3 viewDir=worldPos.xyz-eyePosition;vec3 coords=normalize(reflect(viewDir,worldNormal));return vec3(reflectionMatrix*vec4(coords,1));}\nvec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=vec3(reflectionMatrix*vec4(coords,0));\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;}\nvec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)\n{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);coords=vec3(reflectionMatrix*vec4(coords,0));\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;}\nvec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)\n{return vec3(reflectionMatrix*(view*worldPos));}\nvec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)\n{return vec3(reflectionMatrix*vec4(positionW,1.));}\n#ifdef REFLECTION\nvec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)\n{\n#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED\nvec3 direction=normalize(vDirectionW);return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvec3 direction=normalize(vDirectionW);return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR\nreturn computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_SPHERICAL\nreturn computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_PLANAR\nreturn computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_CUBIC\n#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC\nreturn computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);\n#else\nreturn computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#endif\n#ifdef REFLECTIONMAP_PROJECTION\nreturn computeProjectionCoords(worldPos,view,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nreturn computeSkyBoxCoords(vPositionUVW,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_EXPLICIT\nreturn vec3(0,0,0);\n#endif\n}\n#endif\n";nt.IncludesShadersStore.imageProcessingDeclaration="#ifdef EXPOSURE\nuniform float exposureLinear;\n#endif\n#ifdef CONTRAST\nuniform float contrast;\n#endif\n#if defined(VIGNETTE) || defined(DITHER)\nuniform vec2 vInverseScreenSize;\n#endif\n#ifdef VIGNETTE\nuniform vec4 vignetteSettings1;uniform vec4 vignetteSettings2;\n#endif\n#ifdef COLORCURVES\nuniform vec4 vCameraColorCurveNegative;uniform vec4 vCameraColorCurveNeutral;uniform vec4 vCameraColorCurvePositive;\n#endif\n#ifdef COLORGRADING\n#ifdef COLORGRADING3D\nuniform highp sampler3D txColorTransform;\n#else\nuniform sampler2D txColorTransform;\n#endif\nuniform vec4 colorTransformSettings;\n#endif\n#ifdef DITHER\nuniform float ditherIntensity;\n#endif\n";nt.IncludesShadersStore.imageProcessingFunctions="#if defined(COLORGRADING) && !defined(COLORGRADING3D)\n/** \n* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.\n* sampler3dSetting.x=textureOffset (0.5/textureSize).\n* sampler3dSetting.y=textureSize.\n*/\n#define inline\nvec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)\n{float sliceSize=2.0*sampler3dSetting.x; \n#ifdef SAMPLER3DGREENDEPTH\nfloat sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;\n#else\nfloat sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;\n#endif\nfloat sliceInteger=floor(sliceContinuous);float sliceFraction=sliceContinuous-sliceInteger;\n#ifdef SAMPLER3DGREENDEPTH\nvec2 sliceUV=color.rb;\n#else\nvec2 sliceUV=color.rg;\n#endif\nsliceUV.x*=sliceSize;sliceUV.x+=sliceInteger*sliceSize;sliceUV=saturate(sliceUV);vec4 slice0Color=texture2D(colorTransform,sliceUV);sliceUV.x+=sliceSize;sliceUV=saturate(sliceUV);vec4 slice1Color=texture2D(colorTransform,sliceUV);vec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);\n#ifdef SAMPLER3DBGRMAP\ncolor.rgb=result.rgb;\n#else\ncolor.rgb=result.bgr;\n#endif\nreturn color;}\n#endif\n#ifdef TONEMAPPING_ACES\nconst mat3 ACESInputMat=mat3(\nvec3(0.59719,0.07600,0.02840),\nvec3(0.35458,0.90834,0.13383),\nvec3(0.04823,0.01566,0.83777)\n);const mat3 ACESOutputMat=mat3(\nvec3( 1.60475,-0.10208,-0.00327),\nvec3(-0.53108, 1.10813,-0.07276),\nvec3(-0.07367,-0.00605, 1.07602)\n);vec3 RRTAndODTFit(vec3 v)\n{vec3 a=v*(v+0.0245786)-0.000090537;vec3 b=v*(0.983729*v+0.4329510)+0.238081;return a/b;}\nvec3 ACESFitted(vec3 color)\n{color=ACESInputMat*color;color=RRTAndODTFit(color);color=ACESOutputMat*color;color=saturate(color);return color;}\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS\nvec4 applyImageProcessing(vec4 result) {\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART\n#ifdef EXPOSURE\nresult.rgb*=exposureLinear;\n#endif\n#ifdef VIGNETTE\nvec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;viewportXY=viewportXY*2.0-1.0;vec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);float vignetteTerm=dot(vignetteXY1,vignetteXY1);float vignette=pow(vignetteTerm,vignetteSettings2.w);vec3 vignetteColor=vignetteSettings2.rgb;\n#ifdef VIGNETTEBLENDMODEMULTIPLY\nvec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);result.rgb*=vignetteColorMultiplier;\n#endif\n#ifdef VIGNETTEBLENDMODEOPAQUE\nresult.rgb=mix(vignetteColor,result.rgb,vignette);\n#endif\n#endif\n#ifdef TONEMAPPING\n#ifdef TONEMAPPING_ACES\nresult.rgb=ACESFitted(result.rgb);\n#else\nconst float tonemappingCalibration=1.590579;result.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);\n#endif\n#endif\nresult.rgb=toGammaSpace(result.rgb);result.rgb=saturate(result.rgb);\n#ifdef CONTRAST\nvec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);if (contrast<1.0) {result.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);} else {result.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);}\n#endif\n#ifdef COLORGRADING\nvec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;\n#ifdef COLORGRADING3D\nvec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;\n#else\nvec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;\n#endif\nresult.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);\n#endif\n#ifdef COLORCURVES\nfloat luma=getLuminance(result.rgb);vec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));vec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;result.rgb*=colorCurve.rgb;result.rgb=mix(vec3(luma),result.rgb,colorCurve.a);\n#endif\n#ifdef DITHER\nfloat rand=getRand(gl_FragCoord.xy*vInverseScreenSize);float dither=mix(-ditherIntensity,ditherIntensity,rand);result.rgb=saturate(result.rgb+vec3(dither));\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND\nreturn result;}";nt.IncludesShadersStore.bumpFragmentMainFunctions="#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nuniform mat4 normalMatrix;\n#if defined(WEBGL2) || defined(WEBGPU)\nmat4 toNormalMatrix(mat4 wMatrix)\n{mat4 ret=inverse(wMatrix);ret=transpose(ret);ret[0][3]=0.;ret[1][3]=0.;ret[2][3]=0.;ret[3]=vec4(0.,0.,0.,1.);return ret;}\n#else\nmat4 toNormalMatrix(mat4 m)\n{float\na00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],\na10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],\na20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],\na30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],\nb00=a00*a11-a01*a10,\nb01=a00*a12-a02*a10,\nb02=a00*a13-a03*a10,\nb03=a01*a12-a02*a11,\nb04=a01*a13-a03*a11,\nb05=a02*a13-a03*a12,\nb06=a20*a31-a21*a30,\nb07=a20*a32-a22*a30,\nb08=a20*a33-a23*a30,\nb09=a21*a32-a22*a31,\nb10=a21*a33-a23*a31,\nb11=a22*a33-a23*a32,\ndet=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;mat4 mi=mat4(\na11*b11-a12*b10+a13*b09,\na02*b10-a01*b11-a03*b09,\na31*b05-a32*b04+a33*b03,\na22*b04-a21*b05-a23*b03,\na12*b08-a10*b11-a13*b07,\na00*b11-a02*b08+a03*b07,\na32*b02-a30*b05-a33*b01,\na20*b05-a22*b02+a23*b01,\na10*b10-a11*b08+a13*b06,\na01*b08-a00*b10-a03*b06,\na30*b04-a31*b02+a33*b00,\na21*b02-a20*b04-a23*b00,\na11*b07-a10*b09-a12*b06,\na00*b09-a01*b07+a02*b06,\na31*b01-a30*b03-a32*b00,\na20*b03-a21*b01+a22*b00)/det;return mat4(mi[0][0],mi[1][0],mi[2][0],mi[3][0],\nmi[0][1],mi[1][1],mi[2][1],mi[3][1],\nmi[0][2],mi[1][2],mi[2][2],mi[3][2],\nmi[0][3],mi[1][3],mi[2][3],mi[3][3]);}\n#endif\n#endif\nvec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)\n{\n#ifdef NORMALXYSCALE\nnormal=normalize(normal*vec3(scale,scale,1.0));\n#endif\nreturn normalize(cotangentFrame*normal);}\nvec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)\n{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}\nmat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)\n{vec3 dp1=dFdx(p);vec3 dp2=dFdy(p);vec2 duv1=dFdx(uv);vec2 duv2=dFdy(uv);vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;float det=max(dot(tangent,tangent),dot(bitangent,bitangent));float invmax=det==0.0 ? 0.0 : inversesqrt(det);return mat3(tangent*invmax,bitangent*invmax,normal);}\n#endif\n";nt.IncludesShadersStore.bumpFragmentFunctions="#if defined(BUMP)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)\n#endif\n#if defined(DETAIL)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)\n#endif\n#if defined(BUMP) && defined(PARALLAX)\nconst float minSamples=4.;const float maxSamples=15.;const int iMaxSamples=15;vec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {float parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;vec2 vOffsetDir=normalize(vViewDirCoT.xy);vec2 vMaxOffset=vOffsetDir*parallaxLimit;float numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));float stepSize=1.0/numSamples;float currRayHeight=1.0;vec2 vCurrOffset=vec2(0,0);vec2 vLastOffset=vec2(0,0);float lastSampledHeight=1.0;float currSampledHeight=1.0;bool keepWorking=true;for (int i=0; i<iMaxSamples; i++)\n{currSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;if (!keepWorking)\n{}\nelse if (currSampledHeight>currRayHeight)\n{float delta1=currSampledHeight-currRayHeight;float delta2=(currRayHeight+stepSize)-lastSampledHeight;float ratio=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}\nelse\n{currRayHeight-=stepSize;vLastOffset=vCurrOffset;\n#ifdef PARALLAX_RHS\nvCurrOffset-=stepSize*vMaxOffset;\n#else\nvCurrOffset+=stepSize*vMaxOffset;\n#endif\nlastSampledHeight=currSampledHeight;}}\nreturn vCurrOffset;}\nvec2 parallaxOffset(vec3 viewDir,float heightScale)\n{float height=texture2D(bumpSampler,vBumpUV).w;vec2 texCoordOffset=heightScale*viewDir.xy*height;\n#ifdef PARALLAX_RHS\nreturn texCoordOffset;\n#else\nreturn -texCoordOffset;\n#endif\n}\n#endif\n";nt.IncludesShadersStore.clipPlaneFragmentDeclaration="#ifdef CLIPPLANE\nvarying float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nvarying float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nvarying float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nvarying float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nvarying float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nvarying float fClipDistance6;\n#endif\n";nt.IncludesShadersStore.logDepthDeclaration="#ifdef LOGARITHMICDEPTH\nuniform float logarithmicDepthConstant;varying float vFragmentDepth;\n#endif\n";nt.IncludesShadersStore.fogFragmentDeclaration="#ifdef FOG\n#define FOGMODE_NONE 0.\n#define FOGMODE_EXP 1.\n#define FOGMODE_EXP2 2.\n#define FOGMODE_LINEAR 3.\n#define E 2.71828\nuniform vec4 vFogInfos;uniform vec3 vFogColor;varying vec3 vFogDistance;float CalcFogFactor()\n{float fogCoeff=1.0;float fogStart=vFogInfos.y;float fogEnd=vFogInfos.z;float fogDensity=vFogInfos.w;float fogDistance=length(vFogDistance);if (FOGMODE_LINEAR==vFogInfos.x)\n{fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);}\nelse if (FOGMODE_EXP==vFogInfos.x)\n{fogCoeff=1.0/pow(E,fogDistance*fogDensity);}\nelse if (FOGMODE_EXP2==vFogInfos.x)\n{fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);}\nreturn clamp(fogCoeff,0.0,1.0);}\n#endif\n";nt.IncludesShadersStore.clipPlaneFragment="#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nif (false) {}\n#endif\n#ifdef CLIPPLANE\nelse if (fClipDistance>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE2\nelse if (fClipDistance2>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE3\nelse if (fClipDistance3>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE4\nelse if (fClipDistance4>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE5\nelse if (fClipDistance5>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE6\nelse if (fClipDistance6>0.0)\n{discard;}\n#endif\n";nt.IncludesShadersStore.bumpFragment="vec2 uvOffset=vec2(0.0,0.0);\n#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)\n#ifdef NORMALXYSCALE\nfloat normalScale=1.0;\n#elif defined(BUMP)\nfloat normalScale=vBumpInfos.y;\n#else\nfloat normalScale=1.0;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#elif defined(BUMP)\nvec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);\n#else\nvec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));\n#endif\n#elif defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#else\nvec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;mat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));\n#endif\n#endif\n#ifdef PARALLAX\nmat3 invTBN=transposeMat3(TBN);\n#ifdef PARALLAXOCCLUSION\nuvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);\n#else\nuvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);\n#endif\n#endif\n#ifdef DETAIL\nvec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);vec2 detailNormalRG=detailColor.wy*2.0-1.0;float detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));vec3 detailNormal=vec3(detailNormalRG,detailNormalB);\n#endif\n#ifdef BUMP\n#ifdef OBJECTSPACE_NORMALMAP\n#define CUSTOM_FRAGMENT_BUMP_FRAGMENT\nnormalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);normalW=normalize(mat3(normalMatrix)*normalW);\n#elif !defined(DETAIL)\nnormalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);\n#else\nvec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;\n#if DETAIL_NORMALBLENDMETHOD==0 \ndetailNormal.xy*=vDetailInfos.z;vec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));\n#elif DETAIL_NORMALBLENDMETHOD==1 \ndetailNormal.xy*=vDetailInfos.z;bumpNormal+=vec3(0.0,0.0,1.0);detailNormal*=vec3(-1.0,-1.0,1.0);vec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;\n#endif\nnormalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);\n#endif\n#elif defined(DETAIL)\ndetailNormal.xy*=vDetailInfos.z;normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);\n#endif\n";nt.IncludesShadersStore.decalFragment="#ifdef DECAL\n#ifdef GAMMADECAL\ndecalColor.rgb=toLinearSpace(decalColor.rgb);\n#endif\n#ifdef DECAL_SMOOTHALPHA\ndecalColor.a*=decalColor.a;\n#endif\nsurfaceAlbedo.rgb=mix(surfaceAlbedo.rgb,decalColor.rgb,decalColor.a);\n#endif\n";nt.IncludesShadersStore.depthPrePass="#ifdef DEPTHPREPASS\ngl_FragColor=vec4(0.,0.,0.,1.0);return;\n#endif\n";nt.IncludesShadersStore.lightFragment="#ifdef LIGHT{X}\n#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})\n#else\n#ifdef PBR\n#ifdef SPOTLIGHT{X}\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(POINTLIGHT{X})\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(HEMILIGHT{X})\npreInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(DIRLIGHT{X})\npreInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#endif\npreInfo.NdotV=NdotV;\n#ifdef SPOTLIGHT{X}\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#endif\n#elif defined(POINTLIGHT{X})\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\n#endif\n#else\npreInfo.attenuation=1.0;\n#endif\n#ifdef HEMILIGHT{X}\npreInfo.roughness=roughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\n#ifdef IRIDESCENCE\npreInfo.iridescenceIntensity=iridescenceIntensity;\n#endif\n#ifdef HEMILIGHT{X}\ninfo.diffuse=computeHemisphericDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb,light{X}.vLightGround);\n#elif defined(SS_TRANSLUCENCY)\ninfo.diffuse=computeDiffuseAndTransmittedLighting(preInfo,light{X}.vLightDiffuse.rgb,subSurfaceOut.transmittance);\n#else\ninfo.diffuse=computeDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb);\n#endif\n#ifdef SPECULARTERM\n#ifdef ANISOTROPIC\ninfo.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);\n#else\ninfo.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);\n#endif\n#endif\n#ifdef SHEEN\n#ifdef SHEEN_LINKWITHALBEDO\npreInfo.roughness=sheenOut.sheenIntensity;\n#else\n#ifdef HEMILIGHT{X}\npreInfo.roughness=sheenOut.sheenRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\n#endif\ninfo.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);\n#endif\n#ifdef CLEARCOAT\n#ifdef HEMILIGHT{X}\npreInfo.roughness=clearcoatOut.clearCoatRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\ninfo.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light{X}.vLightDiffuse.rgb);\n#ifdef CLEARCOAT_TINT\nabsorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;\n#ifdef SPECULARTERM\ninfo.specular*=absorption;\n#endif\n#endif\ninfo.diffuse*=info.clearCoat.w;\n#ifdef SPECULARTERM\ninfo.specular*=info.clearCoat.w;\n#endif\n#ifdef SHEEN\ninfo.sheen*=info.clearCoat.w;\n#endif\n#endif\n#else\n#ifdef SPOTLIGHT{X}\ninfo=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);\n#elif defined(HEMILIGHT{X})\ninfo=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);\n#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);\n#endif\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\ninfo.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightSampler{X},textureProjectionMatrix{X});\n#endif\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nfor (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) \n{\n#ifdef SHADOWCSM_RIGHTHANDED{X}\ndiff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;\n#else\ndiff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;\n#endif\nif (diff{X}>=0.) {index{X}=i;break;}}\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nif (index{X}>=0)\n#endif\n{\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#else\nshadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#endif\n#else\nshadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];\n#endif\n#ifndef SHADOWCSMNOBLEND{X}\nfloat frustumLength=frustumLengths{X}[index{X}];float diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)\n{index{X}+=1;float nextShadow=0.;\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nnextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#else\nnextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#endif\n#else\nnextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\nshadow=mix(nextShadow,shadow,diffRatio);\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);\n#endif\n}\n#endif\n}\n#elif defined(SHADOWCLOSEESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithCloseESMCube(vPositionW,light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithESMCube(vPositionW,light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPOISSON{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithPoissonSamplingCube(vPositionW,light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#else\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowCube(vPositionW,light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#endif\n#ifdef SHADOWONLY\n#ifndef SHADOWINUSE\n#define SHADOWINUSE\n#endif\nglobalShadow+=shadow;shadowLightCount+=1.0;\n#endif\n#else\nshadow=1.;\n#endif\naggShadow+=shadow;numLights+=1.0;\n#ifndef SHADOWONLY\n#ifdef CUSTOMUSERLIGHTING\ndiffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);\n#ifdef SPECULARTERM\nspecularBase+=computeCustomSpecularLighting(info,specularBase,shadow);\n#endif\n#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})\ndiffuseBase+=lightmapColor.rgb*shadow;\n#ifdef SPECULARTERM\n#ifndef LIGHTMAPNOSPECULAR{X}\nspecularBase+=info.specular*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifndef LIGHTMAPNOSPECULAR{X}\nclearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef SHEEN\n#ifndef LIGHTMAPNOSPECULAR{X}\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#else\n#ifdef SHADOWCSMDEBUG{X}\ndiffuseBase+=info.diffuse*shadowDebug{X};\n#else \ndiffuseBase+=info.diffuse*shadow;\n#endif\n#ifdef SPECULARTERM\nspecularBase+=info.specular*shadow;\n#endif\n#ifdef CLEARCOAT\nclearCoatBase+=info.clearCoat.rgb*shadow;\n#endif\n#ifdef SHEEN\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#endif\n#endif\n";nt.IncludesShadersStore.logDepthFragment="#ifdef LOGARITHMICDEPTH\ngl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;\n#endif\n";nt.IncludesShadersStore.fogFragment="#ifdef FOG\nfloat fog=CalcFogFactor();\n#ifdef PBR\nfog=toLinearSpace(fog);\n#endif\ncolor.rgb=mix(vFogColor,color.rgb,fog);\n#endif\n";nt.IncludesShadersStore.oitFragment="#ifdef ORDER_INDEPENDENT_TRANSPARENCY\nfloat fragDepth=gl_FragCoord.z; \n#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS\nuint halfFloat=packHalf2x16(vec2(fragDepth));vec2 full=unpackHalf2x16(halfFloat);fragDepth=full.x;\n#endif\nivec2 fragCoord=ivec2(gl_FragCoord.xy);vec2 lastDepth=texelFetch(oitDepthSampler,fragCoord,0).rg;vec4 lastFrontColor=texelFetch(oitFrontColorSampler,fragCoord,0);depth.rg=vec2(-MAX_DEPTH);frontColor=lastFrontColor;backColor=vec4(0.0);\n#ifdef USE_REVERSE_DEPTHBUFFER\nfloat furthestDepth=-lastDepth.x;float nearestDepth=lastDepth.y;\n#else\nfloat nearestDepth=-lastDepth.x;float furthestDepth=lastDepth.y;\n#endif\nfloat alphaMultiplier=1.0-lastFrontColor.a;\n#ifdef USE_REVERSE_DEPTHBUFFER\nif (fragDepth>nearestDepth || fragDepth<furthestDepth) {\n#else\nif (fragDepth<nearestDepth || fragDepth>furthestDepth) {\n#endif\nreturn;}\n#ifdef USE_REVERSE_DEPTHBUFFER\nif (fragDepth<nearestDepth && fragDepth>furthestDepth) {\n#else\nif (fragDepth>nearestDepth && fragDepth<furthestDepth) {\n#endif\ndepth.rg=vec2(-fragDepth,fragDepth);return;}\n#endif\n";nt.ShadersStore.defaultPixelShader="#include<__decl__defaultFragment>\n#if defined(BUMP) || !defined(NORMAL)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\n#include<oitDeclaration>\n#define CUSTOM_FRAGMENT_BEGIN\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#include<helperFunctions>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)\n#ifdef REFRACTION\n#ifdef REFRACTIONMAP_3D\nuniform samplerCube refractionCubeSampler;\n#else\nuniform sampler2D refraction2DSampler;\n#endif\n#endif\n#if defined(SPECULARTERM)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)\n#endif\n#include<fresnelFunction>\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nuniform samplerCube reflectionCubeSampler;\n#else\nuniform sampler2D reflection2DSampler;\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#include<imageProcessingDeclaration>\n#include<imageProcessingFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);vec4 baseColor=vec4(1.,1.,1.,1.);vec3 diffuseColor=vDiffuseColor.rgb;float alpha=vDiffuseColor.a;\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));\n#endif\n#include<bumpFragment>\n#ifdef TWOSIDEDLIGHTING\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n#ifdef DIFFUSE\nbaseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);\n#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)\nif (baseColor.a<alphaCutOff)\ndiscard;\n#endif\n#ifdef ALPHAFROMDIFFUSE\nalpha*=baseColor.a;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\nbaseColor.rgb*=vDiffuseInfos.y;\n#endif\n#if defined(DECAL) && !defined(DECAL_AFTER_DETAIL)\nvec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);\n#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)\n#endif\n#include<depthPrePass>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nbaseColor.rgb*=vColor.rgb;\n#endif\n#ifdef DETAIL\nbaseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);\n#endif\n#if defined(DECAL) && defined(DECAL_AFTER_DETAIL)\nvec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);\n#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE\nvec3 baseAmbientColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nbaseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\n#ifdef SPECULARTERM\nfloat glossiness=vSpecularColor.a;vec3 specularColor=vSpecularColor.rgb;\n#ifdef SPECULAR\nvec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);specularColor=specularMapColor.rgb;\n#ifdef GLOSSINESS\nglossiness=glossiness*specularMapColor.a;\n#endif\n#endif\n#else\nfloat glossiness=0.;\n#endif\nvec3 diffuseBase=vec3(0.,0.,0.);lightingInfo info;\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\nfloat shadow=1.;float aggShadow=0.;float numLights=0.;\n#ifdef LIGHTMAP\nvec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor.rgb=fromRGBD(lightmapColor);\n#endif\nlightmapColor.rgb*=vLightmapInfos.y;\n#endif\n#include<lightFragment>[0..maxSimultaneousLights]\naggShadow=aggShadow/numLights;vec4 refractionColor=vec4(0.,0.,0.,1.);\n#ifdef REFRACTION\nvec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));\n#ifdef REFRACTIONMAP_3D\n#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;vec4 refractionLookup=textureCube(refractionCubeSampler,refractionVector);if (dot(refractionVector,viewDirectionW)<1.0) {refractionColor=refractionLookup;}\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;refractionColor=texture2D(refraction2DSampler,refractionCoords);\n#endif\n#ifdef RGBDREFRACTION\nrefractionColor.rgb=fromRGBD(refractionColor);\n#endif\n#ifdef IS_REFRACTION_LINEAR\nrefractionColor.rgb=toGammaSpace(refractionColor.rgb);\n#endif\nrefractionColor.rgb*=vRefractionInfos.x;\n#endif\nvec4 reflectionColor=vec4(0.,0.,0.,1.);\n#ifdef REFLECTION\nvec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nvReflectionUVW.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\n#ifdef ROUGHNESS\nfloat bias=vReflectionInfos.y;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\n#ifdef GLOSSINESS\nbias*=(1.0-specularMapColor.a);\n#endif\n#endif\n#endif\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);\n#else\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);\n#endif\n#else\nvec2 coords=vReflectionUVW.xy;\n#ifdef REFLECTIONMAP_PROJECTION\ncoords/=vReflectionUVW.z;\n#endif\ncoords.y=1.0-coords.y;reflectionColor=texture2D(reflection2DSampler,coords);\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor.rgb=fromRGBD(reflectionColor);\n#endif\n#ifdef IS_REFLECTION_LINEAR\nreflectionColor.rgb=toGammaSpace(reflectionColor.rgb);\n#endif\nreflectionColor.rgb*=vReflectionInfos.x;\n#ifdef REFLECTIONFRESNEL\nfloat reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);\n#ifdef REFLECTIONFRESNELFROMSPECULAR\n#ifdef SPECULARTERM\nreflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#else\nreflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#else\nreflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#endif\n#endif\n#ifdef REFRACTIONFRESNEL\nfloat refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);refractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nopacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;\n#else\nalpha*=opacityMap.a*vOpacityInfos.y;\n#endif\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=vColor.a;\n#endif\n#ifdef OPACITYFRESNEL\nfloat opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);alpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;\n#endif\n#ifdef ALPHATEST\n#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS\nif (alpha<alphaCutOff)\ndiscard;\n#endif\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\nvec3 emissiveColor=vEmissiveColor;\n#ifdef EMISSIVE\nemissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;\n#endif\n#ifdef EMISSIVEFRESNEL\nfloat emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);emissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;\n#endif\n#ifdef DIFFUSEFRESNEL\nfloat diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);diffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#endif\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase*specularColor;\n#ifdef SPECULAROVERALPHA\nalpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#else\nvec3 finalSpecular=vec3(0.0);\n#endif\n#ifdef REFLECTIONOVERALPHA\nalpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);\n#else\nvec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);\n#endif\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\ncolor.rgb*=lightmapColor.rgb;\n#else\ncolor.rgb+=lightmapColor.rgb;\n#endif\n#endif\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FOG\ncolor.rgb=max(color.rgb,0.);\n#include<logDepthFragment>\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\ncolor.rgb=toLinearSpace(color.rgb);\n#else\n#ifdef IMAGEPROCESSING\ncolor.rgb=toLinearSpace(color.rgb);color=applyImageProcessing(color);\n#endif\n#endif\ncolor.a*=visibility;\n#ifdef PREMULTIPLYALPHA\ncolor.rgb*=color.a;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\nfloat writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;gl_FragData[0]=color; \n#ifdef PREPASS_POSITION\ngl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_VELOCITY\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_IRRADIANCE\ngl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_DEPTH\ngl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_NORMAL\n#ifdef PREPASS_NORMAL_WORLDSPACE\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo); \n#else\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo); \n#endif\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\ngl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_REFLECTIVITY\n#if defined(SPECULARTERM)\n#if defined(SPECULAR)\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularMapColor))*writeGeometryInfo; \n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularColor),1.0)*writeGeometryInfo;\n#endif\n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(0.0,0.0,0.0,1.0)*writeGeometryInfo;\n#endif\n#endif\n#endif\n#if !defined(PREPASS) || defined(WEBGL2)\ngl_FragColor=color;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {frontColor.rgb+=color.rgb*color.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-color.a);} else {backColor+=color;}\n#endif\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";nt.IncludesShadersStore.decalVertexDeclaration="#ifdef DECAL\nuniform vec4 vDecalInfos;uniform mat4 decalMatrix;\n#endif\n";nt.IncludesShadersStore.defaultVertexDeclaration="uniform mat4 viewProjection;uniform mat4 view;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;uniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;uniform mat4 specularMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform mat4 bumpMatrix;\n#endif\n#ifdef REFLECTION\nuniform mat4 reflectionMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;uniform mat4 detailMatrix;\n#endif\n#include<decalVertexDeclaration>\n#define ADDITIONAL_VERTEX_DECLARATION\n";nt.IncludesShadersStore.uvAttributeDeclaration="#ifdef UV{X}\nattribute vec2 uv{X};\n#endif\n";nt.IncludesShadersStore.bonesDeclaration="#if NUM_BONE_INFLUENCERS>0\nattribute vec4 matricesIndices;attribute vec4 matricesWeights;\n#if NUM_BONE_INFLUENCERS>4\nattribute vec4 matricesIndicesExtra;attribute vec4 matricesWeightsExtra;\n#endif\n#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#ifdef BONETEXTURE\nuniform highp sampler2D boneSampler;uniform float boneTextureWidth;\n#else\nuniform mat4 mBones[BonesPerMesh];\n#endif\n#ifdef BONES_VELOCITY_ENABLED\nuniform mat4 mPreviousBones[BonesPerMesh];\n#endif\n#ifdef BONETEXTURE\n#define inline\nmat4 readMatrixFromRawSampler(sampler2D smp,float index)\n{float offset=index *4.0;float dx=1.0/boneTextureWidth;vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),0.));vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),0.));vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),0.));vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),0.));return mat4(m0,m1,m2,m3);}\n#endif\n#endif\n#endif\n";nt.IncludesShadersStore.bakedVertexAnimationDeclaration="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\nuniform float bakedVertexAnimationTime;uniform vec2 bakedVertexAnimationTextureSizeInverted;uniform vec4 bakedVertexAnimationSettings;uniform sampler2D bakedVertexAnimationTexture;\n#ifdef INSTANCES\nattribute vec4 bakedVertexAnimationSettingsInstanced;\n#endif\n#define inline\nmat4 readMatrixFromRawSamplerVAT(sampler2D smp,float index,float frame)\n{float offset=index*4.0;float frameUV=(frame+0.5)*bakedVertexAnimationTextureSizeInverted.y;float dx=bakedVertexAnimationTextureSizeInverted.x;vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),frameUV));vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),frameUV));vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),frameUV));vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),frameUV));return mat4(m0,m1,m2,m3);}\n#endif\n";nt.IncludesShadersStore.instancesDeclaration="#ifdef INSTANCES\nattribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;\n#ifdef INSTANCESCOLOR\nattribute vec4 instanceColor;\n#endif\n#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)\nuniform mat4 world;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY)\nattribute vec4 previousWorld0;attribute vec4 previousWorld1;attribute vec4 previousWorld2;attribute vec4 previousWorld3;\n#ifdef THIN_INSTANCES\nuniform mat4 previousWorld;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nuniform mat4 world;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY)\nuniform mat4 previousWorld;\n#endif\n#endif\n";nt.IncludesShadersStore.prePassVertexDeclaration="#ifdef PREPASS\n#ifdef PREPASS_DEPTH\nvarying vec3 vViewPos;\n#endif\n#ifdef PREPASS_VELOCITY\nuniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;\n#endif\n#endif\n";nt.IncludesShadersStore.samplerVertexDeclaration="#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0\nvarying vec2 v_VARYINGNAME_UV;\n#endif\n";nt.IncludesShadersStore.bumpVertexDeclaration="#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#endif\n";nt.IncludesShadersStore.clipPlaneVertexDeclaration="#ifdef CLIPPLANE\nuniform vec4 vClipPlane;varying float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nuniform vec4 vClipPlane2;varying float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nuniform vec4 vClipPlane3;varying float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nuniform vec4 vClipPlane4;varying float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nuniform vec4 vClipPlane5;varying float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nuniform vec4 vClipPlane6;varying float fClipDistance6;\n#endif\n";nt.IncludesShadersStore.fogVertexDeclaration="#ifdef FOG\nvarying vec3 vFogDistance;\n#endif\n";nt.IncludesShadersStore.lightVxFragmentDeclaration="#ifdef LIGHT{X}\nuniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec4 vLightSpecular{X};\n#else\nvec4 vLightSpecular{X}=vec4(0.);\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};\n#elif defined(SHADOWCUBE{X})\n#else\nvarying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};\n#endif\nuniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};\n#elif defined(POINTLIGHT{X})\nuniform vec4 vLightFalloff{X};\n#elif defined(HEMILIGHT{X})\nuniform vec3 vLightGround{X};\n#endif\n#endif\n";nt.IncludesShadersStore.lightVxUboDeclaration="#ifdef LIGHT{X}\nuniform Light{X}\n{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;\n#ifdef SPOTLIGHT{X}\nvec4 vLightDirection;vec4 vLightFalloff;\n#elif defined(POINTLIGHT{X})\nvec4 vLightFalloff;\n#elif defined(HEMILIGHT{X})\nvec3 vLightGround;\n#endif\nvec4 shadowsInfo;vec2 depthValues;} light{X};\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};\n#elif defined(SHADOWCUBE{X})\n#else\nvarying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};\n#endif\n#endif\n#endif\n";nt.IncludesShadersStore.morphTargetsVertexGlobalDeclaration="#ifdef MORPHTARGETS\nuniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];\n#ifdef MORPHTARGETS_TEXTURE \nuniform float morphTargetTextureIndices[NUM_MORPH_INFLUENCERS];uniform vec3 morphTargetTextureInfo;uniform highp sampler2DArray morphTargets;vec3 readVector3FromRawSampler(int targetIndex,float vertexIndex)\n{ \nfloat y=floor(vertexIndex/morphTargetTextureInfo.y);float x=vertexIndex-y*morphTargetTextureInfo.y;vec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);return texture(morphTargets,textureUV).xyz;}\n#endif\n#endif\n";nt.IncludesShadersStore.morphTargetsVertexDeclaration="#ifdef MORPHTARGETS\n#ifndef MORPHTARGETS_TEXTURE\nattribute vec3 position{X};\n#ifdef MORPHTARGETS_NORMAL\nattribute vec3 normal{X};\n#endif\n#ifdef MORPHTARGETS_TANGENT\nattribute vec3 tangent{X};\n#endif\n#ifdef MORPHTARGETS_UV\nattribute vec2 uv_{X};\n#endif\n#endif\n#endif\n";nt.IncludesShadersStore.morphTargetsVertexGlobal="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE\nfloat vertexID;\n#endif\n#endif\n";nt.IncludesShadersStore.morphTargetsVertex="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE \nvertexID=float(gl_VertexID)*morphTargetTextureInfo.x;positionUpdated+=(readVector3FromRawSampler({X},vertexID)-position)*morphTargetInfluences[{X}];vertexID+=1.0;\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(readVector3FromRawSampler({X},vertexID) -normal)*morphTargetInfluences[{X}];vertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated+=(readVector3FromRawSampler({X},vertexID).xy-uv)*morphTargetInfluences[{X}];vertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz+=(readVector3FromRawSampler({X},vertexID) -tangent.xyz)*morphTargetInfluences[{X}];\n#endif\n#else\npositionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated+=(uv_{X}-uv)*morphTargetInfluences[{X}];\n#endif\n#endif\n#endif\n";nt.IncludesShadersStore.instancesVertex="#ifdef INSTANCES\nmat4 finalWorld=mat4(world0,world1,world2,world3);\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nmat4 finalPreviousWorld=mat4(previousWorld0,previousWorld1,previousWorld2,previousWorld3);\n#endif\n#ifdef THIN_INSTANCES\nfinalWorld=world*finalWorld;\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nfinalPreviousWorld=previousWorld*finalPreviousWorld;\n#endif\n#endif\n#else\nmat4 finalWorld=world;\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nmat4 finalPreviousWorld=previousWorld;\n#endif\n#endif\n";nt.IncludesShadersStore.bonesVertex="#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#if NUM_BONE_INFLUENCERS>0\nmat4 influence;\n#ifdef BONETEXTURE\ninfluence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];\n#endif\n#else\ninfluence=mBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=mBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\ninfluence+=mBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\ninfluence+=mBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\ninfluence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\ninfluence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\ninfluence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\ninfluence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\n#endif\nfinalWorld=finalWorld*influence;\n#endif\n#endif\n";nt.IncludesShadersStore.bakedVertexAnimation="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\n{\n#ifdef INSTANCES\n#define BVASNAME bakedVertexAnimationSettingsInstanced\n#else\n#define BVASNAME bakedVertexAnimationSettings\n#endif\nfloat VATStartFrame=BVASNAME.x;float VATEndFrame=BVASNAME.y;float VATOffsetFrame=BVASNAME.z;float VATSpeed=BVASNAME.w;float totalFrames=VATEndFrame-VATStartFrame+1.0;float time=bakedVertexAnimationTime*VATSpeed/totalFrames;float frameCorrection=time<1.0 ? 0.0 : 1.0;float numOfFrames=totalFrames-frameCorrection;float VATFrameNum=fract(time)*numOfFrames;VATFrameNum=mod(VATFrameNum+VATOffsetFrame,numOfFrames);VATFrameNum=floor(VATFrameNum);VATFrameNum+=VATStartFrame+frameCorrection;mat4 VATInfluence;VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];\n#endif\nfinalWorld=finalWorld*VATInfluence;}\n#endif\n";nt.IncludesShadersStore.prePassVertex="#ifdef PREPASS_DEPTH\nvViewPos=(view*worldPos).rgb;\n#endif\n#if defined(PREPASS_VELOCITY) && defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*worldPos;\n#if NUM_BONE_INFLUENCERS>0\nmat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\npreviousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\npreviousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\npreviousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\nvPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);\n#else\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#endif\n";nt.IncludesShadersStore.uvVariableDeclaration="#if !defined(UV{X}) && defined(MAINUV{X})\nvec2 uv{X}=vec2(0.,0.);\n#endif\n#ifdef MAINUV{X}\nvMainUV{X}=uv{X};\n#endif\n";nt.IncludesShadersStore.samplerVertexImplementation="#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0\nif (v_INFONAME_==0.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uvUpdated,1.0,0.0));}\n#ifdef UV2\nelse if (v_INFONAME_==1.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv2,1.0,0.0));}\n#endif\n#ifdef UV3\nelse if (v_INFONAME_==2.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv3,1.0,0.0));}\n#endif\n#ifdef UV4\nelse if (v_INFONAME_==3.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv4,1.0,0.0));}\n#endif\n#ifdef UV5\nelse if (v_INFONAME_==4.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv5,1.0,0.0));}\n#endif\n#ifdef UV6\nelse if (v_INFONAME_==5.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv6,1.0,0.0));}\n#endif\n#endif\n";nt.IncludesShadersStore.bumpVertex="#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nvec3 tbnNormal=normalize(normalUpdated);vec3 tbnTangent=normalize(tangentUpdated.xyz);vec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;vTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);\n#endif\n#endif\n";nt.IncludesShadersStore.clipPlaneVertex="#ifdef CLIPPLANE\nfClipDistance=dot(worldPos,vClipPlane);\n#endif\n#ifdef CLIPPLANE2\nfClipDistance2=dot(worldPos,vClipPlane2);\n#endif\n#ifdef CLIPPLANE3\nfClipDistance3=dot(worldPos,vClipPlane3);\n#endif\n#ifdef CLIPPLANE4\nfClipDistance4=dot(worldPos,vClipPlane4);\n#endif\n#ifdef CLIPPLANE5\nfClipDistance5=dot(worldPos,vClipPlane5);\n#endif\n#ifdef CLIPPLANE6\nfClipDistance6=dot(worldPos,vClipPlane6);\n#endif\n";nt.IncludesShadersStore.fogVertex="#ifdef FOG\nvFogDistance=(view*worldPos).xyz;\n#endif\n";nt.IncludesShadersStore.shadowsVertex="#ifdef SHADOWS\n#if defined(SHADOWCSM{X})\nvPositionFromCamera{X}=view*worldPos;for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {vPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n}\n#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})\nvPositionFromLight{X}=lightMatrix{X}*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif\n#endif\n";nt.IncludesShadersStore.vertexColorMixing="#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvColor=vec4(1.0);\n#ifdef VERTEXCOLOR\n#ifdef VERTEXALPHA\nvColor*=color;\n#else\nvColor.rgb*=color.rgb;\n#endif\n#endif\n#ifdef INSTANCESCOLOR\nvColor*=instanceColor;\n#endif\n#endif\n";nt.IncludesShadersStore.pointCloudVertex="#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n";nt.IncludesShadersStore.logDepthVertex="#ifdef LOGARITHMICDEPTH\nvFragmentDepth=1.0+gl_Position.w;gl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;\n#endif\n";nt.ShadersStore.defaultVertexShader="#include<__decl__defaultVertex>\n#define CUSTOM_VERTEX_BEGIN\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<mainUVVaryingDeclaration>[1..7]\n#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#if defined(SPECULARTERM)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)\n#endif\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\nvPositionW=vec3(worldPos);\n#include<prePassVertex>\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n#ifndef UV1\nvec2 uvUpdated=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uvUpdated;\n#endif\n#include<uvVariableDeclaration>[2..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#if defined(SPECULARTERM)\n#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)\n#endif\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#include<pointCloudVertex>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n";const Pa=new RegExp("^([gimus]+)!");class Ma{constructor(e){this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=e,this._scene=e.getScene(),this._engine=this._scene.getEngine()}_addPlugin(e){for(let t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e.name)return!1;if(this._material._uniformBufferLayoutBuilt)throw`The plugin "${e.name}" can't be added to the material "${this._material.name}" because this material has already been used for rendering! Please add plugins to materials before any rendering with this material occurs.`;const t=e.getClassName();Ma._MaterialPluginClassToMainDefine[t]||(Ma._MaterialPluginClassToMainDefine[t]="MATERIALPLUGIN_"+ ++Ma._MaterialPluginCounter),this._material._callbackPluginEventGeneric=(e,t)=>this._handlePluginEvent(e,t),this._plugins.push(e),this._plugins.sort(((e,t)=>e.priority-t.priority)),this._codeInjectionPoints={};const i={};i[Ma._MaterialPluginClassToMainDefine[t]]={type:"boolean",default:!0};for(const e of this._plugins)e.collectDefines(i),this._collectPointNames("vertex",e.getCustomCode("vertex")),this._collectPointNames("fragment",e.getCustomCode("fragment"));return this._defineNamesFromPlugins=i,!0}_activatePlugin(e){-1===this._activePlugins.indexOf(e)&&(this._activePlugins.push(e),this._activePlugins.sort(((e,t)=>e.priority-t.priority)),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefinesBeforeAttributes=this._handlePluginEventPrepareDefinesBeforeAttributes.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),e.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(e),this._activePluginsForExtraEvents.sort(((e,t)=>e.priority-t.priority)),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)))}getPlugin(e){for(let t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e)return this._plugins[t];return null}_handlePluginEventIsReadyForSubMesh(e){let t=!0;for(const i of this._activePlugins)t=t&&i.isReadyForSubMesh(e.defines,this._scene,this._engine,e.subMesh);e.isReadyForSubMesh=t}_handlePluginEventPrepareDefinesBeforeAttributes(e){for(const t of this._activePlugins)t.prepareDefinesBeforeAttributes(e.defines,this._scene,e.mesh)}_handlePluginEventPrepareDefines(e){for(const t of this._activePlugins)t.prepareDefines(e.defines,this._scene,e.mesh)}_handlePluginEventHardBindForSubMesh(e){for(const t of this._activePluginsForExtraEvents)t.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventBindForSubMesh(e){for(const t of this._activePlugins)t.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventHasRenderTargetTextures(e){let t=!1;for(const e of this._activePluginsForExtraEvents)if(t=e.hasRenderTargetTextures(),t)break;e.hasRenderTargetTextures=t}_handlePluginEventFillRenderTargetTextures(e){for(const t of this._activePluginsForExtraEvents)t.fillRenderTargetTextures(e.renderTargets)}_handlePluginEvent(e,t){var i;switch(e){case Ys.GetActiveTextures:{const e=t;for(const t of this._activePlugins)t.getActiveTextures(e.activeTextures);break}case Ys.GetAnimatables:{const e=t;for(const t of this._activePlugins)t.getAnimatables(e.animatables);break}case Ys.HasTexture:{const e=t;let i=!1;for(const t of this._activePlugins)if(i=t.hasTexture(e.texture),i)break;e.hasTexture=i;break}case Ys.Disposed:{const e=t;for(const t of this._plugins)t.dispose(e.forceDisposeTextures);break}case Ys.GetDefineNames:t.defineNames=this._defineNamesFromPlugins;break;case Ys.PrepareEffect:{const e=t;for(const t of this._activePlugins)e.fallbackRank=t.addFallbacks(e.defines,e.fallbacks,e.fallbackRank),t.getAttributes(e.attributes,this._scene,e.mesh);this._uniformList.length>0&&e.uniforms.push(...this._uniformList),this._samplerList.length>0&&e.samplers.push(...this._samplerList),this._uboList.length>0&&e.uniformBuffersNames.push(...this._uboList),e.customCode=this._injectCustomCode(e,e.customCode);break}case Ys.PrepareUniformBuffer:{const e=t;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];for(const t of this._plugins){const s=t.getUniforms();if(s){if(s.ubo)for(const t of s.ubo){if(t.size&&t.type){const s=null!==(i=t.arraySize)&&void 0!==i?i:0;e.ubo.addUniform(t.name,t.size,s),this._uboDeclaration+=`${t.type} ${t.name}${s>0?`[${s}]`:""};\n`}this._uniformList.push(t.name)}s.vertex&&(this._vertexDeclaration+=s.vertex+"\n"),s.fragment&&(this._fragmentDeclaration+=s.fragment+"\n")}t.getSamplers(this._samplerList),t.getUniformBuffersNames(this._uboList)}break}}}_collectPointNames(e,t){if(t)for(const i in t)this._codeInjectionPoints[e]||(this._codeInjectionPoints[e]={}),this._codeInjectionPoints[e][i]=!0}_injectCustomCode(e,t){return(i,s)=>{var r,n;t&&(s=t(i,s)),this._uboDeclaration&&(s=s.replace("#define ADDITIONAL_UBO_DECLARATION",this._uboDeclaration)),this._vertexDeclaration&&(s=s.replace("#define ADDITIONAL_VERTEX_DECLARATION",this._vertexDeclaration)),this._fragmentDeclaration&&(s=s.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",this._fragmentDeclaration));const o=null===(r=this._codeInjectionPoints)||void 0===r?void 0:r[i];if(!o)return s;let a=null;for(let t in o){let r="";for(const s of this._activePlugins){let o=null===(n=s.getCustomCode(i))||void 0===n?void 0:n[t];if(o){if(s.resolveIncludes){if(null===a){const t=qe.GLSL;a={defines:[],indexParameters:e.indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:void 0,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:nt.GetShadersRepository(t),includesShadersStore:nt.GetIncludesShadersStore(t),version:void 0,platformName:this._engine.shaderPlatformName,processingContext:void 0,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:void 0}}a.isFragment="fragment"===i,rt._ProcessIncludes(o,a,(e=>o=e))}r+=o+"\n"}}if(r.length>0)if("!"===t.charAt(0)){t=t.substring(1);let e="g";if("!"===t.charAt(0))e="",t=t.substring(1);else{const i=Pa.exec(t);i&&i.length>=2&&(e=i[1],t=t.substring(e.length+1))}e.indexOf("g")<0&&(e+="g");const i=s,n=new RegExp(t,e);let o=n.exec(i);for(;null!==o;){let e=r;for(let t=0;t<o.length;++t)e=e.replace("$"+t,o[t]);s=s.replace(o[0],e),o=n.exec(i)}}else{const e="#define "+t;s=s.replace(e,"\n"+r+"\n"+e)}}return s}}}Ma._MaterialPluginClassToMainDefine={},Ma._MaterialPluginCounter=0,x.OnEnginesDisposedObservable.add((()=>{Oa.length=0,Da=!1,sr.OnEventObservable.remove(Na),Na=null}));const Oa=[];let Da=!1,Na=null;class Fa{_enable(e){e&&this._pluginManager._activatePlugin(this)}constructor(e,t,i,s,r=!0,n=!1,o=!1){this.priority=500,this.resolveIncludes=!1,this.registerForExtraEvents=!1,this._material=e,this.name=t,this.priority=i,this.resolveIncludes=o,e.pluginManager||(e.pluginManager=new Ma(e),e.onDisposeObservable.add((()=>{e.pluginManager=void 0}))),this._pluginDefineNames=s,this._pluginManager=e.pluginManager,r&&this._pluginManager._addPlugin(this),n&&this._enable(!0),this.markAllDefinesAsDirty=e._dirtyCallbacks[63]}getClassName(){return"MaterialPluginBase"}isReadyForSubMesh(e,t,i,s){return!0}hardBindForSubMesh(e,t,i,s){}bindForSubMesh(e,t,i,s){}dispose(e){}getCustomCode(e){return null}collectDefines(e){if(this._pluginDefineNames)for(const t of Object.keys(this._pluginDefineNames)){if("_"===t[0])continue;const i=typeof this._pluginDefineNames[t];e[t]={type:"number"===i?"number":"string"===i?"string":"boolean"===i?"boolean":"object",default:this._pluginDefineNames[t]}}}prepareDefinesBeforeAttributes(e,t,i){}prepareDefines(e,t,i){}hasTexture(e){return!1}hasRenderTargetTextures(){return!1}fillRenderTargetTextures(e){}getActiveTextures(e){}getAnimatables(e){}addFallbacks(e,t,i){return i}getSamplers(e){}getAttributes(e,t,i){}getUniformBuffersNames(e){}getUniforms(){return{}}copyTo(e){de.Clone((()=>e),this)}serialize(){return de.Serialize(this)}parse(e,t,i){de.Parse((()=>this),e,t,i)}}me([ie()],Fa.prototype,"name",void 0),me([ie()],Fa.prototype,"priority",void 0),me([ie()],Fa.prototype,"resolveIncludes",void 0),me([ie()],Fa.prototype,"registerForExtraEvents",void 0);class wa extends $t{constructor(){super(...arguments),this.DETAIL=!1,this.DETAILDIRECTUV=0,this.DETAIL_NORMALBLENDMETHOD=0}}class La extends Fa{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"DetailMap",140,new wa,t),this._texture=null,this.diffuseBlendLevel=1,this.roughnessBlendLevel=1,this.bumpLevel=1,this._normalBlendMethod=sr.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&i.getCaps().standardDerivatives&&this._texture&&Ia.DetailTextureEnabled&&!this._texture.isReady())}prepareDefines(e,t){if(this._isEnabled){e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;const i=t.getEngine();e._areTexturesDirty&&(i.getCaps().standardDerivatives&&this._texture&&Ia.DetailTextureEnabled&&this._isEnabled?(Hs.PrepareDefinesForMergedUV(this._texture,e,"DETAIL"),e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):e.DETAIL=!1)}else e.DETAIL=!1}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;e.useUbo&&i&&e.isSync||this._texture&&Ia.DetailTextureEnabled&&(e.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),Hs.BindTextureMatrix(this._texture,e,"detail")),t.texturesEnabled&&this._texture&&Ia.DetailTextureEnabled&&e.setTexture("detailSampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){var t;e&&(null===(t=this._texture)||void 0===t||t.dispose())}getClassName(){return"DetailMapConfiguration"}getSamplers(e){e.push("detailSampler")}getUniforms(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}}}me([se("detailTexture"),te("_markAllSubMeshesAsTexturesDirty")],La.prototype,"texture",void 0),me([ie()],La.prototype,"diffuseBlendLevel",void 0),me([ie()],La.prototype,"roughnessBlendLevel",void 0),me([ie()],La.prototype,"bumpLevel",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],La.prototype,"normalBlendMethod",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],La.prototype,"isEnabled",void 0);const Ba={effect:null,subMesh:null};class Ua extends $t{constructor(e){super(e),this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.OPACITY=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.SPECULAR=!1,this.SPECULARDIRECTUV=0,this.BUMP=!1,this.BUMPDIRECTUV=0,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.NONUNIFORMSCALING=!1,this.PREMULTIPLYALPHA=!1,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,this.ALPHABLEND=!0,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=!1,this.RGBDREFLECTION=!1,this.RGBDREFRACTION=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.IS_REFLECTION_LINEAR=!1,this.IS_REFRACTION_LINEAR=!1,this.EXPOSURE=!1,this.DECAL_AFTER_DETAIL=!1,this.rebuild()}setReflectionMode(e){const t=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"];for(const i of t)this[i]=i===e}}class Va extends Xr{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._markAllSubMeshesAsImageProcessingDirty()}))))}get isPrePassCapable(){return!this.disableDepthWrite}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}get canRenderToMRT(){return!0}constructor(e,t){super(e,t),this._diffuseTexture=null,this._ambientTexture=null,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._specularTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._refractionTexture=null,this.ambientColor=new N(0,0,0),this.diffuseColor=new N(1,1,1),this.specularColor=new N(1,1,1),this.emissiveColor=new N(0,0,0),this.specularPower=64,this._useAlphaFromDiffuseTexture=!1,this._useEmissiveAsIllumination=!1,this._linkEmissiveWithDiffuse=!1,this._useSpecularOverAlpha=!1,this._useReflectionOverAlpha=!1,this._disableLighting=!1,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this._roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.alphaCutOff=.4,this._useLightmapAsShadowmap=!1,this._useReflectionFresnelFromSpecular=!1,this._useGlossinessFromSpecularMapAlpha=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._applyDecalMapAfterDetailMap=!1,this._renderTargets=new Yt(16),this._worldViewProjectionMatrix=y.Zero(),this._globalAmbientColor=new N(0,0,0),this._cacheHasRenderTargetTextures=!1,this.detailMap=new La(this),this._attachImageProcessingConfiguration(null),this.prePassConfiguration=new Ra,this.getRenderTargetTextures=()=>(this._renderTargets.reset(),Va.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),Va.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._renderTargets.push(this._refractionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets)}get hasRenderTargetTextures(){return!!(Va.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget)||!!(Va.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)||this._cacheHasRenderTargetTextures}getClassName(){return"StandardMaterial"}needAlphaBlending(){return!this._disableAlphaBlending&&(this.alpha<1||null!=this._opacityTexture||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled)}needAlphaTesting(){return!!this._forceAlphaTest||this._hasAlphaChannel()&&(null==this._transparencyMode||this._transparencyMode===sr.MATERIAL_ALPHATEST)}_shouldUseAlphaFromDiffuseTexture(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==sr.MATERIAL_OPAQUE}_hasAlphaChannel(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha||null!=this._opacityTexture}getAlphaTestTexture(){return this._diffuseTexture}isReadyForSubMesh(e,t,i=!1){if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(Ys.GetDefineNames,this._eventInfo),t.materialDefines=new Ua(this._eventInfo.defineNames));const s=this.getScene(),r=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const n=s.getEngine();r._needNormals=Hs.PrepareDefinesForLights(s,e,r,!0,this._maxSimultaneousLights,this._disableLighting),Hs.PrepareDefinesForMultiview(s,r);const o=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(Hs.PrepareDefinesForPrePass(s,r,this.canRenderToMRT&&!o),Hs.PrepareDefinesForOIT(s,r,o),r._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,r._needUVs=!1;for(let e=1;e<=6;++e)r["MAINUV"+e]=!1;if(s.texturesEnabled){if(r.DIFFUSEDIRECTUV=0,r.BUMPDIRECTUV=0,r.AMBIENTDIRECTUV=0,r.OPACITYDIRECTUV=0,r.EMISSIVEDIRECTUV=0,r.SPECULARDIRECTUV=0,r.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&Va.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;Hs.PrepareDefinesForMergedUV(this._diffuseTexture,r,"DIFFUSE")}else r.DIFFUSE=!1;if(this._ambientTexture&&Va.AmbientTextureEnabled){if(!this._ambientTexture.isReadyOrNotBlocking())return!1;Hs.PrepareDefinesForMergedUV(this._ambientTexture,r,"AMBIENT")}else r.AMBIENT=!1;if(this._opacityTexture&&Va.OpacityTextureEnabled){if(!this._opacityTexture.isReadyOrNotBlocking())return!1;Hs.PrepareDefinesForMergedUV(this._opacityTexture,r,"OPACITY"),r.OPACITYRGB=this._opacityTexture.getAlphaFromRGB}else r.OPACITY=!1;if(this._reflectionTexture&&Va.ReflectionTextureEnabled){if(!this._reflectionTexture.isReadyOrNotBlocking())return!1;switch(r._needNormals=!0,r.REFLECTION=!0,r.ROUGHNESS=this._roughness>0,r.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,r.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===Ar.INVCUBIC_MODE,r.REFLECTIONMAP_3D=this._reflectionTexture.isCube,r.REFLECTIONMAP_OPPOSITEZ=r.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!this._reflectionTexture.invertZ:this._reflectionTexture.invertZ,r.RGBDREFLECTION=this._reflectionTexture.isRGBD,this._reflectionTexture.coordinatesMode){case Ar.EXPLICIT_MODE:r.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case Ar.PLANAR_MODE:r.setReflectionMode("REFLECTIONMAP_PLANAR");break;case Ar.PROJECTION_MODE:r.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case Ar.SKYBOX_MODE:r.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case Ar.SPHERICAL_MODE:r.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case Ar.EQUIRECTANGULAR_MODE:r.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case Ar.FIXED_EQUIRECTANGULAR_MODE:r.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case Ar.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:r.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;case Ar.CUBIC_MODE:case Ar.INVCUBIC_MODE:default:r.setReflectionMode("REFLECTIONMAP_CUBIC")}r.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else r.REFLECTION=!1,r.REFLECTIONMAP_OPPOSITEZ=!1;if(this._emissiveTexture&&Va.EmissiveTextureEnabled){if(!this._emissiveTexture.isReadyOrNotBlocking())return!1;Hs.PrepareDefinesForMergedUV(this._emissiveTexture,r,"EMISSIVE")}else r.EMISSIVE=!1;if(this._lightmapTexture&&Va.LightmapTextureEnabled){if(!this._lightmapTexture.isReadyOrNotBlocking())return!1;Hs.PrepareDefinesForMergedUV(this._lightmapTexture,r,"LIGHTMAP"),r.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,r.RGBDLIGHTMAP=this._lightmapTexture.isRGBD}else r.LIGHTMAP=!1;if(this._specularTexture&&Va.SpecularTextureEnabled){if(!this._specularTexture.isReadyOrNotBlocking())return!1;Hs.PrepareDefinesForMergedUV(this._specularTexture,r,"SPECULAR"),r.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha}else r.SPECULAR=!1;if(s.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&Va.BumpTextureEnabled){if(!this._bumpTexture.isReady())return!1;Hs.PrepareDefinesForMergedUV(this._bumpTexture,r,"BUMP"),r.PARALLAX=this._useParallax,r.PARALLAX_RHS=s.useRightHandedSystem,r.PARALLAXOCCLUSION=this._useParallaxOcclusion,r.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else r.BUMP=!1,r.PARALLAX=!1,r.PARALLAX_RHS=!1,r.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&Va.RefractionTextureEnabled){if(!this._refractionTexture.isReadyOrNotBlocking())return!1;r._needUVs=!0,r.REFRACTION=!0,r.REFRACTIONMAP_3D=this._refractionTexture.isCube,r.RGBDREFRACTION=this._refractionTexture.isRGBD,r.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize}else r.REFRACTION=!1;r.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else r.DIFFUSE=!1,r.AMBIENT=!1,r.OPACITY=!1,r.REFLECTION=!1,r.EMISSIVE=!1,r.LIGHTMAP=!1,r.BUMP=!1,r.REFRACTION=!1;r.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),r.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,r.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,r.SPECULAROVERALPHA=this._useSpecularOverAlpha,r.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,r.ALPHATEST_AFTERALLALPHACOMPUTATIONS=null!==this.transparencyMode,r.ALPHABLEND=null===this.transparencyMode||this.needAlphaBlendingForMesh(e)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=r,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(r._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(r),r.IS_REFLECTION_LINEAR=null!=this.reflectionTexture&&!this.reflectionTexture.gammaSpace,r.IS_REFRACTION_LINEAR=null!=this.refractionTexture&&!this.refractionTexture.gammaSpace}r._areFresnelDirty&&(Va.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(r.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,r.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,r.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,r.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,r.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,r.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,r._needNormals=!0,r.FRESNEL=!0):r.FRESNEL=!1),Hs.PrepareDefinesForMisc(e,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,r,this._applyDecalMapAfterDetailMap),Hs.PrepareDefinesForFrameBoundValues(s,n,this,r,i,null,t.getRenderingMesh().hasThinInstances),this._eventInfo.defines=r,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),Hs.PrepareDefinesForAttributes(e,r,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo);let a=!1;if(r.isDirty){const i=r._areLightsDisposed;r.markAsProcessed();const o=new hn;r.REFLECTION&&o.addFallback(0,"REFLECTION"),r.SPECULAR&&o.addFallback(0,"SPECULAR"),r.BUMP&&o.addFallback(0,"BUMP"),r.PARALLAX&&o.addFallback(1,"PARALLAX"),r.PARALLAX_RHS&&o.addFallback(1,"PARALLAX_RHS"),r.PARALLAXOCCLUSION&&o.addFallback(0,"PARALLAXOCCLUSION"),r.SPECULAROVERALPHA&&o.addFallback(0,"SPECULAROVERALPHA"),r.FOG&&o.addFallback(1,"FOG"),r.POINTSIZE&&o.addFallback(0,"POINTSIZE"),r.LOGARITHMICDEPTH&&o.addFallback(0,"LOGARITHMICDEPTH"),Hs.HandleFallbacksForShadows(r,o,this._maxSimultaneousLights),r.SPECULARTERM&&o.addFallback(0,"SPECULARTERM"),r.DIFFUSEFRESNEL&&o.addFallback(1,"DIFFUSEFRESNEL"),r.OPACITYFRESNEL&&o.addFallback(2,"OPACITYFRESNEL"),r.REFLECTIONFRESNEL&&o.addFallback(3,"REFLECTIONFRESNEL"),r.EMISSIVEFRESNEL&&o.addFallback(4,"EMISSIVEFRESNEL"),r.FRESNEL&&o.addFallback(4,"FRESNEL"),r.MULTIVIEW&&o.addFallback(0,"MULTIVIEW");const l=[hi.PositionKind];r.NORMAL&&l.push(hi.NormalKind),r.TANGENT&&l.push(hi.TangentKind);for(let e=1;e<=6;++e)r["UV"+e]&&l.push(`uv${1===e?"":e}`);r.VERTEXCOLOR&&l.push(hi.ColorKind),Hs.PrepareAttributesForBones(l,e,r,o),Hs.PrepareAttributesForInstances(l,r),Hs.PrepareAttributesForMorphTargets(l,e,r),Hs.PrepareAttributesForBakedVertexAnimation(l,e,r);let h="default";const c=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],u=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],d=["Material","Scene","Mesh"],p={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:r.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=o,this._eventInfo.fallbackRank=0,this._eventInfo.defines=r,this._eventInfo.uniforms=c,this._eventInfo.attributes=l,this._eventInfo.samplers=u,this._eventInfo.uniformBuffersNames=d,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=p,this._callbackPluginEventGeneric(Ys.PrepareEffect,this._eventInfo),Ra.AddUniforms(c),Ra.AddSamplers(u),Zt&&(Zt.PrepareUniforms(c,r),Zt.PrepareSamplers(u,r)),Hs.PrepareUniformsAndSamplersList({uniformsNames:c,uniformBuffersNames:d,samplers:u,defines:r,maxSimultaneousLights:this._maxSimultaneousLights}),ks(c);const _={};this.customShaderNameResolve&&(h=this.customShaderNameResolve(h,c,d,u,r,l,_));const f=r.toString(),m=t.effect;let g=s.getEngine().createEffect(h,{attributes:l,uniformsNames:c,uniformBuffersNames:d,samplers:u,defines:f,fallbacks:o,onCompiled:this.onCompiled,onError:this.onError,indexParameters:p,processFinalCode:_.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:r.PREPASS},n);if(this._eventInfo.customCode=void 0,g)if(this._onEffectCreatedObservable&&(Ba.effect=g,Ba.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Ba)),this.allowShaderHotSwapping&&m&&!g.isReady()){if(g=m,r.markAsUnprocessed(),a=this.isFrozen,i)return r._areLightsDisposed=!0,!1}else s.resetCachedMaterial(),t.setEffect(g,r,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(r._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!a,t.effect._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),0))}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("reflectionMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){var s;const r=this.getScene(),n=i.materialDefines;if(!n)return;const o=i.effect;if(!o)return;this._activeEffect=o,t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(e),this._uniformBuffer.bindToEffect(o,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,r,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),n.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const a=o._forceRebindOnNextCall||this._mustRebind(r,o,t.visibility);Hs.BindBonesParameters(t,o);const l=this._uniformBuffer;if(a){if(this.bindViewProjection(o),!l.useUbo||!this.isFrozen||!l.isSync||o._forceRebindOnNextCall){if(Va.FresnelEnabled&&n.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(l.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),l.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&l.updateColor4("opacityParts",new N(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(l.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),l.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(l.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),l.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(l.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),l.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),r.texturesEnabled){if(this._diffuseTexture&&Va.DiffuseTextureEnabled&&(l.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),Hs.BindTextureMatrix(this._diffuseTexture,l,"diffuse")),this._ambientTexture&&Va.AmbientTextureEnabled&&(l.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),Hs.BindTextureMatrix(this._ambientTexture,l,"ambient")),this._opacityTexture&&Va.OpacityTextureEnabled&&(l.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),Hs.BindTextureMatrix(this._opacityTexture,l,"opacity")),this._hasAlphaChannel()&&l.updateFloat("alphaCutOff",this.alphaCutOff),this._reflectionTexture&&Va.ReflectionTextureEnabled&&(l.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),l.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize)){const e=this._reflectionTexture;l.updateVector3("vReflectionPosition",e.boundingBoxPosition),l.updateVector3("vReflectionSize",e.boundingBoxSize)}if(this._emissiveTexture&&Va.EmissiveTextureEnabled&&(l.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),Hs.BindTextureMatrix(this._emissiveTexture,l,"emissive")),this._lightmapTexture&&Va.LightmapTextureEnabled&&(l.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),Hs.BindTextureMatrix(this._lightmapTexture,l,"lightmap")),this._specularTexture&&Va.SpecularTextureEnabled&&(l.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),Hs.BindTextureMatrix(this._specularTexture,l,"specular")),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&Va.BumpTextureEnabled&&(l.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),Hs.BindTextureMatrix(this._bumpTexture,l,"bump"),r._mirroredCameraPosition?l.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):l.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&Va.RefractionTextureEnabled){let e=1;if(this._refractionTexture.isCube||(l.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(e=this._refractionTexture.depth)),l.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,e,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){const e=this._refractionTexture;l.updateVector3("vRefractionPosition",e.boundingBoxPosition),l.updateVector3("vRefractionSize",e.boundingBoxSize)}}}this.pointsCloud&&l.updateFloat("pointSize",this.pointSize),n.SPECULARTERM&&l.updateColor4("vSpecularColor",this.specularColor,this.specularPower),l.updateColor3("vEmissiveColor",Va.EmissiveTextureEnabled?this.emissiveColor:N.BlackReadOnly),l.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),r.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),l.updateColor3("vAmbientColor",this._globalAmbientColor)}r.texturesEnabled&&(this._diffuseTexture&&Va.DiffuseTextureEnabled&&o.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&Va.AmbientTextureEnabled&&o.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&Va.OpacityTextureEnabled&&o.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&Va.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?o.setTexture("reflectionCubeSampler",this._reflectionTexture):o.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&Va.EmissiveTextureEnabled&&o.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&Va.LightmapTextureEnabled&&o.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&Va.SpecularTextureEnabled&&o.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&Va.BumpTextureEnabled&&o.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&Va.RefractionTextureEnabled&&(this._refractionTexture.isCube?o.setTexture("refractionCubeSampler",this._refractionTexture):o.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(o),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),zs(o,this,r),this.bindEyePosition(o)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);!a&&this.isFrozen||(r.lightsEnabled&&!this._disableLighting&&Hs.BindLights(r,t,o,n,this._maxSimultaneousLights),(r.fogEnabled&&t.applyFog&&r.fogMode!==Yi.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||t.receiveShadows||n.PREPASS)&&this.bindView(o),Hs.BindFogParameters(r,t,o),n.NUM_MORPH_INFLUENCERS&&Hs.BindMorphTargetParameters(t,o),n.BAKED_VERTEX_ANIMATION_TEXTURE&&(null===(s=t.bakedVertexAnimationManager)||void 0===s||s.bind(o,n.INSTANCES)),this.useLogarithmicDepth&&Hs.BindLogDepth(n,o,r),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect),l.update()}getAnimatables(){const e=super.getAnimatables();return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e}getActiveTextures(){const e=super.getActiveTextures();return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e}hasTexture(e){return!!super.hasTexture(e)||this._diffuseTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._specularTexture===e||this._bumpTexture===e||this._lightmapTexture===e||this._refractionTexture===e}dispose(e,t){var i,s,r,n,o,a,l,h,c;t&&(null===(i=this._diffuseTexture)||void 0===i||i.dispose(),null===(s=this._ambientTexture)||void 0===s||s.dispose(),null===(r=this._opacityTexture)||void 0===r||r.dispose(),null===(n=this._reflectionTexture)||void 0===n||n.dispose(),null===(o=this._emissiveTexture)||void 0===o||o.dispose(),null===(a=this._specularTexture)||void 0===a||a.dispose(),null===(l=this._bumpTexture)||void 0===l||l.dispose(),null===(h=this._lightmapTexture)||void 0===h||h.dispose(),null===(c=this._refractionTexture)||void 0===c||c.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}clone(e,t=!0,i=""){const s=de.Clone((()=>new Va(e,this.getScene())),this,{cloneTexturesOnlyOnce:t});return s.name=e,s.id=e,this.stencil.copyTo(s.stencil),this._clonePlugins(s,i),s}static Parse(e,t,i){const s=de.Parse((()=>new Va(e.name,t)),e,t,i);return e.stencil&&s.stencil.parse(e.stencil,t,i),sr._parsePlugins(e,s,t,i),s}static get DiffuseTextureEnabled(){return Ia.DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){Ia.DiffuseTextureEnabled=e}static get DetailTextureEnabled(){return Ia.DetailTextureEnabled}static set DetailTextureEnabled(e){Ia.DetailTextureEnabled=e}static get AmbientTextureEnabled(){return Ia.AmbientTextureEnabled}static set AmbientTextureEnabled(e){Ia.AmbientTextureEnabled=e}static get OpacityTextureEnabled(){return Ia.OpacityTextureEnabled}static set OpacityTextureEnabled(e){Ia.OpacityTextureEnabled=e}static get ReflectionTextureEnabled(){return Ia.ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){Ia.ReflectionTextureEnabled=e}static get EmissiveTextureEnabled(){return Ia.EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){Ia.EmissiveTextureEnabled=e}static get SpecularTextureEnabled(){return Ia.SpecularTextureEnabled}static set SpecularTextureEnabled(e){Ia.SpecularTextureEnabled=e}static get BumpTextureEnabled(){return Ia.BumpTextureEnabled}static set BumpTextureEnabled(e){Ia.BumpTextureEnabled=e}static get LightmapTextureEnabled(){return Ia.LightmapTextureEnabled}static set LightmapTextureEnabled(e){Ia.LightmapTextureEnabled=e}static get RefractionTextureEnabled(){return Ia.RefractionTextureEnabled}static set RefractionTextureEnabled(e){Ia.RefractionTextureEnabled=e}static get ColorGradingTextureEnabled(){return Ia.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){Ia.ColorGradingTextureEnabled=e}static get FresnelEnabled(){return Ia.FresnelEnabled}static set FresnelEnabled(e){Ia.FresnelEnabled=e}}me([se("diffuseTexture")],Va.prototype,"_diffuseTexture",void 0),me([te("_markAllSubMeshesAsTexturesAndMiscDirty")],Va.prototype,"diffuseTexture",void 0),me([se("ambientTexture")],Va.prototype,"_ambientTexture",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],Va.prototype,"ambientTexture",void 0),me([se("opacityTexture")],Va.prototype,"_opacityTexture",void 0),me([te("_markAllSubMeshesAsTexturesAndMiscDirty")],Va.prototype,"opacityTexture",void 0),me([se("reflectionTexture")],Va.prototype,"_reflectionTexture",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],Va.prototype,"reflectionTexture",void 0),me([se("emissiveTexture")],Va.prototype,"_emissiveTexture",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],Va.prototype,"emissiveTexture",void 0),me([se("specularTexture")],Va.prototype,"_specularTexture",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],Va.prototype,"specularTexture",void 0),me([se("bumpTexture")],Va.prototype,"_bumpTexture",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],Va.prototype,"bumpTexture",void 0),me([se("lightmapTexture")],Va.prototype,"_lightmapTexture",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],Va.prototype,"lightmapTexture",void 0),me([se("refractionTexture")],Va.prototype,"_refractionTexture",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],Va.prototype,"refractionTexture",void 0),me([re("ambient")],Va.prototype,"ambientColor",void 0),me([re("diffuse")],Va.prototype,"diffuseColor",void 0),me([re("specular")],Va.prototype,"specularColor",void 0),me([re("emissive")],Va.prototype,"emissiveColor",void 0),me([ie()],Va.prototype,"specularPower",void 0),me([ie("useAlphaFromDiffuseTexture")],Va.prototype,"_useAlphaFromDiffuseTexture",void 0),me([te("_markAllSubMeshesAsTexturesAndMiscDirty")],Va.prototype,"useAlphaFromDiffuseTexture",void 0),me([ie("useEmissiveAsIllumination")],Va.prototype,"_useEmissiveAsIllumination",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],Va.prototype,"useEmissiveAsIllumination",void 0),me([ie("linkEmissiveWithDiffuse")],Va.prototype,"_linkEmissiveWithDiffuse",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],Va.prototype,"linkEmissiveWithDiffuse",void 0),me([ie("useSpecularOverAlpha")],Va.prototype,"_useSpecularOverAlpha",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],Va.prototype,"useSpecularOverAlpha",void 0),me([ie("useReflectionOverAlpha")],Va.prototype,"_useReflectionOverAlpha",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],Va.prototype,"useReflectionOverAlpha",void 0),me([ie("disableLighting")],Va.prototype,"_disableLighting",void 0),me([te("_markAllSubMeshesAsLightsDirty")],Va.prototype,"disableLighting",void 0),me([ie("useObjectSpaceNormalMap")],Va.prototype,"_useObjectSpaceNormalMap",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],Va.prototype,"useObjectSpaceNormalMap",void 0),me([ie("useParallax")],Va.prototype,"_useParallax",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],Va.prototype,"useParallax",void 0),me([ie("useParallaxOcclusion")],Va.prototype,"_useParallaxOcclusion",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],Va.prototype,"useParallaxOcclusion",void 0),me([ie()],Va.prototype,"parallaxScaleBias",void 0),me([ie("roughness")],Va.prototype,"_roughness",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],Va.prototype,"roughness",void 0),me([ie()],Va.prototype,"indexOfRefraction",void 0),me([ie()],Va.prototype,"invertRefractionY",void 0),me([ie()],Va.prototype,"alphaCutOff",void 0),me([ie("useLightmapAsShadowmap")],Va.prototype,"_useLightmapAsShadowmap",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],Va.prototype,"useLightmapAsShadowmap",void 0),me([ne("diffuseFresnelParameters")],Va.prototype,"_diffuseFresnelParameters",void 0),me([te("_markAllSubMeshesAsFresnelDirty")],Va.prototype,"diffuseFresnelParameters",void 0),me([ne("opacityFresnelParameters")],Va.prototype,"_opacityFresnelParameters",void 0),me([te("_markAllSubMeshesAsFresnelAndMiscDirty")],Va.prototype,"opacityFresnelParameters",void 0),me([ne("reflectionFresnelParameters")],Va.prototype,"_reflectionFresnelParameters",void 0),me([te("_markAllSubMeshesAsFresnelDirty")],Va.prototype,"reflectionFresnelParameters",void 0),me([ne("refractionFresnelParameters")],Va.prototype,"_refractionFresnelParameters",void 0),me([te("_markAllSubMeshesAsFresnelDirty")],Va.prototype,"refractionFresnelParameters",void 0),me([ne("emissiveFresnelParameters")],Va.prototype,"_emissiveFresnelParameters",void 0),me([te("_markAllSubMeshesAsFresnelDirty")],Va.prototype,"emissiveFresnelParameters",void 0),me([ie("useReflectionFresnelFromSpecular")],Va.prototype,"_useReflectionFresnelFromSpecular",void 0),me([te("_markAllSubMeshesAsFresnelDirty")],Va.prototype,"useReflectionFresnelFromSpecular",void 0),me([ie("useGlossinessFromSpecularMapAlpha")],Va.prototype,"_useGlossinessFromSpecularMapAlpha",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],Va.prototype,"useGlossinessFromSpecularMapAlpha",void 0),me([ie("maxSimultaneousLights")],Va.prototype,"_maxSimultaneousLights",void 0),me([te("_markAllSubMeshesAsLightsDirty")],Va.prototype,"maxSimultaneousLights",void 0),me([ie("invertNormalMapX")],Va.prototype,"_invertNormalMapX",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],Va.prototype,"invertNormalMapX",void 0),me([ie("invertNormalMapY")],Va.prototype,"_invertNormalMapY",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],Va.prototype,"invertNormalMapY",void 0),me([ie("twoSidedLighting")],Va.prototype,"_twoSidedLighting",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],Va.prototype,"twoSidedLighting",void 0),me([ie("applyDecalMapAfterDetailMap")],Va.prototype,"_applyDecalMapAfterDetailMap",void 0),me([te("_markAllSubMeshesAsMiscDirty")],Va.prototype,"applyDecalMapAfterDetailMap",void 0),m("BABYLON.StandardMaterial",Va),Yi.DefaultMaterialFactory=e=>new Va("default material",e),bt.prototype.createDynamicTexture=function(e,t,i,s){const r=new dt(this,ut.Dynamic);return r.baseWidth=e,r.baseHeight=t,i&&(e=this.needPOTTextures?bt.GetExponentOfTwo(e,this._caps.maxTextureSize):e,t=this.needPOTTextures?bt.GetExponentOfTwo(t,this._caps.maxTextureSize):t),r.width=e,r.height=t,r.isReady=!1,r.generateMipMaps=i,r.samplingMode=s,this.updateTextureSamplingMode(s,r),this._internalTexturesCache.push(r),r},bt.prototype.updateDynamicTexture=function(e,t,i,s=!1,r,n=!1,o=!1){if(!e)return;const a=this._gl,l=a.TEXTURE_2D,h=this._bindTextureDirectly(l,e,!0,n);this._unpackFlipY(void 0===i?e.invertY:i),s&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);const c=this._getWebGLTextureType(e.type),u=this._getInternalFormat(r||e.format),d=this._getRGBABufferInternalSizedFormat(e.type,u);a.texImage2D(l,0,d,u,c,t),e.generateMipMaps&&a.generateMipmap(l),h||this._bindTextureDirectly(l,null),s&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),r&&(e.format=r),e._dynamicTextureSource=t,e._premulAlpha=s,e.invertY=i||!1,e.isReady=!0};class ka extends Ar{constructor(e,t,i=null,s=!1,r=3,n=5,o){super(null,i,!s,o,r,void 0,void 0,void 0,void 0,n),this.name=e,this.wrapU=Ar.CLAMP_ADDRESSMODE,this.wrapV=Ar.CLAMP_ADDRESSMODE,this._generateMipMaps=s;const a=this._getEngine();if(!a)return;t.getContext?(this._canvas=t,this._texture=a.createDynamicTexture(t.width,t.height,s,r)):(this._canvas=a.createCanvas(1,1),t.width||0===t.width?this._texture=a.createDynamicTexture(t.width,t.height,s,r):this._texture=a.createDynamicTexture(t,t,s,r));const l=this.getSize();this._canvas.width!==l.width&&(this._canvas.width=l.width),this._canvas.height!==l.height&&(this._canvas.height=l.height),this._context=this._canvas.getContext("2d")}getClassName(){return"DynamicTexture"}get canRescale(){return!0}_recreate(e){this._canvas.width=e.width,this._canvas.height=e.height,this.releaseInternalTexture(),this._texture=this._getEngine().createDynamicTexture(e.width,e.height,this._generateMipMaps,this.samplingMode)}scale(e){const t=this.getSize();t.width*=e,t.height*=e,this._recreate(t)}scaleTo(e,t){const i=this.getSize();i.width=e,i.height=t,this._recreate(i)}getContext(){return this._context}clear(e){const t=this.getSize();e&&(this._context.fillStyle=e),this._context.clearRect(0,0,t.width,t.height)}update(e,t=!1,i=!1){this._getEngine().updateDynamicTexture(this._texture,this._canvas,void 0===e||e,t,this._format||void 0,void 0,i)}drawText(e,t,i,s,r,n,o,a=!0){const l=this.getSize();if(n&&(this._context.fillStyle=n,this._context.fillRect(0,0,l.width,l.height)),this._context.font=s,null==t){const i=this._context.measureText(e);t=(l.width-i.width)/2}if(null==i){const e=parseInt(s.replace(/\D/g,""));i=l.height/2+e/3.65}this._context.fillStyle=r||"",this._context.fillText(e,t,i),a&&this.update(o)}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new ka(this.name,t,e,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.wrapU=this.wrapU,i.wrapV=this.wrapV,i}serialize(){const e=this.getScene();e&&!e.isReady()&&k.Warn("The scene must be ready before serializing the dynamic texture");const t=super.serialize();return ka._IsCanvasElement(this._canvas)&&(t.base64String=this._canvas.toDataURL()),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t}static _IsCanvasElement(e){return void 0!==e.toDataURL}_rebuild(){this.update()}}class Ga{get isFixedFoveationSupported(){return"XRWebGLLayer"==this.layerType&&"number"==typeof this.layer.fixedFoveation}get fixedFoveation(){return this.isFixedFoveationSupported?this.layer.fixedFoveation:null}set fixedFoveation(e){if(this.isFixedFoveationSupported){const t=Math.max(0,Math.min(1,e||0));this.layer.fixedFoveation=t}}constructor(e,t,i,s,r){this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=s,this.createRenderTargetTextureProvider=r}}class za{constructor(e,t){this._scene=e,this.layerWrapper=t,this._renderTargetTextures=new Array,this._engine=e.getEngine()}_createInternalTexture(e,t){const i=new dt(this._engine,ut.Unknown,!0);return i.width=e.width,i.height=e.height,i._hardwareTexture=new xt(t,this._engine._gl),i.isReady=!0,i}_createRenderTargetTexture(e,t,i,s,r,n){if(!this._engine)throw new Error("Engine is disposed");const o={width:e,height:t},a=n?new xa(this._scene,o):new Bn("XR renderTargetTexture",o,this._scene),l=a.renderTarget;if(l._samples=a.samples,!i&&s||(l._framebuffer=i),s)if(n)l._colorTextureArray=s;else{const e=this._createInternalTexture(o,s);l.setTexture(e,0),a._texture=e}return r&&(n?l._depthStencilTextureArray=r:l._depthStencilTexture=this._createInternalTexture(o,r)),a.disableRescaling(),"undefined"!=typeof XRWebGLBinding&&(a.skipInitialClear=!0),this._renderTargetTextures.push(a),a}_destroyRenderTargetTexture(e){this._renderTargetTextures.splice(this._renderTargetTextures.indexOf(e),1),e.dispose()}getFramebufferDimensions(){return this._framebufferDimensions}dispose(){this._renderTargetTextures.forEach((e=>e.dispose())),this._renderTargetTextures.length=0}}class Wa extends Ga{constructor(e){super((()=>e.framebufferWidth),(()=>e.framebufferHeight),e,"XRWebGLLayer",(e=>new Ha(e.scene,this))),this.layer=e}}class Ha extends za{constructor(e,t){super(e,t),this.layerWrapper=t,this._layer=t.layer,this._framebufferDimensions={framebufferWidth:this._layer.framebufferWidth,framebufferHeight:this._layer.framebufferHeight}}trySetViewportForView(e,t){const i=this._layer.getViewport(t);if(!i)return!1;const s=this._framebufferDimensions.framebufferWidth,r=this._framebufferDimensions.framebufferHeight;return e.x=i.x/s,e.y=i.y/r,e.width=i.width/s,e.height=i.height/r,!0}getRenderTargetTextureForEye(e){const t=this._layer.framebufferWidth,i=this._layer.framebufferHeight,s=this._layer.framebuffer;return this._rtt&&t===this._framebufferDimensions.framebufferWidth&&i===this._framebufferDimensions.framebufferHeight&&s===this._framebuffer||(this._rtt=this._createRenderTargetTexture(t,i,s),this._framebufferDimensions.framebufferWidth=t,this._framebufferDimensions.framebufferHeight=i,this._framebuffer=s),this._rtt}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e.eye)}}class Xa{static GetDefaults(e){const t=new Xa;return t.canvasOptions={antialias:!0,depth:!0,stencil:!e||e.isStencilEnable,alpha:!0,framebufferScaleFactor:1},t.newCanvasCssStyle="position:absolute; bottom:0px;right:0px;z-index:10;width:90%;height:100%;background-color: #000000;",t}}class Ya{constructor(e,t=Xa.GetDefaults()){if(this._options=t,this._canvas=null,this._engine=null,this.xrLayer=null,this._xrLayerWrapper=null,this.onXRLayerInitObservable=new a,this._engine=e.scene.getEngine(),this._engine.onDisposeObservable.addOnce((()=>{this._engine=null})),t.canvasElement)this._setManagedOutputCanvas(t.canvasElement);else{const e=document.createElement("canvas");e.style.cssText=this._options.newCanvasCssStyle||"position:absolute; bottom:0px;right:0px;",this._setManagedOutputCanvas(e)}e.onXRSessionInit.add((()=>{this._addCanvas()})),e.onXRSessionEnded.add((()=>{this._removeCanvas()}))}dispose(){this._removeCanvas(),this._setManagedOutputCanvas(null)}async initializeXRLayerAsync(e){const t=()=>(this.xrLayer=new XRWebGLLayer(e,this.canvasContext,this._options.canvasOptions),this._xrLayerWrapper=new Wa(this.xrLayer),this.onXRLayerInitObservable.notifyObservers(this.xrLayer),this.xrLayer);return this.canvasContext.makeXRCompatible?this.canvasContext.makeXRCompatible().then((()=>{}),(()=>{Ht.Warn("Error executing makeXRCompatible. This does not mean that the session will work incorrectly.")})).then((()=>t())):Promise.resolve(t())}_addCanvas(){this._canvas&&this._engine&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.appendChild(this._canvas),this.xrLayer?this._setCanvasSize(!0):this.onXRLayerInitObservable.addOnce((()=>{this._setCanvasSize(!0)}))}_removeCanvas(){this._canvas&&this._engine&&document.body.contains(this._canvas)&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.removeChild(this._canvas),this._setCanvasSize(!1)}_setCanvasSize(e=!0,t=this._xrLayerWrapper){this._canvas&&this._engine&&(e?t&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=t.getWidth()+"px",this._canvas.style.height=t.getHeight()+"px"):this._engine.setSize(t.getWidth(),t.getHeight())):this._originalCanvasSize&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=this._originalCanvasSize.width+"px",this._canvas.style.height=this._originalCanvasSize.height+"px"):this._engine.setSize(this._originalCanvasSize.width,this._originalCanvasSize.height)))}_setManagedOutputCanvas(e){this._removeCanvas(),e?(this._originalCanvasSize={width:e.offsetWidth,height:e.offsetHeight},this._canvas=e,this.canvasContext=this._canvas.getContext("webgl2"),this.canvasContext||(this.canvasContext=this._canvas.getContext("webgl"))):(this._canvas=null,this.canvasContext=null)}}class ja extends Ga{constructor(e){super((()=>e.framebufferWidth),(()=>e.framebufferHeight),e,"XRWebGLLayer",(e=>new Ka(e,this))),this.layer=e}}class Ka extends za{constructor(e,t){super(e.scene,t),this.layerWrapper=t,this._nativeRTTProvider=navigator.xr.getNativeRenderTargetProvider(e.session,this._createRenderTargetTexture.bind(this),this._destroyRenderTargetTexture.bind(this)),this._nativeLayer=t.layer}trySetViewportForView(e){return e.x=0,e.y=0,e.width=1,e.height=1,!0}getRenderTargetTextureForEye(e){return this._nativeRTTProvider.getRenderTargetForEye(e)}getRenderTargetTextureForView(e){return this._nativeRTTProvider.getRenderTargetForEye(e.eye)}getFramebufferDimensions(){return{framebufferWidth:this._nativeLayer.framebufferWidth,framebufferHeight:this._nativeLayer.framebufferHeight}}}class $a{constructor(e){this._nativeRenderTarget=navigator.xr.getWebXRRenderTarget(e.scene.getEngine())}async initializeXRLayerAsync(e){return await this._nativeRenderTarget.initializeXRLayerAsync(e),this.xrLayer=this._nativeRenderTarget.xrLayer,this.xrLayer}dispose(){}}class qa{constructor(e){this.scene=e,this.currentTimestamp=-1,this.defaultHeightCompensation=1.7,this.onXRFrameObservable=new a,this.onXRReferenceSpaceChanged=new a,this.onXRSessionEnded=new a,this.onXRSessionInit=new a,this.inXRFrameLoop=!1,this.inXRSession=!1,this._engine=e.getEngine(),this._onEngineDisposedObserver=this._engine.onDisposeObservable.addOnce((()=>{this._engine=null})),e.onDisposeObservable.addOnce((()=>{this.dispose()}))}get referenceSpace(){return this._referenceSpace}set referenceSpace(e){this._referenceSpace=e,this.onXRReferenceSpaceChanged.notifyObservers(this._referenceSpace)}get sessionMode(){return this._sessionMode}dispose(){var e;this.inXRSession&&this.exitXRAsync(),this.onXRFrameObservable.clear(),this.onXRSessionEnded.clear(),this.onXRReferenceSpaceChanged.clear(),this.onXRSessionInit.clear(),null===(e=this._engine)||void 0===e||e.onDisposeObservable.remove(this._onEngineDisposedObserver),this._engine=null}exitXRAsync(){return this.session&&this.inXRSession?(this.inXRSession=!1,this.session.end().catch((()=>{k.Warn("Could not end XR session.")}))):Promise.resolve()}trySetViewportForView(e,t){var i;return(null===(i=this._baseLayerRTTProvider)||void 0===i?void 0:i.trySetViewportForView(e,t))||!1}getRenderTargetTextureForEye(e){var t;return(null===(t=this._baseLayerRTTProvider)||void 0===t?void 0:t.getRenderTargetTextureForEye(e))||null}getRenderTargetTextureForView(e){var t;return(null===(t=this._baseLayerRTTProvider)||void 0===t?void 0:t.getRenderTargetTextureForView(e))||null}getWebXRRenderTarget(e){const t=this.scene.getEngine();return this._xrNavigator.xr.native?new $a(this):((e=e||Xa.GetDefaults(t)).canvasElement=e.canvasElement||t.getRenderingCanvas()||void 0,new Ya(this,e))}initializeAsync(){return this._xrNavigator=navigator,this._xrNavigator.xr?Promise.resolve():Promise.reject("WebXR not available")}initializeSessionAsync(e="immersive-vr",t={}){return this._xrNavigator.xr.requestSession(e,t).then((t=>(this.session=t,this._sessionMode=e,this.onXRSessionInit.notifyObservers(t),this.inXRSession=!0,this.session.addEventListener("end",(()=>{var e;this.inXRSession=!1,this.onXRSessionEnded.notifyObservers(null),this._engine&&(this._engine.framebufferDimensionsObject=null,this._engine.restoreDefaultFramebuffer(),this._engine.customAnimationFrameRequester=null,this._engine._renderLoop()),this.isNative&&(null===(e=this._baseLayerRTTProvider)||void 0===e||e.dispose()),this._baseLayerRTTProvider=null,this._baseLayerWrapper=null}),{once:!0}),this.session)))}isSessionSupportedAsync(e){return qa.IsSessionSupportedAsync(e)}resetReferenceSpace(){this.referenceSpace=this.baseReferenceSpace}runXRRenderLoop(){var e;this.inXRSession&&this._engine&&(this._engine.customAnimationFrameRequester={requestAnimationFrame:e=>this.session.requestAnimationFrame(e),renderFunction:(e,t)=>{var i;this.inXRSession&&this._engine&&(this.currentFrame=t,this.currentTimestamp=e,t&&(this.inXRFrameLoop=!0,this._engine.framebufferDimensionsObject=(null===(i=this._baseLayerRTTProvider)||void 0===i?void 0:i.getFramebufferDimensions())||null,this.onXRFrameObservable.notifyObservers(t),this._engine._renderLoop(),this._engine.framebufferDimensionsObject=null,this.inXRFrameLoop=!1))}},this._engine.framebufferDimensionsObject=(null===(e=this._baseLayerRTTProvider)||void 0===e?void 0:e.getFramebufferDimensions())||null,"undefined"!=typeof window&&window.cancelAnimationFrame&&window.cancelAnimationFrame(this._engine._frameHandler),this._engine._renderLoop())}setReferenceSpaceTypeAsync(e="local-floor"){return this.session.requestReferenceSpace(e).then((e=>e),(e=>(k.Error("XR.requestReferenceSpace failed for the following reason: "),k.Error(e),k.Log('Defaulting to universally-supported "viewer" reference space type.'),this.session.requestReferenceSpace("viewer").then((e=>{const t=new XRRigidTransform({x:0,y:-this.defaultHeightCompensation,z:0});return e.getOffsetReferenceSpace(t)}),(e=>{throw k.Error(e),'XR initialization failed: required "viewer" reference space type not supported.'}))))).then((e=>this.session.requestReferenceSpace("viewer").then((t=>(this.viewerReferenceSpace=t,e))))).then((e=>(this.referenceSpace=this.baseReferenceSpace=e,this.referenceSpace)))}updateRenderStateAsync(e){return Promise.resolve(this.session.updateRenderState(e))}_setBaseLayerWrapper(e){var t,i;this.isNative&&(null===(t=this._baseLayerRTTProvider)||void 0===t||t.dispose()),this._baseLayerWrapper=e,this._baseLayerRTTProvider=(null===(i=this._baseLayerWrapper)||void 0===i?void 0:i.createRenderTargetTextureProvider(this))||null}_getBaseLayerWrapper(){return this._baseLayerWrapper}updateRenderState(e){e.baseLayer&&this._setBaseLayerWrapper(this.isNative?new ja(e.baseLayer):new Wa(e.baseLayer)),this.session.updateRenderState(e)}static IsSessionSupportedAsync(e){if(!navigator.xr)return Promise.resolve(!1);const t=navigator.xr.isSessionSupported||navigator.xr.supportsSession;return t?t.call(navigator.xr,e).then((e=>{const t=void 0===e||e;return Promise.resolve(t)})).catch((e=>(k.Warn(e),Promise.resolve(!1)))):Promise.resolve(!1)}get isNative(){var e;return null!==(e=this._xrNavigator.xr.native)&&void 0!==e&&e}get currentFrameRate(){var e;return null===(e=this.session)||void 0===e?void 0:e.frameRate}get supportedFrameRates(){var e;return null===(e=this.session)||void 0===e?void 0:e.supportedFrameRates}updateTargetFrameRate(e){return this.session.updateTargetFrameRate(e)}runInXRFrame(e,t=!0){this.inXRFrameLoop?e():!this.inXRSession&&t||this.onXRFrameObservable.addOnce(e)}get isFixedFoveationSupported(){var e;return(null===(e=this._baseLayerWrapper)||void 0===e?void 0:e.isFixedFoveationSupported)||!1}get fixedFoveation(){var e;return(null===(e=this._baseLayerWrapper)||void 0===e?void 0:e.fixedFoveation)||null}set fixedFoveation(e){const t=Math.max(0,Math.min(1,e||0));this._baseLayerWrapper&&(this._baseLayerWrapper.fixedFoveation=t)}get enabledFeatures(){var e,t;return null!==(t=null===(e=this.session)||void 0===e?void 0:e.enabledFeatures)&&void 0!==t?t:null}}var Qa,Za;!function(e){e[e.ENTERING_XR=0]="ENTERING_XR",e[e.EXITING_XR=1]="EXITING_XR",e[e.IN_XR=2]="IN_XR",e[e.NOT_IN_XR=3]="NOT_IN_XR"}(Qa||(Qa={})),function(e){e[e.NOT_TRACKING=0]="NOT_TRACKING",e[e.TRACKING_LOST=1]="TRACKING_LOST",e[e.TRACKING=2]="TRACKING"}(Za||(Za={})),ur._GroundMeshParser=(e,t)=>Ja.Parse(e,t);class Ja extends ur{constructor(e,t){super(e,t),this.generateOctree=!1}getClassName(){return"GroundMesh"}get subdivisions(){return Math.min(this._subdivisionsX,this._subdivisionsY)}get subdivisionsX(){return this._subdivisionsX}get subdivisionsY(){return this._subdivisionsY}optimize(e,t=32){this._subdivisionsX=e,this._subdivisionsY=e,this.subdivide(e);this.createOrUpdateSubmeshesOctree&&this.createOrUpdateSubmeshesOctree(t)}getHeightAtCoordinates(e,t){const i=this.getWorldMatrix(),s=R.Matrix[5];i.invertToRef(s);const r=R.Vector3[8];if(S.TransformCoordinatesFromFloatsToRef(e,0,t,s,r),e=r.x,t=r.z,e<this._minX||e>=this._maxX||t<=this._minZ||t>this._maxZ)return this.position.y;this._heightQuads&&0!=this._heightQuads.length||(this._initHeightQuads(),this._computeHeightQuads());const n=this._getFacetAt(e,t),o=-(n.x*e+n.z*t+n.w)/n.y;return S.TransformCoordinatesFromFloatsToRef(0,o,0,i,r),r.y}getNormalAtCoordinates(e,t){const i=new S(0,1,0);return this.getNormalAtCoordinatesToRef(e,t,i),i}getNormalAtCoordinatesToRef(e,t,i){const s=this.getWorldMatrix(),r=R.Matrix[5];s.invertToRef(r);const n=R.Vector3[8];if(S.TransformCoordinatesFromFloatsToRef(e,0,t,r,n),e=n.x,t=n.z,e<this._minX||e>this._maxX||t<this._minZ||t>this._maxZ)return this;this._heightQuads&&0!=this._heightQuads.length||(this._initHeightQuads(),this._computeHeightQuads());const o=this._getFacetAt(e,t);return S.TransformNormalFromFloatsToRef(o.x,o.y,o.z,s,i),this}updateCoordinateHeights(){return this._heightQuads&&0!=this._heightQuads.length||this._initHeightQuads(),this._computeHeightQuads(),this}_getFacetAt(e,t){const i=Math.floor((e+this._maxX)*this._subdivisionsX/this._width),s=Math.floor(-(t+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),r=this._heightQuads[s*this._subdivisionsX+i];let n;return n=t<r.slope.x*e+r.slope.y?r.facet1:r.facet2,n}_initHeightQuads(){const e=this._subdivisionsX,t=this._subdivisionsY;this._heightQuads=new Array;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s={slope:E.Zero(),facet1:new b(0,0,0,0),facet2:new b(0,0,0,0)};this._heightQuads[i*e+t]=s}return this}_computeHeightQuads(){const e=this.getVerticesData(hi.PositionKind);if(!e)return this;const t=R.Vector3[3],i=R.Vector3[2],s=R.Vector3[1],r=R.Vector3[0],n=R.Vector3[4],o=R.Vector3[5],a=R.Vector3[6],l=R.Vector3[7],h=R.Vector3[8];let c=0,u=0,d=0,p=0,_=0,f=0,m=0;const g=this._subdivisionsX,v=this._subdivisionsY;for(let x=0;x<v;x++)for(let v=0;v<g;v++){c=3*v,u=x*(g+1)*3,d=(x+1)*(g+1)*3,t.x=e[u+c],t.y=e[u+c+1],t.z=e[u+c+2],i.x=e[u+c+3],i.y=e[u+c+4],i.z=e[u+c+5],s.x=e[d+c],s.y=e[d+c+1],s.z=e[d+c+2],r.x=e[d+c+3],r.y=e[d+c+4],r.z=e[d+c+5],p=(r.z-t.z)/(r.x-t.x),_=t.z-p*t.x,i.subtractToRef(t,n),s.subtractToRef(t,o),r.subtractToRef(t,a),S.CrossToRef(a,o,l),S.CrossToRef(n,a,h),l.normalize(),h.normalize(),f=-(l.x*t.x+l.y*t.y+l.z*t.z),m=-(h.x*i.x+h.y*i.y+h.z*i.z);const T=this._heightQuads[x*g+v];T.slope.copyFromFloats(p,_),T.facet1.copyFromFloats(l.x,l.y,l.z,f),T.facet2.copyFromFloats(h.x,h.y,h.z,m)}return this}serialize(e){super.serialize(e),e.subdivisionsX=this._subdivisionsX,e.subdivisionsY=this._subdivisionsY,e.minX=this._minX,e.maxX=this._maxX,e.minZ=this._minZ,e.maxZ=this._maxZ,e.width=this._width,e.height=this._height}static Parse(e,t){const i=new Ja(e.name,t);return i._subdivisionsX=e.subdivisionsX||1,i._subdivisionsY=e.subdivisionsY||1,i._minX=e.minX,i._maxX=e.maxX,i._minZ=e.minZ,i._maxZ=e.maxZ,i._width=e.width,i._height=e.height,i}}function el(e){const t=[],i=[],s=[],r=[];let n,o;const a=e.width||1,l=e.height||1,h=0|(e.subdivisionsX||e.subdivisions||1),c=0|(e.subdivisionsY||e.subdivisions||1);for(n=0;n<=c;n++)for(o=0;o<=h;o++){const e=new S(o*a/h-a/2,0,(c-n)*l/c-l/2),t=new S(0,1,0);i.push(e.x,e.y,e.z),s.push(t.x,t.y,t.z),r.push(o/h,Is.UseOpenGLOrientationForUV?n/c:1-n/c)}for(n=0;n<c;n++)for(o=0;o<h;o++)t.push(o+1+(n+1)*(h+1)),t.push(o+1+n*(h+1)),t.push(o+n*(h+1)),t.push(o+(n+1)*(h+1)),t.push(o+1+(n+1)*(h+1)),t.push(o+n*(h+1));const u=new As;return u.indices=t,u.positions=i,u.normals=s,u.uvs=r,u}function tl(e){const t=void 0!==e.xmin&&null!==e.xmin?e.xmin:-1,i=void 0!==e.zmin&&null!==e.zmin?e.zmin:-1,s=void 0!==e.xmax&&null!==e.xmax?e.xmax:1,r=void 0!==e.zmax&&null!==e.zmax?e.zmax:1,n=e.subdivisions||{w:1,h:1},o=e.precision||{w:1,h:1},a=[],l=[],h=[],c=[];let u,d,p,_;n.h=n.h<1?1:n.h,n.w=n.w<1?1:n.w,o.w=o.w<1?1:o.w,o.h=o.h<1?1:o.h;const f=(s-t)/n.w,m=(r-i)/n.h;function g(e,t,i,s){const r=l.length/3,n=o.w+1;for(u=0;u<o.h;u++)for(d=0;d<o.w;d++){const e=[r+d+u*n,r+(d+1)+u*n,r+(d+1)+(u+1)*n,r+d+(u+1)*n];a.push(e[1]),a.push(e[2]),a.push(e[3]),a.push(e[0]),a.push(e[1]),a.push(e[3])}const p=S.Zero(),_=new S(0,1,0);for(u=0;u<=o.h;u++)for(p.z=u*(s-t)/o.h+t,d=0;d<=o.w;d++)p.x=d*(i-e)/o.w+e,p.y=0,l.push(p.x,p.y,p.z),h.push(_.x,_.y,_.z),c.push(d/o.w,u/o.h)}for(p=0;p<n.h;p++)for(_=0;_<n.w;_++)g(t+_*f,i+p*m,t+(_+1)*f,i+(p+1)*m);const v=new As;return v.indices=a,v.positions=l,v.normals=h,v.uvs=c,v}function il(e){const t=[],i=[],s=[],r=[];let n,o;const a=e.colorFilter||new N(.3,.59,.11),l=e.alphaFilter||0;let h=!1;if(e.minHeight>e.maxHeight){h=!0;const t=e.maxHeight;e.maxHeight=e.minHeight,e.minHeight=t}for(n=0;n<=e.subdivisions;n++)for(o=0;o<=e.subdivisions;o++){const t=new S(o*e.width/e.subdivisions-e.width/2,0,(e.subdivisions-n)*e.height/e.subdivisions-e.height/2),c=4*(((t.x+e.width/2)/e.width*(e.bufferWidth-1)|0)+((1-(t.z+e.height/2)/e.height)*(e.bufferHeight-1)|0)*e.bufferWidth);let d=e.buffer[c]/255,p=e.buffer[c+1]/255,_=e.buffer[c+2]/255;const f=e.buffer[c+3]/255;h&&(d=1-d,p=1-p,_=1-_);const m=d*a.r+p*a.g+_*a.b;t.y=f>=l?e.minHeight+(e.maxHeight-e.minHeight)*m:e.minHeight-u,i.push(t.x,t.y,t.z),s.push(0,0,0),r.push(o/e.subdivisions,1-n/e.subdivisions)}for(n=0;n<e.subdivisions;n++)for(o=0;o<e.subdivisions;o++){const s=o+1+(n+1)*(e.subdivisions+1),r=o+1+n*(e.subdivisions+1),a=o+n*(e.subdivisions+1),l=o+(n+1)*(e.subdivisions+1),h=i[3*s+1]>=e.minHeight,c=i[3*r+1]>=e.minHeight,u=i[3*a+1]>=e.minHeight;h&&c&&u&&(t.push(s),t.push(r),t.push(a)),i[3*l+1]>=e.minHeight&&h&&u&&(t.push(l),t.push(s),t.push(a))}As.ComputeNormals(i,t,s);const c=new As;return c.indices=t,c.positions=i,c.normals=s,c.uvs=r,c}function sl(e,t={},i){const s=new Ja(e,i);return s._setReady(!1),s._subdivisionsX=t.subdivisionsX||t.subdivisions||1,s._subdivisionsY=t.subdivisionsY||t.subdivisions||1,s._width=t.width||1,s._height=t.height||1,s._maxX=s._width/2,s._maxZ=s._height/2,s._minX=-s._maxX,s._minZ=-s._maxZ,el(t).applyToMesh(s,t.updatable),s._setReady(!0),s}function rl(e){const t=[],i=[],s=[],r=[],n=e.diameter||1,o=e.thickness||.5,a=0|(e.tessellation||16),l=0===e.sideOrientation?0:e.sideOrientation||As.DEFAULTSIDE,h=a+1;for(let e=0;e<=a;e++){const l=e/a,c=e*Math.PI*2/a-Math.PI/2,u=y.Translation(n/2,0,0).multiply(y.RotationY(c));for(let n=0;n<=a;n++){const c=1-n/a,d=n*Math.PI*2/a+Math.PI,p=Math.cos(d),_=Math.sin(d);let f=new S(p,_,0),m=f.scale(o/2);const g=new E(l,c);m=S.TransformCoordinates(m,u),f=S.TransformNormal(f,u),i.push(m.x,m.y,m.z),s.push(f.x,f.y,f.z),r.push(g.x,Is.UseOpenGLOrientationForUV?1-g.y:g.y);const v=(e+1)%h,x=(n+1)%h;t.push(e*h+n),t.push(e*h+x),t.push(v*h+n),t.push(e*h+x),t.push(v*h+x),t.push(v*h+n)}}As._ComputeSides(l,i,t,s,r,e.frontUVs,e.backUVs);const c=new As;return c.indices=t,c.positions=i,c.normals=s,c.uvs=r,c}function nl(e,t={},i){const s=new ur(e,i);return t.sideOrientation=ur._GetDefaultSideOrientation(t.sideOrientation),s._originalBuilderSideOrientation=t.sideOrientation,rl(t).applyToMesh(s,t.updatable),s}As.CreateGround=el,As.CreateTiledGround=tl,As.CreateGroundFromHeightMap=il,ur.CreateGround=(e,t,i,s,r,n)=>sl(e,{width:t,height:i,subdivisions:s,updatable:n},r),ur.CreateTiledGround=(e,t,i,s,r,n,o,a,l)=>function(e,t,i=null){const s=new ur(e,i);return tl(t).applyToMesh(s,t.updatable),s}(e,{xmin:t,zmin:i,xmax:s,zmax:r,subdivisions:n,precision:o,updatable:l},a),ur.CreateGroundFromHeightMap=(e,t,i,s,r,n,o,a,l,h,c)=>function(e,t,i={},s=null){const r=i.width||10,n=i.height||10,o=i.subdivisions||1,a=i.minHeight||0,l=i.maxHeight||1,h=i.colorFilter||new N(.3,.59,.11),c=i.alphaFilter||0,u=i.updatable,d=i.onReady;s=s||x.LastCreatedScene;const p=new Ja(e,s);return p._subdivisionsX=o,p._subdivisionsY=o,p._width=r,p._height=n,p._maxX=p._width/2,p._maxZ=p._height/2,p._minX=-p._maxX,p._minZ=-p._maxZ,p._setReady(!1),Ht.LoadImage(t,(e=>{const t=e.width,i=e.height;if(s.isDisposed)return;const _=null==s?void 0:s.getEngine().resizeImageBitmap(e,t,i);il({width:r,height:n,subdivisions:o,minHeight:a,maxHeight:l,colorFilter:h,buffer:_,bufferWidth:t,bufferHeight:i,alphaFilter:c}).applyToMesh(p,u),d&&d(p),p._setReady(!0)}),(()=>{}),s.offlineProvider),p}(e,t,{width:i,height:s,subdivisions:r,minHeight:n,maxHeight:o,updatable:l,onReady:h,alphaFilter:c},a),As.CreateTorus=rl,ur.CreateTorus=(e,t,i,s,r,n,o)=>nl(e,{diameter:t,thickness:i,tessellation:s,sideOrientation:o,updatable:n},r);class ol{constructor(e,t=null){if(this.scene=e,this._pointerDownOnMeshAsked=!1,this._isActionableMesh=!1,this._teleportationRequestInitiated=!1,this._teleportationBackRequestInitiated=!1,this._rotationRightAsked=!1,this._rotationLeftAsked=!1,this._dpadPressed=!0,this._activePointer=!1,this._id=ol._IdCounter++,t)this._gazeTracker=t.clone("gazeTracker");else{this._gazeTracker=nl("gazeTracker",{diameter:.0035,thickness:.0025,tessellation:20,updatable:!1},e),this._gazeTracker.bakeCurrentTransformIntoVertices(),this._gazeTracker.isPickable=!1,this._gazeTracker.isVisible=!1;const t=new Va("targetMat",e);t.specularColor=N.Black(),t.emissiveColor=new N(.7,.7,.7),t.backFaceCulling=!1,this._gazeTracker.material=t}}_getForwardRay(e){return new Fr(S.Zero(),new S(0,0,e))}_selectionPointerDown(){this._pointerDownOnMeshAsked=!0,this._currentHit&&this.scene.simulatePointerDown(this._currentHit,{pointerId:this._id})}_selectionPointerUp(){this._currentHit&&this.scene.simulatePointerUp(this._currentHit,{pointerId:this._id}),this._pointerDownOnMeshAsked=!1}_activatePointer(){this._activePointer=!0}_deactivatePointer(){this._activePointer=!1}_updatePointerDistance(e=100){}dispose(){this._interactionsEnabled=!1,this._teleportationEnabled=!1,this._gazeTracker&&this._gazeTracker.dispose()}}ol._IdCounter=0;class al extends ol{constructor(e,t){super(t),this._getCamera=e}_getForwardRay(e){const t=this._getCamera();return t?t.getForwardRay(e):new Fr(S.Zero(),S.Forward())}}class ll{get onEnteringVR(){return this.onEnteringVRObservable}get onExitingVR(){return this.onExitingVRObservable}get teleportationTarget(){return this._teleportationTarget}set teleportationTarget(e){e&&(e.name="teleportationTarget",this._isDefaultTeleportationTarget=!1,this._teleportationTarget=e)}get gazeTrackerMesh(){return this._cameraGazer._gazeTracker}set gazeTrackerMesh(e){e&&(this._cameraGazer._gazeTracker&&this._cameraGazer._gazeTracker.dispose(),this._cameraGazer._gazeTracker=e,this._cameraGazer._gazeTracker.bakeCurrentTransformIntoVertices(),this._cameraGazer._gazeTracker.isPickable=!1,this._cameraGazer._gazeTracker.isVisible=!1,this._cameraGazer._gazeTracker.name="gazeTracker")}get displayGaze(){return this._displayGaze}set displayGaze(e){this._displayGaze=e,e||(this._cameraGazer._gazeTracker.isVisible=!1)}get displayLaserPointer(){return this._displayLaserPointer}set displayLaserPointer(e){this._displayLaserPointer=e}get deviceOrientationCamera(){return this._deviceOrientationCamera}get currentVRCamera(){return this._scene.activeCamera}get vrDeviceOrientationCamera(){return this._vrDeviceOrientationCamera}get vrButton(){return this._btnVR}get _teleportationRequestInitiated(){return this._cameraGazer._teleportationRequestInitiated}constructor(e,t={}){if(this.webVROptions=t,this._fullscreenVRpresenting=!1,this.enableGazeEvenWhenNoPointerLock=!1,this.exitVROnDoubleTap=!0,this.onEnteringVRObservable=new a,this.onAfterEnteringVRObservable=new a,this.onExitingVRObservable=new a,this._useCustomVRButton=!1,this._teleportActive=!1,this._floorMeshesCollection=[],this._teleportationMode=ll.TELEPORTATIONMODE_CONSTANTTIME,this._teleportationTime=122,this._teleportationSpeed=20,this._rotationAllowed=!0,this._teleportBackwardsVector=new S(0,-1,-1),this._isDefaultTeleportationTarget=!0,this._teleportationFillColor="#444444",this._teleportationBorderColor="#FFFFFF",this._rotationAngle=0,this._haloCenter=new S(0,0,0),this._padSensibilityUp=.65,this._padSensibilityDown=.35,this._pickedLaserColor=new N(.2,.2,1),this._pickedGazeColor=new N(0,0,1),this.onNewMeshSelected=new a,this.onNewMeshPicked=new a,this.onBeforeCameraTeleport=new a,this.onAfterCameraTeleport=new a,this.onSelectedMeshUnselected=new a,this.teleportationEnabled=!0,this._teleportationInitialized=!1,this._interactionsEnabled=!1,this._displayGaze=!0,this._displayLaserPointer=!0,this.updateGazeTrackerScale=!0,this.updateGazeTrackerColor=!0,this.updateControllerLaserColor=!0,this.requestPointerLockOnFullScreen=!0,this.xrTestDone=!1,this._onResize=()=>{this._moveButtonToBottomRight()},this._onFullscreenChange=()=>{this._fullscreenVRpresenting=!!document.fullscreenElement,!this._fullscreenVRpresenting&&this._inputElement&&(this.exitVR(),!this._useCustomVRButton&&this._btnVR&&(this._btnVR.style.top=this._inputElement.offsetTop+this._inputElement.offsetHeight-70+"px",this._btnVR.style.left=this._inputElement.offsetLeft+this._inputElement.offsetWidth-100+"px",this._updateButtonVisibility()))},this._cachedAngularSensibility={angularSensibilityX:null,angularSensibilityY:null,angularSensibility:null},this._beforeRender=()=>{this._scene.getEngine().isPointerLock||this.enableGazeEvenWhenNoPointerLock||(this._cameraGazer._gazeTracker.isVisible=!1)},this._onNewGamepadConnected=e=>{e.type!==xo.POSE_ENABLED&&(e.leftStick&&e.onleftstickchanged((e=>{this._teleportationInitialized&&this.teleportationEnabled&&(this._checkTeleportWithRay(e,this._cameraGazer),this._checkTeleportBackwards(e,this._cameraGazer))})),e.rightStick&&e.onrightstickchanged((e=>{this._teleportationInitialized&&this._checkRotate(e,this._cameraGazer)})),e.type===xo.XBOX&&(e.onbuttondown((e=>{this._interactionsEnabled&&e===po.A&&this._cameraGazer._selectionPointerDown()})),e.onbuttonup((e=>{this._interactionsEnabled&&e===po.A&&this._cameraGazer._selectionPointerUp()}))))},this._workingVector=S.Zero(),this._workingQuaternion=C.Identity(),this._workingMatrix=y.Identity(),k.Warn("WebVR is deprecated. Please avoid using this experience helper and use the WebXR experience helper instead"),this._scene=e,this._inputElement=e.getEngine().getInputElement(),"getVRDisplays"in navigator||void 0!==t.useXR||(t.useXR=!0),void 0===t.createFallbackVRDeviceOrientationFreeCamera&&(t.createFallbackVRDeviceOrientationFreeCamera=!0),void 0===t.createDeviceOrientationCamera&&(t.createDeviceOrientationCamera=!0),void 0===t.laserToggle&&(t.laserToggle=!0),this._hasEnteredVR=!1,this._scene.activeCamera?this._position=this._scene.activeCamera.position.clone():this._position=new S(0,this._defaultHeight,0),t.createDeviceOrientationCamera||!this._scene.activeCamera){if(this._deviceOrientationCamera=new Xo("deviceOrientationVRHelper",this._position.clone(),e),this._scene.activeCamera&&(this._deviceOrientationCamera.minZ=this._scene.activeCamera.minZ,this._deviceOrientationCamera.maxZ=this._scene.activeCamera.maxZ,this._scene.activeCamera instanceof Go&&this._scene.activeCamera.rotation)){const e=this._scene.activeCamera;e.rotationQuaternion?this._deviceOrientationCamera.rotationQuaternion.copyFrom(e.rotationQuaternion):this._deviceOrientationCamera.rotationQuaternion.copyFrom(C.RotationYawPitchRoll(e.rotation.y,e.rotation.x,e.rotation.z)),this._deviceOrientationCamera.rotation=e.rotation.clone()}this._scene.activeCamera=this._deviceOrientationCamera,this._inputElement&&this._scene.activeCamera.attachControl()}else this._existingCamera=this._scene.activeCamera;this.webVROptions.useXR&&navigator.xr?qa.IsSessionSupportedAsync("immersive-vr").then((i=>{i?(k.Log("Using WebXR. It is recommended to use the WebXRDefaultExperience directly"),e.createDefaultXRExperienceAsync({floorMeshes:t.floorMeshes||[]}).then((t=>{this.xr=t,this.xrTestDone=!0,this._cameraGazer=new al((()=>this.xr.baseExperience.camera),e),this.xr.baseExperience.onStateChangedObservable.add((e=>{switch(e){case Qa.ENTERING_XR:this.onEnteringVRObservable.notifyObservers(this),this._interactionsEnabled||this.xr.pointerSelection.detach(),this.xr.pointerSelection.displayLaserPointer=this._displayLaserPointer;break;case Qa.EXITING_XR:this.onExitingVRObservable.notifyObservers(this),this._scene.getEngine().resize();break;case Qa.IN_XR:this._hasEnteredVR=!0;break;case Qa.NOT_IN_XR:this._hasEnteredVR=!1}}))}))):this._completeVRInit(e,t)})):this._completeVRInit(e,t)}_completeVRInit(e,t){if(this.xrTestDone=!0,t.createFallbackVRDeviceOrientationFreeCamera&&(this._vrDeviceOrientationCamera=new ya("VRDeviceOrientationVRHelper",this._position,this._scene,!0,t.vrDeviceOrientationCameraMetrics),this._vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._cameraGazer=new al((()=>this.currentVRCamera),e),!this._useCustomVRButton){this._btnVR=document.createElement("BUTTON"),this._btnVR.className="babylonVRicon",this._btnVR.id="babylonVRiconbtn",this._btnVR.title="Click to switch to VR";let e=".babylonVRicon { position: absolute; right: 20px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A":"https://cdn.babylonjs.com/Assets/vrButton.png")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";e+=".babylonVRicon.vrdisplaypresenting { display: none; }";const t=document.createElement("style");t.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(t),this._moveButtonToBottomRight()}this._btnVR&&this._btnVR.addEventListener("click",(()=>{this.isInVRMode||this.enterVR()}));const i=this._scene.getEngine().getHostWindow();i&&(i.addEventListener("resize",this._onResize),document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),t.createFallbackVRDeviceOrientationFreeCamera&&this._displayVRButton(),this._onKeyDown=e=>{27===e.keyCode&&this.isInVRMode&&this.exitVR()},document.addEventListener("keydown",this._onKeyDown),this._scene.onPrePointerObservable.add((()=>{this._hasEnteredVR&&this.exitVROnDoubleTap&&(this.exitVR(),this._fullscreenVRpresenting&&this._scene.getEngine().exitFullscreen())}),gi.POINTERDOUBLETAP,!1),e.onDisposeObservable.add((()=>{this.dispose()})),this._updateButtonVisibility(),this._circleEase=new is,this._circleEase.setEasingMode(ts.EASINGMODE_EASEINOUT),this._teleportationEasing=this._circleEase,e.onPointerObservable.add((t=>{this._interactionsEnabled&&e.activeCamera===this.vrDeviceOrientationCamera&&"mouse"===t.event.pointerType&&(t.type===gi.POINTERDOWN?this._cameraGazer._selectionPointerDown():t.type===gi.POINTERUP&&this._cameraGazer._selectionPointerUp())})),this.webVROptions.floorMeshes&&this.enableTeleportation({floorMeshes:this.webVROptions.floorMeshes}))}get isInVRMode(){return this.xr&&this.webVROptions.useXR&&this.xr.baseExperience.state===Qa.IN_XR||this._fullscreenVRpresenting}_moveButtonToBottomRight(){if(this._inputElement&&!this._useCustomVRButton&&this._btnVR){const e=this._inputElement.getBoundingClientRect();this._btnVR.style.top=e.top+e.height-70+"px",this._btnVR.style.left=e.left+e.width-100+"px"}}_displayVRButton(){this._useCustomVRButton||this._btnVRDisplayed||!this._btnVR||(document.body.appendChild(this._btnVR),this._btnVRDisplayed=!0)}_updateButtonVisibility(){this._btnVR&&!this._useCustomVRButton&&(this._btnVR.className="babylonVRicon",this.isInVRMode&&(this._btnVR.className+=" vrdisplaypresenting"))}enterVR(){if(this.xr)this.xr.baseExperience.enterXRAsync("immersive-vr","local-floor",this.xr.renderTarget);else{if(this.onEnteringVRObservable)try{this.onEnteringVRObservable.notifyObservers(this)}catch(e){k.Warn("Error in your custom logic onEnteringVR: "+e)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone(),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.rotation=C.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles(),this.vrDeviceOrientationCamera.angularSensibility=2e3),this._existingCamera=this._scene.activeCamera,this._existingCamera.angularSensibilityX&&(this._cachedAngularSensibility.angularSensibilityX=this._existingCamera.angularSensibilityX,this._existingCamera.angularSensibilityX=Number.MAX_VALUE),this._existingCamera.angularSensibilityY&&(this._cachedAngularSensibility.angularSensibilityY=this._existingCamera.angularSensibilityY,this._existingCamera.angularSensibilityY=Number.MAX_VALUE),this._existingCamera.angularSensibility&&(this._cachedAngularSensibility.angularSensibility=this._existingCamera.angularSensibility,this._existingCamera.angularSensibility=Number.MAX_VALUE)),this._vrDeviceOrientationCamera&&(this._vrDeviceOrientationCamera.position=this._position,this._scene.activeCamera&&(this._vrDeviceOrientationCamera.minZ=this._scene.activeCamera.minZ),this._scene.activeCamera=this._vrDeviceOrientationCamera,this._scene.getEngine().enterFullscreen(this.requestPointerLockOnFullScreen),this._updateButtonVisibility(),this._vrDeviceOrientationCamera.onViewMatrixChangedObservable.addOnce((()=>{this.onAfterEnteringVRObservable.notifyObservers({success:!0})}))),this._scene.activeCamera&&this._inputElement&&this._scene.activeCamera.attachControl(),this._interactionsEnabled&&this._scene.registerBeforeRender(this._beforeRender),this._hasEnteredVR=!0}}exitVR(){if(this.xr)this.xr.baseExperience.exitXRAsync();else if(this._hasEnteredVR){if(this.onExitingVRObservable)try{this.onExitingVRObservable.notifyObservers(this)}catch(e){k.Warn("Error in your custom logic onExitingVR: "+e)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone()),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._deviceOrientationCamera?(this._deviceOrientationCamera.position=this._position,this._scene.activeCamera=this._deviceOrientationCamera,this._cachedAngularSensibility.angularSensibilityX&&(this._deviceOrientationCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._deviceOrientationCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._deviceOrientationCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)):this._existingCamera&&(this._existingCamera.position=this._position,this._scene.activeCamera=this._existingCamera,this._inputElement&&this._scene.activeCamera.attachControl(),this._cachedAngularSensibility.angularSensibilityX&&(this._existingCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._existingCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._existingCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)),this._updateButtonVisibility(),this._interactionsEnabled&&(this._scene.unregisterBeforeRender(this._beforeRender),this._cameraGazer._gazeTracker.isVisible=!1),this._scene.getEngine().resize(),this._hasEnteredVR=!1}}get position(){return this._position}set position(e){this._position=e,this._scene.activeCamera&&(this._scene.activeCamera.position=e)}enableInteractions(){if(!this._interactionsEnabled){if(this.xr)return void(this.xr.baseExperience.state===Qa.IN_XR&&this.xr.pointerSelection.attach());this.raySelectionPredicate=e=>e.isVisible&&(e.isPickable||e.name===this._floorMeshName),this.meshSelectionPredicate=()=>!0,this._raySelectionPredicate=e=>!!(this._isTeleportationFloor(e)||-1===e.name.indexOf("gazeTracker")&&-1===e.name.indexOf("teleportationTarget")&&-1===e.name.indexOf("torusTeleportation"))&&this.raySelectionPredicate(e),this._interactionsEnabled=!0}}_isTeleportationFloor(e){for(let t=0;t<this._floorMeshesCollection.length;t++)if(this._floorMeshesCollection[t].id===e.id)return!0;return!(!this._floorMeshName||e.name!==this._floorMeshName)}addFloorMesh(e){this._floorMeshesCollection&&(this._floorMeshesCollection.indexOf(e)>-1||this._floorMeshesCollection.push(e))}removeFloorMesh(e){if(!this._floorMeshesCollection)return;const t=this._floorMeshesCollection.indexOf(e);-1!==t&&this._floorMeshesCollection.splice(t,1)}enableTeleportation(e={}){if(!this._teleportationInitialized){if(this.enableInteractions(),this.webVROptions.useXR&&(e.floorMeshes||e.floorMeshName)){const t=e.floorMeshes||[];if(!t.length){const i=this._scene.getMeshByName(e.floorMeshName);i&&t.push(i)}if(this.xr)return t.forEach((e=>{this.xr.teleportation.addFloorMesh(e)})),void(this.xr.teleportation.attached||this.xr.teleportation.attach());if(!this.xrTestDone){const t=()=>{this.xrTestDone&&(this._scene.unregisterBeforeRender(t),this.xr?this.xr.teleportation.attached||this.xr.teleportation.attach():this.enableTeleportation(e))};return void this._scene.registerBeforeRender(t)}}e.floorMeshName&&(this._floorMeshName=e.floorMeshName),e.floorMeshes&&(this._floorMeshesCollection=e.floorMeshes),e.teleportationMode&&(this._teleportationMode=e.teleportationMode),e.teleportationTime&&e.teleportationTime>0&&(this._teleportationTime=e.teleportationTime),e.teleportationSpeed&&e.teleportationSpeed>0&&(this._teleportationSpeed=e.teleportationSpeed),void 0!==e.easingFunction&&(this._teleportationEasing=e.easingFunction);const t=new Zt;t.vignetteColor=new F(0,0,0,0),t.vignetteEnabled=!0,this._teleportationInitialized=!0,this._isDefaultTeleportationTarget&&this._createTeleportationCircles()}}_checkTeleportWithRay(e,t){this._teleportationRequestInitiated&&!t._teleportationRequestInitiated||(t._teleportationRequestInitiated?Math.sqrt(e.y*e.y+e.x*e.x)<this._padSensibilityDown&&(this._teleportActive&&this.teleportCamera(this._haloCenter),t._teleportationRequestInitiated=!1):e.y<-this._padSensibilityUp&&t._dpadPressed&&(t._activatePointer(),t._teleportationRequestInitiated=!0))}_checkRotate(e,t){t._teleportationRequestInitiated||(t._rotationLeftAsked?e.x>-this._padSensibilityDown&&(t._rotationLeftAsked=!1):e.x<-this._padSensibilityUp&&t._dpadPressed&&(t._rotationLeftAsked=!0,this._rotationAllowed&&this._rotateCamera(!1)),t._rotationRightAsked?e.x<this._padSensibilityDown&&(t._rotationRightAsked=!1):e.x>this._padSensibilityUp&&t._dpadPressed&&(t._rotationRightAsked=!0,this._rotationAllowed&&this._rotateCamera(!0)))}_checkTeleportBackwards(e,t){if(!t._teleportationRequestInitiated)if(e.y>this._padSensibilityUp&&t._dpadPressed){if(!t._teleportationBackRequestInitiated){if(!this.currentVRCamera)return;const e=C.FromRotationMatrix(this.currentVRCamera.getWorldMatrix().getRotationMatrix()),i=this.currentVRCamera.position;e.toEulerAnglesToRef(this._workingVector),this._workingVector.z=0,this._workingVector.x=0,C.RotationYawPitchRollToRef(this._workingVector.y,this._workingVector.x,this._workingVector.z,this._workingQuaternion),this._workingQuaternion.toRotationMatrix(this._workingMatrix),S.TransformCoordinatesToRef(this._teleportBackwardsVector,this._workingMatrix,this._workingVector);const s=new Fr(i,this._workingVector),r=this._scene.pickWithRay(s,this._raySelectionPredicate);r&&r.pickedPoint&&r.pickedMesh&&this._isTeleportationFloor(r.pickedMesh)&&r.distance<5&&this.teleportCamera(r.pickedPoint),t._teleportationBackRequestInitiated=!0}}else t._teleportationBackRequestInitiated=!1}_createTeleportationCircles(){this._teleportationTarget=sl("teleportationTarget",{width:2,height:2,subdivisions:2},this._scene),this._teleportationTarget.isPickable=!1;const e=new ka("DynamicTexture",512,this._scene,!0);e.hasAlpha=!0;const t=e.getContext();t.beginPath(),t.arc(256,256,200,0,2*Math.PI,!1),t.fillStyle=this._teleportationFillColor,t.fill(),t.lineWidth=10,t.strokeStyle=this._teleportationBorderColor,t.stroke(),t.closePath(),e.update();const i=new Va("TextPlaneMaterial",this._scene);i.diffuseTexture=e,this._teleportationTarget.material=i;const s=nl("torusTeleportation",{diameter:.75,thickness:.1,tessellation:25,updatable:!1},this._scene);s.isPickable=!1,s.parent=this._teleportationTarget;const r=new Ie("animationInnerCircle","position.y",30,Ie.ANIMATIONTYPE_FLOAT,Ie.ANIMATIONLOOPMODE_CYCLE),n=[];n.push({frame:0,value:0}),n.push({frame:30,value:.4}),n.push({frame:60,value:0}),r.setKeys(n);const o=new rs;o.setEasingMode(ts.EASINGMODE_EASEINOUT),r.setEasingFunction(o),s.animations=[],s.animations.push(r),this._scene.beginAnimation(s,0,60,!0),this._hideTeleportationTarget()}_hideTeleportationTarget(){this._teleportActive=!1,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!1,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!1))}_rotateCamera(e){if(!(this.currentVRCamera instanceof zo))return;e?this._rotationAngle++:this._rotationAngle--,this.currentVRCamera.animations=[];const t=C.FromRotationMatrix(y.RotationY(Math.PI/4*this._rotationAngle)),i=new Ie("animationRotation","rotationQuaternion",90,Ie.ANIMATIONTYPE_QUATERNION,Ie.ANIMATIONLOOPMODE_CONSTANT),s=[];s.push({frame:0,value:this.currentVRCamera.rotationQuaternion}),s.push({frame:6,value:t}),i.setKeys(s),i.setEasingFunction(this._circleEase),this.currentVRCamera.animations.push(i),this._postProcessMove.animations=[];const r=new Ie("animationPP","vignetteWeight",90,Ie.ANIMATIONTYPE_FLOAT,Ie.ANIMATIONLOOPMODE_CONSTANT),n=[];n.push({frame:0,value:0}),n.push({frame:3,value:4}),n.push({frame:6,value:0}),r.setKeys(n),r.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(r);const o=new Ie("animationPP2","vignetteStretch",90,Ie.ANIMATIONTYPE_FLOAT,Ie.ANIMATIONLOOPMODE_CONSTANT),a=[];a.push({frame:0,value:0}),a.push({frame:3,value:10}),a.push({frame:6,value:0}),o.setKeys(a),o.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(o),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._postProcessMove.samples=4,this._scene.beginAnimation(this.currentVRCamera,0,6,!1,1)}teleportCamera(e){if(!(this.currentVRCamera instanceof zo))return;let t,i;if(this._workingVector.copyFrom(e),this.isInVRMode||(this._workingVector.y+=this._defaultHeight),this.onBeforeCameraTeleport.notifyObservers(this._workingVector),this._teleportationMode==ll.TELEPORTATIONMODE_CONSTANTSPEED){i=90;const e=S.Distance(this.currentVRCamera.position,this._workingVector);t=this._teleportationSpeed/e}else i=Math.round(90*this._teleportationTime/1e3),t=1;this.currentVRCamera.animations=[];const s=new Ie("animationCameraTeleportation","position",90,Ie.ANIMATIONTYPE_VECTOR3,Ie.ANIMATIONLOOPMODE_CONSTANT),r=[{frame:0,value:this.currentVRCamera.position},{frame:i,value:this._workingVector}];s.setKeys(r),s.setEasingFunction(this._teleportationEasing),this.currentVRCamera.animations.push(s),this._postProcessMove.animations=[];const n=Math.round(i/2),o=new Ie("animationPP","vignetteWeight",90,Ie.ANIMATIONTYPE_FLOAT,Ie.ANIMATIONLOOPMODE_CONSTANT),a=[];a.push({frame:0,value:0}),a.push({frame:n,value:8}),a.push({frame:i,value:0}),o.setKeys(a),this._postProcessMove.animations.push(o);const l=new Ie("animationPP2","vignetteStretch",90,Ie.ANIMATIONTYPE_FLOAT,Ie.ANIMATIONLOOPMODE_CONSTANT),h=[];h.push({frame:0,value:0}),h.push({frame:n,value:10}),h.push({frame:i,value:0}),l.setKeys(h),this._postProcessMove.animations.push(l),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._scene.beginAnimation(this.currentVRCamera,0,i,!1,t,(()=>{this.onAfterCameraTeleport.notifyObservers(this._workingVector)})),this._hideTeleportationTarget()}setLaserColor(e,t=this._pickedLaserColor){this._pickedLaserColor=t}setLaserLightingState(e=!0){}setGazeColor(e,t=this._pickedGazeColor){this._pickedGazeColor=t}changeLaserColor(e){this.updateControllerLaserColor}changeGazeColor(e){this.updateGazeTrackerColor&&this._cameraGazer._gazeTracker.material&&(this._cameraGazer._gazeTracker.material.emissiveColor=e)}dispose(){this.isInVRMode&&this.exitVR(),this._postProcessMove&&this._postProcessMove.dispose(),this._vrDeviceOrientationCamera&&this._vrDeviceOrientationCamera.dispose(),!this._useCustomVRButton&&this._btnVR&&this._btnVR.parentNode&&document.body.removeChild(this._btnVR),this._deviceOrientationCamera&&this._scene.activeCamera!=this._deviceOrientationCamera&&this._deviceOrientationCamera.dispose(),this._cameraGazer&&this._cameraGazer.dispose(),this._teleportationTarget&&this._teleportationTarget.dispose(),this.xr&&this.xr.dispose(),this._floorMeshesCollection.length=0,document.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChangeBind),window.removeEventListener("resize",this._onResize),document.removeEventListener("fullscreenchange",this._onFullscreenChange),this._scene.gamepadManager.onGamepadConnectedObservable.removeCallback(this._onNewGamepadConnected),this._scene.unregisterBeforeRender(this._beforeRender)}getClassName(){return"VRExperienceHelper"}}ll.TELEPORTATIONMODE_CONSTANTTIME=0,ll.TELEPORTATIONMODE_CONSTANTSPEED=1;const hl=function(){const e={root:0,found:!1};return function(t,i,s,r){e.root=0,e.found=!1;const n=i*i-4*t*s;if(n<0)return e;const o=Math.sqrt(n);let a=(-i-o)/(2*t),l=(-i+o)/(2*t);if(a>l){const e=l;l=a,a=e}return a>0&&a<r?(e.root=a,e.found=!0,e):l>0&&l<r?(e.root=l,e.found=!0,e):e}}();class cl{constructor(){this._collisionPoint=S.Zero(),this._planeIntersectionPoint=S.Zero(),this._tempVector=S.Zero(),this._tempVector2=S.Zero(),this._tempVector3=S.Zero(),this._tempVector4=S.Zero(),this._edge=S.Zero(),this._baseToVertex=S.Zero(),this._destinationPoint=S.Zero(),this._slidePlaneNormal=S.Zero(),this._displacementVector=S.Zero(),this._radius=S.One(),this._retry=0,this._basePointWorld=S.Zero(),this._velocityWorld=S.Zero(),this._normalizedVelocity=S.Zero(),this._collisionMask=-1}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}get slidePlaneNormal(){return this._slidePlaneNormal}_initialize(e,t,i){this._velocity=t,this._velocitySquaredLength=this._velocity.lengthSquared();const s=Math.sqrt(this._velocitySquaredLength);0===s||1===s?this._normalizedVelocity.copyFromFloats(t._x,t._y,t._z):t.scaleToRef(1/s,this._normalizedVelocity),this._basePoint=e,e.multiplyToRef(this._radius,this._basePointWorld),t.multiplyToRef(this._radius,this._velocityWorld),this._velocityWorldLength=this._velocityWorld.length(),this._epsilon=i,this.collisionFound=!1}_checkPointInTriangle(e,t,i,s,r){t.subtractToRef(e,this._tempVector),i.subtractToRef(e,this._tempVector2),S.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);let n=S.Dot(this._tempVector4,r);return!(n<0)&&(s.subtractToRef(e,this._tempVector3),S.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4),n=S.Dot(this._tempVector4,r),!(n<0)&&(S.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4),n=S.Dot(this._tempVector4,r),n>=0))}_canDoCollision(e,t,i,s){const r=S.Distance(this._basePointWorld,e),n=Math.max(this._radius.x,this._radius.y,this._radius.z);return!(r>this._velocityWorldLength+n+t||!((e,t,i,s)=>!(e.x>i.x+s||i.x-s>t.x||e.y>i.y+s||i.y-s>t.y||e.z>i.z+s||i.z-s>t.z))(i,s,this._basePointWorld,this._velocityWorldLength+n))}_testTriangle(e,t,i,s,r,n,o){let a,l=!1;t||(t=[]),t[e]||(t[e]=new wi(0,0,0,0),t[e].copyFromPoints(i,s,r));const h=t[e];if(!n&&!h.isFrontFacingTo(this._normalizedVelocity,0))return;const c=h.signedDistanceTo(this._basePoint),u=S.Dot(h.normal,this._velocity);if(cl.DoubleSidedCheck&&u>1e-4)return;if(0==u){if(Math.abs(c)>=1)return;l=!0,a=0}else{a=(-1-c)/u;let e=(1-c)/u;if(a>e){const t=e;e=a,a=t}if(a>1||e<0)return;a<0&&(a=0),a>1&&(a=1)}this._collisionPoint.copyFromFloats(0,0,0);let d=!1,p=1;if(l||(this._basePoint.subtractToRef(h.normal,this._planeIntersectionPoint),this._velocity.scaleToRef(a,this._tempVector),this._planeIntersectionPoint.addInPlace(this._tempVector),this._checkPointInTriangle(this._planeIntersectionPoint,i,s,r,h.normal)&&(d=!0,p=a,this._collisionPoint.copyFrom(this._planeIntersectionPoint))),!d){let e=this._velocitySquaredLength;this._basePoint.subtractToRef(i,this._tempVector);let t=2*S.Dot(this._velocity,this._tempVector),n=this._tempVector.lengthSquared()-1,o=hl(e,t,n,p);o.found&&(p=o.root,d=!0,this._collisionPoint.copyFrom(i)),this._basePoint.subtractToRef(s,this._tempVector),t=2*S.Dot(this._velocity,this._tempVector),n=this._tempVector.lengthSquared()-1,o=hl(e,t,n,p),o.found&&(p=o.root,d=!0,this._collisionPoint.copyFrom(s)),this._basePoint.subtractToRef(r,this._tempVector),t=2*S.Dot(this._velocity,this._tempVector),n=this._tempVector.lengthSquared()-1,o=hl(e,t,n,p),o.found&&(p=o.root,d=!0,this._collisionPoint.copyFrom(r)),s.subtractToRef(i,this._edge),i.subtractToRef(this._basePoint,this._baseToVertex);let a=this._edge.lengthSquared(),l=S.Dot(this._edge,this._velocity),h=S.Dot(this._edge,this._baseToVertex);if(e=a*-this._velocitySquaredLength+l*l,t=2*(a*S.Dot(this._velocity,this._baseToVertex)-l*h),n=a*(1-this._baseToVertex.lengthSquared())+h*h,o=hl(e,t,n,p),o.found){const e=(l*o.root-h)/a;e>=0&&e<=1&&(p=o.root,d=!0,this._edge.scaleInPlace(e),i.addToRef(this._edge,this._collisionPoint))}if(r.subtractToRef(s,this._edge),s.subtractToRef(this._basePoint,this._baseToVertex),a=this._edge.lengthSquared(),l=S.Dot(this._edge,this._velocity),h=S.Dot(this._edge,this._baseToVertex),e=a*-this._velocitySquaredLength+l*l,t=2*(a*S.Dot(this._velocity,this._baseToVertex)-l*h),n=a*(1-this._baseToVertex.lengthSquared())+h*h,o=hl(e,t,n,p),o.found){const e=(l*o.root-h)/a;e>=0&&e<=1&&(p=o.root,d=!0,this._edge.scaleInPlace(e),s.addToRef(this._edge,this._collisionPoint))}if(i.subtractToRef(r,this._edge),r.subtractToRef(this._basePoint,this._baseToVertex),a=this._edge.lengthSquared(),l=S.Dot(this._edge,this._velocity),h=S.Dot(this._edge,this._baseToVertex),e=a*-this._velocitySquaredLength+l*l,t=2*(a*S.Dot(this._velocity,this._baseToVertex)-l*h),n=a*(1-this._baseToVertex.lengthSquared())+h*h,o=hl(e,t,n,p),o.found){const e=(l*o.root-h)/a;e>=0&&e<=1&&(p=o.root,d=!0,this._edge.scaleInPlace(e),r.addToRef(this._edge,this._collisionPoint))}}if(d){const e=p*p*this._velocitySquaredLength;(!this.collisionFound||e<this._nearestDistanceSquared)&&(o.collisionResponse&&(this.intersectionPoint?this.intersectionPoint.copyFrom(this._collisionPoint):this.intersectionPoint=this._collisionPoint.clone(),this._nearestDistanceSquared=e,this._nearestDistance=Math.sqrt(e),this.collisionFound=!0),this.collidedMesh=o)}}_collide(e,t,i,s,r,n,o,a,l,h=!1){if(h)if(i&&0!==i.length)for(let n=s;n<r-2;n+=1){const s=i[n],r=i[n+1],h=i[n+2];if(4294967295===h){n+=2;continue}const c=t[s],u=t[r],d=t[h];c&&u&&d&&((l?1:0)^n%2?this._testTriangle(n,e,c,u,d,o,a):this._testTriangle(n,e,u,c,d,o,a))}else for(let i=0;i<t.length-2;i+=1){const s=t[i],r=t[i+1],n=t[i+2];s&&r&&n&&((l?1:0)^i%2?this._testTriangle(i,e,s,r,n,o,a):this._testTriangle(i,e,r,s,n,o,a))}else if(i&&0!==i.length)for(let h=s;h<r;h+=3){const s=t[i[h]-n],r=t[i[h+1]-n],c=t[i[h+2]-n];l?this._testTriangle(h,e,s,r,c,o,a):this._testTriangle(h,e,c,r,s,o,a)}else for(let i=0;i<t.length;i+=3){const s=t[i],r=t[i+1],n=t[i+2];l?this._testTriangle(i,e,s,r,n,o,a):this._testTriangle(i,e,n,r,s,o,a)}}_getResponse(e,t){e.addToRef(t,this._destinationPoint),t.scaleInPlace(this._nearestDistance/t.length()),this._basePoint.addToRef(t,e),e.subtractToRef(this.intersectionPoint,this._slidePlaneNormal),this._slidePlaneNormal.normalize(),this._slidePlaneNormal.scaleToRef(this._epsilon,this._displacementVector),e.addInPlace(this._displacementVector),this.intersectionPoint.addInPlace(this._displacementVector),this._slidePlaneNormal.scaleInPlace(wi.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint)),this._destinationPoint.subtractInPlace(this._slidePlaneNormal),this._destinationPoint.subtractToRef(this.intersectionPoint,t)}}cl.DoubleSidedCheck=!1;class ul{constructor(){this._scaledPosition=S.Zero(),this._scaledVelocity=S.Zero(),this._finalPosition=S.Zero()}getNewPosition(e,t,i,s,r,n,o){e.divideToRef(i._radius,this._scaledPosition),t.divideToRef(i._radius,this._scaledVelocity),i.collidedMesh=null,i._retry=0,i._initialVelocity=this._scaledVelocity,i._initialPosition=this._scaledPosition,this._collideWithWorld(this._scaledPosition,this._scaledVelocity,i,s,this._finalPosition,r),this._finalPosition.multiplyInPlace(i._radius),n(o,this._finalPosition,i.collidedMesh)}createCollider(){return new cl}init(e){this._scene=e}_collideWithWorld(e,t,i,s,r,n=null){const o=10*Ns.CollisionsEpsilon;if(i._retry>=s)return void r.copyFrom(e);const a=n?n.collisionMask:i.collisionMask;i._initialize(e,t,o);const l=n&&n.surroundingMeshes||this._scene.meshes;for(let e=0;e<l.length;e++){const t=l[e];t.isEnabled()&&t.checkCollisions&&t.subMeshes&&t!==n&&a&t.collisionGroup&&t._checkCollision(i)}i.collisionFound?(0===t.x&&0===t.y&&0===t.z||i._getResponse(e,t),t.length()<=o?r.copyFrom(e):(i._retry++,this._collideWithWorld(e,t,i,s,r,n))):e.addToRef(t,r)}}Yi.CollisionCoordinatorFactory=()=>new ul;class dl{constructor(e,t,i,s=""){var r,n;let o;this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.uniqueId=0,this.onCompileObservable=new a,this.onErrorObservable=new a,this.onBindObservable=new a,this._wasPreviouslyReady=!1,this._isReady=!1,this._compilationError="",this._key="",this._computeSourceCodeOverride="",this._pipelineContext=null,this._computeSourceCode="",this._rawComputeSourceCode="",this._shaderLanguage=qe.WGSL,this.name=e,this._key=s,this._engine=i,this.uniqueId=dl._UniqueIdSeed++,this.defines=null!==(r=t.defines)&&void 0!==r?r:"",this.onError=t.onError,this.onCompiled=t.onCompiled,this._entryPoint=null!==(n=t.entryPoint)&&void 0!==n?n:"main",this._shaderStore=nt.GetShadersStore(this._shaderLanguage),this._shaderRepository=nt.GetShadersRepository(this._shaderLanguage),this._includeShaderStore=nt.GetIncludesShadersStore(this._shaderLanguage);const l=Me()?this._engine.getHostDocument():null;e.computeSource?o="source:"+e.computeSource:e.computeElement?(o=l?l.getElementById(e.computeElement):null,o||(o=e.computeElement)):o=e.compute||e;const h={defines:this.defines.split("\n"),indexParameters:void 0,isFragment:!1,shouldUseHighPrecisionShader:!1,processor:null,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:this._shaderRepository,includesShadersStore:this._includeShaderStore,version:(100*this._engine.version).toString(),platformName:this._engine.shaderPlatformName,processingContext:null,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer};this._loadShader(o,"Compute","",(i=>{rt.Initialize(h),rt.PreProcess(i,h,(s=>{this._rawComputeSourceCode=i,t.processFinalCode&&(s=t.processFinalCode(s));const r=rt.Finalize(s,"",h);this._useFinalCode(r.vertexCode,e)}),this._engine)}))}_useFinalCode(e,t){if(t){const i=t.computeElement||t.compute||t.spectorName||t;this._computeSourceCode="//#define SHADER_NAME compute:"+i+"\n"+e}else this._computeSourceCode=e;this._prepareEffect()}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch(e){return!1}}_isReadyInternal(){return!!this._isReady||!!this._pipelineContext&&this._pipelineContext.isReady}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getCompilationError(){return this._compilationError}executeWhenCompiled(e){this.isReady()?e(this):(this.onCompileObservable.add((t=>{e(t)})),this._pipelineContext&&!this._pipelineContext.isAsync||setTimeout((()=>{this._checkIsReady(null)}),16))}_checkIsReady(e){try{if(this._isReadyInternal())return}catch(t){return void this._processCompilationErrors(t,e)}setTimeout((()=>{this._checkIsReady(e)}),16)}_loadShader(e,t,i,s){if("undefined"!=typeof HTMLElement&&e instanceof HTMLElement)return void s(Ne(e));if("source:"===e.substr(0,7))return void s(e.substr(7));if("base64:"===e.substr(0,7))return void s(window.atob(e.substr(7)));if(this._shaderStore[e+t+"Shader"])return void s(this._shaderStore[e+t+"Shader"]);if(i&&this._shaderStore[e+i+"Shader"])return void s(this._shaderStore[e+i+"Shader"]);let r;r="."===e[0]||"/"===e[0]||e.indexOf("http")>-1?e:this._shaderRepository+e,this._engine._loadFile(r+"."+t.toLowerCase()+".fx",s)}get computeSourceCode(){var e,t;return this._computeSourceCodeOverride?this._computeSourceCodeOverride:null!==(t=null===(e=this._pipelineContext)||void 0===e?void 0:e._getComputeShaderCode())&&void 0!==t?t:this._computeSourceCode}get rawComputeSourceCode(){return this._rawComputeSourceCode}_prepareEffect(){const e=this.defines,t=this._pipelineContext;this._isReady=!1;try{const i=this._engine;this._pipelineContext=i.createComputePipelineContext(),this._pipelineContext._name=this._key,i._prepareComputePipelineContext(this._pipelineContext,this._computeSourceCodeOverride?this._computeSourceCodeOverride:this._computeSourceCode,this._rawComputeSourceCode,this._computeSourceCodeOverride?null:e,this._entryPoint),i._executeWhenComputeStateIsCompiled(this._pipelineContext,(()=>{this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),t&&this.getEngine()._deleteComputePipelineContext(t)})),this._pipelineContext.isAsync&&this._checkIsReady(t)}catch(e){this._processCompilationErrors(e,t)}}_getShaderCodeAndErrorLine(e,t){const i=/COMPUTE SHADER ERROR: 0:(\d+?):/;let s=null;if(t&&e){const r=t.match(i);if(r&&2===r.length){const t=parseInt(r[1]),i=e.split("\n",-1);i.length>=t&&(s=`Offending line [${t}] in compute code: ${i[t-1]}`)}}return[e,s]}_processCompilationErrors(e,t=null){var i;if(this._compilationError=e.message,k.Error("Unable to compile compute effect:"),k.Error("Defines:\n"+this.defines),dl.LogShaderCodeOnCompilationError){let e=null,t=null;(null===(i=this._pipelineContext)||void 0===i?void 0:i._getComputeShaderCode())&&([t,e]=this._getShaderCodeAndErrorLine(this._pipelineContext._getComputeShaderCode(),this._compilationError),t&&(k.Error("Compute code:"),k.Error(t))),e&&k.Error(e)}k.Error("Error: "+this._compilationError),t&&(this._pipelineContext=t,this._isReady=!0,this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this))}dispose(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseComputeEffect(this)}static RegisterShader(e,t){nt.GetShadersStore(qe.WGSL)[`${e}ComputeShader`]=t}}var pl,_l,fl,ml,gl;dl._UniqueIdSeed=0,dl.LogShaderCodeOnCompilationError=!0,function(e){e[e.Texture=0]="Texture",e[e.StorageTexture=1]="StorageTexture",e[e.UniformBuffer=2]="UniformBuffer",e[e.StorageBuffer=3]="StorageBuffer",e[e.TextureWithoutSampler=4]="TextureWithoutSampler",e[e.Sampler=5]="Sampler",e[e.ExternalTexture=6]="ExternalTexture"}(pl||(pl={})),bt.prototype.createComputeEffect=function(e,t){throw new Error("createComputeEffect: This engine does not support compute shaders!")},bt.prototype.createComputePipelineContext=function(){throw new Error("createComputePipelineContext: This engine does not support compute shaders!")},bt.prototype.createComputeContext=function(){},bt.prototype.computeDispatch=function(e,t,i,s,r,n,o){throw new Error("computeDispatch: This engine does not support compute shaders!")},bt.prototype.areAllComputeEffectsReady=function(){return!0},bt.prototype.releaseComputeEffects=function(){},bt.prototype._prepareComputePipelineContext=function(e,t,i,s,r){},bt.prototype._rebuildComputeEffects=function(){},bt.prototype._executeWhenComputeStateIsCompiled=function(e,t){t()},bt.prototype._releaseComputeEffect=function(e){},bt.prototype._deleteComputePipelineContext=function(e){};class vl{get options(){return this._options}get shaderPath(){return this._shaderPath}constructor(e,t,i,s={}){this._bindings={},this._samplers={},this._contextIsDirty=!1,this.onCompiled=null,this.onError=null,this.name=e,this._engine=t,this.uniqueId=Bi.UniqueId,this._engine.getCaps().supportComputeShaders?s.bindingsMapping?(this._context=t.createComputeContext(),this._shaderPath=i,this._options=Object.assign({bindingsMapping:{},defines:[]},s)):k.Error("You must provide the binding mappings as browsers don't support reflection for wgsl shaders yet!"):k.Error("This engine does not support compute shaders!")}getClassName(){return"ComputeShader"}setTexture(e,t,i=!0){const s=this._bindings[e];this._bindings[e]={type:i?pl.Texture:pl.TextureWithoutSampler,object:t,indexInGroupEntries:null==s?void 0:s.indexInGroupEntries},this._contextIsDirty||(this._contextIsDirty=!s||s.object!==t||s.type!==this._bindings[e].type)}setStorageTexture(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:pl.StorageTexture,object:t,indexInGroupEntries:null==i?void 0:i.indexInGroupEntries}}setExternalTexture(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:pl.ExternalTexture,object:t,indexInGroupEntries:null==i?void 0:i.indexInGroupEntries}}setVideoTexture(e,t){return!!t.externalTexture&&(this.setExternalTexture(e,t.externalTexture),!0)}setUniformBuffer(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:pl.UniformBuffer,object:t,indexInGroupEntries:null==i?void 0:i.indexInGroupEntries}}setStorageBuffer(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:pl.StorageBuffer,object:t,indexInGroupEntries:null==i?void 0:i.indexInGroupEntries}}setTextureSampler(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||!t.compareSampler(i.object)),this._bindings[e]={type:pl.Sampler,object:t,indexInGroupEntries:null==i?void 0:i.indexInGroupEntries}}isReady(){let e=this._effect;for(const e in this._bindings){const t=this._bindings[e],i=t.type,s=t.object;switch(i){case pl.Texture:case pl.TextureWithoutSampler:case pl.StorageTexture:case pl.ExternalTexture:if(!s.isReady())return!1}}const t=[],i=this._shaderPath;if(this._options.defines)for(let e=0;e<this._options.defines.length;e++)t.push(this._options.defines[e]);const s=t.join("\n");return this._cachedDefines!==s&&(this._cachedDefines=s,e=this._engine.createComputeEffect(i,{defines:s,entryPoint:this._options.entryPoint,onCompiled:this.onCompiled,onError:this.onError}),this._effect=e),!!e.isReady()}dispatch(e,t,i){var s;if(!this.isReady())return!1;for(const e in this._bindings){const t=this._bindings[e];if(!this._options.bindingsMapping[e])throw new Error("ComputeShader ('"+this.name+"'): No binding mapping has been provided for the property '"+e+"'");switch(t.type){case pl.Texture:{const i=this._samplers[e],r=t.object;i&&r._texture&&i.compareSampler(r._texture)||(this._samplers[e]=(new ct).setParameters(r.wrapU,r.wrapV,r.wrapR,r.anisotropicFilteringLevel,r._texture.samplingMode,null===(s=r._texture)||void 0===s?void 0:s._comparisonFunction),this._contextIsDirty=!0);break}case pl.ExternalTexture:this._contextIsDirty=!0;break;case pl.UniformBuffer:{const e=t.object;e.getBuffer()!==t.buffer&&(t.buffer=e.getBuffer(),this._contextIsDirty=!0);break}}}return this._contextIsDirty&&(this._contextIsDirty=!1,this._context.clear()),this._engine.computeDispatch(this._effect,this._context,this._bindings,e,t,i,this._options.bindingsMapping),!0}dispatchWhenReady(e,t,i,s=10){return new Promise((r=>{const n=()=>{this.dispatch(e,t,i)?r():setTimeout(n,s)};n()}))}serialize(){const e=de.Serialize(this);e.options=this._options,e.shaderPath=this._shaderPath,e.bindings={},e.textures={};for(const t in this._bindings){const i=this._bindings[t],s=i.object;switch(i.type){case pl.Texture:case pl.TextureWithoutSampler:case pl.StorageTexture:{const r=s.serialize();r&&(e.textures[t]=r,e.bindings[t]={type:i.type});break}case pl.UniformBuffer:}}return e}static Parse(e,t,i){const s=de.Parse((()=>new vl(e.name,t.getEngine(),e.shaderPath,e.options)),e,t,i);for(const r in e.textures){const n=e.bindings[r],o=Ar.Parse(e.textures[r],t,i);n.type===pl.Texture?s.setTexture(r,o):n.type===pl.TextureWithoutSampler?s.setTexture(r,o,!1):s.setStorageTexture(r,o)}return s}}me([ie()],vl.prototype,"name",void 0),m("BABYLON.ComputeShader",vl);class xl{constructor(e,t,i,s,r,n){this.entries=[],this._boundingVectors=new Array,this._capacity=i,this._depth=s,this._maxDepth=r,this._creationFunc=n,this._minPoint=e,this._maxPoint=t,this._boundingVectors.push(e.clone()),this._boundingVectors.push(t.clone()),this._boundingVectors.push(e.clone()),this._boundingVectors[2].x=t.x,this._boundingVectors.push(e.clone()),this._boundingVectors[3].y=t.y,this._boundingVectors.push(e.clone()),this._boundingVectors[4].z=t.z,this._boundingVectors.push(t.clone()),this._boundingVectors[5].z=e.z,this._boundingVectors.push(t.clone()),this._boundingVectors[6].x=e.x,this._boundingVectors.push(t.clone()),this._boundingVectors[7].y=e.y}get capacity(){return this._capacity}get minPoint(){return this._minPoint}get maxPoint(){return this._maxPoint}addEntry(e){if(this.blocks)for(let t=0;t<this.blocks.length;t++)this.blocks[t].addEntry(e);else this._creationFunc(e,this),this.entries.length>this.capacity&&this._depth<this._maxDepth&&this.createInnerBlocks()}removeEntry(e){if(this.blocks){for(let t=0;t<this.blocks.length;t++)this.blocks[t].removeEntry(e);return}const t=this.entries.indexOf(e);t>-1&&this.entries.splice(t,1)}addEntries(e){for(let t=0;t<e.length;t++){const i=e[t];this.addEntry(i)}}select(e,t,i){if(fs.IsInFrustum(this._boundingVectors,e)){if(this.blocks){for(let s=0;s<this.blocks.length;s++)this.blocks[s].select(e,t,i);return}i?t.concat(this.entries):t.concatWithNoDuplicate(this.entries)}}intersects(e,t,i,s){if(fs.IntersectsSphere(this._minPoint,this._maxPoint,e,t)){if(this.blocks){for(let r=0;r<this.blocks.length;r++)this.blocks[r].intersects(e,t,i,s);return}s?i.concat(this.entries):i.concatWithNoDuplicate(this.entries)}}intersectsRay(e,t){if(e.intersectsBoxMinMax(this._minPoint,this._maxPoint)){if(this.blocks){for(let i=0;i<this.blocks.length;i++)this.blocks[i].intersectsRay(e,t);return}t.concatWithNoDuplicate(this.entries)}}createInnerBlocks(){xl._CreateBlocks(this._minPoint,this._maxPoint,this.entries,this._capacity,this._depth,this._maxDepth,this,this._creationFunc),this.entries.splice(0)}static _CreateBlocks(e,t,i,s,r,n,o,a){o.blocks=new Array;const l=new S((t.x-e.x)/2,(t.y-e.y)/2,(t.z-e.z)/2);for(let t=0;t<2;t++)for(let h=0;h<2;h++)for(let c=0;c<2;c++){const u=e.add(l.multiplyByFloats(t,h,c)),d=e.add(l.multiplyByFloats(t+1,h+1,c+1)),p=new xl(u,d,s,r+1,n,a);p.addEntries(i),o.blocks.push(p)}}}class Tl{constructor(e,t,i=2){this.maxDepth=i,this.dynamicContent=[],this._maxBlockCapacity=t||64,this._selectionContent=new jt(1024),this._creationFunc=e}update(e,t,i){xl._CreateBlocks(e,t,i,this._maxBlockCapacity,0,this.maxDepth,this,this._creationFunc)}addMesh(e){for(let t=0;t<this.blocks.length;t++)this.blocks[t].addEntry(e)}removeMesh(e){for(let t=0;t<this.blocks.length;t++)this.blocks[t].removeEntry(e)}select(e,t){this._selectionContent.reset();for(let i=0;i<this.blocks.length;i++)this.blocks[i].select(e,this._selectionContent,t);return t?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}intersects(e,t,i){this._selectionContent.reset();for(let s=0;s<this.blocks.length;s++)this.blocks[s].intersects(e,t,this._selectionContent,i);return i?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}intersectsRay(e){this._selectionContent.reset();for(let t=0;t<this.blocks.length;t++)this.blocks[t].intersectsRay(e,this._selectionContent);return this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}}Tl.CreationFuncForMeshes=(e,t)=>{const i=e.getBoundingInfo();!e.isBlocked&&i.boundingBox.intersectsMinMax(t.minPoint,t.maxPoint)&&t.entries.push(e)},Tl.CreationFuncForSubMeshes=(e,t)=>{e.getBoundingInfo().boundingBox.intersectsMinMax(t.minPoint,t.maxPoint)&&t.entries.push(e)},Yi.prototype.createOrUpdateSelectionOctree=function(e=64,t=2){let i=this._getComponent(fi.NAME_OCTREE);i||(i=new El(this),this._addComponent(i)),this._selectionOctree||(this._selectionOctree=new Tl(Tl.CreationFuncForMeshes,e,t));const s=this.getWorldExtends();return this._selectionOctree.update(s.min,s.max,this.meshes),this._selectionOctree},Object.defineProperty(Yi.prototype,"selectionOctree",{get:function(){return this._selectionOctree},enumerable:!0,configurable:!0}),Vs.prototype.createOrUpdateSubmeshesOctree=function(e=64,t=2){const i=this.getScene();let s=i._getComponent(fi.NAME_OCTREE);s||(s=new El(i),i._addComponent(s)),this._submeshesOctree||(this._submeshesOctree=new Tl(Tl.CreationFuncForSubMeshes,e,t)),this.computeWorldMatrix(!0);const r=this.getBoundingInfo().boundingBox;return this._submeshesOctree.update(r.minimumWorld,r.maximumWorld,this.subMeshes),this._submeshesOctree};class El{constructor(e){this.name=fi.NAME_OCTREE,this.checksIsEnabled=!0,this._tempRay=new Fr(S.Zero(),new S(1,1,1)),(e=e||x.LastCreatedScene)&&(this.scene=e,this.scene.getActiveMeshCandidates=()=>this.getActiveMeshCandidates(),this.scene.getActiveSubMeshCandidates=e=>this.getActiveSubMeshCandidates(e),this.scene.getCollidingSubMeshCandidates=(e,t)=>this.getCollidingSubMeshCandidates(e,t),this.scene.getIntersectingSubMeshCandidates=(e,t)=>this.getIntersectingSubMeshCandidates(e,t))}register(){this.scene.onMeshRemovedObservable.add((e=>{const t=this.scene.selectionOctree;if(null!=t){const i=t.dynamicContent.indexOf(e);-1!==i&&t.dynamicContent.splice(i,1)}})),this.scene.onMeshImportedObservable.add((e=>{const t=this.scene.selectionOctree;null!=t&&t.addMesh(e)}))}getActiveMeshCandidates(){var e;return(null===(e=this.scene._selectionOctree)||void 0===e?void 0:e.select(this.scene.frustumPlanes))||this.scene._getDefaultMeshCandidates()}getActiveSubMeshCandidates(e){return e._submeshesOctree&&e.useOctreeForRenderingSelection?e._submeshesOctree.select(this.scene.frustumPlanes):this.scene._getDefaultSubMeshCandidates(e)}getIntersectingSubMeshCandidates(e,t){return e._submeshesOctree&&e.useOctreeForPicking?(Fr.TransformToRef(t,e.getWorldMatrix(),this._tempRay),e._submeshesOctree.intersectsRay(this._tempRay)):this.scene._getDefaultSubMeshCandidates(e)}getCollidingSubMeshCandidates(e,t){if(e._submeshesOctree&&e.useOctreeForCollisions){const i=t._velocityWorldLength+Math.max(t._radius.x,t._radius.y,t._radius.z);return e._submeshesOctree.intersects(t._basePointWorld,i)}return this.scene._getDefaultSubMeshCandidates(e)}rebuild(){}dispose(){}}function Sl(e){const t=e.height||2;let i=0===e.diameterTop?0:e.diameterTop||e.diameter||1,s=0===e.diameterBottom?0:e.diameterBottom||e.diameter||1;i=i||1e-5,s=s||1e-5;const r=0|(e.tessellation||24),n=0|(e.subdivisions||1),o=!!e.hasRings,a=!!e.enclose,l=0===e.cap?0:e.cap||ur.CAP_ALL,h=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1,c=0===e.sideOrientation?0:e.sideOrientation||As.DEFAULTSIDE,u=e.faceUV||new Array(3),d=e.faceColors,p=2+(1+(1!==h&&a?2:0))*(o?n:1);let _;for(_=0;_<p;_++)d&&void 0===d[_]&&(d[_]=new F(1,1,1,1));for(_=0;_<p;_++)u&&void 0===u[_]&&(u[_]=new b(0,0,1,1));const f=[],m=[],g=[],v=[],x=[],T=2*Math.PI*h/r;let C,y,A;const R=(s-i)/2/t,I=S.Zero(),P=S.Zero(),M=S.Zero(),O=S.Zero(),D=S.Zero(),N=ji.Y;let w,L,B,U=1,V=1,k=0,G=0;for(w=0;w<=n;w++)for(y=w/n,A=(y*(i-s)+s)/2,U=o&&0!==w&&w!==n?2:1,B=0;B<U;B++){for(o&&(V+=B),a&&(V+=2*B),L=0;L<=r;L++)C=L*T,I.x=Math.cos(-C)*A,I.y=-t/2+y*t,I.z=Math.sin(-C)*A,0===i&&w===n?(P.x=g[g.length-3*(r+1)],P.y=g[g.length-3*(r+1)+1],P.z=g[g.length-3*(r+1)+2]):(P.x=I.x,P.z=I.z,P.y=Math.sqrt(P.x*P.x+P.z*P.z)*R,P.normalize()),0===L&&(M.copyFrom(I),O.copyFrom(P)),m.push(I.x,I.y,I.z),g.push(P.x,P.y,P.z),G=o?k!==V?u[V].y:u[V].w:u[V].y+(u[V].w-u[V].y)*y,v.push(u[V].x+(u[V].z-u[V].x)*L/r,Is.UseOpenGLOrientationForUV?1-G:G),d&&x.push(d[V].r,d[V].g,d[V].b,d[V].a);1!==h&&a&&(m.push(I.x,I.y,I.z),m.push(0,I.y,0),m.push(0,I.y,0),m.push(M.x,M.y,M.z),S.CrossToRef(N,P,D),D.normalize(),g.push(D.x,D.y,D.z,D.x,D.y,D.z),S.CrossToRef(O,N,D),D.normalize(),g.push(D.x,D.y,D.z,D.x,D.y,D.z),G=o?k!==V?u[V+1].y:u[V+1].w:u[V+1].y+(u[V+1].w-u[V+1].y)*y,v.push(u[V+1].x,Is.UseOpenGLOrientationForUV?1-G:G),v.push(u[V+1].z,Is.UseOpenGLOrientationForUV?1-G:G),G=o?k!==V?u[V+2].y:u[V+2].w:u[V+2].y+(u[V+2].w-u[V+2].y)*y,v.push(u[V+2].x,Is.UseOpenGLOrientationForUV?1-G:G),v.push(u[V+2].z,Is.UseOpenGLOrientationForUV?1-G:G),d&&(x.push(d[V+1].r,d[V+1].g,d[V+1].b,d[V+1].a),x.push(d[V+1].r,d[V+1].g,d[V+1].b,d[V+1].a),x.push(d[V+2].r,d[V+2].g,d[V+2].b,d[V+2].a),x.push(d[V+2].r,d[V+2].g,d[V+2].b,d[V+2].a))),k!==V&&(k=V)}const z=1!==h&&a?r+4:r;for(w=0,V=0;V<n;V++){let e=0,t=0,i=0,s=0;for(L=0;L<r;L++)e=w*(z+1)+L,t=(w+1)*(z+1)+L,i=w*(z+1)+(L+1),s=(w+1)*(z+1)+(L+1),f.push(e,t,i),f.push(s,i,t);1!==h&&a&&(f.push(e+2,t+2,i+2),f.push(s+2,i+2,t+2),f.push(e+4,t+4,i+4),f.push(s+4,i+4,t+4)),w=o?w+2:w+1}const W=e=>{const n=e?i/2:s/2;if(0===n)return;let o,a,l;const c=e?u[p-1]:u[0];let _=null;d&&(_=e?d[p-1]:d[0]);const T=m.length/3,b=e?t/2:-t/2,C=new S(0,b,0);m.push(C.x,C.y,C.z),g.push(0,e?1:-1,0);const y=c.y+.5*(c.w-c.y);v.push(c.x+.5*(c.z-c.x),Is.UseOpenGLOrientationForUV?1-y:y),_&&x.push(_.r,_.g,_.b,_.a);const A=new E(.5,.5);for(l=0;l<=r;l++){o=2*Math.PI*l*h/r;const t=Math.cos(-o),i=Math.sin(-o);a=new S(t*n,b,i*n);const s=new E(t*A.x+.5,i*A.y+.5);m.push(a.x,a.y,a.z),g.push(0,e?1:-1,0);const u=c.y+(c.w-c.y)*s.y;v.push(c.x+(c.z-c.x)*s.x,Is.UseOpenGLOrientationForUV?1-u:u),_&&x.push(_.r,_.g,_.b,_.a)}for(l=0;l<r;l++)e?(f.push(T),f.push(T+(l+2)),f.push(T+(l+1))):(f.push(T),f.push(T+(l+1)),f.push(T+(l+2)))};l!==ur.CAP_START&&l!==ur.CAP_ALL||W(!1),l!==ur.CAP_END&&l!==ur.CAP_ALL||W(!0),As._ComputeSides(c,m,f,g,v,e.frontUVs,e.backUVs);const H=new As;return H.indices=f,H.positions=m,H.normals=g,H.uvs=v,d&&(H.colors=x),H}function bl(e,t={},i){const s=new ur(e,i);return t.sideOrientation=ur._GetDefaultSideOrientation(t.sideOrientation),s._originalBuilderSideOrientation=t.sideOrientation,Sl(t).applyToMesh(s,t.updatable),s}As.CreateCylinder=Sl,ur.CreateCylinder=(e,t,i,s,r,n,o,a,l)=>(void 0!==o&&o instanceof Yi||(void 0!==o&&(l=a||ur.DEFAULTSIDE,a=o),o=n,n=1),bl(e,{height:t,diameterTop:i,diameterBottom:s,tessellation:r,subdivisions:n,sideOrientation:l,updatable:a},o)),ve.AddNodeConstructor("Light_Type_3",((e,t)=>()=>new Cl(e,S.Zero(),t)));class Cl extends pr{constructor(e,t,i){super(e,i),this.groundColor=new N(0,0,0),this.direction=t||S.Up()}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}getClassName(){return"HemisphericLight"}setDirectionToTarget(e){return this.direction=S.Normalize(e.subtract(S.Zero())),this.direction}getShadowGenerator(){return null}transferToEffect(e,t){const i=S.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",i.x,i.y,i.z,0,t),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),t),this}transferToNodeMaterialEffect(e,t){const i=S.Normalize(this.direction);return e.setFloat3(t,i.x,i.y,i.z),this}computeWorldMatrix(){return this._worldMatrix||(this._worldMatrix=y.Identity()),this._worldMatrix}getTypeID(){return pr.LIGHTTYPEID_HEMISPHERICLIGHT}prepareLightSpecificDefines(e,t){e["HEMILIGHT"+t]=!0}}me([re()],Cl.prototype,"groundColor",void 0),me([ae()],Cl.prototype,"direction",void 0);class yl{getRenderCamera(e){if(this._renderCamera)return this._renderCamera;{let t;return t=this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:this.originalScene.activeCamera,e&&t&&t.isRigCamera?t.rigParent:t}}setRenderCamera(e){this._renderCamera=e}_getSharedGizmoLight(){return this._sharedGizmoLight||(this._sharedGizmoLight=new Cl("shared gizmo light",new S(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=N.Gray()),this._sharedGizmoLight}static get DefaultUtilityLayer(){return null==yl._DefaultUtilityLayer?yl._CreateDefaultUtilityLayerFromScene(x.LastCreatedScene):yl._DefaultUtilityLayer}static _CreateDefaultUtilityLayerFromScene(e){return yl._DefaultUtilityLayer=new yl(e),yl._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce((()=>{yl._DefaultUtilityLayer=null})),yl._DefaultUtilityLayer}static get DefaultKeepDepthUtilityLayer(){return null==yl._DefaultKeepDepthUtilityLayer&&(yl._DefaultKeepDepthUtilityLayer=new yl(x.LastCreatedScene),yl._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,yl._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce((()=>{yl._DefaultKeepDepthUtilityLayer=null}))),yl._DefaultKeepDepthUtilityLayer}constructor(e,t=!0){this.originalScene=e,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.pickingEnabled=!0,this.onPointerOutObservable=new a,this.utilityLayerScene=new Yi(e.getEngine(),{virtual:!0}),this.utilityLayerScene.useRightHandedSystem=e.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=!1,this.utilityLayerScene.postProcessesEnabled=!1,this.utilityLayerScene.detachControl(),t&&(this._originalPointerObserver=e.onPrePointerObservable.add((t=>{if(!this.utilityLayerScene.activeCamera)return;if(!this.pickingEnabled)return;if(!this.processAllEvents&&t.type!==gi.POINTERMOVE&&t.type!==gi.POINTERUP&&t.type!==gi.POINTERDOWN&&t.type!==gi.POINTERDOUBLETAP)return;this.utilityLayerScene.pointerX=e.pointerX,this.utilityLayerScene.pointerY=e.pointerY;const i=t.event;if(e.isPointerCaptured(i.pointerId))return void(this._pointerCaptures[i.pointerId]=!1);const s=i=>{let s=null;if(t.nearInteractionPickingInfo)s=t.nearInteractionPickingInfo.pickedMesh.getScene()==i?t.nearInteractionPickingInfo:new ci;else if(i!==this.utilityLayerScene&&t.originalPickingInfo)s=t.originalPickingInfo;else{let r=null;this._renderCamera&&(r=i._activeCamera,i._activeCamera=this._renderCamera,t.ray=null),s=t.ray?i.pickWithRay(t.ray):i.pick(e.pointerX,e.pointerY),r&&(i._activeCamera=r)}return s},r=s(this.utilityLayerScene);if(!t.ray&&r&&(t.ray=r.ray),this.utilityLayerScene.onPrePointerObservable.notifyObservers(t),this.onlyCheckPointerDownEvents&&t.type!=gi.POINTERDOWN)return t.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new Ti(t.type,t.event,r),t.type),void(t.type===gi.POINTERUP&&this._pointerCaptures[i.pointerId]&&(this._pointerCaptures[i.pointerId]=!1));if(this.utilityLayerScene.autoClearDepthAndStencil||this.pickUtilitySceneFirst)r&&r.hit&&(t.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new Ti(t.type,t.event,r),t.type),t.skipOnPointerObservable=!0);else{const i=s(e),n=t.event;i&&r&&(0===r.distance&&i.pickedMesh?this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(i.pickedMesh)?(this._notifyObservers(t,i,n),t.skipOnPointerObservable=!0):t.type===gi.POINTERDOWN?this._pointerCaptures[n.pointerId]=!0:t.type!==gi.POINTERMOVE&&t.type!==gi.POINTERUP||(this._lastPointerEvents[n.pointerId]&&(this.onPointerOutObservable.notifyObservers(n.pointerId),delete this._lastPointerEvents[n.pointerId]),this._notifyObservers(t,i,n)):!this._pointerCaptures[n.pointerId]&&(r.distance<i.distance||0===i.distance)?(this._notifyObservers(t,r,n),t.skipOnPointerObservable||(t.skipOnPointerObservable=r.distance>0)):!this._pointerCaptures[n.pointerId]&&r.distance>=i.distance&&(this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(i.pickedMesh)?(this._notifyObservers(t,i,n),t.skipOnPointerObservable=!0):(t.type!==gi.POINTERMOVE&&t.type!==gi.POINTERUP||this._lastPointerEvents[n.pointerId]&&(this.onPointerOutObservable.notifyObservers(n.pointerId),delete this._lastPointerEvents[n.pointerId]),this._notifyObservers(t,r,n))),t.type===gi.POINTERUP&&this._pointerCaptures[n.pointerId]&&(this._pointerCaptures[n.pointerId]=!1))}})),this._originalPointerObserver&&e.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=!1,this._afterRenderObserver=this.originalScene.onAfterRenderCameraObservable.add((e=>{this.shouldRender&&e==this.getRenderCamera()&&this.render()})),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add((()=>{this.dispose()})),this._updateCamera()}_notifyObservers(e,t,i){e.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new Ti(e.type,e.event,t),e.type),this._lastPointerEvents[i.pointerId]=!0)}render(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){const e=this.utilityLayerScene.activeCamera.getScene(),t=this.utilityLayerScene.activeCamera;t._scene=this.utilityLayerScene,t.leftCamera&&(t.leftCamera._scene=this.utilityLayerScene),t.rightCamera&&(t.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(!1),t._scene=e,t.leftCamera&&(t.leftCamera._scene=e),t.rightCamera&&(t.rightCamera._scene=e)}}dispose(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose()}_updateCamera(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()}}yl._DefaultUtilityLayer=null,yl._DefaultKeepDepthUtilityLayer=null,function(e){e[e.Origin=0]="Origin",e[e.Pivot=1]="Pivot"}(_l||(_l={})),(gl=fl||(fl={}))[gl.World=0]="World",gl[gl.Local=1]="Local";class Al{set scaleRatio(e){this._scaleRatio=e}get scaleRatio(){return this._scaleRatio}get isHovered(){return this._isHovered}get attachedMesh(){return this._attachedMesh}set attachedMesh(e){this._attachedMesh=e,e&&(this._attachedNode=e),this._rootMesh.setEnabled(!!e),this._attachedNodeChanged(e)}get attachedNode(){return this._attachedNode}set attachedNode(e){this._attachedNode=e,this._attachedMesh=null,this._rootMesh.setEnabled(!!e),this._attachedNodeChanged(e)}setCustomMesh(e){if(e.getScene()!=this.gizmoLayer.utilityLayerScene)throw"When setting a custom mesh on a gizmo, the custom meshes scene must be the same as the gizmos (eg. gizmo.gizmoLayer.utilityLayerScene)";this._rootMesh.getChildMeshes().forEach((e=>{e.dispose()})),e.parent=this._rootMesh,this._customMeshSet=!0}set updateGizmoRotationToMatchAttachedMesh(e){this._updateGizmoRotationToMatchAttachedMesh=e}get updateGizmoRotationToMatchAttachedMesh(){return this._updateGizmoRotationToMatchAttachedMesh}set updateGizmoPositionToMatchAttachedMesh(e){this._updateGizmoPositionToMatchAttachedMesh=e}get updateGizmoPositionToMatchAttachedMesh(){return this._updateGizmoPositionToMatchAttachedMesh}set anchorPoint(e){this._anchorPoint=e}get anchorPoint(){return this._anchorPoint}set coordinatesMode(e){this._coordinatesMode=e;const t=e==fl.Local;this.updateGizmoRotationToMatchAttachedMesh=t,this.updateGizmoPositionToMatchAttachedMesh=!0}get coordinatesMode(){return this._coordinatesMode}set updateScale(e){this._updateScale=e}get updateScale(){return this._updateScale}_attachedNodeChanged(e){}constructor(e=yl.DefaultUtilityLayer){this.gizmoLayer=e,this._attachedMesh=null,this._attachedNode=null,this._customRotationQuaternion=null,this._scaleRatio=1,this._isHovered=!1,this._customMeshSet=!1,this._updateGizmoRotationToMatchAttachedMesh=!0,this._updateGizmoPositionToMatchAttachedMesh=!0,this._anchorPoint=_l.Origin,this._updateScale=!0,this._coordinatesMode=fl.Local,this._interactionsEnabled=!0,this._rightHandtoLeftHandMatrix=y.RotationY(Math.PI),this._rootMesh=new ur("gizmoRootNode",e.utilityLayerScene),this._rootMesh.rotationQuaternion=C.Identity(),this._beforeRenderObserver=this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.add((()=>{this._update()}))}get customRotationQuaternion(){return this._customRotationQuaternion}set customRotationQuaternion(e){this._customRotationQuaternion=e}_update(){if(this.attachedNode){let e=this.attachedNode;if(this.attachedMesh&&(e=this.attachedMesh||this.attachedNode),this.updateGizmoPositionToMatchAttachedMesh)if(this.anchorPoint==_l.Pivot&&e.getAbsolutePivotPoint){const t=e.getAbsolutePivotPoint();this._rootMesh.position.copyFrom(t)}else{const t=e.getWorldMatrix().getRow(3),i=t?t.toVector3():new S(0,0,0);this._rootMesh.position.copyFrom(i)}if(this.updateGizmoRotationToMatchAttachedMesh){const t=e._isMesh||"AbstractMesh"===e.getClassName()||"TransformNode"===e.getClassName()||"InstancedMesh"===e.getClassName()?e:void 0;e.getWorldMatrix().decompose(void 0,this._rootMesh.rotationQuaternion,void 0,Al.PreserveScaling?t:void 0),this._rootMesh.rotationQuaternion.normalize()}else this._customRotationQuaternion?this._rootMesh.rotationQuaternion.copyFrom(this._customRotationQuaternion):this._rootMesh.rotationQuaternion.set(0,0,0,1);if(this.updateScale){const t=this.gizmoLayer.utilityLayerScene.activeCamera,i=t.globalPosition;this._rootMesh.position.subtractToRef(i,R.Vector3[0]);let s=this.scaleRatio;if(t.mode==ps.ORTHOGRAPHIC_CAMERA)t.orthoTop&&t.orthoBottom&&(s*=t.orthoTop-t.orthoBottom);else{const e=t.getScene().useRightHandedSystem?S.RightHandedForwardReadOnly:S.LeftHandedForwardReadOnly,i=t.getDirection(e);s*=S.Dot(R.Vector3[0],i)}this._rootMesh.scaling.setAll(s),e._getWorldMatrixDeterminant()<0&&!Al.PreserveScaling&&(this._rootMesh.scaling.y*=-1)}else this._rootMesh.scaling.setAll(this.scaleRatio)}}_handlePivotMatrixInverse(e,t,i){if(e.isUsingPivotMatrix()&&!e.isUsingPostMultiplyPivotMatrix())return e.getPivotMatrix().invertToRef(R.Matrix[5]),void R.Matrix[5].multiplyToRef(t,i);i.copyFrom(t)}_matrixChanged(){if(this._attachedNode)if(this._attachedNode._isCamera){const e=this._attachedNode;let t,i;if(e.parent){const i=R.Matrix[1];e.parent._worldMatrix.invertToRef(i),this._attachedNode._worldMatrix.multiplyToRef(i,R.Matrix[0]),t=R.Matrix[0]}else t=this._attachedNode._worldMatrix;if(e.getScene().useRightHandedSystem?(this._rightHandtoLeftHandMatrix.multiplyToRef(t,R.Matrix[1]),i=R.Matrix[1]):i=t,i.decompose(R.Vector3[1],R.Quaternion[0],R.Vector3[0]),"FreeCamera"===this._attachedNode.getClassName()||"FlyCamera"===this._attachedNode.getClassName()||"ArcFollowCamera"===this._attachedNode.getClassName()||"TargetCamera"===this._attachedNode.getClassName()||"TouchCamera"===this._attachedNode.getClassName()||"UniversalCamera"===this._attachedNode.getClassName()){const e=this._attachedNode;e.rotation=R.Quaternion[0].toEulerAngles(),e.rotationQuaternion&&(e.rotationQuaternion.copyFrom(R.Quaternion[0]),e.rotationQuaternion.normalize())}e.position.copyFrom(R.Vector3[0])}else if(this._attachedNode._isMesh||"AbstractMesh"===this._attachedNode.getClassName()||"TransformNode"===this._attachedNode.getClassName()||"InstancedMesh"===this._attachedNode.getClassName()){const e=this._attachedNode;if(e.parent){const t=R.Matrix[0],i=R.Matrix[1];e.parent.getWorldMatrix().invertToRef(t),this._attachedNode.getWorldMatrix().multiplyToRef(t,i);const s=R.Matrix[4];if(this._handlePivotMatrixInverse(e,i,s),s.decompose(R.Vector3[0],R.Quaternion[0],e.position,Al.PreserveScaling?e:void 0,Al.UseAbsoluteScaling),R.Quaternion[0].normalize(),e.isUsingPivotMatrix()){const t=R.Quaternion[1];C.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,t);const i=R.Matrix[2];y.ScalingToRef(e.scaling.x,e.scaling.y,e.scaling.z,i);const s=R.Matrix[2];t.toRotationMatrix(s);const r=e.getPivotMatrix(),n=R.Matrix[3];r.invertToRef(n),r.multiplyToRef(i,R.Matrix[4]),R.Matrix[4].multiplyToRef(s,R.Matrix[5]),R.Matrix[5].multiplyToRef(n,R.Matrix[6]),R.Matrix[6].getTranslationToRef(R.Vector3[1]),e.position.subtractInPlace(R.Vector3[1])}}else{const t=R.Matrix[4];this._handlePivotMatrixInverse(e,this._attachedNode._worldMatrix,t),t.decompose(R.Vector3[0],R.Quaternion[0],e.position,Al.PreserveScaling?e:void 0,Al.UseAbsoluteScaling)}R.Vector3[0].scaleInPlace(1/e.scalingDeterminant),e.scaling.copyFrom(R.Vector3[0]),e.billboardMode||(e.rotationQuaternion?(e.rotationQuaternion.copyFrom(R.Quaternion[0]),e.rotationQuaternion.normalize()):e.rotation=R.Quaternion[0].toEulerAngles())}else if("Bone"===this._attachedNode.getClassName()){const e=this._attachedNode,t=e.getParent();if(t){const i=R.Matrix[0],s=R.Matrix[1];t.getFinalMatrix().invertToRef(i),e.getFinalMatrix().multiplyToRef(i,s),e.getLocalMatrix().copyFrom(s)}else e.getLocalMatrix().copyFrom(e.getFinalMatrix());e.markAsDirty()}else{const e=this._attachedNode;if(e.getTypeID){const t=e.getTypeID();if(t===pr.LIGHTTYPEID_DIRECTIONALLIGHT||t===pr.LIGHTTYPEID_SPOTLIGHT||t===pr.LIGHTTYPEID_POINTLIGHT){const t=e.parent;if(t){const i=R.Matrix[0],s=R.Matrix[1];t.getWorldMatrix().invertToRef(i),e.getWorldMatrix().multiplyToRef(i,s),s.decompose(void 0,R.Quaternion[0],R.Vector3[0])}else this._attachedNode._worldMatrix.decompose(void 0,R.Quaternion[0],R.Vector3[0]);e.position=new S(R.Vector3[0].x,R.Vector3[0].y,R.Vector3[0].z),e.direction&&(e.direction=new S(e.direction.x,e.direction.y,e.direction.z))}}}}_setGizmoMeshMaterial(e,t){e&&e.forEach((e=>{e.material=t,e.color&&(e.color=t.diffuseColor)}))}static GizmoAxisPointerObserver(e,t){let i=!1;return e.utilityLayerScene.onPointerObservable.add((e=>{var s,r;if(e.pickInfo){if(e.type===gi.POINTERMOVE){if(i)return;t.forEach((t=>{var i,s;if(t.colliderMeshes&&t.gizmoMeshes){const r=-1!=(null===(i=t.colliderMeshes)||void 0===i?void 0:i.indexOf(null===(s=null==e?void 0:e.pickInfo)||void 0===s?void 0:s.pickedMesh)),n=t.dragBehavior.enabled?r||t.active?t.hoverMaterial:t.material:t.disableMaterial;t.gizmoMeshes.forEach((e=>{e.material=n,e.color&&(e.color=n.diffuseColor)}))}}))}e.type===gi.POINTERDOWN&&t.has(null===(s=e.pickInfo.pickedMesh)||void 0===s?void 0:s.parent)&&(i=!0,t.get(null===(r=e.pickInfo.pickedMesh)||void 0===r?void 0:r.parent).active=!0,t.forEach((t=>{var i,s;const r=(-1!=(null===(i=t.colliderMeshes)||void 0===i?void 0:i.indexOf(null===(s=null==e?void 0:e.pickInfo)||void 0===s?void 0:s.pickedMesh))||t.active)&&t.dragBehavior.enabled?t.hoverMaterial:t.disableMaterial;t.gizmoMeshes.forEach((e=>{e.material=r,e.color&&(e.color=r.diffuseColor)}))}))),e.type===gi.POINTERUP&&t.forEach((e=>{e.active=!1,i=!1,e.gizmoMeshes.forEach((t=>{t.material=e.dragBehavior.enabled?e.material:e.disableMaterial,t.color&&(t.color=e.material.diffuseColor)}))}))}}))}dispose(){this._rootMesh.dispose(),this._beforeRenderObserver&&this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.remove(this._beforeRenderObserver)}}Al.PreserveScaling=!1,Al.UseAbsoluteScaling=!0,Object.defineProperty(Yi.prototype,"debugLayer",{get:function(){return this._debugLayer||(this._debugLayer=new Rl(this)),this._debugLayer},enumerable:!0,configurable:!0}),function(e){e[e.Properties=0]="Properties",e[e.Debug=1]="Debug",e[e.Statistics=2]="Statistics",e[e.Tools=3]="Tools",e[e.Settings=4]="Settings"}(ml||(ml={}));class Rl{get onPropertyChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable:(this._onPropertyChangedObservable||(this._onPropertyChangedObservable=new a),this._onPropertyChangedObservable)}get onSelectionChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable:(this._onSelectionChangedObservable||(this._onSelectionChangedObservable=new a),this._onSelectionChangedObservable)}constructor(e){this.BJSINSPECTOR=this._getGlobalInspector(),this._scene=e||x.LastCreatedScene,this._scene&&this._scene.onDisposeObservable.add((()=>{this._scene._debugLayer&&this._scene._debugLayer.hide()}))}_createInspector(e){if(this.isVisible())return;if(this._onPropertyChangedObservable){for(const e of this._onPropertyChangedObservable.observers)this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable.add(e);this._onPropertyChangedObservable.clear(),this._onPropertyChangedObservable=void 0}if(this._onSelectionChangedObservable){for(const e of this._onSelectionChangedObservable.observers)this.BJSINSPECTOR.Inspector.OnSelectionChangedObservable.add(e);this._onSelectionChangedObservable.clear(),this._onSelectionChangedObservable=void 0}const t=Object.assign(Object.assign({},Rl.Config),e);this.BJSINSPECTOR=this.BJSINSPECTOR||this._getGlobalInspector(),this.BJSINSPECTOR.Inspector.Show(this._scene,t)}select(e,t){this.BJSINSPECTOR&&(t&&("[object String]"==Object.prototype.toString.call(t)?this.BJSINSPECTOR.Inspector.MarkLineContainerTitleForHighlighting(t):this.BJSINSPECTOR.Inspector.MarkMultipleLineContainerTitlesForHighlighting(t)),this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable.notifyObservers(e))}_getGlobalInspector(){return"undefined"!=typeof INSPECTOR?INSPECTOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.Inspector?BABYLON:void 0}isVisible(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.IsVisible}hide(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.Hide()}setAsActiveScene(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector._SetNewScene(this._scene)}show(e){return new Promise((t=>{if(void 0===this.BJSINSPECTOR){const i=e&&e.inspectorURL?e.inspectorURL:Rl.InspectorURL;Ht.LoadBabylonScript(i,(()=>{this._createInspector(e),t(this)}))}else this._createInspector(e),t(this)}))}}function Il(e){let t=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];const i=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],s=[];let r=[];const n=e.width||e.size||1,o=e.height||e.size||1,a=e.depth||e.size||1,l=e.wrap||!1;let h=void 0===e.topBaseAt?1:e.topBaseAt,c=void 0===e.bottomBaseAt?0:e.bottomBaseAt;h=(h+4)%4,c=(c+4)%4;let u=[2,0,3,1][h],d=[2,0,1,3][c],p=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(l){t=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],p=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];let e=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],i=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]];const s=[17,18,19,16],r=[22,23,20,21];for(;u>0;)e.unshift(e.pop()),s.unshift(s.pop()),u--;for(;d>0;)i.unshift(i.pop()),r.unshift(r.pop()),d--;e=e.flat(),i=i.flat(),p=p.concat(e).concat(i),t.push(s[0],s[2],s[3],s[0],s[1],s[2]),t.push(r[0],r[2],r[3],r[0],r[1],r[2])}const _=[n/2,o/2,a/2];r=p.reduce(((e,t,i)=>e.concat(t*_[i%3])),[]);const f=0===e.sideOrientation?0:e.sideOrientation||As.DEFAULTSIDE,m=e.faceUV||new Array(6),g=e.faceColors,v=[];for(let e=0;e<6;e++)void 0===m[e]&&(m[e]=new b(0,0,1,1)),g&&void 0===g[e]&&(g[e]=new F(1,1,1,1));for(let e=0;e<6;e++)if(s.push(m[e].z,Is.UseOpenGLOrientationForUV?1-m[e].w:m[e].w),s.push(m[e].x,Is.UseOpenGLOrientationForUV?1-m[e].w:m[e].w),s.push(m[e].x,Is.UseOpenGLOrientationForUV?1-m[e].y:m[e].y),s.push(m[e].z,Is.UseOpenGLOrientationForUV?1-m[e].y:m[e].y),g)for(let t=0;t<4;t++)v.push(g[e].r,g[e].g,g[e].b,g[e].a);As._ComputeSides(f,r,t,i,s,e.frontUVs,e.backUVs);const x=new As;if(x.indices=t,x.positions=r,x.normals=i,x.uvs=s,g){const e=f===As.DOUBLESIDE?v.concat(v):v;x.colors=e}return x}function Pl(e,t={},i=null){const s=new ur(e,i);return t.sideOrientation=ur._GetDefaultSideOrientation(t.sideOrientation),s._originalBuilderSideOrientation=t.sideOrientation,Il(t).applyToMesh(s,t.updatable),s}function Ml(e){const t=0|(e.segments||32),i=e.diameterX||e.diameter||1,s=e.diameterY||e.diameter||1,r=e.diameterZ||e.diameter||1,n=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1,o=e.slice&&e.slice<=0?1:e.slice||1,a=0===e.sideOrientation?0:e.sideOrientation||As.DEFAULTSIDE,l=!!e.dedupTopBottomIndices,h=new S(i/2,s/2,r/2),c=2+t,u=2*c,d=[],p=[],_=[],f=[];for(let e=0;e<=c;e++){const t=e/c,i=t*Math.PI*o;for(let e=0;e<=u;e++){const s=e/u,r=s*Math.PI*2*n,o=y.RotationZ(-i),a=y.RotationY(r),l=S.TransformCoordinates(S.Up(),o),c=S.TransformCoordinates(l,a),d=c.multiply(h),m=c.divide(h).normalize();p.push(d.x,d.y,d.z),_.push(m.x,m.y,m.z),f.push(s,Is.UseOpenGLOrientationForUV?1-t:t)}if(e>0){const t=p.length/3;for(let i=t-2*(u+1);i+u+2<t;i++)l?(e>1&&(d.push(i),d.push(i+1),d.push(i+u+1)),(e<c||o<1)&&(d.push(i+u+1),d.push(i+1),d.push(i+u+2))):(d.push(i),d.push(i+1),d.push(i+u+1),d.push(i+u+1),d.push(i+1),d.push(i+u+2))}}As._ComputeSides(a,p,d,_,f,e.frontUVs,e.backUVs);const m=new As;return m.indices=d,m.positions=p,m.normals=_,m.uvs=f,m}function Ol(e,t={},i=null){const s=new ur(e,i);return t.sideOrientation=ur._GetDefaultSideOrientation(t.sideOrientation),s._originalBuilderSideOrientation=t.sideOrientation,Ml(t).applyToMesh(s,t.updatable),s}function Dl(e={subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){const t=0|Math.max(e.subdivisions?e.subdivisions:2,1),i=0|Math.max(e.tessellation?e.tessellation:16,3),s=Math.max(e.height?e.height:1,0),r=Math.max(e.radius?e.radius:.25,0),n=0|Math.max(e.capSubdivisions?e.capSubdivisions:6,1),o=i,a=t,l=Math.max(e.radiusTop?e.radiusTop:r,0),h=Math.max(e.radiusBottom?e.radiusBottom:r,0),c=s-(l+h),u=2*Math.PI,d=Math.max(e.topCapSubdivisions?e.topCapSubdivisions:n,1),p=Math.max(e.bottomCapSubdivisions?e.bottomCapSubdivisions:n,1),_=Math.acos((h-l)/s);let f=[];const m=[],g=[],v=[];let x=0;const T=[],b=.5*c,C=.5*Math.PI;let A,R;const I=S.Zero(),P=S.Zero(),M=Math.cos(_),O=Math.sin(_),D=new E(l*O,b+l*M).subtract(new E(h*O,h*M-b)).length(),N=l*_+D+h*(C-_);let F=0;for(R=0;R<=d;R++){const e=[],t=C-_*(R/d);F+=l*_/d;const i=Math.cos(t),s=Math.sin(t),r=i*l;for(A=0;A<=o;A++){const t=A/o,n=t*u+0,a=Math.sin(n),h=Math.cos(n);P.x=r*a,P.y=b+s*l,P.z=r*h,m.push(P.x,P.y,P.z),I.set(i*a,s,i*h),g.push(I.x,I.y,I.z),v.push(t,Is.UseOpenGLOrientationForUV?F/N:1-F/N),e.push(x),x++}T.push(e)}const w=s-l-h+M*l-M*h,L=O*(h-l)/w;for(R=1;R<=a;R++){const e=[];F+=D/a;const t=O*(R*(h-l)/a+l);for(A=0;A<=o;A++){const i=A/o,s=i*u+0,r=Math.sin(s),n=Math.cos(s);P.x=t*r,P.y=b+M*l-R*w/a,P.z=t*n,m.push(P.x,P.y,P.z),I.set(r,L,n).normalize(),g.push(I.x,I.y,I.z),v.push(i,Is.UseOpenGLOrientationForUV?F/N:1-F/N),e.push(x),x++}T.push(e)}for(R=1;R<=p;R++){const e=[],t=C-_-(Math.PI-_)*(R/p);F+=h*_/p;const i=Math.cos(t),s=Math.sin(t),r=i*h;for(A=0;A<=o;A++){const t=A/o,n=t*u+0,a=Math.sin(n),l=Math.cos(n);P.x=r*a,P.y=s*h-b,P.z=r*l,m.push(P.x,P.y,P.z),I.set(i*a,s,i*l),g.push(I.x,I.y,I.z),v.push(t,Is.UseOpenGLOrientationForUV?F/N:1-F/N),e.push(x),x++}T.push(e)}for(A=0;A<o;A++)for(R=0;R<d+a+p;R++){const e=T[R][A],t=T[R+1][A],i=T[R+1][A+1],s=T[R][A+1];f.push(e),f.push(t),f.push(s),f.push(t),f.push(i),f.push(s)}if(f=f.reverse(),e.orientation&&!e.orientation.equals(S.Up())){const t=new y;e.orientation.clone().scale(.5*Math.PI).cross(S.Up()).toQuaternion().toRotationMatrix(t);const i=S.Zero();for(let e=0;e<m.length;e+=3)i.set(m[e],m[e+1],m[e+2]),S.TransformCoordinatesToRef(i.clone(),t,i),m[e]=i.x,m[e+1]=i.y,m[e+2]=i.z}const B=new As;return B.positions=m,B.normals=g,B.uvs=v,B.indices=f,B}function Nl(e){let t=e.pathArray;const i=e.closeArray||!1,s=e.closePath||!1,r=e.invertUV||!1,n=Math.floor(t[0].length/2);let o=e.offset||n;o=o>n?n:Math.floor(o);const a=0===e.sideOrientation?0:e.sideOrientation||As.DEFAULTSIDE,l=e.uvs,h=e.colors,c=[],u=[],d=[],p=[],_=[],f=[],m=[],g=[];let v;const x=[],T=[];let E,S,b;if(t.length<2){const e=[],i=[];for(S=0;S<t[0].length-o;S++)e.push(t[0][S]),i.push(t[0][S+o]);t=[e,i]}let C=0;const y=s?1:0;let A,R,I,P,M,O;for(v=t[0].length,E=0;E<t.length;E++){for(m[E]=0,_[E]=[0],A=t[E],R=A.length,v=v<R?v:R,b=0;b<R;)c.push(A[b].x,A[b].y,A[b].z),b>0&&(I=A[b].subtract(A[b-1]).length(),P=I+m[E],_[E].push(P),m[E]=P),b++;s&&(b--,c.push(A[0].x,A[0].y,A[0].z),I=A[b].subtract(A[0]).length(),P=I+m[E],_[E].push(P),m[E]=P),x[E]=R+y,T[E]=C,C+=R+y}let D,N,F=null,w=null;for(S=0;S<v+y;S++){for(g[S]=0,f[S]=[0],E=0;E<t.length-1;E++)M=t[E],O=t[E+1],S===v?(F=M[0],w=O[0]):(F=M[S],w=O[S]),I=w.subtract(F).length(),P=I+g[S],f[S].push(P),g[S]=P;i&&w&&F&&(M=t[E],O=t[0],S===v&&(w=O[0]),I=w.subtract(F).length(),P=I+g[S],g[S]=P)}if(l)for(E=0;E<l.length;E++)p.push(l[E].x,Is.UseOpenGLOrientationForUV?1-l[E].y:l[E].y);else for(E=0;E<t.length;E++)for(S=0;S<v+y;S++)D=0!=m[E]?_[E][S]/m[E]:0,N=0!=g[S]?f[S][E]/g[S]:0,r?p.push(N,D):p.push(D,Is.UseOpenGLOrientationForUV?1-N:N);E=0;let L=0,B=x[E]-1,U=x[E+1]-1,V=B<U?B:U,k=T[1]-T[0];const G=i?x.length:x.length-1;for(;L<=V&&E<G;)u.push(L,L+k,L+1),u.push(L+k+1,L+1,L+k),L+=1,L===V&&(E++,E===x.length-1?(k=T[0]-T[E],B=x[E]-1,U=x[0]-1):(k=T[E+1]-T[E],B=x[E]-1,U=x[E+1]-1),L=T[E],V=B<U?B+L:U+L);if(As.ComputeNormals(c,u,d),s){let e=0,i=0;for(E=0;E<t.length;E++)e=3*T[E],i=E+1<t.length?3*(T[E+1]-1):d.length-3,d[e]=.5*(d[e]+d[i]),d[e+1]=.5*(d[e+1]+d[i+1]),d[e+2]=.5*(d[e+2]+d[i+2]),d[i]=d[e],d[i+1]=d[e+1],d[i+2]=d[e+2]}As._ComputeSides(a,c,u,d,p,e.frontUVs,e.backUVs);let z=null;if(h){z=new Float32Array(4*h.length);for(let e=0;e<h.length;e++)z[4*e]=h[e].r,z[4*e+1]=h[e].g,z[4*e+2]=h[e].b,z[4*e+3]=h[e].a}const W=new As,H=new Float32Array(c),X=new Float32Array(d),Y=new Float32Array(p);return W.indices=u,W.positions=H,W.normals=X,W.uvs=Y,z&&W.set(z,hi.ColorKind),s&&(W._idx=T),W}function Fl(e,t,i=null){const s=t.pathArray,r=t.closeArray,n=t.closePath,o=ur._GetDefaultSideOrientation(t.sideOrientation),a=t.instance,l=t.updatable;if(a){const e=R.Vector3[0].setAll(Number.MAX_VALUE),i=R.Vector3[1].setAll(-Number.MAX_VALUE),r=t=>{let r=s[0].length;const n=a;let o=0;const l=n._originalBuilderSideOrientation===ur.DOUBLESIDE?2:1;for(let a=1;a<=l;++a)for(let a=0;a<s.length;++a){const l=s[a],h=l.length;r=r<h?r:h;for(let s=0;s<r;++s){const r=l[s];t[o]=r.x,t[o+1]=r.y,t[o+2]=r.z,e.minimizeInPlaceFromFloats(r.x,r.y,r.z),i.maximizeInPlaceFromFloats(r.x,r.y,r.z),o+=3}if(n._creationDataStorage&&n._creationDataStorage.closePath){const e=l[0];t[o]=e.x,t[o+1]=e.y,t[o+2]=e.z,o+=3}}},n=a.getVerticesData(hi.PositionKind);if(r(n),a.hasBoundingInfo?a.getBoundingInfo().reConstruct(e,i,a._worldMatrix):a.buildBoundingInfo(e,i,a._worldMatrix),a.updateVerticesData(hi.PositionKind,n,!1,!1),t.colors){const e=a.getVerticesData(hi.ColorKind);for(let i=0,s=0;i<t.colors.length;i++,s+=4){const r=t.colors[i];e[s]=r.r,e[s+1]=r.g,e[s+2]=r.b,e[s+3]=r.a}a.updateVerticesData(hi.ColorKind,e,!1,!1)}if(t.uvs){const e=a.getVerticesData(hi.UVKind);for(let i=0;i<t.uvs.length;i++)e[2*i]=t.uvs[i].x,e[2*i+1]=Is.UseOpenGLOrientationForUV?1-t.uvs[i].y:t.uvs[i].y;a.updateVerticesData(hi.UVKind,e,!1,!1)}if(!a.areNormalsFrozen||a.isFacetDataEnabled){const e=a.getIndices(),t=a.getVerticesData(hi.NormalKind),i=a.isFacetDataEnabled?a.getFacetDataParameters():null;if(As.ComputeNormals(n,e,t,i),a._creationDataStorage&&a._creationDataStorage.closePath){let e=0,i=0;for(let r=0;r<s.length;r++)e=3*a._creationDataStorage.idx[r],i=r+1<s.length?3*(a._creationDataStorage.idx[r+1]-1):t.length-3,t[e]=.5*(t[e]+t[i]),t[e+1]=.5*(t[e+1]+t[i+1]),t[e+2]=.5*(t[e+2]+t[i+2]),t[i]=t[e],t[i+1]=t[e+1],t[i+2]=t[e+2]}a.areNormalsFrozen||a.updateVerticesData(hi.NormalKind,t,!1,!1)}return a}{const s=new ur(e,i);s._originalBuilderSideOrientation=o,s._creationDataStorage=new or;const a=Nl(t);return n&&(s._creationDataStorage.idx=a._idx),s._creationDataStorage.closePath=n,s._creationDataStorage.closeArray=r,a.applyToMesh(s,l),s}}function wl(e){const t=[],i=[],s=[],r=[],n=e.radius||.5,o=e.tessellation||64,a=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1,l=0===e.sideOrientation?0:e.sideOrientation||As.DEFAULTSIDE;t.push(0,0,0),r.push(.5,.5);const h=2*Math.PI*a,c=1===a?h/o:h/(o-1);let u=0;for(let e=0;e<o;e++){const e=Math.cos(u),i=Math.sin(u),s=(e+1)/2,o=(1-i)/2;t.push(n*e,n*i,0),r.push(s,Is.UseOpenGLOrientationForUV?1-o:o),u+=c}1===a&&(t.push(t[3],t[4],t[5]),r.push(r[2],Is.UseOpenGLOrientationForUV?1-r[3]:r[3]));const d=t.length/3;for(let e=1;e<d-1;e++)i.push(e+1,0,e);As.ComputeNormals(t,i,s),As._ComputeSides(l,t,i,s,r,e.frontUVs,e.backUVs);const p=new As;return p.indices=i,p.positions=t,p.normals=s,p.uvs=r,p}function Ll(e,t={},i=null){const s=new ur(e,i);return t.sideOrientation=ur._GetDefaultSideOrientation(t.sideOrientation),s._originalBuilderSideOrientation=t.sideOrientation,wl(t).applyToMesh(s,t.updatable),s}function Bl(e){const t=e.pattern||ur.NO_FLIP,i=e.tileWidth||e.tileSize||1,s=e.tileHeight||e.tileSize||1,r=e.alignHorizontal||0,n=e.alignVertical||0,o=e.width||e.size||1,a=Math.floor(o/i);let l=o-a*i;const h=e.height||e.size||1,c=Math.floor(h/s);let u=h-c*s;const d=i*a/2,p=s*c/2;let _=0,f=0,m=0,g=0,v=0,x=0;if(l>0||u>0){switch(m=-d,g=-p,v=d,x=p,r){case ur.CENTER:l/=2,m-=l,v+=l;break;case ur.LEFT:v+=l,_=-l/2;break;case ur.RIGHT:m-=l,_=l/2}switch(n){case ur.CENTER:u/=2,g-=u,x+=u;break;case ur.BOTTOM:x+=u,f=-u/2;break;case ur.TOP:g-=u,f=u/2}}const T=[],E=[],S=[];S[0]=[0,0,1,0,1,1,0,1],S[1]=[0,0,1,0,1,1,0,1],t!==ur.ROTATE_TILE&&t!==ur.ROTATE_ROW||(S[1]=[1,1,0,1,0,0,1,0]),t!==ur.FLIP_TILE&&t!==ur.FLIP_ROW||(S[1]=[1,0,0,0,0,1,1,1]),t!==ur.FLIP_N_ROTATE_TILE&&t!==ur.FLIP_N_ROTATE_ROW||(S[1]=[0,1,1,1,1,0,0,0]);let b=[];const C=[],y=[];let A=0;for(let e=0;e<c;e++)for(let r=0;r<a;r++)T.push(r*i-d+_,e*s-p+f,0),T.push((r+1)*i-d+_,e*s-p+f,0),T.push((r+1)*i-d+_,(e+1)*s-p+f,0),T.push(r*i-d+_,(e+1)*s-p+f,0),y.push(A,A+1,A+3,A+1,A+2,A+3),b=t===ur.FLIP_TILE||t===ur.ROTATE_TILE||t===ur.FLIP_N_ROTATE_TILE?b.concat(S[(r%2+e%2)%2]):t===ur.FLIP_ROW||t===ur.ROTATE_ROW||t===ur.FLIP_N_ROTATE_ROW?b.concat(S[e%2]):b.concat(S[0]),C.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),E.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1),A+=4;if(l>0||u>0){const e=u>0&&(n===ur.CENTER||n===ur.TOP),o=u>0&&(n===ur.CENTER||n===ur.BOTTOM),h=l>0&&(r===ur.CENTER||r===ur.RIGHT),S=l>0&&(r===ur.CENTER||r===ur.LEFT);let R,I,P,M,O=[];if(e&&h&&(T.push(m+_,g+f,0),T.push(-d+_,g+f,0),T.push(-d+_,g+u+f,0),T.push(m+_,g+u+f,0),y.push(A,A+1,A+3,A+1,A+2,A+3),A+=4,R=1-l/i,I=1-u/s,P=1,M=1,O=[R,I,P,I,P,M,R,M],t===ur.ROTATE_ROW&&(O=[1-R,1-I,1-P,1-I,1-P,1-M,1-R,1-M]),t===ur.FLIP_ROW&&(O=[1-R,I,1-P,I,1-P,M,1-R,M]),t===ur.FLIP_N_ROTATE_ROW&&(O=[R,1-I,P,1-I,P,1-M,R,1-M]),b=b.concat(O),C.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),E.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),e&&S&&(T.push(d+_,g+f,0),T.push(v+_,g+f,0),T.push(v+_,g+u+f,0),T.push(d+_,g+u+f,0),y.push(A,A+1,A+3,A+1,A+2,A+3),A+=4,R=0,I=1-u/s,P=l/i,M=1,O=[R,I,P,I,P,M,R,M],(t===ur.ROTATE_ROW||t===ur.ROTATE_TILE&&a%2==0)&&(O=[1-R,1-I,1-P,1-I,1-P,1-M,1-R,1-M]),(t===ur.FLIP_ROW||t===ur.FLIP_TILE&&a%2==0)&&(O=[1-R,I,1-P,I,1-P,M,1-R,M]),(t===ur.FLIP_N_ROTATE_ROW||t===ur.FLIP_N_ROTATE_TILE&&a%2==0)&&(O=[R,1-I,P,1-I,P,1-M,R,1-M]),b=b.concat(O),C.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),E.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),o&&h&&(T.push(m+_,p+f,0),T.push(-d+_,p+f,0),T.push(-d+_,x+f,0),T.push(m+_,x+f,0),y.push(A,A+1,A+3,A+1,A+2,A+3),A+=4,R=1-l/i,I=0,P=1,M=u/s,O=[R,I,P,I,P,M,R,M],(t===ur.ROTATE_ROW&&c%2==1||t===ur.ROTATE_TILE&&c%1==0)&&(O=[1-R,1-I,1-P,1-I,1-P,1-M,1-R,1-M]),(t===ur.FLIP_ROW&&c%2==1||t===ur.FLIP_TILE&&c%2==0)&&(O=[1-R,I,1-P,I,1-P,M,1-R,M]),(t===ur.FLIP_N_ROTATE_ROW&&c%2==1||t===ur.FLIP_N_ROTATE_TILE&&c%2==0)&&(O=[R,1-I,P,1-I,P,1-M,R,1-M]),b=b.concat(O),C.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),E.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),o&&S&&(T.push(d+_,p+f,0),T.push(v+_,p+f,0),T.push(v+_,x+f,0),T.push(d+_,x+f,0),y.push(A,A+1,A+3,A+1,A+2,A+3),A+=4,R=0,I=0,P=l/i,M=u/s,O=[R,I,P,I,P,M,R,M],(t===ur.ROTATE_ROW&&c%2==1||t===ur.ROTATE_TILE&&(c+a)%2==1)&&(O=[1-R,1-I,1-P,1-I,1-P,1-M,1-R,1-M]),(t===ur.FLIP_ROW&&c%2==1||t===ur.FLIP_TILE&&(c+a)%2==1)&&(O=[1-R,I,1-P,I,1-P,M,1-R,M]),(t===ur.FLIP_N_ROTATE_ROW&&c%2==1||t===ur.FLIP_N_ROTATE_TILE&&(c+a)%2==1)&&(O=[R,1-I,P,1-I,P,1-M,R,1-M]),b=b.concat(O),C.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),E.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),e){const e=[];R=0,I=1-u/s,P=1,M=1,e[0]=[R,I,P,I,P,M,R,M],e[1]=[R,I,P,I,P,M,R,M],t!==ur.ROTATE_TILE&&t!==ur.ROTATE_ROW||(e[1]=[1-R,1-I,1-P,1-I,1-P,1-M,1-R,1-M]),t!==ur.FLIP_TILE&&t!==ur.FLIP_ROW||(e[1]=[1-R,I,1-P,I,1-P,M,1-R,M]),t!==ur.FLIP_N_ROTATE_TILE&&t!==ur.FLIP_N_ROTATE_ROW||(e[1]=[R,1-I,P,1-I,P,1-M,R,1-M]);for(let s=0;s<a;s++)T.push(s*i-d+_,g+f,0),T.push((s+1)*i-d+_,g+f,0),T.push((s+1)*i-d+_,g+u+f,0),T.push(s*i-d+_,g+u+f,0),y.push(A,A+1,A+3,A+1,A+2,A+3),A+=4,b=t===ur.FLIP_TILE||t===ur.ROTATE_TILE||t===ur.FLIP_N_ROTATE_TILE?b.concat(e[(s+1)%2]):t===ur.FLIP_ROW||t===ur.ROTATE_ROW||t===ur.FLIP_N_ROTATE_ROW?b.concat(e[1]):b.concat(e[0]),C.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),E.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(o){const e=[];R=0,I=0,P=1,M=u/s,e[0]=[R,I,P,I,P,M,R,M],e[1]=[R,I,P,I,P,M,R,M],t!==ur.ROTATE_TILE&&t!==ur.ROTATE_ROW||(e[1]=[1-R,1-I,1-P,1-I,1-P,1-M,1-R,1-M]),t!==ur.FLIP_TILE&&t!==ur.FLIP_ROW||(e[1]=[1-R,I,1-P,I,1-P,M,1-R,M]),t!==ur.FLIP_N_ROTATE_TILE&&t!==ur.FLIP_N_ROTATE_ROW||(e[1]=[R,1-I,P,1-I,P,1-M,R,1-M]);for(let s=0;s<a;s++)T.push(s*i-d+_,x-u+f,0),T.push((s+1)*i-d+_,x-u+f,0),T.push((s+1)*i-d+_,x+f,0),T.push(s*i-d+_,x+f,0),y.push(A,A+1,A+3,A+1,A+2,A+3),A+=4,b=t===ur.FLIP_TILE||t===ur.ROTATE_TILE||t===ur.FLIP_N_ROTATE_TILE?b.concat(e[(s+c)%2]):t===ur.FLIP_ROW||t===ur.ROTATE_ROW||t===ur.FLIP_N_ROTATE_ROW?b.concat(e[c%2]):b.concat(e[0]),C.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),E.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(h){const e=[];R=1-l/i,I=0,P=1,M=1,e[0]=[R,I,P,I,P,M,R,M],e[1]=[R,I,P,I,P,M,R,M],t!==ur.ROTATE_TILE&&t!==ur.ROTATE_ROW||(e[1]=[1-R,1-I,1-P,1-I,1-P,1-M,1-R,1-M]),t!==ur.FLIP_TILE&&t!==ur.FLIP_ROW||(e[1]=[1-R,I,1-P,I,1-P,M,1-R,M]),t!==ur.FLIP_N_ROTATE_TILE&&t!==ur.FLIP_N_ROTATE_ROW||(e[1]=[R,1-I,P,1-I,P,1-M,R,1-M]);for(let i=0;i<c;i++)T.push(m+_,i*s-p+f,0),T.push(m+l+_,i*s-p+f,0),T.push(m+l+_,(i+1)*s-p+f,0),T.push(m+_,(i+1)*s-p+f,0),y.push(A,A+1,A+3,A+1,A+2,A+3),A+=4,b=t===ur.FLIP_TILE||t===ur.ROTATE_TILE||t===ur.FLIP_N_ROTATE_TILE?b.concat(e[(i+1)%2]):t===ur.FLIP_ROW||t===ur.ROTATE_ROW||t===ur.FLIP_N_ROTATE_ROW?b.concat(e[i%2]):b.concat(e[0]),C.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),E.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(S){const e=[];R=0,I=0,P=l/s,M=1,e[0]=[R,I,P,I,P,M,R,M],e[1]=[R,I,P,I,P,M,R,M],t!==ur.ROTATE_TILE&&t!==ur.ROTATE_ROW||(e[1]=[1-R,1-I,1-P,1-I,1-P,1-M,1-R,1-M]),t!==ur.FLIP_TILE&&t!==ur.FLIP_ROW||(e[1]=[1-R,I,1-P,I,1-P,M,1-R,M]),t!==ur.FLIP_N_ROTATE_TILE&&t!==ur.FLIP_N_ROTATE_ROW||(e[1]=[R,1-I,P,1-I,P,1-M,R,1-M]);for(let i=0;i<c;i++)T.push(v-l+_,i*s-p+f,0),T.push(v+_,i*s-p+f,0),T.push(v+_,(i+1)*s-p+f,0),T.push(v-l+_,(i+1)*s-p+f,0),y.push(A,A+1,A+3,A+1,A+2,A+3),A+=4,b=t===ur.FLIP_TILE||t===ur.ROTATE_TILE||t===ur.FLIP_N_ROTATE_TILE?b.concat(e[(i+a)%2]):t===ur.FLIP_ROW||t===ur.ROTATE_ROW||t===ur.FLIP_N_ROTATE_ROW?b.concat(e[i%2]):b.concat(e[0]),C.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),E.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}}const R=0===e.sideOrientation?0:e.sideOrientation||As.DEFAULTSIDE;As._ComputeSides(R,T,y,E,b,e.frontUVs,e.backUVs);const I=new As;I.indices=y,I.positions=T,I.normals=E,I.uvs=b;const P=R===As.DOUBLESIDE?C.concat(C):C;return I.colors=P,I}function Ul(e){const t=[],i=[],s=[],r=[],n=e.radius||2,o=e.tube||.5,a=e.radialSegments||32,l=e.tubularSegments||32,h=e.p||2,c=e.q||3,u=0===e.sideOrientation?0:e.sideOrientation||As.DEFAULTSIDE,d=e=>{const t=Math.cos(e),i=Math.sin(e),s=c/h*e,r=Math.cos(s),o=n*(2+r)*.5*t,a=n*(2+r)*i*.5,l=n*Math.sin(s)*.5;return new S(o,a,l)};let p,_;for(p=0;p<=a;p++){const e=p%a/a*2*h*Math.PI,t=d(e),s=d(e+.01),n=s.subtract(t);let c=s.add(t);const u=S.Cross(n,c);for(c=S.Cross(u,n),u.normalize(),c.normalize(),_=0;_<l;_++){const e=_%l/l*2*Math.PI,s=-o*Math.cos(e),n=o*Math.sin(e);i.push(t.x+s*c.x+n*u.x),i.push(t.y+s*c.y+n*u.y),i.push(t.z+s*c.z+n*u.z),r.push(p/a),r.push(Is.UseOpenGLOrientationForUV?1-_/l:_/l)}}for(p=0;p<a;p++)for(_=0;_<l;_++){const e=(_+1)%l,i=p*l+_,s=(p+1)*l+_,r=(p+1)*l+e,n=p*l+e;t.push(n),t.push(s),t.push(i),t.push(n),t.push(r),t.push(s)}As.ComputeNormals(i,t,s),As._ComputeSides(u,i,t,s,r,e.frontUVs,e.backUVs);const f=new As;return f.indices=t,f.positions=i,f.normals=s,f.uvs=r,f}Rl.InspectorURL=`${Ht._DefaultCdnUrl}/v${Ns.Version}/inspector/babylon.inspector.bundle.js`,Rl.Config={overlay:!1,showExplorer:!0,showInspector:!0,embedMode:!1,handleResize:!0,enablePopup:!0},As.CreateBox=Il,ur.CreateBox=(e,t,i=null,s,r)=>Pl(e,{size:t,sideOrientation:r,updatable:s},i),As.CreateSphere=Ml,ur.CreateSphere=(e,t,i,s,r,n)=>Ol(e,{segments:t,diameterX:i,diameterY:i,diameterZ:i,sideOrientation:n,updatable:r},s),ur.CreateCapsule=(e,t,i)=>function(e,t={orientation:S.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6,updatable:!1},i=null){const s=new ur(e,i);return Dl(t).applyToMesh(s,t.updatable),s}(e,t,i),As.CreateCapsule=Dl,As.CreateRibbon=Nl,ur.CreateRibbon=(e,t,i=!1,s,r,n,o=!1,a,l)=>Fl(e,{pathArray:t,closeArray:i,closePath:s,offset:r,updatable:o,sideOrientation:a,instance:l},n),As.CreateDisc=wl,ur.CreateDisc=(e,t,i,s=null,r,n)=>Ll(e,{radius:t,tessellation:i,sideOrientation:n,updatable:r},s),As.CreateTiledPlane=Bl,As.CreateTiledBox=function(e){const t=e.faceUV||new Array(6),i=e.faceColors,s=e.pattern||ur.NO_FLIP,r=e.width||e.size||1,n=e.height||e.size||1,o=e.depth||e.size||1,a=e.tileWidth||e.tileSize||1,l=e.tileHeight||e.tileSize||1,h=e.alignHorizontal||0,c=e.alignVertical||0,u=0===e.sideOrientation?0:e.sideOrientation||As.DEFAULTSIDE;for(let e=0;e<6;e++)void 0===t[e]&&(t[e]=new b(0,0,1,1)),i&&void 0===i[e]&&(i[e]=new F(1,1,1,1));const d=r/2,p=n/2,_=o/2,f=[];for(let e=0;e<2;e++)f[e]=Bl({pattern:s,tileWidth:a,tileHeight:l,width:r,height:n,alignVertical:c,alignHorizontal:h,sideOrientation:u});for(let e=2;e<4;e++)f[e]=Bl({pattern:s,tileWidth:a,tileHeight:l,width:o,height:n,alignVertical:c,alignHorizontal:h,sideOrientation:u});let m=c;c===ur.BOTTOM?m=ur.TOP:c===ur.TOP&&(m=ur.BOTTOM);for(let e=4;e<6;e++)f[e]=Bl({pattern:s,tileWidth:a,tileHeight:l,width:r,height:o,alignVertical:m,alignHorizontal:h,sideOrientation:u});let g=[],v=[],x=[],T=[];const E=[],C=[],A=[],R=[];let I=0,P=0;for(let e=0;e<6;e++){const s=f[e].positions.length;C[e]=[],A[e]=[];for(let t=0;t<s/3;t++)C[e].push(new S(f[e].positions[3*t],f[e].positions[3*t+1],f[e].positions[3*t+2])),A[e].push(new S(f[e].normals[3*t],f[e].normals[3*t+1],f[e].normals[3*t+2]));I=f[e].uvs.length,R[e]=[];for(let i=0;i<I;i+=2)R[e][i]=t[e].x+(t[e].z-t[e].x)*f[e].uvs[i],R[e][i+1]=t[e].y+(t[e].w-t[e].y)*f[e].uvs[i+1],Is.UseOpenGLOrientationForUV&&(R[e][i+1]=1-R[e][i+1]);if(x=x.concat(R[e]),T=T.concat(f[e].indices.map((e=>e+P))),P+=C[e].length,i)for(let t=0;t<4;t++)E.push(i[e].r,i[e].g,i[e].b,i[e].a)}const M=new S(0,0,_),O=y.RotationY(Math.PI);g=C[0].map((e=>S.TransformNormal(e,O).add(M))).map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[]),v=A[0].map((e=>S.TransformNormal(e,O))).map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[]),g=g.concat(C[1].map((e=>e.subtract(M))).map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[])),v=v.concat(A[1].map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[]));const D=new S(d,0,0),N=y.RotationY(-Math.PI/2);g=g.concat(C[2].map((e=>S.TransformNormal(e,N).add(D))).map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[])),v=v.concat(A[2].map((e=>S.TransformNormal(e,N))).map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[]));const w=y.RotationY(Math.PI/2);g=g.concat(C[3].map((e=>S.TransformNormal(e,w).subtract(D))).map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[])),v=v.concat(A[3].map((e=>S.TransformNormal(e,w))).map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[]));const L=new S(0,p,0),B=y.RotationX(Math.PI/2);g=g.concat(C[4].map((e=>S.TransformNormal(e,B).add(L))).map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[])),v=v.concat(A[4].map((e=>S.TransformNormal(e,B))).map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[]));const U=y.RotationX(-Math.PI/2);g=g.concat(C[5].map((e=>S.TransformNormal(e,U).subtract(L))).map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[])),v=v.concat(A[5].map((e=>S.TransformNormal(e,U))).map((e=>[e.x,e.y,e.z])).reduce(((e,t)=>e.concat(t)),[])),As._ComputeSides(u,g,T,v,x);const V=new As;if(V.indices=T,V.positions=g,V.normals=v,V.uvs=x,i){const e=u===As.DOUBLESIDE?E.concat(E):E;V.colors=e}return V},As.CreateTorusKnot=Ul,ur.CreateTorusKnot=(e,t,i,s,r,n,o,a,l,h)=>function(e,t={},i){const s=new ur(e,i);return t.sideOrientation=ur._GetDefaultSideOrientation(t.sideOrientation),s._originalBuilderSideOrientation=t.sideOrientation,Ul(t).applyToMesh(s,t.updatable),s}(e,{radius:t,tube:i,radialSegments:s,tubularSegments:r,p:n,q:o,sideOrientation:h,updatable:l},a);const Vl={effect:null,subMesh:null};class kl extends Xr{constructor(e,t,i,s={},r=!0){super(e,t,r),this._textures={},this._textureArrays={},this._externalTextures={},this._floats={},this._ints={},this._uints={},this._floatsArrays={},this._colors3={},this._colors3Arrays={},this._colors4={},this._colors4Arrays={},this._vectors2={},this._vectors3={},this._vectors4={},this._quaternions={},this._quaternionsArrays={},this._matrices={},this._matrixArrays={},this._matrices3x3={},this._matrices2x2={},this._vectors2Arrays={},this._vectors3Arrays={},this._vectors4Arrays={},this._uniformBuffers={},this._textureSamplers={},this._storageBuffers={},this._cachedWorldViewMatrix=new y,this._cachedWorldViewProjectionMatrix=new y,this._multiview=!1,this._materialHelperNeedsPreviousMatrices=!1,this._shaderPath=i,this._options=Object.assign({needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:!1},s)}get shaderPath(){return this._shaderPath}set shaderPath(e){this._shaderPath=e}get options(){return this._options}get isMultiview(){return this._multiview}getClassName(){return"ShaderMaterial"}needAlphaBlending(){return this.alpha<1||this._options.needAlphaBlending}needAlphaTesting(){return this._options.needAlphaTesting}_checkUniform(e){-1===this._options.uniforms.indexOf(e)&&this._options.uniforms.push(e)}setTexture(e,t){return-1===this._options.samplers.indexOf(e)&&this._options.samplers.push(e),this._textures[e]=t,this}setTextureArray(e,t){return-1===this._options.samplers.indexOf(e)&&this._options.samplers.push(e),this._checkUniform(e),this._textureArrays[e]=t,this}setExternalTexture(e,t){return-1===this._options.externalTextures.indexOf(e)&&this._options.externalTextures.push(e),this._externalTextures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setUInt(e,t){return this._checkUniform(e),this._uints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor3Array(e,t){return this._checkUniform(e),this._colors3Arrays[e]=t.reduce(((e,t)=>(t.toArray(e,e.length),e)),[]),this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setColor4Array(e,t){return this._checkUniform(e),this._colors4Arrays[e]=t.reduce(((e,t)=>(t.toArray(e,e.length),e)),[]),this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setQuaternion(e,t){return this._checkUniform(e),this._quaternions[e]=t,this}setQuaternionArray(e,t){return this._checkUniform(e),this._quaternionsArrays[e]=t.reduce(((e,t)=>(t.toArray(e,e.length),e)),[]),this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}setMatrices(e,t){this._checkUniform(e);const i=new Float32Array(16*t.length);for(let e=0;e<t.length;e++)t[e].copyToArray(i,16*e);return this._matrixArrays[e]=i,this}setMatrix3x3(e,t){return this._checkUniform(e),this._matrices3x3[e]=t,this}setMatrix2x2(e,t){return this._checkUniform(e),this._matrices2x2[e]=t,this}setArray2(e,t){return this._checkUniform(e),this._vectors2Arrays[e]=t,this}setArray3(e,t){return this._checkUniform(e),this._vectors3Arrays[e]=t,this}setArray4(e,t){return this._checkUniform(e),this._vectors4Arrays[e]=t,this}setUniformBuffer(e,t){return-1===this._options.uniformBuffers.indexOf(e)&&this._options.uniformBuffers.push(e),this._uniformBuffers[e]=t,this}setTextureSampler(e,t){return-1===this._options.samplerObjects.indexOf(e)&&this._options.samplerObjects.push(e),this._textureSamplers[e]=t,this}setStorageBuffer(e,t){return-1===this._options.storageBuffers.indexOf(e)&&this._options.storageBuffers.push(e),this._storageBuffers[e]=t,this}setDefine(e,t){const i=e.trimEnd()+" ",s=this.options.defines.findIndex((t=>t===e||t.startsWith(i)));return s>=0&&this.options.defines.splice(s,1),("boolean"!=typeof t||t)&&this.options.defines.push(i+t),this}isReadyForSubMesh(e,t,i){return this.isReady(e,i,t)}isReady(e,t,i){var s,r,n,o;const a=i&&this._storeEffectOnSubMeshes;if(this.isFrozen)if(a){if(i.effect&&i.effect._wasPreviouslyReady)return!0}else{const e=this._drawWrapper.effect;if(e&&e._wasPreviouslyReady&&e._wasPreviouslyUsingInstances===t)return!0}const l=this.getScene(),h=l.getEngine(),c=[],u=[],d=new hn;let p=this._shaderPath,_=this._options.uniforms,f=this._options.uniformBuffers,m=this._options.samplers;h.getCaps().multiview&&l.activeCamera&&l.activeCamera.outputRenderTarget&&l.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=!0,c.push("#define MULTIVIEW"),-1!==this._options.uniforms.indexOf("viewProjection")&&-1===this._options.uniforms.indexOf("viewProjectionR")&&this._options.uniforms.push("viewProjectionR"));for(let e=0;e<this._options.defines.length;e++){const t=0===this._options.defines[e].indexOf("#define")?this._options.defines[e]:`#define ${this._options.defines[e]}`;c.push(t)}for(let e=0;e<this._options.attributes.length;e++)u.push(this._options.attributes[e]);if(e&&e.isVerticesDataPresent(hi.ColorKind)&&(-1===u.indexOf(hi.ColorKind)&&u.push(hi.ColorKind),c.push("#define VERTEXCOLOR")),t&&(c.push("#define INSTANCES"),Hs.PushAttributesForInstances(u,this._materialHelperNeedsPreviousMatrices),(null==e?void 0:e.hasThinInstances)&&(c.push("#define THIN_INSTANCES"),e&&e.isVerticesDataPresent(hi.ColorInstanceKind)&&(u.push(hi.ColorInstanceKind),c.push("#define INSTANCESCOLOR")))),e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton){u.push(hi.MatricesIndicesKind),u.push(hi.MatricesWeightsKind),e.numBoneInfluencers>4&&(u.push(hi.MatricesIndicesExtraKind),u.push(hi.MatricesWeightsExtraKind));const t=e.skeleton;c.push("#define NUM_BONE_INFLUENCERS "+e.numBoneInfluencers),d.addCPUSkinningFallback(0,e),t.isUsingTextureForMatrices?(c.push("#define BONETEXTURE"),-1===this._options.uniforms.indexOf("boneTextureWidth")&&this._options.uniforms.push("boneTextureWidth"),-1===this._options.samplers.indexOf("boneSampler")&&this._options.samplers.push("boneSampler")):(c.push("#define BonesPerMesh "+(t.bones.length+1)),-1===this._options.uniforms.indexOf("mBones")&&this._options.uniforms.push("mBones"))}else c.push("#define NUM_BONE_INFLUENCERS 0");let g=0;const v=e?e.morphTargetManager:null;if(v){const e=v.supportsUVs&&-1!==c.indexOf("#define UV1"),t=v.supportsTangents&&-1!==c.indexOf("#define TANGENT"),i=v.supportsNormals&&-1!==c.indexOf("#define NORMAL");g=v.numInfluencers,e&&c.push("#define MORPHTARGETS_UV"),t&&c.push("#define MORPHTARGETS_TANGENT"),i&&c.push("#define MORPHTARGETS_NORMAL"),g>0&&c.push("#define MORPHTARGETS"),v.isUsingTextureForTargets&&(c.push("#define MORPHTARGETS_TEXTURE"),-1===this._options.uniforms.indexOf("morphTargetTextureIndices")&&this._options.uniforms.push("morphTargetTextureIndices"),-1===this._options.samplers.indexOf("morphTargets")&&this._options.samplers.push("morphTargets")),c.push("#define NUM_MORPH_INFLUENCERS "+g);for(let s=0;s<g;s++)u.push(hi.PositionKind+s),i&&u.push(hi.NormalKind+s),t&&u.push(hi.TangentKind+s),e&&u.push(hi.UVKind+"_"+s);g>0&&(_=_.slice(),_.push("morphTargetInfluences"),_.push("morphTargetTextureInfo"),_.push("morphTargetTextureIndices"))}else c.push("#define NUM_MORPH_INFLUENCERS 0");if(e){const t=e.bakedVertexAnimationManager;t&&t.isEnabled&&(c.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),-1===this._options.uniforms.indexOf("bakedVertexAnimationSettings")&&this._options.uniforms.push("bakedVertexAnimationSettings"),-1===this._options.uniforms.indexOf("bakedVertexAnimationTextureSizeInverted")&&this._options.uniforms.push("bakedVertexAnimationTextureSizeInverted"),-1===this._options.uniforms.indexOf("bakedVertexAnimationTime")&&this._options.uniforms.push("bakedVertexAnimationTime"),-1===this._options.samplers.indexOf("bakedVertexAnimationTexture")&&this._options.samplers.push("bakedVertexAnimationTexture")),Hs.PrepareAttributesForBakedVertexAnimation(u,e,c)}for(const e in this._textures)if(!this._textures[e].isReady())return!1;e&&this._shouldTurnAlphaTestOn(e)&&c.push("#define ALPHATEST"),!1!==this._options.useClipPlane&&(ks(_),Gs(this,l,c)),this._useLogarithmicDepth&&(c.push("#define LOGARITHMICDEPTH"),-1===this._options.uniforms.indexOf("logarithmicDepthConstant")&&this._options.uniforms.push("logarithmicDepthConstant")),this.customShaderNameResolve&&(_=_.slice(),f=f.slice(),m=m.slice(),p=this.customShaderNameResolve(p,_,f,m,c,u));const x=a?i._getDrawWrapper():this._drawWrapper,T=null!==(s=null==x?void 0:x.effect)&&void 0!==s?s:null,E=null!==(r=null==x?void 0:x.defines)&&void 0!==r?r:null,S=c.join("\n");let b=T;return E!==S&&(b=h.createEffect(p,{attributes:u,uniformsNames:_,uniformBuffersNames:f,samplers:m,defines:S,fallbacks:d,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:g},shaderLanguage:this._options.shaderLanguage},h),a?i.setEffect(b,S,this._materialContext):x&&x.setEffect(b,S),this._onEffectCreatedObservable&&(Vl.effect=b,Vl.subMesh=null!==(n=null!=i?i:null==e?void 0:e.subMeshes[0])&&void 0!==n?n:null,this._onEffectCreatedObservable.notifyObservers(Vl))),b._wasPreviouslyUsingInstances=!!t,null!==(o=!(null==b?void 0:b.isReady()))&&void 0!==o&&!o&&(T!==b&&l.resetCachedMaterial(),b._wasPreviouslyReady=!0,!0)}bindOnlyWorldMatrix(e,t){const i=this.getScene(),s=null!=t?t:this.getEffect();s&&(-1!==this._options.uniforms.indexOf("world")&&s.setMatrix("world",e),-1!==this._options.uniforms.indexOf("worldView")&&(e.multiplyToRef(i.getViewMatrix(),this._cachedWorldViewMatrix),s.setMatrix("worldView",this._cachedWorldViewMatrix)),-1!==this._options.uniforms.indexOf("worldViewProjection")&&(e.multiplyToRef(i.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),s.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)))}bindForSubMesh(e,t,i){var s;this.bind(e,t,null===(s=i._drawWrapperOverride)||void 0===s?void 0:s.effect,i)}bind(e,t,i,s){var r;const n=s&&this._storeEffectOnSubMeshes,o=null!=i?i:n?s.effect:this.getEffect();if(!o)return;const a=this.getScene();this._activeEffect=o,this.bindOnlyWorldMatrix(e,i);const l=this._options.uniformBuffers;let h=!1;if(o&&l&&l.length>0&&a.getEngine().supportsUniformBuffers)for(let i=0;i<l.length;++i)switch(l[i]){case"Mesh":t&&(t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(e));break;case"Scene":Hs.BindSceneUniformBuffer(o,a.getSceneUniformBuffer()),a.finalizeSceneUbo(),h=!0}const c=t&&n?this._mustRebind(a,o,t.visibility):a.getCachedMaterial()!==this;if(o&&c){let e;for(e in h||-1===this._options.uniforms.indexOf("view")||o.setMatrix("view",a.getViewMatrix()),h||-1===this._options.uniforms.indexOf("projection")||o.setMatrix("projection",a.getProjectionMatrix()),h||-1===this._options.uniforms.indexOf("viewProjection")||(o.setMatrix("viewProjection",a.getTransformMatrix()),this._multiview&&o.setMatrix("viewProjectionR",a._transformMatrixR)),a.activeCamera&&-1!==this._options.uniforms.indexOf("cameraPosition")&&o.setVector3("cameraPosition",a.activeCamera.globalPosition),Hs.BindBonesParameters(t,o),zs(o,this,a),this._useLogarithmicDepth&&Hs.BindLogDepth(n?s.materialDefines:o.defines,o,a),this._textures)o.setTexture(e,this._textures[e]);for(e in this._textureArrays)o.setTextureArray(e,this._textureArrays[e]);for(e in this._externalTextures)o.setExternalTexture(e,this._externalTextures[e]);for(e in this._ints)o.setInt(e,this._ints[e]);for(e in this._uints)o.setUInt(e,this._uints[e]);for(e in this._floats)o.setFloat(e,this._floats[e]);for(e in this._floatsArrays)o.setArray(e,this._floatsArrays[e]);for(e in this._colors3)o.setColor3(e,this._colors3[e]);for(e in this._colors3Arrays)o.setArray3(e,this._colors3Arrays[e]);for(e in this._colors4){const t=this._colors4[e];o.setFloat4(e,t.r,t.g,t.b,t.a)}for(e in this._colors4Arrays)o.setArray4(e,this._colors4Arrays[e]);for(e in this._vectors2)o.setVector2(e,this._vectors2[e]);for(e in this._vectors3)o.setVector3(e,this._vectors3[e]);for(e in this._vectors4)o.setVector4(e,this._vectors4[e]);for(e in this._quaternions)o.setQuaternion(e,this._quaternions[e]);for(e in this._matrices)o.setMatrix(e,this._matrices[e]);for(e in this._matrixArrays)o.setMatrices(e,this._matrixArrays[e]);for(e in this._matrices3x3)o.setMatrix3x3(e,this._matrices3x3[e]);for(e in this._matrices2x2)o.setMatrix2x2(e,this._matrices2x2[e]);for(e in this._vectors2Arrays)o.setArray2(e,this._vectors2Arrays[e]);for(e in this._vectors3Arrays)o.setArray3(e,this._vectors3Arrays[e]);for(e in this._vectors4Arrays)o.setArray4(e,this._vectors4Arrays[e]);for(e in this._quaternionsArrays)o.setArray4(e,this._quaternionsArrays[e]);for(e in this._uniformBuffers){const t=this._uniformBuffers[e].getBuffer();t&&o.bindUniformBuffer(t,e)}for(e in this._textureSamplers)o.setTextureSampler(e,this._textureSamplers[e]);for(e in this._storageBuffers)o.setStorageBuffer(e,this._storageBuffers[e])}if(o&&t&&(c||!this.isFrozen)){const e=t.morphTargetManager;e&&e.numInfluencers>0&&Hs.BindMorphTargetParameters(t,o);const i=t.bakedVertexAnimationManager;i&&i.isEnabled&&(null===(r=t.bakedVertexAnimationManager)||void 0===r||r.bind(o,!!o._wasPreviouslyUsingInstances))}this._afterBind(t,o)}getActiveTextures(){const e=super.getActiveTextures();for(const t in this._textures)e.push(this._textures[t]);for(const t in this._textureArrays){const i=this._textureArrays[t];for(let t=0;t<i.length;t++)e.push(i[t])}return e}hasTexture(e){if(super.hasTexture(e))return!0;for(const t in this._textures)if(this._textures[t]===e)return!0;for(const t in this._textureArrays){const i=this._textureArrays[t];for(let t=0;t<i.length;t++)if(i[t]===e)return!0}return!1}clone(e){const t=de.Clone((()=>new kl(e,this.getScene(),this._shaderPath,this._options,this._storeEffectOnSubMeshes)),this);t.name=e,t.id=e,"object"==typeof t._shaderPath&&(t._shaderPath=Object.assign({},t._shaderPath)),this._options=Object.assign({},this._options),Object.keys(this._options).forEach((e=>{const t=this._options[e];Array.isArray(t)&&(this._options[e]=t.slice(0))})),this.stencil.copyTo(t.stencil);for(const e in this._textures)t.setTexture(e,this._textures[e]);for(const e in this._textureArrays)t.setTextureArray(e,this._textureArrays[e]);for(const e in this._externalTextures)t.setExternalTexture(e,this._externalTextures[e]);for(const e in this._ints)t.setInt(e,this._ints[e]);for(const e in this._uints)t.setUInt(e,this._uints[e]);for(const e in this._floats)t.setFloat(e,this._floats[e]);for(const e in this._floatsArrays)t.setFloats(e,this._floatsArrays[e]);for(const e in this._colors3)t.setColor3(e,this._colors3[e]);for(const e in this._colors3Arrays)t._colors3Arrays[e]=this._colors3Arrays[e];for(const e in this._colors4)t.setColor4(e,this._colors4[e]);for(const e in this._colors4Arrays)t._colors4Arrays[e]=this._colors4Arrays[e];for(const e in this._vectors2)t.setVector2(e,this._vectors2[e]);for(const e in this._vectors3)t.setVector3(e,this._vectors3[e]);for(const e in this._vectors4)t.setVector4(e,this._vectors4[e]);for(const e in this._quaternions)t.setQuaternion(e,this._quaternions[e]);for(const e in this._quaternionsArrays)t._quaternionsArrays[e]=this._quaternionsArrays[e];for(const e in this._matrices)t.setMatrix(e,this._matrices[e]);for(const e in this._matrixArrays)t._matrixArrays[e]=this._matrixArrays[e].slice();for(const e in this._matrices3x3)t.setMatrix3x3(e,this._matrices3x3[e]);for(const e in this._matrices2x2)t.setMatrix2x2(e,this._matrices2x2[e]);for(const e in this._vectors2Arrays)t.setArray2(e,this._vectors2Arrays[e]);for(const e in this._vectors3Arrays)t.setArray3(e,this._vectors3Arrays[e]);for(const e in this._vectors4Arrays)t.setArray4(e,this._vectors4Arrays[e]);for(const e in this._uniformBuffers)t.setUniformBuffer(e,this._uniformBuffers[e]);for(const e in this._textureSamplers)t.setTextureSampler(e,this._textureSamplers[e]);for(const e in this._storageBuffers)t.setStorageBuffer(e,this._storageBuffers[e]);return t}dispose(e,t,i){if(t){let e;for(e in this._textures)this._textures[e].dispose();for(e in this._textureArrays){const t=this._textureArrays[e];for(let e=0;e<t.length;e++)t[e].dispose()}}this._textures={},super.dispose(e,t,i)}serialize(){const e=de.Serialize(this);let t;for(t in e.customType="BABYLON.ShaderMaterial",e.uniqueId=this.uniqueId,e.options=this._options,e.shaderPath=this._shaderPath,e.storeEffectOnSubMeshes=this._storeEffectOnSubMeshes,e.stencil=this.stencil.serialize(),e.textures={},this._textures)e.textures[t]=this._textures[t].serialize();for(t in e.textureArrays={},this._textureArrays){e.textureArrays[t]=[];const i=this._textureArrays[t];for(let s=0;s<i.length;s++)e.textureArrays[t].push(i[s].serialize())}for(t in e.ints={},this._ints)e.ints[t]=this._ints[t];for(t in e.uints={},this._uints)e.uints[t]=this._uints[t];for(t in e.floats={},this._floats)e.floats[t]=this._floats[t];for(t in e.FloatArrays={},this._floatsArrays)e.FloatArrays[t]=this._floatsArrays[t];for(t in e.colors3={},this._colors3)e.colors3[t]=this._colors3[t].asArray();for(t in e.colors3Arrays={},this._colors3Arrays)e.colors3Arrays[t]=this._colors3Arrays[t];for(t in e.colors4={},this._colors4)e.colors4[t]=this._colors4[t].asArray();for(t in e.colors4Arrays={},this._colors4Arrays)e.colors4Arrays[t]=this._colors4Arrays[t];for(t in e.vectors2={},this._vectors2)e.vectors2[t]=this._vectors2[t].asArray();for(t in e.vectors3={},this._vectors3)e.vectors3[t]=this._vectors3[t].asArray();for(t in e.vectors4={},this._vectors4)e.vectors4[t]=this._vectors4[t].asArray();for(t in e.quaternions={},this._quaternions)e.quaternions[t]=this._quaternions[t].asArray();for(t in e.matrices={},this._matrices)e.matrices[t]=this._matrices[t].asArray();for(t in e.matrixArray={},this._matrixArrays)e.matrixArray[t]=this._matrixArrays[t];for(t in e.matrices3x3={},this._matrices3x3)e.matrices3x3[t]=this._matrices3x3[t];for(t in e.matrices2x2={},this._matrices2x2)e.matrices2x2[t]=this._matrices2x2[t];for(t in e.vectors2Arrays={},this._vectors2Arrays)e.vectors2Arrays[t]=this._vectors2Arrays[t];for(t in e.vectors3Arrays={},this._vectors3Arrays)e.vectors3Arrays[t]=this._vectors3Arrays[t];for(t in e.vectors4Arrays={},this._vectors4Arrays)e.vectors4Arrays[t]=this._vectors4Arrays[t];for(t in e.quaternionsArrays={},this._quaternionsArrays)e.quaternionsArrays[t]=this._quaternionsArrays[t];return e}static Parse(e,t,i){const s=de.Parse((()=>new kl(e.name,t,e.shaderPath,e.options,e.storeEffectOnSubMeshes)),e,t,i);let r;for(r in e.stencil&&s.stencil.parse(e.stencil,t,i),e.textures)s.setTexture(r,Ar.Parse(e.textures[r],t,i));for(r in e.textureArrays){const n=e.textureArrays[r],o=[];for(let e=0;e<n.length;e++)o.push(Ar.Parse(n[e],t,i));s.setTextureArray(r,o)}for(r in e.ints)s.setInt(r,e.ints[r]);for(r in e.uints)s.setUInt(r,e.uints[r]);for(r in e.floats)s.setFloat(r,e.floats[r]);for(r in e.floatsArrays)s.setFloats(r,e.floatsArrays[r]);for(r in e.colors3)s.setColor3(r,N.FromArray(e.colors3[r]));for(r in e.colors3Arrays){const t=e.colors3Arrays[r].reduce(((e,t,i)=>(i%3==0?e.push([t]):e[e.length-1].push(t),e)),[]).map((e=>N.FromArray(e)));s.setColor3Array(r,t)}for(r in e.colors4)s.setColor4(r,F.FromArray(e.colors4[r]));for(r in e.colors4Arrays){const t=e.colors4Arrays[r].reduce(((e,t,i)=>(i%4==0?e.push([t]):e[e.length-1].push(t),e)),[]).map((e=>F.FromArray(e)));s.setColor4Array(r,t)}for(r in e.vectors2)s.setVector2(r,E.FromArray(e.vectors2[r]));for(r in e.vectors3)s.setVector3(r,S.FromArray(e.vectors3[r]));for(r in e.vectors4)s.setVector4(r,b.FromArray(e.vectors4[r]));for(r in e.quaternions)s.setQuaternion(r,C.FromArray(e.quaternions[r]));for(r in e.matrices)s.setMatrix(r,y.FromArray(e.matrices[r]));for(r in e.matrixArray)s._matrixArrays[r]=new Float32Array(e.matrixArray[r]);for(r in e.matrices3x3)s.setMatrix3x3(r,e.matrices3x3[r]);for(r in e.matrices2x2)s.setMatrix2x2(r,e.matrices2x2[r]);for(r in e.vectors2Arrays)s.setArray2(r,e.vectors2Arrays[r]);for(r in e.vectors3Arrays)s.setArray3(r,e.vectors3Arrays[r]);for(r in e.vectors4Arrays)s.setArray4(r,e.vectors4Arrays[r]);for(r in e.quaternionsArrays)s.setArray4(r,e.quaternionsArrays[r]);return s}static ParseFromFileAsync(e,t,i,s=""){return new Promise(((r,n)=>{const o=new Te;o.addEventListener("readystatechange",(()=>{if(4==o.readyState)if(200==o.status){const t=JSON.parse(o.responseText),n=this.Parse(t,i||x.LastCreatedScene,s);e&&(n.name=e),r(n)}else n("Unable to load the ShaderMaterial")})),o.open("GET",t),o.send()}))}static ParseFromSnippetAsync(e,t,i=""){return new Promise(((s,r)=>{const n=new Te;n.addEventListener("readystatechange",(()=>{if(4==n.readyState)if(200==n.status){const r=JSON.parse(JSON.parse(n.responseText).jsonPayload),o=JSON.parse(r.shaderMaterial),a=this.Parse(o,t||x.LastCreatedScene,i);a.snippetId=e,s(a)}else r("Unable to load the snippet "+e)})),n.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),n.send()}))}}kl.SnippetUrl="https://snippet.babylonjs.com",kl.CreateFromSnippetAsync=kl.ParseFromSnippetAsync,m("BABYLON.ShaderMaterial",kl);nt.ShadersStore.colorPixelShader="#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\n#define VERTEXCOLOR\nvarying vec4 vColor;\n#else\nuniform vec4 color;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\ngl_FragColor=vColor;\n#else\ngl_FragColor=color;\n#endif\n#define CUSTOM_FRAGMENT_MAIN_END\n}";nt.ShadersStore.colorVertexShader="attribute vec3 position;\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(position,1.0);\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#include<clipPlaneVertex>\n#include<vertexColorMixing>\n#define CUSTOM_VERTEX_MAIN_END\n}",ur._LinesMeshParser=(e,t)=>Gl.Parse(e,t);class Gl extends ur{_isShaderMaterial(e){return"ShaderMaterial"===e.getClassName()}constructor(e,t=null,i=null,s=null,r,n,o,a){super(e,t,i,s,r),this.useVertexColor=n,this.useVertexAlpha=o,this.color=new N(1,1,1),this.alpha=1,s&&(this.color=s.color.clone(),this.alpha=s.alpha,this.useVertexColor=s.useVertexColor,this.useVertexAlpha=s.useVertexAlpha),this.intersectionThreshold=.1;const l={attributes:[hi.PositionKind],uniforms:["world","viewProjection"],needAlphaBlending:!0,defines:[],useClipPlane:null};!1===o?l.needAlphaBlending=!1:l.defines.push("#define VERTEXALPHA"),n?(l.defines.push("#define VERTEXCOLOR"),l.attributes.push(hi.ColorKind)):(l.uniforms.push("color"),this._color4=new F),a?this.material=a:(this.material=new kl("colorShader",this.getScene(),"color",l,!1),this.material.doNotSerialize=!0)}isReady(){return!!this._lineMaterial.isReady(this,!!this._userInstancedBuffersStorage||this.hasThinInstances)&&super.isReady()}getClassName(){return"LinesMesh"}get material(){return this._lineMaterial}set material(e){this._lineMaterial=e,this._lineMaterial.fillMode=sr.LineListDrawMode}get checkCollisions(){return!1}set checkCollisions(e){}_bind(e,t){if(!this._geometry)return this;const i=this.isUnIndexed?null:this._geometry.getIndexBuffer();if(!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(t,i):this._geometry._bind(t,i,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),!this.useVertexColor&&this._isShaderMaterial(this._lineMaterial)){const{r:e,g:t,b:i}=this.color;this._color4.set(e,t,i,this.alpha),this._lineMaterial.setColor4("color",this._color4)}return this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const s=this.getScene().getEngine();return this._unIndexed?s.drawArraysType(sr.LineListDrawMode,e.verticesStart,e.verticesCount,i):s.drawElementsType(sr.LineListDrawMode,e.indexStart,e.indexCount,i),this}dispose(e,t=!1,i){i||this._lineMaterial.dispose(!1,!1,!0),super.dispose(e)}clone(e,t=null,i){return new Gl(e,this.getScene(),t,this,i)}createInstance(e){const t=new zl(e,this);if(this.instancedBuffers){t.instancedBuffers={};for(const e in this.instancedBuffers)t.instancedBuffers[e]=this.instancedBuffers[e]}return t}serialize(e){super.serialize(e),e.color=this.color.asArray(),e.alpha=this.alpha}static Parse(e,t){const i=new Gl(e.name,t);return i.color=N.FromArray(e.color),i.alpha=e.alpha,i}}class zl extends dr{constructor(e,t){super(e,t),this.intersectionThreshold=t.intersectionThreshold}getClassName(){return"InstancedLinesMesh"}}function Wl(e){const t=[],i=[],s=e.lines,r=e.colors,n=[];let o=0;for(let e=0;e<s.length;e++){const a=s[e];for(let s=0;s<a.length;s++){const{x:l,y:h,z:c}=a[s];if(i.push(l,h,c),r){const t=r[e],{r:i,g:o,b:a,a:l}=t[s];n.push(i,o,a,l)}s>0&&(t.push(o-1),t.push(o)),o++}}const a=new As;return a.indices=t,a.positions=i,r&&(a.colors=n),a}function Hl(e){const t=e.dashSize||3,i=e.gapSize||1,s=e.dashNb||200,r=e.points,n=[],o=[],a=S.Zero();let l=0,h=0,c=0,u=0,d=0,p=0,_=0;for(_=0;_<r.length-1;_++)r[_+1].subtractToRef(r[_],a),l+=a.length();for(c=l/s,u=t*c/(t+i),_=0;_<r.length-1;_++){r[_+1].subtractToRef(r[_],a),h=Math.floor(a.length()/c),a.normalize();for(let e=0;e<h;e++)d=c*e,n.push(r[_].x+d*a.x,r[_].y+d*a.y,r[_].z+d*a.z),n.push(r[_].x+(d+u)*a.x,r[_].y+(d+u)*a.y,r[_].z+(d+u)*a.z),o.push(p,p+1),p+=2}const f=new As;return f.positions=n,f.indices=o,f}function Xl(e,t,i=null){const s=t.instance,r=t.lines,n=t.colors;if(s){const e=s.getVerticesData(hi.PositionKind);let t,i;n&&(t=s.getVerticesData(hi.ColorKind));let o=0,a=0;for(let s=0;s<r.length;s++){const l=r[s];for(let r=0;r<l.length;r++)e[o]=l[r].x,e[o+1]=l[r].y,e[o+2]=l[r].z,n&&t&&(i=n[s],t[a]=i[r].r,t[a+1]=i[r].g,t[a+2]=i[r].b,t[a+3]=i[r].a,a+=4),o+=3}return s.updateVerticesData(hi.PositionKind,e,!1,!1),n&&t&&s.updateVerticesData(hi.ColorKind,t,!1,!1),s}const o=new Gl(e,i,null,void 0,void 0,!!n,t.useVertexAlpha,t.material);return Wl(t).applyToMesh(o,t.updatable),o}function Yl(e,t,i=null){const s=t.colors?[t.colors]:null;return Xl(e,{lines:[t.points],updatable:t.updatable,instance:t.instance,colors:s,useVertexAlpha:t.useVertexAlpha,material:t.material},i)}As.CreateLineSystem=Wl,As.CreateDashedLines=Hl,ur.CreateLines=(e,t,i=null,s=!1,r=null)=>Yl(e,{points:t,updatable:s,instance:r},i),ur.CreateDashedLines=(e,t,i,s,r,n=null,o,a)=>function(e,t,i=null){const s=t.points,r=t.instance,n=t.gapSize||1,o=t.dashSize||3;if(r){const e=e=>{const t=S.Zero(),i=e.length/6;let n=0,o=0,a=0,l=0,h=0,c=0,u=0,d=0;for(u=0;u<s.length-1;u++)s[u+1].subtractToRef(s[u],t),n+=t.length();a=n/i;const p=r._creationDataStorage.dashSize;for(l=p*a/(p+r._creationDataStorage.gapSize),u=0;u<s.length-1;u++)for(s[u+1].subtractToRef(s[u],t),o=Math.floor(t.length()/a),t.normalize(),d=0;d<o&&c<e.length;)h=a*d,e[c]=s[u].x+h*t.x,e[c+1]=s[u].y+h*t.y,e[c+2]=s[u].z+h*t.z,e[c+3]=s[u].x+(h+l)*t.x,e[c+4]=s[u].y+(h+l)*t.y,e[c+5]=s[u].z+(h+l)*t.z,c+=6,d++;for(;c<e.length;)e[c]=s[u].x,e[c+1]=s[u].y,e[c+2]=s[u].z,c+=3};return(t.dashNb||t.dashSize||t.gapSize||t.useVertexAlpha||t.material)&&k.Warn("You have used an option other than points with the instance option. Please be aware that these other options will be ignored."),r.updateMeshPositions(e,!1),r}const a=new Gl(e,i,null,void 0,void 0,void 0,t.useVertexAlpha,t.material);return Hl(t).applyToMesh(a,t.updatable),a._creationDataStorage=new or,a._creationDataStorage.dashSize=o,a._creationDataStorage.gapSize=n,a}(e,{points:t,dashSize:i,gapSize:s,dashNb:r,updatable:o,instance:a},n);class jl extends E{constructor(e,t){super(e.x,e.y),this.index=t}}class Kl{constructor(){this.elements=[]}add(e){const t=[];return e.forEach((e=>{const i=new jl(e,this.elements.length);t.push(i),this.elements.push(i)})),t}computeBounds(){const e=new E(this.elements[0].x,this.elements[0].y),t=new E(this.elements[0].x,this.elements[0].y);return this.elements.forEach((i=>{i.x<e.x?e.x=i.x:i.x>t.x&&(t.x=i.x),i.y<e.y?e.y=i.y:i.y>t.y&&(t.y=i.y)})),{min:e,max:t,width:t.x-e.x,height:t.y-e.y}}}class $l{_addToepoint(e){for(const t of e)this._epoints.push(t.x,t.y)}constructor(e,t,i,s=earcut){let r;this._points=new Kl,this._outlinepoints=new Kl,this._holes=new Array,this._epoints=new Array,this._eholes=new Array,this.bjsEarcut=s,this._name=e,this._scene=i||x.LastCreatedScene,r=t instanceof Zi?t.getPoints():t,this._addToepoint(r),this._points.add(r),this._outlinepoints.add(r),void 0===this.bjsEarcut&&k.Warn("Earcut was not found, the polygon will not be built.")}addHole(e){this._points.add(e);const t=new Kl;return t.add(e),this._holes.push(t),this._eholes.push(this._epoints.length/2),this._addToepoint(e),this}build(e=!1,t=0,i=2){const s=new ur(this._name,this._scene),r=this.buildVertexData(t,i);return s.setVerticesData(hi.PositionKind,r.positions,e),s.setVerticesData(hi.NormalKind,r.normals,e),s.setVerticesData(hi.UVKind,r.uvs,e),s.setIndices(r.indices),s}buildVertexData(e=0,t=2){const i=new As,s=[],r=[],n=[],o=this._points.computeBounds();this._points.elements.forEach((e=>{s.push(0,1,0),r.push(e.x,0,e.y),n.push((e.x-o.min.x)/o.width,(e.y-o.min.y)/o.height)}));const a=[],l=this.bjsEarcut(this._epoints,this._eholes,2);for(let e=0;e<l.length;e++)a.push(l[e]);if(e>0){const i=r.length/3;this._points.elements.forEach((t=>{s.push(0,-1,0),r.push(t.x,-e,t.y),n.push(1-(t.x-o.min.x)/o.width,1-(t.y-o.min.y)/o.height)}));const l=a.length;for(let e=0;e<l;e+=3){const t=a[e+0],s=a[e+1],r=a[e+2];a.push(r+i),a.push(s+i),a.push(t+i)}this._addSide(r,s,n,a,o,this._outlinepoints,e,!1,t),this._holes.forEach((i=>{this._addSide(r,s,n,a,o,i,e,!0,t)}))}return i.indices=a,i.positions=r,i.normals=s,i.uvs=n,i}_addSide(e,t,i,s,r,n,o,a,l){let h=e.length/3,c=0;for(let d=0;d<n.elements.length;d++){const p=n.elements[d],_=n.elements[(d+1)%n.elements.length];e.push(p.x,0,p.y),e.push(p.x,-o,p.y),e.push(_.x,0,_.y),e.push(_.x,-o,_.y);const f=n.elements[(d+n.elements.length-1)%n.elements.length],m=n.elements[(d+2)%n.elements.length];let g=new S(-(_.y-p.y),0,_.x-p.x),v=new S(-(p.y-f.y),0,p.x-f.x),x=new S(-(m.y-_.y),0,m.x-_.x);a||(g=g.scale(-1),v=v.scale(-1),x=x.scale(-1));const T=g.normalizeToNew();let E=v.normalizeToNew(),b=x.normalizeToNew();const C=S.Dot(E,T);E=C>l?C<u-1?new S(p.x,0,p.y).subtract(new S(_.x,0,_.y)).normalize():v.add(g).normalize():T;const y=S.Dot(x,g);b=y>l?y<u-1?new S(_.x,0,_.y).subtract(new S(p.x,0,p.y)).normalize():x.add(g).normalize():T,i.push(c/r.width,0),i.push(c/r.width,1),c+=g.length(),i.push(c/r.width,0),i.push(c/r.width,1),t.push(E.x,E.y,E.z),t.push(E.x,E.y,E.z),t.push(b.x,b.y,b.z),t.push(b.x,b.y,b.z),a?(s.push(h),s.push(h+2),s.push(h+1),s.push(h+1),s.push(h+2),s.push(h+3)):(s.push(h),s.push(h+1),s.push(h+2),s.push(h+1),s.push(h+3),s.push(h+2)),h+=4}}}function ql(e,t,i,s,r,n,o){const a=i||new Array(3),l=s,h=[],c=o||!1;for(let e=0;e<3;e++)void 0===a[e]&&(a[e]=new b(0,0,1,1)),l&&void 0===l[e]&&(l[e]=new F(1,1,1,1));const u=e.getVerticesData(hi.PositionKind),d=e.getVerticesData(hi.NormalKind),p=e.getVerticesData(hi.UVKind),_=e.getIndices(),f=u.length/9;let m=0,g=0,v=0,x=0,T=0;const E=[0];if(c)for(let e=f;e<u.length/3;e+=4)g=u[3*(e+2)]-u[3*e],v=u[3*(e+2)+2]-u[3*e+2],x=Math.sqrt(g*g+v*v),T+=x,E.push(T);let S=0,C=0;for(let e=0;e<d.length;e+=3)Math.abs(d[e+1])<.001&&(C=1),Math.abs(d[e+1]-1)<.001&&(C=0),Math.abs(d[e+1]+1)<.001&&(C=2),S=e/3,1===C?(m=S-f,p[2*S]=m%4<1.5?c?a[C].x+(a[C].z-a[C].x)*E[Math.floor(m/4)]/T:a[C].x:c?a[C].x+(a[C].z-a[C].x)*E[Math.floor(m/4)+1]/T:a[C].z,p[2*S+1]=m%2==0?Is.UseOpenGLOrientationForUV?1-a[C].w:a[C].w:Is.UseOpenGLOrientationForUV?1-a[C].y:a[C].y):(p[2*S]=(1-p[2*S])*a[C].x+p[2*S]*a[C].z,p[2*S+1]=(1-p[2*S+1])*a[C].y+p[2*S+1]*a[C].w,Is.UseOpenGLOrientationForUV&&(p[2*S+1]=1-p[2*S+1])),l&&h.push(l[C].r,l[C].g,l[C].b,l[C].a);As._ComputeSides(t,u,_,d,p,r,n);const y=new As;if(y.indices=_,y.positions=u,y.normals=d,y.uvs=p,l){const e=t===As.DOUBLESIDE?h.concat(h):h;y.colors=e}return y}function Ql(e,t,i=null,s=earcut){t.sideOrientation=ur._GetDefaultSideOrientation(t.sideOrientation);const r=t.shape,n=t.holes||[],o=t.depth||0,a=t.smoothingThreshold||2,l=[];let h=[];for(let e=0;e<r.length;e++)l[e]=new E(r[e].x,r[e].z);l[0].equalsWithEpsilon(l[l.length-1],1e-8)&&l.pop();const c=new $l(e,l,i||x.LastCreatedScene,s);for(let e=0;e<n.length;e++){h=[];for(let t=0;t<n[e].length;t++)h.push(new E(n[e][t].x,n[e][t].z));c.addHole(h)}const u=c.build(!1,o,a);return u._originalBuilderSideOrientation=t.sideOrientation,ql(u,t.sideOrientation,t.faceUV,t.faceColors,t.frontUVs,t.backUVs,t.wrap).applyToMesh(u,t.updatable),u}function Zl(e,t,i=null){const s=t.path,r=t.shape,n=t.scale||1,o=t.rotation||0,a=0===t.cap?0:t.cap||ur.NO_CAP,l=t.updatable,h=ur._GetDefaultSideOrientation(t.sideOrientation),c=t.instance||null,u=t.invertUV||!1,d=t.closeShape||!1;return eh(e,r,s,n,o,null,null,t.closePath||!1,d,a,!1,i,!!l,h,c,u,t.frontUVs||null,t.backUVs||null,t.firstNormal||null,!!t.adjustFrame)}function Jl(e,t,i=null){const s=t.path,r=t.shape,n=t.scaleFunction||(()=>1),o=t.rotationFunction||(()=>0),a=t.closePath||t.ribbonCloseArray||!1,l=t.closeShape||t.ribbonClosePath||!1,h=0===t.cap?0:t.cap||ur.NO_CAP,c=t.updatable,u=t.firstNormal||null,d=t.adjustFrame||!1;return eh(e,r,s,null,null,n,o,a,l,h,!0,i,!!c,ur._GetDefaultSideOrientation(t.sideOrientation),t.instance||null,t.invertUV||!1,t.frontUVs||null,t.backUVs||null,u,d)}function eh(e,t,i,s,r,n,o,a,l,h,c,u,d,p,_,f,m,g,v,x){const T=(e,t,i,s,r,n,o,a,l,h,c)=>{const u=i.getTangents(),d=i.getNormals(),p=i.getBinormals(),_=i.getDistances();if(c)for(let e=0;e<u.length;e++)if(0==u[e].x&&0==u[e].y&&0==u[e].z&&u[e].copyFrom(u[e-1]),0==d[e].x&&0==d[e].y&&0==d[e].z&&d[e].copyFrom(d[e-1]),0==p[e].x&&0==p[e].y&&0==p[e].z&&p[e].copyFrom(p[e-1]),e>0){let t=u[e-1];S.Dot(t,u[e])<0&&u[e].scaleInPlace(-1),t=d[e-1],S.Dot(t,d[e])<0&&d[e].scaleInPlace(-1),t=p[e-1],S.Dot(t,p[e])<0&&p[e].scaleInPlace(-1)}let f=0;const m=h&&a?a:()=>null!==n?n:0,g=h&&o?o:()=>null!==r?r:1;let v=l===ur.NO_CAP||l===ur.CAP_END?0:2;const x=R.Matrix[0];for(let i=0;i<t.length;i++){const r=[],n=m(i,_[i]),o=g(i,_[i]);y.RotationAxisToRef(u[i],f,x);for(let s=0;s<e.length;s++){const n=u[i].scale(e[s].z).add(d[i].scale(e[s].x)).add(p[i].scale(e[s].y)),a=S.Zero();S.TransformCoordinatesToRef(n,x,a),a.scaleInPlace(o).addInPlace(t[i]),r[s]=a}s[v]=r,f+=n,v++}const T=e=>{const t=Array(),i=S.Zero();let s;for(s=0;s<e.length;s++)i.addInPlace(e[s]);for(i.scaleInPlace(1/e.length),s=0;s<e.length;s++)t.push(i);return t};switch(l){case ur.NO_CAP:break;case ur.CAP_START:s[0]=T(s[2]),s[1]=s[2];break;case ur.CAP_END:s[v]=s[v-1],s[v+1]=T(s[v-1]);break;case ur.CAP_ALL:s[0]=T(s[2]),s[1]=s[2],s[v]=s[v-1],s[v+1]=T(s[v-1])}return s};let E,b;if(_){const e=_._creationDataStorage;return E=v?e.path3D.update(i,v):e.path3D.update(i),b=T(t,i,e.path3D,e.pathArray,s,r,n,o,e.cap,c,x),Fl("",{pathArray:b,closeArray:!1,closePath:!1,offset:0,updatable:!1,sideOrientation:0,instance:_},u||void 0)}E=v?new Ji(i,v):new Ji(i),b=T(t,i,E,new Array,s,r,n,o,h=h<0||h>3?0:h,c,x);const C=Fl(e,{pathArray:b,closeArray:a,closePath:l,updatable:d,sideOrientation:p,invertUV:f,frontUVs:m||void 0,backUVs:g||void 0},u);return C._creationDataStorage.pathArray=b,C._creationDataStorage.path3D=E,C._creationDataStorage.cap=h,C}function th(e){const t=[];t[0]={vertex:[[0,0,1.732051],[1.632993,0,-.5773503],[-.8164966,1.414214,-.5773503],[-.8164966,-1.414214,-.5773503]],face:[[0,1,2],[0,2,3],[0,3,1],[1,3,2]]},t[1]={vertex:[[0,0,1.414214],[1.414214,0,0],[0,1.414214,0],[-1.414214,0,0],[0,-1.414214,0],[0,0,-1.414214]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]]},t[2]={vertex:[[0,0,1.070466],[.7136442,0,.7978784],[-.3568221,.618034,.7978784],[-.3568221,-.618034,.7978784],[.7978784,.618034,.3568221],[.7978784,-.618034,.3568221],[-.9341724,.381966,.3568221],[.1362939,1,.3568221],[.1362939,-1,.3568221],[-.9341724,-.381966,.3568221],[.9341724,.381966,-.3568221],[.9341724,-.381966,-.3568221],[-.7978784,.618034,-.3568221],[-.1362939,1,-.3568221],[-.1362939,-1,-.3568221],[-.7978784,-.618034,-.3568221],[.3568221,.618034,-.7978784],[.3568221,-.618034,-.7978784],[-.7136442,0,-.7978784],[0,0,-1.070466]],face:[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]]},t[3]={vertex:[[0,0,1.175571],[1.051462,0,.5257311],[.3249197,1,.5257311],[-.8506508,.618034,.5257311],[-.8506508,-.618034,.5257311],[.3249197,-1,.5257311],[.8506508,.618034,-.5257311],[.8506508,-.618034,-.5257311],[-.3249197,1,-.5257311],[-1.051462,0,-.5257311],[-.3249197,-1,-.5257311],[0,0,-1.175571]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]]},t[4]={vertex:[[0,0,1.070722],[.7148135,0,.7971752],[-.104682,.7071068,.7971752],[-.6841528,.2071068,.7971752],[-.104682,-.7071068,.7971752],[.6101315,.7071068,.5236279],[1.04156,.2071068,.1367736],[.6101315,-.7071068,.5236279],[-.3574067,1,.1367736],[-.7888348,-.5,.5236279],[-.9368776,.5,.1367736],[-.3574067,-1,.1367736],[.3574067,1,-.1367736],[.9368776,-.5,-.1367736],[.7888348,.5,-.5236279],[.3574067,-1,-.1367736],[-.6101315,.7071068,-.5236279],[-1.04156,-.2071068,-.1367736],[-.6101315,-.7071068,-.5236279],[.104682,.7071068,-.7971752],[.6841528,-.2071068,-.7971752],[.104682,-.7071068,-.7971752],[-.7148135,0,-.7971752],[0,0,-1.070722]],face:[[0,2,3],[1,6,5],[4,9,11],[7,15,13],[8,16,10],[12,14,19],[17,22,18],[20,21,23],[0,1,5,2],[0,3,9,4],[0,4,7,1],[1,7,13,6],[2,5,12,8],[2,8,10,3],[3,10,17,9],[4,11,15,7],[5,6,14,12],[6,13,20,14],[8,12,19,16],[9,17,18,11],[10,16,22,17],[11,18,21,15],[13,15,21,20],[14,20,23,19],[16,19,23,22],[18,22,23,21]]},t[5]={vertex:[[0,0,1.322876],[1.309307,0,.1889822],[-.9819805,.8660254,.1889822],[.1636634,-1.299038,.1889822],[.3273268,.8660254,-.9449112],[-.8183171,-.4330127,-.9449112]],face:[[0,3,1],[2,4,5],[0,1,4,2],[0,2,5,3],[1,3,5,4]]},t[6]={vertex:[[0,0,1.159953],[1.013464,0,.5642542],[-.3501431,.9510565,.5642542],[-.7715208,-.6571639,.5642542],[.6633206,.9510565,-.03144481],[.8682979,-.6571639,-.3996071],[-1.121664,.2938926,-.03144481],[-.2348831,-1.063314,-.3996071],[.5181548,.2938926,-.9953061],[-.5850262,-.112257,-.9953061]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,9,7],[5,7,9,8],[0,3,7,5,1],[2,4,8,9,6]]},t[7]={vertex:[[0,0,1.118034],[.8944272,0,.6708204],[-.2236068,.8660254,.6708204],[-.7826238,-.4330127,.6708204],[.6708204,.8660254,.2236068],[1.006231,-.4330127,-.2236068],[-1.006231,.4330127,.2236068],[-.6708204,-.8660254,-.2236068],[.7826238,.4330127,-.6708204],[.2236068,-.8660254,-.6708204],[-.8944272,0,-.6708204],[0,0,-1.118034]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,10,7],[5,9,11,8],[7,10,11,9],[0,3,7,9,5,1],[2,4,8,11,10,6]]},t[8]={vertex:[[-.729665,.670121,.319155],[-.655235,-.29213,-.754096],[-.093922,-.607123,.537818],[.702196,.595691,.485187],[.776626,-.36656,-.588064]],face:[[1,4,2],[0,1,2],[3,0,2],[4,3,2],[4,1,0,3]]},t[9]={vertex:[[-.868849,-.100041,.61257],[-.329458,.976099,.28078],[-.26629,-.013796,-.477654],[-.13392,-1.034115,.229829],[.738834,.707117,-.307018],[.859683,-.535264,-.338508]],face:[[3,0,2],[5,3,2],[4,5,2],[1,4,2],[0,1,2],[0,3,5,4,1]]},t[10]={vertex:[[-.610389,.243975,.531213],[-.187812,-.48795,-.664016],[-.187812,.9759,-.664016],[.187812,-.9759,.664016],[.798201,.243975,.132803]],face:[[1,3,0],[3,4,0],[3,1,4],[0,2,1],[0,4,2],[2,4,1]]},t[11]={vertex:[[-1.028778,.392027,-.048786],[-.640503,-.646161,.621837],[-.125162,-.395663,-.540059],[.004683,.888447,-.651988],[.125161,.395663,.540059],[.632925,-.791376,.433102],[1.031672,.157063,-.354165]],face:[[3,2,0],[2,1,0],[2,5,1],[0,4,3],[0,1,4],[4,1,5],[2,3,6],[3,4,6],[5,2,6],[4,5,6]]},t[12]={vertex:[[-.669867,.334933,-.529576],[-.669867,.334933,.529577],[-.4043,1.212901,0],[-.334933,-.669867,-.529576],[-.334933,-.669867,.529577],[.334933,.669867,-.529576],[.334933,.669867,.529577],[.4043,-1.212901,0],[.669867,-.334933,-.529576],[.669867,-.334933,.529577]],face:[[8,9,7],[6,5,2],[3,8,7],[5,0,2],[4,3,7],[0,1,2],[9,4,7],[1,6,2],[9,8,5,6],[8,3,0,5],[3,4,1,0],[4,9,6,1]]},t[13]={vertex:[[-.931836,.219976,-.264632],[-.636706,.318353,.692816],[-.613483,-.735083,-.264632],[-.326545,.979634,0],[-.318353,-.636706,.692816],[-.159176,.477529,-.856368],[.159176,-.477529,-.856368],[.318353,.636706,.692816],[.326545,-.979634,0],[.613482,.735082,-.264632],[.636706,-.318353,.692816],[.931835,-.219977,-.264632]],face:[[11,10,8],[7,9,3],[6,11,8],[9,5,3],[2,6,8],[5,0,3],[4,2,8],[0,1,3],[10,4,8],[1,7,3],[10,11,9,7],[11,6,5,9],[6,2,0,5],[2,4,1,0],[4,10,7,1]]},t[14]={vertex:[[-.93465,.300459,-.271185],[-.838689,-.260219,-.516017],[-.711319,.717591,.128359],[-.710334,-.156922,.080946],[-.599799,.556003,-.725148],[-.503838,-.004675,-.969981],[-.487004,.26021,.48049],[-.460089,-.750282,-.512622],[-.376468,.973135,-.325605],[-.331735,-.646985,.084342],[-.254001,.831847,.530001],[-.125239,-.494738,-.966586],[.029622,.027949,.730817],[.056536,-.982543,-.262295],[.08085,1.087391,.076037],[.125583,-.532729,.485984],[.262625,.599586,.780328],[.391387,-.726999,-.716259],[.513854,-.868287,.139347],[.597475,.85513,.326364],[.641224,.109523,.783723],[.737185,-.451155,.538891],[.848705,-.612742,-.314616],[.976075,.365067,.32976],[1.072036,-.19561,.084927]],face:[[15,18,21],[12,20,16],[6,10,2],[3,0,1],[9,7,13],[2,8,4,0],[0,4,5,1],[1,5,11,7],[7,11,17,13],[13,17,22,18],[18,22,24,21],[21,24,23,20],[20,23,19,16],[16,19,14,10],[10,14,8,2],[15,9,13,18],[12,15,21,20],[6,12,16,10],[3,6,2,0],[9,3,1,7],[9,15,12,6,3],[22,17,11,5,4,8,14,19,23,24]]};const i=e.type&&(e.type<0||e.type>=t.length)?0:e.type||0,s=e.size,r=e.sizeX||s||1,n=e.sizeY||s||1,o=e.sizeZ||s||1,a=e.custom||t[i],l=a.face.length,h=e.faceUV||new Array(l),c=e.faceColors,u=void 0===e.flat||e.flat,d=0===e.sideOrientation?0:e.sideOrientation||As.DEFAULTSIDE,p=[],_=[],f=[],m=[],g=[];let v=0,x=0;const T=[];let E,S,C,y,A,R,I=0,P=0;if(u)for(P=0;P<l;P++)c&&void 0===c[P]&&(c[P]=new F(1,1,1,1)),h&&void 0===h[P]&&(h[P]=new b(0,0,1,1));if(u)for(P=0;P<l;P++){const e=a.face[P].length;for(C=2*Math.PI/e,y=.5*Math.tan(C/2),A=.5,I=0;I<e;I++)p.push(a.vertex[a.face[P][I]][0]*r,a.vertex[a.face[P][I]][1]*n,a.vertex[a.face[P][I]][2]*o),T.push(v),v++,E=h[P].x+(h[P].z-h[P].x)*(.5+y),S=h[P].y+(h[P].w-h[P].y)*(A-.5),m.push(E,Is.UseOpenGLOrientationForUV?1-S:S),R=y*Math.cos(C)-A*Math.sin(C),A=y*Math.sin(C)+A*Math.cos(C),y=R,c&&g.push(c[P].r,c[P].g,c[P].b,c[P].a);for(I=0;I<e-2;I++)_.push(T[0+x],T[I+2+x],T[I+1+x]);x+=e}else{for(I=0;I<a.vertex.length;I++)p.push(a.vertex[I][0]*r,a.vertex[I][1]*n,a.vertex[I][2]*o),m.push(0,Is.UseOpenGLOrientationForUV?1:0);for(P=0;P<l;P++)for(I=0;I<a.face[P].length-2;I++)_.push(a.face[P][0],a.face[P][I+2],a.face[P][I+1])}As.ComputeNormals(p,_,f),As._ComputeSides(d,p,_,f,m,e.frontUVs,e.backUVs);const M=new As;return M.positions=p,M.indices=_,M.normals=f,M.uvs=m,c&&u&&(M.colors=g),M}As.CreatePolygon=ql,ur.CreatePolygon=(e,t,i,s,r,n,o=earcut)=>Ql(e,{shape:t,holes:s,updatable:r,sideOrientation:n},i,o),ur.ExtrudePolygon=(e,t,i,s,r,n,o,a=earcut)=>function(e,t,i=null,s=earcut){return Ql(e,t,i,s)}(e,{shape:t,holes:r,depth:i,updatable:n,sideOrientation:o},s,a),ur.ExtrudeShape=(e,t,i,s,r,n,o=null,a,l,h)=>Zl(e,{shape:t,path:i,scale:s,rotation:r,cap:0===n?0:n||ur.NO_CAP,sideOrientation:l,instance:h,updatable:a},o),ur.ExtrudeShapeCustom=(e,t,i,s,r,n,o,a,l,h,c,u)=>Jl(e,{shape:t,path:i,scaleFunction:s,rotationFunction:r,ribbonCloseArray:n,ribbonClosePath:o,cap:0===a?0:a||ur.NO_CAP,sideOrientation:c,instance:u,updatable:h},l),ur.CreateLathe=(e,t,i,s,r,n,o)=>function(e,t,i=null){const s=t.arc?t.arc<=0||t.arc>1?1:t.arc:1,r=void 0===t.closed||t.closed,n=t.shape,o=t.radius||1,a=t.tessellation||64,l=t.clip||0,h=t.updatable,c=ur._GetDefaultSideOrientation(t.sideOrientation),u=t.cap||ur.NO_CAP,d=2*Math.PI,p=[],_=t.invertUV||!1;let f=0,m=0;const g=d/a*s;let v,x;for(f=0;f<=a-l;f++){for(x=[],u!=ur.CAP_START&&u!=ur.CAP_ALL||(x.push(new S(0,n[0].y,0)),x.push(new S(Math.cos(f*g)*n[0].x*o,n[0].y,Math.sin(f*g)*n[0].x*o))),m=0;m<n.length;m++)v=new S(Math.cos(f*g)*n[m].x*o,n[m].y,Math.sin(f*g)*n[m].x*o),x.push(v);u!=ur.CAP_END&&u!=ur.CAP_ALL||(x.push(new S(Math.cos(f*g)*n[n.length-1].x*o,n[n.length-1].y,Math.sin(f*g)*n[n.length-1].x*o)),x.push(new S(0,n[n.length-1].y,0))),p.push(x)}return Fl(e,{pathArray:p,closeArray:r,sideOrientation:c,updatable:h,invertUV:_,frontUVs:t.frontUVs,backUVs:t.backUVs},i)}(e,{shape:t,radius:i,tessellation:s,sideOrientation:o,updatable:n},r),ur.CreateTube=(e,t,i,s,r,n,o,a,l,h)=>function(e,t,i=null){const s=t.path;let r=t.instance,n=1;void 0!==t.radius?n=t.radius:r&&(n=r._creationDataStorage.radius);const o=t.tessellation||64,a=t.radiusFunction||null;let l=t.cap||ur.NO_CAP;const h=t.invertUV||!1,c=t.updatable,u=ur._GetDefaultSideOrientation(t.sideOrientation);t.arc=t.arc&&(t.arc<=0||t.arc>1)?1:t.arc||1;const d=(e,t,i,s,r,n,o,a)=>{const l=t.getTangents(),h=t.getNormals(),c=t.getDistances(),u=2*Math.PI/r*a,d=n||(()=>s);let p,_,f,m;const g=R.Matrix[0];let v=o===ur.NO_CAP||o===ur.CAP_END?0:2;for(let t=0;t<e.length;t++){_=d(t,c[t]),p=Array(),f=h[t];for(let i=0;i<r;i++)y.RotationAxisToRef(l[t],u*i,g),m=p[i]?p[i]:S.Zero(),S.TransformCoordinatesToRef(f,g,m),m.scaleInPlace(_).addInPlace(e[t]),p[i]=m;i[v]=p,v++}const x=(t,i)=>{const s=Array();for(let r=0;r<t;r++)s.push(e[i]);return s};switch(o){case ur.NO_CAP:break;case ur.CAP_START:i[0]=x(r,0),i[1]=i[2].slice(0);break;case ur.CAP_END:i[v]=i[v-1].slice(0),i[v+1]=x(r,e.length-1);break;case ur.CAP_ALL:i[0]=x(r,0),i[1]=i[2].slice(0),i[v]=i[v-1].slice(0),i[v+1]=x(r,e.length-1)}return i};let p,_;if(r){const e=r._creationDataStorage,i=t.arc||e.arc;return p=e.path3D.update(s),_=d(s,p,e.pathArray,n,e.tessellation,a,e.cap,i),r=Fl("",{pathArray:_,instance:r}),e.path3D=p,e.pathArray=_,e.arc=i,e.radius=n,r}p=new Ji(s),l=l<0||l>3?0:l,_=d(s,p,new Array,n,o,a,l,t.arc);const f=Fl(e,{pathArray:_,closePath:!0,closeArray:!1,updatable:c,sideOrientation:u,invertUV:h,frontUVs:t.frontUVs,backUVs:t.backUVs},i);return f._creationDataStorage.pathArray=_,f._creationDataStorage.path3D=p,f._creationDataStorage.tessellation=o,f._creationDataStorage.cap=l,f._creationDataStorage.arc=t.arc,f._creationDataStorage.radius=n,f}(e,{path:t,radius:i,tessellation:s,radiusFunction:r,arc:1,cap:n,updatable:a,sideOrientation:l,instance:h},o),As.CreatePolyhedron=th,ur.CreatePolyhedron=(e,t,i)=>function(e,t={},i=null){const s=new ur(e,i);return t.sideOrientation=ur._GetDefaultSideOrientation(t.sideOrientation),s._originalBuilderSideOrientation=t.sideOrientation,th(t).applyToMesh(s,t.updatable),s}(e,t,i);const ih=new S(1,0,0),sh=new S(-1,0,0),rh=new S(0,1,0),nh=new S(0,-1,0),oh=new S(0,0,1),ah=new S(0,0,-1);class lh{constructor(e=S.Zero(),t=S.Up(),i=E.Zero(),s=0,r=0,n=null,o=null,a=null,l=null){this.position=e,this.normal=t,this.uv=i,this.vertexIdx=s,this.vertexIdxForBones=r,this.localPositionOverride=n,this.localNormalOverride=o,this.matrixIndicesOverride=a,this.matrixWeightsOverride=l}clone(){var e,t,i,s;return new lh(this.position.clone(),this.normal.clone(),this.uv.clone(),this.vertexIdx,this.vertexIdxForBones,null===(e=this.localPositionOverride)||void 0===e?void 0:e.slice(),null===(t=this.localNormalOverride)||void 0===t?void 0:t.slice(),null===(i=this.matrixIndicesOverride)||void 0===i?void 0:i.slice(),null===(s=this.matrixWeightsOverride)||void 0===s?void 0:s.slice())}}ur.CreateDecal=(e,t,i,s,r,n)=>function(e,t,i){var s,r,n,o;const a=!!t.skeleton,h=i.localMode||a,c=null!==t.overrideMaterialSideOrientation&&void 0!==t.overrideMaterialSideOrientation,u=t.getIndices(),d=a?t.getPositionData(!0,!0):t.getVerticesData(hi.PositionKind),p=a?t.getNormalsData(!0,!0):t.getVerticesData(hi.NormalKind),_=h?a?t.getVerticesData(hi.PositionKind):d:null,f=h?a?t.getVerticesData(hi.NormalKind):p:null,m=t.getVerticesData(hi.UVKind),g=a?t.getVerticesData(hi.MatricesIndicesKind):null,v=a?t.getVerticesData(hi.MatricesWeightsKind):null,x=a?t.getVerticesData(hi.MatricesIndicesExtraKind):null,T=a?t.getVerticesData(hi.MatricesWeightsExtraKind):null,b=i.position||S.Zero();let C=i.normal||S.Up();const A=i.size||S.One(),I=i.angle||0;if(!C){const e=new S(0,0,1),i=t.getScene().activeCamera,s=S.TransformCoordinates(e,i.getWorldMatrix());C=i.globalPosition.subtract(s)}const P=-Math.atan2(C.z,C.x)-Math.PI/2,M=Math.sqrt(C.x*C.x+C.z*C.z),O=Math.atan2(C.y,M),D=new As;D.indices=[],D.positions=[],D.normals=[],D.uvs=[],D.matricesIndices=a?[]:null,D.matricesWeights=a?[]:null,D.matricesIndicesExtra=x?[]:null,D.matricesWeightsExtra=T?[]:null;let N=0;const F=(e,t)=>{const s=new lh;if(!u||!d||!p)return s;const r=u[e];if(s.vertexIdx=3*r,s.vertexIdxForBones=4*r,s.position=new S(d[3*r],d[3*r+1],d[3*r+2]),S.TransformCoordinatesToRef(s.position,t,s.position),s.normal=new S(p[3*r],p[3*r+1],p[3*r+2]),S.TransformNormalToRef(s.normal,t,s.normal),i.captureUVS&&m){const e=m[2*r+1];s.uv=new E(m[2*r],Is.UseOpenGLOrientationForUV?1-e:e)}return s},w=[0,0,0,0],L=(e,t)=>{if(0===e.length)return e;const i=.5*Math.abs(S.Dot(A,t)),s=(e,t,i,s)=>{for(let r=0;r<s;++r)if(e[i+r]===t)return i+r;return-1},r=(e,r)=>{var n,o,a,h,c,u,d,p,m,x,T,b,C,y,A,R;const I=S.GetClipFactor(e.position,r.position,t,i);let P=w,M=w;if(g&&v){const t=e.matrixIndicesOverride?0:e.vertexIdxForBones,i=null!==(n=e.matrixIndicesOverride)&&void 0!==n?n:g,c=null!==(o=e.matrixWeightsOverride)&&void 0!==o?o:v,u=r.matrixIndicesOverride?0:r.vertexIdxForBones,d=null!==(a=r.matrixIndicesOverride)&&void 0!==a?a:g,p=null!==(h=r.matrixWeightsOverride)&&void 0!==h?h:v;P=[0,0,0,0],M=[0,0,0,0];let _=0;for(let e=0;e<4;++e)if(c[t+e]>0){const r=s(d,i[t+e],u,4);P[_]=i[t+e],M[_]=l.Lerp(c[t+e],r>=0?p[r]:0,I),_++}for(let e=0;e<4&&_<4;++e){const r=d[u+e];-1===s(i,r,t,4)&&(P[_]=r,M[_]=l.Lerp(0,p[u+e],I),_++)}const f=M[0]+M[1]+M[2]+M[3];M[0]/=f,M[1]/=f,M[2]/=f,M[3]/=f}const O=e.localPositionOverride?e.localPositionOverride[0]:null!==(c=null==_?void 0:_[e.vertexIdx])&&void 0!==c?c:0,D=e.localPositionOverride?e.localPositionOverride[1]:null!==(u=null==_?void 0:_[e.vertexIdx+1])&&void 0!==u?u:0,N=e.localPositionOverride?e.localPositionOverride[2]:null!==(d=null==_?void 0:_[e.vertexIdx+2])&&void 0!==d?d:0,F=r.localPositionOverride?r.localPositionOverride[0]:null!==(p=null==_?void 0:_[r.vertexIdx])&&void 0!==p?p:0,L=r.localPositionOverride?r.localPositionOverride[1]:null!==(m=null==_?void 0:_[r.vertexIdx+1])&&void 0!==m?m:0,B=r.localPositionOverride?r.localPositionOverride[2]:null!==(x=null==_?void 0:_[r.vertexIdx+2])&&void 0!==x?x:0,U=e.localNormalOverride?e.localNormalOverride[0]:null!==(T=null==f?void 0:f[e.vertexIdx])&&void 0!==T?T:0,V=e.localNormalOverride?e.localNormalOverride[1]:null!==(b=null==f?void 0:f[e.vertexIdx+1])&&void 0!==b?b:0,k=e.localNormalOverride?e.localNormalOverride[2]:null!==(C=null==f?void 0:f[e.vertexIdx+2])&&void 0!==C?C:0,G=U+((r.localNormalOverride?r.localNormalOverride[0]:null!==(y=null==f?void 0:f[r.vertexIdx])&&void 0!==y?y:0)-U)*I,z=V+((r.localNormalOverride?r.localNormalOverride[1]:null!==(A=null==f?void 0:f[r.vertexIdx+1])&&void 0!==A?A:0)-V)*I,W=k+((r.localNormalOverride?r.localNormalOverride[2]:null!==(R=null==f?void 0:f[r.vertexIdx+2])&&void 0!==R?R:0)-k)*I,H=Math.sqrt(G*G+z*z+W*W);return new lh(S.Lerp(e.position,r.position,I),S.Lerp(e.normal,r.normal,I).normalize(),E.Lerp(e.uv,r.uv,I),-1,-1,_?[O+(F-O)*I,D+(L-D)*I,N+(B-N)*I]:null,f?[G/H,z/H,W/H]:null,P,M)};let n=null;e.length>3&&(n=[]);for(let s=0;s<e.length;s+=3){let o=0,a=null,l=null,h=null,c=null;const u=S.Dot(e[s].position,t)-i>0,d=S.Dot(e[s+1].position,t)-i>0,p=S.Dot(e[s+2].position,t)-i>0;switch(o=(u?1:0)+(d?1:0)+(p?1:0),o){case 0:e.length>3?(n.push(e[s]),n.push(e[s+1]),n.push(e[s+2])):n=e;break;case 1:if(n=null!=n?n:new Array,u&&(a=e[s+1],l=e[s+2],h=r(e[s],a),c=r(e[s],l)),d){a=e[s],l=e[s+2],h=r(e[s+1],a),c=r(e[s+1],l),n.push(h),n.push(l.clone()),n.push(a.clone()),n.push(l.clone()),n.push(h.clone()),n.push(c);break}p&&(a=e[s],l=e[s+1],h=r(e[s+2],a),c=r(e[s+2],l)),a&&l&&h&&c&&(n.push(a.clone()),n.push(l.clone()),n.push(h),n.push(c),n.push(h.clone()),n.push(l.clone()));break;case 2:n=null!=n?n:new Array,u||(a=e[s].clone(),l=r(a,e[s+1]),h=r(a,e[s+2]),n.push(a),n.push(l),n.push(h)),d||(a=e[s+1].clone(),l=r(a,e[s+2]),h=r(a,e[s]),n.push(a),n.push(l),n.push(h)),p||(a=e[s+2].clone(),l=r(a,e[s]),h=r(a,e[s+1]),n.push(a),n.push(l),n.push(h))}}return n},B=t instanceof ur?t:null,U=null==B?void 0:B._thinInstanceDataStorage.matrixData,V=(null==B?void 0:B.thinInstanceCount)||1,k=R.Matrix[0];k.copyFrom(y.IdentityReadOnly);for(let e=0;e<V;++e){if((null==B?void 0:B.hasThinInstances)&&U){const t=16*e;k.setRowFromFloats(0,U[t+0],U[t+1],U[t+2],U[t+3]),k.setRowFromFloats(1,U[t+4],U[t+5],U[t+6],U[t+7]),k.setRowFromFloats(2,U[t+8],U[t+9],U[t+10],U[t+11]),k.setRowFromFloats(3,U[t+12],U[t+13],U[t+14],U[t+15])}const s=y.RotationYawPitchRoll(P,O,I).multiply(y.Translation(b.x,b.y,b.z)),r=y.Invert(s),n=t.getWorldMatrix(),o=k.multiply(n).multiply(r),a=new Array(3);for(let e=0;e<u.length;e+=3){let t=a;if(t[0]=F(e,o),c&&h?(t[1]=F(e+2,o),t[2]=F(e+1,o)):(t[1]=F(e+1,o),t[2]=F(e+2,o)),!(i.cullBackFaces&&-t[0].normal.z<=0&&-t[1].normal.z<=0&&-t[2].normal.z<=0)&&(t=L(t,ih),t&&(t=L(t,sh),t&&(t=L(t,rh),t&&(t=L(t,nh),t&&(t=L(t,oh),t&&(t=L(t,ah),t)))))))for(let e=0;e<t.length;e++){const s=t[e];if(D.indices.push(N),h?(s.localPositionOverride?(D.positions[3*N]=s.localPositionOverride[0],D.positions[3*N+1]=s.localPositionOverride[1],D.positions[3*N+2]=s.localPositionOverride[2]):_&&(D.positions[3*N]=_[s.vertexIdx],D.positions[3*N+1]=_[s.vertexIdx+1],D.positions[3*N+2]=_[s.vertexIdx+2]),s.localNormalOverride?(D.normals[3*N]=s.localNormalOverride[0],D.normals[3*N+1]=s.localNormalOverride[1],D.normals[3*N+2]=s.localNormalOverride[2]):f&&(D.normals[3*N]=f[s.vertexIdx],D.normals[3*N+1]=f[s.vertexIdx+1],D.normals[3*N+2]=f[s.vertexIdx+2])):(s.position.toArray(D.positions,3*N),s.normal.toArray(D.normals,3*N)),D.matricesIndices&&D.matricesWeights&&(s.matrixIndicesOverride?(D.matricesIndices[4*N]=s.matrixIndicesOverride[0],D.matricesIndices[4*N+1]=s.matrixIndicesOverride[1],D.matricesIndices[4*N+2]=s.matrixIndicesOverride[2],D.matricesIndices[4*N+3]=s.matrixIndicesOverride[3]):(g&&(D.matricesIndices[4*N]=g[s.vertexIdxForBones],D.matricesIndices[4*N+1]=g[s.vertexIdxForBones+1],D.matricesIndices[4*N+2]=g[s.vertexIdxForBones+2],D.matricesIndices[4*N+3]=g[s.vertexIdxForBones+3]),x&&D.matricesIndicesExtra&&(D.matricesIndicesExtra[4*N]=x[s.vertexIdxForBones],D.matricesIndicesExtra[4*N+1]=x[s.vertexIdxForBones+1],D.matricesIndicesExtra[4*N+2]=x[s.vertexIdxForBones+2],D.matricesIndicesExtra[4*N+3]=x[s.vertexIdxForBones+3])),s.matrixWeightsOverride?(D.matricesWeights[4*N]=s.matrixWeightsOverride[0],D.matricesWeights[4*N+1]=s.matrixWeightsOverride[1],D.matricesWeights[4*N+2]=s.matrixWeightsOverride[2],D.matricesWeights[4*N+3]=s.matrixWeightsOverride[3]):(v&&(D.matricesWeights[4*N]=v[s.vertexIdxForBones],D.matricesWeights[4*N+1]=v[s.vertexIdxForBones+1],D.matricesWeights[4*N+2]=v[s.vertexIdxForBones+2],D.matricesWeights[4*N+3]=v[s.vertexIdxForBones+3]),T&&D.matricesWeightsExtra&&(D.matricesWeightsExtra[4*N]=T[s.vertexIdxForBones],D.matricesWeightsExtra[4*N+1]=T[s.vertexIdxForBones+1],D.matricesWeightsExtra[4*N+2]=T[s.vertexIdxForBones+2],D.matricesWeightsExtra[4*N+3]=T[s.vertexIdxForBones+3]))),i.captureUVS)s.uv.toArray(D.uvs,2*N);else{D.uvs.push(.5+s.position.x/A.x);const e=.5+s.position.y/A.y;D.uvs.push(Is.UseOpenGLOrientationForUV?1-e:e)}N++}}}0===D.indices.length&&(D.indices=null),0===D.positions.length&&(D.positions=null),0===D.normals.length&&(D.normals=null),0===D.uvs.length&&(D.uvs=null),0===(null===(s=D.matricesIndices)||void 0===s?void 0:s.length)&&(D.matricesIndices=null),0===(null===(r=D.matricesWeights)||void 0===r?void 0:r.length)&&(D.matricesWeights=null),0===(null===(n=D.matricesIndicesExtra)||void 0===n?void 0:n.length)&&(D.matricesIndicesExtra=null),0===(null===(o=D.matricesWeightsExtra)||void 0===o?void 0:o.length)&&(D.matricesWeightsExtra=null);const G=new ur(e,t.getScene());return D.applyToMesh(G),h?(G.skeleton=t.skeleton,G.parent=t):(G.position=b.clone(),G.rotation=new S(O,P,I)),G.computeWorldMatrix(!0),G.refreshBoundingInfo(!0,!0),G}(e,t,{position:i,normal:s,size:r,angle:n}),ur._GoldbergMeshParser=(e,t)=>hh.Parse(e,t);class hh extends ur{constructor(){super(...arguments),this.goldbergData={faceColors:[],faceCenters:[],faceZaxis:[],faceXaxis:[],faceYaxis:[],nbSharedFaces:0,nbUnsharedFaces:0,nbFaces:0,nbFacesAtPole:0,adjacentFaces:[]}}relatedGoldbergFace(e,t){return void 0===t?(e>this.goldbergData.nbUnsharedFaces-1&&(k.Warn("Maximum number of unshared faces used"),e=this.goldbergData.nbUnsharedFaces-1),this.goldbergData.nbUnsharedFaces+e):(e>11&&(k.Warn("Last pole used"),e=11),t>this.goldbergData.nbFacesAtPole-1&&(k.Warn("Maximum number of faces at a pole used"),t=this.goldbergData.nbFacesAtPole-1),12+e*this.goldbergData.nbFacesAtPole+t)}_changeGoldbergFaceColors(e){for(let t=0;t<e.length;t++){const i=e[t][0],s=e[t][1],r=e[t][2];for(let e=i;e<s+1;e++)this.goldbergData.faceColors[e]=r}const t=[];for(let e=0;e<12;e++)for(let i=0;i<5;i++)t.push(this.goldbergData.faceColors[e].r,this.goldbergData.faceColors[e].g,this.goldbergData.faceColors[e].b,this.goldbergData.faceColors[e].a);for(let e=12;e<this.goldbergData.faceColors.length;e++)for(let i=0;i<6;i++)t.push(this.goldbergData.faceColors[e].r,this.goldbergData.faceColors[e].g,this.goldbergData.faceColors[e].b,this.goldbergData.faceColors[e].a);return t}setGoldbergFaceColors(e){const t=this._changeGoldbergFaceColors(e);this.setVerticesData(hi.ColorKind,t)}updateGoldbergFaceColors(e){const t=this._changeGoldbergFaceColors(e);this.updateVerticesData(hi.ColorKind,t)}_changeGoldbergFaceUVs(e){const t=this.getVerticesData(hi.UVKind);for(let i=0;i<e.length;i++){const s=e[i][0],r=e[i][1],n=e[i][2],o=e[i][3],a=e[i][4],l=[],h=[];let c,u;for(let e=0;e<5;e++)c=n.x+o*Math.cos(a+e*Math.PI/2.5),u=n.y+o*Math.sin(a+e*Math.PI/2.5),c<0&&(c=0),c>1&&(c=1),l.push(c,u);for(let e=0;e<6;e++)c=n.x+o*Math.cos(a+e*Math.PI/3),u=n.y+o*Math.sin(a+e*Math.PI/3),c<0&&(c=0),c>1&&(c=1),h.push(c,u);for(let e=s;e<Math.min(12,r+1);e++)for(let i=0;i<5;i++)t[10*e+2*i]=l[2*i],t[10*e+2*i+1]=l[2*i+1];for(let e=Math.max(12,s);e<r+1;e++)for(let i=0;i<6;i++)t[12*e-24+2*i]=h[2*i],t[12*e-23+2*i]=h[2*i+1]}return t}setGoldbergFaceUVs(e){const t=this._changeGoldbergFaceUVs(e);this.setVerticesData(hi.UVKind,t)}updateGoldbergFaceUVs(e){const t=this._changeGoldbergFaceUVs(e);this.updateVerticesData(hi.UVKind,t)}placeOnGoldbergFaceAt(e,t,i){const s=S.RotationFromAxis(this.goldbergData.faceXaxis[t],this.goldbergData.faceYaxis[t],this.goldbergData.faceZaxis[t]);e.rotation=s,e.position=this.goldbergData.faceCenters[t].add(this.goldbergData.faceXaxis[t].scale(i.x)).add(this.goldbergData.faceYaxis[t].scale(i.y)).add(this.goldbergData.faceZaxis[t].scale(i.z))}serialize(e){super.serialize(e),e.type="GoldbergMesh";const t={};if(t.adjacentFaces=this.goldbergData.adjacentFaces,t.nbSharedFaces=this.goldbergData.nbSharedFaces,t.nbUnsharedFaces=this.goldbergData.nbUnsharedFaces,t.nbFaces=this.goldbergData.nbFaces,t.nbFacesAtPole=this.goldbergData.nbFacesAtPole,this.goldbergData.faceColors){t.faceColors=[];for(const e of this.goldbergData.faceColors)t.faceColors.push(e.asArray())}if(this.goldbergData.faceCenters){t.faceCenters=[];for(const e of this.goldbergData.faceCenters)t.faceCenters.push(e.asArray())}if(this.goldbergData.faceZaxis){t.faceZaxis=[];for(const e of this.goldbergData.faceZaxis)t.faceZaxis.push(e.asArray())}if(this.goldbergData.faceYaxis){t.faceYaxis=[];for(const e of this.goldbergData.faceYaxis)t.faceYaxis.push(e.asArray())}if(this.goldbergData.faceXaxis){t.faceXaxis=[];for(const e of this.goldbergData.faceXaxis)t.faceXaxis.push(e.asArray())}e.goldbergData=t}static Parse(e,t){const i=e.goldbergData;i.faceColors=i.faceColors.map((e=>F.FromArray(e))),i.faceCenters=i.faceCenters.map((e=>S.FromArray(e))),i.faceZaxis=i.faceZaxis.map((e=>S.FromArray(e))),i.faceXaxis=i.faceXaxis.map((e=>S.FromArray(e))),i.faceYaxis=i.faceYaxis.map((e=>S.FromArray(e)));const s=new hh(e.name,t);return s.goldbergData=i,s}}class ch{constructor(e){this._paths=[],this._tempPaths=[],this._holes=[],this._resolution=e}moveTo(e,t){this._currentPath=new Zi(e,t),this._tempPaths.push(this._currentPath)}lineTo(e,t){this._currentPath.addLineTo(e,t)}quadraticCurveTo(e,t,i,s){this._currentPath.addQuadraticCurveTo(e,t,i,s,this._resolution)}bezierCurveTo(e,t,i,s,r,n){this._currentPath.addBezierCurveTo(e,t,i,s,r,n,this._resolution)}extractHoles(){for(const e of this._tempPaths)e.area()>0?this._holes.push(e):this._paths.push(e);if(!this._paths.length&&this._holes.length){const e=this._holes;this._holes=this._paths,this._paths=e}this._tempPaths.length=0}get paths(){return this._paths}get holes(){return this._holes}}function uh(e,t,i,s,r,n){const o=n.glyphs[e]||n.glyphs["?"];if(!o)return null;const a=new ch(r);if(o.o){const e=o.o.split(" ");for(let r=0,n=e.length;r<n;)switch(e[r++]){case"m":{const n=parseInt(e[r++])*t+i,o=parseInt(e[r++])*t+s;a.moveTo(n,o);break}case"l":{const n=parseInt(e[r++])*t+i,o=parseInt(e[r++])*t+s;a.lineTo(n,o);break}case"q":{const n=parseInt(e[r++])*t+i,o=parseInt(e[r++])*t+s,l=parseInt(e[r++])*t+i,h=parseInt(e[r++])*t+s;a.quadraticCurveTo(l,h,n,o);break}case"b":{const n=parseInt(e[r++])*t+i,o=parseInt(e[r++])*t+s,l=parseInt(e[r++])*t+i,h=parseInt(e[r++])*t+s,c=parseInt(e[r++])*t+i,u=parseInt(e[r++])*t+s;a.bezierCurveTo(l,h,c,u,n,o);break}}}return a.extractHoles(),{offsetX:o.ha*t,shapePath:a}}class dh{static CreateBoneWeightShader(e,t){var i,s,r,n,o,a;const l=e.skeleton,h=null!==(i=e.colorBase)&&void 0!==i?i:N.Black(),c=null!==(s=e.colorZero)&&void 0!==s?s:N.Blue(),u=null!==(r=e.colorQuarter)&&void 0!==r?r:N.Green(),d=null!==(n=e.colorHalf)&&void 0!==n?n:N.Yellow(),p=null!==(o=e.colorFull)&&void 0!==o?o:N.Red(),_=null!==(a=e.targetBoneIndex)&&void 0!==a?a:0;ot.ShadersStore["boneWeights:"+l.name+"VertexShader"]="precision highp float;\n\n        attribute vec3 position;\n        attribute vec2 uv;\n\n        uniform mat4 view;\n        uniform mat4 projection;\n        uniform mat4 worldViewProjection;\n\n        #include<bonesDeclaration>\n        #if NUM_BONE_INFLUENCERS == 0\n            attribute vec4 matricesIndices;\n            attribute vec4 matricesWeights;\n        #endif\n        #include<bakedVertexAnimationDeclaration>\n\n        #include<instancesDeclaration>\n\n        varying vec3 vColor;\n\n        uniform vec3 colorBase;\n        uniform vec3 colorZero;\n        uniform vec3 colorQuarter;\n        uniform vec3 colorHalf;\n        uniform vec3 colorFull;\n\n        uniform float targetBoneIndex;\n\n        void main() {\n            vec3 positionUpdated = position;\n\n            #include<instancesVertex>\n            #include<bonesVertex>\n            #include<bakedVertexAnimation>\n\n            vec4 worldPos = finalWorld * vec4(positionUpdated, 1.0);\n\n            vec3 color = colorBase;\n            float totalWeight = 0.;\n            if(matricesIndices[0] == targetBoneIndex && matricesWeights[0] > 0.){\n                totalWeight += matricesWeights[0];\n            }\n            if(matricesIndices[1] == targetBoneIndex && matricesWeights[1] > 0.){\n                totalWeight += matricesWeights[1];\n            }\n            if(matricesIndices[2] == targetBoneIndex && matricesWeights[2] > 0.){\n                totalWeight += matricesWeights[2];\n            }\n            if(matricesIndices[3] == targetBoneIndex && matricesWeights[3] > 0.){\n                totalWeight += matricesWeights[3];\n            }\n\n            color = mix(color, colorZero, smoothstep(0., 0.25, totalWeight));\n            color = mix(color, colorQuarter, smoothstep(0.25, 0.5, totalWeight));\n            color = mix(color, colorHalf, smoothstep(0.5, 0.75, totalWeight));\n            color = mix(color, colorFull, smoothstep(0.75, 1.0, totalWeight));\n            vColor = color;\n\n        gl_Position = projection * view * worldPos;\n        }",ot.ShadersStore["boneWeights:"+l.name+"FragmentShader"]="\n            precision highp float;\n            varying vec3 vPosition;\n\n            varying vec3 vColor;\n\n            void main() {\n                vec4 color = vec4(vColor, 1.0);\n                gl_FragColor = color;\n            }\n        ";const f=new kl("boneWeight:"+l.name,t,{vertex:"boneWeights:"+l.name,fragment:"boneWeights:"+l.name},{attributes:["position","normal","matricesIndices","matricesWeights"],uniforms:["world","worldView","worldViewProjection","view","projection","viewProjection","colorBase","colorZero","colorQuarter","colorHalf","colorFull","targetBoneIndex"]});return f.setColor3("colorBase",h),f.setColor3("colorZero",c),f.setColor3("colorQuarter",u),f.setColor3("colorHalf",d),f.setColor3("colorFull",p),f.setFloat("targetBoneIndex",_),f.getClassName=()=>"BoneWeightShader",f.transparencyMode=sr.MATERIAL_OPAQUE,f}static CreateSkeletonMapShader(e,t){var i;const s=e.skeleton,r=null!==(i=e.colorMap)&&void 0!==i?i:[{color:new N(1,.38,.18),location:0},{color:new N(.59,.18,1),location:.2},{color:new N(.59,1,.18),location:.4},{color:new N(1,.87,.17),location:.6},{color:new N(1,.17,.42),location:.8},{color:new N(.17,.68,1),location:1}],n=s.bones.length+1,o=dh._CreateBoneMapColorBuffer(n,r,t),a=new kl("boneWeights:"+s.name,t,{vertexSource:"precision highp float;\n\n            attribute vec3 position;\n            attribute vec2 uv;\n\n            uniform mat4 view;\n            uniform mat4 projection;\n            uniform mat4 worldViewProjection;\n            uniform float colorMap["+4*s.bones.length+"];\n\n            #include<bonesDeclaration>\n            #if NUM_BONE_INFLUENCERS == 0\n                attribute vec4 matricesIndices;\n                attribute vec4 matricesWeights;\n            #endif\n            #include<bakedVertexAnimationDeclaration>\n            #include<instancesDeclaration>\n\n            varying vec3 vColor;\n\n            void main() {\n                vec3 positionUpdated = position;\n\n                #include<instancesVertex>\n                #include<bonesVertex>\n                #include<bakedVertexAnimation>\n\n                vec3 color = vec3(0.);\n                bool first = true;\n\n                for (int i = 0; i < 4; i++) {\n                    int boneIdx = int(matricesIndices[i]);\n                    float boneWgt = matricesWeights[i];\n\n                    vec3 c = vec3(colorMap[boneIdx * 4 + 0], colorMap[boneIdx * 4 + 1], colorMap[boneIdx * 4 + 2]);\n\n                    if (boneWgt > 0.) {\n                        if (first) {\n                            first = false;\n                            color = c;\n                        } else {\n                            color = mix(color, c, boneWgt);\n                        }\n                    }\n                }\n\n                vColor = color;\n\n                vec4 worldPos = finalWorld * vec4(positionUpdated, 1.0);\n\n                gl_Position = projection * view * worldPos;\n            }",fragmentSource:"\n            precision highp float;\n            varying vec3 vColor;\n\n            void main() {\n                vec4 color = vec4( vColor, 1.0 );\n                gl_FragColor = color;\n            }\n            "},{attributes:["position","normal","matricesIndices","matricesWeights"],uniforms:["world","worldView","worldViewProjection","view","projection","viewProjection","colorMap"]});return a.setFloats("colorMap",o),a.getClassName=()=>"SkeletonMapShader",a.transparencyMode=sr.MATERIAL_OPAQUE,a}static _CreateBoneMapColorBuffer(e,t,i){const s=new ka("temp",{width:e,height:1},i,!1),r=s.getContext(),n=r.createLinearGradient(0,0,e,0);t.forEach((e=>{n.addColorStop(e.location,e.color.toHexString())})),r.fillStyle=n,r.fillRect(0,0,e,1),s.update();const o=[],a=r.getImageData(0,0,e,1).data,l=1/255;for(let e=0;e<a.length;e++)o.push(a[e]*l);return s.dispose(),o}get scene(){return this._scene}get utilityLayer(){return this._utilityLayer}get isReady(){return this._ready}set ready(e){this._ready=e}get debugMesh(){return this._debugMesh}set debugMesh(e){this._debugMesh=e}get displayMode(){return this.options.displayMode||dh.DISPLAY_LINES}set displayMode(e){e>dh.DISPLAY_SPHERE_AND_SPURS&&(e=dh.DISPLAY_LINES),this.options.displayMode=e}constructor(e,t,i,s=!0,r=3,n={}){var o,a,l,h,c,u,d,p,_,f,m,g,v,x;if(this.skeleton=e,this.mesh=t,this.autoUpdateBonesMatrices=s,this.renderingGroupId=r,this.options=n,this.color=N.White(),this._debugLines=new Array,this._localAxes=null,this._isEnabled=!0,this._obs=null,this._scene=i,this._ready=!1,n.pauseAnimations=null===(o=n.pauseAnimations)||void 0===o||o,n.returnToRest=null!==(a=n.returnToRest)&&void 0!==a&&a,n.displayMode=null!==(l=n.displayMode)&&void 0!==l?l:dh.DISPLAY_LINES,n.displayOptions=null!==(h=n.displayOptions)&&void 0!==h?h:{},n.displayOptions.midStep=null!==(c=n.displayOptions.midStep)&&void 0!==c?c:.235,n.displayOptions.midStepFactor=null!==(u=n.displayOptions.midStepFactor)&&void 0!==u?u:.155,n.displayOptions.sphereBaseSize=null!==(d=n.displayOptions.sphereBaseSize)&&void 0!==d?d:.15,n.displayOptions.sphereScaleUnit=null!==(p=n.displayOptions.sphereScaleUnit)&&void 0!==p?p:2,n.displayOptions.sphereFactor=null!==(_=n.displayOptions.sphereFactor)&&void 0!==_?_:.865,n.displayOptions.spurFollowsChild=null!==(f=n.displayOptions.spurFollowsChild)&&void 0!==f&&f,n.displayOptions.showLocalAxes=null!==(m=n.displayOptions.showLocalAxes)&&void 0!==m&&m,n.displayOptions.localAxesSize=null!==(g=n.displayOptions.localAxesSize)&&void 0!==g?g:.075,n.computeBonesUsingShaders=null===(v=n.computeBonesUsingShaders)||void 0===v||v,n.useAllBones=null===(x=n.useAllBones)||void 0===x||x,this._boneIndices=new Set,!n.useAllBones){const e=null==t?void 0:t.getVerticesData(hi.MatricesIndicesKind),i=null==t?void 0:t.getVerticesData(hi.MatricesWeightsKind);if(e&&i)for(let t=0;t<e.length;++t){const s=e[t];0!==i[t]&&this._boneIndices.add(s)}}this._utilityLayer=new yl(this._scene,!1),this._utilityLayer.pickUtilitySceneFirst=!1,this._utilityLayer.utilityLayerScene.autoClearDepthAndStencil=!0;let T=this.options.displayMode||0;T>dh.DISPLAY_SPHERE_AND_SPURS&&(T=dh.DISPLAY_LINES),this.displayMode=T,this.update(),this._bindObs()}_bindObs(){this.displayMode===dh.DISPLAY_LINES&&(this._obs=this.scene.onBeforeRenderObservable.add((()=>{this._displayLinesUpdate()})))}update(){switch(this.displayMode){case dh.DISPLAY_LINES:this._displayLinesUpdate();break;case dh.DISPLAY_SPHERES:this._buildSpheresAndSpurs(!0);break;case dh.DISPLAY_SPHERE_AND_SPURS:this._buildSpheresAndSpurs(!1)}this._buildLocalAxes()}set isEnabled(e){this.isEnabled!==e&&(this._isEnabled=e,this.debugMesh&&this.debugMesh.setEnabled(e),e&&!this._obs?this._bindObs():!e&&this._obs&&(this.scene.onBeforeRenderObservable.remove(this._obs),this._obs=null))}get isEnabled(){return this._isEnabled}_getBonePosition(e,t,i,s=0,r=0,n=0){const o=R.Matrix[0],a=t.getParent();if(o.copyFrom(t.getLocalMatrix()),0!==s||0!==r||0!==n){const e=R.Matrix[1];y.IdentityToRef(e),e.setTranslationFromFloats(s,r,n),e.multiplyToRef(o,o)}a&&o.multiplyToRef(a.getAbsoluteMatrix(),o),o.multiplyToRef(i,o),e.x=o.m[12],e.y=o.m[13],e.z=o.m[14]}_getLinesForBonesWithLength(e,t){const i=e.length;let s,r;t?(s=t.getWorldMatrix(),r=t.position):(s=new y,r=e[0].position);let n=0;for(let t=0;t<i;t++){const i=e[t];let o=this._debugLines[n];-1!==i._index&&(this._boneIndices.has(i.getIndex())||this.options.useAllBones)&&(o||(o=[S.Zero(),S.Zero()],this._debugLines[n]=o),this._getBonePosition(o[0],i,s),this._getBonePosition(o[1],i,s,0,i.length,0),o[0].subtractInPlace(r),o[1].subtractInPlace(r),n++)}}_getLinesForBonesNoLength(e){const t=e.length;let i=0;const s=this.mesh;let r,n;s?(r=s,n=s.position):(r=new ws(""),n=e[0].position);for(let s=t-1;s>=0;s--){const t=e[s],o=t.getParent();if(!o||!this._boneIndices.has(t.getIndex())&&!this.options.useAllBones)continue;let a=this._debugLines[i];a||(a=[S.Zero(),S.Zero()],this._debugLines[i]=a),t.getAbsolutePositionToRef(r,a[0]),o.getAbsolutePositionToRef(r,a[1]),a[0].subtractInPlace(n),a[1].subtractInPlace(n),i++}s||r.dispose()}_revert(e){this.options.pauseAnimations&&(this.scene.animationsEnabled=e,this.utilityLayer.utilityLayerScene.animationsEnabled=e)}_getAbsoluteBindPoseToRef(e,t){null!==e&&-1!==e._index?(this._getAbsoluteBindPoseToRef(e.getParent(),t),e.getBindMatrix().multiplyToRef(t,t)):t.copyFrom(y.Identity())}_buildSpheresAndSpurs(e=!0){var t,i;this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this._ready=!1;const s=null===(t=this.utilityLayer)||void 0===t?void 0:t.utilityLayerScene,r=this.skeleton.bones,n=[],o=[],a=this.scene.animationsEnabled;try{this.options.pauseAnimations&&(this.scene.animationsEnabled=!1,s.animationsEnabled=!1),this.options.returnToRest&&this.skeleton.returnToRest(),this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteMatrices();let t=Number.NEGATIVE_INFINITY;const l=this.options.displayOptions||{};for(let i=0;i<r.length;i++){const a=r[i];if(-1===a._index||!this._boneIndices.has(a.getIndex())&&!this.options.useAllBones)continue;const h=new y;this._getAbsoluteBindPoseToRef(a,h);const c=new S;h.decompose(void 0,void 0,c),a.children.forEach((i=>{const r=new y;i.getLocalMatrix().multiplyToRef(h,r);const n=new S;r.decompose(void 0,void 0,n);const u=S.Distance(c,n);if(u>t&&(t=u),e)return;const d=n.clone().subtract(c.clone()),p=d.length(),_=d.normalize().scale(p),f=l.midStep||.165,m=l.midStepFactor||.215,g=_.scale(f),v=Jl("skeletonViewer",{shape:[new S(1,-1,0),new S(1,1,0),new S(-1,1,0),new S(-1,-1,0),new S(1,-1,0)],path:[S.Zero(),g,_],scaleFunction:e=>{switch(e){case 0:case 2:return 0;case 1:return p*m}return 0},sideOrientation:ur.DEFAULTSIDE,updatable:!1},s),x=v.getTotalVertices(),T=[],E=[];for(let e=0;e<x;e++)T.push(1,0,0,0),l.spurFollowsChild&&e>9?E.push(i.getIndex(),0,0,0):E.push(a.getIndex(),0,0,0);v.position=c.clone(),v.setVerticesData(hi.MatricesWeightsKind,T,!1),v.setVerticesData(hi.MatricesIndicesKind,E,!1),v.convertToFlatShadedMesh(),o.push(v)}));const u=Ol("skeletonViewer",{segments:6,diameter:l.sphereBaseSize||.2,updatable:!0},s),d=u.getTotalVertices(),p=[],_=[];for(let e=0;e<d;e++)p.push(1,0,0,0),_.push(a.getIndex(),0,0,0);u.setVerticesData(hi.MatricesWeightsKind,p,!1),u.setVerticesData(hi.MatricesIndicesKind,_,!1),u.position=c.clone(),n.push([u,a])}const h=l.sphereScaleUnit||2,c=l.sphereFactor||.85,u=[];for(let e=0;e<n.length;e++){const[i,s]=n[e],r=1/(h/t);let o=0,a=s;for(;a.getParent()&&-1!==a.getParent().getIndex();)o++,a=a.getParent();i.scaling.scaleInPlace(r*Math.pow(c,o)),u.push(i)}this.debugMesh=ur.MergeMeshes(u.concat(o),!0,!0),this.debugMesh&&(this.debugMesh.renderingGroupId=this.renderingGroupId,this.debugMesh.skeleton=this.skeleton,this.debugMesh.parent=this.mesh,this.debugMesh.computeBonesUsingShaders=null===(i=this.options.computeBonesUsingShaders)||void 0===i||i,this.debugMesh.alwaysSelectAsActiveMesh=!0),this.utilityLayer._getSharedGizmoLight().intensity=.7,this._revert(a),this.ready=!0}catch(e){console.error(e),this._revert(a),this.dispose()}}_buildLocalAxes(){var e;this._localAxes&&this._localAxes.dispose(),this._localAxes=null;const t=this.options.displayOptions||{};if(!t.showLocalAxes)return;const i=this._utilityLayer.utilityLayerScene,s=t.localAxesSize||.075,r=[],n=[],o=new F(1,0,0,1),a=new F(0,1,0,1),l=new F(0,0,1,1),h=[],c=[];for(const e in this.skeleton.bones){const t=this.skeleton.bones[e];if(-1===t._index||!this._boneIndices.has(t.getIndex())&&!this.options.useAllBones)continue;const i=new y,u=new S;this._getAbsoluteBindPoseToRef(t,i),i.decompose(void 0,R.Quaternion[0],u);const d=new y;R.Quaternion[0].toRotationMatrix(d);const p=S.TransformCoordinates(new S(0+s,0,0),d),_=S.TransformCoordinates(new S(0,0+s,0),d),f=S.TransformCoordinates(new S(0,0,0+s),d),m=[[u,u.add(p)],[u,u.add(_)],[u,u.add(f)]],g=[[o,o],[a,a],[l,l]];r.push(...m),n.push(...g);for(let e=0;e<6;e++)h.push(1,0,0,0),c.push(t.getIndex(),0,0,0)}this._localAxes=Xl("localAxes",{lines:r,colors:n,updatable:!0},i),this._localAxes.setVerticesData(hi.MatricesWeightsKind,h,!1),this._localAxes.setVerticesData(hi.MatricesIndicesKind,c,!1),this._localAxes.skeleton=this.skeleton,this._localAxes.renderingGroupId=this.renderingGroupId+1,this._localAxes.parent=this.mesh,this._localAxes.computeBonesUsingShaders=null===(e=this.options.computeBonesUsingShaders)||void 0===e||e}_displayLinesUpdate(){if(!this._utilityLayer)return;this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteMatrices(),void 0===this.skeleton.bones[0].length?this._getLinesForBonesNoLength(this.skeleton.bones):this._getLinesForBonesWithLength(this.skeleton.bones,this.mesh);const e=this._utilityLayer.utilityLayerScene;e&&(this._debugMesh?Xl("",{lines:this._debugLines,updatable:!0,instance:this._debugMesh},e):(this._debugMesh=Xl("",{lines:this._debugLines,updatable:!0,instance:null},e),this._debugMesh.renderingGroupId=this.renderingGroupId),this.mesh?this._debugMesh.position.copyFrom(this.mesh.position):this._debugMesh.position.copyFrom(this.skeleton.bones[0].position),this._debugMesh.color=this.color)}changeDisplayMode(e){const t=!!this.isEnabled;this.displayMode!==e&&(this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this.displayMode=e,this.update(),this._bindObs(),this.isEnabled=t)}changeDisplayOptions(e,t){const i=!!this.isEnabled;this.options.displayOptions[e]=t,this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this.update(),this._bindObs(),this.isEnabled=i}dispose(){this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null),this._utilityLayer&&(this._utilityLayer.dispose(),this._utilityLayer=null),this.ready=!1}}dh.DISPLAY_LINES=0,dh.DISPLAY_SPHERES=1,dh.DISPLAY_SPHERE_AND_SPURS=2;class ph{}ph.ALPHA_DISABLE=0,ph.ALPHA_ADD=1,ph.ALPHA_COMBINE=2,ph.ALPHA_SUBTRACT=3,ph.ALPHA_MULTIPLY=4,ph.ALPHA_MAXIMIZED=5,ph.ALPHA_ONEONE=6,ph.ALPHA_PREMULTIPLIED=7,ph.ALPHA_PREMULTIPLIED_PORTERDUFF=8,ph.ALPHA_INTERPOLATE=9,ph.ALPHA_SCREENMODE=10,ph.ALPHA_ONEONE_ONEONE=11,ph.ALPHA_ALPHATOCOLOR=12,ph.ALPHA_REVERSEONEMINUS=13,ph.ALPHA_SRC_DSTONEMINUSSRCALPHA=14,ph.ALPHA_ONEONE_ONEZERO=15,ph.ALPHA_EXCLUSION=16,ph.ALPHA_LAYER_ACCUMULATE=17,ph.ALPHA_EQUATION_ADD=0,ph.ALPHA_EQUATION_SUBSTRACT=1,ph.ALPHA_EQUATION_REVERSE_SUBTRACT=2,ph.ALPHA_EQUATION_MAX=3,ph.ALPHA_EQUATION_MIN=4,ph.ALPHA_EQUATION_DARKEN=5,ph.DELAYLOADSTATE_NONE=0,ph.DELAYLOADSTATE_LOADED=1,ph.DELAYLOADSTATE_LOADING=2,ph.DELAYLOADSTATE_NOTLOADED=4,ph.NEVER=512,ph.ALWAYS=519,ph.LESS=513,ph.EQUAL=514,ph.LEQUAL=515,ph.GREATER=516,ph.GEQUAL=518,ph.NOTEQUAL=517,ph.KEEP=7680,ph.ZERO=0,ph.REPLACE=7681,ph.INCR=7682,ph.DECR=7683,ph.INVERT=5386,ph.INCR_WRAP=34055,ph.DECR_WRAP=34056,ph.TEXTURE_CLAMP_ADDRESSMODE=0,ph.TEXTURE_WRAP_ADDRESSMODE=1,ph.TEXTURE_MIRROR_ADDRESSMODE=2,ph.TEXTURE_CREATIONFLAG_STORAGE=1,ph.TEXTUREFORMAT_ALPHA=0,ph.TEXTUREFORMAT_LUMINANCE=1,ph.TEXTUREFORMAT_LUMINANCE_ALPHA=2,ph.TEXTUREFORMAT_RGB=4,ph.TEXTUREFORMAT_RGBA=5,ph.TEXTUREFORMAT_RED=6,ph.TEXTUREFORMAT_R=6,ph.TEXTUREFORMAT_RG=7,ph.TEXTUREFORMAT_RED_INTEGER=8,ph.TEXTUREFORMAT_R_INTEGER=8,ph.TEXTUREFORMAT_RG_INTEGER=9,ph.TEXTUREFORMAT_RGB_INTEGER=10,ph.TEXTUREFORMAT_RGBA_INTEGER=11,ph.TEXTUREFORMAT_BGRA=12,ph.TEXTUREFORMAT_DEPTH24_STENCIL8=13,ph.TEXTUREFORMAT_DEPTH32_FLOAT=14,ph.TEXTUREFORMAT_DEPTH16=15,ph.TEXTUREFORMAT_DEPTH24=16,ph.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8=17,ph.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8=18,ph.TEXTUREFORMAT_STENCIL8=19,ph.TEXTUREFORMAT_UNDEFINED=4294967295,ph.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492,ph.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_BPTC_UNORM=36493,ph.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495,ph.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494,ph.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779,ph.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919,ph.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778,ph.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918,ph.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777,ph.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1=33776,ph.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917,ph.TEXTUREFORMAT_COMPRESSED_SRGB_S3TC_DXT1_EXT=35916,ph.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4=37808,ph.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840,ph.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL=36196,ph.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2=37492,ph.TEXTUREFORMAT_COMPRESSED_SRGB8_ETC2=37493,ph.TEXTUREFORMAT_COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494,ph.TEXTUREFORMAT_COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495,ph.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC=37496,ph.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497,ph.TEXTURETYPE_UNSIGNED_BYTE=0,ph.TEXTURETYPE_UNSIGNED_INT=0,ph.TEXTURETYPE_FLOAT=1,ph.TEXTURETYPE_HALF_FLOAT=2,ph.TEXTURETYPE_BYTE=3,ph.TEXTURETYPE_SHORT=4,ph.TEXTURETYPE_UNSIGNED_SHORT=5,ph.TEXTURETYPE_INT=6,ph.TEXTURETYPE_UNSIGNED_INTEGER=7,ph.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,ph.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,ph.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,ph.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,ph.TEXTURETYPE_UNSIGNED_INT_24_8=12,ph.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,ph.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,ph.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,ph.TEXTURETYPE_UNDEFINED=16,ph.TEXTURE_2D=3553,ph.TEXTURE_2D_ARRAY=35866,ph.TEXTURE_CUBE_MAP=34067,ph.TEXTURE_CUBE_MAP_ARRAY=3735928559,ph.TEXTURE_3D=32879,ph.TEXTURE_NEAREST_SAMPLINGMODE=1,ph.TEXTURE_NEAREST_NEAREST=1,ph.TEXTURE_BILINEAR_SAMPLINGMODE=2,ph.TEXTURE_LINEAR_LINEAR=2,ph.TEXTURE_TRILINEAR_SAMPLINGMODE=3,ph.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,ph.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,ph.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,ph.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,ph.TEXTURE_NEAREST_LINEAR=7,ph.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,ph.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,ph.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,ph.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,ph.TEXTURE_LINEAR_NEAREST=12,ph.TEXTURE_EXPLICIT_MODE=0,ph.TEXTURE_SPHERICAL_MODE=1,ph.TEXTURE_PLANAR_MODE=2,ph.TEXTURE_CUBIC_MODE=3,ph.TEXTURE_PROJECTION_MODE=4,ph.TEXTURE_SKYBOX_MODE=5,ph.TEXTURE_INVCUBIC_MODE=6,ph.TEXTURE_EQUIRECTANGULAR_MODE=7,ph.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,ph.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,ph.TEXTURE_FILTERING_QUALITY_OFFLINE=4096,ph.TEXTURE_FILTERING_QUALITY_HIGH=64,ph.TEXTURE_FILTERING_QUALITY_MEDIUM=16,ph.TEXTURE_FILTERING_QUALITY_LOW=8,ph.SCALEMODE_FLOOR=1,ph.SCALEMODE_NEAREST=2,ph.SCALEMODE_CEILING=3,ph.MATERIAL_TextureDirtyFlag=1,ph.MATERIAL_LightDirtyFlag=2,ph.MATERIAL_FresnelDirtyFlag=4,ph.MATERIAL_AttributesDirtyFlag=8,ph.MATERIAL_MiscDirtyFlag=16,ph.MATERIAL_PrePassDirtyFlag=32,ph.MATERIAL_AllDirtyFlag=63,ph.MATERIAL_TriangleFillMode=0,ph.MATERIAL_WireFrameFillMode=1,ph.MATERIAL_PointFillMode=2,ph.MATERIAL_PointListDrawMode=3,ph.MATERIAL_LineListDrawMode=4,ph.MATERIAL_LineLoopDrawMode=5,ph.MATERIAL_LineStripDrawMode=6,ph.MATERIAL_TriangleStripDrawMode=7,ph.MATERIAL_TriangleFanDrawMode=8,ph.MATERIAL_ClockWiseSideOrientation=0,ph.MATERIAL_CounterClockWiseSideOrientation=1,ph.ACTION_NothingTrigger=0,ph.ACTION_OnPickTrigger=1,ph.ACTION_OnLeftPickTrigger=2,ph.ACTION_OnRightPickTrigger=3,ph.ACTION_OnCenterPickTrigger=4,ph.ACTION_OnPickDownTrigger=5,ph.ACTION_OnDoublePickTrigger=6,ph.ACTION_OnPickUpTrigger=7,ph.ACTION_OnPickOutTrigger=16,ph.ACTION_OnLongPressTrigger=8,ph.ACTION_OnPointerOverTrigger=9,ph.ACTION_OnPointerOutTrigger=10,ph.ACTION_OnEveryFrameTrigger=11,ph.ACTION_OnIntersectionEnterTrigger=12,ph.ACTION_OnIntersectionExitTrigger=13,ph.ACTION_OnKeyDownTrigger=14,ph.ACTION_OnKeyUpTrigger=15,ph.PARTICLES_BILLBOARDMODE_Y=2,ph.PARTICLES_BILLBOARDMODE_ALL=7,ph.PARTICLES_BILLBOARDMODE_STRETCHED=8,ph.PARTICLES_BILLBOARDMODE_STRETCHED_LOCAL=9,ph.MESHES_CULLINGSTRATEGY_STANDARD=0,ph.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,ph.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,ph.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,ph.SCENELOADER_NO_LOGGING=0,ph.SCENELOADER_MINIMAL_LOGGING=1,ph.SCENELOADER_SUMMARY_LOGGING=2,ph.SCENELOADER_DETAILED_LOGGING=3,ph.PREPASS_IRRADIANCE_TEXTURE_TYPE=0,ph.PREPASS_POSITION_TEXTURE_TYPE=1,ph.PREPASS_VELOCITY_TEXTURE_TYPE=2,ph.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3,ph.PREPASS_COLOR_TEXTURE_TYPE=4,ph.PREPASS_DEPTH_TEXTURE_TYPE=5,ph.PREPASS_NORMAL_TEXTURE_TYPE=6,ph.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE=7,ph.BUFFER_CREATIONFLAG_READ=1,ph.BUFFER_CREATIONFLAG_WRITE=2,ph.BUFFER_CREATIONFLAG_READWRITE=3,ph.BUFFER_CREATIONFLAG_UNIFORM=4,ph.BUFFER_CREATIONFLAG_VERTEX=8,ph.BUFFER_CREATIONFLAG_INDEX=16,ph.BUFFER_CREATIONFLAG_STORAGE=32,ph.RENDERPASS_MAIN=0,ph.INPUT_ALT_KEY=18,ph.INPUT_CTRL_KEY=17,ph.INPUT_META_KEY1=91,ph.INPUT_META_KEY2=92,ph.INPUT_META_KEY3=93,ph.INPUT_SHIFT_KEY=16,ph.SNAPSHOTRENDERING_STANDARD=0,ph.SNAPSHOTRENDERING_FAST=1,ph.PERSPECTIVE_CAMERA=0,ph.ORTHOGRAPHIC_CAMERA=1,ph.FOVMODE_VERTICAL_FIXED=0,ph.FOVMODE_HORIZONTAL_FIXED=1,ph.RIG_MODE_NONE=0,ph.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,ph.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,ph.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,ph.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,ph.RIG_MODE_STEREOSCOPIC_INTERLACED=14,ph.RIG_MODE_VR=20,ph.RIG_MODE_CUSTOM=22,ph.MAX_SUPPORTED_UV_SETS=6,ph.GL_ALPHA_EQUATION_ADD=32774,ph.GL_ALPHA_EQUATION_MIN=32775,ph.GL_ALPHA_EQUATION_MAX=32776,ph.GL_ALPHA_EQUATION_SUBTRACT=32778,ph.GL_ALPHA_EQUATION_REVERSE_SUBTRACT=32779,ph.GL_ALPHA_FUNCTION_SRC=768,ph.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR=769,ph.GL_ALPHA_FUNCTION_SRC_ALPHA=770,ph.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA=771,ph.GL_ALPHA_FUNCTION_DST_ALPHA=772,ph.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA=773,ph.GL_ALPHA_FUNCTION_DST_COLOR=774,ph.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR=775,ph.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED=776,ph.GL_ALPHA_FUNCTION_CONSTANT_COLOR=32769,ph.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR=32770,ph.GL_ALPHA_FUNCTION_CONSTANT_ALPHA=32771,ph.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA=32772,ph.SnippetUrl="https://snippet.babylonjs.com",bt.prototype._debugPushGroup=function(e,t){},bt.prototype._debugPopGroup=function(e){},bt.prototype._debugInsertMarker=function(e,t){},bt.prototype._debugFlushPendingCommands=function(){};class _h{constructor(){this._timeElapsedQueryEnded=!1}}class fh{constructor(){this.occlusionInternalRetryCounter=0,this.isOcclusionQueryInProgress=!1,this.isOccluded=!1,this.occlusionRetryCount=-1,this.occlusionType=Vs.OCCLUSION_TYPE_NONE,this.occlusionQueryAlgorithmType=Vs.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE,this.forceRenderingWhenOccluded=!1}}Ns.prototype.createQuery=function(){const e=this._gl.createQuery();if(!e)throw new Error("Unable to create Occlusion Query");return e},Ns.prototype.deleteQuery=function(e){return this._gl.deleteQuery(e),this},Ns.prototype.isQueryResultAvailable=function(e){return this._gl.getQueryParameter(e,this._gl.QUERY_RESULT_AVAILABLE)},Ns.prototype.getQueryResult=function(e){return this._gl.getQueryParameter(e,this._gl.QUERY_RESULT)},Ns.prototype.beginOcclusionQuery=function(e,t){const i=this._getGlAlgorithmType(e);return this._gl.beginQuery(i,t),!0},Ns.prototype.endOcclusionQuery=function(e){const t=this._getGlAlgorithmType(e);return this._gl.endQuery(t),this},Ns.prototype._createTimeQuery=function(){const e=this.getCaps().timerQuery;return e.createQueryEXT?e.createQueryEXT():this.createQuery()},Ns.prototype._deleteTimeQuery=function(e){const t=this.getCaps().timerQuery;t.deleteQueryEXT?t.deleteQueryEXT(e):this.deleteQuery(e)},Ns.prototype._getTimeQueryResult=function(e){const t=this.getCaps().timerQuery;return t.getQueryObjectEXT?t.getQueryObjectEXT(e,t.QUERY_RESULT_EXT):this.getQueryResult(e)},Ns.prototype._getTimeQueryAvailability=function(e){const t=this.getCaps().timerQuery;return t.getQueryObjectEXT?t.getQueryObjectEXT(e,t.QUERY_RESULT_AVAILABLE_EXT):this.isQueryResultAvailable(e)},Ns.prototype.startTimeQuery=function(){const e=this.getCaps(),t=e.timerQuery;if(!t)return null;const i=new _h;if(this._gl.getParameter(t.GPU_DISJOINT_EXT),e.canUseTimestampForTimerQuery)i._startTimeQuery=this._createTimeQuery(),t.queryCounterEXT(i._startTimeQuery,t.TIMESTAMP_EXT);else{if(this._currentNonTimestampToken)return this._currentNonTimestampToken;i._timeElapsedQuery=this._createTimeQuery(),t.beginQueryEXT?t.beginQueryEXT(t.TIME_ELAPSED_EXT,i._timeElapsedQuery):this._gl.beginQuery(t.TIME_ELAPSED_EXT,i._timeElapsedQuery),this._currentNonTimestampToken=i}return i},Ns.prototype.endTimeQuery=function(e){const t=this.getCaps(),i=t.timerQuery;if(!i||!e)return-1;if(t.canUseTimestampForTimerQuery){if(!e._startTimeQuery)return-1;e._endTimeQuery||(e._endTimeQuery=this._createTimeQuery(),i.queryCounterEXT(e._endTimeQuery,i.TIMESTAMP_EXT))}else if(!e._timeElapsedQueryEnded){if(!e._timeElapsedQuery)return-1;i.endQueryEXT?i.endQueryEXT(i.TIME_ELAPSED_EXT):(this._gl.endQuery(i.TIME_ELAPSED_EXT),this._currentNonTimestampToken=null),e._timeElapsedQueryEnded=!0}const s=this._gl.getParameter(i.GPU_DISJOINT_EXT);let r=!1;if(e._endTimeQuery?r=this._getTimeQueryAvailability(e._endTimeQuery):e._timeElapsedQuery&&(r=this._getTimeQueryAvailability(e._timeElapsedQuery)),r&&!s){let i=0;if(t.canUseTimestampForTimerQuery){if(!e._startTimeQuery||!e._endTimeQuery)return-1;const t=this._getTimeQueryResult(e._startTimeQuery);i=this._getTimeQueryResult(e._endTimeQuery)-t,this._deleteTimeQuery(e._startTimeQuery),this._deleteTimeQuery(e._endTimeQuery),e._startTimeQuery=null,e._endTimeQuery=null}else{if(!e._timeElapsedQuery)return-1;i=this._getTimeQueryResult(e._timeElapsedQuery),this._deleteTimeQuery(e._timeElapsedQuery),e._timeElapsedQuery=null,e._timeElapsedQueryEnded=!1}return i}return-1},Ns.prototype._captureGPUFrameTime=!1,Ns.prototype._gpuFrameTime=new Fi,Ns.prototype.getGPUFrameTimeCounter=function(){return this._gpuFrameTime},Ns.prototype.captureGPUFrameTime=function(e){e!==this._captureGPUFrameTime&&(this._captureGPUFrameTime=e,e?(this._onBeginFrameObserver=this.onBeginFrameObservable.add((()=>{this._gpuFrameTimeToken||(this._gpuFrameTimeToken=this.startTimeQuery())})),this._onEndFrameObserver=this.onEndFrameObservable.add((()=>{if(!this._gpuFrameTimeToken)return;const e=this.endTimeQuery(this._gpuFrameTimeToken);e>-1&&(this._gpuFrameTimeToken=null,this._gpuFrameTime.fetchNewFrame(),this._gpuFrameTime.addCount(e,!0))}))):(this.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null))},Ns.prototype._getGlAlgorithmType=function(e){return e===Vs.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this._gl.ANY_SAMPLES_PASSED_CONSERVATIVE:this._gl.ANY_SAMPLES_PASSED},Object.defineProperty(Vs.prototype,"isOcclusionQueryInProgress",{get:function(){return this._occlusionDataStorage.isOcclusionQueryInProgress},set:function(e){this._occlusionDataStorage.isOcclusionQueryInProgress=e},enumerable:!1,configurable:!0}),Object.defineProperty(Vs.prototype,"_occlusionDataStorage",{get:function(){return this.__occlusionDataStorage||(this.__occlusionDataStorage=new fh),this.__occlusionDataStorage},enumerable:!1,configurable:!0}),Object.defineProperty(Vs.prototype,"isOccluded",{get:function(){return this._occlusionDataStorage.isOccluded},set:function(e){this._occlusionDataStorage.isOccluded=e},enumerable:!0,configurable:!0}),Object.defineProperty(Vs.prototype,"occlusionQueryAlgorithmType",{get:function(){return this._occlusionDataStorage.occlusionQueryAlgorithmType},set:function(e){this._occlusionDataStorage.occlusionQueryAlgorithmType=e},enumerable:!0,configurable:!0}),Object.defineProperty(Vs.prototype,"occlusionType",{get:function(){return this._occlusionDataStorage.occlusionType},set:function(e){this._occlusionDataStorage.occlusionType=e},enumerable:!0,configurable:!0}),Object.defineProperty(Vs.prototype,"occlusionRetryCount",{get:function(){return this._occlusionDataStorage.occlusionRetryCount},set:function(e){this._occlusionDataStorage.occlusionRetryCount=e},enumerable:!0,configurable:!0}),Object.defineProperty(Vs.prototype,"forceRenderingWhenOccluded",{get:function(){return this._occlusionDataStorage.forceRenderingWhenOccluded},set:function(e){this._occlusionDataStorage.forceRenderingWhenOccluded=e},enumerable:!0,configurable:!0}),Vs.prototype._checkOcclusionQuery=function(){const e=this._occlusionDataStorage;if(e.occlusionType===Vs.OCCLUSION_TYPE_NONE)return e.isOccluded=!1,!1;const t=this.getEngine();if(!t.getCaps().supportOcclusionQuery)return e.isOccluded=!1,!1;if(!t.isQueryResultAvailable)return e.isOccluded=!1,!1;if(this.isOcclusionQueryInProgress&&null!==this._occlusionQuery&&void 0!==this._occlusionQuery)if(t.isQueryResultAvailable(this._occlusionQuery)){const i=t.getQueryResult(this._occlusionQuery);e.isOcclusionQueryInProgress=!1,e.occlusionInternalRetryCounter=0,e.isOccluded=!(i>0)}else{if(e.occlusionInternalRetryCounter++,!(-1!==e.occlusionRetryCount&&e.occlusionInternalRetryCounter>e.occlusionRetryCount))return e.occlusionType!==Vs.OCCLUSION_TYPE_OPTIMISTIC&&e.isOccluded;e.isOcclusionQueryInProgress=!1,e.occlusionInternalRetryCounter=0,e.isOccluded=e.occlusionType!==Vs.OCCLUSION_TYPE_OPTIMISTIC&&e.isOccluded}const i=this.getScene();if(i.getBoundingBoxRenderer){const s=i.getBoundingBoxRenderer();null===this._occlusionQuery&&(this._occlusionQuery=t.createQuery()),t.beginOcclusionQuery(e.occlusionQueryAlgorithmType,this._occlusionQuery)&&(s.renderOcclusionBoundingBox(this),t.endOcclusionQuery(e.occlusionQueryAlgorithmType),this._occlusionDataStorage.isOcclusionQueryInProgress=!0)}return e.isOccluded},Ns.prototype.createTransformFeedback=function(){const e=this._gl.createTransformFeedback();if(!e)throw new Error("Unable to create Transform Feedback");return e},Ns.prototype.deleteTransformFeedback=function(e){this._gl.deleteTransformFeedback(e)},Ns.prototype.bindTransformFeedback=function(e){this._gl.bindTransformFeedback(this._gl.TRANSFORM_FEEDBACK,e)},Ns.prototype.beginTransformFeedback=function(e=!0){this._gl.beginTransformFeedback(e?this._gl.POINTS:this._gl.TRIANGLES)},Ns.prototype.endTransformFeedback=function(){this._gl.endTransformFeedback()},Ns.prototype.setTranformFeedbackVaryings=function(e,t){this._gl.transformFeedbackVaryings(e,t,this._gl.INTERLEAVED_ATTRIBS)},Ns.prototype.bindTransformFeedbackBuffer=function(e){this._gl.bindBufferBase(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,e?e.underlyingResource:null)},bt.prototype.createExternalTexture=function(e){return null},bt.prototype.setExternalTexture=function(e,t){throw new Error("setExternalTexture: This engine does not support external textures!")},bt.prototype.updateVideoTexture=function(e,t,i){if(!e||e._isDisabled)return;const s=this._getInternalFormat(e.format),r=this._getRGBABufferInternalSizedFormat(0,e.format),n=this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0);this._unpackFlipY(!i);try{if(void 0===this._videoTextureSupported&&(this._gl.getError(),this._gl.texImage2D(this._gl.TEXTURE_2D,0,r,s,this._gl.UNSIGNED_BYTE,t),0!==this._gl.getError()?this._videoTextureSupported=!1:this._videoTextureSupported=!0),this._videoTextureSupported)this._gl.texImage2D(this._gl.TEXTURE_2D,0,r,s,this._gl.UNSIGNED_BYTE,t);else{if(!e._workingCanvas){e._workingCanvas=this.createCanvas(e.width,e.height);const t=e._workingCanvas.getContext("2d");if(!t)throw new Error("Unable to get 2d context");e._workingContext=t,e._workingCanvas.width=e.width,e._workingCanvas.height=e.height}e._workingContext.clearRect(0,0,e.width,e.height),e._workingContext.drawImage(t,0,0,t.videoWidth,t.videoHeight,0,0,e.width,e.height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,r,s,this._gl.UNSIGNED_BYTE,e._workingCanvas)}e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),n||this._bindTextureDirectly(this._gl.TEXTURE_2D,null),e.isReady=!0}catch(t){e._isDisabled=!0}},bt.prototype.restoreSingleAttachment=function(){const e=this._gl;this.bindAttachments([e.BACK])},bt.prototype.restoreSingleAttachmentForRenderTarget=function(){const e=this._gl;this.bindAttachments([e.COLOR_ATTACHMENT0])},bt.prototype.buildTextureLayout=function(e){const t=this._gl,i=[];for(let s=0;s<e.length;s++)e[s]?i.push(t["COLOR_ATTACHMENT"+s]):i.push(t.NONE);return i},bt.prototype.bindAttachments=function(e){this._gl.drawBuffers(e)},bt.prototype.unBindMultiColorAttachmentFramebuffer=function(e,t=!1,i){this._currentRenderTarget=null;const s=this._gl,r=e._attachments,n=r.length;if(e._MSAAFramebuffer){s.bindFramebuffer(s.READ_FRAMEBUFFER,e._MSAAFramebuffer),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,e._framebuffer);for(let t=0;t<n;t++){const i=e.textures[t];for(let e=0;e<n;e++)r[e]=s.NONE;r[t]=s[this.webGLVersion>1?"COLOR_ATTACHMENT"+t:"COLOR_ATTACHMENT"+t+"_WEBGL"],s.readBuffer(r[t]),s.drawBuffers(r),s.blitFramebuffer(0,0,i.width,i.height,0,0,i.width,i.height,s.COLOR_BUFFER_BIT,s.NEAREST)}for(let e=0;e<n;e++)r[e]=s[this.webGLVersion>1?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"];s.drawBuffers(r)}for(let i=0;i<n;i++){const r=e.textures[i];!(null==r?void 0:r.generateMipMaps)||t||r.isCube||(this._bindTextureDirectly(s.TEXTURE_2D,r,!0),s.generateMipmap(s.TEXTURE_2D),this._bindTextureDirectly(s.TEXTURE_2D,null))}i&&(e._MSAAFramebuffer&&this._bindUnboundFramebuffer(e._framebuffer),i()),this._bindUnboundFramebuffer(null)},bt.prototype.createMultipleRenderTarget=function(e,t,i=!0){var s;let r=!1,n=!0,o=!1,a=!1,l=15,h=1,c=[],u=[],d=[],p=[],_=[],f=[],m=[],g=[];const v=this._createHardwareRenderTargetWrapper(!0,!1,e);void 0!==t&&(r=void 0!==t.generateMipMaps&&t.generateMipMaps,n=void 0===t.generateDepthBuffer||t.generateDepthBuffer,o=void 0!==t.generateStencilBuffer&&t.generateStencilBuffer,a=void 0!==t.generateDepthTexture&&t.generateDepthTexture,h=t.textureCount||1,t.types&&(c=t.types),t.samplingModes&&(u=t.samplingModes),t.useSRGBBuffers&&(d=t.useSRGBBuffers),t.formats&&(p=t.formats),t.targetTypes&&(_=t.targetTypes),t.faceIndex&&(f=t.faceIndex),t.layerIndex&&(m=t.layerIndex),t.layerCounts&&(g=t.layerCounts),this.webGLVersion>1&&(13===t.depthTextureFormat||17===t.depthTextureFormat||16===t.depthTextureFormat||14===t.depthTextureFormat||18===t.depthTextureFormat)&&(l=t.depthTextureFormat));const x=this._gl,T=x.createFramebuffer();this._bindUnboundFramebuffer(T);const E=e.width||e,S=e.height||e,b=[],C=[],y=this.webGLVersion>1&&a&&(13===t.depthTextureFormat||17===t.depthTextureFormat||18===t.depthTextureFormat),A=this._setupFramebufferDepthAttachments(!y&&o,!a&&n,E,S);v._framebuffer=T,v._depthStencilBuffer=A,v._generateDepthBuffer=!a&&n,v._generateStencilBuffer=!y&&o,v._attachments=C;for(let e=0;e<h;e++){let t=u[e]||3,i=c[e]||0,n=d[e]||!1;const o=p[e]||5,a=_[e]||3553,l=null!==(s=g[e])&&void 0!==s?s:1;(1!==i||this._caps.textureFloatLinearFiltering)&&(2!==i||this._caps.textureHalfFloatLinearFiltering)||(t=1);const h=this._getSamplingParameters(t,r);1!==i||this._caps.textureFloat||(i=0,k.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),n=n&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU);const f=this.webGLVersion>1,m=x[f?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"];if(C.push(m),-1===a)continue;const v=new dt(this,ut.MultiRenderTarget);b[e]=v,x.activeTexture(x["TEXTURE"+e]),x.bindTexture(a,v._hardwareTexture.underlyingResource),x.texParameteri(a,x.TEXTURE_MAG_FILTER,h.mag),x.texParameteri(a,x.TEXTURE_MIN_FILTER,h.min),x.texParameteri(a,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(a,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE);const T=this._getRGBABufferInternalSizedFormat(i,o,n),y=this._getInternalFormat(o),A=this._getWebGLTextureType(i);if(!f||35866!==a&&32879!==a)if(34067===a){for(let e=0;e<6;e++)x.texImage2D(x.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,T,E,S,0,y,A,null);v.isCube=!0}else x.texImage2D(x.TEXTURE_2D,0,T,E,S,0,y,A,null);else 35866===a?v.is2DArray=!0:v.is3D=!0,v.baseDepth=v.depth=l,x.texImage3D(a,0,T,E,S,l,0,y,A,null);r&&x.generateMipmap(a),this._bindTextureDirectly(a,null),v.baseWidth=E,v.baseHeight=S,v.width=E,v.height=S,v.isReady=!0,v.samples=1,v.generateMipMaps=r,v.samplingMode=t,v.type=i,v._useSRGBBuffer=n,v.format=o,this._internalTexturesCache.push(v)}if(a&&this._caps.depthTextureExtension){const e=new dt(this,ut.Depth);let t=5,i=x.DEPTH_COMPONENT16,s=x.DEPTH_COMPONENT,n=x.UNSIGNED_SHORT,o=x.DEPTH_ATTACHMENT;this.webGLVersion<2?i=x.DEPTH_COMPONENT:14===l?(t=1,n=x.FLOAT,i=x.DEPTH_COMPONENT32F):18===l?(t=0,n=x.FLOAT_32_UNSIGNED_INT_24_8_REV,i=x.DEPTH32F_STENCIL8,s=x.DEPTH_STENCIL,o=x.DEPTH_STENCIL_ATTACHMENT):16===l?(t=0,n=x.UNSIGNED_INT,i=x.DEPTH_COMPONENT24,o=x.DEPTH_ATTACHMENT):13!==l&&17!==l||(t=12,n=x.UNSIGNED_INT_24_8,i=x.DEPTH24_STENCIL8,s=x.DEPTH_STENCIL,o=x.DEPTH_STENCIL_ATTACHMENT),x.activeTexture(x.TEXTURE0),x.bindTexture(x.TEXTURE_2D,e._hardwareTexture.underlyingResource),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE),x.texImage2D(x.TEXTURE_2D,0,i,E,S,0,s,n,null),x.framebufferTexture2D(x.FRAMEBUFFER,o,x.TEXTURE_2D,e._hardwareTexture.underlyingResource,0),e.baseWidth=E,e.baseHeight=S,e.width=E,e.height=S,e.isReady=!0,e.samples=1,e.generateMipMaps=r,e.samplingMode=1,e.format=l,e.type=t,b[h]=e,this._internalTexturesCache.push(e)}return v.setTextures(b),i&&x.drawBuffers(C),this._bindUnboundFramebuffer(null),v.setLayerAndFaceIndices(m,f),this.resetTextureCache(),v},bt.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,t,i=!0){if(this.webGLVersion<2||!e||!e.texture)return 1;if(e.samples===t)return t;const s=e._attachments.length;if(0===s)return 1;const r=this._gl;t=Math.min(t,this.getCaps().maxMSAASamples);const n=!!e._depthStencilBuffer;if(n&&(r.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=null),e._MSAAFramebuffer&&(r.deleteFramebuffer(e._MSAAFramebuffer),e._MSAAFramebuffer=null),t>1&&"function"==typeof r.renderbufferStorageMultisample){const n=r.createFramebuffer();if(!n)throw new Error("Unable to create multi sampled framebuffer");e._MSAAFramebuffer=n,this._bindUnboundFramebuffer(n);const o=[];for(let t=0;t<s;t++)e.textures[t]._hardwareTexture.releaseMSAARenderBuffers();for(let i=0;i<s;i++){const s=e.textures[i],n=s._hardwareTexture,a=r[this.webGLVersion>1?"COLOR_ATTACHMENT"+i:"COLOR_ATTACHMENT"+i+"_WEBGL"],l=this._createRenderBuffer(s.width,s.height,t,-1,this._getRGBABufferInternalSizedFormat(s.type,s.format,s._useSRGBBuffer),a);if(!l)throw new Error("Unable to create multi sampled framebuffer");n.addMSAARenderBuffer(l),s.samples=t,o.push(a)}i&&r.drawBuffers(o)}else this._bindUnboundFramebuffer(e._framebuffer);return n&&(e._depthStencilBuffer=this._setupFramebufferDepthAttachments(e._generateStencilBuffer,e._generateDepthBuffer,e.texture.width,e.texture.height,t)),this._bindUnboundFramebuffer(null),t},bt.prototype._createDepthStencilCubeTexture=function(e,t,i){const s=new dt(this,ut.DepthStencil);if(s.isCube=!0,1===this.webGLVersion)return k.Error("Depth cube texture is not supported by WebGL 1."),s;const r=Object.assign({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},t),n=this._gl;this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,s,!0),this._setupDepthStencilTexture(s,e,r.generateStencil,r.bilinearFiltering,r.comparisonFunction),i._depthStencilTexture=s,i._depthStencilTextureWithStencil=r.generateStencil;for(let t=0;t<6;t++)r.generateStencil?n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,n.DEPTH24_STENCIL8,e,e,0,n.DEPTH_STENCIL,n.UNSIGNED_INT_24_8,null):n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,n.DEPTH_COMPONENT24,e,e,0,n.DEPTH_COMPONENT,n.UNSIGNED_INT,null);return this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(s),s},bt.prototype._partialLoadFile=function(e,t,i,s,r=null){this._loadFile(e,(e=>{i[t]=e,i._internalCount++,6===i._internalCount&&s(i)}),void 0,void 0,!0,((e,t)=>{r&&e&&r(e.status+" "+e.statusText,t)}))},bt.prototype._cascadeLoadFiles=function(e,t,i,s=null){const r=[];r._internalCount=0;for(let e=0;e<6;e++)this._partialLoadFile(i[e],e,r,t,s)},bt.prototype._cascadeLoadImgs=function(e,t,i,s,r=null,n){const o=[];o._internalCount=0;for(let a=0;a<6;a++)this._partialLoadImg(s[a],a,o,e,t,i,r,n)},bt.prototype._partialLoadImg=function(e,t,i,s,r,n,o=null,a){const l=Wt();Dt(e,(e=>{i[t]=e,i._internalCount++,s&&s.removePendingData(l),6===i._internalCount&&n&&n(r,i)}),((e,t)=>{s&&s.removePendingData(l),o&&o(e,t)}),s?s.offlineProvider:null,a),s&&s.addPendingData(l)},bt.prototype._setCubeMapTextureParams=function(e,t,i){const s=this._gl;s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,t?s.LINEAR_MIPMAP_LINEAR:s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),e.samplingMode=t?3:2,t&&this.getCaps().textureMaxLevel&&void 0!==i&&i>0&&(s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAX_LEVEL,i),e._maxLodLevel=i),this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null)},bt.prototype.createCubeTextureBase=function(e,t,i,s,r=null,n=null,o,a=null,l=!1,h=0,c=0,u=null,d=null,p=null,_=!1){const f=u||new dt(this,ut.Cube);f.isCube=!0,f.url=e,f.generateMipMaps=!s,f._lodGenerationScale=h,f._lodGenerationOffset=c,f._useSRGBBuffer=!!_&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||!!s),f!==u&&(f.label=e.substring(0,60)),this._doNotHandleContextLost||(f._extension=a,f._files=i);const m=e;this._transformTextureUrl&&!u&&(e=this._transformTextureUrl(e));const g=e.split("?")[0],v=g.lastIndexOf("."),x=a||(v>-1?g.substring(v).toLowerCase():"");let T=null;for(const e of bt._TextureLoaders)if(e.canLoad(x)){T=e;break}const E=(u,g)=>{e===m?n&&u&&n(u.status+" "+u.statusText,g):(k.Warn(`Failed to load ${e}, falling back to the ${m}`),this.createCubeTextureBase(m,t,i,!!s,r,n,o,a,l,h,c,f,d,p,_))};if(T){const s=e=>{d&&d(f,e),T.loadCubeData(e,f,l,r,n)};i&&6===i.length?T.supportCascades?this._cascadeLoadFiles(t,(e=>s(e.map((e=>new Uint8Array(e))))),i,n):n?n("Textures type does not support cascades."):k.Warn("Texture loader does not support cascades."):this._loadFile(e,(e=>s(new Uint8Array(e))),void 0,void 0,!0,E)}else{if(!i)throw new Error("Cannot load cubemap because files were not defined");this._cascadeLoadImgs(t,f,((e,t)=>{p&&p(e,t)}),i,n)}return this._internalTexturesCache.push(f),f},bt.prototype.createCubeTexture=function(e,t,i,s,r=null,n=null,o,a=null,l=!1,h=0,c=0,u=null,d,p=!1){const _=this._gl;return this.createCubeTextureBase(e,t,i,!!s,r,n,o,a,l,h,c,u,(e=>this._bindTextureDirectly(_.TEXTURE_CUBE_MAP,e,!0)),((e,t)=>{const i=this.needPOTTextures?bt.GetExponentOfTwo(t[0].width,this._caps.maxCubemapTextureSize):t[0].width,n=i,a=[_.TEXTURE_CUBE_MAP_POSITIVE_X,_.TEXTURE_CUBE_MAP_POSITIVE_Y,_.TEXTURE_CUBE_MAP_POSITIVE_Z,_.TEXTURE_CUBE_MAP_NEGATIVE_X,_.TEXTURE_CUBE_MAP_NEGATIVE_Y,_.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(_.TEXTURE_CUBE_MAP,e,!0),this._unpackFlipY(!1);const l=o?this._getInternalFormat(o,e._useSRGBBuffer):e._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:_.RGBA;let h=o?this._getInternalFormat(o):_.RGBA;e._useSRGBBuffer&&1===this.webGLVersion&&(h=l);for(let e=0;e<a.length;e++)if(t[e].width!==i||t[e].height!==n){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext)return void k.Warn("Cannot create canvas to resize texture.");this._workingCanvas.width=i,this._workingCanvas.height=n,this._workingContext.drawImage(t[e],0,0,t[e].width,t[e].height,0,0,i,n),_.texImage2D(a[e],0,l,h,_.UNSIGNED_BYTE,this._workingCanvas)}else _.texImage2D(a[e],0,l,h,_.UNSIGNED_BYTE,t[e]);s||_.generateMipmap(_.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(e,!s),e.width=i,e.height=n,e.isReady=!0,o&&(e.format=o),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),r&&r()}),!!p)},bt.prototype.setTextureSampler=function(e,t){throw new Error("setTextureSampler: This engine does not support separate texture sampler objects!")};const mh=new a,gh=new a;function vh(e){if(this._excludedCompressedTextures&&this._excludedCompressedTextures.some((t=>{const i="\\b"+t+"\\b";return e&&(e===t||e.match(new RegExp(i,"g")))})))return e;const t=e.lastIndexOf("."),i=e.lastIndexOf("?"),s=i>-1?e.substring(i,e.length):"";return(t>-1?e.substring(0,t):e)+this._textureFormatInUse+s}Object.defineProperty(Ns.prototype,"onBeforeViewRenderObservable",{get:function(){return mh}}),Object.defineProperty(Ns.prototype,"onAfterViewRenderObservable",{get:function(){return gh}}),Object.defineProperty(Ns.prototype,"inputElement",{get:function(){return this._inputElement},set:function(e){var t;this._inputElement!==e&&(this._inputElement=e,null===(t=this._onEngineViewChanged)||void 0===t||t.call(this))}}),Ns.prototype.getInputElement=function(){return this.inputElement||this.getRenderingCanvas()},Ns.prototype.registerView=function(e,t,i){this.views||(this.views=[]);for(const t of this.views)if(t.target===e)return t;const s=this.getRenderingCanvas();s&&(e.width=s.width,e.height=s.height);const r={target:e,camera:t,clearBeforeCopy:i,enabled:!0,id:(1e5*Math.random()).toFixed()};return this.views.push(r),t&&!Array.isArray(t)&&t.onDisposeObservable.add((()=>{this.unRegisterView(e)})),r},Ns.prototype.unRegisterView=function(e){if(!this.views||0===this.views.length)return this;for(const t of this.views)if(t.target===e){const e=this.views.indexOf(t);-1!==e&&this.views.splice(e,1);break}return this},Ns.prototype._renderViewStep=function(e){const t=e.target,i=t.getContext("2d");if(!i)return!0;const s=this.getRenderingCanvas();mh.notifyObservers(e);const r=e.camera;let n=null,o=null,a=null;if(r&&(a=Array.isArray(r)?r[0].getScene():r.getScene(),n=a.activeCamera,o=a.activeCameras,this.activeView=e,Array.isArray(r)?a.activeCameras=r:(a.activeCamera=r,a.activeCameras=null)),e.customResize)e.customResize(t);else{const e=Math.floor(t.clientWidth/this._hardwareScalingLevel),i=Math.floor(t.clientHeight/this._hardwareScalingLevel),r=e!==t.width||s.width!==t.width||i!==t.height||s.height!==t.height;t.clientWidth&&t.clientHeight&&r&&(t.width=e,t.height=i,this.setSize(e,i))}return!(!s.width||!s.height||(this._renderFrame(),this.flushFramebuffer(),e.clearBeforeCopy&&i.clearRect(0,0,s.width,s.height),i.drawImage(s,0,0),a&&(a.activeCameras=o,a.activeCamera=n),gh.notifyObservers(e),0))},Ns.prototype._renderViews=function(){if(!this.views||0===this.views.length)return!1;if(!this.getRenderingCanvas())return!1;let e;for(const t of this.views)if(t.enabled)if(t.target!==this.inputElement){if(!this._renderViewStep(t))return!1}else e=t;return!(e&&!this._renderViewStep(e)||(this.activeView=null,0))},bt.prototype.createStorageBuffer=function(e,t){throw new Error("createStorageBuffer: Unsupported method in this engine!")},bt.prototype.updateStorageBuffer=function(e,t,i,s){},bt.prototype.readFromStorageBuffer=function(e,t,i,s){throw new Error("readFromStorageBuffer: Unsupported method in this engine!")},bt.prototype.setStorageBuffer=function(e,t){throw new Error("setStorageBuffer: Unsupported method in this engine!")},Object.defineProperty(Ns.prototype,"texturesSupported",{get:function(){const e=[];return this._caps.astc&&e.push("-astc.ktx"),this._caps.s3tc&&e.push("-dxt.ktx"),this._caps.pvrtc&&e.push("-pvrtc.ktx"),this._caps.etc2&&e.push("-etc2.ktx"),this._caps.etc1&&e.push("-etc1.ktx"),e},enumerable:!0,configurable:!0}),Object.defineProperty(Ns.prototype,"textureFormatInUse",{get:function(){return this._textureFormatInUse||null},enumerable:!0,configurable:!0}),Ns.prototype.setCompressedTextureExclusions=function(e){this._excludedCompressedTextures=e},Ns.prototype.setTextureFormatToUse=function(e){const t=this.texturesSupported;for(let i=0,s=t.length;i<s;i++)for(let s=0,r=e.length;s<r;s++)if(t[i]===e[s].toLowerCase())return this._transformTextureUrl=vh.bind(this),this._textureFormatInUse=t[i];return this._textureFormatInUse="",this._transformTextureUrl=null,null};class xh{constructor(){const e=new ArrayBuffer(xh.DEFAULT_BUFFER_SIZE);this._uint32s=new Uint32Array(e),this._int32s=new Int32Array(e),this._float32s=new Float32Array(e),this._length=xh.DEFAULT_BUFFER_SIZE/4,this._position=0,this._nativeDataStream=new _native.NativeDataStream((()=>{this._flush()}))}writeUint32(e){this._flushIfNecessary(1),this._uint32s[this._position++]=e}writeInt32(e){this._flushIfNecessary(1),this._int32s[this._position++]=e}writeFloat32(e){this._flushIfNecessary(1),this._float32s[this._position++]=e}writeUint32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._uint32s.set(e,this._position),this._position+=e.length}writeInt32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._int32s.set(e,this._position),this._position+=e.length}writeFloat32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._float32s.set(e,this._position),this._position+=e.length}writeNativeData(e){this._flushIfNecessary(e.length),this._uint32s.set(e,this._position),this._position+=e.length}writeBoolean(e){this.writeUint32(e?1:0)}_flushIfNecessary(e){this._position+e>this._length&&this._flush()}_flush(){this._nativeDataStream.writeBuffer(this._uint32s.buffer,this._position),this._position=0}}xh.DEFAULT_BUFFER_SIZE=65536;const Th=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],Eh=[()=>1,e=>e.y,e=>e.z,e=>e.x,e=>e.x*e.y,e=>e.y*e.z,e=>3*e.z*e.z-1,e=>e.x*e.z,e=>e.x*e.x-e.y*e.y],Sh=(e,t)=>Th[e]*Eh[e](t),bh=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class Ch{constructor(){this.preScaled=!1,this.l00=S.Zero(),this.l1_1=S.Zero(),this.l10=S.Zero(),this.l11=S.Zero(),this.l2_2=S.Zero(),this.l2_1=S.Zero(),this.l20=S.Zero(),this.l21=S.Zero(),this.l22=S.Zero()}addLight(e,t,i){R.Vector3[0].set(t.r,t.g,t.b);const s=R.Vector3[0],r=R.Vector3[1];s.scaleToRef(i,r),r.scaleToRef(Sh(0,e),R.Vector3[2]),this.l00.addInPlace(R.Vector3[2]),r.scaleToRef(Sh(1,e),R.Vector3[2]),this.l1_1.addInPlace(R.Vector3[2]),r.scaleToRef(Sh(2,e),R.Vector3[2]),this.l10.addInPlace(R.Vector3[2]),r.scaleToRef(Sh(3,e),R.Vector3[2]),this.l11.addInPlace(R.Vector3[2]),r.scaleToRef(Sh(4,e),R.Vector3[2]),this.l2_2.addInPlace(R.Vector3[2]),r.scaleToRef(Sh(5,e),R.Vector3[2]),this.l2_1.addInPlace(R.Vector3[2]),r.scaleToRef(Sh(6,e),R.Vector3[2]),this.l20.addInPlace(R.Vector3[2]),r.scaleToRef(Sh(7,e),R.Vector3[2]),this.l21.addInPlace(R.Vector3[2]),r.scaleToRef(Sh(8,e),R.Vector3[2]),this.l22.addInPlace(R.Vector3[2])}scaleInPlace(e){this.l00.scaleInPlace(e),this.l1_1.scaleInPlace(e),this.l10.scaleInPlace(e),this.l11.scaleInPlace(e),this.l2_2.scaleInPlace(e),this.l2_1.scaleInPlace(e),this.l20.scaleInPlace(e),this.l21.scaleInPlace(e),this.l22.scaleInPlace(e)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(bh[0]),this.l1_1.scaleInPlace(bh[1]),this.l10.scaleInPlace(bh[2]),this.l11.scaleInPlace(bh[3]),this.l2_2.scaleInPlace(bh[4]),this.l2_1.scaleInPlace(bh[5]),this.l20.scaleInPlace(bh[6]),this.l21.scaleInPlace(bh[7]),this.l22.scaleInPlace(bh[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(Th[0]),this.l1_1.scaleInPlace(Th[1]),this.l10.scaleInPlace(Th[2]),this.l11.scaleInPlace(Th[3]),this.l2_2.scaleInPlace(Th[4]),this.l2_1.scaleInPlace(Th[5]),this.l20.scaleInPlace(Th[6]),this.l21.scaleInPlace(Th[7]),this.l22.scaleInPlace(Th[8])}updateFromArray(e){return S.FromArrayToRef(e[0],0,this.l00),S.FromArrayToRef(e[1],0,this.l1_1),S.FromArrayToRef(e[2],0,this.l10),S.FromArrayToRef(e[3],0,this.l11),S.FromArrayToRef(e[4],0,this.l2_2),S.FromArrayToRef(e[5],0,this.l2_1),S.FromArrayToRef(e[6],0,this.l20),S.FromArrayToRef(e[7],0,this.l21),S.FromArrayToRef(e[8],0,this.l22),this}updateFromFloatsArray(e){return S.FromFloatsToRef(e[0],e[1],e[2],this.l00),S.FromFloatsToRef(e[3],e[4],e[5],this.l1_1),S.FromFloatsToRef(e[6],e[7],e[8],this.l10),S.FromFloatsToRef(e[9],e[10],e[11],this.l11),S.FromFloatsToRef(e[12],e[13],e[14],this.l2_2),S.FromFloatsToRef(e[15],e[16],e[17],this.l2_1),S.FromFloatsToRef(e[18],e[19],e[20],this.l20),S.FromFloatsToRef(e[21],e[22],e[23],this.l21),S.FromFloatsToRef(e[24],e[25],e[26],this.l22),this}static FromArray(e){return(new Ch).updateFromArray(e)}static FromPolynomial(e){const t=new Ch;return t.l00=e.xx.scale(.376127).add(e.yy.scale(.376127)).add(e.zz.scale(.376126)),t.l1_1=e.y.scale(.977204),t.l10=e.z.scale(.977204),t.l11=e.x.scale(.977204),t.l2_2=e.xy.scale(1.16538),t.l2_1=e.yz.scale(1.16538),t.l20=e.zz.scale(1.34567).subtract(e.xx.scale(.672834)).subtract(e.yy.scale(.672834)),t.l21=e.zx.scale(1.16538),t.l22=e.xx.scale(1.16538).subtract(e.yy.scale(1.16538)),t.l1_1.scaleInPlace(-1),t.l11.scaleInPlace(-1),t.l2_1.scaleInPlace(-1),t.l21.scaleInPlace(-1),t.scaleInPlace(Math.PI),t}}class yh{constructor(){this.x=S.Zero(),this.y=S.Zero(),this.z=S.Zero(),this.xx=S.Zero(),this.yy=S.Zero(),this.zz=S.Zero(),this.xy=S.Zero(),this.yz=S.Zero(),this.zx=S.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=Ch.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(e){R.Vector3[0].copyFromFloats(e.r,e.g,e.b);const t=R.Vector3[0];this.xx.addInPlace(t),this.yy.addInPlace(t),this.zz.addInPlace(t)}scaleInPlace(e){this.x.scaleInPlace(e),this.y.scaleInPlace(e),this.z.scaleInPlace(e),this.xx.scaleInPlace(e),this.yy.scaleInPlace(e),this.zz.scaleInPlace(e),this.yz.scaleInPlace(e),this.zx.scaleInPlace(e),this.xy.scaleInPlace(e)}updateFromHarmonics(e){return this._harmonics=e,this.x.copyFrom(e.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.copyFrom(e.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.copyFrom(e.l10),this.z.scaleInPlace(1.02333),this.xx.copyFrom(e.l00),R.Vector3[0].copyFrom(e.l20).scaleInPlace(.247708),R.Vector3[1].copyFrom(e.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).subtractInPlace(R.Vector3[0]).addInPlace(R.Vector3[1]),this.yy.copyFrom(e.l00),this.yy.scaleInPlace(.886277).subtractInPlace(R.Vector3[0]).subtractInPlace(R.Vector3[1]),this.zz.copyFrom(e.l00),R.Vector3[0].copyFrom(e.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(R.Vector3[0]),this.yz.copyFrom(e.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.copyFrom(e.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.copyFrom(e.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(e){return(new yh).updateFromHarmonics(e)}static FromArray(e){const t=new yh;return S.FromArrayToRef(e[0],0,t.x),S.FromArrayToRef(e[1],0,t.y),S.FromArrayToRef(e[2],0,t.z),S.FromArrayToRef(e[3],0,t.xx),S.FromArrayToRef(e[4],0,t.yy),S.FromArrayToRef(e[5],0,t.zz),S.FromArrayToRef(e[6],0,t.yz),S.FromArrayToRef(e[7],0,t.zx),S.FromArrayToRef(e[8],0,t.xy),t}}function Ah(e,t,i,s,r,n,o,a){const l=t.getEngine();return t.isReady=!1,r=null!=r?r:t.samplingMode,s=null!=s?s:t.type,n=null!=n?n:t.format,o=null!=o?o:t.width,a=null!=a?a:t.height,-1===s&&(s=0),new Promise((h=>{const c=new dn("postprocess",e,null,null,1,null,r,l,!1,void 0,s,void 0,null,!1,n);c.externalTextureSamplerBinding=!0;const u=l.createRenderTargetTexture({width:o,height:a},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:r,type:s,format:n});c.getEffect().executeWhenCompiled((()=>{c.onApply=e=>{e._bindTexture("textureSampler",t),e.setFloat2("scale",1,1)},i.postProcessManager.directRender([c],u,!0),l.restoreDefaultFramebuffer(),l._releaseTexture(t),c&&c.dispose(),u._swapAndDie(t),t.type=s,t.format=5,t.isReady=!0,h(t)}))}))}let Rh,Ih;function Ph(e){Rh||(Rh=new Float32Array(1),Ih=new Int32Array(Rh.buffer)),Rh[0]=e;const t=Ih[0];let i=t>>16&32768,s=t>>12&2047;const r=t>>23&255;return r<103?i:r>142?(i|=31744,i|=(255==r?0:1)&&8388607&t,i):r<113?(s|=2048,i|=(s>>114-r)+(s>>113-r&1),i):(i|=r-112<<10|s>>1,i+=1&s,i)}function Mh(e){const t=(32768&e)>>15,i=(31744&e)>>10,s=1023&e;return 0===i?(t?-1:1)*Math.pow(2,-14)*(s/Math.pow(2,10)):31==i?s?NaN:1/0*(t?-1:1):(t?-1:1)*Math.pow(2,i-15)*(1+s/Math.pow(2,10))}nt.ShadersStore.rgbdDecodePixelShader="varying vec2 vUV;uniform sampler2D textureSampler;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=vec4(fromRGBD(texture2D(textureSampler,vUV)),1.0);}";const Oh=async function(e,t,i,s=0,r=0){return!e.isReady()&&e._texture&&await new Promise(((t,i)=>{null!==e._texture?e._texture.onLoadedObservable.addOnce((()=>{t(0)})):i(0)})),await(async(e,t,i,s,r)=>{const n=e.getScene(),o=n.getEngine();let a;if(e.isCube){const e=["#define POSITIVEX","#define NEGATIVEX","#define POSITIVEY","#define NEGATIVEY","#define POSITIVEZ","#define NEGATIVEZ"];a=new dn("lodCube","lodCube",["lod","gamma"],null,1,null,Ar.NEAREST_NEAREST_MIPNEAREST,o,!1,e[s])}else a=new dn("lod","lod",["lod","gamma"],null,1,null,Ar.NEAREST_NEAREST_MIPNEAREST,o);await new Promise((e=>{a.getEffect().executeWhenCompiled((()=>{e(0)}))}));const l=new Bn("temp",{width:t,height:i},n,!1);a.onApply=function(t){t.setTexture("textureSampler",e),t.setFloat("lod",r),t.setBool("gamma",e.gammaSpace)};const h=e.getInternalTexture();try{if(l.renderTarget&&h){const s=h.samplingMode;0!==r?e.updateSamplingMode(Ar.NEAREST_NEAREST_MIPNEAREST):e.updateSamplingMode(Ar.NEAREST_NEAREST),n.postProcessManager.directRender([a],l.renderTarget,!0),e.updateSamplingMode(s);const c=await o.readPixels(0,0,t,i),u=new Uint8Array(c.buffer,0,c.byteLength);return o.unBindFramebuffer(l.renderTarget),u}throw Error("Render to texture failed.")}finally{l.dispose(),a.dispose()}})(e,t,i,s,r)};class Dh{static ExpandRGBDTexture(e){const t=e._texture;if(!t||!e.isRGBD)return;const i=t.getEngine(),s=i.getCaps(),r=t.isReady;let n=!1;s.textureHalfFloatRender&&s.textureHalfFloatLinearFiltering?(n=!0,t.type=2):s.textureFloatRender&&s.textureFloatLinearFiltering&&(n=!0,t.type=1),n&&(t.isReady=!1,t._isRGBD=!1,t.invertY=!1);const o=()=>{if(n){const s=new dn("rgbdDecode","rgbdDecode",null,null,1,null,3,i,!1,void 0,t.type,void 0,null,!1);s.externalTextureSamplerBinding=!0;const r=i.createRenderTargetTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:t.samplingMode,type:t.type,format:5});s.getEffect().executeWhenCompiled((()=>{s.onApply=e=>{e._bindTexture("textureSampler",t),e.setFloat2("scale",1,1)},e.getScene().postProcessManager.directRender([s],r,!0),i.restoreDefaultFramebuffer(),i._releaseTexture(t),s&&s.dispose(),r._swapAndDie(t),t.isReady=!0}))}};r?o():e.onLoadObservable.addOnce(o)}static EncodeTextureToRGBD(e,t,i=0){return Ah("rgbdEncode",e,t,i,1,5)}}class Nh{constructor(e,t,i,s){this.name=e,this.worldAxisForNormal=t,this.worldAxisForFileX=i,this.worldAxisForFileY=s}}class Fh{static ConvertCubeMapTextureToSphericalPolynomial(e){var t;if(!e.isCube)return null;null===(t=e.getScene())||void 0===t||t.getEngine().flushFramebuffer();const i=e.getSize().width,s=e.readPixels(0,void 0,void 0,!1),r=e.readPixels(1,void 0,void 0,!1);let n,o;e.isRenderTarget?(n=e.readPixels(3,void 0,void 0,!1),o=e.readPixels(2,void 0,void 0,!1)):(n=e.readPixels(2,void 0,void 0,!1),o=e.readPixels(3,void 0,void 0,!1));const a=e.readPixels(4,void 0,void 0,!1),l=e.readPixels(5,void 0,void 0,!1),h=e.gammaSpace;let c=0;return 1!=e.textureType&&2!=e.textureType||(c=1),new Promise((e=>{Promise.all([r,s,n,o,a,l]).then((([t,s,r,n,o,a])=>{const l={size:i,right:s,left:t,up:r,down:n,front:o,back:a,format:5,type:c,gammaSpace:h};e(this.ConvertCubeMapToSphericalPolynomial(l))}))}))}static _AreaElement(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}static ConvertCubeMapToSphericalPolynomial(e){const t=new Ch;let i=0;const s=2/e.size,r=s,n=.5*s,o=n-1;for(let a=0;a<6;a++){const h=this._FileFaces[a],u=e[h.name];let d=o;const p=5===e.format?4:3;for(let a=0;a<e.size;a++){let _=o;for(let r=0;r<e.size;r++){const o=h.worldAxisForFileX.scale(_).add(h.worldAxisForFileY.scale(d)).add(h.worldAxisForNormal);o.normalize();const f=this._AreaElement(_-n,d-n)-this._AreaElement(_-n,d+n)-this._AreaElement(_+n,d-n)+this._AreaElement(_+n,d+n);let m=u[a*e.size*p+r*p+0],g=u[a*e.size*p+r*p+1],v=u[a*e.size*p+r*p+2];isNaN(m)&&(m=0),isNaN(g)&&(g=0),isNaN(v)&&(v=0),0===e.type&&(m/=255,g/=255,v/=255),e.gammaSpace&&(m=Math.pow(l.Clamp(m),c),g=Math.pow(l.Clamp(g),c),v=Math.pow(l.Clamp(v),c));const x=this.MAX_HDRI_VALUE;if(this.PRESERVE_CLAMPED_COLORS){const e=Math.max(m,g,v);if(e>x){const t=x/e;m*=t,g*=t,v*=t}}else m=l.Clamp(m,0,x),g=l.Clamp(g,0,x),v=l.Clamp(v,0,x);const T=new N(m,g,v);t.addLight(o,T,f),i+=f,_+=s}d+=r}}const a=4*Math.PI*6/6/i;return t.scaleInPlace(a),t.convertIncidentRadianceToIrradiance(),t.convertIrradianceToLambertianRadiance(),yh.FromHarmonics(t)}}Fh._FileFaces=[new Nh("right",new S(1,0,0),new S(0,0,-1),new S(0,-1,0)),new Nh("left",new S(-1,0,0),new S(0,0,1),new S(0,-1,0)),new Nh("up",new S(0,1,0),new S(1,0,0),new S(0,0,1)),new Nh("down",new S(0,-1,0),new S(1,0,0),new S(0,0,-1)),new Nh("front",new S(0,0,1),new S(1,0,0),new S(0,-1,0)),new Nh("back",new S(0,0,-1),new S(-1,0,0),new S(0,-1,0))],Fh.MAX_HDRI_VALUE=4096,Fh.PRESERVE_CLAMPED_COLORS=!1,Cr.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)},Object.defineProperty(Cr.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=Fh.ConvertCubeMapTextureToSphericalPolynomial(this),null===this._texture._sphericalPolynomialPromise?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then((e=>{this._texture._sphericalPolynomial=e,this._texture._sphericalPolynomialComputed=!0}))),null}return null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e)},enumerable:!0,configurable:!0});nt.ShadersStore.rgbdEncodePixelShader="varying vec2 vUV;uniform sampler2D textureSampler;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);}";const wh="image/png",Lh=2,Bh=[134,22,135,150,246,214,150,54];function Uh(e){const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let i=0;for(let e=0;e<Bh.length;e++)if(t.getUint8(i++)!==Bh[e])return k.Error("Not a babylon environment map"),null;let s="",r=0;for(;r=t.getUint8(i++);)s+=String.fromCharCode(r);let n=JSON.parse(s);return n=Vh(n),n.specular&&(n.specular.specularDataPosition=i,n.specular.lodGenerationScale=n.specular.lodGenerationScale||.8),n}function Vh(e){if(e.version>Lh)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "${Lh}".`);return 2===e.version?e:e=Object.assign(Object.assign({},e),{version:2,imageType:wh})}function kh(e,t){const i=(t=Vh(t)).specular;let s=l.Log2(t.width);if(s=Math.round(s)+1,i.mipmaps.length!==6*s)throw new Error(`Unsupported specular mipmaps number "${i.mipmaps.length}"`);const r=new Array(s);for(let t=0;t<s;t++){r[t]=new Array(6);for(let s=0;s<6;s++){const n=i.mipmaps[6*t+s];r[t][s]=new Uint8Array(e.buffer,e.byteOffset+i.specularDataPosition+n.position,n.length)}}return r}function Gh(e,t,i,s,r,n,o,a,l,h,c){return new Promise(((u,d)=>{if(i){const i=t.createTexture(null,!0,!0,null,1,null,(e=>{d(e)}),e);s.getEffect().executeWhenCompiled((()=>{s.externalTextureSamplerBinding=!0,s.onApply=s=>{s._bindTexture("textureSampler",i),s.setFloat2("scale",1,t._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},t.scenes.length&&(t.scenes[0].postProcessManager.directRender([s],h,!0,n,o),t.restoreDefaultFramebuffer(),i.dispose(),URL.revokeObjectURL(r),u())}))}else{if(t._uploadImageToTexture(c,e,n,o),a){const i=l[o];i&&t._uploadImageToTexture(i._texture,e,n,0)}u()}}))}function zh(e,t,i=wh){if(!Ht.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const s=l.ILog2(e.width)+1,r=e.getEngine();let n=!1,o=!1,a=null,h=null,c=null;const u=r.getCaps();if(e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,r.updateTextureSamplingMode(3,e),u.textureLOD?r._features.supportRenderAndCopyToLodForFloatTextures?u.textureHalfFloatRender&&u.textureHalfFloatLinearFiltering?(n=!0,e.type=2):u.textureFloatRender&&u.textureFloatLinearFiltering&&(n=!0,e.type=1):n=!1:(n=!1,o=!0,c={}),n)a=new dn("rgbdDecode","rgbdDecode",null,null,1,null,3,r,!1,void 0,e.type,void 0,null,!1),e._isRGBD=!1,e.invertY=!1,h=r.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,o){const t=3,i=e._lodGenerationScale,n=e._lodGenerationOffset;for(let o=0;o<t;o++){const a=(s-1)*i+n,l=n+(a-n)*(1-o/(t-1)),h=Math.round(Math.min(Math.max(l,0),a)),u=new dt(r,ut.Temp);u.isCube=!0,u.invertY=!0,u.generateMipMaps=!1,r.updateTextureSamplingMode(2,u);const d=new Cr(null);switch(d._isCube=!0,d._texture=u,c[h]=d,o){case 0:e._lodTextureLow=d;break;case 1:e._lodTextureMid=d;break;case 2:e._lodTextureHigh=d}}}const d=[];for(let s=0;s<t.length;s++)for(let l=0;l<6;l++){const u=t[s][l],p=new Blob([u],{type:i}),_=URL.createObjectURL(p);let f;if("undefined"==typeof Image||r._features.forceBitmapOverHTMLImageElement)f=r.createImageBitmap(p,{premultiplyAlpha:"none"}).then((t=>Gh(t,r,n,a,_,l,s,o,c,h,e)));else{const t=new Image;t.src=_,f=new Promise(((i,u)=>{t.onload=()=>{Gh(t,r,n,a,_,l,s,o,c,h,e).then((()=>i())).catch((e=>{u(e)}))},t.onerror=e=>{u(e)}}))}d.push(f)}if(t.length<s){let i;const n=Math.pow(2,s-1-t.length),o=n*n*4;switch(e.type){case 0:i=new Uint8Array(o);break;case 2:i=new Uint16Array(o);break;case 1:i=new Float32Array(o)}for(let n=t.length;n<s;n++)for(let t=0;t<6;t++)r._uploadArrayBufferViewToTexture(e,i,t,n)}return Promise.all(d).then((()=>{h&&(r._releaseTexture(e),h._swapAndDie(e)),a&&a.dispose(),o&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}))}function Wh(e,t){const i=(t=Vh(t)).irradiance;if(!i)return;const s=new yh;S.FromArrayToRef(i.x,0,s.x),S.FromArrayToRef(i.y,0,s.y),S.FromArrayToRef(i.z,0,s.z),S.FromArrayToRef(i.xx,0,s.xx),S.FromArrayToRef(i.yy,0,s.yy),S.FromArrayToRef(i.zz,0,s.zz),S.FromArrayToRef(i.yz,0,s.yz),S.FromArrayToRef(i.zx,0,s.zx),S.FromArrayToRef(i.xy,0,s.xy),e._sphericalPolynomial=s}function Hh(e,t,i,s){let r=s,n=0,o="";for(;r<i.length;){const s=i.charAt(r);if(o)s===o?'"'===o||"'"===o?"\\"!==i.charAt(r-1)&&(o=""):o="":"*/"===o&&"*"===s&&r+1<i.length&&("/"===i.charAt(r+1)&&(o=""),""===o&&r++);else switch(s){case e:n++;break;case t:n--;break;case'"':case"'":case"`":o=s;break;case"/":if(r+1<i.length){const e=i.charAt(r+1);"/"===e?o="\n":"*"===e&&(o="*/")}}if(r++,0===n)break}return 0===n?r-1:-1}function Xh(e,t){for(;t<e.length;){const i=e[t];if(" "!==i&&"\n"!==i&&"\r"!==i&&"\t"!==i&&"\n"!==i&&" "!==i)break;t++}return t}function Yh(e){const t=e.charCodeAt(0);return t>=48&&t<=57||t>=65&&t<=90||t>=97&&t<=122||95==t}function jh(e){let t=0,i="",s=!1;const r=[];for(;t<e.length;){const n=e.charAt(t);if(i)n===i?'"'===i||"'"===i?("\\"!==e.charAt(t-1)&&(i=""),r.push(n)):(i="",s=!1):"*/"===i&&"*"===n&&t+1<e.length?("/"===e.charAt(t+1)&&(i=""),""===i&&(s=!1,t++)):s||r.push(n);else{switch(n){case'"':case"'":case"`":i=n;break;case"/":if(t+1<e.length){const r=e.charAt(t+1);"/"===r?(i="\n",s=!0):"*"===r&&(i="*/",s=!0)}}s||r.push(n)}t++}return r.join("")}function Kh(e,t,i,s){for(;t>=0&&e.charAt(t)!==i&&(!s||e.charAt(t)!==s);)t--;return t}class $h{get code(){return this._sourceCode}constructor(e,t=20){this.debug=!1,this._sourceCode=e,this._numMaxIterations=t,this._functionDescr=[],this.inlineToken="#define inline"}processCode(){this.debug&&console.log(`Start inlining process (code size=${this._sourceCode.length})...`),this._collectFunctions(),this._processInlining(this._numMaxIterations),this.debug&&console.log("End of inlining process.")}_collectFunctions(){let e=0;for(;e<this._sourceCode.length;){const t=this._sourceCode.indexOf(this.inlineToken,e);if(t<0)break;const i=this._sourceCode.indexOf("(",t+this.inlineToken.length);if(i<0){this.debug&&console.warn(`Could not find the opening parenthesis after the token. startIndex=${e}`),e=t+this.inlineToken.length;continue}const s=$h._RegexpFindFunctionNameAndType.exec(this._sourceCode.substring(t+this.inlineToken.length,i));if(!s){this.debug&&console.warn(`Could not extract the name/type of the function from: ${this._sourceCode.substring(t+this.inlineToken.length,i)}`),e=t+this.inlineToken.length;continue}const[r,n]=[s[3],s[4]],o=Hh("(",")",this._sourceCode,i);if(o<0){this.debug&&console.warn(`Could not extract the parameters the function '${n}' (type=${r}). funcParamsStartIndex=${i}`),e=t+this.inlineToken.length;continue}const a=this._sourceCode.substring(i+1,o),l=Xh(this._sourceCode,o+1);if(l===this._sourceCode.length){this.debug&&console.warn(`Could not extract the body of the function '${n}' (type=${r}). funcParamsEndIndex=${o}`),e=t+this.inlineToken.length;continue}const h=Hh("{","}",this._sourceCode,l);if(h<0){this.debug&&console.warn(`Could not extract the body of the function '${n}' (type=${r}). funcBodyStartIndex=${l}`),e=t+this.inlineToken.length;continue}const c=this._sourceCode.substring(l,h+1),u=jh(a).split(","),d=[];for(let e=0;e<u.length;++e){const t=u[e].trim(),i=t.lastIndexOf(" ");i>=0&&d.push(t.substring(i+1))}"void"!==r&&d.push("return"),this._functionDescr.push({name:n,type:r,parameters:d,body:c,callIndex:0}),e=h+1;const p=t>0?this._sourceCode.substring(0,t):"",_=h+1<this._sourceCode.length-1?this._sourceCode.substring(h+1):"";this._sourceCode=p+_,e-=h+1-t}this.debug&&console.log(`Collect functions: ${this._functionDescr.length} functions found. functionDescr=`,this._functionDescr)}_processInlining(e=20){for(;e-- >=0&&this._replaceFunctionCallsByCode(););return this.debug&&console.log(`numMaxIterations is ${e} after inlining process`),e>=0}_replaceFunctionCallsByCode(){let e=!1;for(const t of this._functionDescr){const{name:i,type:s,parameters:r,body:n}=t;let o=0;for(;o<this._sourceCode.length;){const a=this._sourceCode.indexOf(i,o);if(a<0)break;if(0===a||Yh(this._sourceCode.charAt(a-1))){o=a+i.length;continue}const l=Xh(this._sourceCode,a+i.length);if(l===this._sourceCode.length||"("!==this._sourceCode.charAt(l)){o=a+i.length;continue}const h=Hh("(",")",this._sourceCode,l);if(h<0){this.debug&&console.warn(`Could not extract the parameters of the function call. Function '${i}' (type=${s}). callParamsStartIndex=${l}`),o=a+i.length;continue}const c=this._sourceCode.substring(l+1,h),u=e=>{const t=[];let i=0,s=0;for(;i<e.length;){if("("===e.charAt(i)){const t=Hh("(",")",e,i);if(t<0)return null;i=t}else","===e.charAt(i)&&(t.push(e.substring(s,i)),s=i+1);i++}return s<i&&t.push(e.substring(s,i)),t},d=u(jh(c));if(null===d){this.debug&&console.warn(`Invalid function call: can't extract the parameters of the function call. Function '${i}' (type=${s}). callParamsStartIndex=${l}, callParams=`+c),o=a+i.length;continue}const p=[];for(let e=0;e<d.length;++e){const t=d[e].trim();p.push(t)}const _="void"!==s?i+"_"+t.callIndex++:null;if(_&&p.push(_+" ="),p.length!==r.length){this.debug&&console.warn(`Invalid function call: not the same number of parameters for the call than the number expected by the function. Function '${i}' (type=${s}). function parameters=${r}, call parameters=${p}`),o=a+i.length;continue}o=h+1;const f=this._replaceNames(n,r,p);let m=a>0?this._sourceCode.substring(0,a):"";const g=h+1<this._sourceCode.length-1?this._sourceCode.substring(h+1):"";if(_){const e=Kh(this._sourceCode,a-1,"\n","{");m=this._sourceCode.substring(0,e+1);const t=this._sourceCode.substring(e+1,a);this._sourceCode=m+s+" "+_+";\n"+f+"\n"+t+_+g,this.debug&&console.log(`Replace function call by code. Function '${i}' (type=${s}). injectDeclarationIndex=${e}, call parameters=${p}`)}else this._sourceCode=m+f+g,o+=f.length-(h+1-a),this.debug&&console.log(`Replace function call by code. Function '${i}' (type=${s}). functionCallIndex=${a}, call parameters=${p}`);e=!0}}return e}_replaceNames(e,t,i){for(let s=0;s<t.length;++s){const r=new RegExp(t[s].replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),n=t[s].length,o=i[s];e=e.replace(r,((i,...r)=>{const a=r[0];return Yh(e.charAt(a-1))||Yh(e.charAt(a+n))?t[s]:o}))}return e}}$h._RegexpFindFunctionNameAndType=/((\s+?)(\w+)\s+(\w+)\s*?)$/;class qh{get isAsync(){return this.isParallelCompiled}get isReady(){if(this.compilationError){const e=this.compilationError.message;throw new Error("SHADER ERROR"+("string"==typeof e?"\n"+e:""))}return this.isCompiled}_getVertexShaderCode(){return null}_getFragmentShaderCode(){return null}_handlesSpectorRebuildCallback(e){throw new Error("Not implemented")}constructor(e){this.isParallelCompiled=!0,this.isCompiled=!1,this._valueCache={},this._engine=e}_fillEffectInformation(e,t,i,s,r,n,o,a){const l=this._engine;if(l.supportsUniformBuffers)for(const i in t)e.bindUniformBlock(i,t[i]);let h;for(this._engine.getUniforms(this,i).forEach(((e,t)=>{s[i[t]]=e})),this._uniforms=s,h=0;h<r.length;h++)null==e.getUniform(r[h])&&(r.splice(h,1),h--);r.forEach(((e,t)=>{n[e]=t})),a.push(...l.getAttributes(this,o))}dispose(){this._uniforms={}}_cacheMatrix(e,t){const i=this._valueCache[e],s=t.updateFlag;return(void 0===i||i!==s)&&(this._valueCache[e]=s,!0)}_cacheFloat2(e,t,i){let s=this._valueCache[e];if(!s)return s=[t,i],this._valueCache[e]=s,!0;let r=!1;return s[0]!==t&&(s[0]=t,r=!0),s[1]!==i&&(s[1]=i,r=!0),r}_cacheFloat3(e,t,i,s){let r=this._valueCache[e];if(!r)return r=[t,i,s],this._valueCache[e]=r,!0;let n=!1;return r[0]!==t&&(r[0]=t,n=!0),r[1]!==i&&(r[1]=i,n=!0),r[2]!==s&&(r[2]=s,n=!0),n}_cacheFloat4(e,t,i,s,r){let n=this._valueCache[e];if(!n)return n=[t,i,s,r],this._valueCache[e]=n,!0;let o=!1;return n[0]!==t&&(n[0]=t,o=!0),n[1]!==i&&(n[1]=i,o=!0),n[2]!==s&&(n[2]=s,o=!0),n[3]!==r&&(n[3]=r,o=!0),o}setInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this._engine.setInt3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setInt4(e,t,i,s,r){this._cacheFloat4(e,t,i,s,r)&&(this._engine.setInt4(this._uniforms[e],t,i,s,r)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this._engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this._engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this._engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this._engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setUInt3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this._engine.setUInt3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setUInt4(e,t,i,s,r){this._cacheFloat4(e,t,i,s,r)&&(this._engine.setUInt4(this._uniforms[e],t,i,s,r)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this._engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this._engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this._engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this._engine.setUIntArray4(this._uniforms[e],t)}setFloatArray(e,t){this._valueCache[e]=null,this._engine.setFloatArray(this._uniforms[e],t)}setFloatArray2(e,t){this._valueCache[e]=null,this._engine.setFloatArray2(this._uniforms[e],t)}setFloatArray3(e,t){this._valueCache[e]=null,this._engine.setFloatArray3(this._uniforms[e],t)}setFloatArray4(e,t){this._valueCache[e]=null,this._engine.setFloatArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this._engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this._engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this._engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this._engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this._engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this._engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this._engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this._engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setBool(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setInt(this._uniforms[e],t?1:0)&&(this._valueCache[e]=t?1:0)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this._engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this._engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this._engine.setFloat3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,s,r){this._cacheFloat4(e,t,i,s,r)&&(this._engine.setFloat4(this._uniforms[e],t,i,s,r)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this._engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}}class Qh extends cn{get _framebuffer(){return this.__framebuffer}set _framebuffer(e){this.__framebuffer&&this._engine._releaseFramebufferObjects(this.__framebuffer),this.__framebuffer=e}get _framebufferDepthStencil(){return this.__framebufferDepthStencil}set _framebufferDepthStencil(e){this.__framebufferDepthStencil&&this._engine._releaseFramebufferObjects(this.__framebufferDepthStencil),this.__framebufferDepthStencil=e}constructor(e,t,i,s){super(e,t,i,s),this.__framebuffer=null,this.__framebufferDepthStencil=null,this._engine=s}dispose(e=!1){this._framebuffer=null,this._framebufferDepthStencil=null,super.dispose(e)}}class Zh{get underlyingResource(){return this._nativeTexture}constructor(e,t){this._engine=t,this.set(e)}setUsage(){}set(e){this._nativeTexture=e}reset(){this._nativeTexture=null}release(){this._nativeTexture&&this._engine.deleteTexture(this._nativeTexture),this.reset()}}function Jh(e,t){switch(e){case 15:return _native.Engine.TEXTURE_FORMAT_D16;case 16:return _native.Engine.TEXTURE_FORMAT_D24;case 13:return _native.Engine.TEXTURE_FORMAT_D24S8;case 14:return _native.Engine.TEXTURE_FORMAT_D32F;case 36492:return _native.Engine.TEXTURE_FORMAT_BC7;case 36494:return _native.Engine.TEXTURE_FORMAT_BC6H;case 33779:return _native.Engine.TEXTURE_FORMAT_BC3;case 33778:return _native.Engine.TEXTURE_FORMAT_BC2;case 33777:case 33776:return _native.Engine.TEXTURE_FORMAT_BC1;case 37808:return _native.Engine.TEXTURE_FORMAT_ASTC4x4;case 36196:return _native.Engine.TEXTURE_FORMAT_ETC1;case 37492:return _native.Engine.TEXTURE_FORMAT_ETC2;case 37496:return _native.Engine.TEXTURE_FORMAT_ETC2A;case 4:switch(t){case 0:return _native.Engine.TEXTURE_FORMAT_RGB8;case 3:return _native.Engine.TEXTURE_FORMAT_RGB8S;case 6:return _native.Engine.TEXTURE_FORMAT_RGB8I;case 7:return _native.Engine.TEXTURE_FORMAT_RGB8U}break;case 5:switch(t){case 0:return _native.Engine.TEXTURE_FORMAT_RGBA8;case 1:return _native.Engine.TEXTURE_FORMAT_RGBA32F;case 2:return _native.Engine.TEXTURE_FORMAT_RGBA16F;case 3:return _native.Engine.TEXTURE_FORMAT_RGBA8S;case 4:return _native.Engine.TEXTURE_FORMAT_RGBA16I;case 5:return _native.Engine.TEXTURE_FORMAT_RGBA16U;case 6:return _native.Engine.TEXTURE_FORMAT_RGBA32I;case 7:return _native.Engine.TEXTURE_FORMAT_RGBA32U}break;case 6:switch(t){case 0:return _native.Engine.TEXTURE_FORMAT_R8;case 1:return _native.Engine.TEXTURE_FORMAT_R32F;case 2:return _native.Engine.TEXTURE_FORMAT_R16F;case 3:return _native.Engine.TEXTURE_FORMAT_R8S;case 4:return _native.Engine.TEXTURE_FORMAT_R16S;case 5:return _native.Engine.TEXTURE_FORMAT_R16U;case 6:return _native.Engine.TEXTURE_FORMAT_R32I;case 7:return _native.Engine.TEXTURE_FORMAT_R32U}break;case 7:switch(t){case 0:return _native.Engine.TEXTURE_FORMAT_RG8;case 1:return _native.Engine.TEXTURE_FORMAT_RG32F;case 2:return _native.Engine.TEXTURE_FORMAT_RG16F;case 3:return _native.Engine.TEXTURE_FORMAT_RG8S;case 4:return _native.Engine.TEXTURE_FORMAT_RG16S;case 5:return _native.Engine.TEXTURE_FORMAT_RG16U;case 6:return _native.Engine.TEXTURE_FORMAT_RG32I;case 7:return _native.Engine.TEXTURE_FORMAT_RG32U}break;case 12:if(0===t)return _native.Engine.TEXTURE_FORMAT_BGRA8}throw new Ue(`Unsupported texture format or type: format ${e}, type ${t}.`,1e3)}function ec(e){switch(e){case 1:return _native.Engine.TEXTURE_NEAREST_NEAREST;case 2:return _native.Engine.TEXTURE_LINEAR_LINEAR;case 3:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPLINEAR;case 4:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPNEAREST;case 5:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPNEAREST;case 6:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPLINEAR;case 7:return _native.Engine.TEXTURE_NEAREST_LINEAR;case 8:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPLINEAR;case 9:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPNEAREST;case 10:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPLINEAR;case 11:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPNEAREST;case 12:return _native.Engine.TEXTURE_LINEAR_NEAREST;default:throw new Error(`Unsupported sampling mode: ${e}.`)}}function tc(e){switch(e){case 1:return _native.Engine.ADDRESS_MODE_WRAP;case 0:return _native.Engine.ADDRESS_MODE_CLAMP;case 2:return _native.Engine.ADDRESS_MODE_MIRROR;default:throw new Error("Unexpected wrap mode: "+e+".")}}function ic(e){switch(e){case hi.BYTE:return _native.Engine.ATTRIB_TYPE_INT8;case hi.UNSIGNED_BYTE:return _native.Engine.ATTRIB_TYPE_UINT8;case hi.SHORT:return _native.Engine.ATTRIB_TYPE_INT16;case hi.UNSIGNED_SHORT:return _native.Engine.ATTRIB_TYPE_UINT16;case hi.FLOAT:return _native.Engine.ATTRIB_TYPE_FLOAT;default:throw new Error(`Unsupported attribute type: ${e}.`)}}const sc=new a;if("undefined"!=typeof self&&!Object.prototype.hasOwnProperty.call(self,"_native")){let e;Object.defineProperty(self,"_native",{get:()=>e,set:t=>{e=t,e&&sc.notifyObservers(e)}})}class rc extends mt{}class nc{constructor(e){this._engine=e,this._pending=new Array,this._isCommandBufferScopeActive=!1,this._commandStream=oc._createNativeDataStream(),this._engine.setCommandDataStream(this._commandStream)}beginCommandScope(){if(this._isCommandBufferScopeActive)throw new Error("Command scope already active.");this._isCommandBufferScopeActive=!0}endCommandScope(){if(!this._isCommandBufferScopeActive)throw new Error("Command scope is not active.");this._isCommandBufferScopeActive=!1,this._submit()}startEncodingCommand(e){this._commandStream.writeNativeData(e)}encodeCommandArgAsUInt32(e){this._commandStream.writeUint32(e)}encodeCommandArgAsUInt32s(e){this._commandStream.writeUint32Array(e)}encodeCommandArgAsInt32(e){this._commandStream.writeInt32(e)}encodeCommandArgAsInt32s(e){this._commandStream.writeInt32Array(e)}encodeCommandArgAsFloat32(e){this._commandStream.writeFloat32(e)}encodeCommandArgAsFloat32s(e){this._commandStream.writeFloat32Array(e)}encodeCommandArgAsNativeData(e){this._commandStream.writeNativeData(e),this._pending.push(e)}finishEncodingCommand(){this._isCommandBufferScopeActive||this._submit()}_submit(){this._engine.submitCommands(),this._pending.length=0}}class oc extends Ns{setHardwareScalingLevel(e){super.setHardwareScalingLevel(e),this._engine.setHardwareScalingLevel(e)}constructor(e={}){if(super(null,!1,void 0,e.adaptToDeviceRatio),this._engine=new _native.Engine,this._camera=_native.Camera?new _native.Camera:null,this._commandBufferEncoder=new nc(this._engine),this._boundBuffersVertexArray=null,this._currentDepthTest=_native.Engine.DEPTH_TEST_LEQUAL,this._stencilTest=!1,this._stencilMask=255,this._stencilFunc=519,this._stencilFuncRef=0,this._stencilFuncMask=255,this._stencilOpStencilFail=7680,this._stencilOpDepthFail=7680,this._stencilOpStencilDepthPass=7681,this._zOffset=0,this._zOffsetUnits=0,this._depthWrite=!0,_native.Engine.PROTOCOL_VERSION!==oc.PROTOCOL_VERSION)throw new Error(`Protocol version mismatch: ${_native.Engine.PROTOCOL_VERSION} (Native) !== ${oc.PROTOCOL_VERSION} (JS)`);this._webGLVersion=2,this.disableUniformBuffers=!0,this._shaderPlatformName="NATIVE",this._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_SIZE,maxCubemapTextureSize:512,maxRenderTextureSize:512,maxVertexAttribs:16,maxVaryingVectors:16,maxFragmentUniformVectors:16,maxVertexUniformVectors:16,standardDerivatives:!0,astc:null,pvrtc:null,etc1:null,etc2:null,bptc:null,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!1,highPrecisionShaderSupported:!0,colorBufferFloat:!1,supportFloatTexturesResolve:!1,textureFloat:!0,textureFloatLinearFiltering:!1,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!1,textureHalfFloatRender:!0,textureLOD:!0,texelFetch:!1,drawBuffersExtension:!1,depthTextureExtension:!1,vertexArrayObject:!0,instancedArrays:!0,supportOcclusionQuery:!1,canUseTimestampForTimerQuery:!1,blendMinMax:!1,maxMSAASamples:16,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!1,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!1,texture2DArrayMaxLayerCount:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_LAYERS,disableMorphTargetTexture:!1},this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:!1,supportDepthStencilTexture:!1,supportShadowSamplers:!1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:!1,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!1,supportMSAA:!0,supportSSAO2:!1,supportExtendedTextureFormats:!1,supportSwitchCaseInShader:!1,supportSyncTextureRead:!1,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!0,supportSpriteInstancing:!1,forceVertexBufferStrideMultiple4Bytes:!1,_collectUbosUpdatedInFrame:!1},Ht.Log("Babylon Native (v"+Ns.Version+") launched"),Ht.LoadScript=function(e,t,i,s){Ht.LoadFile(e,(e=>{Function(e).apply(null),t&&t()}),void 0,void 0,!1,((e,t)=>{i&&i("LoadScript Error",t)}))},"undefined"==typeof URL&&(window.URL={createObjectURL:function(){},revokeObjectURL:function(){}}),"undefined"==typeof Blob&&(window.Blob=function(e){return e}),Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,value:function e(){const t=isNaN(arguments[0])?1:Number(arguments[0]);return t?Array.prototype.reduce.call(this,(function(i,s){return Array.isArray(s)?i.push.apply(i,e.call(s,t-1)):i.push(s),i}),[]):Array.prototype.slice.call(this)},writable:!0});const t=window&&window.devicePixelRatio||1;this._hardwareScalingLevel=e.adaptToDeviceRatio?1/t:1,this._engine.setHardwareScalingLevel(this._hardwareScalingLevel),this._lastDevicePixelRatio=t,this.resize();const i=this.getDepthFunction();i&&this.setDepthFunction(i),this._shaderProcessor=new ft,this.onNewSceneAddedObservable.add((e=>{const t=e.render;e.render=(...i)=>{this._commandBufferEncoder.beginCommandScope(),t.apply(e,i),this._commandBufferEncoder.endCommandScope()}}))}dispose(){super.dispose(),this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._engine.dispose()}static _createNativeDataStream(){return new xh}_queueNewFrame(e,t){return t.requestAnimationFrame&&t!==window?t.requestAnimationFrame(e):this._engine.requestAnimationFrame(e),0}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._currentFramebuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_UNBINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(this._currentFramebuffer),this._commandBufferEncoder.finishEncodingCommand()),e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()),this._currentFramebuffer=e)}getHostDocument(){return null}clear(e,t,i,s=!1){if(this.useReverseDepthBuffer)throw new Error("reverse depth buffer is not currently implemented");this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_CLEAR),this._commandBufferEncoder.encodeCommandArgAsUInt32(t&&e?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.r:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.g:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.b:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.a:1),this._commandBufferEncoder.encodeCommandArgAsUInt32(i?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(1),this._commandBufferEncoder.encodeCommandArgAsUInt32(s?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(0),this._commandBufferEncoder.finishEncodingCommand()}createIndexBuffer(e,t,i){const s=this._normalizeIndexData(e),r=new rc;return r.references=1,r.is32Bits=4===s.BYTES_PER_ELEMENT,s.byteLength&&(r.nativeIndexBuffer=this._engine.createIndexBuffer(s.buffer,s.byteOffset,s.byteLength,r.is32Bits,null!=t&&t)),r}createVertexBuffer(e,t,i){const s=ArrayBuffer.isView(e)?e:new Float32Array(e),r=new rc;return r.references=1,s.byteLength&&(r.nativeVertexBuffer=this._engine.createVertexBuffer(s.buffer,s.byteOffset,s.byteLength,null!=t&&t)),r}_recordVertexArrayObject(e,t,i,s,r){i&&this._engine.recordIndexBuffer(e,i.nativeIndexBuffer);const n=s.getAttributesNames();for(let i=0;i<n.length;i++){const o=s.getAttributeLocation(i);if(o>=0){const s=n[i];let a=null;if(r&&(a=r[s]),a||(a=t[s]),a){const t=a.getBuffer();t&&t.nativeVertexBuffer&&this._engine.recordVertexBuffer(e,t.nativeVertexBuffer,o,a.byteOffset,a.byteStride,a.getSize(),ic(a.type),a.normalized,a.getInstanceDivisor())}}}}bindBuffers(e,t,i){this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._boundBuffersVertexArray=this._engine.createVertexArray(),this._recordVertexArrayObject(this._boundBuffersVertexArray,e,t,i),this.bindVertexArrayObject(this._boundBuffersVertexArray)}recordVertexArrayObject(e,t,i,s){const r=this._engine.createVertexArray();return this._recordVertexArrayObject(r,e,t,i,s),r}_deleteVertexArray(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()}bindVertexArrayObject(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()}releaseVertexArrayObject(e){this._deleteVertexArray(e)}getAttributes(e,t){const i=e;return this._engine.getAttributes(i.nativeProgram,t)}drawElementsType(e,t,i,s){this._drawCalls.addCount(1,!1),s&&_native.Engine.COMMAND_DRAWINDEXEDINSTANCED?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXEDINSTANCED),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(s)):(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXED),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i)),this._commandBufferEncoder.finishEncodingCommand()}drawArraysType(e,t,i,s){this._drawCalls.addCount(1,!1),s&&_native.Engine.COMMAND_DRAWINSTANCED?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINSTANCED),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(s)):(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAW),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i)),this._commandBufferEncoder.finishEncodingCommand()}createPipelineContext(){return new qh(this)}createMaterialContext(){}createDrawContext(){}_preparePipelineContext(e,t,i,s,r,n,o,a){e.nativeProgram=s?this.createRawShaderProgram():this.createShaderProgram(e,t,i,a)}isAsync(e){return!(!e.isAsync||!this._engine.createProgramAsync)}_executeWhenRenderingStateIsCompiled(e,t){const i=e;if(!this.isAsync(e))return void t();const s=i.onCompiled;i.onCompiled=s?()=>{s(),t()}:t}createRawShaderProgram(){throw new Error("Not Supported")}createShaderProgram(e,t,i,s){const r=e;if(r.nativeProgram)throw new Error("Tried to create a second program in the same NativePipelineContext");this.onBeforeShaderCompilationObservable.notifyObservers(this);const n=new $h(t);n.processCode(),t=n.code;const o=new $h(i);o.processCode(),i=o.code,t=bt._ConcatenateShader(t,s),i=bt._ConcatenateShader(i,s);const a=()=>{var e;r.isCompiled=!0,null===(e=r.onCompiled)||void 0===e||e.call(r),this.onAfterShaderCompilationObservable.notifyObservers(this)};if(this.isAsync(e))return this._engine.createProgramAsync(t,i,a,(e=>{r.compilationError=e}));try{const e=r.nativeProgram=this._engine.createProgram(t,i);return a(),e}catch(e){const t=null==e?void 0:e.message;throw new Error("SHADER ERROR"+("string"==typeof t?"\n"+t:""))}}inlineShaderCode(e){const t=new $h(e);return t.debug=!1,t.processCode(),t.code}_setProgram(e){this._currentProgram!==e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand(),this._currentProgram=e)}_deletePipelineContext(e){const t=e;t&&t.nativeProgram&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(t.nativeProgram),this._commandBufferEncoder.finishEncodingCommand())}getUniforms(e,t){const i=e;return this._engine.getUniforms(i.nativeProgram,t)}bindUniformBlock(e,t,i){throw new Error("Not Implemented")}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.nativeProgram);const i=e.getSamplers();for(let t=0;t<i.length;t++){const s=e.getUniform(i[t]);s&&(this._boundUniforms[t]=s)}this._currentEffect=null}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._engine.getRenderWidth()}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._engine.getRenderHeight()}setViewport(e,t,i){this._cachedViewport=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETVIEWPORT),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.x),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.y),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.width),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.height),this._commandBufferEncoder.finishEncodingCommand()}enableScissor(e,t,i,s){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSCISSOR),this._commandBufferEncoder.encodeCommandArgAsFloat32(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(s),this._commandBufferEncoder.finishEncodingCommand()}disableScissor(){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSCISSOR),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.finishEncodingCommand()}setState(e,t=0,i,s=!1,r,n,o=0){var a,l;this._zOffset=t,this._zOffsetUnits=o,0!==this._zOffset&&Ht.Warn("zOffset is not supported in Native engine."),this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTATE),this._commandBufferEncoder.encodeCommandArgAsUInt32(e?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(o),this._commandBufferEncoder.encodeCommandArgAsUInt32(null===(l=null!==(a=this.cullBackFaces)&&void 0!==a?a:r)||void 0===l||l?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(s?1:0),this._commandBufferEncoder.finishEncodingCommand()}getInputElementClientRect(){return{bottom:this.getRenderHeight(),height:this.getRenderHeight(),left:0,right:this.getRenderWidth(),top:0,width:this.getRenderWidth(),x:0,y:0,toJSON:()=>{}}}setZOffset(e){e!==this._zOffset&&(this._zOffset=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSET),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-e:e),this._commandBufferEncoder.finishEncodingCommand())}getZOffset(){return this._zOffset}setZOffsetUnits(e){e!==this._zOffsetUnits&&(this._zOffsetUnits=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSETUNITS),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-e:e),this._commandBufferEncoder.finishEncodingCommand())}getZOffsetUnits(){return this._zOffsetUnits}setDepthBuffer(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(e?this._currentDepthTest:_native.Engine.DEPTH_TEST_ALWAYS),this._commandBufferEncoder.finishEncodingCommand()}getDepthWrite(){return this._depthWrite}getDepthFunction(){switch(this._currentDepthTest){case _native.Engine.DEPTH_TEST_NEVER:return 512;case _native.Engine.DEPTH_TEST_ALWAYS:return 519;case _native.Engine.DEPTH_TEST_GREATER:return 516;case _native.Engine.DEPTH_TEST_GEQUAL:return 518;case _native.Engine.DEPTH_TEST_NOTEQUAL:return 517;case _native.Engine.DEPTH_TEST_EQUAL:return 514;case _native.Engine.DEPTH_TEST_LESS:return 513;case _native.Engine.DEPTH_TEST_LEQUAL:return 515}return null}setDepthFunction(e){let t=0;switch(e){case 512:t=_native.Engine.DEPTH_TEST_NEVER;break;case 519:t=_native.Engine.DEPTH_TEST_ALWAYS;break;case 516:t=_native.Engine.DEPTH_TEST_GREATER;break;case 518:t=_native.Engine.DEPTH_TEST_GEQUAL;break;case 517:t=_native.Engine.DEPTH_TEST_NOTEQUAL;break;case 514:t=_native.Engine.DEPTH_TEST_EQUAL;break;case 513:t=_native.Engine.DEPTH_TEST_LESS;break;case 515:t=_native.Engine.DEPTH_TEST_LEQUAL}this._currentDepthTest=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(this._currentDepthTest),this._commandBufferEncoder.finishEncodingCommand()}setDepthWrite(e){this._depthWrite=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(e)),this._commandBufferEncoder.finishEncodingCommand()}setColorWrite(e){this._colorWrite=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETCOLORWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(e)),this._commandBufferEncoder.finishEncodingCommand()}getColorWrite(){return this._colorWrite}applyStencil(){this._setStencil(this._stencilMask,function(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_FAIL_S_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_S_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_S_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_S_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_S_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_S_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_S_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_S_DECRSAT;default:throw new Error(`Unsupported stencil OpFail mode: ${e}.`)}}(this._stencilOpStencilFail),function(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_FAIL_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_Z_DECRSAT;default:throw new Error(`Unsupported stencil depthFail mode: ${e}.`)}}(this._stencilOpDepthFail),function(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_PASS_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_PASS_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_PASS_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_PASS_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_PASS_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_PASS_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_PASS_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_PASS_Z_DECRSAT;default:throw new Error(`Unsupported stencil opPass mode: ${e}.`)}}(this._stencilOpStencilDepthPass),function(e){switch(e){case 513:return _native.Engine.STENCIL_TEST_LESS;case 515:return _native.Engine.STENCIL_TEST_LEQUAL;case 514:return _native.Engine.STENCIL_TEST_EQUAL;case 518:return _native.Engine.STENCIL_TEST_GEQUAL;case 516:return _native.Engine.STENCIL_TEST_GREATER;case 517:return _native.Engine.STENCIL_TEST_NOTEQUAL;case 512:return _native.Engine.STENCIL_TEST_NEVER;case 519:return _native.Engine.STENCIL_TEST_ALWAYS;default:throw new Error(`Unsupported stencil func mode: ${e}.`)}}(this._stencilFunc),this._stencilFuncRef)}_setStencil(e,t,i,s,r,n){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTENCIL),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(s),this._commandBufferEncoder.encodeCommandArgAsUInt32(r),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.finishEncodingCommand()}setStencilBuffer(e){this._stencilTest=e,e?this.applyStencil():this._setStencil(255,_native.Engine.STENCIL_OP_FAIL_S_KEEP,_native.Engine.STENCIL_OP_FAIL_Z_KEEP,_native.Engine.STENCIL_OP_PASS_Z_KEEP,_native.Engine.STENCIL_TEST_ALWAYS,0)}getStencilBuffer(){return this._stencilTest}getStencilOperationPass(){return this._stencilOpStencilDepthPass}setStencilOperationPass(e){this._stencilOpStencilDepthPass=e,this.applyStencil()}setStencilMask(e){this._stencilMask=e,this.applyStencil()}setStencilFunction(e){this._stencilFunc=e,this.applyStencil()}setStencilFunctionReference(e){this._stencilFuncRef=e,this.applyStencil()}setStencilFunctionMask(e){this._stencilFuncMask=e}setStencilOperationFail(e){this._stencilOpStencilFail=e,this.applyStencil()}setStencilOperationDepthFail(e){this._stencilOpDepthFail=e,this.applyStencil()}getStencilMask(){return this._stencilMask}getStencilFunction(){return this._stencilFunc}getStencilFunctionReference(){return this._stencilFuncRef}getStencilFunctionMask(){return this._stencilFuncMask}getStencilOperationFail(){return this._stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilOpDepthFail}setAlphaConstants(e,t,i,s){throw new Error("Setting alpha blend constant color not yet implemented.")}setAlphaMode(e,t=!1){if(this._alphaMode===e)return;const i=function(e){switch(e){case 0:return _native.Engine.ALPHA_DISABLE;case 1:return _native.Engine.ALPHA_ADD;case 2:return _native.Engine.ALPHA_COMBINE;case 3:return _native.Engine.ALPHA_SUBTRACT;case 4:return _native.Engine.ALPHA_MULTIPLY;case 5:return _native.Engine.ALPHA_MAXIMIZED;case 6:return _native.Engine.ALPHA_ONEONE;case 7:return _native.Engine.ALPHA_PREMULTIPLIED;case 8:return _native.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF;case 9:return _native.Engine.ALPHA_INTERPOLATE;case 10:return _native.Engine.ALPHA_SCREENMODE;default:throw new Error(`Unsupported alpha mode: ${e}.`)}}(e);this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETBLENDMODE),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand(),t||this.setDepthWrite(0===e),this._alphaMode=e}getAlphaMode(){return this._alphaMode}setInt(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINT),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray2(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray3(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray4(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray2(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray3(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray4(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setArray(e,t){return!!e&&this.setFloatArray(e,new Float32Array(t))}setArray2(e,t){return!!e&&this.setFloatArray2(e,new Float32Array(t))}setArray3(e,t){return!!e&&this.setFloatArray3(e,new Float32Array(t))}setArray4(e,t){return!!e&&this.setFloatArray4(e,new Float32Array(t))}setMatrices(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRICES),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setMatrix3x3(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX3X3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setMatrix2x2(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX2X2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat2(e,t,i){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat3(e,t,i,s){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(s),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat4(e,t,i,s,r){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(s),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.finishEncodingCommand(),!0)}setColor3(e,t){return!!e&&(this.setFloat3(e,t.r,t.g,t.b),!0)}setColor4(e,t,i){return!!e&&(this.setFloat4(e,t.r,t.g,t.b,i),!0)}wipeCaches(e){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this._currentEffect=null,e&&(this._currentProgram=null,this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._alphaState.reset()),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}_createTexture(){return this._engine.createTexture()}_deleteTexture(e){e&&this._engine.deleteTexture(e)}updateDynamicTexture(e,t,i,s=!1,r){if(void 0===s&&(s=!1),e&&e._hardwareTexture){const i=t.getCanvasTexture(),s=e._hardwareTexture.underlyingResource;this._engine.copyTexture(s,i),e.isReady=!0}}createDynamicTexture(e,t,i,s){return e=Math.max(e,1),t=Math.max(t,1),this.createRawTexture(new Uint8Array(e*t*4),e,t,5,!1,!1,s)}createVideoElement(e){return this._camera?this._camera.createVideo(e):null}updateVideoTexture(e,t,i){if(e&&e._hardwareTexture&&this._camera){const s=e._hardwareTexture.underlyingResource;this._camera.updateVideoTexture(s,t,i)}}createRawTexture(e,t,i,s,r,n,o,a=null,l=0,h=0,c=!1){const u=new dt(this,ut.Raw);if(u.format=s,u.generateMipMaps=r,u.samplingMode=o,u.invertY=n,u.baseWidth=t,u.baseHeight=i,u.width=u.baseWidth,u.height=u.baseHeight,u._compression=a,u.type=l,u._useSRGBBuffer=this._getUseSRGBBuffer(c,!r),this.updateRawTexture(u,e,s,n,a,l,u._useSRGBBuffer),u._hardwareTexture){const e=u._hardwareTexture.underlyingResource,t=ec(o);this._setTextureSampling(e,t)}return this._internalTexturesCache.push(u),u}createRawTexture2DArray(e,t,i,s,r,n,o,a,l=null,h=0){const c=new dt(this,ut.Raw2DArray);if(c.baseWidth=t,c.baseHeight=i,c.baseDepth=s,c.width=t,c.height=i,c.depth=s,c.format=r,c.type=h,c.generateMipMaps=n,c.samplingMode=a,c.is2DArray=!0,c._hardwareTexture){const l=c._hardwareTexture.underlyingResource;this._engine.loadRawTexture2DArray(l,e,t,i,s,Jh(r,h),n,o);const u=ec(a);this._setTextureSampling(l,u)}return c.isReady=!0,this._internalTexturesCache.push(c),c}updateRawTexture(e,t,i,s,r=null,n=0,o=!1){if(e){if(t&&e._hardwareTexture){const s=e._hardwareTexture.underlyingResource;this._engine.loadRawTexture(s,t,e.width,e.height,Jh(i,n),e.generateMipMaps,e.invertY)}e.isReady=!0}}createTexture(e,t,i,s,r=3,n=null,o=null,a=null,l=null,h=null,c=null,u,d,p,_=!1){const f="data:"===(e=e||"").substr(0,5),m=f&&-1!==e.indexOf(";base64,"),g=l||new dt(this,ut.Url),v=e;!this._transformTextureUrl||m||l||a||(e=this._transformTextureUrl(e));const T=e.lastIndexOf("."),E=c||(T>-1?e.substring(T).toLowerCase():"");let S=null;for(const e of Ns._TextureLoaders)if(e.canLoad(E)){S=e;break}s&&s.addPendingData(g),g.url=e,g.generateMipMaps=!t,g.samplingMode=r,g.invertY=i,g._useSRGBBuffer=this._getUseSRGBBuffer(_,t),this.doNotHandleContextLost||(g._buffer=a);let b=null;n&&!l&&(b=g.onLoadedObservable.add(n)),l||this._internalTexturesCache.push(g);const C=(i,l)=>{s&&s.removePendingData(g),e===v?(b&&g.onLoadedObservable.remove(b),x.UseFallbackTexture&&this.createTexture(x.FallbackTexture,t,g.invertY,s,r,null,o,a,g),o&&o((i||"Unknown error")+(x.UseFallbackTexture?" - Fallback texture was used":""),l)):(k.Warn(`Failed to load ${e}, falling back to ${v}`),this.createTexture(v,t,g.invertY,s,r,n,o,a,g,h,c,u,d))};if(S)throw new Error("Loading textures from IInternalTextureLoader not yet implemented.");{const n=e=>{if(!g._hardwareTexture)return void(s&&s.removePendingData(g));const n=g._hardwareTexture.underlyingResource;this._engine.loadTexture(n,e,!t,i,g._useSRGBBuffer,(()=>{g.baseWidth=this._engine.getTextureWidth(n),g.baseHeight=this._engine.getTextureHeight(n),g.width=g.baseWidth,g.height=g.baseHeight,g.isReady=!0;const e=ec(r);this._setTextureSampling(n,e),s&&s.removePendingData(g),g.onLoadedObservable.notifyObservers(g),g.onLoadedObservable.clear()}),(()=>{throw new Error("Could not load a native texture.")}))};if(f&&a)if(a instanceof ArrayBuffer)n(new Uint8Array(a));else if(ArrayBuffer.isView(a))n(a);else{if("string"!=typeof a)throw new Error("Unsupported buffer type");n(new Uint8Array(Ht.DecodeBase64(a)))}else m?n(new Uint8Array(Ht.DecodeBase64(e))):this._loadFile(e,(e=>n(new Uint8Array(e))),void 0,void 0,!0,((e,t)=>{C("Unable to load "+(e&&e.responseURL,t))}))}return g}wrapNativeTexture(e,t=!1,i=3){const s=new Zh(e,this._engine),r=new dt(this,ut.Unknown,!0);return r._hardwareTexture=s,r.baseWidth=this._engine.getTextureWidth(e),r.baseHeight=this._engine.getTextureHeight(e),r.width=r.baseWidth,r.height=r.baseHeight,r.isReady=!0,r.useMipMaps=t,this.updateTextureSamplingMode(i,r),r}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapNativeTexture instead.")}_createDepthStencilTexture(e,t,i){var s,r;const n=t.generateStencil||!1,o=t.samples||1,a=i,l=new dt(this,ut.DepthStencil),h=null!==(s=e.width)&&void 0!==s?s:e,c=null!==(r=e.height)&&void 0!==r?r:e,u=this._engine.createFrameBuffer(l._hardwareTexture.underlyingResource,h,c,n,!0,o);return a._framebufferDepthStencil=u,l}_releaseFramebufferObjects(e){e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand())}_createImageBitmapFromSource(e,t){return new Promise(((t,i)=>{const s=this.createCanvasImage();s.onload=()=>{try{const e=this._engine.createImageBitmap(s);t(e)}catch(e){i(`Error loading image ${s.src} with exception: ${e}`)}},s.onerror=e=>{i(`Error loading image ${s.src} with exception: ${e}`)},s.src=e}))}createImageBitmap(e,t){return new Promise(((t,i)=>{if(Array.isArray(e)){const i=e;if(i.length){const e=this._engine.createImageBitmap(i[0]);if(e)return void t(e)}}i("Unsupported data for createImageBitmap.")}))}resizeImageBitmap(e,t,i){return this._engine.resizeImageBitmap(e,t,i)}createCubeTexture(e,t,i,s,r=null,n=null,o,a=null,l=!1,h=0,c=0,u=null,d,p=!1){const _=u||new dt(this,ut.Cube);_.isCube=!0,_.url=e,_.generateMipMaps=!s,_._lodGenerationScale=h,_._lodGenerationOffset=c,_._useSRGBBuffer=this._getUseSRGBBuffer(p,!!s),this._doNotHandleContextLost||(_._extension=a,_._files=i);const f=e.lastIndexOf(".");if(".env"===(a||(f>-1?e.substring(f).toLowerCase():""))){const t=e=>{const t=Uh(e);_.width=t.width,_.height=t.width,Wh(_,t);const i=t.specular;if(!i)throw new Error("Nothing else parsed so far");_._lodGenerationScale=i.lodGenerationScale;const s=kh(e,t);_.format=5,_.type=0,_.generateMipMaps=!0,_.getEngine().updateTextureSamplingMode(Ar.TRILINEAR_SAMPLINGMODE,_),_._isRGBD=!0,_.invertY=!0,this._engine.loadCubeTextureWithMips(_._hardwareTexture.underlyingResource,s,!1,_._useSRGBBuffer,(()=>{_.isReady=!0,r&&r()}),(()=>{throw new Error("Could not load a native cube texture.")}))};if(i&&6===i.length)throw new Error("Multi-file loading not allowed on env files.");{const i=(e,t)=>{n&&e&&n(e.status+" "+e.statusText,t)};this._loadFile(e,(e=>t(new Uint8Array(e))),void 0,void 0,!0,i)}}else{if(!i||6!==i.length)throw new Error("Cannot load cubemap because 6 files were not defined");const e=[i[0],i[3],i[1],i[4],i[2],i[5]];Promise.all(e.map((e=>Ht.LoadFileAsync(e).then((e=>new Uint8Array(e)))))).then((e=>new Promise(((t,i)=>{this._engine.loadCubeTexture(_._hardwareTexture.underlyingResource,e,!s,!0,_._useSRGBBuffer,t,i)})))).then((()=>{_.isReady=!0,r&&r()}),(e=>{n&&n(`Failed to load cubemap: ${e.message}`,e)}))}return this._internalTexturesCache.push(_),_}_createHardwareTexture(){return new Zh(this._createTexture(),this._engine)}_createHardwareRenderTargetWrapper(e,t,i){const s=new Qh(e,t,i,this);return this._renderTargetWrapperCache.push(s),s}_createInternalTexture(e,t,i=!0,s=ut.Unknown){var r,n,o;let a,l=!1,h=0,c=3,u=5,d=!1,p=1;void 0!==t&&"object"==typeof t?(l=!!t.generateMipMaps,h=void 0===t.type?0:t.type,c=void 0===t.samplingMode?3:t.samplingMode,u=void 0===t.format?5:t.format,d=void 0!==t.useSRGBBuffer&&t.useSRGBBuffer,p=null!==(r=t.samples)&&void 0!==r?r:1,a=t.label):l=!!t,d=this._getUseSRGBBuffer(d,!l),(1!==h||this._caps.textureFloatLinearFiltering)&&(2!==h||this._caps.textureHalfFloatLinearFiltering)||(c=1),1!==h||this._caps.textureFloat||(h=0,k.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const _=new dt(this,s),f=null!==(n=e.width)&&void 0!==n?n:e,m=null!==(o=e.height)&&void 0!==o?o:e,g=e.layers||0;if(0!==g)throw new Error("Texture layers are not supported in Babylon Native");const v=_._hardwareTexture.underlyingResource,x=Jh(u,h);return this._engine.initializeTexture(v,f,m,l,x,!0,d,p),this._setTextureSampling(v,ec(c)),_._useSRGBBuffer=d,_.baseWidth=f,_.baseHeight=m,_.width=f,_.height=m,_.depth=g,_.isReady=!0,_.samples=p,_.generateMipMaps=l,_.samplingMode=c,_.type=h,_.format=u,_.label=a,this._internalTexturesCache.push(_),_}createRenderTargetTexture(e,t){var i,s,r,n;const o=this._createHardwareRenderTargetWrapper(!1,!1,e);let a,l=!0,h=!1,c=!1,u=1;void 0!==t&&"object"==typeof t&&(l=null===(i=t.generateDepthBuffer)||void 0===i||i,h=!!t.generateStencilBuffer,c=!!t.noColorAttachment,a=t.colorAttachment,u=null!==(s=t.samples)&&void 0!==s?s:1);const d=a||(c?null:this._createInternalTexture(e,t,!0,ut.RenderTarget)),p=null!==(r=e.width)&&void 0!==r?r:e,_=null!==(n=e.height)&&void 0!==n?n:e,f=this._engine.createFrameBuffer(d?d._hardwareTexture.underlyingResource:null,p,_,h,l,u);return o._framebuffer=f,o._generateDepthBuffer=l,o._generateStencilBuffer=h,o._samples=u,o.setTextures(d),o}updateRenderTargetTextureSampleCount(e,t){return k.Warn("Updating render target sample count is not currently supported"),e.samples}updateTextureSamplingMode(e,t){if(t._hardwareTexture){const i=ec(e);this._setTextureSampling(t._hardwareTexture.underlyingResource,i)}t.samplingMode=e}bindFramebuffer(e,t,i,s,r){const n=e;if(this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,t)throw new Error("Cuboid frame buffers are not yet supported in NativeEngine.");if(i||s)throw new Error("Required width/height for frame buffers not yet supported in NativeEngine.");n._framebufferDepthStencil?this._bindUnboundFramebuffer(n._framebufferDepthStencil):this._bindUnboundFramebuffer(n._framebuffer)}unBindFramebuffer(e,t=!1,i){this._currentRenderTarget=null,i&&i(),this._bindUnboundFramebuffer(null)}createDynamicVertexBuffer(e){return this.createVertexBuffer(e,!0)}updateDynamicIndexBuffer(e,t,i=0){const s=e,r=this._normalizeIndexData(t);s.is32Bits=4===r.BYTES_PER_ELEMENT,this._engine.updateDynamicIndexBuffer(s.nativeIndexBuffer,r.buffer,r.byteOffset,r.byteLength,i)}updateDynamicVertexBuffer(e,t,i,s){const r=e,n=ArrayBuffer.isView(t)?t:new Float32Array(t);this._engine.updateDynamicVertexBuffer(r.nativeVertexBuffer,n.buffer,n.byteOffset+(null!=i?i:0),null!=s?s:n.byteLength)}_setTexture(e,t,i=!1,s=!1){const r=this._boundUniforms[e];if(!r)return!1;if(!t)return null!=this._boundTexturesCache[e]&&(this._activeChannel=e,this._boundTexturesCache[e]=null),!1;if(t.video)this._activeChannel=e,t.update();else if(4===t.delayLoadState)return t.delayLoad(),!1;let n;return n=s?t.depthStencilTexture:t.isReady()?t.getInternalTexture():t.isCube?this.emptyCubeTexture:t.is3D?this.emptyTexture3D:t.is2DArray?this.emptyTexture2DArray:this.emptyTexture,this._activeChannel=e,!(!n||!n._hardwareTexture||(this._setTextureWrapMode(n._hardwareTexture.underlyingResource,tc(t.wrapU),tc(t.wrapV),tc(t.wrapR)),this._updateAnisotropicLevel(t),this._setTextureCore(r,n._hardwareTexture.underlyingResource),0))}_setTextureSampling(e,t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURESAMPLING),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.finishEncodingCommand()}_setTextureWrapMode(e,t,i,s){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREWRAPMODE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(s),this._commandBufferEncoder.finishEncodingCommand()}_setTextureCore(e,t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand()}_updateAnisotropicLevel(e){const t=e.getInternalTexture(),i=e.anisotropicFilteringLevel;t&&t._hardwareTexture&&t._cachedAnisotropicFilteringLevel!==i&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREANISOTROPICLEVEL),this._commandBufferEncoder.encodeCommandArgAsNativeData(t._hardwareTexture.underlyingResource),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand(),t._cachedAnisotropicFilteringLevel=i)}_bindTexture(e,t){const i=this._boundUniforms[e];if(i&&t&&t._hardwareTexture){const e=t._hardwareTexture.underlyingResource;this._setTextureCore(i,e)}}_deleteBuffer(e){e.nativeIndexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEINDEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e.nativeIndexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete e.nativeIndexBuffer),e.nativeVertexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e.nativeVertexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete e.nativeVertexBuffer)}createCanvas(e,t){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");const i=new _native.Canvas;return i.width=e,i.height=t,i}createCanvasImage(){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");return new _native.Image}updateTextureData(e,t,i,s,r,n,o=0,a=0,l=!1){throw new Error("updateTextureData not implemented.")}_uploadCompressedDataToTextureDirectly(e,t,i,s,r,n=0,o=0){throw new Error("_uploadCompressedDataToTextureDirectly not implemented.")}_uploadDataToTextureDirectly(e,t,i=0,s=0){throw new Error("_uploadDataToTextureDirectly not implemented.")}_uploadArrayBufferViewToTexture(e,t,i=0,s=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}_uploadImageToTexture(e,t,i=0,s=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}getFontOffset(e){return{ascent:0,height:0,descent:0}}_readTexturePixels(e,t,i,s,r,n,o,a,l,h){var c,u,d,p;if(void 0!==s&&-1!==s)throw new Error(`Reading cubemap faces is not supported, but faceIndex is ${s}.`);return this._engine.readTexture(null===(c=e._hardwareTexture)||void 0===c?void 0:c.underlyingResource,null!=r?r:0,null!=l?l:0,null!=h?h:0,t,i,null!==(u=null==n?void 0:n.buffer)&&void 0!==u?u:null,null!==(d=null==n?void 0:n.byteOffset)&&void 0!==d?d:0,null!==(p=null==n?void 0:n.byteLength)&&void 0!==p?p:0).then((e=>(n||(n=new Uint8Array(e)),n)))}}oc.PROTOCOL_VERSION=8,oc._createNativeDataStream=function(){return _native.NativeDataStream.VALIDATION_ENABLED?new ac:new xh};class ac extends xh{constructor(){super()}writeUint32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32),super.writeUint32(e)}writeInt32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32),super.writeInt32(e)}writeFloat32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32),super.writeFloat32(e)}writeUint32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32_ARRAY),super.writeUint32Array(e)}writeInt32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32_ARRAY),super.writeInt32Array(e)}writeFloat32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32_ARRAY),super.writeFloat32Array(e)}writeNativeData(e){super.writeUint32(_native.NativeDataStream.VALIDATION_NATIVE_DATA),super.writeNativeData(e)}writeBoolean(e){super.writeUint32(_native.NativeDataStream.VALIDATION_BOOLEAN),super.writeBoolean(e)}}var lc,hc,cc,uc,dc,pc,_c,fc,mc,gc,vc,xc,Tc,Ec,Sc,bc,Cc,yc,Ac,Rc,Ic,Pc,Mc,Oc,Dc,Nc,Fc,wc,Lc,Bc,Uc,Vc,kc,Gc,zc,Wc,Hc,Xc,Yc,jc;!function(e){e.LowPower="low-power",e.HighPerformance="high-performance"}(lc||(lc={})),function(e){e.DepthClipControl="depth-clip-control",e.Depth32FloatStencil8="depth32float-stencil8",e.TextureCompressionBC="texture-compression-bc",e.TextureCompressionETC2="texture-compression-etc2",e.TextureCompressionASTC="texture-compression-astc",e.TimestampQuery="timestamp-query",e.IndirectFirstInstance="indirect-first-instance",e.ShaderF16="shader-f16",e.RG11B10UFloatRenderable="rg11b10ufloat-renderable",e.BGRA8UnormStorage="bgra8unorm-storage",e.Float32Filterable="float32-filterable"}(hc||(hc={})),function(e){e.Unmapped="unmapped",e.Pending="pending",e.Mapped="mapped"}(cc||(cc={})),function(e){e[e.MapRead=1]="MapRead",e[e.MapWrite=2]="MapWrite",e[e.CopySrc=4]="CopySrc",e[e.CopyDst=8]="CopyDst",e[e.Index=16]="Index",e[e.Vertex=32]="Vertex",e[e.Uniform=64]="Uniform",e[e.Storage=128]="Storage",e[e.Indirect=256]="Indirect",e[e.QueryResolve=512]="QueryResolve"}(uc||(uc={})),function(e){e[e.Read=1]="Read",e[e.Write=2]="Write"}(dc||(dc={})),function(e){e.E1d="1d",e.E2d="2d",e.E3d="3d"}(pc||(pc={})),function(e){e[e.CopySrc=1]="CopySrc",e[e.CopyDst=2]="CopyDst",e[e.TextureBinding=4]="TextureBinding",e[e.StorageBinding=8]="StorageBinding",e[e.RenderAttachment=16]="RenderAttachment"}(_c||(_c={})),function(e){e.E1d="1d",e.E2d="2d",e.E2dArray="2d-array",e.Cube="cube",e.CubeArray="cube-array",e.E3d="3d"}(fc||(fc={})),function(e){e.All="all",e.StencilOnly="stencil-only",e.DepthOnly="depth-only"}(mc||(mc={})),function(e){e.R8Unorm="r8unorm",e.R8Snorm="r8snorm",e.R8Uint="r8uint",e.R8Sint="r8sint",e.R16Uint="r16uint",e.R16Sint="r16sint",e.R16Float="r16float",e.RG8Unorm="rg8unorm",e.RG8Snorm="rg8snorm",e.RG8Uint="rg8uint",e.RG8Sint="rg8sint",e.R32Uint="r32uint",e.R32Sint="r32sint",e.R32Float="r32float",e.RG16Uint="rg16uint",e.RG16Sint="rg16sint",e.RG16Float="rg16float",e.RGBA8Unorm="rgba8unorm",e.RGBA8UnormSRGB="rgba8unorm-srgb",e.RGBA8Snorm="rgba8snorm",e.RGBA8Uint="rgba8uint",e.RGBA8Sint="rgba8sint",e.BGRA8Unorm="bgra8unorm",e.BGRA8UnormSRGB="bgra8unorm-srgb",e.RGB9E5UFloat="rgb9e5ufloat",e.RGB10A2UINT="rgb10a2uint",e.RGB10A2Unorm="rgb10a2unorm",e.RG11B10UFloat="rg11b10ufloat",e.RG32Uint="rg32uint",e.RG32Sint="rg32sint",e.RG32Float="rg32float",e.RGBA16Uint="rgba16uint",e.RGBA16Sint="rgba16sint",e.RGBA16Float="rgba16float",e.RGBA32Uint="rgba32uint",e.RGBA32Sint="rgba32sint",e.RGBA32Float="rgba32float",e.Stencil8="stencil8",e.Depth16Unorm="depth16unorm",e.Depth24Plus="depth24plus",e.Depth24PlusStencil8="depth24plus-stencil8",e.Depth32Float="depth32float",e.BC1RGBAUnorm="bc1-rgba-unorm",e.BC1RGBAUnormSRGB="bc1-rgba-unorm-srgb",e.BC2RGBAUnorm="bc2-rgba-unorm",e.BC2RGBAUnormSRGB="bc2-rgba-unorm-srgb",e.BC3RGBAUnorm="bc3-rgba-unorm",e.BC3RGBAUnormSRGB="bc3-rgba-unorm-srgb",e.BC4RUnorm="bc4-r-unorm",e.BC4RSnorm="bc4-r-snorm",e.BC5RGUnorm="bc5-rg-unorm",e.BC5RGSnorm="bc5-rg-snorm",e.BC6HRGBUFloat="bc6h-rgb-ufloat",e.BC6HRGBFloat="bc6h-rgb-float",e.BC7RGBAUnorm="bc7-rgba-unorm",e.BC7RGBAUnormSRGB="bc7-rgba-unorm-srgb",e.ETC2RGB8Unorm="etc2-rgb8unorm",e.ETC2RGB8UnormSRGB="etc2-rgb8unorm-srgb",e.ETC2RGB8A1Unorm="etc2-rgb8a1unorm",e.ETC2RGB8A1UnormSRGB="etc2-rgb8a1unorm-srgb",e.ETC2RGBA8Unorm="etc2-rgba8unorm",e.ETC2RGBA8UnormSRGB="etc2-rgba8unorm-srgb",e.EACR11Unorm="eac-r11unorm",e.EACR11Snorm="eac-r11snorm",e.EACRG11Unorm="eac-rg11unorm",e.EACRG11Snorm="eac-rg11snorm",e.ASTC4x4Unorm="astc-4x4-unorm",e.ASTC4x4UnormSRGB="astc-4x4-unorm-srgb",e.ASTC5x4Unorm="astc-5x4-unorm",e.ASTC5x4UnormSRGB="astc-5x4-unorm-srgb",e.ASTC5x5Unorm="astc-5x5-unorm",e.ASTC5x5UnormSRGB="astc-5x5-unorm-srgb",e.ASTC6x5Unorm="astc-6x5-unorm",e.ASTC6x5UnormSRGB="astc-6x5-unorm-srgb",e.ASTC6x6Unorm="astc-6x6-unorm",e.ASTC6x6UnormSRGB="astc-6x6-unorm-srgb",e.ASTC8x5Unorm="astc-8x5-unorm",e.ASTC8x5UnormSRGB="astc-8x5-unorm-srgb",e.ASTC8x6Unorm="astc-8x6-unorm",e.ASTC8x6UnormSRGB="astc-8x6-unorm-srgb",e.ASTC8x8Unorm="astc-8x8-unorm",e.ASTC8x8UnormSRGB="astc-8x8-unorm-srgb",e.ASTC10x5Unorm="astc-10x5-unorm",e.ASTC10x5UnormSRGB="astc-10x5-unorm-srgb",e.ASTC10x6Unorm="astc-10x6-unorm",e.ASTC10x6UnormSRGB="astc-10x6-unorm-srgb",e.ASTC10x8Unorm="astc-10x8-unorm",e.ASTC10x8UnormSRGB="astc-10x8-unorm-srgb",e.ASTC10x10Unorm="astc-10x10-unorm",e.ASTC10x10UnormSRGB="astc-10x10-unorm-srgb",e.ASTC12x10Unorm="astc-12x10-unorm",e.ASTC12x10UnormSRGB="astc-12x10-unorm-srgb",e.ASTC12x12Unorm="astc-12x12-unorm",e.ASTC12x12UnormSRGB="astc-12x12-unorm-srgb",e.Depth32FloatStencil8="depth32float-stencil8"}(gc||(gc={})),function(e){e.ClampToEdge="clamp-to-edge",e.Repeat="repeat",e.MirrorRepeat="mirror-repeat"}(vc||(vc={})),function(e){e.Nearest="nearest",e.Linear="linear"}(xc||(xc={})),function(e){e.Nearest="nearest",e.Linear="linear"}(Tc||(Tc={})),function(e){e.Never="never",e.Less="less",e.Equal="equal",e.LessEqual="less-equal",e.Greater="greater",e.NotEqual="not-equal",e.GreaterEqual="greater-equal",e.Always="always"}(Ec||(Ec={})),function(e){e[e.Vertex=1]="Vertex",e[e.Fragment=2]="Fragment",e[e.Compute=4]="Compute"}(Sc||(Sc={})),function(e){e.Uniform="uniform",e.Storage="storage",e.ReadOnlyStorage="read-only-storage"}(bc||(bc={})),function(e){e.Filtering="filtering",e.NonFiltering="non-filtering",e.Comparison="comparison"}(Cc||(Cc={})),function(e){e.Float="float",e.UnfilterableFloat="unfilterable-float",e.Depth="depth",e.Sint="sint",e.Uint="uint"}(yc||(yc={})),function(e){e.WriteOnly="write-only"}(Ac||(Ac={})),function(e){e.Error="error",e.Warning="warning",e.Info="info"}(Rc||(Rc={})),function(e){e.Validation="validation",e.Internal="internal"}(Ic||(Ic={})),function(e){e.Auto="auto"}(Pc||(Pc={})),function(e){e.PointList="point-list",e.LineList="line-list",e.LineStrip="line-strip",e.TriangleList="triangle-list",e.TriangleStrip="triangle-strip"}(Mc||(Mc={})),function(e){e.CCW="ccw",e.CW="cw"}(Oc||(Oc={})),function(e){e.None="none",e.Front="front",e.Back="back"}(Dc||(Dc={})),function(e){e[e.Red=1]="Red",e[e.Green=2]="Green",e[e.Blue=4]="Blue",e[e.Alpha=8]="Alpha",e[e.All=15]="All"}(Nc||(Nc={})),function(e){e.Zero="zero",e.One="one",e.Src="src",e.OneMinusSrc="one-minus-src",e.SrcAlpha="src-alpha",e.OneMinusSrcAlpha="one-minus-src-alpha",e.Dst="dst",e.OneMinusDst="one-minus-dst",e.DstAlpha="dst-alpha",e.OneMinusDstAlpha="one-minus-dst-alpha",e.SrcAlphaSaturated="src-alpha-saturated",e.Constant="constant",e.OneMinusConstant="one-minus-constant"}(Fc||(Fc={})),function(e){e.Add="add",e.Subtract="subtract",e.ReverseSubtract="reverse-subtract",e.Min="min",e.Max="max"}(wc||(wc={})),function(e){e.Keep="keep",e.Zero="zero",e.Replace="replace",e.Invert="invert",e.IncrementClamp="increment-clamp",e.DecrementClamp="decrement-clamp",e.IncrementWrap="increment-wrap",e.DecrementWrap="decrement-wrap"}(Lc||(Lc={})),function(e){e.Uint16="uint16",e.Uint32="uint32"}(Bc||(Bc={})),function(e){e.Uint8x2="uint8x2",e.Uint8x4="uint8x4",e.Sint8x2="sint8x2",e.Sint8x4="sint8x4",e.Unorm8x2="unorm8x2",e.Unorm8x4="unorm8x4",e.Snorm8x2="snorm8x2",e.Snorm8x4="snorm8x4",e.Uint16x2="uint16x2",e.Uint16x4="uint16x4",e.Sint16x2="sint16x2",e.Sint16x4="sint16x4",e.Unorm16x2="unorm16x2",e.Unorm16x4="unorm16x4",e.Snorm16x2="snorm16x2",e.Snorm16x4="snorm16x4",e.Float16x2="float16x2",e.Float16x4="float16x4",e.Float32="float32",e.Float32x2="float32x2",e.Float32x3="float32x3",e.Float32x4="float32x4",e.Uint32="uint32",e.Uint32x2="uint32x2",e.Uint32x3="uint32x3",e.Uint32x4="uint32x4",e.Sint32="sint32",e.Sint32x2="sint32x2",e.Sint32x3="sint32x3",e.Sint32x4="sint32x4",e.UNORM10x10x10x2="unorm10-10-10-2"}(Uc||(Uc={})),function(e){e.Vertex="vertex",e.Instance="instance"}(Vc||(Vc={})),function(e){e.Beginning="beginning",e.End="end"}(kc||(kc={})),function(e){e.Beginning="beginning",e.End="end"}(Gc||(Gc={})),function(e){e.Load="load",e.Clear="clear"}(zc||(zc={})),function(e){e.Store="store",e.Discard="discard"}(Wc||(Wc={})),function(e){e.Occlusion="occlusion",e.Timestamp="timestamp"}(Hc||(Hc={})),function(e){e.Opaque="opaque",e.Premultiplied="premultiplied"}(Xc||(Xc={})),function(e){e.Unknown="unknown",e.Destroyed="destroyed"}(Yc||(Yc={})),function(e){e.Validation="validation",e.OutOfMemory="out-of-memory",e.Internal="internal"}(jc||(jc={}));class Kc{constructor(){this.shaderLanguage=qe.GLSL,this.vertexBufferKindToNumberOfComponents={}}_addUniformToLeftOverUBO(e,t,i){let s=0;[e,t,s]=this._getArraySize(e,t,i);for(let t=0;t<this._webgpuProcessingContext.leftOverUniforms.length;t++)if(this._webgpuProcessingContext.leftOverUniforms[t].name===e)return;this._webgpuProcessingContext.leftOverUniforms.push({name:e,type:t,length:s})}_buildLeftOverUBO(){if(!this._webgpuProcessingContext.leftOverUniforms.length)return"";const e=Kc.LeftOvertUBOName;let t=this._webgpuProcessingContext.availableBuffers[e];return t||(t={binding:this._webgpuProcessingContext.getNextFreeUBOBinding()},this._webgpuProcessingContext.availableBuffers[e]=t,this._addBufferBindingDescription(e,t,bc.Uniform,!0),this._addBufferBindingDescription(e,t,bc.Uniform,!1)),this._generateLeftOverUBOCode(e,t)}_collectBindingNames(){for(let e=0;e<this._webgpuProcessingContext.bindGroupLayoutEntries.length;e++){const t=this._webgpuProcessingContext.bindGroupLayoutEntries[e];if(void 0!==t)for(let i=0;i<t.length;i++){const t=this._webgpuProcessingContext.bindGroupLayoutEntries[e][i],s=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][t.binding].name,r=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][t.binding].nameInArrayOfTexture;t&&(t.texture||t.externalTexture||t.storageTexture?this._webgpuProcessingContext.textureNames.push(r):t.sampler?this._webgpuProcessingContext.samplerNames.push(s):t.buffer&&this._webgpuProcessingContext.bufferNames.push(s))}else this._webgpuProcessingContext.bindGroupLayoutEntries[e]=[]}}_preCreateBindGroupEntries(){const e=this._webgpuProcessingContext.bindGroupEntries;for(let t=0;t<this._webgpuProcessingContext.bindGroupLayoutEntries.length;t++){const i=this._webgpuProcessingContext.bindGroupLayoutEntries[t],s=[];for(let e=0;e<i.length;e++){const i=this._webgpuProcessingContext.bindGroupLayoutEntries[t][e];i.sampler||i.texture||i.storageTexture||i.externalTexture?s.push({binding:i.binding,resource:void 0}):i.buffer&&s.push({binding:i.binding,resource:{buffer:void 0,offset:0,size:0}})}e[t]=s}}_addTextureBindingDescription(e,t,i,s,r,n){let{groupIndex:o,bindingIndex:a}=t.textures[i];if(this._webgpuProcessingContext.bindGroupLayoutEntries[o]||(this._webgpuProcessingContext.bindGroupLayoutEntries[o]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o][a]){let n;n=null===s?this._webgpuProcessingContext.bindGroupLayoutEntries[o].push({binding:a,visibility:0,externalTexture:{}}):r?this._webgpuProcessingContext.bindGroupLayoutEntries[o].push({binding:a,visibility:0,storageTexture:{access:Ac.WriteOnly,format:r,viewDimension:s}}):this._webgpuProcessingContext.bindGroupLayoutEntries[o].push({binding:a,visibility:0,texture:{sampleType:t.sampleType,viewDimension:s,multisampled:!1}});const l=t.isTextureArray?e+i:e;this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o][a]={name:e,index:n-1,nameInArrayOfTexture:l}}a=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o][a].index,this._webgpuProcessingContext.bindGroupLayoutEntries[o][a].visibility|=n?Sc.Vertex:Sc.Fragment}_addSamplerBindingDescription(e,t,i){let{groupIndex:s,bindingIndex:r}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[s]||(this._webgpuProcessingContext.bindGroupLayoutEntries[s]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][r]){const i=this._webgpuProcessingContext.bindGroupLayoutEntries[s].push({binding:r,visibility:0,sampler:{type:t.type}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][r]={name:e,index:i-1}}r=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][r].index,this._webgpuProcessingContext.bindGroupLayoutEntries[s][r].visibility|=i?Sc.Vertex:Sc.Fragment}_addBufferBindingDescription(e,t,i,s){let{groupIndex:r,bindingIndex:n}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[r]||(this._webgpuProcessingContext.bindGroupLayoutEntries[r]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][n]){const t=this._webgpuProcessingContext.bindGroupLayoutEntries[r].push({binding:n,visibility:0,buffer:{type:i}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][n]={name:e,index:t-1}}n=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][n].index,this._webgpuProcessingContext.bindGroupLayoutEntries[r][n].visibility|=s?Sc.Vertex:Sc.Fragment}_injectStartingAndEndingCode(e,t,i,s){let r=e.indexOf(t);if(r<0)return console.error('No "main" function found in shader code! Processing aborted.'),e;if(i){for(;r++<e.length&&"{"!=e.charAt(r););if(r<e.length){const t=e.substring(0,r+1),s=e.substring(r+1);e=t+i+s}}if(s){const t=e.lastIndexOf("}");e=e.substring(0,t),e+=s+"\n}"}return e}}Kc.AutoSamplerSuffix="Sampler",Kc.LeftOvertUBOName="LeftOver",Kc.InternalsUBOName="Internals",Kc.UniformSizes={bool:1,int:1,float:1,vec2:2,ivec2:2,uvec2:2,vec3:3,ivec3:3,uvec3:3,vec4:4,ivec4:4,uvec4:4,mat2:4,mat3:12,mat4:16,i32:1,u32:1,f32:1,mat2x2:4,mat3x3:12,mat4x4:16},Kc._SamplerFunctionByWebGLSamplerType={sampler2D:"sampler2D",sampler2DArray:"sampler2DArray",sampler2DShadow:"sampler2DShadow",sampler2DArrayShadow:"sampler2DArrayShadow",samplerCube:"samplerCube",sampler3D:"sampler3D"},Kc._TextureTypeByWebGLSamplerType={sampler2D:"texture2D",sampler2DArray:"texture2DArray",sampler2DShadow:"texture2D",sampler2DArrayShadow:"texture2DArray",samplerCube:"textureCube",samplerCubeArray:"textureCubeArray",sampler3D:"texture3D"},Kc._GpuTextureViewDimensionByWebGPUTextureType={textureCube:fc.Cube,textureCubeArray:fc.CubeArray,texture2D:fc.E2d,texture2DArray:fc.E2dArray,texture3D:fc.E3d},Kc._SamplerTypeByWebGLSamplerType={sampler2DShadow:"samplerShadow",sampler2DArrayShadow:"samplerShadow"},Kc._IsComparisonSamplerByWebGPUSamplerType={samplerShadow:!0,samplerArrayShadow:!0,sampler:!1};class $c{get isAsync(){return!1}get isReady(){return!!this.stages}constructor(e,t){this.bindGroupLayouts={},this._name="unnamed",this.shaderProcessingContext=e,this._leftOverUniformsByName={},this.engine=t,this.vertexBufferKindToType={}}_handlesSpectorRebuildCallback(){}_fillEffectInformation(e,t,i,s,r,n,o,a){const l=this.engine;e._fragmentSourceCode="",e._vertexSourceCode="";const h=this.shaderProcessingContext.availableTextures;let c;for(c=0;c<r.length;c++){const e=r[c],t=h[r[c]];null==t||null==t?(r.splice(c,1),c--):n[e]=c}for(const e of l.getAttributes(this,o))a.push(e);this.buildUniformLayout();const u=[],d=[];for(c=0;c<o.length;c++){const e=a[c];e>=0&&(u.push(o[c]),d.push(e))}this.shaderProcessingContext.attributeNamesFromEffect=u,this.shaderProcessingContext.attributeLocationsFromEffect=d}buildUniformLayout(){if(this.shaderProcessingContext.leftOverUniforms.length){this.uniformBuffer=new ai(this.engine,void 0,void 0,"leftOver-"+this._name);for(const e of this.shaderProcessingContext.leftOverUniforms){const t=e.type.replace(/^(.*?)(<.*>)?$/,"$1"),i=Kc.UniformSizes[t];this.uniformBuffer.addUniform(e.name,i,e.length),this._leftOverUniformsByName[e.name]=e.type}this.uniformBuffer.create()}}dispose(){this.uniformBuffer&&this.uniformBuffer.dispose()}setInt(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt(e,t)}setInt2(e,t,i){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt2(e,t,i)}setInt3(e,t,i,s){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt3(e,t,i,s)}setInt4(e,t,i,s,r){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt4(e,t,i,s,r)}setIntArray(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateIntArray(e,t)}setIntArray2(e,t){this.setIntArray(e,t)}setIntArray3(e,t){this.setIntArray(e,t)}setIntArray4(e,t){this.setIntArray(e,t)}setUInt(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt(e,t)}setUInt2(e,t,i){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt2(e,t,i)}setUInt3(e,t,i,s){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt3(e,t,i,s)}setUInt4(e,t,i,s,r){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt4(e,t,i,s,r)}setUIntArray(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUIntArray(e,t)}setUIntArray2(e,t){this.setUIntArray(e,t)}setUIntArray3(e,t){this.setUIntArray(e,t)}setUIntArray4(e,t){this.setUIntArray(e,t)}setArray(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateArray(e,t)}setArray2(e,t){this.setArray(e,t)}setArray3(e,t){this.setArray(e,t)}setArray4(e,t){this.setArray(e,t)}setMatrices(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrices(e,t)}setMatrix(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrix(e,t)}setMatrix3x3(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrix3x3(e,t)}setMatrix2x2(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrix2x2(e,t)}setFloat(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat(e,t)}setVector2(e,t){this.setFloat2(e,t.x,t.y)}setFloat2(e,t,i){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat2(e,t,i)}setVector3(e,t){this.setFloat3(e,t.x,t.y,t.z)}setFloat3(e,t,i,s){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat3(e,t,i,s)}setVector4(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setQuaternion(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setFloat4(e,t,i,s,r){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat4(e,t,i,s,r)}setColor3(e,t){this.setFloat3(e,t.r,t.g,t.b)}setColor4(e,t,i){this.setFloat4(e,t.r,t.g,t.b,i)}setDirectColor4(e,t){this.setFloat4(e,t.r,t.g,t.b,t.a)}_getVertexShaderCode(){var e;return null===(e=this.sources)||void 0===e?void 0:e.vertex}_getFragmentShaderCode(){var e;return null===(e=this.sources)||void 0===e?void 0:e.fragment}}const qc={mat2:2,mat3:3,mat4:4,mat2x2:2,mat3x3:3,mat4x4:4};class Qc{static get KnownUBOs(){return Qc._SimplifiedKnownBindings?Qc._SimplifiedKnownUBOs:Qc._KnownUBOs}constructor(e){this.shaderLanguage=e,this._attributeNextLocation=0,this._varyingNextLocation=0,this.freeGroupIndex=0,this.freeBindingIndex=0,this.availableVaryings={},this.availableAttributes={},this.availableBuffers={},this.availableTextures={},this.availableSamplers={},this.orderedAttributes=[],this.bindGroupLayoutEntries=[],this.bindGroupLayoutEntryInfo=[],this.bindGroupEntries=[],this.bufferNames=[],this.textureNames=[],this.samplerNames=[],this.leftOverUniforms=[],this._findStartingGroupBinding()}_findStartingGroupBinding(){const e=Qc.KnownUBOs,t=[];for(const i in e){const s=e[i].binding;-1!==s.groupIndex&&(void 0===t[s.groupIndex]?t[s.groupIndex]=s.bindingIndex:t[s.groupIndex]=Math.max(t[s.groupIndex],s.bindingIndex))}this.freeGroupIndex=t.length-1,0===this.freeGroupIndex?(this.freeGroupIndex++,this.freeBindingIndex=0):this.freeBindingIndex=t[t.length-1]+1}getAttributeNextLocation(e,t=0){var i;const s=this._attributeNextLocation;return this._attributeNextLocation+=(null!==(i=qc[e])&&void 0!==i?i:1)*(t||1),s}getVaryingNextLocation(e,t=0){var i;const s=this._varyingNextLocation;return this._varyingNextLocation+=(null!==(i=qc[e])&&void 0!==i?i:1)*(t||1),s}getNextFreeUBOBinding(){return this._getNextFreeBinding(1)}_getNextFreeBinding(e){if(this.freeBindingIndex>65536-e&&(this.freeGroupIndex++,this.freeBindingIndex=0),4===this.freeGroupIndex)throw"Too many textures or UBOs have been declared and it is not supported in WebGPU.";const t={groupIndex:this.freeGroupIndex,bindingIndex:this.freeBindingIndex};return this.freeBindingIndex+=e,t}}Qc._SimplifiedKnownBindings=!0,Qc._SimplifiedKnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:-1,bindingIndex:-1}},Light1:{binding:{groupIndex:-1,bindingIndex:-1}},Light2:{binding:{groupIndex:-1,bindingIndex:-1}},Light3:{binding:{groupIndex:-1,bindingIndex:-1}},Light4:{binding:{groupIndex:-1,bindingIndex:-1}},Light5:{binding:{groupIndex:-1,bindingIndex:-1}},Light6:{binding:{groupIndex:-1,bindingIndex:-1}},Light7:{binding:{groupIndex:-1,bindingIndex:-1}},Light8:{binding:{groupIndex:-1,bindingIndex:-1}},Light9:{binding:{groupIndex:-1,bindingIndex:-1}},Light10:{binding:{groupIndex:-1,bindingIndex:-1}},Light11:{binding:{groupIndex:-1,bindingIndex:-1}},Light12:{binding:{groupIndex:-1,bindingIndex:-1}},Light13:{binding:{groupIndex:-1,bindingIndex:-1}},Light14:{binding:{groupIndex:-1,bindingIndex:-1}},Light15:{binding:{groupIndex:-1,bindingIndex:-1}},Light16:{binding:{groupIndex:-1,bindingIndex:-1}},Light17:{binding:{groupIndex:-1,bindingIndex:-1}},Light18:{binding:{groupIndex:-1,bindingIndex:-1}},Light19:{binding:{groupIndex:-1,bindingIndex:-1}},Light20:{binding:{groupIndex:-1,bindingIndex:-1}},Light21:{binding:{groupIndex:-1,bindingIndex:-1}},Light22:{binding:{groupIndex:-1,bindingIndex:-1}},Light23:{binding:{groupIndex:-1,bindingIndex:-1}},Light24:{binding:{groupIndex:-1,bindingIndex:-1}},Light25:{binding:{groupIndex:-1,bindingIndex:-1}},Light26:{binding:{groupIndex:-1,bindingIndex:-1}},Light27:{binding:{groupIndex:-1,bindingIndex:-1}},Light28:{binding:{groupIndex:-1,bindingIndex:-1}},Light29:{binding:{groupIndex:-1,bindingIndex:-1}},Light30:{binding:{groupIndex:-1,bindingIndex:-1}},Light31:{binding:{groupIndex:-1,bindingIndex:-1}},Material:{binding:{groupIndex:-1,bindingIndex:-1}},Mesh:{binding:{groupIndex:-1,bindingIndex:-1}},Internals:{binding:{groupIndex:-1,bindingIndex:-1}}},Qc._KnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:1,bindingIndex:0}},Light1:{binding:{groupIndex:1,bindingIndex:1}},Light2:{binding:{groupIndex:1,bindingIndex:2}},Light3:{binding:{groupIndex:1,bindingIndex:3}},Light4:{binding:{groupIndex:1,bindingIndex:4}},Light5:{binding:{groupIndex:1,bindingIndex:5}},Light6:{binding:{groupIndex:1,bindingIndex:6}},Light7:{binding:{groupIndex:1,bindingIndex:7}},Light8:{binding:{groupIndex:1,bindingIndex:8}},Light9:{binding:{groupIndex:1,bindingIndex:9}},Light10:{binding:{groupIndex:1,bindingIndex:10}},Light11:{binding:{groupIndex:1,bindingIndex:11}},Light12:{binding:{groupIndex:1,bindingIndex:12}},Light13:{binding:{groupIndex:1,bindingIndex:13}},Light14:{binding:{groupIndex:1,bindingIndex:14}},Light15:{binding:{groupIndex:1,bindingIndex:15}},Light16:{binding:{groupIndex:1,bindingIndex:16}},Light17:{binding:{groupIndex:1,bindingIndex:17}},Light18:{binding:{groupIndex:1,bindingIndex:18}},Light19:{binding:{groupIndex:1,bindingIndex:19}},Light20:{binding:{groupIndex:1,bindingIndex:20}},Light21:{binding:{groupIndex:1,bindingIndex:21}},Light22:{binding:{groupIndex:1,bindingIndex:22}},Light23:{binding:{groupIndex:1,bindingIndex:23}},Light24:{binding:{groupIndex:1,bindingIndex:24}},Light25:{binding:{groupIndex:1,bindingIndex:25}},Light26:{binding:{groupIndex:1,bindingIndex:26}},Light27:{binding:{groupIndex:1,bindingIndex:27}},Light28:{binding:{groupIndex:1,bindingIndex:28}},Light29:{binding:{groupIndex:1,bindingIndex:29}},Light30:{binding:{groupIndex:1,bindingIndex:30}},Light31:{binding:{groupIndex:1,bindingIndex:31}},Material:{binding:{groupIndex:2,bindingIndex:0}},Mesh:{binding:{groupIndex:2,bindingIndex:1}},Internals:{binding:{groupIndex:2,bindingIndex:2}}};class Zc extends Kc{constructor(){super(...arguments),this._missingVaryings=[],this._textureArrayProcessing=[],this._vertexIsGLES3=!1,this._fragmentIsGLES3=!1,this.shaderLanguage=qe.GLSL,this.parseGLES3=!0}_getArraySize(e,t,i){let s=0;const r=e.indexOf("["),n=e.indexOf("]");if(r>0&&n>0){const t=e.substring(r+1,n);s=+t,isNaN(s)&&(s=+i[t.trim()]),e=e.substr(0,r)}return[e,t,s]}initializeShaders(e){this._webgpuProcessingContext=e,this._missingVaryings.length=0,this._textureArrayProcessing.length=0,this.attributeKeywordName=void 0,this.varyingVertexKeywordName=void 0,this.varyingFragmentKeywordName=void 0}preProcessShaderCode(e,t){const i=`// Internals UBO\nuniform ${Kc.InternalsUBOName} {\nfloat yFactor_;\nfloat textureOutputHeight_;\n};\n`,s=-1!==e.indexOf("// Internals UBO");return t?(this._fragmentIsGLES3=-1!==e.indexOf("#version 3"),this._fragmentIsGLES3&&(this.varyingFragmentKeywordName="in"),s?e:i+"##INJECTCODE##\n"+e):(this._vertexIsGLES3=-1!==e.indexOf("#version 3"),this._vertexIsGLES3&&(this.attributeKeywordName="in",this.varyingVertexKeywordName="out"),s?e:i+e)}varyingCheck(e,t){return(t&&this._fragmentIsGLES3?/(flat\s)?\s*\bin\b/:!t&&this._vertexIsGLES3?/(flat\s)?\s*\bout\b/:/(flat\s)?\s*\bvarying\b/).test(e)}varyingProcessor(e,t,i){var s;this._preProcessors=i;const r=(t&&this._fragmentIsGLES3?/\s*(flat)?\s*in\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm:!t&&this._vertexIsGLES3?/\s*(flat)?\s*out\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm:/\s*(flat)?\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm).exec(e);if(null!==r){const n=null!==(s=r[1])&&void 0!==s?s:"",o=r[2],a=r[3];let l;t?(l=this._webgpuProcessingContext.availableVaryings[a],this._missingVaryings[l]="",void 0===l&&k.Warn(`Invalid fragment shader: The varying named "${a}" is not declared in the vertex shader! This declaration will be ignored.`)):(l=this._webgpuProcessingContext.getVaryingNextLocation(o,this._getArraySize(a,o,i)[2]),this._webgpuProcessingContext.availableVaryings[a]=l,this._missingVaryings[l]=`layout(location = ${l}) ${n} in ${o} ${a};`),e=e.replace(r[0],void 0===l?"":`layout(location = ${l}) ${n} ${t?"in":"out"} ${o} ${a};`)}return e}attributeProcessor(e,t){this._preProcessors=t;const i=(this._vertexIsGLES3?/\s*in\s+(\S+)\s+(\S+)\s*;/gm:/\s*attribute\s+(\S+)\s+(\S+)\s*;/gm).exec(e);if(null!==i){const s=i[1],r=i[2],n=this._webgpuProcessingContext.getAttributeNextLocation(s,this._getArraySize(r,s,t)[2]);this._webgpuProcessingContext.availableAttributes[r]=n,this._webgpuProcessingContext.orderedAttributes[n]=r;const o=this.vertexBufferKindToNumberOfComponents[r];if(void 0!==o){const t=o<0?-1===o?"int":"ivec"+-o:1===o?"uint":"uvec"+o,a=`_int_${r}_`;e=e.replace(i[0],`layout(location = ${n}) in ${t} ${a}; ${s} ${r} = ${s}(${a});`)}else e=e.replace(i[0],`layout(location = ${n}) in ${s} ${r};`)}return e}uniformProcessor(e,t,i){var s;this._preProcessors=i;const r=/\s*uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm.exec(e);if(null!==r){let n=r[1],o=r[2];if(0===n.indexOf("sampler")||1===n.indexOf("sampler")){let r=0;[o,n,r]=this._getArraySize(o,n,i);let a=this._webgpuProcessingContext.availableTextures[o];if(!a){a={autoBindSampler:!0,isTextureArray:r>0,isStorageTexture:!1,textures:[],sampleType:yc.Float};for(let e=0;e<(r||1);++e)a.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}const l=null!==(s=Kc._SamplerTypeByWebGLSamplerType[n])&&void 0!==s?s:"sampler",h=!!Kc._IsComparisonSamplerByWebGPUSamplerType[l],c=h?Cc.Comparison:Cc.Filtering,u=o+Kc.AutoSamplerSuffix;let d=this._webgpuProcessingContext.availableSamplers[u];d||(d={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:c});const p="u"===n.charAt(0)?"u":"i"===n.charAt(0)?"i":"";p&&(n=n.substr(1));const _=h?yc.Depth:"u"===p?yc.Uint:"i"===p?yc.Sint:yc.Float;a.sampleType=_;const f=r>0,m=d.binding.groupIndex,g=d.binding.bindingIndex,v=Kc._SamplerFunctionByWebGLSamplerType[n],x=Kc._TextureTypeByWebGLSamplerType[n],T=Kc._GpuTextureViewDimensionByWebGPUTextureType[x];if(f){const t=[];t.push(`layout(set = ${m}, binding = ${g}) uniform ${p}${l} ${u};`),e="\n";for(let i=0;i<r;++i){const s=a.textures[i].groupIndex,r=a.textures[i].bindingIndex;t.push(`layout(set = ${s}, binding = ${r}) uniform ${x} ${o}Texture${i};`),e+=`${i>0?"\n":""}#define ${o}${i} ${p}${v}(${o}Texture${i}, ${u})`}e=t.join("\n")+e,this._textureArrayProcessing.push(o)}else r=1,e=`layout(set = ${m}, binding = ${g}) uniform ${l} ${u};\n                        layout(set = ${a.textures[0].groupIndex}, binding = ${a.textures[0].bindingIndex}) uniform ${p}${x} ${o}Texture;\n                        #define ${o} ${p}${v}(${o}Texture, ${u})`;this._webgpuProcessingContext.availableTextures[o]=a,this._webgpuProcessingContext.availableSamplers[u]=d,this._addSamplerBindingDescription(u,d,!t);for(let e=0;e<r;++e)this._addTextureBindingDescription(o,a,e,T,null,!t)}else this._addUniformToLeftOverUBO(o,n,i),e=""}return e}uniformBufferProcessor(e,t){const i=/uniform\s+(\w+)/gm.exec(e);if(null!==i){const s=i[1];let r=this._webgpuProcessingContext.availableBuffers[s];if(!r){const e=Qc.KnownUBOs[s];let t;t=e&&-1!==e.binding.groupIndex?e.binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),r={binding:t},this._webgpuProcessingContext.availableBuffers[s]=r}this._addBufferBindingDescription(s,r,bc.Uniform,!t),e=e.replace("uniform",`layout(set = ${r.binding.groupIndex}, binding = ${r.binding.bindingIndex}) uniform`)}return e}postProcessor(e,t,i,s,r){const n=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),i){const t=e.indexOf("gl_FragCoord")>=0,i="\n                glFragCoord_ = gl_FragCoord;\n                if (yFactor_ == 1.) {\n                    glFragCoord_.y = textureOutputHeight_ - glFragCoord_.y;\n                }\n            ",s=t?"vec4 glFragCoord_;\n":"",r=-1!==e.search(/layout *\(location *= *0\) *out/g);if(e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/gl_FragCoord/g,"glFragCoord_"),this._fragmentIsGLES3){const t=/^\s*out\s+\S+\s+\S+\s*;/gm.exec(e);null!==t&&(e=e.substring(0,t.index)+"layout(location = 0) "+e.substring(t.index))}else e=e.replace(/void\s+?main\s*\(/g,(n||r?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(");e=(e=e.replace(/dFdy/g,"(-yFactor_)*dFdy")).replace("##INJECTCODE##",s),t&&(e=this._injectStartingAndEndingCode(e,"void main",i))}else if(e=(e=e.replace(/gl_InstanceID/g,"gl_InstanceIndex")).replace(/gl_VertexID/g,"gl_VertexIndex"),-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e;if(!i){const t=e.lastIndexOf("}");e=e.substring(0,t),e+="gl_Position.y *= yFactor_;\n",r.isNDCHalfZRange||(e+="gl_Position.z = (gl_Position.z + gl_Position.w) / 2.0;\n"),e+="}"}return e}_applyTextureArrayProcessing(e,t){const i=new RegExp(t+"\\s*\\[(.+)?\\]","gm");let s=i.exec(e);for(;null!==s;){const r=s[1];let n=+r;this._preProcessors&&isNaN(n)&&(n=+this._preProcessors[r.trim()]),e=e.replace(s[0],t+n),s=i.exec(e)}return e}_generateLeftOverUBOCode(e,t){let i=`layout(set = ${t.binding.groupIndex}, binding = ${t.binding.bindingIndex}) uniform ${e} {\n    `;for(const e of this._webgpuProcessingContext.leftOverUniforms)e.length>0?i+=`    ${e.type} ${e.name}[${e.length}];\n`:i+=`    ${e.type} ${e.name};\n`;return i+="};\n\n",i}finalizeShaders(e,t){for(let i=0;i<this._textureArrayProcessing.length;++i){const s=this._textureArrayProcessing[i];e=this._applyTextureArrayProcessing(e,s),t=this._applyTextureArrayProcessing(t,s)}for(let e=0;e<this._missingVaryings.length;++e){const i=this._missingVaryings[e];i&&i.length>0&&(t=i+"\n"+t)}const i=this._buildLeftOverUBO();return e=i+e,t=i+t,this._collectBindingNames(),this._preCreateBindGroupEntries(),this._preProcessors=null,this.vertexBufferKindToNumberOfComponents={},{vertexCode:e,fragmentCode:t}}}nt.IncludesShadersStoreWGSL.bonesDeclaration="#if NUM_BONE_INFLUENCERS>0\nattribute matricesIndices : vec4<f32>;attribute matricesWeights : vec4<f32>;\n#if NUM_BONE_INFLUENCERS>4\nattribute matricesIndicesExtra : vec4<f32>;attribute matricesWeightsExtra : vec4<f32>;\n#endif\n#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#ifdef BONETEXTURE\nvar boneSampler : texture_2d<f32>;uniform boneTextureWidth : f32;\n#else\nuniform mBones : array<mat4x4,BonesPerMesh>;\n#ifdef BONES_VELOCITY_ENABLED\nuniform mPreviousBones : array<mat4x4,BonesPerMesh>;\n#endif\n#endif\n#ifdef BONETEXTURE\nfn readMatrixFromRawSampler(smp : texture_2d<f32>,index : f32)->mat4x4<f32>\n{let offset=i32(index) *4; \nlet m0=textureLoad(smp,vec2<i32>(offset+0,0),0);let m1=textureLoad(smp,vec2<i32>(offset+1,0),0);let m2=textureLoad(smp,vec2<i32>(offset+2,0),0);let m3=textureLoad(smp,vec2<i32>(offset+3,0),0);return mat4x4<f32>(m0,m1,m2,m3);}\n#endif\n#endif\n#endif\n";nt.IncludesShadersStoreWGSL.bonesVertex="#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#if NUM_BONE_INFLUENCERS>0\nvar influence : mat4x4<f32>;\n#ifdef BONETEXTURE\ninfluence=readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[0])*vertexInputs.matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[1])*vertexInputs.matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[2])*vertexInputs.matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[3])*vertexInputs.matricesWeights[3];\n#endif \n#if NUM_BONE_INFLUENCERS>4\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[0])*vertexInputs.matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[1])*vertexInputs.matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[2])*vertexInputs.matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[3])*vertexInputs.matricesWeightsExtra[3];\n#endif \n#else \ninfluence=uniforms.mBones[int(vertexInputs.matricesIndices[0])]*vertexInputs.matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndices[1])]*vertexInputs.matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndices[2])]*vertexInputs.matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndices[3])]*vertexInputs.matricesWeights[3];\n#endif \n#if NUM_BONE_INFLUENCERS>4\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[0])]*vertexInputs.matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[1])]*vertexInputs.matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[2])]*vertexInputs.matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[3])]*vertexInputs.matricesWeightsExtra[3];\n#endif \n#endif\nfinalWorld=finalWorld*influence;\n#endif\n#endif\n";nt.IncludesShadersStoreWGSL.bakedVertexAnimationDeclaration="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\nuniform bakedVertexAnimationTime: f32;uniform bakedVertexAnimationTextureSizeInverted: vec2<f32>;uniform bakedVertexAnimationSettings: vec4<f32>;var bakedVertexAnimationTexture : texture_2d<f32>;\n#ifdef INSTANCES\nattribute bakedVertexAnimationSettingsInstanced : vec4<f32>;\n#endif\nfn readMatrixFromRawSamplerVAT(smp : texture_2d<f32>,index : f32,frame : f32)->mat4x4<f32>\n{let offset=i32(index)*4;let frameUV=i32(frame);let m0=textureLoad(smp,vec2<i32>(offset+0,frameUV),0);let m1=textureLoad(smp,vec2<i32>(offset+1,frameUV),0);let m2=textureLoad(smp,vec2<i32>(offset+2,frameUV),0);let m3=textureLoad(smp,vec2<i32>(offset+3,frameUV),0);return mat4x4<f32>(m0,m1,m2,m3);}\n#endif\n";nt.IncludesShadersStoreWGSL.bakedVertexAnimation="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\n{\n#ifdef INSTANCES\nlet VATStartFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.x;let VATEndFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.y;let VATOffsetFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.z;let VATSpeed: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.w;\n#else\nlet VATStartFrame: f32=uniforms.bakedVertexAnimationSettings.x;let VATEndFrame: f32=uniforms.bakedVertexAnimationSettings.y;let VATOffsetFrame: f32=uniforms.bakedVertexAnimationSettings.z;let VATSpeed: f32=uniforms.bakedVertexAnimationSettings.w;\n#endif\nlet totalFrames: f32=VATEndFrame-VATStartFrame+1.0;let time: f32=uniforms.bakedVertexAnimationTime*VATSpeed/totalFrames;let frameCorrection: f32=select(1.0,0.0,time<1.0);let numOfFrames: f32=totalFrames-frameCorrection;var VATFrameNum: f32=fract(time)*numOfFrames;VATFrameNum=(VATFrameNum+VATOffsetFrame) % numOfFrames;VATFrameNum=floor(VATFrameNum);VATFrameNum=VATFrameNum+VATStartFrame+frameCorrection;var VATInfluence : mat4x4<f32>;VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[0],VATFrameNum)*vertexInputs.matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[1],VATFrameNum)*vertexInputs.matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[2],VATFrameNum)*vertexInputs.matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[3],VATFrameNum)*vertexInputs.matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[0],VATFrameNum)*vertexInputs.matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[1],VATFrameNum)*vertexInputs.matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[2],VATFrameNum)*vertexInputs.matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[3],VATFrameNum)*vertexInputs.matricesWeightsExtra[3];\n#endif\nfinalWorld=finalWorld*VATInfluence;}\n#endif\n";nt.IncludesShadersStoreWGSL.clipPlaneFragment="#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nif (false) {}\n#endif\n#ifdef CLIPPLANE\nelse if (fragmentInputs.fClipDistance>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE2\nelse if (fragmentInputs.fClipDistance2>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE3\nelse if (fragmentInputs.fClipDistance3>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE4\nelse if (fragmentInputs.fClipDistance4>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE5\nelse if (fragmentInputs.fClipDistance5>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE6\nelse if (fragmentInputs.fClipDistance6>0.0)\n{discard;}\n#endif\n";nt.IncludesShadersStoreWGSL.clipPlaneFragmentDeclaration="#ifdef CLIPPLANE\nvarying fClipDistance: f32;\n#endif\n#ifdef CLIPPLANE2\nvarying fClipDistance2: f32;\n#endif\n#ifdef CLIPPLANE3\nvarying fClipDistance3: f32;\n#endif\n#ifdef CLIPPLANE4\nvarying fClipDistance4: f32;\n#endif\n#ifdef CLIPPLANE5\nvarying fClipDistance5: f32;\n#endif\n#ifdef CLIPPLANE6\nvarying fClipDistance6: f32;\n#endif\n";nt.IncludesShadersStoreWGSL.clipPlaneVertex="#ifdef CLIPPLANE\nvertexOutputs.fClipDistance=dot(worldPos,uniforms.vClipPlane);\n#endif\n#ifdef CLIPPLANE2\nvertexOutputs.fClipDistance2=dot(worldPos,uniforms.vClipPlane2);\n#endif\n#ifdef CLIPPLANE3\nvertexOutputs.fClipDistance3=dot(worldPos,uniforms.vClipPlane3);\n#endif\n#ifdef CLIPPLANE4\nvertexOutputs.fClipDistance4=dot(worldPos,uniforms.vClipPlane4);\n#endif\n#ifdef CLIPPLANE5\nvertexOutputs.fClipDistance5=dot(worldPos,uniforms.vClipPlane5);\n#endif\n#ifdef CLIPPLANE6\nvertexOutputs.fClipDistance6=dot(worldPos,uniforms.vClipPlane6);\n#endif\n";nt.IncludesShadersStoreWGSL.clipPlaneVertexDeclaration="#ifdef CLIPPLANE\nuniform vClipPlane: vec4<f32>;varying fClipDistance: f32;\n#endif\n#ifdef CLIPPLANE2\nuniform vClipPlane2: vec4<f32>;varying fClipDistance2: f32;\n#endif\n#ifdef CLIPPLANE3\nuniform vClipPlane3: vec4<f32>;varying fClipDistance3: f32;\n#endif\n#ifdef CLIPPLANE4\nuniform vClipPlane4: vec4<f32>;varying fClipDistance4: f32;\n#endif\n#ifdef CLIPPLANE5\nuniform vClipPlane5: vec4<f32>;varying fClipDistance5: f32;\n#endif\n#ifdef CLIPPLANE6\nuniform vClipPlane6: vec4<f32>;varying fClipDistance6: f32;\n#endif\n";nt.IncludesShadersStoreWGSL.instancesDeclaration="#ifdef INSTANCES\nattribute world0 : vec4<f32>;attribute world1 : vec4<f32>;attribute world2 : vec4<f32>;attribute world3 : vec4<f32>;\n#ifdef INSTANCESCOLOR\nattribute instanceColor : vec4<f32>;\n#endif\n#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)\nuniform world : mat4x4<f32>;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY)\nattribute previousWorld0 : vec4<f32>;attribute previousWorld1 : vec4<f32>;attribute previousWorld2 : vec4<f32>;attribute previousWorld3 : vec4<f32>;\n#ifdef THIN_INSTANCES\nuniform previousWorld : mat4x4<f32>;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nuniform world : mat4x4<f32>;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY)\nuniform previousWorld : mat4x4<f32>;\n#endif\n#endif\n";nt.IncludesShadersStoreWGSL.instancesVertex="#ifdef INSTANCES\nvar finalWorld=mat4x4<f32>(vertexInputs.world0,vertexInputs.world1,vertexInputs.world2,vertexInputs.world3);\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nvar finalPreviousWorld=mat4x4<f32>(previousWorld0,previousWorld1,previousWorld2,previousWorld3);\n#endif\n#ifdef THIN_INSTANCES\n#if !defined(WORLD_UBO)\nfinalWorld=uniforms.world*finalWorld;\n#else\nfinalWorld=mesh.world*finalWorld;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nfinalPreviousWorld=previousWorld*finalPreviousWorld;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nvar finalWorld=uniforms.world;\n#else\nvar finalWorld=mesh.world;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nvar finalPreviousWorld=previousWorld;\n#endif\n#endif\n";nt.IncludesShadersStoreWGSL.meshUboDeclaration="struct Mesh {world : mat4x4<f32>,\nvisibility : f32,};var<uniform> mesh : Mesh;\n#define WORLD_UBO\n";nt.IncludesShadersStoreWGSL.morphTargetsVertex="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE \nvertexID=f32(vertexInputs.vertexIndex)*uniforms.morphTargetTextureInfo.x;positionUpdated=positionUpdated+(readVector3FromRawSampler({X},vertexID)-vertexInputs.position)*uniforms.morphTargetInfluences[{X}];vertexID=vertexID+1.0;\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated=normalUpdated+(readVector3FromRawSampler({X},vertexID) -vertexInputs.normal)*uniforms.morphTargetInfluences[{X}];vertexID=vertexID+1.0;\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated=uvUpdated+(readVector3FromRawSampler({X},vertexID).xy-vertexInputs.uv)*uniforms.morphTargetInfluences[{X}];vertexID=vertexID+1.0;\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz=tangentUpdated.xyz+(readVector3FromRawSampler({X},vertexID) -vertexInputs.tangent.xyz)*uniforms.morphTargetInfluences[{X}];\n#endif\n#else\npositionUpdated=positionUpdated+(position{X}-vertexInputs.position)*uniforms.morphTargetInfluences[{X}];\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(normal{X}-vertexInputs.normal)*uniforms.morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz=tangentUpdated.xyz+(tangent{X}-vertexInputs.tangent.xyz)*uniforms.morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated=uvUpdated+(uv_{X}-vertexInputs.uv)*uniforms.morphTargetInfluences[{X}];\n#endif\n#endif\n#endif\n";nt.IncludesShadersStoreWGSL.morphTargetsVertexDeclaration="#ifdef MORPHTARGETS\n#ifndef MORPHTARGETS_TEXTURE\nattribute position{X} : vec3<f32>;\n#ifdef MORPHTARGETS_NORMAL\nattribute normal{X} : vec3<f32>;\n#endif\n#ifdef MORPHTARGETS_TANGENT\nattribute tangent{X} : vec3<f32>;\n#endif\n#ifdef MORPHTARGETS_UV\nattribute uv_{X} : vec2<f32>;\n#endif\n#endif\n#endif\n";nt.IncludesShadersStoreWGSL.morphTargetsVertexGlobal="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE\nvar vertexID : f32;\n#endif\n#endif\n";nt.IncludesShadersStoreWGSL.morphTargetsVertexGlobalDeclaration="#ifdef MORPHTARGETS\nuniform morphTargetInfluences : array<f32,NUM_MORPH_INFLUENCERS>;\n#ifdef MORPHTARGETS_TEXTURE \nuniform morphTargetTextureIndices : array<f32,NUM_MORPH_INFLUENCERS>;uniform morphTargetTextureInfo : vec3<f32>;var morphTargets : texture_2d_array<f32>;var morphTargetsSampler : sampler;fn readVector3FromRawSampler(targetIndex : i32,vertexIndex : f32)->vec3<f32>\n{ \nlet y=floor(vertexIndex/uniforms.morphTargetTextureInfo.y);let x=vertexIndex-y*uniforms.morphTargetTextureInfo.y;let textureUV=vec2<f32>((x+0.5)/uniforms.morphTargetTextureInfo.y,(y+0.5)/uniforms.morphTargetTextureInfo.z);return textureSampleLevel(morphTargets,morphTargetsSampler,textureUV,i32(uniforms.morphTargetTextureIndices[targetIndex]),0.0).xyz;}\n#endif\n#endif\n";nt.IncludesShadersStoreWGSL.sceneUboDeclaration="struct Scene {viewProjection : mat4x4<f32>,\n#ifdef MULTIVIEW\nviewProjectionR : mat4x4<f32>,\n#endif \nview : mat4x4<f32>,\nprojection : mat4x4<f32>,\nvEyePosition : vec4<f32>,};var<uniform> scene : Scene;\n";const Jc={texture_1d:fc.E1d,texture_2d:fc.E2d,texture_2d_array:fc.E2dArray,texture_3d:fc.E3d,texture_cube:fc.Cube,texture_cube_array:fc.CubeArray,texture_multisampled_2d:fc.E2d,texture_depth_2d:fc.E2d,texture_depth_2d_array:fc.E2dArray,texture_depth_cube:fc.Cube,texture_depth_cube_array:fc.CubeArray,texture_depth_multisampled_2d:fc.E2d,texture_storage_1d:fc.E1d,texture_storage_2d:fc.E2d,texture_storage_2d_array:fc.E2dArray,texture_storage_3d:fc.E3d,texture_external:null};class eu extends Kc{constructor(){super(...arguments),this.shaderLanguage=qe.WGSL,this.uniformRegexp=/uniform\s+(\w+)\s*:\s*(.+)\s*;/,this.textureRegexp=/var\s+(\w+)\s*:\s*((array<\s*)?(texture_\w+)\s*(<\s*(.+)\s*>)?\s*(,\s*\w+\s*>\s*)?);/,this.noPrecision=!0}_getArraySize(e,t,i){let s=0;const r=t.lastIndexOf(">");if(t.indexOf("array")>=0&&r>0){let e=r;for(;e>0&&" "!==t.charAt(e)&&","!==t.charAt(e);)e--;const n=t.substring(e+1,r);for(s=+n,isNaN(s)&&(s=+i[n.trim()]);e>0&&(" "===t.charAt(e)||","===t.charAt(e));)e--;t=t.substring(t.indexOf("<")+1,e+1)}return[e,t,s]}initializeShaders(e){this._webgpuProcessingContext=e,this._attributesInputWGSL=[],this._attributesWGSL=[],this._attributesConversionCodeWGSL=[],this._hasNonFloatAttribute=!1,this._varyingsWGSL=[],this._varyingNamesWGSL=[],this._stridedUniformArrays=[]}preProcessShaderCode(e){return`struct ${Kc.InternalsUBOName} {\n  yFactor_: f32,\n  textureOutputHeight_: f32,\n};\nvar<uniform> internals : ${Kc.InternalsUBOName};\n`+jh(e)}varyingProcessor(e,t,i){const s=/\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(null!==s){const r=s[2],n=s[1];let o;t?(o=this._webgpuProcessingContext.availableVaryings[n],void 0===o&&k.Warn(`Invalid fragment shader: The varying named "${n}" is not declared in the vertex shader! This declaration will be ignored.`)):(o=this._webgpuProcessingContext.getVaryingNextLocation(r,this._getArraySize(n,r,i)[2]),this._webgpuProcessingContext.availableVaryings[n]=o,this._varyingsWGSL.push(`  @location(${o}) ${n} : ${r},`),this._varyingNamesWGSL.push(n)),e=""}return e}attributeProcessor(e,t){const i=/\s*attribute\s+(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(null!==i){const s=i[2],r=i[1],n=this._webgpuProcessingContext.getAttributeNextLocation(s,this._getArraySize(r,s,t)[2]);this._webgpuProcessingContext.availableAttributes[r]=n,this._webgpuProcessingContext.orderedAttributes[n]=r;const o=this.vertexBufferKindToNumberOfComponents[r];if(void 0!==o){const e=o<0?-1===o?"i32":"vec"+-o+"<i32>":1===o?"u32":"vec"+o+"<u32>",t=`_int_${r}_`;this._attributesInputWGSL.push(`@location(${n}) ${t} : ${e},`),this._attributesWGSL.push(`${r} : ${s},`),this._attributesConversionCodeWGSL.push(`vertexInputs.${r} = ${s}(vertexInputs_.${t});`),this._hasNonFloatAttribute=!0}else this._attributesInputWGSL.push(`@location(${n}) ${r} : ${s},`),this._attributesWGSL.push(`${r} : ${s},`),this._attributesConversionCodeWGSL.push(`vertexInputs.${r} = vertexInputs_.${r};`);e=""}return e}uniformProcessor(e,t,i){const s=this.uniformRegexp.exec(e);if(null!==s){const t=s[2],r=s[1];this._addUniformToLeftOverUBO(r,t,i),e=""}return e}textureProcessor(e,t,i){const s=this.textureRegexp.exec(e);if(null!==s){const r=s[1],n=s[2],o=!!s[3],a=s[4],l=a.indexOf("storage")>0,h=s[6],c=l?h.substring(0,h.indexOf(",")).trim():null;let u=o?this._getArraySize(r,n,i)[2]:0,d=this._webgpuProcessingContext.availableTextures[r];if(d)u=d.textures.length;else{d={isTextureArray:u>0,isStorageTexture:l,textures:[],sampleType:yc.Float},u=u||1;for(let e=0;e<u;++e)d.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}this._webgpuProcessingContext.availableTextures[r]=d;const p=a.indexOf("depth")>0,_=Jc[a],f=p?yc.Depth:"u32"===h?yc.Uint:"i32"===h?yc.Sint:yc.Float;if(d.sampleType=f,void 0===_)throw`Can't get the texture dimension corresponding to the texture function "${a}"!`;for(let i=0;i<u;++i){const{groupIndex:s,bindingIndex:n}=d.textures[i];0===i&&(e=`@group(${s}) @binding(${n}) ${e}`),this._addTextureBindingDescription(r,d,i,_,c,!t)}}return e}postProcessor(e){return e}finalizeShaders(e,t){const i=t.indexOf("fragmentInputs.position")>=0?"\n            if (internals.yFactor_ == 1.) {\n                fragmentInputs.position.y = internals.textureOutputHeight_ - fragmentInputs.position.y;\n            }\n        ":"";e=this._processSamplers(e,!0),t=this._processSamplers(t,!1),e=this._processCustomBuffers(e,!0),t=this._processCustomBuffers(t,!1);const s=this._buildLeftOverUBO();t=s+t,e=(e=s+e).replace(/#define /g,"//#define "),e=this._processStridedUniformArrays(e);let r="struct VertexInputs {\n  @builtin(vertex_index) vertexIndex : u32,\n  @builtin(instance_index) instanceIndex : u32,\n";this._attributesInputWGSL.length>0&&(r+=this._attributesInputWGSL.join("\n")),r+="\n};\nvar<private> vertexInputs"+(this._hasNonFloatAttribute?"_":"")+" : VertexInputs;\n",this._hasNonFloatAttribute&&(r+="struct VertexInputs_ {\n  vertexIndex : u32, instanceIndex : u32,\n",r+=this._attributesWGSL.join("\n"),r+="\n};\nvar<private> vertexInputs : VertexInputs_;\n");let n="struct FragmentInputs {\n  @builtin(position) position : vec4<f32>,\n";this._varyingsWGSL.length>0&&(n+=this._varyingsWGSL.join("\n")),n+="\n};\nvar<private> vertexOutputs : FragmentInputs;\n",e=r+n+e;let o=`\n  vertexInputs${this._hasNonFloatAttribute?"_":""} = input;\n`;this._hasNonFloatAttribute&&(o+="vertexInputs.vertexIndex = vertexInputs_.vertexIndex;\nvertexInputs.instanceIndex = vertexInputs_.instanceIndex;\n",o+=this._attributesConversionCodeWGSL.join("\n"),o+="\n"),e=this._injectStartingAndEndingCode(e,"fn main",o,"  vertexOutputs.position.y = vertexOutputs.position.y * internals.yFactor_;\n  return vertexOutputs;"),t=t.replace(/#define /g,"//#define "),t=(t=this._processStridedUniformArrays(t)).replace(/dpdy/g,"(-internals.yFactor_)*dpdy");let a="struct FragmentInputs {\n  @builtin(position) position : vec4<f32>,\n  @builtin(front_facing) frontFacing : bool,\n";this._varyingsWGSL.length>0&&(a+=this._varyingsWGSL.join("\n")),a+="\n};\nvar<private> fragmentInputs : FragmentInputs;\n";let l="struct FragmentOutputs {\n  @location(0) color : vec4<f32>,\n",h=!1,c=0;for(;!(h||(c=t.indexOf("fragmentOutputs.fragDepth",c),c<0));){const e=c;for(h=!0;c>1&&"\n"!==t.charAt(c);){if("/"===t.charAt(c)&&"/"===t.charAt(c-1)){h=!1;break}c--}c=e+25}h&&(l+="  @builtin(frag_depth) fragDepth: f32,\n"),l+="};\nvar<private> fragmentOutputs : FragmentOutputs;\n",t=a+l+t;const u="  fragmentInputs = input;\n  "+i;return t=this._injectStartingAndEndingCode(t,"fn main",u,"  return fragmentOutputs;"),this._collectBindingNames(),this._preCreateBindGroupEntries(),this.vertexBufferKindToNumberOfComponents={},{vertexCode:e,fragmentCode:t}}_generateLeftOverUBOCode(e,t){let i="",s=`struct ${e} {\n`;for(const t of this._webgpuProcessingContext.leftOverUniforms){const r=t.type.replace(/^(.*?)(<.*>)?$/,"$1"),n=Kc.UniformSizes[r];if(t.length>0)if(n<=2){const n=`${e}_${this._stridedUniformArrays.length}_strided_arr`;i+=`struct ${n} {\n                        @size(16)\n                        el: ${r},\n                    }`,this._stridedUniformArrays.push(t.name),s+=` @align(16) ${t.name} : array<${n}, ${t.length}>,\n`}else s+=` ${t.name} : array<${t.type}, ${t.length}>,\n`;else s+=`  ${t.name} : ${t.type},\n`}return s+="};\n",s=`${i}\n${s}`,s+=`@group(${t.binding.groupIndex}) @binding(${t.binding.bindingIndex}) var<uniform> uniforms : ${e};\n`,s}_processSamplers(e,t){const i=/var\s+(\w+Sampler)\s*:\s*(sampler|sampler_comparison)\s*;/gm;for(;;){const s=i.exec(e);if(null===s)break;const r=s[1],n=s[2],o=r.indexOf(Kc.AutoSamplerSuffix)===r.length-Kc.AutoSamplerSuffix.length?r.substring(0,r.indexOf(Kc.AutoSamplerSuffix)):null,a="sampler_comparison"===n?Cc.Comparison:Cc.Filtering;if(o){const e=this._webgpuProcessingContext.availableTextures[o];e&&(e.autoBindSampler=!0)}let l=this._webgpuProcessingContext.availableSamplers[r];l||(l={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:a},this._webgpuProcessingContext.availableSamplers[r]=l),this._addSamplerBindingDescription(r,l,t);const h=e.substring(0,s.index),c=`@group(${l.binding.groupIndex}) @binding(${l.binding.bindingIndex}) `,u=e.substring(s.index);e=h+c+u,i.lastIndex+=c.length}return e}_processCustomBuffers(e,t){const i=/var<\s*(uniform|storage)\s*(,\s*(read|read_write)\s*)?>\s+(\S+)\s*:\s*(\S+)\s*;/gm;for(;;){const s=i.exec(e);if(null===s)break;const r=s[1],n=s[3];let o=s[4];const a=s[5];let l=this._webgpuProcessingContext.availableBuffers[o];if(!l){const e="uniform"===r?Qc.KnownUBOs[a]:null;let t;e?(o=a,t=e.binding,-1===t.groupIndex&&(t=this._webgpuProcessingContext.getNextFreeUBOBinding())):t=this._webgpuProcessingContext.getNextFreeUBOBinding(),l={binding:t},this._webgpuProcessingContext.availableBuffers[o]=l}this._addBufferBindingDescription(o,this._webgpuProcessingContext.availableBuffers[o],"read_write"===n?bc.Storage:"storage"===r?bc.ReadOnlyStorage:bc.Uniform,t);const h=l.binding.groupIndex,c=l.binding.bindingIndex,u=e.substring(0,s.index),d=`@group(${h}) @binding(${c}) `,p=e.substring(s.index);e=u+d+p,i.lastIndex+=d.length}return e}_processStridedUniformArrays(e){for(const t of this._stridedUniformArrays)e=e.replace(new RegExp(`${t}\\s*\\[(.*)\\]`,"g"),`${t}[$1].el`);return e}}class tu{get underlyingResource(){return this._webgpuTexture}getMSAATexture(e=0){var t,i;return null!==(i=null===(t=this._webgpuMSAATexture)||void 0===t?void 0:t[e])&&void 0!==i?i:null}setMSAATexture(e,t=-1){this._webgpuMSAATexture||(this._webgpuMSAATexture=[]),-1===t&&(t=this._webgpuMSAATexture.length),this._webgpuMSAATexture[t]=e}releaseMSAATexture(){if(this._webgpuMSAATexture){for(const e of this._webgpuMSAATexture)null==e||e.destroy();this._webgpuMSAATexture=null}}constructor(e=null){this.format=gc.RGBA8Unorm,this.textureUsages=0,this.textureAdditionalUsages=0,this._webgpuTexture=e,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}set(e){this._webgpuTexture=e}setUsage(e,t,i,s,r){this.createView({format:this.format,dimension:i?fc.Cube:fc.E2d,mipLevelCount:t?l.ILog2(Math.max(s,r))+1:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:i?6:1,aspect:mc.All})}createView(e,t=!1){if(this.view=this._webgpuTexture.createView(e),t&&e){const t=e.mipLevelCount;e.mipLevelCount=1,this.viewForWriting=this._webgpuTexture.createView(e),e.mipLevelCount=t}}reset(){this._webgpuTexture=null,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}release(){var e,t;null===(e=this._webgpuTexture)||void 0===e||e.destroy(),this.releaseMSAATexture(),null===(t=this._copyInvertYTempTexture)||void 0===t||t.destroy(),this.reset()}}const iu="\n    #extension GL_EXT_samplerless_texture_functions : enable\n\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));\n\n    layout(set = 0, binding = 0) uniform texture2D img;\n\n    #ifdef INVERTY\n        layout(location = 0) out flat ivec2 vTextureSize;\n    #endif\n\n    void main() {\n        #ifdef INVERTY\n            vTextureSize = textureSize(img, 0);\n        #endif\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n    }\n    ",su=iu;var ru,nu;!function(e){e[e.MipMap=0]="MipMap",e[e.InvertYPremultiplyAlpha=1]="InvertYPremultiplyAlpha",e[e.Clear=2]="Clear",e[e.InvertYPremultiplyAlphaWithOfst=3]="InvertYPremultiplyAlphaWithOfst"}(ru||(ru={})),function(e){e[e.DontInvertY=0]="DontInvertY",e[e.InvertY=1]="InvertY"}(nu||(nu={}));const ou=[{vertex:"\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));\n\n    layout(location = 0) out vec2 vTex;\n\n    void main() {\n        vTex = tex[gl_VertexIndex];\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n    }\n    ",fragment:"\n    layout(set = 0, binding = 0) uniform sampler imgSampler;\n    layout(set = 0, binding = 1) uniform texture2D img;\n\n    layout(location = 0) in vec2 vTex;\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n        outColor = texture(sampler2D(img, imgSampler), vTex);\n    }\n    "},{vertex:iu,fragment:"\n    #extension GL_EXT_samplerless_texture_functions : enable\n\n    layout(set = 0, binding = 0) uniform texture2D img;\n\n    #ifdef INVERTY\n        layout(location = 0) in flat ivec2 vTextureSize;\n    #endif\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n    #ifdef INVERTY\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.x, vTextureSize.y - gl_FragCoord.y), 0);\n    #else\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.xy), 0);\n    #endif\n    #ifdef PREMULTIPLYALPHA\n        color.rgb *= color.a;\n    #endif\n        outColor = color;\n    }\n    "},{vertex:"\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n\n    void main() {\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n    }\n    ",fragment:"\n    layout(set = 0, binding = 0) uniform Uniforms {\n        uniform vec4 color;\n    };\n\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n        outColor = color;\n    }\n    "},{vertex:su,fragment:"\n    #extension GL_EXT_samplerless_texture_functions : enable\n\n    layout(set = 0, binding = 0) uniform texture2D img;\n    layout(set = 0, binding = 1) uniform Params {\n        float ofstX;\n        float ofstY;\n        float width;\n        float height;\n    };\n\n    #ifdef INVERTY\n        layout(location = 0) in flat ivec2 vTextureSize;\n    #endif\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n        if (gl_FragCoord.x < ofstX || gl_FragCoord.x >= ofstX + width) {\n            discard;\n        }\n        if (gl_FragCoord.y < ofstY || gl_FragCoord.y >= ofstY + height) {\n            discard;\n        }\n    #ifdef INVERTY\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.x, ofstY + height - (gl_FragCoord.y - ofstY)), 0);\n    #else\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.xy), 0);\n    #endif\n    #ifdef PREMULTIPLYALPHA\n        color.rgb *= color.a;\n    #endif\n        outColor = color;\n    }\n    "}],au={"":0,r8unorm:1,r8uint:2,r8sint:3,r16uint:4,r16sint:5,r16float:6,rg8unorm:7,rg8uint:8,rg8sint:9,r32uint:10,r32sint:11,r32float:12,rg16uint:13,rg16sint:14,rg16float:15,rgba8unorm:16,"rgba8unorm-srgb":17,rgba8uint:18,rgba8sint:19,bgra8unorm:20,"bgra8unorm-srgb":21,rgb10a2uint:22,rgb10a2unorm:23,rg32uint:24,rg32sint:25,rg32float:26,rgba16uint:27,rgba16sint:28,rgba16float:29,rgba32uint:30,rgba32sint:31,rgba32float:32,stencil8:33,depth16unorm:34,depth24plus:35,"depth24plus-stencil8":36,depth32float:37,"depth32float-stencil8":38};class lu{static ComputeNumMipmapLevels(e,t){return l.ILog2(Math.max(e,t))+1}constructor(e,t,i,s,r){if(this._pipelines={},this._compiledShaders=[],this._videoPipelines={},this._videoCompiledShaders=[],this._deferredReleaseTextures=[],this._device=e,this._glslang=t,this._tintWASM=i,this._bufferManager=s,-1!==r.indexOf(hc.RG11B10UFloatRenderable)){const e=Object.keys(au);au[gc.RG11B10UFloat]=au[e[e.length-1]]+1}this._mipmapSampler=e.createSampler({minFilter:xc.Linear}),this._videoSampler=e.createSampler({minFilter:xc.Linear}),this._ubCopyWithOfst=this._bufferManager.createBuffer(16,uc.Uniform|uc.CopyDst,"UBCopyWithOffset").underlyingResource,this._getPipeline(gc.RGBA8Unorm),this._getVideoPipeline(gc.RGBA8Unorm)}_getPipeline(e,t=ru.MipMap,i){const s=t===ru.MipMap?1:t===ru.InvertYPremultiplyAlpha?((i.invertY?1:0)<<1)+((i.premultiplyAlpha?1:0)<<2):t===ru.Clear?8:t===ru.InvertYPremultiplyAlphaWithOfst?((i.invertY?1:0)<<4)+((i.premultiplyAlpha?1:0)<<5):0;this._pipelines[e]||(this._pipelines[e]=[]);let r=this._pipelines[e][s];if(!r){let n="#version 450\n";t!==ru.InvertYPremultiplyAlpha&&t!==ru.InvertYPremultiplyAlphaWithOfst||(i.invertY&&(n+="#define INVERTY\n"),i.premultiplyAlpha&&(n+="#define PREMULTIPLYALPHA\n"));let o=this._compiledShaders[s];if(!o){let e=this._glslang.compileGLSL(n+ou[t].vertex,"vertex"),i=this._glslang.compileGLSL(n+ou[t].fragment,"fragment");this._tintWASM&&(e=this._tintWASM.convertSpirV2WGSL(e),i=this._tintWASM.convertSpirV2WGSL(i));const r=this._device.createShaderModule({code:e}),a=this._device.createShaderModule({code:i});o=this._compiledShaders[s]=[r,a]}const a=this._device.createRenderPipeline({layout:Pc.Auto,vertex:{module:o[0],entryPoint:"main"},fragment:{module:o[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:Mc.TriangleStrip,stripIndexFormat:Bc.Uint16}});r=this._pipelines[e][s]=[a,a.getBindGroupLayout(0)]}return r}_getVideoPipeline(e,t=nu.DontInvertY){const i=t===nu.InvertY?1:0;this._videoPipelines[e]||(this._videoPipelines[e]=[]);let s=this._videoPipelines[e][i];if(!s){let t=this._videoCompiledShaders[i];if(!t){const e=this._device.createShaderModule({code:"\n    struct VertexOutput {\n        @builtin(position) Position : vec4<f32>,\n        @location(0) fragUV : vec2<f32>\n    }\n  \n    @vertex\n    fn main(\n        @builtin(vertex_index) VertexIndex : u32\n    ) -> VertexOutput {\n        var pos = array<vec2<f32>, 4>(\n            vec2(-1.0,  1.0),\n            vec2( 1.0,  1.0),\n            vec2(-1.0, -1.0),\n            vec2( 1.0, -1.0)\n        );\n        var tex = array<vec2<f32>, 4>(\n            vec2(0.0, 0.0),\n            vec2(1.0, 0.0),\n            vec2(0.0, 1.0),\n            vec2(1.0, 1.0)\n        );\n\n        var output: VertexOutput;\n\n        output.Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);\n        output.fragUV = tex[VertexIndex];\n\n        return output;\n    }\n    "}),s=this._device.createShaderModule({code:0===i?"\n    @group(0) @binding(0) var videoSampler: sampler;\n    @group(0) @binding(1) var videoTexture: texture_external;\n\n    @fragment\n    fn main(\n        @location(0) fragUV: vec2<f32>\n    ) -> @location(0) vec4<f32> {\n        return textureSampleBaseClampToEdge(videoTexture, videoSampler, fragUV);\n    }\n    ":"\n    @group(0) @binding(0) var videoSampler: sampler;\n    @group(0) @binding(1) var videoTexture: texture_external;\n\n    @fragment\n    fn main(\n        @location(0) fragUV: vec2<f32>\n    ) -> @location(0) vec4<f32> {\n        return textureSampleBaseClampToEdge(videoTexture, videoSampler, vec2<f32>(fragUV.x, 1.0 - fragUV.y));\n    }\n    "});t=this._videoCompiledShaders[i]=[e,s]}const r=this._device.createRenderPipeline({label:`CopyVideoToTexture_${e}_${0===i?"DontInvertY":"InvertY"}`,layout:Pc.Auto,vertex:{module:t[0],entryPoint:"main"},fragment:{module:t[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:Mc.TriangleStrip,stripIndexFormat:Bc.Uint16}});s=this._videoPipelines[e][i]=[r,r.getBindGroupLayout(0)]}return s}static GetTextureTypeFromFormat(e){switch(e){case gc.R8Unorm:case gc.R8Snorm:case gc.R8Uint:case gc.R8Sint:case gc.RG8Unorm:case gc.RG8Snorm:case gc.RG8Uint:case gc.RG8Sint:case gc.RGBA8Unorm:case gc.RGBA8UnormSRGB:case gc.RGBA8Snorm:case gc.RGBA8Uint:case gc.RGBA8Sint:case gc.BGRA8Unorm:case gc.BGRA8UnormSRGB:case gc.RGB10A2UINT:case gc.RGB10A2Unorm:case gc.RGB9E5UFloat:case gc.RG11B10UFloat:case gc.BC7RGBAUnorm:case gc.BC7RGBAUnormSRGB:case gc.BC6HRGBUFloat:case gc.BC6HRGBFloat:case gc.BC5RGUnorm:case gc.BC5RGSnorm:case gc.BC3RGBAUnorm:case gc.BC3RGBAUnormSRGB:case gc.BC2RGBAUnorm:case gc.BC2RGBAUnormSRGB:case gc.BC4RUnorm:case gc.BC4RSnorm:case gc.BC1RGBAUnorm:case gc.BC1RGBAUnormSRGB:case gc.ETC2RGB8Unorm:case gc.ETC2RGB8UnormSRGB:case gc.ETC2RGB8A1Unorm:case gc.ETC2RGB8A1UnormSRGB:case gc.ETC2RGBA8Unorm:case gc.ETC2RGBA8UnormSRGB:case gc.EACR11Unorm:case gc.EACR11Snorm:case gc.EACRG11Unorm:case gc.EACRG11Snorm:case gc.ASTC4x4Unorm:case gc.ASTC4x4UnormSRGB:case gc.ASTC5x4Unorm:case gc.ASTC5x4UnormSRGB:case gc.ASTC5x5Unorm:case gc.ASTC5x5UnormSRGB:case gc.ASTC6x5Unorm:case gc.ASTC6x5UnormSRGB:case gc.ASTC6x6Unorm:case gc.ASTC6x6UnormSRGB:case gc.ASTC8x5Unorm:case gc.ASTC8x5UnormSRGB:case gc.ASTC8x6Unorm:case gc.ASTC8x6UnormSRGB:case gc.ASTC8x8Unorm:case gc.ASTC8x8UnormSRGB:case gc.ASTC10x5Unorm:case gc.ASTC10x5UnormSRGB:case gc.ASTC10x6Unorm:case gc.ASTC10x6UnormSRGB:case gc.ASTC10x8Unorm:case gc.ASTC10x8UnormSRGB:case gc.ASTC10x10Unorm:case gc.ASTC10x10UnormSRGB:case gc.ASTC12x10Unorm:case gc.ASTC12x10UnormSRGB:case gc.ASTC12x12Unorm:case gc.ASTC12x12UnormSRGB:case gc.Stencil8:return 0;case gc.R16Uint:case gc.R16Sint:case gc.RG16Uint:case gc.RG16Sint:case gc.RGBA16Uint:case gc.RGBA16Sint:case gc.Depth16Unorm:return 5;case gc.R16Float:case gc.RG16Float:case gc.RGBA16Float:return 2;case gc.R32Uint:case gc.R32Sint:case gc.RG32Uint:case gc.RG32Sint:case gc.RGBA32Uint:case gc.RGBA32Sint:return 7;case gc.R32Float:case gc.RG32Float:case gc.RGBA32Float:case gc.Depth32Float:case gc.Depth32FloatStencil8:case gc.Depth24Plus:case gc.Depth24PlusStencil8:return 1}return 0}static _GetBlockInformationFromFormat(e){switch(e){case gc.R8Unorm:case gc.R8Snorm:case gc.R8Uint:case gc.R8Sint:return{width:1,height:1,length:1};case gc.R16Uint:case gc.R16Sint:case gc.R16Float:case gc.RG8Unorm:case gc.RG8Snorm:case gc.RG8Uint:case gc.RG8Sint:return{width:1,height:1,length:2};case gc.R32Uint:case gc.R32Sint:case gc.R32Float:case gc.RG16Uint:case gc.RG16Sint:case gc.RG16Float:case gc.RGBA8Unorm:case gc.RGBA8UnormSRGB:case gc.RGBA8Snorm:case gc.RGBA8Uint:case gc.RGBA8Sint:case gc.BGRA8Unorm:case gc.BGRA8UnormSRGB:case gc.RGB9E5UFloat:case gc.RGB10A2UINT:case gc.RGB10A2Unorm:case gc.RG11B10UFloat:return{width:1,height:1,length:4};case gc.RG32Uint:case gc.RG32Sint:case gc.RG32Float:case gc.RGBA16Uint:case gc.RGBA16Sint:case gc.RGBA16Float:return{width:1,height:1,length:8};case gc.RGBA32Uint:case gc.RGBA32Sint:case gc.RGBA32Float:return{width:1,height:1,length:16};case gc.Stencil8:throw"No fixed size for Stencil8 format!";case gc.Depth16Unorm:return{width:1,height:1,length:2};case gc.Depth24Plus:throw"No fixed size for Depth24Plus format!";case gc.Depth24PlusStencil8:throw"No fixed size for Depth24PlusStencil8 format!";case gc.Depth32Float:return{width:1,height:1,length:4};case gc.Depth32FloatStencil8:return{width:1,height:1,length:5};case gc.BC7RGBAUnorm:case gc.BC7RGBAUnormSRGB:case gc.BC6HRGBUFloat:case gc.BC6HRGBFloat:case gc.BC5RGUnorm:case gc.BC5RGSnorm:case gc.BC3RGBAUnorm:case gc.BC3RGBAUnormSRGB:case gc.BC2RGBAUnorm:case gc.BC2RGBAUnormSRGB:return{width:4,height:4,length:16};case gc.BC4RUnorm:case gc.BC4RSnorm:case gc.BC1RGBAUnorm:case gc.BC1RGBAUnormSRGB:case gc.ETC2RGB8Unorm:case gc.ETC2RGB8UnormSRGB:case gc.ETC2RGB8A1Unorm:case gc.ETC2RGB8A1UnormSRGB:case gc.EACR11Unorm:case gc.EACR11Snorm:return{width:4,height:4,length:8};case gc.ETC2RGBA8Unorm:case gc.ETC2RGBA8UnormSRGB:case gc.EACRG11Unorm:case gc.EACRG11Snorm:case gc.ASTC4x4Unorm:case gc.ASTC4x4UnormSRGB:return{width:4,height:4,length:16};case gc.ASTC5x4Unorm:case gc.ASTC5x4UnormSRGB:return{width:5,height:4,length:16};case gc.ASTC5x5Unorm:case gc.ASTC5x5UnormSRGB:return{width:5,height:5,length:16};case gc.ASTC6x5Unorm:case gc.ASTC6x5UnormSRGB:return{width:6,height:5,length:16};case gc.ASTC6x6Unorm:case gc.ASTC6x6UnormSRGB:return{width:6,height:6,length:16};case gc.ASTC8x5Unorm:case gc.ASTC8x5UnormSRGB:return{width:8,height:5,length:16};case gc.ASTC8x6Unorm:case gc.ASTC8x6UnormSRGB:return{width:8,height:6,length:16};case gc.ASTC8x8Unorm:case gc.ASTC8x8UnormSRGB:return{width:8,height:8,length:16};case gc.ASTC10x5Unorm:case gc.ASTC10x5UnormSRGB:return{width:10,height:5,length:16};case gc.ASTC10x6Unorm:case gc.ASTC10x6UnormSRGB:return{width:10,height:6,length:16};case gc.ASTC10x8Unorm:case gc.ASTC10x8UnormSRGB:return{width:10,height:8,length:16};case gc.ASTC10x10Unorm:case gc.ASTC10x10UnormSRGB:return{width:10,height:10,length:16};case gc.ASTC12x10Unorm:case gc.ASTC12x10UnormSRGB:return{width:12,height:10,length:16};case gc.ASTC12x12Unorm:case gc.ASTC12x12UnormSRGB:return{width:12,height:12,length:16}}return{width:1,height:1,length:4}}static _IsHardwareTexture(e){return!!e.release}static _IsInternalTexture(e){return!!e.dispose}static IsImageBitmap(e){return void 0!==e.close}static IsImageBitmapArray(e){return Array.isArray(e)&&void 0!==e[0].close}setCommandEncoder(e){this._commandEncoderForCreation=e}static IsCompressedFormat(e){switch(e){case gc.BC7RGBAUnormSRGB:case gc.BC7RGBAUnorm:case gc.BC6HRGBFloat:case gc.BC6HRGBUFloat:case gc.BC5RGSnorm:case gc.BC5RGUnorm:case gc.BC4RSnorm:case gc.BC4RUnorm:case gc.BC3RGBAUnormSRGB:case gc.BC3RGBAUnorm:case gc.BC2RGBAUnormSRGB:case gc.BC2RGBAUnorm:case gc.BC1RGBAUnormSRGB:case gc.BC1RGBAUnorm:case gc.ETC2RGB8Unorm:case gc.ETC2RGB8UnormSRGB:case gc.ETC2RGB8A1Unorm:case gc.ETC2RGB8A1UnormSRGB:case gc.ETC2RGBA8Unorm:case gc.ETC2RGBA8UnormSRGB:case gc.EACR11Unorm:case gc.EACR11Snorm:case gc.EACRG11Unorm:case gc.EACRG11Snorm:case gc.ASTC4x4Unorm:case gc.ASTC4x4UnormSRGB:case gc.ASTC5x4Unorm:case gc.ASTC5x4UnormSRGB:case gc.ASTC5x5Unorm:case gc.ASTC5x5UnormSRGB:case gc.ASTC6x5Unorm:case gc.ASTC6x5UnormSRGB:case gc.ASTC6x6Unorm:case gc.ASTC6x6UnormSRGB:case gc.ASTC8x5Unorm:case gc.ASTC8x5UnormSRGB:case gc.ASTC8x6Unorm:case gc.ASTC8x6UnormSRGB:case gc.ASTC8x8Unorm:case gc.ASTC8x8UnormSRGB:case gc.ASTC10x5Unorm:case gc.ASTC10x5UnormSRGB:case gc.ASTC10x6Unorm:case gc.ASTC10x6UnormSRGB:case gc.ASTC10x8Unorm:case gc.ASTC10x8UnormSRGB:case gc.ASTC10x10Unorm:case gc.ASTC10x10UnormSRGB:case gc.ASTC12x10Unorm:case gc.ASTC12x10UnormSRGB:case gc.ASTC12x12Unorm:case gc.ASTC12x12UnormSRGB:return!0}return!1}static GetWebGPUTextureFormat(e,t,i=!1){switch(t){case 15:return gc.Depth16Unorm;case 16:return gc.Depth24Plus;case 13:return gc.Depth24PlusStencil8;case 14:return gc.Depth32Float;case 18:return gc.Depth32FloatStencil8;case 19:return gc.Stencil8;case 36492:return i?gc.BC7RGBAUnormSRGB:gc.BC7RGBAUnorm;case 36495:return gc.BC6HRGBUFloat;case 36494:return gc.BC6HRGBFloat;case 33779:return i?gc.BC3RGBAUnormSRGB:gc.BC3RGBAUnorm;case 33778:return i?gc.BC2RGBAUnormSRGB:gc.BC2RGBAUnorm;case 33777:case 33776:return i?gc.BC1RGBAUnormSRGB:gc.BC1RGBAUnorm;case 37808:return i?gc.ASTC4x4UnormSRGB:gc.ASTC4x4Unorm;case 36196:case 37492:return i?gc.ETC2RGB8UnormSRGB:gc.ETC2RGB8Unorm;case 37496:return i?gc.ETC2RGBA8UnormSRGB:gc.ETC2RGBA8Unorm}switch(e){case 3:switch(t){case 6:return gc.R8Snorm;case 7:return gc.RG8Snorm;case 4:throw"RGB format not supported in WebGPU";case 8:return gc.R8Sint;case 9:return gc.RG8Sint;case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return gc.RGBA8Sint;default:return gc.RGBA8Snorm}case 0:switch(t){case 6:return gc.R8Unorm;case 7:return gc.RG8Unorm;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return i?gc.RGBA8UnormSRGB:gc.RGBA8Unorm;case 12:return i?gc.BGRA8UnormSRGB:gc.BGRA8Unorm;case 8:return gc.R8Uint;case 9:return gc.RG8Uint;case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return gc.RGBA8Uint;case 0:throw"TEXTUREFORMAT_ALPHA format not supported in WebGPU";case 1:throw"TEXTUREFORMAT_LUMINANCE format not supported in WebGPU";case 2:throw"TEXTUREFORMAT_LUMINANCE_ALPHA format not supported in WebGPU";default:return gc.RGBA8Unorm}case 4:switch(t){case 8:return gc.R16Sint;case 9:return gc.RG16Sint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return gc.RGBA16Sint}case 5:switch(t){case 8:return gc.R16Uint;case 9:return gc.RG16Uint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return gc.RGBA16Uint}case 6:switch(t){case 8:return gc.R32Sint;case 9:return gc.RG32Sint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return gc.RGBA32Sint}case 7:switch(t){case 8:return gc.R32Uint;case 9:return gc.RG32Uint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return gc.RGBA32Uint}case 1:switch(t){case 6:return gc.R32Float;case 7:return gc.RG32Float;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";default:return gc.RGBA32Float}case 2:switch(t){case 6:return gc.R16Float;case 7:return gc.RG16Float;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";default:return gc.RGBA16Float}case 10:throw"TEXTURETYPE_UNSIGNED_SHORT_5_6_5 format not supported in WebGPU";case 13:switch(t){case 5:default:return gc.RG11B10UFloat;case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV"}case 14:switch(t){case 5:default:return gc.RGB9E5UFloat;case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV"}case 8:throw"TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4 format not supported in WebGPU";case 9:throw"TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1 format not supported in WebGPU";case 11:switch(t){case 5:default:return gc.RGB10A2Unorm;case 11:return gc.RGB10A2UINT}}return i?gc.RGBA8UnormSRGB:gc.RGBA8Unorm}static GetNumChannelsFromWebGPUTextureFormat(e){switch(e){case gc.R8Unorm:case gc.R8Snorm:case gc.R8Uint:case gc.R8Sint:case gc.BC4RUnorm:case gc.BC4RSnorm:case gc.R16Uint:case gc.R16Sint:case gc.Depth16Unorm:case gc.R16Float:case gc.R32Uint:case gc.R32Sint:case gc.R32Float:case gc.Depth32Float:case gc.Stencil8:case gc.Depth24Plus:case gc.EACR11Unorm:case gc.EACR11Snorm:return 1;case gc.RG8Unorm:case gc.RG8Snorm:case gc.RG8Uint:case gc.RG8Sint:case gc.Depth32FloatStencil8:case gc.BC5RGUnorm:case gc.BC5RGSnorm:case gc.RG16Uint:case gc.RG16Sint:case gc.RG16Float:case gc.RG32Uint:case gc.RG32Sint:case gc.RG32Float:case gc.Depth24PlusStencil8:case gc.EACRG11Unorm:case gc.EACRG11Snorm:return 2;case gc.RGB9E5UFloat:case gc.RG11B10UFloat:case gc.BC6HRGBUFloat:case gc.BC6HRGBFloat:case gc.ETC2RGB8Unorm:case gc.ETC2RGB8UnormSRGB:return 3;case gc.RGBA8Unorm:case gc.RGBA8UnormSRGB:case gc.RGBA8Snorm:case gc.RGBA8Uint:case gc.RGBA8Sint:case gc.BGRA8Unorm:case gc.BGRA8UnormSRGB:case gc.RGB10A2UINT:case gc.RGB10A2Unorm:case gc.BC7RGBAUnorm:case gc.BC7RGBAUnormSRGB:case gc.BC3RGBAUnorm:case gc.BC3RGBAUnormSRGB:case gc.BC2RGBAUnorm:case gc.BC2RGBAUnormSRGB:case gc.BC1RGBAUnorm:case gc.BC1RGBAUnormSRGB:case gc.RGBA16Uint:case gc.RGBA16Sint:case gc.RGBA16Float:case gc.RGBA32Uint:case gc.RGBA32Sint:case gc.RGBA32Float:case gc.ETC2RGB8A1Unorm:case gc.ETC2RGB8A1UnormSRGB:case gc.ETC2RGBA8Unorm:case gc.ETC2RGBA8UnormSRGB:case gc.ASTC4x4Unorm:case gc.ASTC4x4UnormSRGB:case gc.ASTC5x4Unorm:case gc.ASTC5x4UnormSRGB:case gc.ASTC5x5Unorm:case gc.ASTC5x5UnormSRGB:case gc.ASTC6x5Unorm:case gc.ASTC6x5UnormSRGB:case gc.ASTC6x6Unorm:case gc.ASTC6x6UnormSRGB:case gc.ASTC8x5Unorm:case gc.ASTC8x5UnormSRGB:case gc.ASTC8x6Unorm:case gc.ASTC8x6UnormSRGB:case gc.ASTC8x8Unorm:case gc.ASTC8x8UnormSRGB:case gc.ASTC10x5Unorm:case gc.ASTC10x5UnormSRGB:case gc.ASTC10x6Unorm:case gc.ASTC10x6UnormSRGB:case gc.ASTC10x8Unorm:case gc.ASTC10x8UnormSRGB:case gc.ASTC10x10Unorm:case gc.ASTC10x10UnormSRGB:case gc.ASTC12x10Unorm:case gc.ASTC12x10UnormSRGB:case gc.ASTC12x12Unorm:case gc.ASTC12x12UnormSRGB:return 4}throw`Unknown format ${e}!`}static HasStencilAspect(e){switch(e){case gc.Stencil8:case gc.Depth32FloatStencil8:case gc.Depth24PlusStencil8:return!0}return!1}static HasDepthAndStencilAspects(e){switch(e){case gc.Depth32FloatStencil8:case gc.Depth24PlusStencil8:return!0}return!1}static GetDepthFormatOnly(e){switch(e){case gc.Depth16Unorm:return gc.Depth16Unorm;case gc.Depth24Plus:case gc.Depth24PlusStencil8:return gc.Depth24Plus;case gc.Depth32Float:case gc.Depth32FloatStencil8:return gc.Depth32Float}return e}static GetSample(e){return e>1?4:1}copyVideoToTexture(e,t,i,s=!1,r){var n,o,a,l;const h=void 0===r,[c,u]=this._getVideoPipeline(i,s?nu.InvertY:nu.DontInvertY);h&&(r=this._device.createCommandEncoder({})),null===(o=(n=r).pushDebugGroup)||void 0===o||o.call(n,`copy video to texture - invertY=${s}`);const d={colorAttachments:[{view:t._hardwareTexture.underlyingResource.createView({format:i,dimension:fc.E2d,mipLevelCount:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:1,aspect:mc.All}),loadOp:zc.Load,storeOp:Wc.Store}]},p=r.beginRenderPass(d),_={layout:u,entries:[{binding:0,resource:this._videoSampler},{binding:1,resource:this._device.importExternalTexture({source:e.underlyingResource})}]},f=this._device.createBindGroup(_);p.setPipeline(c),p.setBindGroup(0,f),p.draw(4,1,0,0),p.end(),null===(l=(a=r).popDebugGroup)||void 0===l||l.call(a),h&&(this._device.queue.submit([r.finish()]),r=null)}invertYPreMultiplyAlpha(e,t,i,s,r=!1,n=!1,o=0,a=0,l=1,h=0,c=0,u=0,d=0,p,_){var f,m,g,v,x,T;const E=0!==u,S=void 0===p,[b,C]=this._getPipeline(s,E?ru.InvertYPremultiplyAlphaWithOfst:ru.InvertYPremultiplyAlpha,{invertY:r,premultiplyAlpha:n});let y;if(o=Math.max(o,0),S&&(p=this._device.createCommandEncoder({})),null===(m=(f=p).pushDebugGroup)||void 0===m||m.call(f,`internal process texture - invertY=${r} premultiplyAlpha=${n}`),lu._IsHardwareTexture(e)?(y=e.underlyingResource,r&&!n&&1===l&&0===o||(e=void 0)):(y=e,e=void 0),!y)return;E&&this._bufferManager.setRawData(this._ubCopyWithOfst,0,new Float32Array([h,c,u,d]),0,16);const A=e,R=null!==(g=null==A?void 0:A._copyInvertYTempTexture)&&void 0!==g?g:this.createTexture({width:t,height:i,layers:1},!1,!1,!1,!1,!1,s,1,p,_c.CopySrc|_c.RenderAttachment|_c.TextureBinding,void 0,"TempTextureForCopyWithInvertY"),I=null!==(v=null==A?void 0:A._copyInvertYRenderPassDescr)&&void 0!==v?v:{colorAttachments:[{view:R.createView({format:s,dimension:fc.E2d,baseMipLevel:0,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:0}),loadOp:zc.Load,storeOp:Wc.Store}]},P=p.beginRenderPass(I);let M=E?null==A?void 0:A._copyInvertYBindGroupWithOfst:null==A?void 0:A._copyInvertYBindGroup;if(!M){const e={layout:C,entries:[{binding:0,resource:y.createView({format:s,dimension:fc.E2d,baseMipLevel:a,mipLevelCount:1,arrayLayerCount:l,baseArrayLayer:o})}]};E&&e.entries.push({binding:1,resource:{buffer:this._ubCopyWithOfst}}),M=this._device.createBindGroup(e)}P.setPipeline(b),P.setBindGroup(0,M),P.draw(4,1,0,0),P.end(),p.copyTextureToTexture({texture:R},{texture:y,mipLevel:a,origin:{x:0,y:0,z:o}},{width:t,height:i,depthOrArrayLayers:1}),A?(A._copyInvertYTempTexture=R,A._copyInvertYRenderPassDescr=I,E?A._copyInvertYBindGroupWithOfst=M:A._copyInvertYBindGroup=M):this._deferredReleaseTextures.push([R,null]),null===(T=(x=p).popDebugGroup)||void 0===T||T.call(x),S&&(this._device.queue.submit([p.finish()]),p=null)}copyWithInvertY(e,t,i,s){var r,n,o,a;const l=void 0===s,[h,c]=this._getPipeline(t,ru.InvertYPremultiplyAlpha,{invertY:!0,premultiplyAlpha:!1});l&&(s=this._device.createCommandEncoder({})),null===(n=(r=s).pushDebugGroup)||void 0===n||n.call(r,"internal copy texture with invertY");const u=s.beginRenderPass(i),d=this._device.createBindGroup({layout:c,entries:[{binding:0,resource:e}]});u.setPipeline(h),u.setBindGroup(0,d),u.draw(4,1,0,0),u.end(),null===(a=(o=s).popDebugGroup)||void 0===a||a.call(o),l&&(this._device.queue.submit([s.finish()]),s=null)}createTexture(e,t=!1,i=!1,s=!1,r=!1,n=!1,o=gc.RGBA8Unorm,a=1,l,h=-1,c=0,u){a=lu.GetSample(a);const d=e.layers||1,p={width:e.width,height:e.height,depthOrArrayLayers:d},_=au[o]?_c.RenderAttachment:0,f=lu.IsCompressedFormat(o),m=t?lu.ComputeNumMipmapLevels(e.width,e.height):1,g=h>=0?h:_c.CopySrc|_c.CopyDst|_c.TextureBinding;c|=t&&!f?_c.CopySrc|_:0,f||n||(c|=_|_c.CopyDst);const v=this._device.createTexture({label:`Texture${n?"3D":"2D"}_${u?u+"_":""}${p.width}x${p.height}x${p.depthOrArrayLayers}_${t?"wmips":"womips"}_${o}_samples${a}`,size:p,dimension:n?pc.E3d:pc.E2d,format:o,usage:g|c,sampleCount:a,mipLevelCount:m});return lu.IsImageBitmap(e)&&(this.updateTexture(e,v,e.width,e.height,d,o,0,0,s,r,0,0),t&&i&&this.generateMipmaps(v,o,m,0,l)),v}createCubeTexture(e,t=!1,i=!1,s=!1,r=!1,n=gc.RGBA8Unorm,o=1,a,l=-1,h=0,c){o=lu.GetSample(o);const u=lu.IsImageBitmapArray(e)?e[0].width:e.width,d=lu.IsImageBitmapArray(e)?e[0].height:e.height,p=au[n]?_c.RenderAttachment:0,_=lu.IsCompressedFormat(n),f=t?lu.ComputeNumMipmapLevels(u,d):1,m=l>=0?l:_c.CopySrc|_c.CopyDst|_c.TextureBinding;h|=t&&!_?_c.CopySrc|p:0,_||(h|=p|_c.CopyDst);const g=this._device.createTexture({label:`TextureCube_${c?c+"_":""}${u}x${d}x6_${t?"wmips":"womips"}_${n}_samples${o}`,size:{width:u,height:d,depthOrArrayLayers:6},dimension:pc.E2d,format:n,usage:m|h,sampleCount:o,mipLevelCount:f});return lu.IsImageBitmapArray(e)&&(this.updateCubeTextures(e,g,u,d,n,s,r,0,0),t&&i&&this.generateCubeMipmaps(g,n,f,a)),g}generateCubeMipmaps(e,t,i,s){var r,n,o,a;const l=void 0===s;l&&(s=this._device.createCommandEncoder({})),null===(n=(r=s).pushDebugGroup)||void 0===n||n.call(r,`create cube mipmaps - ${i} levels`);for(let r=0;r<6;++r)this.generateMipmaps(e,t,i,r,s);null===(a=(o=s).popDebugGroup)||void 0===a||a.call(o),l&&(this._device.queue.submit([s.finish()]),s=null)}generateMipmaps(e,t,i,s=0,r){var n,o,a,l,h,c,u,d;const p=void 0===r,[_,f]=this._getPipeline(t);let m;if(s=Math.max(s,0),p&&(r=this._device.createCommandEncoder({})),null===(o=(n=r).pushDebugGroup)||void 0===o||o.call(n,`create mipmaps for face #${s} - ${i} levels`),lu._IsHardwareTexture(e)?(m=e.underlyingResource,e._mipmapGenRenderPassDescr=e._mipmapGenRenderPassDescr||[],e._mipmapGenBindGroup=e._mipmapGenBindGroup||[]):(m=e,e=void 0),!m)return;const g=e;for(let e=1;e<i;++e){const i=null!==(l=null===(a=null==g?void 0:g._mipmapGenRenderPassDescr[s])||void 0===a?void 0:a[e-1])&&void 0!==l?l:{colorAttachments:[{view:m.createView({format:t,dimension:fc.E2d,baseMipLevel:e,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:s}),loadOp:zc.Load,storeOp:Wc.Store}]};g&&(g._mipmapGenRenderPassDescr[s]=g._mipmapGenRenderPassDescr[s]||[],g._mipmapGenRenderPassDescr[s][e-1]=i);const n=r.beginRenderPass(i),o=null!==(c=null===(h=null==g?void 0:g._mipmapGenBindGroup[s])||void 0===h?void 0:h[e-1])&&void 0!==c?c:this._device.createBindGroup({layout:f,entries:[{binding:0,resource:this._mipmapSampler},{binding:1,resource:m.createView({format:t,dimension:fc.E2d,baseMipLevel:e-1,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:s})}]});g&&(g._mipmapGenBindGroup[s]=g._mipmapGenBindGroup[s]||[],g._mipmapGenBindGroup[s][e-1]=o),n.setPipeline(_),n.setBindGroup(0,o),n.draw(4,1,0,0),n.end()}null===(d=(u=r).popDebugGroup)||void 0===d||d.call(u),p&&(this._device.queue.submit([r.finish()]),r=null)}createGPUTextureForInternalTexture(e,t,i,s,r){e._hardwareTexture||(e._hardwareTexture=new tu),void 0===t&&(t=e.width),void 0===i&&(i=e.height),void 0===s&&(s=e.depth);const n=e._hardwareTexture,o=!!(1&(null!=r?r:0));n.format=lu.GetWebGPUTextureFormat(e.type,e.format,e._useSRGBBuffer),n.textureUsages=e._source===ut.RenderTarget||e.source===ut.MultiRenderTarget?_c.TextureBinding|_c.CopySrc|_c.RenderAttachment:e._source===ut.DepthStencil?_c.TextureBinding|_c.RenderAttachment:-1,n.textureAdditionalUsages=o?_c.StorageBinding:0;const a=e.generateMipMaps,l=s||1;let h;if(h=null!==e._maxLodLevel?e._maxLodLevel:a?lu.ComputeNumMipmapLevels(t,i):1,e.isCube){const s=this.createCubeTexture({width:t,height:i},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,n.format,1,this._commandEncoderForCreation,n.textureUsages,n.textureAdditionalUsages,e.label);n.set(s),n.createView({format:lu.GetDepthFormatOnly(n.format),dimension:fc.Cube,mipLevelCount:h,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:6,aspect:lu.HasDepthAndStencilAspects(n.format)?mc.DepthOnly:mc.All},o)}else{const s=this.createTexture({width:t,height:i,layers:l},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,e.is3D,n.format,1,this._commandEncoderForCreation,n.textureUsages,n.textureAdditionalUsages,e.label);n.set(s),n.createView({format:lu.GetDepthFormatOnly(n.format),dimension:e.is2DArray?fc.E2dArray:e.is3D?pc.E3d:fc.E2d,mipLevelCount:h,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:e.is3D?1:l,aspect:lu.HasDepthAndStencilAspects(n.format)?mc.DepthOnly:mc.All},o)}return e.width=e.baseWidth=t,e.height=e.baseHeight=i,e.depth=e.baseDepth=s,this.createMSAATexture(e,e.samples),n}createMSAATexture(e,t,i=!0,s=-1){const r=e._hardwareTexture;if(i&&(null==r||r.releaseMSAATexture()),!r||(null!=t?t:1)<=1)return;const n=e.width,o=e.height,a=this.createTexture({width:n,height:o,layers:1},!1,!1,!1,!1,!1,r.format,t,this._commandEncoderForCreation,_c.RenderAttachment,0,e.label?"MSAA"+e.label:void 0);r.setMSAATexture(a,s)}updateCubeTextures(e,t,i,s,r,n=!1,o=!1,a=0,l=0){const h=[0,3,1,4,2,5];for(let c=0;c<h.length;++c){const u=e[h[c]];this.updateTexture(u,t,i,s,1,r,c,0,n,o,a,l)}}updateTexture(e,t,i,s,r,n,o=0,a=0,l=!1,h=!1,c=0,u=0,d){const p=lu._IsInternalTexture(t)?t._hardwareTexture.underlyingResource:t,_=lu._GetBlockInformationFromFormat(n),f=lu._IsInternalTexture(t)?t._hardwareTexture:t,m={texture:p,origin:{x:c,y:u,z:Math.max(o,0)},mipLevel:a,premultipliedAlpha:h},g={width:Math.ceil(i/_.width)*_.width,height:Math.ceil(s/_.height)*_.height,depthOrArrayLayers:r||1};if(void 0!==e.byteLength){const v=Math.ceil(i/_.width)*_.length;if(256*Math.ceil(v/256)===v){const t=this._device.createCommandEncoder({}),i=this._bufferManager.createRawBuffer(e.byteLength,uc.MapWrite|uc.CopySrc,!0,"TempBufferForUpdateTexture"+(p?"_"+p.label:"")),r=i.getMappedRange();new Uint8Array(r).set(e),i.unmap(),t.copyBufferToTexture({buffer:i,offset:0,bytesPerRow:v,rowsPerImage:s},m,g),this._device.queue.submit([t.finish()]),this._bufferManager.releaseBuffer(i)}else this._device.queue.writeTexture(m,e,{offset:0,bytesPerRow:v,rowsPerImage:s},g);if(l||h){if(!lu._IsInternalTexture(t))throw"updateTexture: Can't process the texture data because a GPUTexture was provided instead of an InternalTexture!";{const e=0===c&&0===u&&i===t.width&&s===t.height;this.invertYPreMultiplyAlpha(f,t.width,t.height,n,l,h,o,a,r||1,c,u,e?0:i,e?0:s,void 0,d)}}}else if(l)if(m.premultipliedAlpha=!1,lu._IsInternalTexture(t)&&0===c&&0===u&&i===t.width&&s===t.height)this._device.queue.copyExternalImageToTexture({source:e},m,g),this.invertYPreMultiplyAlpha(f,i,s,n,l,h,o,a,r||1,0,0,0,0,void 0,d);else{const t=this._device.createCommandEncoder({}),c=this.createTexture({width:i,height:s,layers:1},!1,!1,!1,!1,!1,n,1,t,_c.CopySrc|_c.TextureBinding,void 0,"TempTextureForUpdateTexture");this._deferredReleaseTextures.push([c,null]),g.depthOrArrayLayers=1,this._device.queue.copyExternalImageToTexture({source:e},{texture:c},g),g.depthOrArrayLayers=r||1,this.invertYPreMultiplyAlpha(c,i,s,n,l,h,o,a,r||1,0,0,0,0,t,d),t.copyTextureToTexture({texture:c},m,g),this._device.queue.submit([t.finish()])}else this._device.queue.copyExternalImageToTexture({source:e},m,g)}readPixels(e,t,i,s,r,n,o=0,a=0,l=null,h=!1){const c=lu._GetBlockInformationFromFormat(n),u=Math.ceil(s/c.width)*c.length,d=256*Math.ceil(u/256),p=d*r,_=this._bufferManager.createRawBuffer(p,uc.MapRead|uc.CopyDst,void 0,"TempBufferForReadPixels"+(e.label?"_"+e.label:"")),f=this._device.createCommandEncoder({});return f.copyTextureToBuffer({texture:e,mipLevel:a,origin:{x:t,y:i,z:Math.max(o,0)}},{buffer:_,offset:0,bytesPerRow:d},{width:s,height:r,depthOrArrayLayers:1}),this._device.queue.submit([f.finish()]),this._bufferManager.readDataFromBuffer(_,p,s,r,u,d,lu.GetTextureTypeFromFormat(n),0,l,!0,h)}releaseTexture(e){if(lu._IsInternalTexture(e)){const t=e._hardwareTexture,i=e._irradianceTexture;this._deferredReleaseTextures.push([t,i])}else this._deferredReleaseTextures.push([e,null])}destroyDeferredTextures(){for(let e=0;e<this._deferredReleaseTextures.length;++e){const[t,i]=this._deferredReleaseTextures[e];t&&(lu._IsHardwareTexture(t)?t.release():t.destroy()),null==i||i.dispose()}this._deferredReleaseTextures.length=0}}class hu extends mt{constructor(e,t=0){super(),this.capacity=t,this._buffer=e}get underlyingResource(){return this._buffer}}class cu{static _IsGPUBuffer(e){return void 0===e.underlyingResource}static _FlagsToString(e,t=""){let i=t;for(let t=0;t<=9;++t)e&1<<t&&(i&&(i+="_"),i+=uc[1<<t]);return i}constructor(e){this._deferredReleaseBuffers=[],this._device=e}createRawBuffer(e,t,i=!1,s){const r=void 0!==e.byteLength?e.byteLength+3&-4:e+3&-4,n={label:cu._FlagsToString(t,null!=s?s:"Buffer")+"_size"+r,mappedAtCreation:i,size:r,usage:t};return this._device.createBuffer(n)}createBuffer(e,t,i){const s=void 0!==e.byteLength,r=this.createRawBuffer(e,t,void 0,i),n=new hu(r);return n.references=1,n.capacity=s?e.byteLength:e,s&&this.setSubData(n,0,e),n}setRawData(e,t,i,s,r){this._device.queue.writeBuffer(e,t,i.buffer,s,r)}setSubData(e,t,i,s=0,r=0){const n=e.underlyingResource;r=r||i.byteLength,r=Math.min(r,e.capacity-t);let o=i.byteOffset+s,a=o+r;const l=r+3&-4;if(l!==r){const e=new Uint8Array(i.buffer.slice(o,a));(i=new Uint8Array(l)).set(e),s=0,o=0,a=l,r=l}const h=15728640;let c=0;for(;a-(o+c)>h;)this._device.queue.writeBuffer(n,t+c,i.buffer,o+c,h),c+=h;this._device.queue.writeBuffer(n,t+c,i.buffer,o+c,r-c)}_getHalfFloatAsFloatRGBAArrayBuffer(e,t,i){i||(i=new Float32Array(e));const s=new Uint16Array(t);for(;e--;)i[e]=Mh(s[e]);return i}readDataFromBuffer(e,t,i,s,r,n,o=0,a=0,l=null,h=!0,c=!1){const u=1===o?2:2===o?1:0;return new Promise(((i,d)=>{e.mapAsync(dc.Read,a,t).then((()=>{const d=e.getMappedRange(a,t);let p=l;if(c)p=null===p?Ds(o,t,!0,d):Ds(o,p.buffer,void 0,d);else if(null===p)switch(u){case 0:p=new Uint8Array(t),p.set(new Uint8Array(d));break;case 1:p=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,d);break;case 2:p=new Float32Array(t/4),p.set(new Float32Array(d))}else switch(u){case 0:p=new Uint8Array(p.buffer),p.set(new Uint8Array(d));break;case 1:p=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,d,l);break;case 2:p=new Float32Array(p.buffer),p.set(new Float32Array(d))}if(r!==n){1!==u||c||(r*=2,n*=2);const e=new Uint8Array(p.buffer);let t=r,i=0;for(let o=1;o<s;++o){i=o*n;for(let s=0;s<r;++s)e[t++]=e[i++]}p=0===u||c?new Uint8Array(e.buffer,0,t):new Float32Array(e.buffer,0,t/4)}e.unmap(),h&&this.releaseBuffer(e),i(p)}),(e=>d(e)))}))}releaseBuffer(e){return cu._IsGPUBuffer(e)?(this._deferredReleaseBuffers.push(e),!0):(e.references--,0===e.references&&(this._deferredReleaseBuffers.push(e.underlyingResource),!0))}destroyDeferredBuffers(){for(let e=0;e<this._deferredReleaseBuffers.length;++e)this._deferredReleaseBuffers[e].destroy();this._deferredReleaseBuffers.length=0}}const uu=[0,0,3,7,0,2,6,2,4,1,5,3,1],du=[0,64,32,96,16,80,48,112,8],pu=[0,128,128,0,0,0,0,128,0,0,0,0,128];class _u{constructor(e){this._samplers={},this._device=e,this.disabled=!1}static GetSamplerHashCode(e){var t,i,s;const r=e._cachedAnisotropicFilteringLevel&&e._cachedAnisotropicFilteringLevel>1?4:1;return uu[e.samplingMode]+du[(e._comparisonFunction||514)-512+1]+pu[e.samplingMode]+((null!==(t=e._cachedWrapU)&&void 0!==t?t:1)<<8)+((null!==(i=e._cachedWrapV)&&void 0!==i?i:1)<<10)+((null!==(s=e._cachedWrapR)&&void 0!==s?s:1)<<12)+((e.useMipMaps?1:0)<<14)+(r<<15)}static _GetSamplerFilterDescriptor(e,t){let i,s,r,n,o;const a=e.useMipMaps;switch(e.samplingMode){case 11:i=xc.Linear,s=xc.Linear,r=xc.Nearest,a||(n=o=0);break;case 3:case 3:i=xc.Linear,s=xc.Linear,a?r=xc.Linear:(r=xc.Nearest,n=o=0);break;case 8:i=xc.Nearest,s=xc.Nearest,a?r=xc.Linear:(r=xc.Nearest,n=o=0);break;case 4:i=xc.Nearest,s=xc.Nearest,r=xc.Nearest,a||(n=o=0);break;case 5:i=xc.Nearest,s=xc.Linear,r=xc.Nearest,a||(n=o=0);break;case 6:i=xc.Nearest,s=xc.Linear,a?r=xc.Linear:(r=xc.Nearest,n=o=0);break;case 7:i=xc.Nearest,s=xc.Linear,r=xc.Nearest,n=o=0;break;case 1:case 1:default:i=xc.Nearest,s=xc.Nearest,r=xc.Nearest,n=o=0;break;case 9:i=xc.Linear,s=xc.Nearest,r=xc.Nearest,a||(n=o=0);break;case 10:i=xc.Linear,s=xc.Nearest,a?r=xc.Linear:(r=xc.Nearest,n=o=0);break;case 2:case 2:i=xc.Linear,s=xc.Linear,r=xc.Nearest,n=o=0;break;case 12:i=xc.Linear,s=xc.Nearest,r=xc.Nearest,n=o=0}return t>1&&(0!==n||0!==o)&&r!==xc.Nearest?{magFilter:xc.Linear,minFilter:xc.Linear,mipmapFilter:xc.Linear,anisotropyEnabled:!0}:{magFilter:i,minFilter:s,mipmapFilter:r,lodMinClamp:n,lodMaxClamp:o}}static _GetWrappingMode(e){switch(e){case 1:return vc.Repeat;case 0:return vc.ClampToEdge;case 2:return vc.MirrorRepeat}return vc.Repeat}static _GetSamplerWrappingDescriptor(e){return{addressModeU:this._GetWrappingMode(e._cachedWrapU),addressModeV:this._GetWrappingMode(e._cachedWrapV),addressModeW:this._GetWrappingMode(e._cachedWrapR)}}static _GetSamplerDescriptor(e,t){const i=e.useMipMaps&&e._cachedAnisotropicFilteringLevel&&e._cachedAnisotropicFilteringLevel>1?4:1,s=this._GetSamplerFilterDescriptor(e,i);return Object.assign(Object.assign(Object.assign({label:t},s),this._GetSamplerWrappingDescriptor(e)),{compare:e._comparisonFunction?_u.GetCompareFunction(e._comparisonFunction):void 0,maxAnisotropy:s.anisotropyEnabled?i:1})}static GetCompareFunction(e){switch(e){case 519:return Ec.Always;case 514:return Ec.Equal;case 516:return Ec.Greater;case 518:return Ec.GreaterEqual;case 513:default:return Ec.Less;case 515:return Ec.LessEqual;case 512:return Ec.Never;case 517:return Ec.NotEqual}}getSampler(e,t=!1,i=0,s){if(this.disabled)return this._device.createSampler(_u._GetSamplerDescriptor(e,s));t?i=0:0===i&&(i=_u.GetSamplerHashCode(e));let r=t?void 0:this._samplers[i];return r||(r=this._device.createSampler(_u._GetSamplerDescriptor(e,s)),t||(this._samplers[i]=r)),r}}var fu;!function(e){e[e.StencilReadMask=0]="StencilReadMask",e[e.StencilWriteMask=1]="StencilWriteMask",e[e.DepthBias=2]="DepthBias",e[e.DepthBiasSlopeScale=3]="DepthBiasSlopeScale",e[e.DepthStencilState=4]="DepthStencilState",e[e.MRTAttachments1=5]="MRTAttachments1",e[e.MRTAttachments2=6]="MRTAttachments2",e[e.RasterizationState=7]="RasterizationState",e[e.ColorStates=8]="ColorStates",e[e.ShaderStage=9]="ShaderStage",e[e.TextureStage=10]="TextureStage",e[e.VertexState=11]="VertexState",e[e.NumStates=12]="NumStates"}(fu||(fu={}));const mu={0:1,1:2,768:3,769:4,770:5,771:6,772:7,773:8,774:9,775:10,776:11,32769:12,32770:13,32771:12,32772:13},gu={0:0,7680:1,7681:2,7682:3,7683:4,5386:5,34055:6,34056:7},vu={[hi.PositionKind]:!0,[hi.NormalKind]:!0,[hi.TangentKind]:!0,[hi.UVKind]:!0,[hi.UV2Kind]:!0,[hi.UV3Kind]:!0,[hi.UV4Kind]:!0,[hi.UV5Kind]:!0,[hi.UV6Kind]:!0,[hi.ColorKind]:!0,[hi.ColorInstanceKind]:!0,[hi.MatricesIndicesKind]:!0,[hi.MatricesWeightsKind]:!0,[hi.MatricesIndicesExtraKind]:!0,[hi.MatricesWeightsExtraKind]:!0};class xu{static _IsSignedType(e){switch(e){case hi.BYTE:case hi.SHORT:case hi.INT:case hi.FLOAT:return!0;case hi.UNSIGNED_BYTE:case hi.UNSIGNED_SHORT:case hi.UNSIGNED_INT:return!1;default:throw new Error(`Invalid type '${e}'`)}}constructor(e,t){this.mrtTextureCount=0,this._device=e,this._useTextureStage=!0,this._states=new Array(30),this._statesLength=0,this._stateDirtyLowestIndex=0,this._emptyVertexBuffer=t,this._mrtFormats=[],this._parameter={token:void 0,pipeline:null},this.disabled=!1,this.vertexBuffers=[],this._kMaxVertexBufferStride=e.limits.maxVertexBufferArrayStride||2048,this.reset()}reset(){this._isDirty=!0,this.vertexBuffers.length=0,this.setAlphaToCoverage(!1),this.resetDepthCullingState(),this.setClampDepth(!1),this.setDepthBias(0),this._webgpuColorFormat=[gc.BGRA8Unorm],this.setColorFormat(gc.BGRA8Unorm),this.setMRT([]),this.setAlphaBlendEnabled(!1),this.setAlphaBlendFactors([null,null,null,null],[null,null]),this.setWriteMask(15),this.setDepthStencilFormat(gc.Depth24PlusStencil8),this.setStencilEnabled(!1),this.resetStencilState(),this.setBuffers(null,null,null),this._setTextureState(0)}get colorFormats(){return this._mrtAttachments1>0?this._mrtFormats:this._webgpuColorFormat}getRenderPipeline(e,t,i,s=0){if(i=lu.GetSample(i),this.disabled){const r=xu._GetTopology(e);return this._setVertexState(t),this._setTextureState(s),this._parameter.pipeline=this._createRenderPipeline(t,r,i),xu.NumCacheMiss++,xu._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}if(this._setShaderStage(t.uniqueId),this._setRasterizationState(e,i),this._setColorStates(),this._setDepthStencilState(),this._setVertexState(t),this._setTextureState(s),this.lastStateDirtyLowestIndex=this._stateDirtyLowestIndex,!this._isDirty&&this._parameter.pipeline)return this._stateDirtyLowestIndex=this._statesLength,xu.NumCacheHitWithoutHash++,this._parameter.pipeline;if(this._getRenderPipeline(this._parameter),this._isDirty=!1,this._stateDirtyLowestIndex=this._statesLength,this._parameter.pipeline)return xu.NumCacheHitWithHash++,this._parameter.pipeline;const r=xu._GetTopology(e);return this._parameter.pipeline=this._createRenderPipeline(t,r,i),this._setRenderPipeline(this._parameter),xu.NumCacheMiss++,xu._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}endFrame(){xu.NumPipelineCreationLastFrame=xu._NumPipelineCreationCurrentFrame,xu._NumPipelineCreationCurrentFrame=0}setAlphaToCoverage(e){this._alphaToCoverageEnabled=e}setFrontFace(e){this._frontFace=e}setCullEnabled(e){this._cullEnabled=e}setCullFace(e){this._cullFace=e}setClampDepth(e){this._clampDepth=e}resetDepthCullingState(){this.setDepthCullingState(!1,2,1,0,0,!0,!0,519)}setDepthCullingState(e,t,i,s,r,n,o,a){this._depthWriteEnabled=o,this._depthTestEnabled=n,this._depthCompare=(null!=a?a:519)-512,this._cullFace=i,this._cullEnabled=e,this._frontFace=t,this.setDepthBiasSlopeScale(s),this.setDepthBias(r)}setDepthBias(e){this._depthBias!==e&&(this._depthBias=e,this._states[fu.DepthBias]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,fu.DepthBias))}setDepthBiasSlopeScale(e){this._depthBiasSlopeScale!==e&&(this._depthBiasSlopeScale=e,this._states[fu.DepthBiasSlopeScale]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,fu.DepthBiasSlopeScale))}setColorFormat(e){this._webgpuColorFormat[0]=e,this._colorFormat=au[null!=e?e:""]}setMRTAttachments(e){this.mrtAttachments=e;let t=0;for(let i=0;i<e.length;++i)0!==e[i]&&(t+=1<<i);this._mrtEnabledMask!==t&&(this._mrtEnabledMask=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,fu.MRTAttachments1))}setMRT(e,t){var i,s;if((t=null!=t?t:e.length)>10)throw"Can't handle more than 10 attachments for a MRT in cache render pipeline!";this.mrtTextureArray=e,this.mrtTextureCount=t,this._mrtEnabledMask=65535;const r=[0,0];let n=0,o=0,a=0;for(let l=0;l<t;++l){const t=e[l],h=null==t?void 0:t._hardwareTexture;this._mrtFormats[a]=null!==(i=null==h?void 0:h.format)&&void 0!==i?i:this._webgpuColorFormat[0],r[n]+=au[null!==(s=this._mrtFormats[a])&&void 0!==s?s:""]<<o,o+=6,a++,o>=32&&(o=0,n++)}this._mrtFormats.length=a,this._mrtAttachments1===r[0]&&this._mrtAttachments2===r[1]||(this._mrtAttachments1=r[0],this._mrtAttachments2=r[1],this._states[fu.MRTAttachments1]=r[0],this._states[fu.MRTAttachments2]=r[1],this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,fu.MRTAttachments1))}setAlphaBlendEnabled(e){this._alphaBlendEnabled=e}setAlphaBlendFactors(e,t){this._alphaBlendFuncParams=e,this._alphaBlendEqParams=t}setWriteMask(e){this._writeMask=e}setDepthStencilFormat(e){this._webgpuDepthStencilFormat=e,this._depthStencilFormat=void 0===e?0:au[e]}setDepthTestEnabled(e){this._depthTestEnabled=e}setDepthWriteEnabled(e){this._depthWriteEnabled=e}setDepthCompare(e){this._depthCompare=(null!=e?e:519)-512}setStencilEnabled(e){this._stencilEnabled=e}setStencilCompare(e){this._stencilFrontCompare=(null!=e?e:519)-512}setStencilDepthFailOp(e){this._stencilFrontDepthFailOp=null===e?1:gu[e]}setStencilPassOp(e){this._stencilFrontPassOp=null===e?2:gu[e]}setStencilFailOp(e){this._stencilFrontFailOp=null===e?1:gu[e]}setStencilReadMask(e){this._stencilReadMask!==e&&(this._stencilReadMask=e,this._states[fu.StencilReadMask]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,fu.StencilReadMask))}setStencilWriteMask(e){this._stencilWriteMask!==e&&(this._stencilWriteMask=e,this._states[fu.StencilWriteMask]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,fu.StencilWriteMask))}resetStencilState(){this.setStencilState(!1,519,7680,7681,7680,255,255)}setStencilState(e,t,i,s,r,n,o){this._stencilEnabled=e,this._stencilFrontCompare=(null!=t?t:519)-512,this._stencilFrontDepthFailOp=null===i?1:gu[i],this._stencilFrontPassOp=null===s?2:gu[s],this._stencilFrontFailOp=null===r?1:gu[r],this.setStencilReadMask(n),this.setStencilWriteMask(o)}setBuffers(e,t,i){this._vertexBuffers=e,this._overrideVertexBuffers=i,this._indexBuffer=t}static _GetTopology(e){switch(e){case 0:default:return Mc.TriangleList;case 2:case 3:return Mc.PointList;case 1:case 4:return Mc.LineList;case 5:throw"LineLoop is an unsupported fillmode in WebGPU";case 6:return Mc.LineStrip;case 7:return Mc.TriangleStrip;case 8:throw"TriangleFan is an unsupported fillmode in WebGPU"}}static _GetAphaBlendOperation(e){switch(e){case 32774:default:return wc.Add;case 32778:return wc.Subtract;case 32779:return wc.ReverseSubtract;case 32775:return wc.Min;case 32776:return wc.Max}}static _GetAphaBlendFactor(e){switch(e){case 0:return Fc.Zero;case 1:default:return Fc.One;case 768:return Fc.Src;case 769:return Fc.OneMinusSrc;case 770:return Fc.SrcAlpha;case 771:return Fc.OneMinusSrcAlpha;case 772:return Fc.DstAlpha;case 773:return Fc.OneMinusDstAlpha;case 774:return Fc.Dst;case 775:return Fc.OneMinusDst;case 776:return Fc.SrcAlphaSaturated;case 32769:case 32771:return Fc.Constant;case 32770:case 32772:return Fc.OneMinusConstant}}static _GetCompareFunction(e){switch(e){case 0:return Ec.Never;case 1:return Ec.Less;case 2:return Ec.Equal;case 3:return Ec.LessEqual;case 4:return Ec.Greater;case 5:return Ec.NotEqual;case 6:return Ec.GreaterEqual;case 7:return Ec.Always}return Ec.Never}static _GetStencilOpFunction(e){switch(e){case 0:return Lc.Zero;case 1:return Lc.Keep;case 2:return Lc.Replace;case 3:return Lc.IncrementClamp;case 4:return Lc.DecrementClamp;case 5:return Lc.Invert;case 6:return Lc.IncrementWrap;case 7:return Lc.DecrementWrap}return Lc.Keep}static _GetVertexInputDescriptorFormat(e){const t=e.type,i=e.normalized,s=e.getSize();switch(t){case hi.BYTE:switch(s){case 1:case 2:return i?Uc.Snorm8x2:Uc.Sint8x2;case 3:case 4:return i?Uc.Snorm8x4:Uc.Sint8x4}break;case hi.UNSIGNED_BYTE:switch(s){case 1:case 2:return i?Uc.Unorm8x2:Uc.Uint8x2;case 3:case 4:return i?Uc.Unorm8x4:Uc.Uint8x4}break;case hi.SHORT:switch(s){case 1:case 2:return i?Uc.Snorm16x2:Uc.Sint16x2;case 3:case 4:return i?Uc.Snorm16x4:Uc.Sint16x4}break;case hi.UNSIGNED_SHORT:switch(s){case 1:case 2:return i?Uc.Unorm16x2:Uc.Uint16x2;case 3:case 4:return i?Uc.Unorm16x4:Uc.Uint16x4}break;case hi.INT:switch(s){case 1:return Uc.Sint32;case 2:return Uc.Sint32x2;case 3:return Uc.Sint32x3;case 4:return Uc.Sint32x4}break;case hi.UNSIGNED_INT:switch(s){case 1:return Uc.Uint32;case 2:return Uc.Uint32x2;case 3:return Uc.Uint32x3;case 4:return Uc.Uint32x4}break;case hi.FLOAT:switch(s){case 1:return Uc.Float32;case 2:return Uc.Float32x2;case 3:return Uc.Float32x3;case 4:return Uc.Float32x4}}throw new Error(`Invalid Format '${e.getKind()}' - type=${t}, normalized=${i}, size=${s}`)}_getAphaBlendState(){return this._alphaBlendEnabled?{srcFactor:xu._GetAphaBlendFactor(this._alphaBlendFuncParams[2]),dstFactor:xu._GetAphaBlendFactor(this._alphaBlendFuncParams[3]),operation:xu._GetAphaBlendOperation(this._alphaBlendEqParams[1])}:null}_getColorBlendState(){return this._alphaBlendEnabled?{srcFactor:xu._GetAphaBlendFactor(this._alphaBlendFuncParams[0]),dstFactor:xu._GetAphaBlendFactor(this._alphaBlendFuncParams[1]),operation:xu._GetAphaBlendOperation(this._alphaBlendEqParams[0])}:null}_setShaderStage(e){this._shaderId!==e&&(this._shaderId=e,this._states[fu.ShaderStage]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,fu.ShaderStage))}_setRasterizationState(e,t){const i=this._frontFace-1+((this._cullEnabled?this._cullFace:0)<<1)+((this._clampDepth?1:0)<<3)+((this._alphaToCoverageEnabled?1:0)<<4)+(e<<5)+(t<<8);this._rasterizationState!==i&&(this._rasterizationState=i,this._states[fu.RasterizationState]=this._rasterizationState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,fu.RasterizationState))}_setColorStates(){let e=((this._writeMask?1:0)<<22)+(this._colorFormat<<23)+((this._depthWriteEnabled?1:0)<<29);this._alphaBlendEnabled&&(e+=(0|(null===this._alphaBlendFuncParams[0]?2:mu[this._alphaBlendFuncParams[0]]))+((null===this._alphaBlendFuncParams[1]?2:mu[this._alphaBlendFuncParams[1]])<<4)+((null===this._alphaBlendFuncParams[2]?2:mu[this._alphaBlendFuncParams[2]])<<8)+((null===this._alphaBlendFuncParams[3]?2:mu[this._alphaBlendFuncParams[3]])<<12)+((null===this._alphaBlendEqParams[0]?1:this._alphaBlendEqParams[0]-32773)<<16)+((null===this._alphaBlendEqParams[1]?1:this._alphaBlendEqParams[1]-32773)<<19)),e!==this._colorStates&&(this._colorStates=e,this._states[fu.ColorStates]=this._colorStates,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,fu.ColorStates))}_setDepthStencilState(){const e=this._stencilEnabled?this._stencilFrontCompare+(this._stencilFrontDepthFailOp<<3)+(this._stencilFrontPassOp<<6)+(this._stencilFrontFailOp<<9):591,t=this._depthStencilFormat+((this._depthTestEnabled?this._depthCompare:7)<<6)+(e<<10);this._depthStencilState!==t&&(this._depthStencilState=t,this._states[fu.DepthStencilState]=this._depthStencilState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,fu.DepthStencilState))}_setVertexState(e){var t,i;const s=this._statesLength;let r=fu.VertexState;const n=e._pipelineContext,o=n.shaderProcessingContext.attributeNamesFromEffect,a=n.shaderProcessingContext.attributeLocationsFromEffect;let l,h=0;for(let e=0;e<o.length;e++){const s=a[e];let n=null!==(t=this._overrideVertexBuffers&&this._overrideVertexBuffers[o[e]])&&void 0!==t?t:this._vertexBuffers[o[e]];n||(n=this._emptyVertexBuffer);const c=null===(i=n.effectiveBuffer)||void 0===i?void 0:i.underlyingResource;if(void 0===n._validOffsetRange){const e=n.effectiveByteOffset,t=n.getSize(!0),i=n.effectiveByteStride;n._validOffsetRange=e+t<=this._kMaxVertexBufferStride&&0===i||0!==i&&e+t<=i}l&&l===c&&n._validOffsetRange||(this.vertexBuffers[h++]=n,l=n._validOffsetRange?c:null);const u=n.hashCode+(s<<7);this._isDirty=this._isDirty||this._states[r]!==u,this._states[r++]=u}this.vertexBuffers.length=h,this._statesLength=r,this._isDirty=this._isDirty||r!==s,this._isDirty&&(this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,fu.VertexState))}_setTextureState(e){this._textureState!==e&&(this._textureState=e,this._states[fu.TextureStage]=this._textureState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,fu.TextureStage))}_createPipelineLayout(e){if(this._useTextureStage)return this._createPipelineLayoutWithTextureStage(e);const t=[],i=e.shaderProcessingContext.bindGroupLayoutEntries;for(let e=0;e<i.length;e++){const s=i[e];t[e]=this._device.createBindGroupLayout({entries:s})}return e.bindGroupLayouts[0]=t,this._device.createPipelineLayout({bindGroupLayouts:t})}_createPipelineLayoutWithTextureStage(e){var t;const i=e.shaderProcessingContext,s=i.bindGroupLayoutEntries;let r=1;for(let e=0;e<s.length;e++){const n=s[e];for(let o=0;o<n.length;o++){const n=s[e][o];if(n.texture){const o=i.bindGroupLayoutEntryInfo[e][n.binding].name,a=i.availableTextures[o],l=a.autoBindSampler?i.availableSamplers[o+Kc.AutoSamplerSuffix]:null;let h=a.sampleType,c=null!==(t=null==l?void 0:l.type)&&void 0!==t?t:Cc.Filtering;if(this._textureState&r&&h!==yc.Depth&&(a.autoBindSampler&&(c=Cc.NonFiltering),h=yc.UnfilterableFloat),n.texture.sampleType=h,l){const e=i.bindGroupLayoutEntryInfo[l.binding.groupIndex][l.binding.bindingIndex].index;s[l.binding.groupIndex][e].sampler.type=c}r<<=1}}}const n=[];for(let e=0;e<s.length;++e)n[e]=this._device.createBindGroupLayout({entries:s[e]});return e.bindGroupLayouts[this._textureState]=n,this._device.createPipelineLayout({bindGroupLayouts:n})}_getVertexInputDescriptor(e){var t,i;const s=[],r=e._pipelineContext,n=r.shaderProcessingContext.attributeNamesFromEffect,o=r.shaderProcessingContext.attributeLocationsFromEffect;let a,l;for(let e=0;e<n.length;e++){const r=o[e];let h=null!==(t=this._overrideVertexBuffers&&this._overrideVertexBuffers[n[e]])&&void 0!==t?t:this._vertexBuffers[n[e]];h||(h=this._emptyVertexBuffer);let c=null===(i=h.effectiveBuffer)||void 0===i?void 0:i.underlyingResource,u=h.effectiveByteOffset;const d=!h._validOffsetRange;if(!a||!l||a!==c||d){const e={arrayStride:h.effectiveByteStride,stepMode:h.getIsInstanced()?Vc.Instance:Vc.Vertex,attributes:[]};s.push(e),l=e.attributes,d&&(u=0,c=null)}l.push({shaderLocation:r,offset:u,format:xu._GetVertexInputDescriptorFormat(h)}),a=c}return s}_processNonFloatVertexBuffers(e,t){const i=e.engine._getShaderProcessor(e.shaderProcessingContext.shaderLanguage);let s=!1;for(const t in this._vertexBuffers){const r=this._vertexBuffers[t];if(!r||!vu[t])continue;const n=r.normalized?hi.FLOAT:r.type,o=e.vertexBufferKindToType[t];(n!==hi.FLOAT&&void 0===o||void 0!==o&&o!==n)&&(s=!0,e.vertexBufferKindToType[t]=n,n!==hi.FLOAT&&(i.vertexBufferKindToNumberOfComponents[t]=hi.DeduceStride(t),xu._IsSignedType(n)&&(i.vertexBufferKindToNumberOfComponents[t]*=-1)))}s&&t._processShaderCode(i,!0)}_createRenderPipeline(e,t,i){var s,r,n;const o=e._pipelineContext,a=this._getVertexInputDescriptor(e),l=this._createPipelineLayout(o),h=[],c=this._getAphaBlendState(),u=this._getColorBlendState();if(this._processNonFloatVertexBuffers(o,e),this._mrtAttachments1>0)for(let e=0;e<this._mrtFormats.length;++e){const t=this._mrtFormats[e];if(t){const i={format:t,writeMask:this._mrtEnabledMask&1<<e?this._writeMask:0};c&&u&&(i.blend={alpha:c,color:u}),h.push(i)}else h.push(null)}else if(this._webgpuColorFormat[0]){const e={format:this._webgpuColorFormat[0],writeMask:this._writeMask};c&&u&&(e.blend={alpha:c,color:u}),h.push(e)}else h.push(null);const d={compare:xu._GetCompareFunction(this._stencilEnabled?this._stencilFrontCompare:7),depthFailOp:xu._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontDepthFailOp:1),failOp:xu._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontFailOp:1),passOp:xu._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontPassOp:1)};let p;t!==Mc.LineStrip&&t!==Mc.TriangleStrip||(p=!this._indexBuffer||this._indexBuffer.is32Bits?Bc.Uint32:Bc.Uint16);const _=!!this._webgpuDepthStencilFormat&&lu.HasStencilAspect(this._webgpuDepthStencilFormat);return this._device.createRenderPipeline({label:`RenderPipeline_${null!==(r=null===(s=h[0])||void 0===s?void 0:s.format)&&void 0!==r?r:"nooutput"}_${null!==(n=this._webgpuDepthStencilFormat)&&void 0!==n?n:"nodepth"}_samples${i}_textureState${this._textureState}`,layout:l,vertex:{module:o.stages.vertexStage.module,entryPoint:o.stages.vertexStage.entryPoint,buffers:a},primitive:{topology:t,stripIndexFormat:p,frontFace:1===this._frontFace?Oc.CCW:Oc.CW,cullMode:this._cullEnabled?2===this._cullFace?Dc.Front:Dc.Back:Dc.None},fragment:o.stages.fragmentStage?{module:o.stages.fragmentStage.module,entryPoint:o.stages.fragmentStage.entryPoint,targets:h}:void 0,multisample:{count:i},depthStencil:void 0===this._webgpuDepthStencilFormat?void 0:{depthWriteEnabled:this._depthWriteEnabled,depthCompare:this._depthTestEnabled?xu._GetCompareFunction(this._depthCompare):Ec.Always,format:this._webgpuDepthStencilFormat,stencilFront:this._stencilEnabled&&_?d:void 0,stencilBack:this._stencilEnabled&&_?d:void 0,stencilReadMask:this._stencilEnabled&&_?this._stencilReadMask:void 0,stencilWriteMask:this._stencilEnabled&&_?this._stencilWriteMask:void 0,depthBias:this._depthBias,depthBiasClamp:this._depthBiasClamp,depthBiasSlopeScale:this._depthBiasSlopeScale}})}}xu.NumCacheHitWithoutHash=0,xu.NumCacheHitWithHash=0,xu.NumCacheMiss=0,xu.NumPipelineCreationLastFrame=0,xu._NumPipelineCreationCurrentFrame=0;class Tu{constructor(){this.values={}}count(){let e=0,t=this.pipeline?1:0;for(const i in this.values){const s=this.values[i],[r,n]=s.count();e+=r,t+=n,e++}return[e,t]}}class Eu extends xu{static GetNodeCounts(){const e=Eu._Cache.count();return{nodeCount:e[0],pipelineCount:e[1]}}static _GetPipelines(e,t,i,s){if(e.pipeline){const e=i.slice();e.length=s,t.push(e)}for(const r in e.values){const n=e.values[r];i[s]=parseInt(r),Eu._GetPipelines(n,t,i,s+1)}}static GetPipelines(){const e=[];return Eu._GetPipelines(Eu._Cache,e,[],0),e}constructor(e,t){super(e,t),this._nodeStack=[],this._nodeStack[0]=Eu._Cache}_getRenderPipeline(e){let t=this._nodeStack[this._stateDirtyLowestIndex];for(let e=this._stateDirtyLowestIndex;e<this._statesLength;++e){let i=t.values[this._states[e]];i||(i=new Tu,t.values[this._states[e]]=i),t=i,this._nodeStack[e+1]=t}e.token=t,e.pipeline=t.pipeline}_setRenderPipeline(e){e.token.pipeline=e.pipeline}}Eu._Cache=new Tu;class Su extends Et{constructor(e){super(!1),this._cache=e,this.reset()}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._cache.setStencilCompare(e))}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._cache.setStencilReadMask(e))}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._cache.setStencilFailOp(e))}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._cache.setStencilDepthFailOp(e))}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._cache.setStencilPassOp(e))}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._cache.setStencilWriteMask(e))}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._cache.setStencilEnabled(e))}reset(){super.reset(),this._cache.resetStencilState()}apply(){var e;const t=null===(e=this.stencilMaterial)||void 0===e?void 0:e.enabled;this.enabled=t?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.enabled&&(this.func=t?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=t?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=t?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=t?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=t?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=t?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=t?this.stencilMaterial.mask:this.stencilGlobal.mask)}}class bu extends at{constructor(e){super(!1),this._cache=e,this.reset()}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0,this._cache.setDepthBiasSlopeScale(e))}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0,this._cache.setDepthBias(e))}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0,this._cache.setCullFace(null!=e?e:1))}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0,this._cache.setCullEnabled(!!e))}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0,this._cache.setDepthCompare(e))}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0,this._cache.setDepthWriteEnabled(e))}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0,this._cache.setDepthTestEnabled(e))}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0,this._cache.setFrontFace(null!=e?e:2))}reset(){super.reset(),this._cache.resetDepthCullingState()}apply(){}}class Cu{static IsExternalTexture(e){return void 0!==e.underlyingResource}getClassName(){return"ExternalTexture"}get underlyingResource(){return this._video}constructor(e){this.useMipMaps=!1,this.type=16,this.format=4294967295,this._video=e,this.uniqueId=dt._Counter++}isReady(){return this._video.readyState>=this._video.HAVE_CURRENT_DATA}dispose(){}}class yu{get forceBindGroupCreation(){return this._numExternalTextures>0}get hasFloatOrDepthTextures(){return this._numFloatOrDepthTextures>0}constructor(){this.uniqueId=yu._Counter++,this.updateId=0,this.textureState=0,this.reset()}reset(){this.samplers={},this.textures={},this.isDirty=!0,this._numFloatOrDepthTextures=0,this._numExternalTextures=0}setSampler(e,t){let i=this.samplers[e],s=-1;i?s=i.hashCode:this.samplers[e]=i={sampler:t,hashCode:0},i.sampler=t,i.hashCode=t?_u.GetSamplerHashCode(t):0;const r=s!==i.hashCode;r&&this.updateId++,this.isDirty||(this.isDirty=r)}setTexture(e,t){var i,s,r;let n=this.textures[e],o=-1;n?o=null!==(s=null===(i=n.texture)||void 0===i?void 0:i.uniqueId)&&void 0!==s?s:-1:this.textures[e]=n={texture:t,isFloatOrDepthTexture:!1,isExternalTexture:!1},n.isExternalTexture&&this._numExternalTextures--,n.isFloatOrDepthTexture&&this._numFloatOrDepthTextures--,t?(n.isFloatOrDepthTexture=1===t.type||t.format>=13&&t.format<=18,n.isExternalTexture=Cu.IsExternalTexture(t),n.isFloatOrDepthTexture&&this._numFloatOrDepthTextures++,n.isExternalTexture&&this._numExternalTextures++):(n.isFloatOrDepthTexture=!1,n.isExternalTexture=!1),n.texture=t;const a=o!==(null!==(r=null==t?void 0:t.uniqueId)&&void 0!==r?r:-1);a&&this.updateId++,this.isDirty||(this.isDirty=a)}}yu._Counter=0;class Au{isDirty(e){return this._isDirty||this._materialContextUpdateId!==e}resetIsDirty(e){this._isDirty=!1,this._materialContextUpdateId=e}get useInstancing(){return this._useInstancing}set useInstancing(e){this._useInstancing!==e&&(e?(this.indirectDrawBuffer=this._bufferManager.createRawBuffer(20,uc.CopyDst|uc.Indirect|uc.Storage,void 0,"IndirectDrawBuffer"),this._indirectDrawData=new Uint32Array(5),this._indirectDrawData[3]=0,this._indirectDrawData[4]=0):(this.indirectDrawBuffer&&this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this._useInstancing=e,this._currentInstanceCount=-1)}constructor(e){this._bufferManager=e,this.uniqueId=Au._Counter++,this._useInstancing=!1,this._currentInstanceCount=0,this.reset()}reset(){this.buffers={},this._isDirty=!0,this._materialContextUpdateId=0,this.fastBundle=void 0,this.bindGroups=void 0}setBuffer(e,t){var i;this._isDirty||(this._isDirty=(null==t?void 0:t.uniqueId)!==(null===(i=this.buffers[e])||void 0===i?void 0:i.uniqueId)),this.buffers[e]=t}setIndirectData(e,t,i){t!==this._currentInstanceCount&&this.indirectDrawBuffer&&this._indirectDrawData&&(this._currentInstanceCount=t,this._indirectDrawData[0]=e,this._indirectDrawData[1]=t,this._indirectDrawData[2]=i,this._bufferManager.setRawData(this.indirectDrawBuffer,0,this._indirectDrawData,0,20))}dispose(){this.indirectDrawBuffer&&(this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this.fastBundle=void 0,this.bindGroups=void 0,this.buffers=void 0}}Au._Counter=0;class Ru{constructor(){this.values={}}}class Iu{static get Statistics(){return{totalCreated:Iu.NumBindGroupsCreatedTotal,lastFrameCreated:Iu.NumBindGroupsCreatedLastFrame,lookupLastFrame:Iu.NumBindGroupsLookupLastFrame,noLookupLastFrame:Iu.NumBindGroupsNoLookupLastFrame}}constructor(e,t,i){this.disabled=!1,this._device=e,this._cacheSampler=t,this._engine=i}endFrame(){Iu.NumBindGroupsCreatedLastFrame=Iu._NumBindGroupsCreatedCurrentFrame,Iu.NumBindGroupsLookupLastFrame=Iu._NumBindGroupsLookupCurrentFrame,Iu.NumBindGroupsNoLookupLastFrame=Iu._NumBindGroupsNoLookupCurrentFrame,Iu._NumBindGroupsCreatedCurrentFrame=0,Iu._NumBindGroupsLookupCurrentFrame=0,Iu._NumBindGroupsNoLookupCurrentFrame=0}getBindGroups(e,t,i){var s,r,n,o,a,l,h,c,u,d;let p,_=Iu._Cache;const f=this.disabled||i.forceBindGroupCreation;if(!f){if(!t.isDirty(i.updateId)&&!i.isDirty)return Iu._NumBindGroupsNoLookupCurrentFrame++,t.bindGroups;for(const i of e.shaderProcessingContext.bufferNames){const e=null!==(r=null===(s=t.buffers[i])||void 0===s?void 0:s.uniqueId)&&void 0!==r?r:0;let n=_.values[e];n||(n=new Ru,_.values[e]=n),_=n}for(const t of e.shaderProcessingContext.samplerNames){const e=null!==(o=null===(n=i.samplers[t])||void 0===n?void 0:n.hashCode)&&void 0!==o?o:0;let s=_.values[e];s||(s=new Ru,_.values[e]=s),_=s}for(const t of e.shaderProcessingContext.textureNames){const e=null!==(h=null===(l=null===(a=i.textures[t])||void 0===a?void 0:a.texture)||void 0===l?void 0:l.uniqueId)&&void 0!==h?h:0;let s=_.values[e];s||(s=new Ru,_.values[e]=s),_=s}p=_.bindGroups}if(t.resetIsDirty(i.updateId),i.isDirty=!1,p)return t.bindGroups=p,Iu._NumBindGroupsLookupCurrentFrame++,p;p=[],t.bindGroups=p,f||(_.bindGroups=p),Iu.NumBindGroupsCreatedTotal++,Iu._NumBindGroupsCreatedCurrentFrame++;const m=e.bindGroupLayouts[i.textureState];for(let s=0;s<e.shaderProcessingContext.bindGroupLayoutEntries.length;s++){const r=e.shaderProcessingContext.bindGroupLayoutEntries[s],n=e.shaderProcessingContext.bindGroupEntries[s];for(let o=0;o<r.length;o++){const r=e.shaderProcessingContext.bindGroupLayoutEntries[s][o],a=e.shaderProcessingContext.bindGroupLayoutEntryInfo[s][r.binding],l=null!==(c=a.nameInArrayOfTexture)&&void 0!==c?c:a.name;if(r.sampler){const e=i.samplers[l];if(e){const t=e.sampler;if(!t){this._engine.dbgSanityChecks&&k.Error(`Trying to bind a null sampler! entry=${JSON.stringify(r)}, name=${l}, bindingInfo=${JSON.stringify(e,((e,t)=>"texture"===e?"<no dump>":t))}, materialContext.uniqueId=${i.uniqueId}`,50);continue}n[o].resource=this._cacheSampler.getSampler(t,!1,e.hashCode,t.label)}else k.Error(`Sampler "${l}" could not be bound. entry=${JSON.stringify(r)}, materialContext=${JSON.stringify(i,((e,t)=>"texture"===e||"sampler"===e?"<no dump>":t))}`,50)}else if(r.texture||r.storageTexture){const e=i.textures[l];if(e){if(this._engine.dbgSanityChecks&&null===e.texture){k.Error(`Trying to bind a null texture! entry=${JSON.stringify(r)}, bindingInfo=${JSON.stringify(e,((e,t)=>"texture"===e?"<no dump>":t))}, materialContext.uniqueId=${i.uniqueId}`,50);continue}const t=e.texture._hardwareTexture;if(this._engine.dbgSanityChecks&&(!t||r.texture&&!t.view||r.storageTexture&&!t.viewForWriting)){k.Error(`Trying to bind a null gpu texture or view! entry=${JSON.stringify(r)}, name=${l}, bindingInfo=${JSON.stringify(e,((e,t)=>"texture"===e?"<no dump>":t))}, isReady=${null===(u=e.texture)||void 0===u?void 0:u.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}n[o].resource=r.storageTexture?t.viewForWriting:t.view}else k.Error(`Texture "${l}" could not be bound. entry=${JSON.stringify(r)}, materialContext=${JSON.stringify(i,((e,t)=>"texture"===e||"sampler"===e?"<no dump>":t))}`,50)}else if(r.externalTexture){const e=i.textures[l];if(e){if(this._engine.dbgSanityChecks&&null===e.texture){k.Error(`Trying to bind a null external texture! entry=${JSON.stringify(r)}, name=${l}, bindingInfo=${JSON.stringify(e,((e,t)=>"texture"===e?"<no dump>":t))}, materialContext.uniqueId=${i.uniqueId}`,50);continue}const t=e.texture.underlyingResource;if(this._engine.dbgSanityChecks&&!t){k.Error(`Trying to bind a null gpu external texture! entry=${JSON.stringify(r)}, name=${l}, bindingInfo=${JSON.stringify(e,((e,t)=>"texture"===e?"<no dump>":t))}, isReady=${null===(d=e.texture)||void 0===d?void 0:d.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}n[o].resource=this._device.importExternalTexture({source:t})}else k.Error(`Texture "${l}" could not be bound. entry=${JSON.stringify(r)}, materialContext=${JSON.stringify(i,((e,t)=>"texture"===e||"sampler"===e?"<no dump>":t))}`,50)}else if(r.buffer){const e=t.buffers[l];if(e){const t=e.underlyingResource;n[o].resource.buffer=t,n[o].resource.size=e.capacity}else k.Error(`Can't find buffer "${l}". entry=${JSON.stringify(r)}, buffers=${JSON.stringify(t.buffers)}, drawContext.uniqueId=${t.uniqueId}`,50)}}const o=m[s];p[s]=this._device.createBindGroup({layout:o,entries:n})}return p}}Iu.NumBindGroupsCreatedTotal=0,Iu.NumBindGroupsCreatedLastFrame=0,Iu.NumBindGroupsLookupLastFrame=0,Iu.NumBindGroupsNoLookupLastFrame=0,Iu._Cache=new Ru,Iu._NumBindGroupsCreatedCurrentFrame=0,Iu._NumBindGroupsLookupCurrentFrame=0,Iu._NumBindGroupsNoLookupCurrentFrame=0;nt.ShadersStore.clearQuadVertexShader="uniform float depthValue;const vec2 pos[4]={vec2(-1.0,1.0),\nvec2(1.0,1.0),\nvec2(-1.0,-1.0),\nvec2(1.0,-1.0)};\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\ngl_Position=vec4(pos[gl_VertexID],depthValue,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}\n";nt.ShadersStore.clearQuadPixelShader="uniform vec4 color;void main() {gl_FragColor=color;}\n";class Pu{setDepthStencilFormat(e){this._depthTextureFormat=e,this._cacheRenderPipeline.setDepthStencilFormat(e)}setColorFormat(e){this._cacheRenderPipeline.setColorFormat(e)}setMRTAttachments(e,t,i){this._cacheRenderPipeline.setMRT(t,i),this._cacheRenderPipeline.setMRTAttachments(e)}constructor(e,t,i){this._bindGroups={},this._bundleCache={},this._keyTemp=[],this._device=e,this._engine=t,this._cacheRenderPipeline=new Eu(this._device,i),this._cacheRenderPipeline.setDepthTestEnabled(!1),this._cacheRenderPipeline.setStencilReadMask(255),this._effect=t.createEffect("clearQuad",[],["color","depthValue"])}clear(e,t,i,s,r=1){var n,o;let a,l,h=null;const c=!!this._engine._currentRenderTarget;if(e)a=e;else{let e=0;this._keyTemp.length=0;for(let t=0;t<this._cacheRenderPipeline.colorFormats.length;++t)this._keyTemp[e++]=au[null!==(n=this._cacheRenderPipeline.colorFormats[t])&&void 0!==n?n:""];const u=au[null!==(o=this._depthTextureFormat)&&void 0!==o?o:0];if(this._keyTemp[e]=(t?t.r+256*t.g+256*t.b*256+256*t.a*256*256:0)+(i?2**32:0)+(s?2**33:0)+(this._engine.useReverseDepthBuffer?2**34:0)+(c?2**35:0)+(r>1?2**36:0)+u*2**37,l=this._keyTemp.join("_"),h=this._bundleCache[l],h)return h;a=this._device.createRenderBundleEncoder({colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:lu.GetSample(r)})}this._cacheRenderPipeline.setDepthWriteEnabled(!!i),this._cacheRenderPipeline.setStencilEnabled(!!s&&!!this._depthTextureFormat&&lu.HasStencilAspect(this._depthTextureFormat)),this._cacheRenderPipeline.setStencilWriteMask(s?255:0),this._cacheRenderPipeline.setStencilCompare(s?519:512),this._cacheRenderPipeline.setStencilPassOp(s?7681:7680),this._cacheRenderPipeline.setWriteMask(t?15:0);const u=this._cacheRenderPipeline.getRenderPipeline(7,this._effect,r),d=this._effect._pipelineContext;t&&this._effect.setDirectColor4("color",t),this._effect.setFloat("depthValue",this._engine.useReverseDepthBuffer?this._engine._clearReverseDepthValue:this._engine._clearDepthValue),d.uniformBuffer.update();const p=c?this._engine._ubInvertY:this._engine._ubDontInvertY,_=d.uniformBuffer.getBuffer(),f=_.uniqueId+"-"+p.uniqueId;let m=this._bindGroups[f];if(!m){const e=d.bindGroupLayouts[0];m=this._bindGroups[f]=[],m.push(this._device.createBindGroup({layout:e[0],entries:[]})),Qc._SimplifiedKnownBindings||m.push(this._device.createBindGroup({layout:e[1],entries:[]})),m.push(this._device.createBindGroup({layout:e[Qc._SimplifiedKnownBindings?1:2],entries:[{binding:0,resource:{buffer:p.underlyingResource,size:p.capacity}},{binding:1,resource:{buffer:_.underlyingResource,size:_.capacity}}]}))}a.setPipeline(u);for(let e=0;e<m.length;++e)a.setBindGroup(e,m[e]);return a.draw(4,1,0,0),e||(h=a.finish(),this._bundleCache[l]=h),h}}class Mu{constructor(e,t,i,s){this.x=Math.floor(e),this.y=Math.floor(t),this.w=Math.floor(i),this.h=Math.floor(s)}run(e){e.setViewport(this.x,this.y,this.w,this.h,0,1)}clone(){return new Mu(this.x,this.y,this.w,this.h)}}class Ou{constructor(e,t,i,s){this.x=e,this.y=t,this.w=i,this.h=s}run(e){e.setScissorRect(this.x,this.y,this.w,this.h)}clone(){return new Ou(this.x,this.y,this.w,this.h)}}class Du{constructor(e){this.ref=e}run(e){e.setStencilReference(this.ref)}clone(){return new Du(this.ref)}}class Nu{constructor(e){this.color=e}run(e){e.setBlendConstant(this.color)}clone(){return new Nu(this.color)}}class Fu{constructor(e){this.query=e}run(e){e.beginOcclusionQuery(this.query)}clone(){return new Fu(this.query)}}class wu{constructor(){}run(e){e.endOcclusionQuery()}clone(){return new wu}}class Lu{constructor(){this.bundles=[]}run(e){e.executeBundles(this.bundles)}clone(){const e=new Lu;return e.bundles=this.bundles,e}}class Bu{constructor(e){this.numDrawCalls=0,this._device=e,this._list=new Array(10),this._listLength=0}addBundle(e){if(!this._currentItemIsBundle){const e=new Lu;this._list[this._listLength++]=e,this._currentBundleList=e.bundles,this._currentItemIsBundle=!0}e&&this._currentBundleList.push(e)}_finishBundle(){this._currentItemIsBundle&&this._bundleEncoder&&(this._currentBundleList.push(this._bundleEncoder.finish()),this._bundleEncoder=void 0,this._currentItemIsBundle=!1)}addItem(e){this._finishBundle(),this._list[this._listLength++]=e,this._currentItemIsBundle=!1}getBundleEncoder(e,t,i){return this._currentItemIsBundle||(this.addBundle(),this._bundleEncoder=this._device.createRenderBundleEncoder({colorFormats:e,depthStencilFormat:t,sampleCount:lu.GetSample(i)})),this._bundleEncoder}close(){this._finishBundle()}run(e){this.close();for(let t=0;t<this._listLength;++t)this._list[t].run(e)}reset(){this._listLength=0,this._currentItemIsBundle=!1,this.numDrawCalls=0}clone(){this.close();const e=new Bu(this._device);e._list=new Array(this._listLength),e._listLength=this._listLength,e.numDrawCalls=this.numDrawCalls;for(let t=0;t<this._listLength;++t)e._list[t]=this._list[t].clone();return e}}class Uu{get querySet(){return this._querySet}constructor(e,t,i,s,r=!0,n){this._dstBuffers=[],this._device=i,this._bufferManager=s,this._count=e,this._canUseMultipleBuffers=r,this._querySet=i.createQuerySet({label:n,type:t,count:e}),this._queryBuffer=s.createRawBuffer(8*e,uc.QueryResolve|uc.CopySrc,void 0,"QueryBuffer"),r||this._dstBuffers.push(this._bufferManager.createRawBuffer(8*this._count,uc.MapRead|uc.CopyDst,void 0,"QueryBufferNoMultipleBuffers"))}_getBuffer(e,t){if(!this._canUseMultipleBuffers&&0===this._dstBuffers.length)return null;const i=this._device.createCommandEncoder();let s;return 0===this._dstBuffers.length?s=this._bufferManager.createRawBuffer(8*this._count,uc.MapRead|uc.CopyDst,void 0,"QueryBufferAdditionalBuffer"):(s=this._dstBuffers[this._dstBuffers.length-1],this._dstBuffers.length--),i.resolveQuerySet(this._querySet,e,t,this._queryBuffer,0),i.copyBufferToBuffer(this._queryBuffer,0,s,0,8*t),this._device.queue.submit([i.finish()]),s}async readValues(e=0,t=1){const i=this._getBuffer(e,t);if(null===i)return null;await i.mapAsync(dc.Read);const s=new BigUint64Array(i.getMappedRange()).slice();return i.unmap(),this._dstBuffers[this._dstBuffers.length]=i,s}async readValue(e=0){const t=this._getBuffer(e,1);if(null===t)return null;await t.mapAsync(dc.Read);const i=new BigUint64Array(t.getMappedRange()),s=Number(i[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,s}async readTwoValuesAndSubtract(e=0){const t=this._getBuffer(e,2);if(null===t)return null;await t.mapAsync(dc.Read);const i=new BigUint64Array(t.getMappedRange()),s=Number(i[1]-i[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,s}dispose(){this._querySet.destroy(),this._bufferManager.releaseBuffer(this._queryBuffer);for(let e=0;e<this._dstBuffers.length;++e)this._bufferManager.releaseBuffer(this._dstBuffers[e])}}class Vu{get gpuFrameTimeCounter(){return this._gpuFrameTimeCounter}constructor(e,t){this._enabled=!1,this._gpuFrameTimeCounter=new Fi,this._measureDurationState=0,this._device=e,this._bufferManager=t}get enable(){return this._enabled}set enable(e){this._enabled!==e&&(this._enabled=e,this._measureDurationState=0,e?this._measureDuration=new ku(this._device,this._bufferManager):this._measureDuration.dispose())}startFrame(e){this._enabled&&0===this._measureDurationState&&(this._measureDuration.start(e),this._measureDurationState=1)}endFrame(e){1===this._measureDurationState&&(this._measureDurationState=2,this._measureDuration.stop(e).then((e=>{null!==e&&e>=0&&(this._gpuFrameTimeCounter.fetchNewFrame(),this._gpuFrameTimeCounter.addCount(e,!0)),this._measureDurationState=0})))}}class ku{constructor(e,t){this._querySet=new Uu(2,Hc.Timestamp,e,t)}start(e){e.writeTimestamp(this._querySet.querySet,0)}async stop(e){return e.writeTimestamp(this._querySet.querySet,1),this._querySet.readTwoValuesAndSubtract(0)}dispose(){this._querySet.dispose()}}class Gu{get querySet(){return this._querySet.querySet}get hasQueries(){return this._currentTotalIndices!==this._availableIndices.length}canBeginQuery(e){if(this._frameQuerySetIsDirty===this._engine.frameId||this._queryFrameId[e]===this._engine.frameId)return!1;const t=void 0!==this._engine._getCurrentRenderPassWrapper().renderPassDescriptor.occlusionQuerySet;return t&&(this._queryFrameId[e]=this._engine.frameId),t}constructor(e,t,i,s=50,r=100){this._availableIndices=[],this._frameQuerySetIsDirty=-1,this._queryFrameId=[],this._engine=e,this._device=t,this._bufferManager=i,this._frameLastBuffer=-1,this._currentTotalIndices=0,this._countIncrement=r,this._allocateNewIndices(s)}createQuery(){0===this._availableIndices.length&&this._allocateNewIndices();const e=this._availableIndices[this._availableIndices.length-1];return this._availableIndices.length--,e}deleteQuery(e){this._availableIndices[this._availableIndices.length]=e}isQueryResultAvailable(e){return this._retrieveQueryBuffer(),!!this._lastBuffer&&e<this._lastBuffer.length}getQueryResult(e){var t,i;return Number(null!==(i=null===(t=this._lastBuffer)||void 0===t?void 0:t[e])&&void 0!==i?i:-1)}_retrieveQueryBuffer(){this._lastBuffer&&this._frameLastBuffer===this._engine.frameId||this._frameLastBuffer!==this._engine.frameId&&(this._frameLastBuffer=this._engine.frameId,this._querySet.readValues(0,this._currentTotalIndices).then((e=>{this._lastBuffer=e})))}_allocateNewIndices(e){e=null!=e?e:this._countIncrement,this._delayQuerySetDispose();for(let t=0;t<e;++t)this._availableIndices.push(this._currentTotalIndices+t);this._currentTotalIndices+=e,this._querySet=new Uu(this._currentTotalIndices,Hc.Occlusion,this._device,this._bufferManager,!1,"QuerySet_OcclusionQuery_count_"+this._currentTotalIndices),this._frameQuerySetIsDirty=this._engine.frameId}_delayQuerySetDispose(){const e=this._querySet;e&&setTimeout((()=>e.dispose),1e3)}dispose(){var e;null===(e=this._querySet)||void 0===e||e.dispose(),this._availableIndices.length=0}}class zu{async initTwgsl(e){if(!zu._twgsl)return e=e||{},(e=Object.assign(Object.assign({},zu._TWgslDefaultOptions),e)).twgsl?(zu._twgsl=e.twgsl,Promise.resolve()):(e.jsPath&&e.wasmPath&&await Ht.LoadBabylonScriptAsync(e.jsPath),self.twgsl?(zu._twgsl=await self.twgsl(Ht.GetBabylonScriptURL(e.wasmPath)),Promise.resolve()):Promise.reject("twgsl is not available."))}convertSpirV2WGSL(e,t=!1){const i=zu._twgsl.convertSpirV2WGSL(e,zu.DisableUniformityAnalysis||t);return zu.ShowWGSLShaderCode&&(console.log(i),console.log("***********************************************")),zu.DisableUniformityAnalysis||t?"diagnostic(off, derivative_uniformity);\n"+i:i}}zu._TWgslDefaultOptions={jsPath:`${Ht._DefaultCdnUrl}/twgsl/twgsl.js`,wasmPath:`${Ht._DefaultCdnUrl}/twgsl/twgsl.wasm`},zu.ShowWGSLShaderCode=!1,zu.DisableUniformityAnalysis=!1,zu._twgsl=null;class Wu{constructor(e,t,i){this._record=!1,this._play=!1,this._playBundleListIndex=0,this._allBundleLists=[],this._enabled=!1,this._engine=e,this._mode=t,this._bundleList=i}get enabled(){return this._enabled}get play(){return this._play}get record(){return this._record}set enabled(e){this._allBundleLists.length=0,this._record=this._enabled=e,this._play=!1,e&&(this._modeSaved=this._mode,this._mode=0)}get mode(){return this._mode}set mode(e){this._record?this._modeSaved=e:this._mode=e}endRenderPass(e){if(!this._record&&!this._play)return!1;let t;if(this._record)t=this._bundleList.clone(),this._allBundleLists.push(t),this._bundleList.reset();else{if(this._playBundleListIndex>=this._allBundleLists.length)throw new Error(`Invalid playBundleListIndex! Your snapshot is no longer valid for the current frame, you should recreate a new one. playBundleListIndex=${this._playBundleListIndex}, allBundleLists.length=${this._allBundleLists.length}}`);t=this._allBundleLists[this._playBundleListIndex++]}return t.run(e),1===this._mode&&this._engine._reportDrawCall(t.numDrawCalls),!0}endFrame(){this._record&&(this._record=!1,this._play=!0,this._mode=this._modeSaved),this._playBundleListIndex=0}reset(){this.enabled=!1,this.enabled=!0}}nt.ShadersStoreWGSL.postprocessVertexShader="attribute position: vec2<f32>;uniform scale: vec2<f32>;varying vUV: vec2<f32>;const madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.vUV=(vertexInputs.position*madd+madd)*uniforms.scale;vertexOutputs.position=vec4(vertexInputs.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}\n";const Hu={label:"TextureView_SwapChain_ResolveTarget",dimension:pc.E2d,format:void 0,mipLevelCount:1,arrayLayerCount:1},Xu={label:"TextureView_SwapChain",dimension:pc.E2d,format:void 0,mipLevelCount:1,arrayLayerCount:1},Yu="/* disable_uniformity_analysis */",ju=new F;class Ku extends Ns{get snapshotRenderingMode(){return this._snapshotRendering.mode}set snapshotRenderingMode(e){this._snapshotRendering.mode=e}snapshotRenderingReset(){this._snapshotRendering.reset()}get snapshotRendering(){return this._snapshotRendering.enabled}set snapshotRendering(e){this._snapshotRendering.enabled=e}get disableCacheSamplers(){return!!this._cacheSampler&&this._cacheSampler.disabled}set disableCacheSamplers(e){this._cacheSampler&&(this._cacheSampler.disabled=e)}get disableCacheRenderPipelines(){return!!this._cacheRenderPipeline&&this._cacheRenderPipeline.disabled}set disableCacheRenderPipelines(e){this._cacheRenderPipeline&&(this._cacheRenderPipeline.disabled=e)}get disableCacheBindGroups(){return!!this._cacheBindGroups&&this._cacheBindGroups.disabled}set disableCacheBindGroups(e){this._cacheBindGroups&&(this._cacheBindGroups.disabled=e)}static get IsSupportedAsync(){return navigator.gpu?navigator.gpu.requestAdapter().then((e=>!!e),(()=>!1)).catch((()=>!1)):Promise.resolve(!1)}static get IsSupported(){return k.Warn("You must call IsSupportedAsync for WebGPU!"),!1}get supportsUniformBuffers(){return!0}get supportedExtensions(){return this._adapterSupportedExtensions}get enabledExtensions(){return this._deviceEnabledExtensions}get supportedLimits(){return this._adapterSupportedLimits}get currentLimits(){return this._deviceLimits}get description(){return this.name+this.version}get version(){return 1}getInfo(){return{vendor:this._adapterInfo.vendor||"unknown vendor",renderer:this._adapterInfo.architecture||"unknown renderer",version:this._adapterInfo.description||"unknown version"}}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=e}get currentSampleCount(){return this._currentRenderTarget?this._currentRenderTarget.samples:this._mainPassSampleCount}static CreateAsync(e,t={}){const i=new Ku(e,t);return new Promise((e=>{i.initAsync(t.glslangOptions,t.twgslOptions).then((()=>e(i)))}))}constructor(e,t={}){var i,s;super(null,null===(i=t.antialias)||void 0===i||i,t),this._uploadEncoderDescriptor={label:"upload"},this._renderEncoderDescriptor={label:"render"},this._clearDepthValue=1,this._clearReverseDepthValue=0,this._clearStencilValue=0,this._defaultSampleCount=4,this._glslang=null,this._tintWASM=null,this._adapterInfo={vendor:"",architecture:"",device:"",description:""},this._compiledComputeEffects={},this._counters={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.countersLastFrame={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.numMaxUncapturedErrors=20,this._commandBuffers=[null,null],this._currentRenderPass=null,this._mainRenderPassWrapper={renderPassDescriptor:null,colorAttachmentViewDescriptor:null,depthAttachmentViewDescriptor:null,colorAttachmentGPUTextures:[],depthTextureFormat:void 0},this._rttRenderPassWrapper={renderPassDescriptor:null,colorAttachmentViewDescriptor:null,depthAttachmentViewDescriptor:null,colorAttachmentGPUTextures:[],depthTextureFormat:void 0},this._pendingDebugCommands=[],this._currentOverrideVertexBuffers=null,this._currentIndexBuffer=null,this._colorWriteLocal=!0,this._forceEnableEffect=!1,this.dbgShowShaderCode=!1,this.dbgSanityChecks=!0,this.dbgVerboseLogsForFirstFrames=!1,this.dbgVerboseLogsNumFrames=10,this.dbgLogIfNotDrawWrapper=!0,this.dbgShowEmptyEnableEffectCalls=!0,this.isNDCHalfZRange=!0,this.hasOriginBottomLeft=!1,this._viewportsCurrent={x:0,y:0,w:0,h:0},this._scissorsCurrent={x:0,y:0,w:0,h:0},this._scissorCached={x:0,y:0,z:0,w:0},this._stencilRefsCurrent=-1,this._blendColorsCurrent=[null,null,null,null],this._name="WebGPU",t.deviceDescriptor=t.deviceDescriptor||{},t.enableGPUDebugMarkers=null!==(s=t.enableGPUDebugMarkers)&&void 0!==s&&s,k.Log(`Babylon.js v${Ns.Version} - ${this.description} engine`),navigator.gpu?(t.swapChainFormat=t.swapChainFormat||navigator.gpu.getPreferredCanvasFormat(),this._isWebGPU=!0,this._shaderPlatformName="WEBGPU",this._renderingCanvas=e,this._options=t,this._mainPassSampleCount=t.antialias?this._defaultSampleCount:1,this._setupMobileChecks(),this._sharedInit(e),this._shaderProcessor=new Zc,this._shaderProcessorWGSL=new eu):k.Error("WebGPU is not supported by your browser.")}initAsync(e,t){var i;return this._initGlslang(null!=e?e:null===(i=this._options)||void 0===i?void 0:i.glslangOptions).then((e=>{var i;return this._glslang=e,this._tintWASM=Ku.UseTWGSL?new zu:null,this._tintWASM?this._tintWASM.initTwgsl(null!=t?t:null===(i=this._options)||void 0===i?void 0:i.twgslOptions).then((()=>navigator.gpu.requestAdapter(this._options)),(e=>{throw k.Error("Can not initialize twgsl!"),k.Error(e),Error("WebGPU initializations stopped.")})):navigator.gpu.requestAdapter(this._options)}),(e=>{throw k.Error("Can not initialize glslang!"),k.Error(e),Error("WebGPU initializations stopped.")})).then((e=>{var t,i,s;if(e){this._adapter=e,this._adapterSupportedExtensions=[],null===(t=this._adapter.features)||void 0===t||t.forEach((e=>this._adapterSupportedExtensions.push(e))),this._adapterSupportedLimits=this._adapter.limits,this._adapter.requestAdapterInfo().then((e=>{this._adapterInfo=e}));const r=null!==(i=this._options.deviceDescriptor)&&void 0!==i?i:{},n=null!==(s=null==r?void 0:r.requiredFeatures)&&void 0!==s?s:this._options.enableAllFeatures?this._adapterSupportedExtensions:void 0;if(n){const e=n,t=[];for(const i of e)-1!==this._adapterSupportedExtensions.indexOf(i)&&t.push(i);r.requiredFeatures=t}if(this._options.setMaximumLimits&&!r.requiredLimits){r.requiredLimits={};for(const e in this._adapterSupportedLimits)r.requiredLimits[e]=this._adapterSupportedLimits[e]}return this._adapter.requestDevice(r)}throw"Could not retrieve a WebGPU adapter (adapter is null)."})).then((e=>{var t,i;this._device=e,this._deviceEnabledExtensions=[],null===(t=this._device.features)||void 0===t||t.forEach((e=>this._deviceEnabledExtensions.push(e))),this._deviceLimits=e.limits;let s=-1;this._device.addEventListener("uncapturederror",(e=>{++s<this.numMaxUncapturedErrors?k.Warn(`WebGPU uncaptured error (${s+1}): ${e.error} - ${e.error.message}`):s++===this.numMaxUncapturedErrors&&k.Warn(`WebGPU uncaptured error: too many warnings (${this.numMaxUncapturedErrors}), no more warnings will be reported to the console for this engine.`)})),this._doNotHandleContextLost||null===(i=this._device.lost)||void 0===i||i.then((e=>{this._isDisposed||(this._contextWasLost=!0,k.Warn("WebGPU context lost. "+e),this.onContextLostObservable.notifyObservers(this),this._restoreEngineAfterContextLost((()=>this.initAsync())))}))}),(e=>{k.Error("Could not retrieve a WebGPU device."),k.Error(e)})).then((()=>{this._bufferManager=new cu(this._device),this._textureHelper=new lu(this._device,this._glslang,this._tintWASM,this._bufferManager,this._deviceEnabledExtensions),this._cacheSampler=new _u(this._device),this._cacheBindGroups=new Iu(this._device,this._cacheSampler,this),this._timestampQuery=new Vu(this._device,this._bufferManager),this._occlusionQuery=this._device.createQuerySet?new Gu(this,this._device,this._bufferManager):void 0,this._bundleList=new Bu(this._device),this._snapshotRendering=new Wu(this,this._snapshotRenderingMode,this._bundleList),this._ubInvertY=this._bufferManager.createBuffer(new Float32Array([-1,0]),uc.Uniform|uc.CopyDst,"UBInvertY"),this._ubDontInvertY=this._bufferManager.createBuffer(new Float32Array([1,0]),uc.Uniform|uc.CopyDst,"UBDontInvertY"),this.dbgVerboseLogsForFirstFrames&&void 0===this._count&&(this._count=0,console.log("%c frame #"+this._count+" - begin","background: #ffff00")),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._initializeLimits(),this._emptyVertexBuffer=new hi(this,[0],"",!1,!1,1,!1,0,1),this._cacheRenderPipeline=new Eu(this._device,this._emptyVertexBuffer),this._depthCullingState=new bu(this._cacheRenderPipeline),this._stencilStateComposer=new Su(this._cacheRenderPipeline),this._stencilStateComposer.stencilGlobal=this._stencilState,this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=515,this._depthCullingState.depthMask=!0,this._textureHelper.setCommandEncoder(this._uploadEncoder),this._clearQuad=new Pu(this._device,this,this._emptyVertexBuffer),this._defaultDrawContext=this.createDrawContext(),this._currentDrawContext=this._defaultDrawContext,this._defaultMaterialContext=this.createMaterialContext(),this._currentMaterialContext=this._defaultMaterialContext,this._initializeContextAndSwapChain(),this._initializeMainAttachments(),this.resize()})).catch((e=>{k.Error("Can not create WebGPU Device and/or context."),k.Error(e),console.trace&&console.trace()}))}_initGlslang(e){return e=e||{},(e=Object.assign(Object.assign({},Ku._GLSLslangDefaultOptions),e)).glslang?Promise.resolve(e.glslang):self.glslang?self.glslang(e.wasmPath):e.jsPath&&e.wasmPath?Ht.LoadBabylonScriptAsync(e.jsPath).then((()=>self.glslang(Ht.GetBabylonScriptURL(e.wasmPath)))):Promise.reject("gslang is not available.")}_initializeLimits(){this._caps={maxTexturesImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage,maxVertexTextureImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage,maxCombinedTexturesImageUnits:2*this._deviceLimits.maxSampledTexturesPerShaderStage,maxTextureSize:this._deviceLimits.maxTextureDimension2D,maxCubemapTextureSize:this._deviceLimits.maxTextureDimension2D,maxRenderTextureSize:this._deviceLimits.maxTextureDimension2D,maxVertexAttribs:this._deviceLimits.maxVertexAttributes,maxVaryingVectors:this._deviceLimits.maxInterStageShaderVariables,maxFragmentUniformVectors:Math.floor(this._deviceLimits.maxUniformBufferBindingSize/4),maxVertexUniformVectors:Math.floor(this._deviceLimits.maxUniformBufferBindingSize/4),standardDerivatives:!0,astc:this._deviceEnabledExtensions.indexOf(hc.TextureCompressionASTC)>=0||void 0,s3tc:this._deviceEnabledExtensions.indexOf(hc.TextureCompressionBC)>=0||void 0,pvrtc:null,etc1:null,etc2:this._deviceEnabledExtensions.indexOf(hc.TextureCompressionETC2)>=0||void 0,bptc:this._deviceEnabledExtensions.indexOf(hc.TextureCompressionBC)>=0||void 0,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!0,highPrecisionShaderSupported:!0,colorBufferFloat:!0,supportFloatTexturesResolve:!1,textureFloat:!0,textureFloatLinearFiltering:this._deviceEnabledExtensions.indexOf(hc.Float32Filterable)>=0,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!0,textureHalfFloatRender:!0,textureLOD:!0,texelFetch:!0,drawBuffersExtension:!0,depthTextureExtension:!0,vertexArrayObject:!1,instancedArrays:!0,timerQuery:"undefined"!=typeof BigUint64Array&&-1!==this._deviceEnabledExtensions.indexOf(hc.TimestampQuery)||void 0,supportOcclusionQuery:"undefined"!=typeof BigUint64Array,canUseTimestampForTimerQuery:!0,multiview:!1,oculusMultiview:!1,parallelShaderCompile:void 0,blendMinMax:!0,maxMSAASamples:4,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!0,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!0,texture2DArrayMaxLayerCount:this._deviceLimits.maxTextureArrayLayers,disableMorphTargetTexture:!1},this._caps.parallelShaderCompile=null,this._features={forceBitmapOverHTMLImageElement:!0,supportRenderAndCopyToLodForFloatTextures:!0,supportDepthStencilTexture:!0,supportShadowSamplers:!0,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!0,trackUbosInFrame:!0,checkUbosContentBeforeUpload:!0,supportCSM:!0,basisNeedsPOT:!1,support3DTextures:!0,needTypeSuffixInShaderConstants:!0,supportMSAA:!0,supportSSAO2:!0,supportExtendedTextureFormats:!0,supportSwitchCaseInShader:!0,supportSyncTextureRead:!1,needsInvertingBitmap:!1,useUBOBindingCache:!1,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!0,supportRenderPasses:!0,supportSpriteInstancing:!0,forceVertexBufferStrideMultiple4Bytes:!0,_collectUbosUpdatedInFrame:!1}}_initializeContextAndSwapChain(){if(!this._renderingCanvas)throw"The rendering canvas has not been set!";this._context=this._renderingCanvas.getContext("webgpu"),this._configureContext(),this._colorFormat=this._options.swapChainFormat,this._mainRenderPassWrapper.colorAttachmentGPUTextures=[new tu],this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].format=this._colorFormat,this._setColorFormat(this._mainRenderPassWrapper)}_initializeMainAttachments(){if(!this._bufferManager)return;this.flushFramebuffer(),this._mainTextureExtends={width:this.getRenderWidth(!0),height:this.getRenderHeight(!0),depthOrArrayLayers:1};const e=new Float32Array([this.getRenderHeight(!0)]);let t;if(this._bufferManager.setSubData(this._ubInvertY,4,e),this._bufferManager.setSubData(this._ubDontInvertY,4,e),this._options.antialias){const e={label:`Texture_MainColor_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}_antialiasing`,size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:pc.E2d,format:this._options.swapChainFormat,usage:_c.RenderAttachment};this._mainTexture&&this._textureHelper.releaseTexture(this._mainTexture),this._mainTexture=this._device.createTexture(e),t=[{view:this._mainTexture.createView({label:"TextureView_MainColor_antialiasing",dimension:pc.E2d,format:this._options.swapChainFormat,mipLevelCount:1,arrayLayerCount:1}),clearValue:new F(0,0,0,1),loadOp:zc.Clear,storeOp:Wc.Store}]}else t=[{view:void 0,clearValue:new F(0,0,0,1),loadOp:zc.Clear,storeOp:Wc.Store}];this._mainRenderPassWrapper.depthTextureFormat=this.isStencilEnable?gc.Depth24PlusStencil8:gc.Depth32Float,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper);const i={label:`Texture_MainDepthStencil_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}`,size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:pc.E2d,format:this._mainRenderPassWrapper.depthTextureFormat,usage:_c.RenderAttachment};this._depthTexture&&this._textureHelper.releaseTexture(this._depthTexture),this._depthTexture=this._device.createTexture(i);const s={view:this._depthTexture.createView({label:`TextureView_MainDepthStencil_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}`,dimension:pc.E2d,format:this._depthTexture.format,mipLevelCount:1,arrayLayerCount:1}),depthClearValue:this._clearDepthValue,depthLoadOp:zc.Clear,depthStoreOp:Wc.Store,stencilClearValue:this._clearStencilValue,stencilLoadOp:this.isStencilEnable?zc.Clear:void 0,stencilStoreOp:this.isStencilEnable?Wc.Store:void 0};this._mainRenderPassWrapper.renderPassDescriptor={label:"MainRenderPass",colorAttachments:t,depthStencilAttachment:s}}_configureContext(){this._context.configure({device:this._device,format:this._options.swapChainFormat,usage:_c.RenderAttachment|_c.CopySrc,alphaMode:this.premultipliedAlpha?Xc.Premultiplied:Xc.Opaque})}setSize(e,t,i=!1){return!!super.setSize(e,t,i)&&(this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - setSize -",e,t)),this._initializeMainAttachments(),this.snapshotRendering&&this.snapshotRenderingReset(),!0)}_getShaderProcessor(e){return e===qe.WGSL?this._shaderProcessorWGSL:this._shaderProcessor}_getShaderProcessingContext(e){return new Qc(e)}_currentPassIsMainPass(){return null===this._currentRenderTarget}_getCurrentRenderPass(){return this._currentRenderTarget&&!this._currentRenderPass?this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1):this._currentRenderPass||this._startMainRenderPass(!1),this._currentRenderPass}_getCurrentRenderPassWrapper(){return this._currentRenderTarget?this._rttRenderPassWrapper:this._mainRenderPassWrapper}applyStates(){this._stencilStateComposer.apply(),this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState.alphaBlend)}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._forceEnableEffect=!0,this._currentIndexBuffer=null,this._currentOverrideVertexBuffers=null,this._cacheRenderPipeline.setBuffers(null,null,null),e&&(this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=515,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters),this._cacheRenderPipeline.setAlphaBlendEnabled(!1),this.setColorWrite(!0)),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}setColorWrite(e){this._colorWriteLocal=e,this._cacheRenderPipeline.setWriteMask(e?15:0)}getColorWrite(){return this._colorWriteLocal}_mustUpdateViewport(){const e=this._viewportCached.x,t=this._viewportCached.y,i=this._viewportCached.z,s=this._viewportCached.w,r=this._viewportsCurrent.x!==e||this._viewportsCurrent.y!==t||this._viewportsCurrent.w!==i||this._viewportsCurrent.h!==s;return r&&(this._viewportsCurrent.x=this._viewportCached.x,this._viewportsCurrent.y=this._viewportCached.y,this._viewportsCurrent.w=this._viewportCached.z,this._viewportsCurrent.h=this._viewportCached.w),r}_applyViewport(e){const t=Math.floor(this._viewportCached.x),i=Math.floor(this._viewportCached.z),s=Math.floor(this._viewportCached.w);let r=Math.floor(this._viewportCached.y);this._currentRenderTarget||(r=this.getRenderHeight(!0)-r-s),e?e.addItem(new Mu(t,r,i,s)):this._getCurrentRenderPass().setViewport(t,r,i,s,0,1),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - viewport applied - (",this._viewportCached.x,this._viewportCached.y,this._viewportCached.z,this._viewportCached.w,") current pass is main pass="+this._currentPassIsMainPass()))}_viewport(e,t,i,s){this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=s}_mustUpdateScissor(){const e=this._scissorCached.x,t=this._scissorCached.y,i=this._scissorCached.z,s=this._scissorCached.w,r=this._scissorsCurrent.x!==e||this._scissorsCurrent.y!==t||this._scissorsCurrent.w!==i||this._scissorsCurrent.h!==s;return r&&(this._scissorsCurrent.x=this._scissorCached.x,this._scissorsCurrent.y=this._scissorCached.y,this._scissorsCurrent.w=this._scissorCached.z,this._scissorsCurrent.h=this._scissorCached.w),r}_applyScissor(e){const t=this._currentRenderTarget?this._scissorCached.y:this.getRenderHeight()-this._scissorCached.w-this._scissorCached.y;e?e.addItem(new Ou(this._scissorCached.x,t,this._scissorCached.z,this._scissorCached.w)):this._getCurrentRenderPass().setScissorRect(this._scissorCached.x,t,this._scissorCached.z,this._scissorCached.w),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - scissor applied - (",this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w,") current pass is main pass="+this._currentPassIsMainPass()))}_scissorIsActive(){return 0!==this._scissorCached.x||0!==this._scissorCached.y||0!==this._scissorCached.z||0!==this._scissorCached.w}enableScissor(e,t,i,s){this._scissorCached.x=e,this._scissorCached.y=t,this._scissorCached.z=i,this._scissorCached.w=s}disableScissor(){this._scissorCached.x=this._scissorCached.y=this._scissorCached.z=this._scissorCached.w=0,this._scissorsCurrent.x=this._scissorsCurrent.y=this._scissorsCurrent.w=this._scissorsCurrent.h=0}_mustUpdateStencilRef(){const e=this._stencilStateComposer.funcRef!==this._stencilRefsCurrent;return e&&(this._stencilRefsCurrent=this._stencilStateComposer.funcRef),e}_applyStencilRef(e){var t,i;e?e.addItem(new Du(null!==(t=this._stencilStateComposer.funcRef)&&void 0!==t?t:0)):this._getCurrentRenderPass().setStencilReference(null!==(i=this._stencilStateComposer.funcRef)&&void 0!==i?i:0)}_mustUpdateBlendColor(){const e=this._alphaState._blendConstants,t=e[0]!==this._blendColorsCurrent[0]||e[1]!==this._blendColorsCurrent[1]||e[2]!==this._blendColorsCurrent[2]||e[3]!==this._blendColorsCurrent[3];return t&&(this._blendColorsCurrent[0]=e[0],this._blendColorsCurrent[1]=e[1],this._blendColorsCurrent[2]=e[2],this._blendColorsCurrent[3]=e[3]),t}_applyBlendColor(e){e?e.addItem(new Nu(this._alphaState._blendConstants.slice())):this._getCurrentRenderPass().setBlendConstant(this._alphaState._blendConstants)}_resetRenderPassStates(){this._viewportsCurrent.x=this._viewportsCurrent.y=this._viewportsCurrent.w=this._viewportsCurrent.h=0,this._scissorsCurrent.x=this._scissorsCurrent.y=this._scissorsCurrent.w=this._scissorsCurrent.h=0,this._stencilRefsCurrent=-1,this._blendColorsCurrent[0]=this._blendColorsCurrent[1]=this._blendColorsCurrent[2]=this._blendColorsCurrent[3]=null}clear(e,t,i,s=!1){e&&void 0===e.a&&(e.a=1);const r=this._scissorIsActive();this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - clear - backBuffer=",t," depth=",i," stencil=",s," scissor is active=",r)),this._currentRenderTarget?r?(this._currentRenderPass||this._startRenderTargetRenderPass(this._currentRenderTarget,!1,t?e:null,i,s),this._applyScissor(this.compatibilityMode?null:this._bundleList),this._clearFullQuad(t?e:null,i,s)):(this._currentRenderPass&&this._endCurrentRenderPass(),this._startRenderTargetRenderPass(this._currentRenderTarget,!0,t?e:null,i,s)):(this._currentRenderPass&&r||this._startMainRenderPass(!r,t?e:null,i,s),r&&(this._applyScissor(this.compatibilityMode?null:this._bundleList),this._clearFullQuad(t?e:null,i,s)))}_clearFullQuad(e,t,i){var s,r;const n=this.compatibilityMode?this._getCurrentRenderPass():null;this._clearQuad.setColorFormat(this._colorFormat),this._clearQuad.setDepthStencilFormat(this._depthTextureFormat),this._clearQuad.setMRTAttachments(null!==(s=this._cacheRenderPipeline.mrtAttachments)&&void 0!==s?s:[],null!==(r=this._cacheRenderPipeline.mrtTextureArray)&&void 0!==r?r:[],this._cacheRenderPipeline.mrtTextureCount),this.compatibilityMode?n.setStencilReference(this._clearStencilValue):this._bundleList.addItem(new Du(this._clearStencilValue));const o=this._clearQuad.clear(n,e,t,i,this.currentSampleCount);this.compatibilityMode?this._applyStencilRef(null):(this._bundleList.addBundle(o),this._applyStencilRef(this._bundleList),this._reportDrawCall())}createVertexBuffer(e,t,i){let s;return s=e instanceof Array?new Float32Array(e):e instanceof ArrayBuffer?new Uint8Array(e):e,this._bufferManager.createBuffer(s,uc.Vertex|uc.CopyDst,i)}createDynamicVertexBuffer(e,t){return this.createVertexBuffer(e,void 0,t)}createIndexBuffer(e,t,i){let s,r=!0;e instanceof Uint32Array||e instanceof Int32Array?s=e:e instanceof Uint16Array?(s=e,r=!1):e.length>65535?s=new Uint32Array(e):(s=new Uint16Array(e),r=!1);const n=this._bufferManager.createBuffer(s,uc.Index|uc.CopyDst,i);return n.is32Bits=r,n}_createBuffer(e,t,i){let s;s=e instanceof Array?new Float32Array(e):e instanceof ArrayBuffer?new Uint8Array(e):e;let r=0;return 1&t&&(r|=uc.CopySrc),2&t&&(r|=uc.CopyDst),4&t&&(r|=uc.Uniform),8&t&&(r|=uc.Vertex),16&t&&(r|=uc.Index),32&t&&(r|=uc.Storage),this._bufferManager.createBuffer(s,r,i)}bindBuffersDirectly(){throw"Not implemented on WebGPU"}updateAndBindInstancesBuffer(){throw"Not implemented on WebGPU"}bindBuffers(e,t,i,s){this._currentIndexBuffer=t,this._currentOverrideVertexBuffers=null!=s?s:null,this._cacheRenderPipeline.setBuffers(e,t,this._currentOverrideVertexBuffers)}_releaseBuffer(e){return this._bufferManager.releaseBuffer(e)}createEffect(e,t,i,s,r,n,o,a,l,h=qe.GLSL){var c;const u=e.vertexElement||e.vertex||e.vertexToken||e.vertexSource||e,d=e.fragmentElement||e.fragment||e.fragmentToken||e.fragmentSource||e,p=this._getGlobalDefines();let _=null!==(c=null!=r?r:t.defines)&&void 0!==c?c:"";p&&(_+="\n"+p);const f=u+"+"+d+"@"+_;if(this._compiledEffects[f]){const e=this._compiledEffects[f];return o&&e.isReady()&&o(e),e}const m=new ot(e,t,i,s,this,r,n,o,a,l,f,h);return this._compiledEffects[f]=m,m}_compileRawShaderToSpirV(e,t){return this._glslang.compileGLSL(e,t)}_compileShaderToSpirV(e,t,i,s){return this._compileRawShaderToSpirV(s+(i?i+"\n":"")+e,t)}_getWGSLShader(e,t,i){return(i=i?"//"+i.split("\n").join("\n//")+"\n":"")+e}_createPipelineStageDescriptor(e,t,i,s,r){return this._tintWASM&&i===qe.GLSL&&(e=this._tintWASM.convertSpirV2WGSL(e,s),t=this._tintWASM.convertSpirV2WGSL(t,r)),{vertexStage:{module:this._device.createShaderModule({code:e}),entryPoint:"main"},fragmentStage:{module:this._device.createShaderModule({code:t}),entryPoint:"main"}}}_compileRawPipelineStageDescriptor(e,t,i){const s=e.indexOf(Yu)>=0,r=t.indexOf(Yu)>=0,n=i===qe.GLSL?this._compileRawShaderToSpirV(e,"vertex"):e,o=i===qe.GLSL?this._compileRawShaderToSpirV(t,"fragment"):t;return this._createPipelineStageDescriptor(n,o,i,s,r)}_compilePipelineStageDescriptor(e,t,i,s){this.onBeforeShaderCompilationObservable.notifyObservers(this);const r=e.indexOf(Yu)>=0,n=t.indexOf(Yu)>=0,o="#version 450\n",a=s===qe.GLSL?this._compileShaderToSpirV(e,"vertex",i,o):this._getWGSLShader(e,"vertex",i),l=s===qe.GLSL?this._compileShaderToSpirV(t,"fragment",i,o):this._getWGSLShader(t,"fragment",i),h=this._createPipelineStageDescriptor(a,l,s,r,n);return this.onAfterShaderCompilationObservable.notifyObservers(this),h}createRawShaderProgram(){throw"Not available on WebGPU"}createShaderProgram(){throw"Not available on WebGPU"}inlineShaderCode(e){const t=new $h(e);return t.debug=!1,t.processCode(),t.code}createPipelineContext(e){return new $c(e,this)}createMaterialContext(){return new yu}createDrawContext(){return new Au(this._bufferManager)}_preparePipelineContext(e,t,i,s,r,n,o,a){const l=e,h=l.shaderProcessingContext.shaderLanguage;this.dbgShowShaderCode&&(console.log(a),console.log(t),console.log(i),console.log("***********************************************")),l.sources={fragment:i,vertex:t,rawVertex:r,rawFragment:n},l.stages=s?this._compileRawPipelineStageDescriptor(t,i,h):this._compilePipelineStageDescriptor(t,i,a,h)}getAttributes(e,t){const i=new Array(t.length),s=e;for(let e=0;e<t.length;e++){const r=t[e],n=s.shaderProcessingContext.availableAttributes[r];void 0!==n&&(i[e]=n)}return i}enableEffect(e){if(!e)return;let t=!0;if(Tt.IsWrapper(e)){if(!e.effect||e.effect===this._currentEffect&&e.materialContext===this._currentMaterialContext&&e.drawContext===this._currentDrawContext&&!this._forceEnableEffect){if(!e.effect&&this.dbgShowEmptyEnableEffectCalls)throw console.error("drawWrapper=",e),"Invalid call to enableEffect: the effect property is empty!";return}if(t=e.effect!==this._currentEffect,this._currentEffect=e.effect,this._currentMaterialContext=e.materialContext,this._currentDrawContext=e.drawContext,this._counters.numEnableDrawWrapper++,!this._currentMaterialContext)throw console.error("drawWrapper=",e),"Invalid call to enableEffect: the materialContext property is empty!"}else t=e!==this._currentEffect,this._currentEffect=e,this._currentMaterialContext=this._defaultMaterialContext,this._currentDrawContext=this._defaultDrawContext,this._counters.numEnableEffects++,this.dbgLogIfNotDrawWrapper&&k.Warn(`enableEffect has been called with an Effect and not a Wrapper! effect.uniqueId=${e.uniqueId}, effect.name=${e.name}, effect.name.vertex=${e.name.vertex}, effect.name.fragment=${e.name.fragment}`,10);this._stencilStateComposer.stencilMaterial=void 0,this._forceEnableEffect=!t&&!this._forceEnableEffect&&this._forceEnableEffect,t&&(this._currentEffect.onBind&&this._currentEffect.onBind(this._currentEffect),this._currentEffect._onBindObservable&&this._currentEffect._onBindObservable.notifyObservers(this._currentEffect))}_releaseEffect(e){this._compiledEffects[e._key]&&(delete this._compiledEffects[e._key],this._deletePipelineContext(e.getPipelineContext()))}releaseEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={}}_deletePipelineContext(e){e&&e.dispose()}get needPOTTextures(){return!1}_createHardwareTexture(){return new tu}_releaseTexture(e){const t=this._internalTexturesCache.indexOf(e);-1!==t&&this._internalTexturesCache.splice(t,1),this._textureHelper.releaseTexture(e)}_getRGBABufferInternalSizedFormat(){return 5}updateTextureComparisonFunction(e,t){e._comparisonFunction=t}_createInternalTexture(e,t,i=!0,s=ut.Unknown){var r,n,o;const a={};void 0!==t&&"object"==typeof t?(a.generateMipMaps=t.generateMipMaps,a.type=void 0===t.type?0:t.type,a.samplingMode=void 0===t.samplingMode?3:t.samplingMode,a.format=void 0===t.format?5:t.format,a.samples=null!==(r=t.samples)&&void 0!==r?r:1,a.creationFlags=null!==(n=t.creationFlags)&&void 0!==n?n:0,a.useSRGBBuffer=null!==(o=t.useSRGBBuffer)&&void 0!==o&&o,a.label=t.label):(a.generateMipMaps=t,a.type=0,a.samplingMode=3,a.format=5,a.samples=1,a.creationFlags=0,a.useSRGBBuffer=!1),(1!==a.type||this._caps.textureFloatLinearFiltering)&&(2!==a.type||this._caps.textureHalfFloatLinearFiltering)||(a.samplingMode=1),1!==a.type||this._caps.textureFloat||(a.type=0,k.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const l=new dt(this,s),h=e.width||e,c=e.height||e,u=e.layers||0;return l.baseWidth=h,l.baseHeight=c,l.width=h,l.height=c,l.depth=u,l.isReady=!0,l.samples=a.samples,l.generateMipMaps=!!a.generateMipMaps,l.samplingMode=a.samplingMode,l.type=a.type,l.format=a.format,l.is2DArray=u>0,l._cachedWrapU=0,l._cachedWrapV=0,l._useSRGBBuffer=a.useSRGBBuffer,l.label=a.label,this._internalTexturesCache.push(l),i||this._textureHelper.createGPUTextureForInternalTexture(l,h,c,u||1,a.creationFlags),l}createTexture(e,t,i,s,r=3,n=null,o=null,a=null,l=null,h=null,c=null,u,d,p,_){return this._createTextureBase(e,t,i,s,r,n,o,((e,t,i,s,r,n,o,a)=>{var l;const c=s;if(e.baseWidth=c.width,e.baseHeight=c.height,e.width=c.width,e.height=c.height,e.format=-1!==e.format?e.format:null!=h?h:5,e.type=-1!==e.type?e.type:0,a(e.width,e.height,c,t,e,(()=>{})),null===(l=e._hardwareTexture)||void 0===l?void 0:l.underlyingResource)n||o||this._generateMipmaps(e,this._uploadEncoder);else{const t=this._textureHelper.createGPUTextureForInternalTexture(e,c.width,c.height,void 0,p);lu.IsImageBitmap(c)&&(this._textureHelper.updateTexture(c,e,c.width,c.height,e.depth,t.format,0,0,r,!1,0,0),n||o||this._generateMipmaps(e,this._uploadEncoder))}i&&i.removePendingData(e),e.isReady=!0,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}),(()=>!1),a,l,h,c,u,d,_)}wrapWebGPUTexture(e){const t=new tu(e),i=new dt(this,ut.Unknown,!0);return i._hardwareTexture=t,i.isReady=!0,i}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapWebGPUTexture instead.")}generateMipMapsForCubemap(e){var t;e.generateMipMaps&&((null===(t=e._hardwareTexture)||void 0===t?void 0:t.underlyingResource)||this._textureHelper.createGPUTextureForInternalTexture(e),this._generateMipmaps(e))}updateTextureSamplingMode(e,t,i=!1){i&&(t.generateMipMaps=!0,this._generateMipmaps(t)),t.samplingMode=e}updateTextureWrappingMode(e,t,i=null,s=null){null!==t&&(e._cachedWrapU=t),null!==i&&(e._cachedWrapV=i),(e.is2DArray||e.is3D)&&null!==s&&(e._cachedWrapR=s)}updateTextureDimensions(e,t,i,s=1){if(!e._hardwareTexture)return;if(e.width===t&&e.height===i&&e.depth===s)return;const r=e._hardwareTexture.textureAdditionalUsages;e._hardwareTexture.release(),this._textureHelper.createGPUTextureForInternalTexture(e,t,i,s,r)}_setInternalTexture(e,t,i){if(i=null!=i?i:e,this._currentEffect){const s=this._currentEffect._pipelineContext.shaderProcessingContext.availableTextures[i];if(this._currentMaterialContext.setTexture(e,t),s&&s.autoBindSampler){const e=i+Kc.AutoSamplerSuffix;this._currentMaterialContext.setSampler(e,t)}}}setTexture(e,t,i,s){this._setTexture(e,i,!1,!1,s,s)}setTextureArray(e,t,i,s){for(let e=0;e<i.length;e++)this._setTexture(-1,i[e],!0,!1,s+e.toString(),s)}_setTexture(e,t,i=!1,s=!1,r="",n){if(n=null!=n?n:r,this._currentEffect){if(!t)return this._currentMaterialContext.setTexture(r,null),!1;if(t.video)t.update();else if(4===t.delayLoadState)return t.delayLoad(),!1;let e=null;if(e=s?t.depthStencilTexture:t.isReady()?t.getInternalTexture():t.isCube?this.emptyCubeTexture:t.is3D?this.emptyTexture3D:t.is2DArray?this.emptyTexture2DArray:this.emptyTexture,e&&!e.isMultiview){if(e.isCube&&e._cachedCoordinatesMode!==t.coordinatesMode){e._cachedCoordinatesMode=t.coordinatesMode;const i=3!==t.coordinatesMode&&5!==t.coordinatesMode?1:0;t.wrapU=i,t.wrapV=i}e._cachedWrapU=t.wrapU,e._cachedWrapV=t.wrapV,e.is3D&&(e._cachedWrapR=t.wrapR),this._setAnisotropicLevel(0,e,t.anisotropicFilteringLevel)}this._setInternalTexture(r,e,n)}else this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - _setTexture called with a null _currentEffect! texture=",t));return!0}_setAnisotropicLevel(e,t,i){t._cachedAnisotropicFilteringLevel!==i&&(t._cachedAnisotropicFilteringLevel=Math.min(i,this._caps.maxAnisotropy))}_bindTexture(e,t,i){void 0!==e&&this._setInternalTexture(i,t)}generateMipmaps(e){this._generateMipmaps(e)}_generateMipmaps(e,t){t=null!=t?t:this._renderEncoder;const i=e._hardwareTexture;if(!i)return;t===this._renderEncoder&&this._endCurrentRenderPass();const s=e._hardwareTexture.format,r=lu.ComputeNumMipmapLevels(e.width,e.height);this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - generate mipmaps - width="+e.width+", height="+e.height+", isCube="+e.isCube+", command encoder="+(t===this._renderEncoder?"render":"copy"))),e.isCube?this._textureHelper.generateCubeMipmaps(i,s,r,t):this._textureHelper.generateMipmaps(i,s,r,0,t)}updateTextureData(e,t,i,s,r,n,o=0,a=0,l=!1){var h;let c=e._hardwareTexture;(null===(h=e._hardwareTexture)||void 0===h?void 0:h.underlyingResource)||(c=this._textureHelper.createGPUTextureForInternalTexture(e));const u=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(u,e,r,n,e.depth,c.format,o,a,e.invertY,!1,i,s),l&&this._generateMipmaps(e)}_uploadCompressedDataToTextureDirectly(e,t,i,s,r,n=0,o=0){var a;let l=e._hardwareTexture;(null===(a=e._hardwareTexture)||void 0===a?void 0:a.underlyingResource)||(e.format=t,l=this._textureHelper.createGPUTextureForInternalTexture(e,i,s));const h=new Uint8Array(r.buffer,r.byteOffset,r.byteLength);this._textureHelper.updateTexture(h,e,i,s,e.depth,l.format,n,o,!1,!1,0,0)}_uploadDataToTextureDirectly(e,t,i=0,s=0,r,n=!1){var o;const a=Math.round(Math.log(e.width)*Math.LOG2E),l=Math.round(Math.log(e.height)*Math.LOG2E),h=n?e.width:Math.pow(2,Math.max(a-s,0)),c=n?e.height:Math.pow(2,Math.max(l-s,0));let u=e._hardwareTexture;(null===(o=e._hardwareTexture)||void 0===o?void 0:o.underlyingResource)||(u=this._textureHelper.createGPUTextureForInternalTexture(e,h,c));const d=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(d,e,h,c,e.depth,u.format,i,s,e.invertY,!1,0,0)}_uploadArrayBufferViewToTexture(e,t,i=0,s=0){this._uploadDataToTextureDirectly(e,t,i,s)}_uploadImageToTexture(e,t,i=0,s=0){var r;let n=e._hardwareTexture;if((null===(r=e._hardwareTexture)||void 0===r?void 0:r.underlyingResource)||(n=this._textureHelper.createGPUTextureForInternalTexture(e)),t instanceof HTMLImageElement)throw"WebGPU engine: HTMLImageElement not supported in _uploadImageToTexture!";const o=t,a=Math.ceil(e.width/(1<<s)),l=Math.ceil(e.height/(1<<s));this._textureHelper.updateTexture(o,e,a,l,e.depth,n.format,i,s,e.invertY,!1,0,0)}readPixels(e,t,i,s,r=!0,n=!0){const o=this._getCurrentRenderPassWrapper().colorAttachmentGPUTextures[0];if(!o)return Promise.resolve(new Uint8Array(0));const a=o.underlyingResource,l=o.format;return a?(n&&this.flushFramebuffer(),this._textureHelper.readPixels(a,e,t,i,s,l)):Promise.resolve(new Uint8Array(0))}beginFrame(){super.beginFrame()}endFrame(){if(this._endCurrentRenderPass(),this._snapshotRendering.endFrame(),this._timestampQuery.endFrame(this._renderEncoder),this.flushFramebuffer(),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._features._collectUbosUpdatedInFrame){if(this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){const e=[];for(const t in ai._UpdatedUbosInFrame)e.push(t+":"+ai._UpdatedUbosInFrame[t]);console.log("frame #"+this._count+" - updated ubos -",e.join(", "))}ai._UpdatedUbosInFrame={}}this.countersLastFrame.numEnableEffects=this._counters.numEnableEffects,this.countersLastFrame.numEnableDrawWrapper=this._counters.numEnableDrawWrapper,this.countersLastFrame.numBundleCreationNonCompatMode=this._counters.numBundleCreationNonCompatMode,this.countersLastFrame.numBundleReuseNonCompatMode=this._counters.numBundleReuseNonCompatMode,this._counters.numEnableEffects=0,this._counters.numEnableDrawWrapper=0,this._counters.numBundleCreationNonCompatMode=0,this._counters.numBundleReuseNonCompatMode=0,this._cacheRenderPipeline.endFrame(),this._cacheBindGroups.endFrame(),this._pendingDebugCommands.length=0,super.endFrame(),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),this._count<this.dbgVerboseLogsNumFrames&&console.log("%c frame #"+this._count+" - end","background: #ffff00"),this._count<this.dbgVerboseLogsNumFrames&&(this._count++,this._count!==this.dbgVerboseLogsNumFrames&&console.log("%c frame #"+this._count+" - begin","background: #ffff00")))}flushFramebuffer(){this._endCurrentRenderPass(),this._commandBuffers[0]=this._uploadEncoder.finish(),this._commandBuffers[1]=this._renderEncoder.finish(),this._device.queue.submit(this._commandBuffers),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._timestampQuery.startFrame(this._uploadEncoder),this._textureHelper.setCommandEncoder(this._uploadEncoder),this._bundleList.reset()}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentPassIsMainPass()}_startRenderTargetRenderPass(e,t,i,s,r){var n,o,a,l,h,c,u,d;this._endCurrentRenderPass();const p=e,_=p._depthStencilTexture,f=null==_?void 0:_._hardwareTexture,m=null==f?void 0:f.underlyingResource,g=null==f?void 0:f.getMSAATexture(),v=null==m?void 0:m.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),x=null==g?void 0:g.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),T=!!f&&lu.HasStencilAspect(f.format),E=[];this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();const S=ju;i&&(S.r=255*i.r,S.g=255*i.g,S.b=255*i.b,S.a=255*i.a);const b=t&&i,C=t&&s,y=t&&r;if(p._attachments&&p.isMulti){this._mrtAttachments&&0!==this._mrtAttachments.length||(this._mrtAttachments=p._defaultAttachments);for(let e=0;e<this._mrtAttachments.length;++e){const t=this._mrtAttachments[e],s=p.textures[e],r=null==s?void 0:s._hardwareTexture,h=null==r?void 0:r.underlyingResource;if(r&&h){const c=r.getMSAATexture(e),u=null!==(o=null===(n=p.layerIndices)||void 0===n?void 0:n[e])&&void 0!==o?o:0,d=null!==(l=null===(a=p.faceIndices)||void 0===a?void 0:a[e])&&void 0!==l?l:0,_=Object.assign(Object.assign({},this._rttRenderPassWrapper.colorAttachmentViewDescriptor),{format:r.format,baseArrayLayer:s.isCube?6*u+d:u}),f=Object.assign(Object.assign({},this._rttRenderPassWrapper.colorAttachmentViewDescriptor),{format:r.format,baseArrayLayer:0}),m=7===s.type||5===s.type,g=h.createView(_),v=null==c?void 0:c.createView(f);E.push({view:v||g,resolveTarget:c?g:void 0,clearValue:0!==t&&b?m?S:i:void 0,loadOp:0!==t&&b?zc.Clear:zc.Load,storeOp:Wc.Store})}}this._cacheRenderPipeline.setMRT(p.textures,this._mrtAttachments.length),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)}else{const e=p.texture;if(e){const t=e._hardwareTexture,s=t.underlyingResource,r=t.getMSAATexture(),n=s.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),o=null==r?void 0:r.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),a=7===e.type||5===e.type;E.push({view:o||n,resolveTarget:r?n:void 0,clearValue:b?a?S:i:void 0,loadOp:b?zc.Clear:zc.Load,storeOp:Wc.Store})}else E.push(null)}if(null===(h=this._debugPushGroup)||void 0===h||h.call(this,"render target pass",1),this._rttRenderPassWrapper.renderPassDescriptor={label:(null!==(c=e.label)&&void 0!==c?c:"RTT")+"RenderPass",colorAttachments:E,depthStencilAttachment:_&&m?{view:x||v,depthClearValue:C?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,depthLoadOp:C?zc.Clear:zc.Load,depthStoreOp:Wc.Store,stencilClearValue:p._depthStencilTextureWithStencil&&y?this._clearStencilValue:void 0,stencilLoadOp:T?p._depthStencilTextureWithStencil&&y?zc.Clear:zc.Load:void 0,stencilStoreOp:T?Wc.Store:void 0}:void 0,occlusionQuerySet:(null===(u=this._occlusionQuery)||void 0===u?void 0:u.hasQueries)?this._occlusionQuery.querySet:void 0},this._currentRenderPass=this._renderEncoder.beginRenderPass(this._rttRenderPassWrapper.renderPassDescriptor),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){const i=p.texture;console.log("frame #"+this._count+" - render target begin pass - rtt name="+e.label+", internalTexture.uniqueId="+i.uniqueId+", width="+i.width+", height="+i.height+", setClearStates="+t,"renderPassDescriptor=",this._rttRenderPassWrapper.renderPassDescriptor)}null===(d=this._debugFlushPendingCommands)||void 0===d||d.call(this),this._resetRenderPassStates(),f&&lu.HasStencilAspect(f.format)||(this._stencilStateComposer.enabled=!1)}_startMainRenderPass(e,t,i,s){var r,n,o;this._endCurrentRenderPass(),this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();const a=e&&t,l=e&&i,h=e&&s;this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].clearValue=a?t:void 0,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].loadOp=a?zc.Clear:zc.Load,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthClearValue=l?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthLoadOp=l?zc.Clear:zc.Load,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilClearValue=h?this._clearStencilValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilLoadOp=this.isStencilEnable?h?zc.Clear:zc.Load:void 0,this._mainRenderPassWrapper.renderPassDescriptor.occlusionQuerySet=(null===(r=this._occlusionQuery)||void 0===r?void 0:r.hasQueries)?this._occlusionQuery.querySet:void 0;const c=this._context.getCurrentTexture();this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].set(c),this._options.antialias?(Hu.format=c.format,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].resolveTarget=c.createView(Hu)):(Xu.format=c.format,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].view=c.createView(Xu)),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - main begin pass - texture width="+this._mainTextureExtends.width," height="+this._mainTextureExtends.height+", setClearStates="+e,"renderPassDescriptor=",this._mainRenderPassWrapper.renderPassDescriptor)),null===(n=this._debugPushGroup)||void 0===n||n.call(this,"main pass",0),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._mainRenderPassWrapper.renderPassDescriptor),this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper),null===(o=this._debugFlushPendingCommands)||void 0===o||o.call(this),this._resetRenderPassStates(),this._isStencilEnable||(this._stencilStateComposer.enabled=!1)}_endCurrentRenderPass(){var e,t,i;if(!this._currentRenderPass)return 0;const s=this._currentPassIsMainPass()?2:1;return this._snapshotRendering.endRenderPass(this._currentRenderPass)||this.compatibilityMode||(this._bundleList.run(this._currentRenderPass),this._bundleList.reset()),this._currentRenderPass.end(),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - "+(2===s?"main":"render target")+" end pass"+(1===s?" - internalTexture.uniqueId="+(null===(t=null===(e=this._currentRenderTarget)||void 0===e?void 0:e.texture)||void 0===t?void 0:t.uniqueId):""))),null===(i=this._debugPopGroup)||void 0===i||i.call(this,0),this._currentRenderPass=null,s}bindFramebuffer(e,t=0,i,s,r,n=0,o=0){var a,l;const h=null===(a=e.texture)||void 0===a?void 0:a._hardwareTexture;this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass(),this._currentRenderTarget=e,this._rttRenderPassWrapper.colorAttachmentGPUTextures[0]=h,this._rttRenderPassWrapper.depthTextureFormat=this._currentRenderTarget._depthStencilTexture?lu.GetWebGPUTextureFormat(-1,this._currentRenderTarget._depthStencilTexture.format):void 0,this._setDepthTextureFormat(this._rttRenderPassWrapper),this._setColorFormat(this._rttRenderPassWrapper),this._rttRenderPassWrapper.colorAttachmentViewDescriptor={format:this._colorFormat,dimension:fc.E2d,mipLevelCount:1,baseArrayLayer:e.isCube?6*o+t:o,baseMipLevel:n,arrayLayerCount:1,aspect:mc.All},this._rttRenderPassWrapper.depthAttachmentViewDescriptor={format:this._depthTextureFormat,dimension:fc.E2d,mipLevelCount:1,baseArrayLayer:e.isCube?6*o+t:o,baseMipLevel:0,arrayLayerCount:1,aspect:mc.All},this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - bindFramebuffer - rtt name="+e.label+", internalTexture.uniqueId="+(null===(l=e.texture)||void 0===l?void 0:l.uniqueId)+", face="+t+", lodLevel="+n+", layer="+o,"colorAttachmentViewDescriptor=",this._rttRenderPassWrapper.colorAttachmentViewDescriptor,"depthAttachmentViewDescriptor=",this._rttRenderPassWrapper.depthAttachmentViewDescriptor)),this._cachedViewport&&!r?this.setViewport(this._cachedViewport,i,s):(i||(i=e.width,n&&(i/=Math.pow(2,n))),s||(s=e.height,n&&(s/=Math.pow(2,n))),this._viewport(0,0,i,s)),this.wipeCaches()}unBindFramebuffer(e,t=!1,i){var s,r;const n=this._currentRenderTarget;this._currentRenderTarget=null,i&&i(),this._currentRenderTarget=n,this._endCurrentRenderPass(),!(null===(s=e.texture)||void 0===s?void 0:s.generateMipMaps)||t||e.isCube||this._generateMipmaps(e.texture),this._currentRenderTarget=null,this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - unBindFramebuffer - rtt name="+e.label+", internalTexture.uniqueId=",null===(r=e.texture)||void 0===r?void 0:r.uniqueId)),this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._currentRenderPass||this._startMainRenderPass(!1),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_setColorFormat(e){var t,i;const s=null!==(i=null===(t=e.colorAttachmentGPUTextures[0])||void 0===t?void 0:t.format)&&void 0!==i?i:null;this._cacheRenderPipeline.setColorFormat(s),this._colorFormat!==s&&(this._colorFormat=s)}_setDepthTextureFormat(e){this._cacheRenderPipeline.setDepthStencilFormat(e.depthTextureFormat),this._depthTextureFormat!==e.depthTextureFormat&&(this._depthTextureFormat=e.depthTextureFormat)}setDitheringState(){}setRasterizerState(){}setState(e,t=0,i,s=!1,r,n,o=0){var a,l;(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e);const h=null===(l=null!==(a=this.cullBackFaces)&&void 0!==a?a:r)||void 0===l||l?1:2;(this._depthCullingState.cullFace!==h||i)&&(this._depthCullingState.cullFace=h),this.setZOffset(t),this.setZOffsetUnits(o);const c=s?this._currentRenderTarget?1:2:this._currentRenderTarget?2:1;(this._depthCullingState.frontFace!==c||i)&&(this._depthCullingState.frontFace=c),this._stencilStateComposer.stencilMaterial=n}_applyRenderPassChanges(e){const t=!!this._stencilStateComposer.enabled&&this._mustUpdateStencilRef(),i=!!this._alphaState.alphaBlend&&this._mustUpdateBlendColor();this._mustUpdateViewport()&&this._applyViewport(e),this._mustUpdateScissor()&&this._applyScissor(e),t&&this._applyStencilRef(e),i&&this._applyBlendColor(e)}_draw(e,t,i,s,r){var n;const o=this._getCurrentRenderPass(),a=this._bundleList;this.applyStates();const l=this._currentEffect._pipelineContext;if(this.bindUniformBufferBase(this._currentRenderTarget?this._ubInvertY:this._ubDontInvertY,0,Kc.InternalsUBOName),l.uniformBuffer&&(l.uniformBuffer.update(),this.bindUniformBufferBase(l.uniformBuffer.getBuffer(),0,Kc.LeftOvertUBOName)),this._snapshotRendering.play)return void this._reportDrawCall();!this.compatibilityMode&&(this._currentDrawContext.isDirty(this._currentMaterialContext.updateId)||this._currentMaterialContext.isDirty||this._currentMaterialContext.forceBindGroupCreation)&&(this._currentDrawContext.fastBundle=void 0);let h=o;if(!this.compatibilityMode&&this._currentDrawContext.fastBundle||this._snapshotRendering.record){if(this._applyRenderPassChanges(a),!this._snapshotRendering.record)return this._counters.numBundleReuseNonCompatMode++,this._currentDrawContext.indirectDrawBuffer&&this._currentDrawContext.setIndirectData(s,r||1,i),a.addBundle(this._currentDrawContext.fastBundle),void this._reportDrawCall();h=a.getBundleEncoder(this._cacheRenderPipeline.colorFormats,this._depthTextureFormat,this.currentSampleCount),a.numDrawCalls++}let c=0;if(this._currentMaterialContext.hasFloatOrDepthTextures){let e=1;for(let t=0;t<l.shaderProcessingContext.textureNames.length;++t){const i=l.shaderProcessingContext.textureNames[t],s=null===(n=this._currentMaterialContext.textures[i])||void 0===n?void 0:n.texture,r=s&&s.format>=13&&s.format<=18;(1===(null==s?void 0:s.type)&&!this._caps.textureFloatLinearFiltering||r)&&(c|=e),e<<=1}}this._currentMaterialContext.textureState=c;const u=this._cacheRenderPipeline.getRenderPipeline(t,this._currentEffect,this.currentSampleCount,c),d=this._cacheBindGroups.getBindGroups(l,this._currentDrawContext,this._currentMaterialContext);this._snapshotRendering.record||(this._applyRenderPassChanges(this.compatibilityMode?null:a),this.compatibilityMode||(this._counters.numBundleCreationNonCompatMode++,h=this._device.createRenderBundleEncoder({colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:lu.GetSample(this.currentSampleCount)}))),h.setPipeline(u),this._currentIndexBuffer&&h.setIndexBuffer(this._currentIndexBuffer.underlyingResource,this._currentIndexBuffer.is32Bits?Bc.Uint32:Bc.Uint16,0);const p=this._cacheRenderPipeline.vertexBuffers;for(let e=0;e<p.length;e++){const t=p[e],i=t.effectiveBuffer;i&&h.setVertexBuffer(e,i.underlyingResource,t._validOffsetRange?0:t.byteOffset)}for(let e=0;e<d.length;e++)h.setBindGroup(e,d[e]);const _=!this.compatibilityMode&&!this._snapshotRendering.record;_&&this._currentDrawContext.indirectDrawBuffer?(this._currentDrawContext.setIndirectData(s,r||1,i),0===e?h.drawIndexedIndirect(this._currentDrawContext.indirectDrawBuffer,0):h.drawIndirect(this._currentDrawContext.indirectDrawBuffer,0)):0===e?h.drawIndexed(s,r||1,i,0,0):h.draw(s,r||1,i,0),_&&(this._currentDrawContext.fastBundle=h.finish(),a.addBundle(this._currentDrawContext.fastBundle)),this._reportDrawCall()}drawElementsType(e,t,i,s=1){this._draw(0,e,t,i,s)}drawArraysType(e,t,i,s=1){this._currentIndexBuffer=null,this._draw(1,e,t,i,s)}dispose(){var e,t;this._isDisposed=!0,null===(e=this._mainTexture)||void 0===e||e.destroy(),null===(t=this._depthTexture)||void 0===t||t.destroy(),this._device.destroy(),super.dispose()}getRenderWidth(e=!1){var t,i;return!e&&this._currentRenderTarget?this._currentRenderTarget.width:null!==(i=null===(t=this._renderingCanvas)||void 0===t?void 0:t.width)&&void 0!==i?i:0}getRenderHeight(e=!1){var t,i;return!e&&this._currentRenderTarget?this._currentRenderTarget.height:null!==(i=null===(t=this._renderingCanvas)||void 0===t?void 0:t.height)&&void 0!==i?i:0}getError(){return 0}bindSamplers(){}_bindTextureDirectly(){return!1}areAllEffectsReady(){return!0}_executeWhenRenderingStateIsCompiled(e,t){t()}_isRenderingStateCompiled(){return!0}_getUnpackAlignement(){return 1}_unpackFlipY(){}_bindUnboundFramebuffer(){throw"_bindUnboundFramebuffer is not implementedin WebGPU! You probably want to use restoreDefaultFramebuffer or unBindFramebuffer instead"}_getSamplingParameters(){throw"_getSamplingParameters is not available in WebGPU"}getUniforms(){return[]}setIntArray(){return!1}setIntArray2(){return!1}setIntArray3(){return!1}setIntArray4(){return!1}setArray(){return!1}setArray2(){return!1}setArray3(){return!1}setArray4(){return!1}setMatrices(){return!1}setMatrix3x3(){return!1}setMatrix2x2(){return!1}setFloat(){return!1}setFloat2(){return!1}setFloat3(){return!1}setFloat4(){return!1}}Ku._GLSLslangDefaultOptions={jsPath:`${Ht._DefaultCdnUrl}/glslang/glslang.js`,wasmPath:`${Ht._DefaultCdnUrl}/glslang/glslang.wasm`},Ku.UseTWGSL=!0,Ku.prototype.setAlphaMode=function(e,t=!1){if(this._alphaMode===e&&(0===e&&!this._alphaState.alphaBlend||0!==e&&this._alphaState.alphaBlend)){if(!t){const t=0===e;this.depthCullingState.depthMask!==t&&(this.setDepthWrite(t),this._cacheRenderPipeline.setDepthWriteEnabled(t))}}else{switch(e){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,1),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,771),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,1),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(1,1,0,1),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(770,1,0,1),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(0,769,1,1),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(774,0,1,1),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(770,769,1,1),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(32769,32770,32771,32772),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(1,769,1,771),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(1,1,1,1),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(772,1,0,0),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(775,769,773,771),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(1,1,1,0),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(775,769,0,1),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,771),this._alphaState.alphaBlend=!0}t||(this.setDepthWrite(e===Ns.ALPHA_DISABLE),this._cacheRenderPipeline.setDepthWriteEnabled(e===Ns.ALPHA_DISABLE)),this._alphaMode=e,this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState.alphaBlend),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)}},Ku.prototype.setAlphaEquation=function(e){Ns.prototype.setAlphaEquation.call(this,e),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)};class $u{getBindGroups(e,t,i){if(!i)throw new Error("WebGPUComputeContext.getBindGroups: bindingsMapping is required until browsers support reflection for wgsl shaders!");if(0===this._bindGroups.length){const s=this._bindGroupEntries.length>0;for(const t in e){const r=e[t],n=i[t],o=n.group,a=n.binding,l=r.type,h=r.object;let c=r.indexInGroupEntries,u=this._bindGroupEntries[o];switch(u||(u=this._bindGroupEntries[o]=[]),l){case pl.Sampler:{const e=h;void 0!==c&&s?u[c].resource=this._cacheSampler.getSampler(e):(r.indexInGroupEntries=u.length,u.push({binding:a,resource:this._cacheSampler.getSampler(e)}));break}case pl.Texture:case pl.TextureWithoutSampler:{const e=h,t=e._texture._hardwareTexture;void 0!==c&&s?(l===pl.Texture&&(u[c++].resource=this._cacheSampler.getSampler(e._texture)),u[c].resource=t.view):(r.indexInGroupEntries=u.length,l===pl.Texture&&u.push({binding:a-1,resource:this._cacheSampler.getSampler(e._texture)}),u.push({binding:a,resource:t.view}));break}case pl.StorageTexture:{const e=h,t=e._texture._hardwareTexture;t.textureAdditionalUsages&_c.StorageBinding||k.Error(`computeDispatch: The texture (name=${e.name}, uniqueId=${e.uniqueId}) is not a storage texture!`,50),void 0!==c&&s?u[c].resource=t.viewForWriting:(r.indexInGroupEntries=u.length,u.push({binding:a,resource:t.viewForWriting}));break}case pl.ExternalTexture:{const e=h.underlyingResource;void 0!==c&&s?u[c].resource=this._device.importExternalTexture({source:e}):(r.indexInGroupEntries=u.length,u.push({binding:a,resource:this._device.importExternalTexture({source:e})}));break}case pl.UniformBuffer:case pl.StorageBuffer:{const e=(pl.UniformBuffer,h).getBuffer(),t=e.underlyingResource;void 0!==c&&s?(u[c].resource.buffer=t,u[c].resource.size=e.capacity):(r.indexInGroupEntries=u.length,u.push({binding:a,resource:{buffer:t,offset:0,size:e.capacity}}));break}}}for(let e=0;e<this._bindGroupEntries.length;++e){const i=this._bindGroupEntries[e];this._bindGroups[e]=i?this._device.createBindGroup({layout:t.getBindGroupLayout(e),entries:i}):void 0}this._bindGroups.length=this._bindGroupEntries.length}return this._bindGroups}constructor(e,t){this._device=e,this._cacheSampler=t,this.uniqueId=$u._Counter++,this._bindGroupEntries=[],this.clear()}clear(){this._bindGroups=[]}}$u._Counter=0;class qu{get isAsync(){return!1}get isReady(){return!!this.stage}constructor(e){this._name="unnamed",this.engine=e}_getComputeShaderCode(){var e;return null===(e=this.sources)||void 0===e?void 0:e.compute}dispose(){}}Ku.prototype.createComputeContext=function(){return new $u(this._device,this._cacheSampler)},Ku.prototype.createComputeEffect=function(e,t){const i=(e.computeElement||e.compute||e.computeToken||e.computeSource||e)+"@"+t.defines;if(this._compiledComputeEffects[i]){const e=this._compiledComputeEffects[i];return t.onCompiled&&e.isReady()&&t.onCompiled(e),e}const s=new dl(e,t,this,i);return this._compiledComputeEffects[i]=s,s},Ku.prototype.createComputePipelineContext=function(){return new qu(this)},Ku.prototype.areAllComputeEffectsReady=function(){for(const e in this._compiledComputeEffects)if(!this._compiledComputeEffects[e].isReady())return!1;return!0},Ku.prototype.computeDispatch=function(e,t,i,s,r,n,o){this._endCurrentRenderPass();const a=e._pipelineContext,l=t;a.computePipeline||(a.computePipeline=this._device.createComputePipeline({layout:Pc.Auto,compute:a.stage}));const h=this._renderEncoder.beginComputePass();h.setPipeline(a.computePipeline);const c=l.getBindGroups(i,a.computePipeline,o);for(let e=0;e<c.length;++e){const t=c[e];t&&h.setBindGroup(e,t)}h.dispatchWorkgroups(s,r,n),h.end()},Ku.prototype.releaseComputeEffects=function(){for(const e in this._compiledComputeEffects){const t=this._compiledComputeEffects[e].getPipelineContext();this._deleteComputePipelineContext(t)}this._compiledComputeEffects={}},Ku.prototype._prepareComputePipelineContext=function(e,t,i,s,r){const n=e;this.dbgShowShaderCode&&(console.log(s),console.log(t)),n.sources={compute:t,rawCompute:i},n.stage=this._createComputePipelineStageDescriptor(t,s,r)},Ku.prototype._releaseComputeEffect=function(e){this._compiledComputeEffects[e._key]&&(delete this._compiledComputeEffects[e._key],this._deleteComputePipelineContext(e.getPipelineContext()))},Ku.prototype._rebuildComputeEffects=function(){for(const e in this._compiledComputeEffects){const t=this._compiledComputeEffects[e];t._pipelineContext=null,t._wasPreviouslyReady=!1,t._prepareEffect()}},Ku.prototype._deleteComputePipelineContext=function(e){e&&e.dispose()},Ku.prototype._createComputePipelineStageDescriptor=function(e,t,i){return t=t?"//"+t.split("\n").join("\n//")+"\n":"",{module:this._device.createShaderModule({code:t+e}),entryPoint:i}},Ku.prototype._createDepthStencilCubeTexture=function(e,t){const i=new dt(this,ut.DepthStencil);i.isCube=!0;const s=Object.assign({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1},t);return i.format=s.generateStencil?13:14,this._setupDepthStencilTexture(i,e,s.generateStencil,s.bilinearFiltering,s.comparisonFunction,s.samples),this._textureHelper.createGPUTextureForInternalTexture(i),this._internalTexturesCache.push(i),i},Ku.prototype.createCubeTexture=function(e,t,i,s,r=null,n=null,o,a=null,l=!1,h=0,c=0,u=null,d=!1){return this.createCubeTextureBase(e,t,i,!!s,r,n,o,a,l,h,c,u,null,((e,t)=>{const i=t,n=i[0].width,a=n;this._setCubeMapTextureParams(e,!s),e.format=null!=o?o:-1;const l=this._textureHelper.createGPUTextureForInternalTexture(e,n,a);this._textureHelper.updateCubeTextures(i,l.underlyingResource,n,a,l.format,!1,!1,0,0),s||this._generateMipmaps(e,this._uploadEncoder),e.isReady=!0,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),r&&r()}),!!d)},Ku.prototype._setCubeMapTextureParams=function(e,t,i){e.samplingMode=t?3:2,e._cachedWrapU=0,e._cachedWrapV=0,i&&(e._maxLodLevel=i)},Ku.prototype._debugPushGroup=function(e,t){this._options.enableGPUDebugMarkers&&(0===t||1===t?this._renderEncoder.pushDebugGroup(e):this._currentRenderPass?this._currentRenderPass.pushDebugGroup(e):this._pendingDebugCommands.push(["push",e]))},Ku.prototype._debugPopGroup=function(e){this._options.enableGPUDebugMarkers&&(0===e||1===e?this._renderEncoder.popDebugGroup():this._currentRenderPass?this._currentRenderPass.popDebugGroup():this._pendingDebugCommands.push(["pop",null]))},Ku.prototype._debugInsertMarker=function(e,t){this._options.enableGPUDebugMarkers&&(0===t||1===t?this._renderEncoder.insertDebugMarker(e):this._currentRenderPass?this._currentRenderPass.insertDebugMarker(e):this._pendingDebugCommands.push(["insert",e]))},Ku.prototype._debugFlushPendingCommands=function(){for(let e=0;e<this._pendingDebugCommands.length;++e){const[t,i]=this._pendingDebugCommands[e];switch(t){case"push":this._debugPushGroup(i);break;case"pop":this._debugPopGroup();break;case"insert":this._debugInsertMarker(i)}}this._pendingDebugCommands.length=0},Ku.prototype.updateDynamicIndexBuffer=function(e,t,i=0){const s=e;let r;r=e.is32Bits?t instanceof Uint32Array?t:new Uint32Array(t):t instanceof Uint16Array?t:new Uint16Array(t),this._bufferManager.setSubData(s,i,r)},Ku.prototype.updateDynamicVertexBuffer=function(e,t,i,s){const r=e;let n;void 0===i&&(i=0),void 0===s?(n=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,s=n.byteLength):n=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,this._bufferManager.setSubData(r,i,n,0,s)},Ku.prototype.updateDynamicTexture=function(e,t,i,s=!1,r,n,o){var a;if(!e)return;const l=t.width,h=t.height;let c=e._hardwareTexture;(null===(a=e._hardwareTexture)||void 0===a?void 0:a.underlyingResource)||(c=this._textureHelper.createGPUTextureForInternalTexture(e,l,h)),this._textureHelper.updateTexture(t,e,l,h,e.depth,c.format,0,0,i,s,0,0,o),e.generateMipMaps&&this._generateMipmaps(e),e.isReady=!0};class Qu extends Cu{constructor(e){super(e)}}function Zu(e,t,i,s){let r,n=1;1===s?r=new Float32Array(t*i*4):2===s?(r=new Uint16Array(t*i*4),n=15360):r=7===s?new Uint32Array(t*i*4):new Uint8Array(t*i*4);for(let s=0;s<t;s++)for(let o=0;o<i;o++){const i=3*(o*t+s),a=4*(o*t+s);r[a+0]=e[i+0],r[a+1]=e[i+1],r[a+2]=e[i+2],r[a+3]=n}return r}ot.prototype.setExternalTexture=function(e,t){this._engine.setExternalTexture(e,t)},Ku.prototype.createExternalTexture=function(e){return new Qu(e)},Ku.prototype.setExternalTexture=function(e,t){t?this._setInternalTexture(e,t):this._currentMaterialContext.setTexture(e,null)},Ku.prototype.unBindMultiColorAttachmentFramebuffer=function(e,t=!1,i){i&&i();const s=e._attachments.length;this._endCurrentRenderPass();for(let i=0;i<s;i++){const s=e.textures[i];!s.generateMipMaps||t||s.isCube||this._generateMipmaps(s)}this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)},Ku.prototype.createMultipleRenderTarget=function(e,t,i){var s,r,n;let o=!1,a=!0,l=!1,h=!1,c=15,u=1,d=[],p=[],_=[],f=[],m=[],g=[],v=[],x=[],T=[];const E=this._createHardwareRenderTargetWrapper(!0,!1,e);void 0!==t&&(o=void 0!==t.generateMipMaps&&t.generateMipMaps,a=void 0===t.generateDepthBuffer||t.generateDepthBuffer,l=void 0!==t.generateStencilBuffer&&t.generateStencilBuffer,h=void 0!==t.generateDepthTexture&&t.generateDepthTexture,u=t.textureCount||1,c=null!==(s=t.depthTextureFormat)&&void 0!==s?s:15,t.types&&(d=t.types),t.samplingModes&&(p=t.samplingModes),t.useSRGBBuffers&&(_=t.useSRGBBuffers),t.formats&&(f=t.formats),t.targetTypes&&(m=t.targetTypes),t.faceIndex&&(g=t.faceIndex),t.layerIndex&&(v=t.layerIndex),t.layerCounts&&(x=t.layerCounts),T=null!==(r=t.labels)&&void 0!==r?r:T);const S=e.width||e,b=e.height||e;let C=null;(a||l||h)&&(h||(c=a&&l?13:a?14:19),C=E.createDepthStencilTexture(0,!1,l,1,c,"MultipleRenderTargetDepthStencil"));const y=[],A=[],R=[];E._generateDepthBuffer=a,E._generateStencilBuffer=l,E._attachments=A,E._defaultAttachments=R;for(let e=0;e<u;e++){let t=p[e]||3,s=d[e]||0;const r=f[e]||5,a=!!_[e]&&this._caps.supportSRGBBuffers,l=m[e]||3553,h=null!==(n=x[e])&&void 0!==n?n:1;if((1!==s||this._caps.textureFloatLinearFiltering)&&(2!==s||this._caps.textureHalfFloatLinearFiltering)||(t=1),1!==s||this._caps.textureFloat||(s=0,k.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),A.push(e+1),R.push(i?e+1:0===e?1:0),-1===l)continue;const c=new dt(this,ut.MultiRenderTarget);switch(y[e]=c,l){case 34067:c.isCube=!0;break;case 32879:c.is3D=!0,c.baseDepth=c.depth=h;break;case 35866:c.is2DArray=!0,c.baseDepth=c.depth=h}c.baseWidth=S,c.baseHeight=b,c.width=S,c.height=b,c.isReady=!0,c.samples=1,c.generateMipMaps=o,c.samplingMode=t,c.type=s,c._cachedWrapU=0,c._cachedWrapV=0,c._useSRGBBuffer=a,c.format=r,c.label=T[e],this._internalTexturesCache.push(c),this._textureHelper.createGPUTextureForInternalTexture(c)}return C&&(C.incrementReferences(),y[u]=C,this._internalTexturesCache.push(C)),E.setTextures(y),E.setLayerAndFaceIndices(v,g),E},Ku.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,t){if(!e||!e.textures||e.textures[0].samples===t)return t;const i=e.textures.length;if(0===i)return 1;t=Math.min(t,this.getCaps().maxMSAASamples);for(let t=0;t<i;++t){const i=e.textures[t]._hardwareTexture;null==i||i.releaseMSAATexture()}const s=e._depthStencilTexture===e.textures[i-1];for(let r=0;r<i;++r){const n=e.textures[r];this._textureHelper.createMSAATexture(n,t,!1,r===i-1&&s?0:r),n.samples=t}return e._depthStencilTexture&&!s&&(this._textureHelper.createMSAATexture(e._depthStencilTexture,t),e._depthStencilTexture.samples=t),t},Ku.prototype.bindAttachments=function(e){0!==e.length&&this._currentRenderTarget&&(this._mrtAttachments=e,this._currentRenderPass&&this._cacheRenderPipeline.setMRTAttachments(e))},Ku.prototype.buildTextureLayout=function(e){const t=[];for(let i=0;i<e.length;i++)e[i]?t.push(i+1):t.push(0);return t},Ku.prototype.restoreSingleAttachment=function(){},Ku.prototype.restoreSingleAttachmentForRenderTarget=function(){},Ku.prototype.getGPUFrameTimeCounter=function(){return this._timestampQuery.gpuFrameTimeCounter},Ku.prototype.captureGPUFrameTime=function(e){this._timestampQuery.enable=e&&!!this._caps.timerQuery},Ku.prototype.createQuery=function(){return this._occlusionQuery.createQuery()},Ku.prototype.deleteQuery=function(e){return this._occlusionQuery.deleteQuery(e),this},Ku.prototype.isQueryResultAvailable=function(e){return this._occlusionQuery.isQueryResultAvailable(e)},Ku.prototype.getQueryResult=function(e){return this._occlusionQuery.getQueryResult(e)},Ku.prototype.beginOcclusionQuery=function(e,t){var i;return this.compatibilityMode?!!this._occlusionQuery.canBeginQuery(t)&&(null===(i=this._currentRenderPass)||void 0===i||i.beginOcclusionQuery(t),!0):(this._bundleList.addItem(new Fu(t)),!0)},Ku.prototype.endOcclusionQuery=function(){var e;return this.compatibilityMode?null===(e=this._currentRenderPass)||void 0===e||e.endOcclusionQuery():this._bundleList.addItem(new wu),this},Ku.prototype.createRawTexture=function(e,t,i,s,r,n,o,a=null,l=0,h=0,c=!1){const u=new dt(this,ut.Raw);return u.baseWidth=t,u.baseHeight=i,u.width=t,u.height=i,u.format=s,u.generateMipMaps=r,u.samplingMode=o,u.invertY=n,u._compression=a,u.type=l,u._useSRGBBuffer=c,this._doNotHandleContextLost||(u._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(u,t,i,void 0,h),this.updateRawTexture(u,e,s,n,a,l,c),this._internalTexturesCache.push(u),u},Ku.prototype.updateRawTexture=function(e,t,i,s,r=null,n=0,o=!1){if(e){if(this._doNotHandleContextLost||(e._bufferView=t,e.invertY=s,e._compression=r,e._useSRGBBuffer=o),t){const r=e._hardwareTexture;4===i&&(t=Zu(t,e.width,e.height,n));const o=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(o,e,e.width,e.height,e.depth,r.format,0,0,s,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0}},Ku.prototype.createRawCubeTexture=function(e,t,i,s,r,n,o,a=null){const l=new dt(this,ut.CubeRaw);return 1!==s||this._caps.textureFloatLinearFiltering?2!==s||this._caps.textureHalfFloatLinearFiltering?1!==s||this._caps.textureFloatRender?2!==s||this._caps.colorBufferFloat||(r=!1,k.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(r=!1,k.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(r=!1,o=1,k.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(r=!1,o=1,k.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")),l.isCube=!0,l.format=4===i?5:i,l.type=s,l.generateMipMaps=r,l.width=t,l.height=t,l.samplingMode=o,this._doNotHandleContextLost||(l._bufferViewArray=e),l.invertY=n,l._compression=a,l._cachedWrapU=0,l._cachedWrapV=0,this._textureHelper.createGPUTextureForInternalTexture(l),e&&this.updateRawCubeTexture(l,e,i,s,n,a),l.isReady=!0,l},Ku.prototype.updateRawCubeTexture=function(e,t,i,s,r,n=null){e._bufferViewArray=t,e.invertY=r,e._compression=n;const o=e._hardwareTexture,a=4===i,l=[];for(let i=0;i<t.length;++i){let r=t[i];a&&(r=Zu(t[i],e.width,e.height,s)),l.push(new Uint8Array(r.buffer,r.byteOffset,r.byteLength))}this._textureHelper.updateCubeTextures(l,o.underlyingResource,e.width,e.height,o.format,r,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder),e.isReady=!0},Ku.prototype.createRawCubeTextureFromUrl=function(e,t,i,s,r,n,o,a,l=null,h=null,c=3,u=!1){const d=this.createRawCubeTexture(null,i,s,r,!n,u,c,null);null==t||t.addPendingData(d),d.url=e,this._internalTexturesCache.push(d);const p=e=>{const i=d.width,n=o(e);if(!n)return;const h=[0,2,4,1,3,5];if(a){const e=4===s,t=a(n),o=d._hardwareTexture,l=[0,1,2,3,4,5];for(let s=0;s<t.length;s++){const n=i>>s,a=[];for(let i=0;i<6;i++){let o=t[s][l[i]];e&&(o=Zu(o,n,n,r)),a.push(new Uint8Array(o.buffer,o.byteOffset,o.byteLength))}this._textureHelper.updateCubeTextures(a,o.underlyingResource,n,n,o.format,u,!1,0,0)}}else{const e=[];for(let t=0;t<6;t++)e.push(n[h[t]]);this.updateRawCubeTexture(d,e,s,r,u)}d.isReady=!0,null==t||t.removePendingData(d),l&&l()};return this._loadFile(e,(e=>{p(e)}),void 0,null==t?void 0:t.offlineProvider,!0,((e,i)=>{null==t||t.removePendingData(d),h&&e&&h(e.status+" "+e.statusText,i)})),d},Ku.prototype.createRawTexture3D=function(e,t,i,s,r,n,o,a,l=null,h=0,c=0){const u=ut.Raw3D,d=new dt(this,u);return d.baseWidth=t,d.baseHeight=i,d.baseDepth=s,d.width=t,d.height=i,d.depth=s,d.format=r,d.type=h,d.generateMipMaps=n,d.samplingMode=a,d.is3D=!0,this._doNotHandleContextLost||(d._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(d,t,i,void 0,c),this.updateRawTexture3D(d,e,r,o,l,h),this._internalTexturesCache.push(d),d},Ku.prototype.updateRawTexture3D=function(e,t,i,s,r=null,n=0){if(this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.invertY=s,e._compression=r),t){const r=e._hardwareTexture;4===i&&(t=Zu(t,e.width,e.height,n));const o=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(o,e,e.width,e.height,e.depth,r.format,0,0,s,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0},Ku.prototype.createRawTexture2DArray=function(e,t,i,s,r,n,o,a,l=null,h=0,c=0){const u=ut.Raw2DArray,d=new dt(this,u);return d.baseWidth=t,d.baseHeight=i,d.baseDepth=s,d.width=t,d.height=i,d.depth=s,d.format=r,d.type=h,d.generateMipMaps=n,d.samplingMode=a,d.is2DArray=!0,this._doNotHandleContextLost||(d._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(d,t,i,s,c),this.updateRawTexture2DArray(d,e,r,o,l,h),this._internalTexturesCache.push(d),d},Ku.prototype.updateRawTexture2DArray=function(e,t,i,s,r=null,n=0){if(this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.invertY=s,e._compression=r),t){const r=e._hardwareTexture;4===i&&(t=Zu(t,e.width,e.height,n));const o=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(o,e,e.width,e.height,e.depth,r.format,0,0,s,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0},Ku.prototype._readTexturePixels=function(e,t,i,s=-1,r=0,n=null,o=!0,a=!1,l=0,h=0){const c=e._hardwareTexture;return o&&this.flushFramebuffer(),this._textureHelper.readPixels(c.underlyingResource,l,h,t,i,c.format,s,r,n,a)},Ku.prototype._readTexturePixelsSync=function(){throw"_readTexturePixelsSync is unsupported in WebGPU!"};class Ju extends cn{}Ku.prototype._createHardwareRenderTargetWrapper=function(e,t,i){const s=new Ju(e,t,i,this);return this._renderTargetWrapperCache.push(s),s},Ku.prototype.createRenderTargetTexture=function(e,t){var i,s,r;const n=this._createHardwareRenderTargetWrapper(!1,!1,e),o={};void 0!==t&&"object"==typeof t?(o.generateMipMaps=t.generateMipMaps,o.generateDepthBuffer=void 0===t.generateDepthBuffer||t.generateDepthBuffer,o.generateStencilBuffer=o.generateDepthBuffer&&t.generateStencilBuffer,o.samplingMode=void 0===t.samplingMode?3:t.samplingMode,o.creationFlags=null!==(i=t.creationFlags)&&void 0!==i?i:0,o.noColorAttachment=!!t.noColorAttachment,o.samples=t.samples,o.label=t.label):(o.generateMipMaps=t,o.generateDepthBuffer=!0,o.generateStencilBuffer=!1,o.samplingMode=3,o.creationFlags=0,o.noColorAttachment=!1);const a=o.noColorAttachment?null:this._createInternalTexture(e,t,!0,ut.RenderTarget);return n.label=null!==(s=o.label)&&void 0!==s?s:"RenderTargetWrapper",n._samples=null!==(r=o.samples)&&void 0!==r?r:1,n._generateDepthBuffer=o.generateDepthBuffer,n._generateStencilBuffer=!!o.generateStencilBuffer,n.setTextures(a),(n._generateDepthBuffer||n._generateStencilBuffer)&&n.createDepthStencilTexture(0,!1,n._generateStencilBuffer,n.samples,o.generateStencilBuffer?13:14,o.label?o.label+"-DepthStencil":void 0),a&&(void 0!==t&&"object"==typeof t&&t.createMipMaps&&!o.generateMipMaps&&(a.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(a,void 0,void 0,void 0,o.creationFlags),void 0!==t&&"object"==typeof t&&t.createMipMaps&&!o.generateMipMaps&&(a.generateMipMaps=!1)),n},Ku.prototype._createDepthStencilTexture=function(e,t){const i=new dt(this,ut.DepthStencil);i.label=t.label;const s=Object.assign({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:t.generateStencil?13:14},t);i.format=s.depthTextureFormat,this._setupDepthStencilTexture(i,e,s.generateStencil,s.bilinearFiltering,s.comparisonFunction,s.samples),this._textureHelper.createGPUTextureForInternalTexture(i);const r=i._hardwareTexture;return i.type=lu.GetTextureTypeFromFormat(r.format),this._internalTexturesCache.push(i),i},Ku.prototype._setupDepthStencilTexture=function(e,t,i,s,r,n=1){const o=t.width||t,a=t.height||t,l=t.layers||0;e.baseWidth=o,e.baseHeight=a,e.width=o,e.height=a,e.is2DArray=l>0,e.depth=l,e.isReady=!0,e.samples=n,e.generateMipMaps=!1,e.samplingMode=s?2:1,e.type=1,e._comparisonFunction=r,e._cachedWrapU=0,e._cachedWrapV=0},Ku.prototype.updateRenderTargetTextureSampleCount=function(e,t){return e&&e.texture&&e.samples!==t?(t=Math.min(t,this.getCaps().maxMSAASamples),this._textureHelper.createMSAATexture(e.texture,t),e._depthStencilTexture&&(this._textureHelper.createMSAATexture(e._depthStencilTexture,t),e._depthStencilTexture.samples=t),e._samples=t,e.texture.samples=t,t):t},Ku.prototype.createRenderTargetCubeTexture=function(e,t){var i;const s=this._createHardwareRenderTargetWrapper(!1,!0,e),r=Object.assign({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,samples:1},t);r.generateStencilBuffer=r.generateDepthBuffer&&r.generateStencilBuffer,s.label=null!==(i=r.label)&&void 0!==i?i:"RenderTargetWrapper",s._generateDepthBuffer=r.generateDepthBuffer,s._generateStencilBuffer=r.generateStencilBuffer;const n=new dt(this,ut.RenderTarget);return n.width=e,n.height=e,n.depth=0,n.isReady=!0,n.isCube=!0,n.samples=r.samples,n.generateMipMaps=r.generateMipMaps,n.samplingMode=r.samplingMode,n.type=r.type,n.format=r.format,this._internalTexturesCache.push(n),s.setTextures(n),(s._generateDepthBuffer||s._generateStencilBuffer)&&s.createDepthStencilTexture(0,void 0===r.samplingMode||2===r.samplingMode||2===r.samplingMode||3===r.samplingMode||3===r.samplingMode||5===r.samplingMode||6===r.samplingMode||7===r.samplingMode||11===r.samplingMode,s._generateStencilBuffer,s.samples),t&&t.createMipMaps&&!r.generateMipMaps&&(n.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(n),t&&t.createMipMaps&&!r.generateMipMaps&&(n.generateMipMaps=!1),s},ot.prototype.setTextureSampler=function(e,t){this._engine.setTextureSampler(e,t)},Ku.prototype.setTextureSampler=function(e,t){var i;null===(i=this._currentMaterialContext)||void 0===i||i.setSampler(e,t)},ot.prototype.setStorageBuffer=function(e,t){this._engine.setStorageBuffer(e,t)},Ku.prototype.createStorageBuffer=function(e,t,i){return this._createBuffer(e,32|t,i)},Ku.prototype.updateStorageBuffer=function(e,t,i,s){const r=e;let n;void 0===i&&(i=0),void 0===s?(n=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,s=n.byteLength):n=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,this._bufferManager.setSubData(r,i,n,0,s)},Ku.prototype.readFromStorageBuffer=function(e,t,i,s){i=i||e.capacity;const r=this._bufferManager.createRawBuffer(i,uc.MapRead|uc.CopyDst,void 0,"TempReadFromStorageBuffer");return this._renderEncoder.copyBufferToBuffer(e.underlyingResource,null!=t?t:0,r,0,i),new Promise(((e,t)=>{this.onEndFrameObservable.addOnce((()=>{r.mapAsync(dc.Read,0,i).then((()=>{const t=r.getMappedRange(0,i);let n=s;if(void 0===n)n=new Uint8Array(i),n.set(new Uint8Array(t));else{const e=n.constructor;n=new e(n.buffer),n.set(new e(t))}r.unmap(),this._bufferManager.releaseBuffer(r),e(n)}),(e=>t(e)))}))}))},Ku.prototype.setStorageBuffer=function(e,t){var i,s;null===(i=this._currentDrawContext)||void 0===i||i.setBuffer(e,null!==(s=null==t?void 0:t.getBuffer())&&void 0!==s?s:null)},Ku.prototype.createUniformBuffer=function(e,t){let i;return i=e instanceof Array?new Float32Array(e):e,this._bufferManager.createBuffer(i,uc.Uniform|uc.CopyDst,t)},Ku.prototype.createDynamicUniformBuffer=function(e,t){return this.createUniformBuffer(e,t)},Ku.prototype.updateUniformBuffer=function(e,t,i,s){void 0===i&&(i=0);const r=e;let n;void 0===s?(n=t instanceof Float32Array?t:new Float32Array(t),s=n.byteLength):n=t instanceof Float32Array?t:new Float32Array(t),this._bufferManager.setSubData(r,i,n,0,s)},Ku.prototype.bindUniformBufferBase=function(e,t,i){this._currentDrawContext.setBuffer(i,e)},Ku.prototype.bindUniformBlock=function(){},Ku.prototype.updateVideoTexture=function(e,t,i){var s;if(!e||e._isDisabled)return;void 0===this._videoTextureSupported&&(this._videoTextureSupported=!0);let r=e._hardwareTexture;(null===(s=e._hardwareTexture)||void 0===s?void 0:s.underlyingResource)||(r=this._textureHelper.createGPUTextureForInternalTexture(e)),function(e){return!(!e||void 0===e.underlyingResource)}(t)?(this._textureHelper.copyVideoToTexture(t,e,r.format,!i),e.generateMipMaps&&this._generateMipmaps(e),e.isReady=!0):t&&this.createImageBitmap(t).then((t=>{this._textureHelper.updateTexture(t,e,e.width,e.height,e.depth,r.format,0,0,!i,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e),e.isReady=!0})).catch((()=>{e.isReady=!0}))};class ed{}ed.COPY=1,ed.CUT=2,ed.PASTE=3;class td extends Al{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}get disableMaterial(){return this._disableMaterial}constructor(e,t=N.Gray(),i=yl.DefaultUtilityLayer,s=null,r=1,n=N.Yellow(),o=N.Gray()){var l,h,c,u,d,p,_;super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new a,this.uniformScaling=!1,this.sensitivity=1,this.dragScale=1,this.incrementalSnap=!1,this._isEnabled=!0,this._parent=null,this._dragging=!1,this._tmpVector=new S(0,0,0),this._parent=s,this._coloredMaterial=new Va("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new N(.1,.1,.1)),this._hoverMaterial=new Va("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=n,this._disableMaterial=new Va("",i.utilityLayerScene),this._disableMaterial.diffuseColor=o,this._disableMaterial.alpha=.4,this._gizmoMesh=new ur("axis",i.utilityLayerScene);const{arrowMesh:f,arrowTail:m}=this._createGizmoMesh(this._gizmoMesh,r),g=this._createGizmoMesh(this._gizmoMesh,r+4,!0);this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._rootMesh.addChild(this._gizmoMesh,Al.PreserveScaling),this._gizmoMesh.scaling.scaleInPlace(1/3);const v=f.position.clone(),x=m.position.clone(),T=m.scaling.clone(),E=e=>{const t=e*(3/this._rootMesh.scaling.length())*6;f.position.z+=t/3.5,m.scaling.y+=t,this.dragScale=m.scaling.y,m.position.z=f.position.z/2},b=()=>{f.position.set(v.x,v.y,v.z),m.position.set(x.x,x.y,x.z),m.scaling.set(T.x,T.y,T.z),this.dragScale=m.scaling.y,this._dragging=!1};this.dragBehavior=new Ur({dragAxis:e}),this.dragBehavior.moveAttached=!1,this.dragBehavior.updateDragPlane=!1,this._rootMesh.addBehavior(this.dragBehavior);let C=0,A=0;const I={snapDistance:0};this.dragBehavior.onDragObservable.add((t=>{if(this.attachedNode){const i=this.sensitivity*t.dragDistance*(3*this.scaleRatio/this._rootMesh.scaling.length()),s=this._tmpVector;let r=!1,n=0;if(this.uniformScaling?s.setAll(.57735):s.copyFrom(e),0==this.snapDistance)s.scaleToRef(i,s);else{C+=i,A+=i;const e=this.incrementalSnap?A:C;Math.abs(e)>this.snapDistance?(n=Math.floor(Math.abs(e)/this.snapDistance),e<0&&(n*=-1),C%=this.snapDistance,s.scaleToRef(this.snapDistance*n,s),r=!0):s.scaleInPlace(0)}s.addInPlaceFromFloats(1,1,1),s.x=Math.abs(s.x)<td.MinimumAbsoluteScale?td.MinimumAbsoluteScale*(s.x<0?-1:1):s.x,s.y=Math.abs(s.y)<td.MinimumAbsoluteScale?td.MinimumAbsoluteScale*(s.y<0?-1:1):s.y,s.z=Math.abs(s.z)<td.MinimumAbsoluteScale?td.MinimumAbsoluteScale*(s.z<0?-1:1):s.z;const o=this.attachedNode._isMesh?this.attachedNode:void 0;Math.abs(this.snapDistance)>0&&this.incrementalSnap?(this.attachedNode.getWorldMatrix().decompose(void 0,R.Quaternion[0],R.Vector3[2],Al.PreserveScaling?o:void 0),y.ComposeToRef(s,R.Quaternion[0],R.Vector3[2],R.Matrix[1])):(y.ScalingToRef(s.x,s.y,s.z,R.Matrix[2]),R.Matrix[2].multiplyToRef(this.attachedNode.getWorldMatrix(),R.Matrix[1])),R.Matrix[1].decompose(R.Vector3[1],void 0,void 0,Al.PreserveScaling?o:void 0);const a=1e5;Math.abs(R.Vector3[1].x)<a&&Math.abs(R.Vector3[1].y)<a&&Math.abs(R.Vector3[1].z)<a&&this.attachedNode.getWorldMatrix().copyFrom(R.Matrix[1]),r&&(I.snapDistance=this.snapDistance*n,this.onSnapObservable.notifyObservers(I)),this._matrixChanged()}})),this.dragBehavior.onDragStartObservable.add((()=>{this._dragging=!0})),this.dragBehavior.onDragObservable.add((e=>E(e.dragDistance))),this.dragBehavior.onDragEndObservable.add(b),null===(c=null===(h=null===(l=null==s?void 0:s.uniformScaleGizmo)||void 0===l?void 0:l.dragBehavior)||void 0===h?void 0:h.onDragObservable)||void 0===c||c.add((e=>E(e.delta.y))),null===(p=null===(d=null===(u=null==s?void 0:s.uniformScaleGizmo)||void 0===u?void 0:u.dragBehavior)||void 0===d?void 0:d.onDragEndObservable)||void 0===p||p.add(b);const P={gizmoMeshes:[f,m],colliderMeshes:[g.arrowMesh,g.arrowTail],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};null===(_=this._parent)||void 0===_||_.addToAxisCache(this._gizmoMesh,P),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add((e=>{var t;if(!this._customMeshSet&&(this._isHovered=!(-1==P.colliderMeshes.indexOf(null===(t=null==e?void 0:e.pickInfo)||void 0===t?void 0:t.pickedMesh)),!this._parent)){const e=this.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(P.gizmoMeshes,e)}})),this.dragBehavior.onEnabledObservable.add((e=>{this._setGizmoMeshMaterial(P.gizmoMeshes,e?this._coloredMaterial:this._disableMaterial)}));const M=i._getSharedGizmoLight();M.includedOnlyMeshes=M.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes())}_createGizmoMesh(e,t,i=!1){const s=Pl("yPosMesh",{size:.4*(1+(t-1)/4)},this.gizmoLayer.utilityLayerScene),r=bl("cylinder",{diameterTop:.005*t,height:.275,diameterBottom:.005*t,tessellation:96},this.gizmoLayer.utilityLayerScene);return s.scaling.scaleInPlace(.1),s.material=this._coloredMaterial,s.rotation.x=Math.PI/2,s.position.z+=.3,r.material=this._coloredMaterial,r.position.z+=.1375,r.rotation.x=Math.PI/2,i&&(s.visibility=0,r.visibility=0),e.addChild(s),e.addChild(r),{arrowMesh:s,arrowTail:r}}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh,this.attachedNode=this._parent.attachedNode):(this.attachedMesh=null,this.attachedNode=null)}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach((e=>{e&&e.dispose()})),super.dispose()}setCustomMesh(e,t=!1){super.setCustomMesh(e),t&&(this._rootMesh.getChildMeshes().forEach((e=>{e.material=this._coloredMaterial,e.color&&(e.color=this._coloredMaterial.diffuseColor)})),this._customMeshSet=!1)}}td.MinimumAbsoluteScale=u;class id extends Al{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}set rotationColor(e){this._rotationShaderMaterial.setColor3("rotationColor",e)}get disableMaterial(){return this._disableMaterial}constructor(e,t=N.Gray(),i=yl.DefaultUtilityLayer,s=32,r=null,n=!1,o=1,l=N.Yellow(),h=N.Gray()){var c;super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new a,this.angle=0,this.sensitivity=1,this._isEnabled=!0,this._parent=null,this._dragging=!1,this._angles=new S,this._parent=r,this._coloredMaterial=new Va("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new N(.1,.1,.1)),this._hoverMaterial=new Va("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=l,this._hoverMaterial.specularColor=l,this._disableMaterial=new Va("",i.utilityLayerScene),this._disableMaterial.diffuseColor=h,this._disableMaterial.alpha=.4,this._gizmoMesh=new ur("",i.utilityLayerScene);const{rotationMesh:d,collider:p}=this._createGizmoMesh(this._gizmoMesh,o,s);this._rotationDisplayPlane=Br("rotationDisplay",{size:.6,updatable:!1},this.gizmoLayer.utilityLayerScene),this._rotationDisplayPlane.rotation.z=.5*Math.PI,this._rotationDisplayPlane.parent=this._gizmoMesh,this._rotationDisplayPlane.setEnabled(!1),ot.ShadersStore.rotationGizmoVertexShader=id._RotationGizmoVertexShader,ot.ShadersStore.rotationGizmoFragmentShader=id._RotationGizmoFragmentShader,this._rotationShaderMaterial=new kl("shader",this.gizmoLayer.utilityLayerScene,{vertex:"rotationGizmo",fragment:"rotationGizmo"},{attributes:["position","uv"],uniforms:["worldViewProjection","angles","rotationColor"]}),this._rotationShaderMaterial.backFaceCulling=!1,this.rotationColor=l,this._rotationDisplayPlane.material=this._rotationShaderMaterial,this._rotationDisplayPlane.visibility=.999,this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._rootMesh.addChild(this._gizmoMesh,Al.PreserveScaling),this._gizmoMesh.scaling.scaleInPlace(1/3),this.dragBehavior=new Ur({dragPlaneNormal:e}),this.dragBehavior.moveAttached=!1,this.dragBehavior.maxDragAngle=id.MaxDragAngle,this.dragBehavior._useAlternatePickedPointAboveMaxDragAngle=!0,this._rootMesh.addBehavior(this.dragBehavior);const _=new S,f=new y,m=new S;let g=new S;this.dragBehavior.onDragStartObservable.add((e=>{this.attachedNode&&(_.copyFrom(e.dragPlanePoint),this._rotationDisplayPlane.setEnabled(!0),this._rotationDisplayPlane.getWorldMatrix().invertToRef(f),S.TransformCoordinatesToRef(e.dragPlanePoint,f,_),this._angles.x=Math.atan2(_.y,_.x)+Math.PI,this._angles.y=0,this._angles.z=this.updateGizmoRotationToMatchAttachedMesh?1:0,this._dragging=!0,_.copyFrom(e.dragPlanePoint),this._rotationShaderMaterial.setVector3("angles",this._angles),this.angle=0)})),this.dragBehavior.onDragEndObservable.add((()=>{this._dragging=!1,this._rotationDisplayPlane.setEnabled(!1)}));const v={snapDistance:0};let x=0;const T=new y,E=new C;this.dragBehavior.onDragObservable.add((t=>{if(this.attachedNode){const s=new S(1,1,1),r=new C(0,0,0,1),n=new S(0,0,0);if(this.attachedNode.getWorldMatrix().decompose(s,r,n),!(Math.abs(Math.abs(s.x)-Math.abs(s.y))<=u&&Math.abs(Math.abs(s.x)-Math.abs(s.z))<=u)&&this.updateGizmoRotationToMatchAttachedMesh)return void k.Warn("Unable to use a rotation gizmo matching mesh rotation with non uniform scaling. Use uniform scaling or set updateGizmoRotationToMatchAttachedMesh to false.");r.normalize();const o=this.updateGizmoPositionToMatchAttachedMesh?n:this._rootMesh.absolutePosition,a=t.dragPlanePoint.subtract(o).normalize(),l=_.subtract(o).normalize(),h=S.Cross(a,l),c=S.Dot(a,l);let d=Math.atan2(h.length(),c)*this.sensitivity;m.copyFrom(e),g.copyFrom(e),this.updateGizmoRotationToMatchAttachedMesh&&(r.toRotationMatrix(f),g=S.TransformCoordinates(m,f));let p=!1;if(i.utilityLayerScene.activeCamera){const e=i.utilityLayerScene.activeCamera.position.subtract(o).normalize();S.Dot(e,g)>0&&(m.scaleInPlace(-1),g.scaleInPlace(-1),p=!0)}S.Dot(g,h)>0&&(d=-d),R.Vector3[0].set(d,0,0),this.dragBehavior.validateDrag(R.Vector3[0])||(d=0);let b=!1;if(0!=this.snapDistance)if(x+=d,Math.abs(x)>this.snapDistance){let e=Math.floor(Math.abs(x)/this.snapDistance);x<0&&(e*=-1),x%=this.snapDistance,d=this.snapDistance*e,b=!0}else d=0;const A=Math.sin(d/2);if(E.set(m.x*A,m.y*A,m.z*A,Math.cos(d/2)),T.determinant()>0){const e=new S;E.toEulerAnglesToRef(e),C.RotationYawPitchRollToRef(e.y,-e.x,-e.z,E)}if(this.updateGizmoRotationToMatchAttachedMesh)r.multiplyToRef(E,r),r.normalize(),y.ComposeToRef(s,r,n,this.attachedNode.getWorldMatrix());else{E.toRotationMatrix(R.Matrix[0]);const e=this.attachedNode.getWorldMatrix().getTranslation();this.attachedNode.getWorldMatrix().multiplyToRef(R.Matrix[0],this.attachedNode.getWorldMatrix()),this.attachedNode.getWorldMatrix().setTranslation(e)}_.copyFrom(t.dragPlanePoint),b&&(v.snapDistance=d,this.onSnapObservable.notifyObservers(v)),this._angles.y+=d,this.angle+=p?-d:d,this._rotationShaderMaterial.setVector3("angles",this._angles),this._matrixChanged()}}));const b=i._getSharedGizmoLight();b.includedOnlyMeshes=b.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes(!1));const A={colliderMeshes:[p],gizmoMeshes:[d],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};null===(c=this._parent)||void 0===c||c.addToAxisCache(this._gizmoMesh,A),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add((e=>{var t;if(!this._customMeshSet&&(this.dragBehavior.maxDragAngle=id.MaxDragAngle,this._isHovered=!(-1==A.colliderMeshes.indexOf(null===(t=null==e?void 0:e.pickInfo)||void 0===t?void 0:t.pickedMesh)),!this._parent)){const e=A.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(A.gizmoMeshes,e)}})),this.dragBehavior.onEnabledObservable.add((e=>{this._setGizmoMeshMaterial(A.gizmoMeshes,e?this._coloredMaterial:this._disableMaterial)}))}_createGizmoMesh(e,t,i){const s=nl("ignore",{diameter:.6,thickness:.03*t,tessellation:i},this.gizmoLayer.utilityLayerScene);s.visibility=0;const r=nl("",{diameter:.6,thickness:.005*t,tessellation:i},this.gizmoLayer.utilityLayerScene);return r.material=this._coloredMaterial,r.rotation.x=Math.PI/2,s.rotation.x=Math.PI/2,e.addChild(r,Al.PreserveScaling),e.addChild(s,Al.PreserveScaling),{rotationMesh:r,collider:s}}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh):this.attachedMesh=null}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),this._rotationDisplayPlane&&this._rotationDisplayPlane.dispose(),this._rotationShaderMaterial&&this._rotationShaderMaterial.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach((e=>{e&&e.dispose()})),super.dispose()}}id.MaxDragAngle=9*Math.PI/20,id._RotationGizmoVertexShader="\n        precision highp float;\n        attribute vec3 position;\n        attribute vec2 uv;\n        uniform mat4 worldViewProjection;\n        varying vec3 vPosition;\n        varying vec2 vUV;\n\n        void main(void) {\n            gl_Position = worldViewProjection * vec4(position, 1.0);\n            vUV = uv;\n        }",id._RotationGizmoFragmentShader="\n        precision highp float;\n        varying vec2 vUV;\n        varying vec3 vPosition;\n        uniform vec3 angles;\n        uniform vec3 rotationColor;\n\n        #define twopi 6.283185307\n\n        void main(void) {\n            vec2 uv = vUV - vec2(0.5);\n            float angle = atan(uv.y, uv.x) + 3.141592;\n            float delta = gl_FrontFacing ? angles.y : -angles.y;\n            float begin = angles.x - delta * angles.z;\n            float start = (begin < (begin + delta)) ? begin : (begin + delta);\n            float end = (begin > (begin + delta)) ? begin : (begin + delta);\n            float len = sqrt(dot(uv,uv));\n            float opacity = 1. - step(0.5, len);\n\n            float base = abs(floor(start / twopi)) * twopi;\n            start += base;\n            end += base;\n\n            float intensity = 0.;\n            for (int i = 0; i < 5; i++)\n            {\n                intensity += max(step(start, angle) - step(end, angle), 0.);\n                angle += twopi;\n            }\n            gl_FragColor = vec4(rotationColor, min(intensity * 0.25, 0.8)) * opacity;\n        }\n    ";class sd extends pr{constructor(){super(...arguments),this._needProjectionMatrixCompute=!0}_setPosition(e){this._position=e}get position(){return this._position}set position(e){this._setPosition(e)}_setDirection(e){this._direction=e}get direction(){return this._direction}set direction(e){this._setDirection(e)}get shadowMinZ(){return this._shadowMinZ}set shadowMinZ(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute()}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute()}computeTransformedInformation(){return!(!this.parent||!this.parent.getWorldMatrix||(this.transformedPosition||(this.transformedPosition=S.Zero()),S.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=S.Zero()),S.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),0))}getDepthScale(){return 50}getShadowDirection(e){return this.transformedDirection?this.transformedDirection:this.direction}getAbsolutePosition(){return this.transformedPosition?this.transformedPosition:this.position}setDirectionToTarget(e){return this.direction=S.Normalize(e.subtract(this.position)),this.direction}getRotation(){this.direction.normalize();const e=S.Cross(this.direction,ji.Y),t=S.Cross(e,this.direction);return S.RotationFromAxis(e,t,this.direction)}needCube(){return!1}needProjectionMatrixCompute(){return this._needProjectionMatrixCompute}forceProjectionMatrixCompute(){this._needProjectionMatrixCompute=!0}_initCache(){super._initCache(),this._cache.position=S.Zero()}_isSynchronized(){return!!this._cache.position.equals(this.position)}computeWorldMatrix(e){return!e&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=y.Identity()),y.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)}getDepthMinZ(e){return void 0!==this.shadowMinZ?this.shadowMinZ:e.minZ}getDepthMaxZ(e){return void 0!==this.shadowMaxZ?this.shadowMaxZ:e.maxZ}setShadowProjectionMatrix(e,t,i){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(t,i,e):this._setDefaultShadowProjectionMatrix(e,t,i),this}_syncParentEnabledState(){super._syncParentEnabledState(),this.parent&&this.parent.getWorldMatrix||(this.transformedPosition=null,this.transformedDirection=null)}}me([ae()],sd.prototype,"position",null),me([ae()],sd.prototype,"direction",null),me([ie()],sd.prototype,"shadowMinZ",null),me([ie()],sd.prototype,"shadowMaxZ",null),ve.AddNodeConstructor("Light_Type_1",((e,t)=>()=>new rd(e,S.Zero(),t)));class rd extends sd{get shadowFrustumSize(){return this._shadowFrustumSize}set shadowFrustumSize(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()}get shadowOrthoScale(){return this._shadowOrthoScale}set shadowOrthoScale(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()}get orthoLeft(){return this._orthoLeft}set orthoLeft(e){this._orthoLeft=e}get orthoRight(){return this._orthoRight}set orthoRight(e){this._orthoRight=e}get orthoTop(){return this._orthoTop}set orthoTop(e){this._orthoTop=e}get orthoBottom(){return this._orthoBottom}set orthoBottom(e){this._orthoBottom=e}constructor(e,t,i){super(e,i),this._shadowFrustumSize=0,this._shadowOrthoScale=.1,this.autoUpdateExtends=!0,this.autoCalcShadowZBounds=!1,this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE,this.position=t.scale(-1),this.direction=t}getClassName(){return"DirectionalLight"}getTypeID(){return pr.LIGHTTYPEID_DIRECTIONALLIGHT}_setDefaultShadowProjectionMatrix(e,t,i){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,t,i)}_setDefaultFixedFrustumShadowProjectionMatrix(e){const t=this.getScene().activeCamera;t&&y.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,void 0!==this.shadowMinZ?this.shadowMinZ:t.minZ,void 0!==this.shadowMaxZ?this.shadowMaxZ:t.maxZ,e,this.getScene().getEngine().isNDCHalfZRange)}_setDefaultAutoExtendShadowProjectionMatrix(e,t,i){const s=this.getScene().activeCamera;if(!s)return;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){const e=S.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=-Number.MAX_VALUE,this._orthoTop=-Number.MAX_VALUE,this._orthoBottom=Number.MAX_VALUE;let s=Number.MAX_VALUE,r=-Number.MAX_VALUE;for(let n=0;n<i.length;n++){const o=i[n];if(!o)continue;const a=o.getBoundingInfo().boundingBox;for(let i=0;i<a.vectorsWorld.length;i++)S.TransformCoordinatesToRef(a.vectorsWorld[i],t,e),e.x<this._orthoLeft&&(this._orthoLeft=e.x),e.y<this._orthoBottom&&(this._orthoBottom=e.y),e.x>this._orthoRight&&(this._orthoRight=e.x),e.y>this._orthoTop&&(this._orthoTop=e.y),this.autoCalcShadowZBounds&&(e.z<s&&(s=e.z),e.z>r&&(r=e.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=s,this._shadowMaxZ=r)}const r=this._orthoRight-this._orthoLeft,n=this._orthoTop-this._orthoBottom,o=void 0!==this.shadowMinZ?this.shadowMinZ:s.minZ,a=void 0!==this.shadowMaxZ?this.shadowMaxZ:s.maxZ,l=this.getScene().getEngine().useReverseDepthBuffer;y.OrthoOffCenterLHToRef(this._orthoLeft-r*this.shadowOrthoScale,this._orthoRight+r*this.shadowOrthoScale,this._orthoBottom-n*this.shadowOrthoScale,this._orthoTop+n*this.shadowOrthoScale,l?a:o,l?o:a,e,this.getScene().getEngine().isNDCHalfZRange)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,t),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,t),this)}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?(e.setFloat3(t,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(e.setFloat3(t,this.direction.x,this.direction.y,this.direction.z),this)}getDepthMinZ(e){const t=this._scene.getEngine();return!t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}getDepthMaxZ(e){const t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}prepareLightSpecificDefines(e,t){e["DIRLIGHT"+t]=!0}}function nd(e,t={},i){t.diameter||(t.diameter=1),t.segments||(t.segments=16);const s=Ol("",{slice:.5,diameter:t.diameter,segments:t.segments},i),r=Ll("",{radius:t.diameter/2,tessellation:3*t.segments+(4-t.segments)},i);r.rotation.x=-Math.PI/2,r.parent=s;const n=ur.MergeMeshes([r,s],!0);return n.name=e,n}me([ie()],rd.prototype,"shadowFrustumSize",null),me([ie()],rd.prototype,"shadowOrthoScale",null),me([ie()],rd.prototype,"autoUpdateExtends",void 0),me([ie()],rd.prototype,"autoCalcShadowZBounds",void 0),me([ie("orthoLeft")],rd.prototype,"_orthoLeft",void 0),me([ie("orthoRight")],rd.prototype,"_orthoRight",void 0),me([ie("orthoTop")],rd.prototype,"_orthoTop",void 0),me([ie("orthoBottom")],rd.prototype,"_orthoBottom",void 0),ur.CreateHemisphere=(e,t,i,s)=>nd(e,{segments:t,diameter:i},s),ve.AddNodeConstructor("Light_Type_2",((e,t)=>()=>new od(e,S.Zero(),S.Zero(),0,0,t)));class od extends sd{get angle(){return this._angle}set angle(e){this._angle=e,this._cosHalfAngle=Math.cos(.5*e),this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute(),this._computeAngleValues()}get innerAngle(){return this._innerAngle}set innerAngle(e){this._innerAngle=e,this._computeAngleValues()}get shadowAngleScale(){return this._shadowAngleScale}set shadowAngleScale(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute()}get projectionTextureMatrix(){return this._projectionTextureMatrix}get projectionTextureLightNear(){return this._projectionTextureLightNear}set projectionTextureLightNear(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureLightFar(){return this._projectionTextureLightFar}set projectionTextureLightFar(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureUpDirection(){return this._projectionTextureUpDirection}set projectionTextureUpDirection(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=!0}get projectionTexture(){return this._projectionTexture}set projectionTexture(e){this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(od._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled((()=>{this._markMeshesAsLightDirty()})):od._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce((()=>{this._markMeshesAsLightDirty()}))))}static _IsProceduralTexture(e){return void 0!==e.onGeneratedObservable}static _IsTexture(e){return void 0!==e.onLoadObservable}get projectionTextureProjectionLightMatrix(){return this._projectionTextureProjectionLightMatrix}set projectionTextureProjectionLightMatrix(e){this._projectionTextureProjectionLightMatrix=e,this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0}constructor(e,t,i,s,r,n){super(e,n),this._innerAngle=0,this._projectionTextureMatrix=y.Zero(),this._projectionTextureLightNear=1e-6,this._projectionTextureLightFar=1e3,this._projectionTextureUpDirection=S.Up(),this._projectionTextureViewLightDirty=!0,this._projectionTextureProjectionLightDirty=!0,this._projectionTextureDirty=!0,this._projectionTextureViewTargetVector=S.Zero(),this._projectionTextureViewLightMatrix=y.Zero(),this._projectionTextureProjectionLightMatrix=y.Zero(),this._projectionTextureScalingMatrix=y.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),this.position=t,this.direction=i,this.angle=s,this.exponent=r}getClassName(){return"SpotLight"}getTypeID(){return pr.LIGHTTYPEID_SPOTLIGHT}_setDirection(e){super._setDirection(e),this._projectionTextureViewLightDirty=!0}_setPosition(e){super._setPosition(e),this._projectionTextureViewLightDirty=!0}_setDefaultShadowProjectionMatrix(e,t,i){const s=this.getScene().activeCamera;if(!s)return;this._shadowAngleScale=this._shadowAngleScale||1;const r=this._shadowAngleScale*this._angle,n=void 0!==this.shadowMinZ?this.shadowMinZ:s.minZ,o=void 0!==this.shadowMaxZ?this.shadowMaxZ:s.maxZ,a=this.getScene().getEngine().useReverseDepthBuffer;y.PerspectiveFovLHToRef(r,1,a?o:n,a?n:o,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,a)}_computeProjectionTextureViewLightMatrix(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.getAbsolutePosition().addToRef(this.direction,this._projectionTextureViewTargetVector),y.LookAtLHToRef(this.getAbsolutePosition(),this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)}_computeProjectionTextureProjectionLightMatrix(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;const e=this.projectionTextureLightFar,t=this.projectionTextureLightNear,i=e/(e-t),s=-i*t,r=1/Math.tan(this._angle/2);y.FromValuesToRef(r/1,0,0,0,0,r,0,0,0,0,i,1,0,0,s,0,this._projectionTextureProjectionLightMatrix)}_computeProjectionTextureMatrix(){if(this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof Ar){const e=this._projectionTexture.uScale/2,t=this._projectionTexture.vScale/2;y.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix)}this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeAngleValues(){this._lightAngleScale=1/Math.max(.001,Math.cos(.5*this._innerAngle)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale}transferTexturesToEffect(e,t){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+t,this._projectionTextureMatrix),e.setTexture("projectionLightSampler"+t,this.projectionTexture)),this}transferToEffect(e,t){let i;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,t),i=S.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,t),i=S.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",i.x,i.y,i.z,this._cosHalfAngle,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,t),this}transferToNodeMaterialEffect(e,t){let i;return i=this.computeTransformedInformation()?S.Normalize(this.transformedDirection):S.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(t,-i.x,-i.y,-i.z):e.setFloat3(t,i.x,i.y,i.z),this}dispose(){super.dispose(),this._projectionTexture&&this._projectionTexture.dispose()}getDepthMinZ(e){const t=this._scene.getEngine(),i=void 0!==this.shadowMinZ?this.shadowMinZ:e.minZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?i:this._scene.getEngine().isNDCHalfZRange?0:i}getDepthMaxZ(e){const t=this._scene.getEngine(),i=void 0!==this.shadowMaxZ?this.shadowMaxZ:e.maxZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:i}prepareLightSpecificDefines(e,t){e["SPOTLIGHT"+t]=!0,e["PROJECTEDLIGHTTEXTURE"+t]=!(!this.projectionTexture||!this.projectionTexture.isReady())}}me([ie()],od.prototype,"angle",null),me([ie()],od.prototype,"innerAngle",null),me([ie()],od.prototype,"shadowAngleScale",null),me([ie()],od.prototype,"exponent",void 0),me([ie()],od.prototype,"projectionTextureLightNear",null),me([ie()],od.prototype,"projectionTextureLightFar",null),me([ie()],od.prototype,"projectionTextureUpDirection",null),me([se("projectedLightTexture")],od.prototype,"_projectionTexture",void 0);class ad extends Al{constructor(e=yl.DefaultUtilityLayer){super(e),this._cachedPosition=new S,this._cachedForward=new S(0,0,1),this._pointerObserver=null,this.onClickedObservable=new a,this._light=null,this.attachedMesh=new Vs("",this.gizmoLayer.utilityLayerScene),this._attachedMeshParent=new ws("parent",this.gizmoLayer.utilityLayerScene),this.attachedMesh.parent=this._attachedMeshParent,this._material=new Va("light",this.gizmoLayer.utilityLayerScene),this._material.diffuseColor=new N(.5,.5,.5),this._material.specularColor=new N(.1,.1,.1),this._pointerObserver=e.utilityLayerScene.onPointerObservable.add((e=>{this._light&&(this._isHovered=!(!e.pickInfo||-1==this._rootMesh.getChildMeshes().indexOf(e.pickInfo.pickedMesh)),this._isHovered&&0===e.event.button&&this.onClickedObservable.notifyObservers(this._light))}),gi.POINTERDOWN)}get attachedNode(){return this.attachedMesh}set attachedNode(e){console.warn("Nodes cannot be attached to LightGizmo. Attach to a mesh instead.")}set light(e){if(this._light=e,e){this._lightMesh&&this._lightMesh.dispose(),this._lightMesh=e instanceof Cl?ad._CreateHemisphericLightMesh(this.gizmoLayer.utilityLayerScene):e instanceof rd?ad._CreateDirectionalLightMesh(this.gizmoLayer.utilityLayerScene):e instanceof od?ad._CreateSpotLightMesh(this.gizmoLayer.utilityLayerScene):ad._CreatePointLightMesh(this.gizmoLayer.utilityLayerScene),this._lightMesh.getChildMeshes(!1).forEach((e=>{e.material=this._material})),this._lightMesh.parent=this._rootMesh;const t=this.gizmoLayer._getSharedGizmoLight();if(t.includedOnlyMeshes=t.includedOnlyMeshes.concat(this._lightMesh.getChildMeshes(!1)),this._lightMesh.rotationQuaternion=new C,this.attachedMesh.reservedDataStore||(this.attachedMesh.reservedDataStore={}),this.attachedMesh.reservedDataStore.lightGizmo=this,e.parent&&this._attachedMeshParent.freezeWorldMatrix(e.parent.getWorldMatrix()),e.position&&(this.attachedMesh.position.copyFrom(e.position),this.attachedMesh.computeWorldMatrix(!0),this._cachedPosition.copyFrom(this.attachedMesh.position)),e.direction){this.attachedMesh.setDirection(e.direction),this.attachedMesh.computeWorldMatrix(!0);const t=this._getMeshForward();this._cachedForward.copyFrom(t)}this._update()}}get light(){return this._light}get material(){return this._material}_getMeshForward(){let e=this.attachedMesh.forward;return this.attachedMesh.getScene().useRightHandedSystem&&(e.negateToRef(R.Vector3[0]),e=R.Vector3[0]),e}_update(){if(super._update(),this._light){if(this._light.parent&&this._attachedMeshParent.freezeWorldMatrix(this._light.parent.getWorldMatrix()),this._light.position)if(this.attachedMesh.position.equals(this._cachedPosition))this.attachedMesh.position.copyFrom(this._light.position),this.attachedMesh.computeWorldMatrix(!0),this._cachedPosition.copyFrom(this.attachedMesh.position);else{const e=this.attachedMesh.position;this._light.position=new S(e.x,e.y,e.z),this._cachedPosition.copyFrom(this.attachedMesh.position)}if(this._light.direction){const e=this._getMeshForward();if(S.DistanceSquared(e,this._cachedForward)>1e-4){const t=e;this._light.direction=new S(t.x,t.y,t.z),this._cachedForward.copyFrom(e)}else S.DistanceSquared(e,this._light.direction)>1e-4&&(this.attachedMesh.setDirection(this._light.direction),this.attachedMesh.computeWorldMatrix(!0),this._cachedForward.copyFrom(e))}}}dispose(){this.onClickedObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this._material.dispose(),super.dispose(),this._attachedMeshParent.dispose()}static _CreateHemisphericLightMesh(e){const t=new ur("hemisphereLight",e),i=nd(t.name,{segments:10,diameter:1},e);return i.position.z=-.15,i.rotation.x=Math.PI/2,i.parent=t,this._CreateLightLines(3,e).parent=t,t.scaling.scaleInPlace(ad._Scale),t.rotation.x=Math.PI/2,t}static _CreatePointLightMesh(e){const t=new ur("pointLight",e),i=Ol(t.name,{segments:10,diameter:1},e);return i.rotation.x=Math.PI/2,i.parent=t,this._CreateLightLines(5,e).parent=t,t.scaling.scaleInPlace(ad._Scale),t.rotation.x=Math.PI/2,t}static _CreateSpotLightMesh(e){const t=new ur("spotLight",e);Ol(t.name,{segments:10,diameter:1},e).parent=t;const i=nd(t.name,{segments:10,diameter:2},e);return i.parent=t,i.rotation.x=-Math.PI/2,this._CreateLightLines(2,e).parent=t,t.scaling.scaleInPlace(ad._Scale),t.rotation.x=Math.PI/2,t}static _CreateDirectionalLightMesh(e){const t=new ur("directionalLight",e),i=new ur(t.name,e);i.parent=t,Ol(t.name,{diameter:1.2,segments:10},e).parent=i;const s=bl(t.name,{updatable:!1,height:6,diameterTop:.3,diameterBottom:.3,tessellation:6,subdivisions:1},e);s.parent=i;let r=s.clone(t.name);r.scaling.y=.5,r.position.x+=1.25;let n=s.clone(t.name);n.scaling.y=.5,n.position.x+=-1.25;const o=bl(t.name,{updatable:!1,height:1,diameterTop:0,diameterBottom:.6,tessellation:6,subdivisions:1},e);return o.position.y+=3,o.parent=i,r=o.clone(t.name),r.position.y=1.5,r.position.x+=1.25,n=o.clone(t.name),n.position.y=1.5,n.position.x+=-1.25,i.scaling.scaleInPlace(ad._Scale),i.rotation.z=Math.PI/2,i.rotation.y=Math.PI/2,t}}ad._Scale=.007,ad._CreateLightLines=(e,t)=>{const i=new ur("root",t);i.rotation.x=Math.PI/2;const s=new ur("linePivot",t);s.parent=i;const r=bl("line",{updatable:!1,height:2,diameterTop:.2,diameterBottom:.3,tessellation:6,subdivisions:1},t);if(r.position.y=r.scaling.y/2+1.2,r.parent=s,e<2)return s;for(let e=0;e<4;e++){const t=s.clone("lineParentClone");t.rotation.z=Math.PI/4,t.rotation.y=Math.PI/2+Math.PI/2*e,t.getChildMeshes()[0].scaling.y=.5,t.getChildMeshes()[0].scaling.x=t.getChildMeshes()[0].scaling.z=.8,t.getChildMeshes()[0].position.y=t.getChildMeshes()[0].scaling.y/2+1.2}if(e<3)return i;for(let e=0;e<4;e++){const t=s.clone("linePivotClone");t.rotation.z=Math.PI/2,t.rotation.y=Math.PI/2*e}if(e<4)return i;for(let e=0;e<4;e++){const t=s.clone("linePivotClone");t.rotation.z=Math.PI+Math.PI/4,t.rotation.y=Math.PI/2+Math.PI/2*e,t.getChildMeshes()[0].scaling.y=.5,t.getChildMeshes()[0].scaling.x=t.getChildMeshes()[0].scaling.z=.8,t.getChildMeshes()[0].position.y=t.getChildMeshes()[0].scaling.y/2+1.2}return e<5||(s.clone("linePivotClone").rotation.z=Math.PI),i};class ld extends Al{constructor(e=yl.DefaultUtilityLayer,t){super(e),this._pointerObserver=null,this.onClickedObservable=new a,this._camera=null,this._invProjection=new y,this._material=new Va("cameraGizmoMaterial",this.gizmoLayer.utilityLayerScene),this._gizmoColor=t,this._material.diffuseColor=null!=t?t:new N(.5,.5,.5),this._material.specularColor=new N(.1,.1,.1),this._pointerObserver=e.utilityLayerScene.onPointerObservable.add((e=>{this._camera&&(this._isHovered=!(!e.pickInfo||-1==this._rootMesh.getChildMeshes().indexOf(e.pickInfo.pickedMesh)),this._isHovered&&0===e.event.button&&this.onClickedObservable.notifyObservers(this._camera))}),gi.POINTERDOWN)}get displayFrustum(){return this._cameraLinesMesh.isEnabled()}set displayFrustum(e){this._cameraLinesMesh.setEnabled(e)}set camera(e){var t,i;if(this._camera=e,this.attachedNode=e,e){this._cameraMesh&&this._cameraMesh.dispose(),this._cameraLinesMesh&&this._cameraLinesMesh.dispose(),this._cameraMesh=ld._CreateCameraMesh(this.gizmoLayer.utilityLayerScene);const s=null!==(i=null===(t=this._gizmoColor)||void 0===t?void 0:t.toColor4(1))&&void 0!==i?i:new F(1,1,1,1);this._cameraLinesMesh=ld._CreateCameraFrustum(this.gizmoLayer.utilityLayerScene,s),this._cameraMesh.getChildMeshes(!1).forEach((e=>{e.material=this._material})),this._cameraMesh.parent=this._rootMesh,this._cameraLinesMesh.parent=this._rootMesh,this.gizmoLayer.utilityLayerScene.activeCamera&&this.gizmoLayer.utilityLayerScene.activeCamera.maxZ<1.5*e.maxZ&&(this.gizmoLayer.utilityLayerScene.activeCamera.maxZ=1.5*e.maxZ),this.attachedNode.reservedDataStore||(this.attachedNode.reservedDataStore={}),this.attachedNode.reservedDataStore.cameraGizmo=this;const r=this.gizmoLayer._getSharedGizmoLight();r.includedOnlyMeshes=r.includedOnlyMeshes.concat(this._cameraMesh.getChildMeshes(!1)),this._update()}}get camera(){return this._camera}get material(){return this._material}_update(){super._update(),this._camera&&(this._camera.getProjectionMatrix().invertToRef(this._invProjection),this._cameraLinesMesh.setPivotMatrix(this._invProjection,!1),this._cameraLinesMesh.scaling.x=1/this._rootMesh.scaling.x,this._cameraLinesMesh.scaling.y=1/this._rootMesh.scaling.y,this._cameraLinesMesh.scaling.z=1/this._rootMesh.scaling.z,this._cameraMesh.parent=null,this._cameraMesh.rotation.y=.5*Math.PI*(this._camera.getScene().useRightHandedSystem?1:-1),this._cameraMesh.parent=this._rootMesh)}dispose(){this.onClickedObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this._cameraMesh&&this._cameraMesh.dispose(),this._cameraLinesMesh&&this._cameraLinesMesh.dispose(),this._material.dispose(),super.dispose()}static _CreateCameraMesh(e){const t=new ur("rootCameraGizmo",e),i=new ur(t.name,e);i.parent=t,Pl(t.name,{width:1,height:.8,depth:.5},e).parent=i;const s=bl(t.name,{height:.5,diameterTop:.8,diameterBottom:.8},e);s.parent=i,s.position.y=.3,s.position.x=-.6,s.rotation.x=.5*Math.PI;const r=bl(t.name,{height:.5,diameterTop:.6,diameterBottom:.6},e);r.parent=i,r.position.y=.5,r.position.x=.4,r.rotation.x=.5*Math.PI;const n=bl(t.name,{height:.5,diameterTop:.5,diameterBottom:.5},e);return n.parent=i,n.position.y=0,n.position.x=.6,n.rotation.z=.5*Math.PI,t.scaling.scaleInPlace(ld._Scale),i.position.x=-.9,t}static _CreateCameraFrustum(e,t){const i=new ur("rootCameraGizmo",e),s=new ur(i.name,e);s.parent=i;for(let i=0;i<4;i+=2)for(let r=0;r<4;r+=2){let n=Yl("lines",{points:[new S(-1+r,-1+i,-1),new S(-1+r,-1+i,1)],colors:[t,t]},e);n.parent=s,n.alwaysSelectAsActiveMesh=!0,n.isPickable=!1,n=Yl("lines",{points:[new S(-1,-1+r,-1+i),new S(1,-1+r,-1+i)],colors:[t,t]},e),n.parent=s,n.alwaysSelectAsActiveMesh=!0,n.isPickable=!1,n=Yl("lines",{points:[new S(-1+r,-1,-1+i),new S(-1+r,1,-1+i)],colors:[t,t]},e),n.parent=s,n.alwaysSelectAsActiveMesh=!0,n.isPickable=!1}return i}}ld._Scale=.05;nt.IncludesShadersStore.kernelBlurVaryingDeclaration="varying vec2 sampleCoord{X};";nt.IncludesShadersStore.packingFunctions="vec4 pack(float depth)\n{const vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\nfloat unpack(vec4 color)\n{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}";nt.IncludesShadersStore.kernelBlurFragment="#ifdef DOF\nfactor=sampleCoC(sampleCoord{X}); \ncomputedWeight=KERNEL_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;\n#endif\n";nt.IncludesShadersStore.kernelBlurFragment2="#ifdef DOF\nfactor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});computedWeight=KERNEL_DEP_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_DEP_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;\n#endif\n";nt.ShadersStore.kernelBlurPixelShader="uniform sampler2D textureSampler;uniform vec2 delta;varying vec2 sampleCenter;\n#ifdef DOF\nuniform sampler2D circleOfConfusionSampler;float sampleCoC(in vec2 offset) {float coc=texture2D(circleOfConfusionSampler,offset).r;return coc; }\n#endif\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#ifdef PACKEDFLOAT\n#include<packingFunctions>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float computedWeight=0.0;\n#ifdef PACKEDFLOAT\nfloat blend=0.;\n#else\nvec4 blend=vec4(0.);\n#endif\n#ifdef DOF\nfloat sumOfWeights=CENTER_WEIGHT; \nfloat factor=0.0;\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;\n#else\nblend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;\n#endif\n#endif\n#include<kernelBlurFragment>[0..varyingCount]\n#include<kernelBlurFragment2>[0..depCount]\n#ifdef PACKEDFLOAT\ngl_FragColor=pack(blend);\n#else\ngl_FragColor=blend;\n#endif\n#ifdef DOF\ngl_FragColor/=sumOfWeights;\n#endif\n}";nt.IncludesShadersStore.kernelBlurVertex="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";nt.ShadersStore.kernelBlurVertexShader="attribute vec2 position;uniform vec2 delta;varying vec2 sampleCenter;\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nsampleCenter=(position*madd+madd);\n#include<kernelBlurVertex>[0..varyingCount]\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";class hd extends dn{set kernel(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this._blockCompilation||this._updateParameters())}get kernel(){return this._idealKernel}set packedFloat(e){this._packedFloat!==e&&(this._packedFloat=e,this._blockCompilation||this._updateParameters())}get packedFloat(){return this._packedFloat}getClassName(){return"BlurPostProcess"}constructor(e,t,i,s,r,n=Ar.BILINEAR_SAMPLINGMODE,o,a,l=0,h="",c=!1,u=5){super(e,"kernelBlur",["delta","direction"],["circleOfConfusionSampler"],s,r,n,o,a,null,l,"kernelBlur",{varyingCount:0,depCount:0},!0,u),this._blockCompilation=c,this._packedFloat=!1,this._staticDefines="",this._staticDefines=h,this.direction=t,this.onApplyObservable.add((e=>{this._outputTexture?e.setFloat2("delta",1/this._outputTexture.width*this.direction.x,1/this._outputTexture.height*this.direction.y):e.setFloat2("delta",1/this.width*this.direction.x,1/this.height*this.direction.y)})),this.kernel=i}updateEffect(e=null,t=null,i=null,s,r,n){this._updateParameters(r,n)}_updateParameters(e,t){const i=this._kernel,s=(i-1)/2;let r=[],n=[],o=0;for(let e=0;e<i;e++){const t=e/(i-1),a=this._gaussianWeight(2*t-1);r[e]=e-s,n[e]=a,o+=a}for(let e=0;e<n.length;e++)n[e]/=o;const a=[],l=[],h=[];for(let e=0;e<=s;e+=2){const t=Math.min(e+1,Math.floor(s));if(e===t)h.push({o:r[e],w:n[e]});else{const i=t===s,o=n[e]+n[t]*(i?.5:1),a=r[e]+1/(1+n[e]/n[t]);0===a?(h.push({o:r[e],w:n[e]}),h.push({o:r[e+1],w:n[e+1]})):(h.push({o:a,w:o}),h.push({o:-a,w:o}))}}for(let e=0;e<h.length;e++)l[e]=h[e].o,a[e]=h[e].w;r=l,n=a;const c=this.getEngine().getCaps().maxVaryingVectors,u=Math.max(c,0)-1;let d=Math.min(r.length,u),p="";p+=this._staticDefines,-1!=this._staticDefines.indexOf("DOF")&&(p+=`#define CENTER_WEIGHT ${this._glslFloat(n[d-1])}\n`,d--);for(let e=0;e<d;e++)p+=`#define KERNEL_OFFSET${e} ${this._glslFloat(r[e])}\n`,p+=`#define KERNEL_WEIGHT${e} ${this._glslFloat(n[e])}\n`;let _=0;for(let e=u;e<r.length;e++)p+=`#define KERNEL_DEP_OFFSET${_} ${this._glslFloat(r[e])}\n`,p+=`#define KERNEL_DEP_WEIGHT${_} ${this._glslFloat(n[e])}\n`,_++;this.packedFloat&&(p+="#define PACKEDFLOAT 1"),this._blockCompilation=!1,super.updateEffect(p,null,null,{varyingCount:d,depCount:_},e,t)}_nearestBestKernel(e){const t=Math.round(e);for(const e of[t,t-1,t+1,t-2,t+2])if(e%2!=0&&Math.floor(e/2)%2==0&&e>0)return Math.max(e,3);return Math.max(t,3)}_gaussianWeight(e){const t=1/3,i=-e*e/(2*t*t);return 1/(Math.sqrt(2*Math.PI)*t)*Math.exp(i)}_glslFloat(e,t=8){return e.toFixed(t).replace(/0+$/,"")}static _Parse(e,t,i,s){return de.Parse((()=>new hd(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,void 0,!1)),e,i,s)}}me([ie("kernel")],hd.prototype,"_kernel",void 0),me([ie("packedFloat")],hd.prototype,"_packedFloat",void 0),me([oe()],hd.prototype,"direction",void 0),m("BABYLON.BlurPostProcess",hd);class cd extends Bn{set blurRatio(e){this._blurRatio!==e&&(this._blurRatio=e,this._preparePostProcesses())}get blurRatio(){return this._blurRatio}set adaptiveBlurKernel(e){this._adaptiveBlurKernel=e,this._autoComputeBlurKernel()}set blurKernel(e){this.blurKernelX=e,this.blurKernelY=e}set blurKernelX(e){this._blurKernelX!==e&&(this._blurKernelX=e,this._preparePostProcesses())}get blurKernelX(){return this._blurKernelX}set blurKernelY(e){this._blurKernelY!==e&&(this._blurKernelY=e,this._preparePostProcesses())}get blurKernelY(){return this._blurKernelY}_autoComputeBlurKernel(){const e=this.getScene().getEngine(),t=this.getRenderWidth()/e.getRenderWidth(),i=this.getRenderHeight()/e.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*t,this.blurKernelY=this._adaptiveBlurKernel*i}_onRatioRescale(){this._sizeRatio&&(this.resize(this._initialSizeParameter),this._adaptiveBlurKernel||this._preparePostProcesses()),this._adaptiveBlurKernel&&this._autoComputeBlurKernel()}_updateGammaSpace(){const e=this.getScene();e&&(this.gammaSpace=!e.imageProcessingConfiguration.isEnabled||!e.imageProcessingConfiguration.applyByPostProcess)}constructor(e,t,i,s,r=0,n=Ar.BILINEAR_SAMPLINGMODE,o=!0){if(super(e,t,i,s,!0,r,!1,n,o),this.mirrorPlane=new wi(0,1,0,1),this._transformMatrix=y.Zero(),this._mirrorMatrix=y.Zero(),this._adaptiveBlurKernel=0,this._blurKernelX=0,this._blurKernelY=0,this._blurRatio=1,!(i=this.getScene()))return this;this.ignoreCameraViewport=!0,this._updateGammaSpace(),this._imageProcessingConfigChangeObserver=i.imageProcessingConfiguration.onUpdateParameters.add((()=>{this._updateGammaSpace()}));const a=i.getEngine();let l;a.supportsUniformBuffers&&(this._sceneUBO=i.createSceneUniformBuffer(`Scene for Mirror Texture (name "${e}")`)),this.onBeforeBindObservable.add((()=>{var t;null===(t=a._debugPushGroup)||void 0===t||t.call(a,`mirror generation for ${e}`,1)})),this.onAfterUnbindObservable.add((()=>{var e;null===(e=a._debugPopGroup)||void 0===e||e.call(a,1)})),this.onBeforeRenderObservable.add((()=>{this._sceneUBO&&(this._currentSceneUBO=i.getSceneUniformBuffer(),i.setSceneUniformBuffer(this._sceneUBO),i.getSceneUniformBuffer().unbindEffect()),y.ReflectionToRef(this.mirrorPlane,this._mirrorMatrix),this._mirrorMatrix.multiplyToRef(i.getViewMatrix(),this._transformMatrix),i.setTransformMatrix(this._transformMatrix,i.getProjectionMatrix()),l=i.clipPlane,i.clipPlane=this.mirrorPlane,i._mirroredCameraPosition=S.TransformCoordinates(i.activeCamera.globalPosition,this._mirrorMatrix)})),this.onAfterRenderObservable.add((()=>{this._sceneUBO&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(),i._mirroredCameraPosition=null,i.clipPlane=l}))}_preparePostProcesses(){if(this.clearPostProcesses(!0),this._blurKernelX&&this._blurKernelY){const e=this.getScene().getEngine(),t=e.getCaps().textureFloatRender&&e.getCaps().textureFloatLinearFiltering?1:2;this._blurX=new hd("horizontal blur",new E(1,0),this._blurKernelX,this._blurRatio,null,Ar.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurX.autoClear=!1,1===this._blurRatio&&this.samples<2&&this._texture?this._blurX.inputTexture=this._renderTarget:this._blurX.alwaysForcePOT=!0,this._blurY=new hd("vertical blur",new E(0,1),this._blurKernelY,this._blurRatio,null,Ar.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurY.autoClear=!1,this._blurY.alwaysForcePOT=1!==this._blurRatio,this.addPostProcess(this._blurX),this.addPostProcess(this._blurY)}else this._blurY&&(this.removePostProcess(this._blurY),this._blurY.dispose(),this._blurY=null),this._blurX&&(this.removePostProcess(this._blurX),this._blurX.dispose(),this._blurX=null)}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new cd(this.name,t.width,e,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(i.renderList=this.renderList.slice(0)),i}serialize(){if(!this.name)return null;const e=super.serialize();return e.mirrorPlane=this.mirrorPlane.asArray(),e}dispose(){var e;super.dispose();const t=this.getScene();t&&t.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigChangeObserver),null===(e=this._sceneUBO)||void 0===e||e.dispose()}}Ar._CreateMirror=(e,t,i,s)=>new cd(e,t,i,s);class ud extends Cr{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(y.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,i){let s="";return e.forEach((e=>s+=e)),new ud(s,t,null,i,e)}static CreateFromPrefilteredData(e,t,i=null,s=!0){const r=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;const n=new ud(e,t,null,!1,null,null,null,void 0,!0,i,s);return t.useDelayedTextureLoading=r,n}constructor(e,t,i=null,s=!1,r=null,n=null,o=null,l=5,h=!1,c=null,u=!1,d=.8,p=0,_,f){var m;super(t),this._lodScale=.8,this._lodOffset=0,this.onLoadObservable=new a,this.boundingBoxPosition=S.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this._textureMatrixRefraction=new y,this.name=e,this.url=e,this._noMipmap=s,this.hasAlpha=!1,this._format=l,this.isCube=!0,this._textureMatrix=y.Identity(),this._createPolynomials=u,this.coordinatesMode=Ar.CUBIC_MODE,this._extensions=i,this._files=r,this._forcedExtension=c,this._loaderOptions=_,this._useSRGBBuffer=f,this._lodScale=d,this._lodOffset=p,(e||r)&&this.updateURL(e,c,n,h,o,i,null===(m=this.getScene())||void 0===m?void 0:m.useDelayedTextureLoading,r)}getClassName(){return"CubeTexture"}updateURL(e,t,i=null,s=!1,r=null,n=null,o=!1,a=null){this.name&&!this.name.startsWith("data:")||(this.name=e),this.url=e,t&&(this._forcedExtension=t);const l=e.lastIndexOf("."),h=t||(l>-1?e.substring(l).toLowerCase():""),c=0===h.indexOf(".dds"),u=0===h.indexOf(".env"),d=0===h.indexOf(".basis");if(u?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=s,s&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),a)this._files=a;else if(d||u||c||n||(n=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,n){for(let t=0;t<n.length;t++)this._files.push(e+n[t]);this._extensions=n}o?(this.delayLoadState=4,this._delayedOnLoad=i,this._delayedOnError=r):this._loadTexture(i,r)}delayLoad(e){4===this.delayLoadState&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){var t,i;if(e.updateFlag===this._textureMatrix.updateFlag)return;if(e.isIdentity()!==this._textureMatrix.isIdentity()&&(null===(t=this.getScene())||void 0===t||t.markAllMaterialsAsDirty(1,(e=>-1!==e.getActiveTextures().indexOf(this)))),this._textureMatrix=e,!(null===(i=this.getScene())||void 0===i?void 0:i.useRightHandedSystem))return;const s=R.Vector3[0],r=R.Quaternion[0],n=R.Vector3[1];this._textureMatrix.decompose(s,r,n),r.z*=-1,r.w*=-1,y.ComposeToRef(s,r,n,this._textureMatrixRefraction)}getRefractionTextureMatrix(){var e;return(null===(e=this.getScene())||void 0===e?void 0:e.useRightHandedSystem)?this._textureMatrixRefraction:this._textureMatrix}_loadTexture(e=null,t=null){var i;const s=this.getScene(),r=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);const n=()=>{var t;this.onLoadObservable.notifyObservers(this),r&&(r.dispose(),null===(t=this.getScene())||void 0===t||t.markAllMaterialsAsDirty(1)),e&&e()},o=(e,i)=>{this._loadingError=!0,this._errorObject={message:e,exception:i},t&&t(e,i),Ar.OnTextureLoadErrorObservable.notifyObservers(this)};this._texture?this._texture.isReady?Ht.SetImmediate((()=>n())):this._texture.onLoadedObservable.add((()=>n())):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,s,this._lodScale,this._lodOffset,e,o,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,s,this._files,this._noMipmap,e,o,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer),null===(i=this._texture)||void 0===i||i.onLoadedObservable.add((()=>this.onLoadObservable.notifyObservers(this))))}static Parse(e,t,i){const s=de.Parse((()=>{var s;let r=!1;return e.prefiltered&&(r=e.prefiltered),new ud(i+(null!==(s=e.url)&&void 0!==s?s:e.name),t,e.extensions,!1,e.files||null,null,null,void 0,r,e.forcedExtension)}),e,t);if(e.boundingBoxPosition&&(s.boundingBoxPosition=S.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(s.boundingBoxSize=S.FromArray(e.boundingBoxSize)),e.animations)for(let t=0;t<e.animations.length;t++){const i=e.animations[t],r=g("BABYLON.Animation");r&&s.animations.push(r.Parse(i))}return s}clone(){let e=0;const t=de.Clone((()=>{const t=new ud(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=t.uniqueId,t}),this);return t.uniqueId=e,t}}me([ie()],ud.prototype,"url",void 0),me([ae()],ud.prototype,"boundingBoxPosition",void 0),me([ae()],ud.prototype,"boundingBoxSize",null),me([ie("rotationY")],ud.prototype,"rotationY",null),me([ie("files")],ud.prototype,"_files",void 0),me([ie("forcedExtension")],ud.prototype,"_forcedExtension",void 0),me([ie("extensions")],ud.prototype,"_extensions",void 0),me([ue("textureMatrix")],ud.prototype,"_textureMatrix",void 0),me([ue("textureMatrixRefraction")],ud.prototype,"_textureMatrixRefraction",void 0),Ar._CubeTextureParser=ud.Parse,m("BABYLON.CubeTexture",ud);nt.IncludesShadersStore.backgroundFragmentDeclaration="uniform vec4 vEyePosition;uniform vec4 vPrimaryColor;\n#ifdef USEHIGHLIGHTANDSHADOWCOLORS\nuniform vec4 vPrimaryColorShadow;\n#endif\nuniform float shadowLevel;uniform float alpha;\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;\n#endif\n#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)\nuniform vec3 vBackgroundCenter;\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 vReflectionControl;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)\nuniform mat4 view;\n#endif\n#ifdef PROJECTED_GROUND\nuniform vec2 projectedGroundInfos;\n#endif\n";nt.IncludesShadersStore.backgroundUboDeclaration="layout(std140,column_major) uniform;uniform Material\n{uniform vec4 vPrimaryColor;uniform vec4 vPrimaryColorShadow;uniform vec2 vDiffuseInfos;uniform vec2 vReflectionInfos;uniform mat4 diffuseMatrix;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;uniform float pointSize;uniform float shadowLevel;uniform float alpha;uniform vec3 vBackgroundCenter;uniform vec4 vReflectionControl;uniform vec2 projectedGroundInfos;};\n#include<sceneUboDeclaration>\n";nt.ShadersStore.backgroundPixelShader="#ifdef TEXTURELODSUPPORT\n#extension GL_EXT_shader_texture_lod : enable\n#endif\nprecision highp float;\n#include<__decl__backgroundFragment>\n#include<helperFunctions>\nvarying vec3 vPositionW;\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif \n#ifdef MAINUV2 \nvarying vec2 vMainUV2; \n#endif \n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef DIFFUSE\n#if DIFFUSEDIRECTUV==1\n#define vDiffuseUV vMainUV1\n#elif DIFFUSEDIRECTUV==2\n#define vDiffuseUV vMainUV2\n#else\nvarying vec2 vDiffuseUV;\n#endif\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef TEXTURELODSUPPORT\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef TEXTURELODSUPPORT\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE;\n#endif\n#ifndef SHADOWONLY\n#define SHADOWONLY;\n#endif\n#include<imageProcessingDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<imageProcessingFunctions>\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#include<logDepthDeclaration>\n#include<clipPlaneFragmentDeclaration>\n#include<fogFragmentDeclaration>\n#ifdef REFLECTIONFRESNEL\n#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\nvec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}\n#endif\n#ifdef PROJECTED_GROUND\nfloat diskIntersectWithBackFaceCulling(vec3 ro,vec3 rd,vec3 c,float r) {float d=rd.y;if(d>0.0) { return 1e6; }\nvec3 o=ro-c;float t=-o.y/d;vec3 q=o+rd*t;return (dot(q,q)<r*r) ? t : 1e6;}\nfloat sphereIntersect(vec3 ro,vec3 rd,float ra) {float b=dot(ro,rd);float c=dot(ro,ro)-ra*ra;float h=b*b-c;if(h<0.0) { return -1.0; }\nh=sqrt(h);return-b+h;}\nvec3 project(vec3 viewDirectionW,vec3 eyePosition) {float radius=projectedGroundInfos.x;float height=projectedGroundInfos.y;vec3 camDir=-viewDirectionW;float skySphereDistance=sphereIntersect(eyePosition,camDir,radius);vec3 skySpherePositionW=eyePosition+camDir*skySphereDistance;vec3 p=normalize(skySpherePositionW);eyePosition.y-=height;float sIntersection=sphereIntersect(eyePosition,p,radius);vec3 h=vec3(0.0,-height,0.0);float dIntersection=diskIntersectWithBackFaceCulling(eyePosition,p,h,radius);p=(eyePosition+min(sIntersection,dIntersection)*p);return p;}\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=vec3(0.0,1.0,0.0);\n#endif\nfloat shadow=1.;float globalShadow=0.;float shadowLightCount=0.;float aggShadow=0.;float numLights=0.;\n#include<lightFragment>[0..maxSimultaneousLights]\n#ifdef SHADOWINUSE\nglobalShadow/=shadowLightCount;\n#else\nglobalShadow=1.0;\n#endif\n#ifndef BACKMAT_SHADOWONLY\nvec4 reflectionColor=vec4(1.,1.,1.,1.);\n#ifdef REFLECTION\n#ifdef PROJECTED_GROUND\nvec3 reflectionVector=project(viewDirectionW,vEyePosition.xyz);reflectionVector=vec3(reflectionMatrix*vec4(reflectionVector,1.));\n#else\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=reflectionVector;\n#else\nvec2 reflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n#ifdef REFLECTIONBLUR\nfloat reflectionLOD=vReflectionInfos.y;\n#ifdef TEXTURELODSUPPORT\nreflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;reflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);\n#else\nfloat lodReflectionNormalized=saturate(reflectionLOD);float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords);if(lodReflectionNormalizedDoubled<1.0){reflectionColor=mix(\nsampleReflection(reflectionSamplerHigh,reflectionCoords),\nreflectionSpecularMid,\nlodReflectionNormalizedDoubled\n);} else {reflectionColor=mix(\nreflectionSpecularMid,\nsampleReflection(reflectionSamplerLow,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);}\n#endif\n#else\nvec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);reflectionColor=reflectionSample;\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor.rgb=fromRGBD(reflectionColor);\n#endif\n#ifdef GAMMAREFLECTION\nreflectionColor.rgb=toLinearSpace(reflectionColor.rgb);\n#endif\n#ifdef REFLECTIONBGR\nreflectionColor.rgb=reflectionColor.bgr;\n#endif\nreflectionColor.rgb*=vReflectionInfos.x;\n#endif\nvec3 diffuseColor=vec3(1.,1.,1.);float finalAlpha=alpha;\n#ifdef DIFFUSE\nvec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);\n#ifdef GAMMADIFFUSE\ndiffuseMap.rgb=toLinearSpace(diffuseMap.rgb);\n#endif\ndiffuseMap.rgb*=vDiffuseInfos.y;\n#ifdef DIFFUSEHASALPHA\nfinalAlpha*=diffuseMap.a;\n#endif\ndiffuseColor=diffuseMap.rgb;\n#endif\n#ifdef REFLECTIONFRESNEL\nvec3 colorBase=diffuseColor;\n#else\nvec3 colorBase=reflectionColor.rgb*diffuseColor;\n#endif\ncolorBase=max(colorBase,0.0);\n#ifdef USERGBCOLOR\nvec3 finalColor=colorBase;\n#else\n#ifdef USEHIGHLIGHTANDSHADOWCOLORS\nvec3 mainColor=mix(vPrimaryColorShadow.rgb,vPrimaryColor.rgb,colorBase);\n#else\nvec3 mainColor=vPrimaryColor.rgb;\n#endif\nvec3 finalColor=colorBase*mainColor;\n#endif\n#ifdef REFLECTIONFRESNEL\nvec3 reflectionAmount=vReflectionControl.xxx;vec3 reflectionReflectance0=vReflectionControl.yyy;vec3 reflectionReflectance90=vReflectionControl.zzz;float VdotN=dot(normalize(vEyePosition.xyz),normalW);vec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);reflectionAmount*=planarReflectionFresnel;\n#ifdef REFLECTIONFALLOFF\nfloat reflectionDistanceFalloff=1.0-saturate(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w);reflectionDistanceFalloff*=reflectionDistanceFalloff;reflectionAmount*=reflectionDistanceFalloff;\n#endif\nfinalColor=mix(finalColor,reflectionColor.rgb,saturate(reflectionAmount));\n#endif\n#ifdef OPACITYFRESNEL\nfloat viewAngleToFloor=dot(normalW,normalize(vEyePosition.xyz-vBackgroundCenter));const float startAngle=0.1;float fadeFactor=saturate(viewAngleToFloor/startAngle);finalAlpha*=fadeFactor*fadeFactor;\n#endif\n#ifdef SHADOWINUSE\nfinalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);\n#endif\nvec4 color=vec4(finalColor,finalAlpha);\n#else\nvec4 color=vec4(vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*alpha);\n#endif\n#include<logDepthFragment>\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\n#if !defined(SKIPFINALCOLORCLAMP)\ncolor.rgb=clamp(color.rgb,0.,30.0);\n#endif\n#else\ncolor=applyImageProcessing(color);\n#endif\n#ifdef PREMULTIPLYALPHA\ncolor.rgb*=color.a;\n#endif\n#ifdef NOISE\ncolor.rgb+=dither(vPositionW.xy,0.5);color=max(color,0.0);\n#endif\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";nt.IncludesShadersStore.backgroundVertexDeclaration="uniform mat4 view;uniform mat4 viewProjection;uniform float shadowLevel;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n";nt.ShadersStore.backgroundVertexShader="precision highp float;\n#include<__decl__backgroundVertex>\n#include<helperFunctions>\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0\nvarying vec2 vDiffuseUV;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=position;\n#endif\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*finalWorld*vec4(position,1.0);} else {gl_Position=viewProjectionR*finalWorld*vec4(position,1.0);}\n#else\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#endif\nvec4 worldPos=finalWorld*vec4(position,1.0);vPositionW=vec3(worldPos);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normal);\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));\n#ifdef EQUIRECTANGULAR_RELFECTION_FOV\nmat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));vec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));if (fFovMultiplier<=1.0) {vDirectionW=normalize(segment);} else {vDirectionW=normalize(vDirectionW+(vDirectionW-segment));}\n#endif\n#endif\n#ifndef UV1\nvec2 uv=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uv;\n#endif\n#ifdef MAINUV2\nvMainUV2=uv2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0\nif (vDiffuseInfos.x==0.)\n{vDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));}\nelse\n{vDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));}\n#endif\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#ifdef VERTEXCOLOR\nvColor=color;\n#endif\n#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n";class dd extends $t{constructor(){super(),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.GAMMADIFFUSE=!1,this.DIFFUSEHASALPHA=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONBLUR=!1,this.REFLECTIONFRESNEL=!1,this.REFLECTIONFALLOFF=!1,this.TEXTURELODSUPPORT=!1,this.PREMULTIPLYALPHA=!1,this.USERGBCOLOR=!1,this.USEHIGHLIGHTANDSHADOWCOLORS=!1,this.BACKMAT_SHADOWONLY=!1,this.NOISE=!1,this.REFLECTIONBGR=!1,this.PROJECTED_GROUND=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.EQUIRECTANGULAR_RELFECTION_FOV=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.UV1=!1,this.UV2=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.SHADOWFLOAT=!1,this.LOGARITHMICDEPTH=!1,this.NONUNIFORMSCALING=!1,this.ALPHATEST=!1,this.rebuild()}}class pd extends Xr{get _perceptualColor(){return this.__perceptualColor}set _perceptualColor(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()}get primaryColorShadowLevel(){return this._primaryColorShadowLevel}set primaryColorShadowLevel(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}get primaryColorHighlightLevel(){return this._primaryColorHighlightLevel}set primaryColorHighlightLevel(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}set reflectionStandardFresnelWeight(e){let t=e;t<.5?(t*=2,this.reflectionReflectance0=pd.StandardReflectance0*t,this.reflectionReflectance90=pd.StandardReflectance90*t):(t=2*t-1,this.reflectionReflectance0=pd.StandardReflectance0+(1-pd.StandardReflectance0)*t,this.reflectionReflectance90=pd.StandardReflectance90+(1-pd.StandardReflectance90)*t)}get fovMultiplier(){return this._fovMultiplier}set fovMultiplier(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e))}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsImageProcessingDirty()}))))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this.imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this.imageProcessingConfiguration.colorCurves=e}constructor(e,t){super(e,t),this.primaryColor=N.White(),this._primaryColorShadowLevel=0,this._primaryColorHighlightLevel=0,this.reflectionTexture=null,this.reflectionBlur=0,this.diffuseTexture=null,this._shadowLights=null,this.shadowLights=null,this.shadowLevel=0,this.sceneCenter=S.Zero(),this.opacityFresnel=!0,this.reflectionFresnel=!1,this.reflectionFalloffDistance=0,this.reflectionAmount=1,this.reflectionReflectance0=.05,this.reflectionReflectance90=.5,this.useRGBColor=!0,this.enableNoise=!1,this._fovMultiplier=1,this.useEquirectangularFOV=!1,this._maxSimultaneousLights=4,this.maxSimultaneousLights=4,this._shadowOnly=!1,this.shadowOnly=!1,this._imageProcessingObserver=null,this.switchToBGR=!1,this._enableGroundProjection=!1,this.enableGroundProjection=!1,this.projectedGroundRadius=1e3,this.projectedGroundHeight=10,this._renderTargets=new Yt(16),this._reflectionControls=b.Zero(),this._white=N.White(),this._primaryShadowColor=N.Black(),this._primaryHighlightColor=N.Black(),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._renderTargets.push(this._diffuseTexture),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._renderTargets)}get hasRenderTargetTextures(){return!(!this._diffuseTexture||!this._diffuseTexture.isRenderTarget)||!(!this._reflectionTexture||!this._reflectionTexture.isRenderTarget)}needAlphaTesting(){return!0}needAlphaBlending(){return this.alpha<1||null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha||this._shadowOnly}isReadyForSubMesh(e,t,i=!1){if(t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new dd);const s=this.getScene(),r=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const n=s.getEngine();if(Hs.PrepareDefinesForLights(s,e,r,!1,this._maxSimultaneousLights),r._needNormals=!0,Hs.PrepareDefinesForMultiview(s,r),r._areTexturesDirty){if(r._needUVs=!1,s.texturesEnabled){if(s.getEngine().getCaps().textureLOD&&(r.TEXTURELODSUPPORT=!0),this._diffuseTexture&&Ia.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;Hs.PrepareDefinesForMergedUV(this._diffuseTexture,r,"DIFFUSE"),r.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,r.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,r.OPACITYFRESNEL=this._opacityFresnel}else r.DIFFUSE=!1,r.DIFFUSEDIRECTUV=0,r.DIFFUSEHASALPHA=!1,r.GAMMADIFFUSE=!1,r.OPACITYFRESNEL=!1;const e=this._reflectionTexture;if(e&&Ia.ReflectionTextureEnabled){if(!e.isReadyOrNotBlocking())return!1;switch(r.REFLECTION=!0,r.GAMMAREFLECTION=e.gammaSpace,r.RGBDREFLECTION=e.isRGBD,r.REFLECTIONBLUR=this._reflectionBlur>0,r.LODINREFLECTIONALPHA=e.lodLevelInAlpha,r.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,r.REFLECTIONBGR=this.switchToBGR,e.coordinatesMode===Ar.INVCUBIC_MODE&&(r.INVERTCUBICMAP=!0),r.REFLECTIONMAP_3D=e.isCube,r.REFLECTIONMAP_OPPOSITEZ=r.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!e.invertZ:e.invertZ,e.coordinatesMode){case Ar.EXPLICIT_MODE:r.REFLECTIONMAP_EXPLICIT=!0;break;case Ar.PLANAR_MODE:r.REFLECTIONMAP_PLANAR=!0;break;case Ar.PROJECTION_MODE:r.REFLECTIONMAP_PROJECTION=!0;break;case Ar.SKYBOX_MODE:r.REFLECTIONMAP_SKYBOX=!0;break;case Ar.SPHERICAL_MODE:r.REFLECTIONMAP_SPHERICAL=!0;break;case Ar.EQUIRECTANGULAR_MODE:r.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case Ar.FIXED_EQUIRECTANGULAR_MODE:r.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case Ar.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:r.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case Ar.CUBIC_MODE:case Ar.INVCUBIC_MODE:default:r.REFLECTIONMAP_CUBIC=!0}this.reflectionFresnel?(r.REFLECTIONFRESNEL=!0,r.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(r.REFLECTIONFRESNEL=!1,r.REFLECTIONFALLOFF=!1)}else r.REFLECTION=!1,r.REFLECTIONFRESNEL=!1,r.REFLECTIONFALLOFF=!1,r.REFLECTIONBLUR=!1,r.REFLECTIONMAP_3D=!1,r.REFLECTIONMAP_SPHERICAL=!1,r.REFLECTIONMAP_PLANAR=!1,r.REFLECTIONMAP_CUBIC=!1,r.REFLECTIONMAP_PROJECTION=!1,r.REFLECTIONMAP_SKYBOX=!1,r.REFLECTIONMAP_EXPLICIT=!1,r.REFLECTIONMAP_EQUIRECTANGULAR=!1,r.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,r.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,r.INVERTCUBICMAP=!1,r.REFLECTIONMAP_OPPOSITEZ=!1,r.LODINREFLECTIONALPHA=!1,r.GAMMAREFLECTION=!1,r.RGBDREFLECTION=!1}r.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,r.USERGBCOLOR=this._useRGBColor,r.NOISE=this._enableNoise}if(r._areLightsDirty&&(r.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(0!==this._primaryColorShadowLevel||0!==this._primaryColorHighlightLevel),r.BACKMAT_SHADOWONLY=this._shadowOnly),r._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(r)}if(r._areMiscDirty&&(r.REFLECTIONMAP_3D&&this._enableGroundProjection?(r.PROJECTED_GROUND=!0,r.REFLECTIONMAP_SKYBOX=!0):r.PROJECTED_GROUND=!1),Hs.PrepareDefinesForMisc(e,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e),r),Hs.PrepareDefinesForFrameBoundValues(s,n,this,r,i,null,t.getRenderingMesh().hasThinInstances),Hs.PrepareDefinesForAttributes(e,r,!1,!0,!1)&&e&&(s.getEngine().getCaps().standardDerivatives||e.isVerticesDataPresent(hi.NormalKind)||(e.createNormals(!0),k.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name))),r.isDirty){r.markAsProcessed(),s.resetCachedMaterial();const i=new hn;r.FOG&&i.addFallback(0,"FOG"),r.POINTSIZE&&i.addFallback(1,"POINTSIZE"),r.MULTIVIEW&&i.addFallback(0,"MULTIVIEW"),Hs.HandleFallbacksForShadows(r,i,this._maxSimultaneousLights);const o=[hi.PositionKind];r.NORMAL&&o.push(hi.NormalKind),r.UV1&&o.push(hi.UVKind),r.UV2&&o.push(hi.UV2Kind),Hs.PrepareAttributesForBones(o,e,r,i),Hs.PrepareAttributesForInstances(o,r);const a=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","mBones","vPrimaryColor","vPrimaryColorShadow","vReflectionInfos","reflectionMatrix","vReflectionMicrosurfaceInfos","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix","projectedGroundInfos","logarithmicDepthConstant"];ks(a);const l=["diffuseSampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh"],h=["Material","Scene"];Zt&&(Zt.PrepareUniforms(a,r),Zt.PrepareSamplers(l,r)),Hs.PrepareUniformsAndSamplersList({uniformsNames:a,uniformBuffersNames:h,samplers:l,defines:r,maxSimultaneousLights:this._maxSimultaneousLights});const c=r.toString(),u=s.getEngine().createEffect("background",{attributes:o,uniformsNames:a,uniformBuffersNames:h,samplers:l,defines:c,fallbacks:i,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights}},n);t.setEffect(u,r,this._materialContext),this.buildUniformLayout()}return!(!t.effect||!t.effect.isReady()||(r._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),0))}_computePrimaryColorFromPerceptualColor(){this.__perceptualColor&&(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor,this.getScene().getEngine().useExactSrgbConversions),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())}_computePrimaryColors(){0===this._primaryColorShadowLevel&&0===this._primaryColorHighlightLevel||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))}buildUniformLayout(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("vReflectionInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("reflectionMatrix",16),this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.addUniform("projectedGroundInfos",2),this._uniformBuffer.create()}unbind(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),super.unbind()}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindForSubMesh(e,t,i){const s=this.getScene(),r=i.materialDefines;if(!r)return;const n=i.effect;if(!n)return;this._activeEffect=n,this.bindOnlyWorldMatrix(e),Hs.BindBonesParameters(t,this._activeEffect);const o=this._mustRebind(s,n,t.visibility);if(o){this._uniformBuffer.bindToEffect(n,"Material"),this.bindViewProjection(n);const e=this._reflectionTexture;this._uniformBuffer.useUbo&&this.isFrozen&&this._uniformBuffer.isSync||(s.texturesEnabled&&(this._diffuseTexture&&Ia.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),Hs.BindTextureMatrix(this._diffuseTexture,this._uniformBuffer,"diffuse")),e&&Ia.ReflectionTextureEnabled&&(this._uniformBuffer.updateMatrix("reflectionMatrix",e.getReflectionTextureMatrix()),this._uniformBuffer.updateFloat2("vReflectionInfos",e.level,this._reflectionBlur),this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",e.getSize().width,e.lodGenerationScale,e.lodGenerationOffset))),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),r.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),s.texturesEnabled&&(this._diffuseTexture&&Ia.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),e&&Ia.ReflectionTextureEnabled&&(r.REFLECTIONBLUR&&r.TEXTURELODSUPPORT?this._uniformBuffer.setTexture("reflectionSampler",e):r.REFLECTIONBLUR?(this._uniformBuffer.setTexture("reflectionSampler",e._lodTextureMid||e),this._uniformBuffer.setTexture("reflectionSamplerLow",e._lodTextureLow||e),this._uniformBuffer.setTexture("reflectionSamplerHigh",e._lodTextureHigh||e)):this._uniformBuffer.setTexture("reflectionSampler",e),r.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w))),r.PROJECTED_GROUND&&this._uniformBuffer.updateFloat2("projectedGroundInfos",this.projectedGroundRadius,this.projectedGroundHeight)),zs(this._activeEffect,this,s),s.bindEyePosition(n)}else s.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._uniformBuffer.bindToEffect(n,"Material"),this._needToBindSceneUbo=!0);!o&&this.isFrozen||(s.lightsEnabled&&Hs.BindLights(s,t,this._activeEffect,r,this._maxSimultaneousLights),this.bindView(n),Hs.BindFogParameters(s,t,this._activeEffect,!0),this._useLogarithmicDepth&&Hs.BindLogDepth(r,n,s),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect),this._uniformBuffer.update()}hasTexture(e){return!!super.hasTexture(e)||this._reflectionTexture===e||this._diffuseTexture===e}dispose(e=!1,t=!1){t&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e)}clone(e){return de.Clone((()=>new pd(e,this.getScene())),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.BackgroundMaterial",e}getClassName(){return"BackgroundMaterial"}static Parse(e,t,i){return de.Parse((()=>new pd(e.name,t)),e,t,i)}}pd.StandardReflectance0=.05,pd.StandardReflectance90=.5,me([re()],pd.prototype,"_primaryColor",void 0),me([te("_markAllSubMeshesAsLightsDirty")],pd.prototype,"primaryColor",void 0),me([re()],pd.prototype,"__perceptualColor",void 0),me([ie()],pd.prototype,"_primaryColorShadowLevel",void 0),me([ie()],pd.prototype,"_primaryColorHighlightLevel",void 0),me([te("_markAllSubMeshesAsLightsDirty")],pd.prototype,"primaryColorHighlightLevel",null),me([se()],pd.prototype,"_reflectionTexture",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],pd.prototype,"reflectionTexture",void 0),me([ie()],pd.prototype,"_reflectionBlur",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],pd.prototype,"reflectionBlur",void 0),me([se()],pd.prototype,"_diffuseTexture",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],pd.prototype,"diffuseTexture",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],pd.prototype,"shadowLights",void 0),me([ie()],pd.prototype,"_shadowLevel",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],pd.prototype,"shadowLevel",void 0),me([ae()],pd.prototype,"_sceneCenter",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],pd.prototype,"sceneCenter",void 0),me([ie()],pd.prototype,"_opacityFresnel",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],pd.prototype,"opacityFresnel",void 0),me([ie()],pd.prototype,"_reflectionFresnel",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],pd.prototype,"reflectionFresnel",void 0),me([ie()],pd.prototype,"_reflectionFalloffDistance",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],pd.prototype,"reflectionFalloffDistance",void 0),me([ie()],pd.prototype,"_reflectionAmount",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],pd.prototype,"reflectionAmount",void 0),me([ie()],pd.prototype,"_reflectionReflectance0",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],pd.prototype,"reflectionReflectance0",void 0),me([ie()],pd.prototype,"_reflectionReflectance90",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],pd.prototype,"reflectionReflectance90",void 0),me([ie()],pd.prototype,"_useRGBColor",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],pd.prototype,"useRGBColor",void 0),me([ie()],pd.prototype,"_enableNoise",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],pd.prototype,"enableNoise",void 0),me([ie()],pd.prototype,"_maxSimultaneousLights",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],pd.prototype,"maxSimultaneousLights",void 0),me([ie()],pd.prototype,"_shadowOnly",void 0),me([te("_markAllSubMeshesAsLightsDirty")],pd.prototype,"shadowOnly",void 0),me([ce()],pd.prototype,"_imageProcessingConfiguration",void 0),me([ie(),te("_markAllSubMeshesAsMiscDirty")],pd.prototype,"enableGroundProjection",void 0),me([ie()],pd.prototype,"projectedGroundRadius",void 0),me([ie()],pd.prototype,"projectedGroundHeight",void 0),m("BABYLON.BackgroundMaterial",pd);class _d{static _GetDefaultOptions(e){return{createGround:!0,groundSize:15,groundTexture:this._GroundTextureCDNUrl,groundColor:new N(.2,.2,.3).toLinearSpace(e.getEngine().useExactSrgbConversions).scale(3),groundOpacity:.9,enableGroundShadow:!0,groundShadowLevel:.5,enableGroundMirror:!1,groundMirrorSizeRatio:.3,groundMirrorBlurKernel:64,groundMirrorAmount:1,groundMirrorFresnelWeight:1,groundMirrorFallOffDistance:0,groundMirrorTextureType:0,groundYBias:1e-5,createSkybox:!0,skyboxSize:20,skyboxTexture:this._SkyboxTextureCDNUrl,skyboxColor:new N(.2,.2,.3).toLinearSpace(e.getEngine().useExactSrgbConversions).scale(3),backgroundYRotation:0,sizeAuto:!0,rootPosition:S.Zero(),setupImageProcessing:!0,environmentTexture:this._EnvironmentTextureCDNUrl,cameraExposure:.8,cameraContrast:1.2,toneMappingEnabled:!0}}get rootMesh(){return this._rootMesh}get skybox(){return this._skybox}get skyboxTexture(){return this._skyboxTexture}get skyboxMaterial(){return this._skyboxMaterial}get ground(){return this._ground}get groundTexture(){return this._groundTexture}get groundMirror(){return this._groundMirror}get groundMirrorRenderList(){return this._groundMirror?this._groundMirror.renderList:null}get groundMaterial(){return this._groundMaterial}constructor(e,t){this._errorHandler=(e,t)=>{this.onErrorObservable.notifyObservers({message:e,exception:t})},this._options=Object.assign(Object.assign({},_d._GetDefaultOptions(t)),e),this._scene=t,this.onErrorObservable=new a,this._setupBackground(),this._setupImageProcessing()}updateOptions(e){const t=Object.assign(Object.assign({},this._options),e);this._ground&&!t.createGround&&(this._ground.dispose(),this._ground=null),this._groundMaterial&&!t.createGround&&(this._groundMaterial.dispose(),this._groundMaterial=null),this._groundTexture&&this._options.groundTexture!=t.groundTexture&&(this._groundTexture.dispose(),this._groundTexture=null),this._skybox&&!t.createSkybox&&(this._skybox.dispose(),this._skybox=null),this._skyboxMaterial&&!t.createSkybox&&(this._skyboxMaterial.dispose(),this._skyboxMaterial=null),this._skyboxTexture&&this._options.skyboxTexture!=t.skyboxTexture&&(this._skyboxTexture.dispose(),this._skyboxTexture=null),this._groundMirror&&!t.enableGroundMirror&&(this._groundMirror.dispose(),this._groundMirror=null),this._scene.environmentTexture&&this._options.environmentTexture!=t.environmentTexture&&this._scene.environmentTexture.dispose(),this._options=t,this._setupBackground(),this._setupImageProcessing()}setMainColor(e){this.groundMaterial&&(this.groundMaterial.primaryColor=e),this.skyboxMaterial&&(this.skyboxMaterial.primaryColor=e),this.groundMirror&&(this.groundMirror.clearColor=new F(e.r,e.g,e.b,1))}_setupImageProcessing(){this._options.setupImageProcessing&&(this._scene.imageProcessingConfiguration.contrast=this._options.cameraContrast,this._scene.imageProcessingConfiguration.exposure=this._options.cameraExposure,this._scene.imageProcessingConfiguration.toneMappingEnabled=this._options.toneMappingEnabled,this._setupEnvironmentTexture())}_setupEnvironmentTexture(){if(this._scene.environmentTexture)return;if(this._options.environmentTexture instanceof Cr)return void(this._scene.environmentTexture=this._options.environmentTexture);const e=ud.CreateFromPrefilteredData(this._options.environmentTexture,this._scene);this._scene.environmentTexture=e}_setupBackground(){this._rootMesh||(this._rootMesh=new ur("BackgroundHelper",this._scene)),this._rootMesh.rotation.y=this._options.backgroundYRotation;const e=this._getSceneSize();this._options.createGround&&(this._setupGround(e),this._setupGroundMaterial(),this._setupGroundDiffuseTexture(),this._options.enableGroundMirror&&this._setupGroundMirrorTexture(e),this._setupMirrorInGroundMaterial()),this._options.createSkybox&&(this._setupSkybox(e),this._setupSkyboxMaterial(),this._setupSkyboxReflectionTexture()),this._rootMesh.position.x=e.rootPosition.x,this._rootMesh.position.z=e.rootPosition.z,this._rootMesh.position.y=e.rootPosition.y}_getSceneSize(){let e=this._options.groundSize,t=this._options.skyboxSize,i=this._options.rootPosition;if(!this._scene.meshes||1===this._scene.meshes.length)return{groundSize:e,skyboxSize:t,rootPosition:i};const s=this._scene.getWorldExtends((e=>e!==this._ground&&e!==this._rootMesh&&e!==this._skybox)),r=s.max.subtract(s.min);if(this._options.sizeAuto){this._scene.activeCamera instanceof Ho&&this._scene.activeCamera.upperRadiusLimit&&(e=2*this._scene.activeCamera.upperRadiusLimit,t=e);const n=r.length();n>e&&(e=2*n,t=e),e*=1.1,t*=1.5,i=s.min.add(r.scale(.5)),i.y=s.min.y-this._options.groundYBias}return{groundSize:e,skyboxSize:t,rootPosition:i}}_setupGround(e){this._ground&&!this._ground.isDisposed()||(this._ground=Br("BackgroundPlane",{size:e.groundSize},this._scene),this._ground.rotation.x=Math.PI/2,this._ground.parent=this._rootMesh,this._ground.onDisposeObservable.add((()=>{this._ground=null}))),this._ground.receiveShadows=this._options.enableGroundShadow}_setupGroundMaterial(){this._groundMaterial||(this._groundMaterial=new pd("BackgroundPlaneMaterial",this._scene)),this._groundMaterial.alpha=this._options.groundOpacity,this._groundMaterial.alphaMode=8,this._groundMaterial.shadowLevel=this._options.groundShadowLevel,this._groundMaterial.primaryColor=this._options.groundColor,this._groundMaterial.useRGBColor=!1,this._groundMaterial.enableNoise=!0,this._ground&&(this._ground.material=this._groundMaterial)}_setupGroundDiffuseTexture(){this._groundMaterial&&(this._groundTexture||(this._options.groundTexture instanceof Cr?this._groundMaterial.diffuseTexture=this._options.groundTexture:(this._groundTexture=new Ar(this._options.groundTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._groundTexture.gammaSpace=!1,this._groundTexture.hasAlpha=!0,this._groundMaterial.diffuseTexture=this._groundTexture)))}_setupGroundMirrorTexture(e){const t=Ar.CLAMP_ADDRESSMODE;if(!this._groundMirror&&(this._groundMirror=new cd("BackgroundPlaneMirrorTexture",{ratio:this._options.groundMirrorSizeRatio},this._scene,!1,this._options.groundMirrorTextureType,Ar.BILINEAR_SAMPLINGMODE,!0),this._groundMirror.mirrorPlane=new wi(0,-1,0,e.rootPosition.y),this._groundMirror.anisotropicFilteringLevel=1,this._groundMirror.wrapU=t,this._groundMirror.wrapV=t,this._groundMirror.renderList))for(let e=0;e<this._scene.meshes.length;e++){const t=this._scene.meshes[e];t!==this._ground&&t!==this._skybox&&t!==this._rootMesh&&this._groundMirror.renderList.push(t)}const i=this._options.groundColor.toGammaSpace(this._scene.getEngine().useExactSrgbConversions);this._groundMirror.clearColor=new F(i.r,i.g,i.b,1),this._groundMirror.adaptiveBlurKernel=this._options.groundMirrorBlurKernel}_setupMirrorInGroundMaterial(){this._groundMaterial&&(this._groundMaterial.reflectionTexture=this._groundMirror,this._groundMaterial.reflectionFresnel=!0,this._groundMaterial.reflectionAmount=this._options.groundMirrorAmount,this._groundMaterial.reflectionStandardFresnelWeight=this._options.groundMirrorFresnelWeight,this._groundMaterial.reflectionFalloffDistance=this._options.groundMirrorFallOffDistance)}_setupSkybox(e){this._skybox&&!this._skybox.isDisposed()||(this._skybox=Pl("BackgroundSkybox",{size:e.skyboxSize,sideOrientation:ur.BACKSIDE},this._scene),this._skybox.onDisposeObservable.add((()=>{this._skybox=null}))),this._skybox.parent=this._rootMesh}_setupSkyboxMaterial(){this._skybox&&(this._skyboxMaterial||(this._skyboxMaterial=new pd("BackgroundSkyboxMaterial",this._scene)),this._skyboxMaterial.useRGBColor=!1,this._skyboxMaterial.primaryColor=this._options.skyboxColor,this._skyboxMaterial.enableNoise=!0,this._skybox.material=this._skyboxMaterial)}_setupSkyboxReflectionTexture(){this._skyboxMaterial&&(this._skyboxTexture||(this._options.skyboxTexture instanceof Cr?this._skyboxMaterial.reflectionTexture=this._options.skyboxTexture:(this._skyboxTexture=new ud(this._options.skyboxTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._skyboxTexture.coordinatesMode=Ar.SKYBOX_MODE,this._skyboxTexture.gammaSpace=!1,this._skyboxMaterial.reflectionTexture=this._skyboxTexture)))}dispose(){this._groundMaterial&&this._groundMaterial.dispose(!0,!0),this._skyboxMaterial&&this._skyboxMaterial.dispose(!0,!0),this._rootMesh.dispose(!1)}}_d._GroundTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundGround.png",_d._SkyboxTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundSkybox.dds",_d._EnvironmentTextureCDNUrl="https://assets.babylonjs.com/environments/environmentSpecular.env";class fd extends ws{get texture(){return this._texture}set texture(e){this._texture!==e&&(this._texture=e,this._useDirectMapping?(this._texture.wrapU=Ar.CLAMP_ADDRESSMODE,this._texture.wrapV=Ar.CLAMP_ADDRESSMODE,this._material.diffuseTexture=this._texture):(this._texture.coordinatesMode=Ar.FIXED_EQUIRECTANGULAR_MIRRORED_MODE,this._texture.wrapV=Ar.CLAMP_ADDRESSMODE,this._material.reflectionTexture=this._texture),this._changeTextureMode(this._textureMode))}get mesh(){return this._mesh}get fovMultiplier(){return this._material.fovMultiplier}set fovMultiplier(e){this._material.fovMultiplier=e}get textureMode(){return this._textureMode}set textureMode(e){this._textureMode!==e&&this._changeTextureMode(e)}get halfDome(){return this._halfDome}set halfDome(e){this._halfDome=e,this._halfDomeMask.setEnabled(e),this._changeTextureMode(this._textureMode)}set crossEye(e){this._crossEye=e,this._changeTextureMode(this._textureMode)}get crossEye(){return this._crossEye}get material(){return this._material}constructor(e,t,i,s,r=null){super(e,s),this.onError=r,this._halfDome=!1,this._crossEye=!1,this._useDirectMapping=!1,this._textureMode=fd.MODE_MONOSCOPIC,this._onBeforeCameraRenderObserver=null,this.onLoadErrorObservable=new a,this.onLoadObservable=new a,s=this.getScene(),e=e||"textureDome",i.resolution=0|Math.abs(i.resolution)||32,i.clickToPlay=Boolean(i.clickToPlay),i.autoPlay=void 0===i.autoPlay||Boolean(i.autoPlay),i.loop=void 0===i.loop||Boolean(i.loop),i.size=Math.abs(i.size)||(s.activeCamera?.48*s.activeCamera.maxZ:1e3),void 0===i.useDirectMapping?this._useDirectMapping=!0:this._useDirectMapping=i.useDirectMapping,void 0===i.faceForward&&(i.faceForward=!0),this._setReady(!1),i.mesh?this._mesh=i.mesh:this._mesh=Ol(e+"_mesh",{segments:i.resolution,diameter:i.size,updatable:!1,sideOrientation:ur.BACKSIDE},s);const n=this._material=new pd(e+"_material",s);n.useEquirectangularFOV=!0,n.fovMultiplier=1,n.opacityFresnel=!1;const o=this._initTexture(t,s,i);if(this.texture=o,this._mesh.material=n,this._mesh.parent=this,this._halfDomeMask=Ol("",{slice:.5,diameter:.98*i.size,segments:2*i.resolution,sideOrientation:ur.BACKSIDE},s),this._halfDomeMask.rotate(ji.X,-Math.PI/2),this._halfDomeMask.parent=this._mesh,this._halfDome=!!i.halfDomeMode,this._halfDomeMask.setEnabled(this._halfDome),this._crossEye=!!i.crossEyeMode,this._texture.anisotropicFilteringLevel=1,this._texture.onLoadObservable.addOnce((()=>{this._setReady(!0)})),i.faceForward&&s.activeCamera){const e=s.activeCamera,t=S.Forward(),i=S.TransformNormal(t,e.getViewMatrix());i.normalize(),this.rotation.y=Math.acos(S.Dot(t,i))}this._changeTextureMode(this._textureMode)}_changeTextureMode(e){switch(this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._textureMode=e,this._texture.uScale=1,this._texture.vScale=1,this._texture.uOffset=0,this._texture.vOffset=0,this._texture.vAng=0,e){case fd.MODE_MONOSCOPIC:this._halfDome&&(this._texture.uScale=2,this._texture.uOffset=-1);break;case fd.MODE_SIDEBYSIDE:{this._texture.uScale=this._halfDome?.99999:.5;const e=this._halfDome?0:.5,t=this._halfDome?-.5:0;this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add((i=>{let s=i.isRightCamera;this._crossEye&&(s=!s),this._texture.uOffset=s?e:t}));break}case fd.MODE_TOPBOTTOM:this._texture.vScale=this._halfDome?.99999:.5,this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add((e=>{let t=e.isRightCamera;this._crossEye&&(t=!t),this._texture.vOffset=t?.5:0}))}}dispose(e,t=!1){this._texture.dispose(),this._mesh.dispose(),this._material.dispose(),this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this.onLoadErrorObservable.clear(),this.onLoadObservable.clear(),super.dispose(e,t)}}fd.MODE_MONOSCOPIC=0,fd.MODE_TOPBOTTOM=1,fd.MODE_SIDEBYSIDE=2;class md extends fd{get photoTexture(){return this.texture}set photoTexture(e){this.texture=e}get imageMode(){return this.textureMode}set imageMode(e){this.textureMode=e}_initTexture(e,t,i){return new Ar(e,t,!i.generateMipMaps,!this._useDirectMapping,void 0,(()=>{this.onLoadObservable.notifyObservers()}),((e,t)=>{this.onLoadErrorObservable.notifyObservers(e||"Unknown error occured"),this.onError&&this.onError(e,t)}))}}md.MODE_MONOSCOPIC=fd.MODE_MONOSCOPIC,md.MODE_TOPBOTTOM=fd.MODE_TOPBOTTOM,md.MODE_SIDEBYSIDE=fd.MODE_SIDEBYSIDE;let gd=0;const vd=e=>{if(!e.environmentBRDFTexture){const t=e.useDelayedTextureLoading;e.useDelayedTextureLoading=!1;const i=e._blockEntityCollection;e._blockEntityCollection=!1;const s=Ar.CreateFromBase64String("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==","EnvironmentBRDFTexture"+gd++,e,!0,!1,Ar.BILINEAR_SAMPLINGMODE);e._blockEntityCollection=i;const r=e.getEngine().getLoadedTexturesCache(),n=r.indexOf(s.getInternalTexture());-1!==n&&r.splice(n,1),s.isRGBD=!0,s.wrapU=Ar.CLAMP_ADDRESSMODE,s.wrapV=Ar.CLAMP_ADDRESSMODE,e.environmentBRDFTexture=s,e.useDelayedTextureLoading=t,Dh.ExpandRGBDTexture(s);const o=e.getEngine().onContextRestoredObservable.add((()=>{s.isRGBD=!0;const e=()=>{s.isReady()?Dh.ExpandRGBDTexture(s):Ht.SetImmediate(e)};e()}));e.onDisposeObservable.add((()=>{e.getEngine().onContextRestoredObservable.remove(o)}))}return e.environmentBRDFTexture};class xd extends $t{constructor(){super(...arguments),this.BRDF_V_HEIGHT_CORRELATED=!1,this.MS_BRDF_ENERGY_CONSERVATION=!1,this.SPHERICAL_HARMONICS=!1,this.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1}}class Td extends Fa{_markAllSubMeshesAsMiscDirty(){this._internalMarkAllSubMeshesAsMiscDirty()}constructor(e,t=!0){super(e,"PBRBRDF",90,new xd,t),this._useEnergyConservation=Td.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=Td.DEFAULT_USE_ENERGY_CONSERVATION,this._useSmithVisibilityHeightCorrelated=Td.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=Td.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this._useSphericalHarmonics=Td.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=Td.DEFAULT_USE_SPHERICAL_HARMONICS,this._useSpecularGlossinessInputEnergyConservation=Td.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=Td.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16],this._enable(!0)}prepareDefines(e){e.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,e.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,e.SPHERICAL_HARMONICS=this._useSphericalHarmonics,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation}getClassName(){return"PBRBRDFConfiguration"}}Td.DEFAULT_USE_ENERGY_CONSERVATION=!0,Td.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0,Td.DEFAULT_USE_SPHERICAL_HARMONICS=!0,Td.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0,me([ie(),te("_markAllSubMeshesAsMiscDirty")],Td.prototype,"useEnergyConservation",void 0),me([ie(),te("_markAllSubMeshesAsMiscDirty")],Td.prototype,"useSmithVisibilityHeightCorrelated",void 0),me([ie(),te("_markAllSubMeshesAsMiscDirty")],Td.prototype,"useSphericalHarmonics",void 0),me([ie(),te("_markAllSubMeshesAsMiscDirty")],Td.prototype,"useSpecularGlossinessInputEnergyConservation",void 0);nt.IncludesShadersStore.pbrFragmentDeclaration="uniform vec4 vEyePosition;uniform vec3 vReflectionColor;uniform vec4 vAlbedoColor;uniform vec4 vLightingIntensity;uniform vec4 vReflectivityColor;uniform vec4 vMetallicReflectanceFactors;uniform vec3 vEmissiveColor;uniform float visibility;uniform vec3 vAmbientColor;\n#ifdef ALBEDO\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nuniform vec4 vAmbientInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;\n#endif\n#ifdef OPACITY\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef REFLECTIVITY\nuniform vec3 vReflectivityInfos;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#ifdef REALTIME_FILTERING\nuniform vec2 vReflectionFilteringInfo;\n#endif\nuniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;uniform vec3 vReflectionSize; \n#endif\n#endif\n#if defined(SS_REFRACTION) && defined(SS_USE_LOCAL_REFRACTIONMAP_CUBIC)\nuniform vec3 vRefractionPosition;uniform vec3 vRefractionSize; \n#endif\n#ifdef CLEARCOAT\nuniform vec2 vClearCoatParams;uniform vec4 vClearCoatRefractionParams;\n#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nuniform vec4 vClearCoatInfos;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nuniform mat4 clearCoatMatrix;\n#endif\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS\nuniform mat4 clearCoatRoughnessMatrix;\n#endif\n#ifdef CLEARCOAT_BUMP\nuniform vec2 vClearCoatBumpInfos;uniform vec2 vClearCoatTangentSpaceParams;uniform mat4 clearCoatBumpMatrix;\n#endif\n#ifdef CLEARCOAT_TINT\nuniform vec4 vClearCoatTintParams;uniform float clearCoatColorAtDistance;\n#ifdef CLEARCOAT_TINT_TEXTURE\nuniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;\n#endif\n#endif\n#endif\n#ifdef IRIDESCENCE\nuniform vec4 vIridescenceParams;\n#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)\nuniform vec4 vIridescenceInfos;\n#endif\n#ifdef IRIDESCENCE_TEXTURE\nuniform mat4 iridescenceMatrix;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nuniform mat4 iridescenceThicknessMatrix;\n#endif\n#endif\n#ifdef ANISOTROPIC\nuniform vec3 vAnisotropy;\n#ifdef ANISOTROPIC_TEXTURE\nuniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;\n#endif\n#endif\n#ifdef SHEEN\nuniform vec4 vSheenColor;\n#ifdef SHEEN_ROUGHNESS\nuniform float vSheenRoughness;\n#endif\n#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)\nuniform vec4 vSheenInfos;\n#endif\n#ifdef SHEEN_TEXTURE\nuniform mat4 sheenMatrix;\n#endif\n#ifdef SHEEN_TEXTURE_ROUGHNESS\nuniform mat4 sheenRoughnessMatrix;\n#endif\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\nuniform vec4 vRefractionMicrosurfaceInfos;uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;\n#ifdef REALTIME_FILTERING\nuniform vec2 vRefractionFilteringInfo;\n#endif\n#ifdef SS_DISPERSION\nuniform float dispersion;\n#endif\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nuniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nuniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nuniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;\n#endif\nuniform vec2 vThicknessParam;uniform vec3 vDiffusionDistance;uniform vec4 vTintColor;uniform vec3 vSubSurfaceIntensity;\n#endif\n#ifdef PREPASS\n#ifdef SS_SCATTERING\nuniform float scatteringDiffusionProfile;\n#endif\n#endif\n#if DEBUGMODE>0\nuniform vec2 vDebugMode;\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\n#endif\n#include<decalFragmentDeclaration>\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nuniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;\n#else\nuniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;\n#endif\n#endif\n#define ADDITIONAL_FRAGMENT_DECLARATION\n";nt.IncludesShadersStore.pbrUboDeclaration="layout(std140,column_major) uniform;uniform Material {vec2 vAlbedoInfos;vec4 vAmbientInfos;vec2 vOpacityInfos;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec3 vReflectivityInfos;vec2 vMicroSurfaceSamplerInfos;vec2 vReflectionInfos;vec2 vReflectionFilteringInfo;vec3 vReflectionPosition;vec3 vReflectionSize;vec3 vBumpInfos;mat4 albedoMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 reflectivityMatrix;mat4 microSurfaceSamplerMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;mat4 reflectionMatrix;vec3 vReflectionColor;vec4 vAlbedoColor;vec4 vLightingIntensity;vec3 vReflectionMicrosurfaceInfos;float pointSize;vec4 vReflectivityColor;vec3 vEmissiveColor;vec3 vAmbientColor;vec2 vDebugMode;vec4 vMetallicReflectanceFactors;vec2 vMetallicReflectanceInfos;mat4 metallicReflectanceMatrix;vec2 vReflectanceInfos;mat4 reflectanceMatrix;vec3 vSphericalL00;vec3 vSphericalL1_1;vec3 vSphericalL10;vec3 vSphericalL11;vec3 vSphericalL2_2;vec3 vSphericalL2_1;vec3 vSphericalL20;vec3 vSphericalL21;vec3 vSphericalL22;vec3 vSphericalX;vec3 vSphericalY;vec3 vSphericalZ;vec3 vSphericalXX_ZZ;vec3 vSphericalYY_ZZ;vec3 vSphericalZZ;vec3 vSphericalXY;vec3 vSphericalYZ;vec3 vSphericalZX;\n#define ADDITIONAL_UBO_DECLARATION\n};\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";nt.IncludesShadersStore.pbrFragmentExtraDeclaration="varying vec3 vPositionW;\n#if DEBUGMODE>0\nvarying vec4 vClipSpacePosition;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n";nt.IncludesShadersStore.samplerFragmentAlternateDeclaration="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying vec2 v_VARYINGNAME_UV;\n#endif\n#endif\n";nt.IncludesShadersStore.pbrFragmentSamplersDeclaration="#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)\n#ifdef CLEARCOAT\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)\n#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL)\nuniform sampler2D clearCoatRoughnessSampler;\n#endif\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)\n#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL)\nuniform sampler2D sheenRoughnessSampler;\n#endif\n#endif\n#ifdef ANISOTROPIC\n#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)\n#endif\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;\n#endif\n#ifdef USEIRRADIANCEMAP\nuniform samplerCube irradianceSampler;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform sampler2D reflectionSamplerLow;uniform sampler2D reflectionSamplerHigh;\n#endif\n#ifdef USEIRRADIANCEMAP\nuniform sampler2D irradianceSampler;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#endif\n#ifdef ENVIRONMENTBRDF\nuniform sampler2D environmentBrdfSampler;\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\n#ifdef SS_REFRACTIONMAP_3D\n#define sampleRefraction(s,c) textureCube(s,c)\nuniform samplerCube refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube refractionSamplerLow;uniform samplerCube refractionSamplerHigh;\n#endif\n#else\n#define sampleRefraction(s,c) texture2D(s,c)\nuniform sampler2D refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform sampler2D refractionSamplerLow;uniform sampler2D refractionSamplerHigh;\n#endif\n#endif\n#endif\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)\n#endif\n";nt.IncludesShadersStore.subSurfaceScatteringFunctions="bool testLightingForSSS(float diffusionProfile)\n{return diffusionProfile<1.;}";nt.IncludesShadersStore.importanceSampling="vec3 hemisphereCosSample(vec2 u) {float phi=2.*PI*u.x;float cosTheta2=1.-u.y;float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}\nvec3 hemisphereImportanceSampleDggx(vec2 u,float a) {float phi=2.*PI*u.x;float cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}\nvec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) { \nfloat phi=2.*PI*u.x;float sinTheta=pow(u.y,a/(2.*a+1.));float cosTheta=sqrt(1.-sinTheta*sinTheta);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}";nt.IncludesShadersStore.pbrHelperFunctions="#define MINIMUMVARIANCE 0.0005\nfloat convertRoughnessToAverageSlope(float roughness)\n{return square(roughness)+MINIMUMVARIANCE;}\nfloat fresnelGrazingReflectance(float reflectance0) {float reflectance90=saturate(reflectance0*25.0);return reflectance90;}\nvec2 getAARoughnessFactors(vec3 normalVector) {\n#ifdef SPECULARAA\nvec3 nDfdx=dFdx(normalVector.xyz);vec3 nDfdy=dFdy(normalVector.xyz);float slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));float geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);float geometricAlphaGFactor=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2(geometricRoughnessFactor,geometricAlphaGFactor);\n#else\nreturn vec2(0.);\n#endif\n}\n#ifdef ANISOTROPIC\n#ifdef ANISOTROPIC_LEGACY\nvec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2(alphaT,alphaB);}\nvec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 anisotropicFrameDirection=anisotropy>=0.0 ? B : T;vec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);vec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);vec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}\n#else\nvec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG,MINIMUMVARIANCE);return vec2(alphaT,alphaB);}\nvec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 bentNormal=cross(B,V);bentNormal=normalize(cross(bentNormal,B));float a=square(square(1.0-anisotropy*(1.0-roughness)));bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}\n#endif\n#endif\n#if defined(CLEARCOAT) || defined(SS_REFRACTION)\nvec3 cocaLambert(vec3 alpha,float distance) {return exp(-alpha*distance);}\nvec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {return cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}\nvec3 computeColorAtDistanceInMedia(vec3 color,float distance) {return -log(color)/distance;}\nvec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 clearCoatAbsorption=mix(vec3(1.0),\ncocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),\nclearCoatIntensity);return clearCoatAbsorption;}\n#endif\n#ifdef MICROSURFACEAUTOMATIC\nfloat computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)\n{const float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;float reflectivityLuminance=getLuminance(reflectivityColor);float reflectivityLuma=sqrt(reflectivityLuminance);microSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return microSurface;}\n#endif\n";nt.IncludesShadersStore.harmonicsFunctions="#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nvec3 computeEnvironmentIrradiance(vec3 normal) {return vSphericalL00\n+ vSphericalL1_1*(normal.y)\n+ vSphericalL10*(normal.z)\n+ vSphericalL11*(normal.x)\n+ vSphericalL2_2*(normal.y*normal.x)\n+ vSphericalL2_1*(normal.y*normal.z)\n+ vSphericalL20*((3.0*normal.z*normal.z)-1.0)\n+ vSphericalL21*(normal.z*normal.x)\n+ vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}\n#else\nvec3 computeEnvironmentIrradiance(vec3 normal) {float Nx=normal.x;float Ny=normal.y;float Nz=normal.z;vec3 C1=vSphericalZZ.rgb;vec3 Cx=vSphericalX.rgb;vec3 Cy=vSphericalY.rgb;vec3 Cz=vSphericalZ.rgb;vec3 Cxx_zz=vSphericalXX_ZZ.rgb;vec3 Cyy_zz=vSphericalYY_ZZ.rgb;vec3 Cxy=vSphericalXY.rgb;vec3 Cyz=vSphericalYZ.rgb;vec3 Czx=vSphericalZX.rgb;vec3 a1=Cyy_zz*Ny+Cy;vec3 a2=Cyz*Nz+a1;vec3 b1=Czx*Nz+Cx;vec3 b2=Cxy*Ny+b1;vec3 b3=Cxx_zz*Nx+b2;vec3 t1=Cz *Nz+C1;vec3 t2=a2 *Ny+t1;vec3 t3=b3 *Nx+t2;return t3;}\n#endif\n#endif\n";nt.IncludesShadersStore.pbrDirectLightingSetupFunctions="struct preLightingInfo\n{vec3 lightOffset;float lightDistanceSquared;float lightDistance;float attenuation;vec3 L;vec3 H;float NdotV;float NdotLUnclamped;float NdotL;float VdotH;float roughness;\n#ifdef IRIDESCENCE\nfloat iridescenceIntensity;\n#endif\n};preLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.lightOffset=lightData.xyz-vPositionW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}\npreLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}\npreLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;\n#ifdef SPECULARTERM\nresult.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));\n#endif\nreturn result;}";nt.IncludesShadersStore.pbrDirectLightingFalloffFunctions="float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)\n{return max(0.,1.0-length(lightOffset)/range);}\nfloat computeDistanceLightFalloff_Physical(float lightDistanceSquared)\n{return 1.0/maxEps(lightDistanceSquared);}\nfloat computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)\n{float lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);float factor=lightDistanceSquared*inverseSquaredRange;float attenuation=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}\nfloat computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDistanceLightFalloff_Physical(lightDistanceSquared);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);\n#else\nreturn computeDistanceLightFalloff_Standard(lightOffset,range);\n#endif\n}\nfloat computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)\n{float falloff=0.0;float cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)\n{falloff=max(0.,pow(cosAngle,exponent));}\nreturn falloff;}\nfloat computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)\n{const float kMinusLog2ConeAngleIntensityRatio=6.64385618977; \nfloat concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);vec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);float falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}\nfloat computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)\n{float cd=dot(-lightDirection,directionToLightCenterW);float falloff=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}\nfloat computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);\n#else\nreturn computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);\n#endif\n}";nt.IncludesShadersStore.pbrBRDFFunctions="#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nvec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}\n#endif\n#ifdef ENVIRONMENTBRDF\nvec3 getBRDFLookup(float NdotV,float perceptualRoughness) {vec2 UV=vec2(NdotV,perceptualRoughness);vec4 brdfLookup=texture2D(environmentBrdfSampler,UV);\n#ifdef ENVIRONMENTBRDF_RGBD\nbrdfLookup.rgb=fromRGBD(brdfLookup.rgba);\n#endif\nreturn brdfLookup.rgb;}\nvec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;\n#else\nvec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;\n#endif\nreturn reflectance;}\nvec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);\n#else\nvec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;\n#endif\nreturn reflectance;}\n#endif\n/* NOT USED\n#if defined(SHEEN) && defined(SHEEN_SOFTER)\nfloat getBRDFLookupCharlieSheen(float NdotV,float perceptualRoughness)\n{float c=1.0-NdotV;float c3=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}\n#endif\n*/\n#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)\nvec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\n/**\n* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.\n* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table\n*/\nvec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {vec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}\n#endif\nvec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)\n{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}\nfloat fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)\n{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}\n#ifdef CLEARCOAT\nvec3 getR0RemappedForClearCoat(vec3 f0) {\n#ifdef CLEARCOAT_DEFAULTIOR\n#ifdef MOBILE\nreturn saturate(f0*(f0*0.526868+0.529324)-0.0482256);\n#else\nreturn saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);\n#endif\n#else\nvec3 s=sqrt(f0);vec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);return square(t);\n#endif\n}\n#endif\n#ifdef IRIDESCENCE\nconst mat3 XYZ_TO_REC709=mat3(\n3.2404542,-0.9692660, 0.0556434,\n-1.5371385, 1.8760108,-0.2040259,\n-0.4985314, 0.0415560, 1.0572252\n);vec3 getIORTfromAirToSurfaceR0(vec3 f0) {vec3 sqrtF0=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}\nvec3 getR0fromIORs(vec3 iorT,float iorI) {return square((iorT-vec3(iorI))/(iorT+vec3(iorI)));}\nfloat getR0fromIORs(float iorT,float iorI) {return square((iorT-iorI)/(iorT+iorI));}\nvec3 evalSensitivity(float opd,vec3 shift) {float phase=2.0*PI*opd*1.0e-9;const vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);const vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);const vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);vec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-square(phase)*var);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;vec3 srgb=XYZ_TO_REC709*xyz;return srgb;}\nvec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0) {vec3 I=vec3(1.0);float iridescenceIOR=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));float sinTheta2Sq=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));float cosTheta2Sq=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}\nfloat cosTheta2=sqrt(cosTheta2Sq);float R0=getR0fromIORs(iridescenceIOR,outsideIOR);float R12=fresnelSchlickGGX(cosTheta1,R0,1.);float R21=R12;float T121=1.0-R12;float phi12=0.0;if (iridescenceIOR<outsideIOR) phi12=PI;float phi21=PI-phi12;vec3 baseIOR=getIORTfromAirToSurfaceR0(clamp(baseF0,0.0,0.9999)); \nvec3 R1=getR0fromIORs(baseIOR,iridescenceIOR);vec3 R23=fresnelSchlickGGX(cosTheta2,R1,vec3(1.));vec3 phi23=vec3(0.0);if (baseIOR[0]<iridescenceIOR) phi23[0]=PI;if (baseIOR[1]<iridescenceIOR) phi23[1]=PI;if (baseIOR[2]<iridescenceIOR) phi23[2]=PI;float opd=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;vec3 phi=vec3(phi21)+phi23;vec3 R123=clamp(R12*R23,1e-5,0.9999);vec3 r123=sqrt(R123);vec3 Rs=square(T121)*R23/(vec3(1.0)-R123);vec3 C0=R12+Rs;I=C0;vec3 Cm=Rs-T121;for (int m=1; m<=2; ++m)\n{Cm*=r123;vec3 Sm=2.0*evalSensitivity(float(m)*opd,float(m)*phi);I+=Cm*Sm;}\nreturn max(I,vec3(0.0));}\n#endif\nfloat normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)\n{float a2=square(alphaG);float d=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}\n#ifdef SHEEN\nfloat normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)\n{float invR=1./alphaG;float cos2h=NdotH*NdotH;float sin2h=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}\n#endif\n#ifdef ANISOTROPIC\nfloat normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {float a2=alphaTB.x*alphaTB.y;vec3 v=vec3(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);float v2=dot(v,v);float w2=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}\n#endif\n#ifdef BRDF_V_HEIGHT_CORRELATED\nfloat smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {\n#ifdef MOBILE\nfloat GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);float GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);\n#else\nfloat a2=alphaG*alphaG;float GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);float GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);\n#endif\n}\n#else\nfloat smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)\n{\n#ifdef MOBILE\nreturn 1.0/(dot+alphaG+(1.0-alphaG)*dot ));\n#else\nfloat alphaSquared=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));\n#endif\n}\nfloat smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)\n{float visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}\n#endif\n#ifdef ANISOTROPIC\nfloat smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {float lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));float lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));float v=0.5/(lambdaV+lambdaL);return v;}\n#endif\n#ifdef CLEARCOAT\nfloat visibility_Kelemen(float VdotH) {return 0.25/(VdotH*VdotH); }\n#endif\n#ifdef SHEEN\nfloat visibility_Ashikhmin(float NdotL,float NdotV)\n{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}\n/* NOT USED\n#ifdef SHEEN_SOFTER\nfloat l(float x,float alphaG)\n{float oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);float a=mix(21.5473,25.3245,oneMinusAlphaSq);float b=mix(3.82987,3.32435,oneMinusAlphaSq);float c=mix(0.19823,0.16801,oneMinusAlphaSq);float d=mix(-1.97760,-1.27393,oneMinusAlphaSq);float e=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}\nfloat lambdaSheen(float cosTheta,float alphaG)\n{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}\nfloat visibility_CharlieSheen(float NdotL,float NdotV,float alphaG)\n{float G=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}\n#endif\n*/\n#endif\nfloat diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {float diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));float diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));float diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;float fresnel =\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}\n#ifdef SS_TRANSLUCENCY\nvec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {vec3 S=1./maxEps(diffusionDistance);vec3 temp=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}\nfloat computeWrappedDiffuseNdotL(float NdotL,float w) {float t=1.0+w;float invt2=1.0/square(t);return saturate((NdotL+w)*invt2);}\n#endif\n";nt.IncludesShadersStore.hdrFilteringFunctions="#ifdef NUM_SAMPLES\n#if NUM_SAMPLES>0\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfloat radicalInverse_VdC(uint bits) \n{bits=(bits<<16u) | (bits>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return float(bits)*2.3283064365386963e-10; }\nvec2 hammersley(uint i,uint N)\n{return vec2(float(i)/float(N),radicalInverse_VdC(i));}\n#else\nfloat vanDerCorpus(int n,int base)\n{float invBase=1.0/float(base);float denom =1.0;float result =0.0;for(int i=0; i<32; ++i)\n{if(n>0)\n{denom =mod(float(n),2.0);result+=denom*invBase;invBase=invBase/2.0;n =int(float(n)/2.0);}}\nreturn result;}\nvec2 hammersley(int i,int N)\n{return vec2(float(i)/float(N),vanDerCorpus(i,2));}\n#endif\nfloat log4(float x) {return log2(x)/2.;}\nconst float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);const float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;const float K=4.;\n#define inline\nvec3 irradiance(samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)\n{vec3 n=normalize(inputN);vec3 result=vec3(0.0);vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfor(uint i=0u; i<NUM_SAMPLES; ++i)\n#else\nfor(int i=0; i<NUM_SAMPLES; ++i)\n#endif\n{vec2 Xi=hammersley(i,NUM_SAMPLES);vec3 Ls=hemisphereCosSample(Xi);Ls=normalize(Ls);vec3 Ns=vec3(0.,0.,1.);float NoL=dot(Ns,Ls);if (NoL>0.) {float pdf_inversed=PI/NoL;float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(l,0.0,maxLevel);vec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nresult+=c;}}\nresult=result*NUM_SAMPLES_FLOAT_INVERSED;return result;}\n#define inline\nvec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)\n{vec3 n=normalize(inputN);vec3 c=textureCube(inputTexture,n).rgb; \nif (alphaG==0.) {\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nreturn c;} else {vec3 result=vec3(0.);vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);float weight=0.;\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfor(uint i=0u; i<NUM_SAMPLES; ++i)\n#else\nfor(int i=0; i<NUM_SAMPLES; ++i)\n#endif\n{vec2 Xi=hammersley(i,NUM_SAMPLES);vec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);float NoV=1.;float NoH=H.z;float NoH2=H.z*H.z;float NoL=2.*NoH2-1.;vec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {float pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(float(l),0.0,maxLevel);weight+=NoL;vec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nresult+=c*NoL;}}\nresult=result/weight;return result;}}\n#endif\n#endif\n";nt.IncludesShadersStore.pbrDirectLightingFunctions="#define CLEARCOATREFLECTANCE90 1.0\nstruct lightingInfo\n{vec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef CLEARCOAT\nvec4 clearCoat;\n#endif\n#ifdef SHEEN\nvec3 sheen;\n#endif\n};float adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {\n#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)\nfloat lightRoughness=lightRadius/lightDistance;float totalRoughness=saturate(lightRoughness+roughness);return totalRoughness;\n#else\nreturn roughness;\n#endif\n}\nvec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {return mix(groundColor,lightColor,info.NdotL);}\nvec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {float diffuseTerm=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*info.attenuation*info.NdotL*lightColor;}\n#define inline\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return toLinearSpace(textureColor);}\n#ifdef SS_TRANSLUCENCY\nvec3 computeDiffuseAndTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance) {float NdotL=absEps(info.NdotLUnclamped);float wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);float trAdapt=step(0.,info.NdotLUnclamped);vec3 transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);float diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;}\n#endif\n#ifdef SPECULARTERM\nvec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);\n#ifdef IRIDESCENCE\nfresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);\n#endif\nfloat distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);\n#ifdef BRDF_V_HEIGHT_CORRELATED\nfloat smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);\n#else\nfloat smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);\n#endif\nvec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}\n#endif\n#ifdef ANISOTROPIC\nvec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float TdotH=dot(T,info.H);float BdotH=dot(B,info.H);float TdotV=dot(T,V);float BdotV=dot(B,V);float TdotL=dot(T,info.L);float BdotL=dot(B,info.L);float alphaG=convertRoughnessToAverageSlope(info.roughness);vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,square(geometricRoughnessFactor));vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);\n#ifdef IRIDESCENCE\nfresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);\n#endif\nfloat distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}\n#endif\n#ifdef CLEARCOAT\nvec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {float NccdotL=saturateEps(dot(Ncc,info.L));float NccdotH=saturateEps(dot(Ncc,info.H));float clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);float fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);float kelemenVisibility=visibility_Kelemen(info.VdotH);float clearCoatTerm=fresnel*distribution*kelemenVisibility;return vec4(\nclearCoatTerm*info.attenuation*NccdotL*lightColor,\n1.0-fresnel\n);}\nvec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);float NdotLRefract=saturateEps(dot(Ncc,LRefract));vec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}\n#endif\n#ifdef SHEEN\nvec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);float fresnel=1.;float distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER\nfloat visibility=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);\n#else */\nfloat visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */\nfloat sheenTerm=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}\n#endif\n";nt.IncludesShadersStore.pbrIBLFunctions="#if defined(REFLECTION) || defined(SS_REFRACTION)\nfloat getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {float microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;float lod=log2(microsurfaceAverageSlopeTexels);return lod;}\nfloat getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {float lod=log2(cubeMapDimensionPixels)*roughness;return lod;}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)\nfloat environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {float temp=NdotVUnclamped+ambientOcclusion;return saturate(square(temp)-1.0+ambientOcclusion);}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)\nfloat environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {vec3 reflection=reflect(view,normal);float temp=saturate(1.0+1.1*dot(reflection,geometricNormal));return square(temp);}\n#endif\n#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)\n#define UNPACK_LOD(x) (1.0-x)*255.0\nfloat getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {float microsurfaceAverageSlope=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}\n#endif\n";nt.IncludesShadersStore.pbrBlockAlbedoOpacity="struct albedoOpacityOutParams\n{vec3 surfaceAlbedo;float alpha;};\n#define pbr_inline\nvoid albedoOpacityBlock(\nin vec4 vAlbedoColor,\n#ifdef ALBEDO\nin vec4 albedoTexture,\nin vec2 albedoInfos,\n#endif\n#ifdef OPACITY\nin vec4 opacityMap,\nin vec2 vOpacityInfos,\n#endif\n#ifdef DETAIL\nin vec4 detailColor,\nin vec4 vDetailInfos,\n#endif\n#ifdef DECAL\nin vec4 decalColor,\nin vec4 vDecalInfos,\n#endif\nout albedoOpacityOutParams outParams\n)\n{vec3 surfaceAlbedo=vAlbedoColor.rgb;float alpha=vAlbedoColor.a;\n#ifdef ALBEDO\n#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)\nalpha*=albedoTexture.a;\n#endif\n#ifdef GAMMAALBEDO\nsurfaceAlbedo*=toLinearSpace(albedoTexture.rgb);\n#else\nsurfaceAlbedo*=albedoTexture.rgb;\n#endif\nsurfaceAlbedo*=albedoInfos.y;\n#endif\n#ifndef DECAL_AFTER_DETAIL\n#include<decalFragment>\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nsurfaceAlbedo*=vColor.rgb;\n#endif\n#ifdef DETAIL\nfloat detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; \n#endif\n#ifdef DECAL_AFTER_DETAIL\n#include<decalFragment>\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALBEDO\n#ifdef OPACITY\n#ifdef OPACITYRGB\nalpha=getLuminance(opacityMap.rgb);\n#else\nalpha*=opacityMap.a;\n#endif\nalpha*=vOpacityInfos.y;\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=vColor.a;\n#endif\n#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)\n#ifdef ALPHATEST \n#if DEBUGMODE != 88\nif (alpha<ALPHATESTVALUE)\ndiscard;\n#endif\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;}\n";nt.IncludesShadersStore.pbrBlockReflectivity="struct reflectivityOutParams\n{float microSurface;float roughness;vec3 surfaceReflectivityColor;\n#ifdef METALLICWORKFLOW\nvec3 surfaceAlbedo;\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\nvec3 ambientOcclusionColor;\n#endif\n#if DEBUGMODE>0\n#ifdef METALLICWORKFLOW\nvec2 metallicRoughness;\n#ifdef REFLECTIVITY\nvec4 surfaceMetallicColorMap;\n#endif\n#ifndef FROSTBITE_REFLECTANCE\nvec3 metallicF0;\n#endif\n#else\n#ifdef REFLECTIVITY\nvec4 surfaceReflectivityColorMap;\n#endif\n#endif\n#endif\n};\n#define pbr_inline\nvoid reflectivityBlock(\nin vec4 vReflectivityColor,\n#ifdef METALLICWORKFLOW\nin vec3 surfaceAlbedo,\nin vec4 metallicReflectanceFactors,\n#endif\n#ifdef REFLECTIVITY\nin vec3 reflectivityInfos,\nin vec4 surfaceMetallicOrReflectivityColorMap,\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\nin vec3 ambientOcclusionColorIn,\n#endif\n#ifdef MICROSURFACEMAP\nin vec4 microSurfaceTexel,\n#endif\n#ifdef DETAIL\nin vec4 detailColor,\nin vec4 vDetailInfos,\n#endif\nout reflectivityOutParams outParams\n)\n{float microSurface=vReflectivityColor.a;vec3 surfaceReflectivityColor=vReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvec2 metallicRoughness=surfaceReflectivityColor.rg;\n#ifdef REFLECTIVITY\n#if DEBUGMODE>0\noutParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef AOSTOREINMETALMAPRED\nvec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);\n#endif\n#ifdef METALLNESSSTOREINMETALMAPBLUE\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;\n#else\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;\n#endif\n#ifdef ROUGHNESSSTOREINMETALMAPALPHA\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;\n#else\n#ifdef ROUGHNESSSTOREINMETALMAPGREEN\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;\n#endif\n#endif\n#endif\n#ifdef DETAIL\nfloat detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);float loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);float hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));\n#endif\n#ifdef MICROSURFACEMAP\nmetallicRoughness.g*=microSurfaceTexel.r;\n#endif\n#if DEBUGMODE>0\noutParams.metallicRoughness=metallicRoughness;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS\nmicroSurface=1.0-metallicRoughness.g;vec3 baseColor=surfaceAlbedo;\n#ifdef FROSTBITE_REFLECTANCE\noutParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);surfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);\n#else\nvec3 metallicF0=metallicReflectanceFactors.rgb;\n#if DEBUGMODE>0\noutParams.metallicF0=metallicF0;\n#endif\noutParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0),vec3(0.,0.,0.),metallicRoughness.r);surfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);\n#endif\n#else\n#ifdef REFLECTIVITY\nsurfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;\n#if DEBUGMODE>0\noutParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef MICROSURFACEFROMREFLECTIVITYMAP\nmicroSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;\n#else\n#ifdef MICROSURFACEAUTOMATIC\nmicroSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);\n#endif\n#ifdef MICROSURFACEMAP\nmicroSurface*=microSurfaceTexel.r;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE\n#endif\n#endif\n#endif\nmicroSurface=saturate(microSurface);float roughness=1.-microSurface;outParams.microSurface=microSurface;outParams.roughness=roughness;outParams.surfaceReflectivityColor=surfaceReflectivityColor;}\n";nt.IncludesShadersStore.pbrBlockAmbientOcclusion="struct ambientOcclusionOutParams\n{vec3 ambientOcclusionColor;\n#if DEBUGMODE>0 && defined(AMBIENT)\nvec3 ambientOcclusionColorMap;\n#endif\n};\n#define pbr_inline\nvoid ambientOcclusionBlock(\n#ifdef AMBIENT\nin vec3 ambientOcclusionColorMap_,\nin vec4 vAmbientInfos,\n#endif\nout ambientOcclusionOutParams outParams\n)\n{vec3 ambientOcclusionColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nvec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;\n#ifdef AMBIENTINGRAYSCALE\nambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);\n#endif\nambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);\n#if DEBUGMODE>0\noutParams.ambientOcclusionColorMap=ambientOcclusionColorMap;\n#endif\n#endif\noutParams.ambientOcclusionColor=ambientOcclusionColor;}\n";nt.IncludesShadersStore.pbrBlockAlphaFresnel="#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nstruct alphaFresnelOutParams\n{float alpha;};\n#define pbr_inline\nvoid alphaFresnelBlock(\nin vec3 normalW,\nin vec3 viewDirectionW,\nin float alpha,\nin float microSurface,\nout alphaFresnelOutParams outParams\n)\n{float opacityPerceptual=alpha;\n#ifdef LINEARALPHAFRESNEL\nfloat opacity0=opacityPerceptual;\n#else\nfloat opacity0=opacityPerceptual*opacityPerceptual;\n#endif\nfloat opacity90=fresnelGrazingReflectance(opacity0);vec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;\n#ifdef ALPHATEST\nif (outParams.alpha<ALPHATESTVALUE)\ndiscard;\n#ifndef ALPHABLEND\noutParams.alpha=1.0;\n#endif\n#endif\n}\n#endif\n#endif\n";nt.IncludesShadersStore.pbrBlockAnisotropic="#ifdef ANISOTROPIC\nstruct anisotropicOutParams\n{float anisotropy;vec3 anisotropicTangent;vec3 anisotropicBitangent;vec3 anisotropicNormal;\n#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)\nvec3 anisotropyMapData;\n#endif\n};\n#define pbr_inline\nvoid anisotropicBlock(\nin vec3 vAnisotropy,\nin float roughness,\n#ifdef ANISOTROPIC_TEXTURE\nin vec3 anisotropyMapData,\n#endif\nin mat3 TBN,\nin vec3 normalW,\nin vec3 viewDirectionW,\nout anisotropicOutParams outParams\n)\n{float anisotropy=vAnisotropy.b;vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);\n#ifdef ANISOTROPIC_TEXTURE\nanisotropy*=anisotropyMapData.b;\n#if DEBUGMODE>0\noutParams.anisotropyMapData=anisotropyMapData;\n#endif\nanisotropyMapData.rg=anisotropyMapData.rg*2.0-1.0;\n#ifdef ANISOTROPIC_LEGACY\nanisotropyDirection.rg*=anisotropyMapData.rg;\n#else\nanisotropyDirection.xy=mat2(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(anisotropyMapData.rg);\n#endif\n#endif\nmat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));vec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);vec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);}\n#endif\n";nt.IncludesShadersStore.pbrBlockReflection="#ifdef REFLECTION\nstruct reflectionOutParams\n{vec4 environmentRadiance;vec3 environmentIrradiance;\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords;\n#else\nvec2 reflectionCoords;\n#endif\n#ifdef SS_TRANSLUCENCY\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nvec3 irradianceVector;\n#endif\n#endif\n#endif\n};\n#define pbr_inline\nvoid createReflectionCoords(\nin vec3 vPositionW,\nin vec3 normalW,\n#ifdef ANISOTROPIC\nin anisotropicOutParams anisotropicOut,\n#endif\n#ifdef REFLECTIONMAP_3D\nout vec3 reflectionCoords\n#else\nout vec2 reflectionCoords\n#endif\n)\n{\n#ifdef ANISOTROPIC\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);\n#else\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nreflectionCoords=reflectionVector;\n#else\nreflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n}\n#define pbr_inline\n#define inline\nvoid sampleReflectionTexture(\nin float alphaG,\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nin float NdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nin float roughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\nconst vec3 reflectionCoords,\n#else\nin sampler2D reflectionSampler,\nconst vec2 reflectionCoords,\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\nout vec4 environmentRadiance\n)\n{\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);\n#elif defined(LINEARSPECULARREFLECTION)\nfloat reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);\n#else\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);\n#endif\n#ifdef LODBASEDMICROSFURACE\nreflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;\n#ifdef LODINREFLECTIONALPHA\nfloat automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);float requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);\n#else\nfloat requestedReflectionLOD=reflectionLOD;\n#endif\n#ifdef REALTIME_FILTERING\nenvironmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);\n#else\nenvironmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);\n#endif\n#else\nfloat lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(\nsampleReflection(reflectionSamplerHigh,reflectionCoords),\nenvironmentMid,\nlodReflectionNormalizedDoubled\n);} else {environmentRadiance=mix(\nenvironmentMid,\nsampleReflection(reflectionSamplerLow,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);}\n#endif\n#ifdef RGBDREFLECTION\nenvironmentRadiance.rgb=fromRGBD(environmentRadiance);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);\n#endif\nenvironmentRadiance.rgb*=vReflectionInfos.x;environmentRadiance.rgb*=vReflectionColor.rgb;}\n#define pbr_inline\n#define inline\nvoid reflectionBlock(\nin vec3 vPositionW,\nin vec3 normalW,\nin float alphaG,\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\n#ifdef ANISOTROPIC\nin anisotropicOutParams anisotropicOut,\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nin float NdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nin float roughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\n#else\nin sampler2D reflectionSampler,\n#endif\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nin vec3 vEnvironmentIrradiance,\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nin mat4 reflectionMatrix,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\nin samplerCube irradianceSampler,\n#else\nin sampler2D irradianceSampler,\n#endif\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\nout reflectionOutParams outParams\n)\n{vec4 environmentRadiance=vec4(0.,0.,0.,0.);\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=vec3(0.);\n#else\nvec2 reflectionCoords=vec2(0.);\n#endif\ncreateReflectionCoords(\nvPositionW,\nnormalW,\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif\nreflectionCoords\n);sampleReflectionTexture(\nalphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nroughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nreflectionSampler,\nreflectionCoords,\n#else\nreflectionSampler,\nreflectionCoords,\n#endif\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentRadiance\n);vec3 environmentIrradiance=vec3(0.,0.,0.);\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nenvironmentIrradiance=vEnvironmentIrradiance;\n#else\n#ifdef ANISOTROPIC\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;\n#else\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#if defined(REALTIME_FILTERING)\nenvironmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo);\n#else\nenvironmentIrradiance=computeEnvironmentIrradiance(irradianceVector);\n#endif\n#ifdef SS_TRANSLUCENCY\noutParams.irradianceVector=irradianceVector;\n#endif\n#endif\n#elif defined(USEIRRADIANCEMAP)\nvec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);environmentIrradiance=environmentIrradiance4.rgb;\n#ifdef RGBDREFLECTION\nenvironmentIrradiance.rgb=fromRGBD(environmentIrradiance4);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);\n#endif\n#endif\nenvironmentIrradiance*=vReflectionColor.rgb;outParams.environmentRadiance=environmentRadiance;outParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;}\n#endif\n";nt.IncludesShadersStore.pbrBlockSheen="#ifdef SHEEN\nstruct sheenOutParams\n{float sheenIntensity;vec3 sheenColor;float sheenRoughness;\n#ifdef SHEEN_LINKWITHALBEDO\nvec3 surfaceAlbedo;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfloat sheenAlbedoScaling;\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nvec3 finalSheenRadianceScaled;\n#endif\n#if DEBUGMODE>0\n#ifdef SHEEN_TEXTURE\nvec4 sheenMapData;\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nvec3 sheenEnvironmentReflectance;\n#endif\n#endif\n};\n#define pbr_inline\n#define inline\nvoid sheenBlock(\nin vec4 vSheenColor,\n#ifdef SHEEN_ROUGHNESS\nin float vSheenRoughness,\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nin vec4 sheenMapRoughnessData,\n#endif\n#endif\nin float roughness,\n#ifdef SHEEN_TEXTURE\nin vec4 sheenMapData,\nin float sheenMapLevel,\n#endif\nin float reflectance,\n#ifdef SHEEN_LINKWITHALBEDO\nin vec3 baseColor,\nin vec3 surfaceAlbedo,\n#endif\n#ifdef ENVIRONMENTBRDF\nin float NdotV,\nin vec3 environmentBrdf,\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nin vec2 AARoughnessFactors,\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\nin vec4 vLightingIntensity,\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\nin vec3 reflectionCoords,\n#else\nin sampler2D reflectionSampler,\nin vec2 reflectionCoords,\n#endif\nin float NdotVUnclamped,\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nin float seo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\nin float eho,\n#endif\n#endif\nout sheenOutParams outParams\n)\n{float sheenIntensity=vSheenColor.a;\n#ifdef SHEEN_TEXTURE\n#if DEBUGMODE>0\noutParams.sheenMapData=sheenMapData;\n#endif\n#endif\n#ifdef SHEEN_LINKWITHALBEDO\nfloat sheenFactor=pow5(1.0-sheenIntensity);vec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);float sheenRoughness=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#else\nvec3 sheenColor=vSheenColor.rgb;\n#ifdef SHEEN_TEXTURE\n#ifdef SHEEN_GAMMATEXTURE\nsheenColor.rgb*=toLinearSpace(sheenMapData.rgb);\n#else\nsheenColor.rgb*=sheenMapData.rgb;\n#endif\nsheenColor.rgb*=sheenMapLevel;\n#endif\n#ifdef SHEEN_ROUGHNESS\nfloat sheenRoughness=vSheenRoughness;\n#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE\n#if defined(SHEEN_TEXTURE)\nsheenRoughness*=sheenMapData.a;\n#endif\n#elif defined(SHEEN_TEXTURE_ROUGHNESS)\n#ifdef SHEEN_TEXTURE_ROUGHNESS_IDENTICAL\nsheenRoughness*=sheenMapData.a;\n#else\nsheenRoughness*=sheenMapRoughnessData.a;\n#endif\n#endif\n#else\nfloat sheenRoughness=roughness;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#endif\n#if !defined(SHEEN_ALBEDOSCALING)\nsheenIntensity*=(1.-reflectance);\n#endif\nsheenColor*=sheenIntensity;\n#endif\n#ifdef ENVIRONMENTBRDF\n/*#ifdef SHEEN_SOFTER\nvec3 environmentSheenBrdf=vec3(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));\n#else*/\n#ifdef SHEEN_ROUGHNESS\nvec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);\n#else\nvec3 environmentSheenBrdf=environmentBrdf;\n#endif\n/*#endif*/\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nfloat sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);\n#ifdef SPECULARAA\nsheenAlphaG+=AARoughnessFactors.y;\n#endif\nvec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);sampleReflectionTexture(\nsheenAlphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nsheenRoughness,\n#endif\nreflectionSampler,\nreflectionCoords,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentSheenRadiance\n);vec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nsheenEnvironmentReflectance*=seo;\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\nsheenEnvironmentReflectance*=eho;\n#endif\n#if DEBUGMODE>0\noutParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;\n#endif\noutParams.finalSheenRadianceScaled=\nenvironmentSheenRadiance.rgb *\nsheenEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\noutParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;\n#endif\noutParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;}\n#endif\n";nt.IncludesShadersStore.pbrBlockClearcoat="struct clearcoatOutParams\n{vec3 specularEnvironmentR0;float conservationFactor;vec3 clearCoatNormalW;vec2 clearCoatAARoughnessFactors;float clearCoatIntensity;float clearCoatRoughness;\n#ifdef REFLECTION\nvec3 finalClearCoatRadianceScaled;\n#endif\n#ifdef CLEARCOAT_TINT\nvec3 absorption;float clearCoatNdotVRefract;vec3 clearCoatColor;float clearCoatThickness;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nvec3 energyConservationFactorClearCoat;\n#endif\n#if DEBUGMODE>0\n#ifdef CLEARCOAT_BUMP\nmat3 TBNClearCoat;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nvec2 clearCoatMapData;\n#endif\n#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\nvec4 clearCoatTintMapData;\n#endif\n#ifdef REFLECTION\nvec4 environmentClearCoatRadiance;vec3 clearCoatEnvironmentReflectance;\n#endif\nfloat clearCoatNdotV;\n#endif\n};\n#ifdef CLEARCOAT\n#define pbr_inline\n#define inline\nvoid clearcoatBlock(\nin vec3 vPositionW,\nin vec3 geometricNormalW,\nin vec3 viewDirectionW,\nin vec2 vClearCoatParams,\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nin vec4 clearCoatMapRoughnessData,\n#endif\nin vec3 specularEnvironmentR0,\n#ifdef CLEARCOAT_TEXTURE\nin vec2 clearCoatMapData,\n#endif\n#ifdef CLEARCOAT_TINT\nin vec4 vClearCoatTintParams,\nin float clearCoatColorAtDistance,\nin vec4 vClearCoatRefractionParams,\n#ifdef CLEARCOAT_TINT_TEXTURE\nin vec4 clearCoatTintMapData,\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\nin vec2 vClearCoatBumpInfos,\nin vec4 clearCoatBumpMapData,\nin vec2 vClearCoatBumpUV,\n#if defined(TANGENT) && defined(NORMAL)\nin mat3 vTBN,\n#else\nin vec2 vClearCoatTangentSpaceParams,\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nin mat4 normalMatrix,\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nin vec3 faceNormal,\n#endif\n#ifdef REFLECTION\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\nin vec4 vLightingIntensity,\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\n#else\nin sampler2D reflectionSampler,\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\nin float ambientMonochrome,\n#endif\n#endif\n#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\nin float frontFacingMultiplier,\n#endif\nout clearcoatOutParams outParams\n)\n{float clearCoatIntensity=vClearCoatParams.x;float clearCoatRoughness=vClearCoatParams.y;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE\nclearCoatRoughness*=clearCoatMapData.y;\n#endif\n#if DEBUGMODE>0\noutParams.clearCoatMapData=clearCoatMapData;\n#endif\n#endif\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL\nclearCoatRoughness*=clearCoatMapData.y;\n#else\nclearCoatRoughness*=clearCoatMapRoughnessData.y;\n#endif\n#endif\noutParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;\n#ifdef CLEARCOAT_TINT\nvec3 clearCoatColor=vClearCoatTintParams.rgb;float clearCoatThickness=vClearCoatTintParams.a;\n#ifdef CLEARCOAT_TINT_TEXTURE\n#ifdef CLEARCOAT_TINT_GAMMATEXTURE\nclearCoatColor*=toLinearSpace(clearCoatTintMapData.rgb);\n#else\nclearCoatColor*=clearCoatTintMapData.rgb;\n#endif\nclearCoatThickness*=clearCoatTintMapData.a;\n#if DEBUGMODE>0\noutParams.clearCoatTintMapData=clearCoatTintMapData;\n#endif\n#endif\noutParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;\n#endif\n#ifdef CLEARCOAT_REMAP_F0\nvec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);\n#else\nvec3 specularEnvironmentR0Updated=specularEnvironmentR0;\n#endif\noutParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);vec3 clearCoatNormalW=geometricNormalW;\n#ifdef CLEARCOAT_BUMP\n#ifdef NORMALXYSCALE\nfloat clearCoatNormalScale=1.0;\n#else\nfloat clearCoatNormalScale=vClearCoatBumpInfos.y;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBNClearCoat=vTBN;\n#else\nvec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;mat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);\n#endif\n#if DEBUGMODE>0\noutParams.TBNClearCoat=TBNClearCoat;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nclearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);\n#else\nclearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nclearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nclearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;\n#endif\noutParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);float clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);float clearCoatNdotV=absEps(clearCoatNdotVUnclamped);\n#if DEBUGMODE>0\noutParams.clearCoatNdotV=clearCoatNdotV;\n#endif\n#ifdef CLEARCOAT_TINT\nvec3 clearCoatVRefract=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));\n#endif\n#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))\nvec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);\n#endif\n#if defined(REFLECTION)\nfloat clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);\n#ifdef SPECULARAA\nclearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;\n#endif\nvec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);vec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nclearCoatReflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvec3 clearCoatReflectionCoords=clearCoatReflectionVector;\n#else\nvec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nclearCoatReflectionCoords/=clearCoatReflectionVector.z;\n#endif\nclearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;\n#endif\nsampleReflectionTexture(\nclearCoatAlphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nclearCoatNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nclearCoatRoughness,\n#endif\nreflectionSampler,\nclearCoatReflectionCoords,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentClearCoatRadiance\n);\n#if DEBUGMODE>0\noutParams.environmentClearCoatRadiance=environmentClearCoatRadiance;\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nfloat clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;\n#endif\n#endif\n#endif\n#else\nvec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));\n#endif\nclearCoatEnvironmentReflectance*=clearCoatIntensity;\n#if DEBUGMODE>0\noutParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;\n#endif\noutParams.finalClearCoatRadianceScaled=\nenvironmentClearCoatRadiance.rgb *\nclearCoatEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(CLEARCOAT_TINT)\noutParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);\n#endif\nfloat fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\noutParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);\n#endif\n}\n#endif\n";nt.IncludesShadersStore.pbrBlockIridescence="struct iridescenceOutParams\n{float iridescenceIntensity;float iridescenceIOR;float iridescenceThickness;vec3 specularEnvironmentR0;};\n#ifdef IRIDESCENCE\n#define pbr_inline\n#define inline\nvoid iridescenceBlock(\nin vec4 vIridescenceParams,\nin float viewAngle,\nin vec3 specularEnvironmentR0,\n#ifdef IRIDESCENCE_TEXTURE\nin vec2 iridescenceMapData,\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nin vec2 iridescenceThicknessMapData,\n#endif\n#ifdef CLEARCOAT\nin float NdotVUnclamped,\n#ifdef CLEARCOAT_TEXTURE\nin vec2 clearCoatMapData,\n#endif\n#endif\nout iridescenceOutParams outParams\n)\n{float iridescenceIntensity=vIridescenceParams.x;float iridescenceIOR=vIridescenceParams.y;float iridescenceThicknessMin=vIridescenceParams.z;float iridescenceThicknessMax=vIridescenceParams.w;float iridescenceThicknessWeight=1.;\n#ifdef IRIDESCENCE_TEXTURE\niridescenceIntensity*=iridescenceMapData.x;\n#ifdef IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE\niridescenceThicknessWeight=iridescenceMapData.g;\n#endif\n#endif\n#if defined(IRIDESCENCE_THICKNESS_TEXTURE)\niridescenceThicknessWeight=iridescenceThicknessMapData.g;\n#endif\nfloat iridescenceThickness=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);float topIor=1.; \n#ifdef CLEARCOAT\nfloat clearCoatIntensity=vClearCoatParams.x;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#endif\ntopIor=mix(1.0,vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+square(1.0/topIor)*(square(NdotVUnclamped)-1.0));\n#endif\nvec3 iridescenceFresnel=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;}\n#endif\n";nt.IncludesShadersStore.pbrBlockSubSurface="struct subSurfaceOutParams\n{vec3 specularEnvironmentReflectance;\n#ifdef SS_REFRACTION\nvec3 finalRefraction;vec3 surfaceAlbedo;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nfloat alpha;\n#endif\n#ifdef REFLECTION\nfloat refractionFactorForIrradiance;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nvec3 transmittance;float translucencyIntensity;\n#ifdef REFLECTION\nvec3 refractionIrradiance;\n#endif\n#endif\n#if DEBUGMODE>0\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec4 thicknessMap;\n#endif\n#ifdef SS_REFRACTION\nvec4 environmentRefraction;vec3 refractionTransmittance;\n#endif\n#endif\n};\n#ifdef SUBSURFACE\n#define pbr_inline\n#define inline\n#ifdef SS_REFRACTION\nvec4 sampleEnvironmentRefraction(\nin float ior\n,in float thickness\n,in float refractionLOD\n,in vec3 normalW\n,in vec3 vPositionW\n,in vec3 viewDirectionW\n,in mat4 view\n,in vec4 vRefractionInfos\n,in mat4 refractionMatrix\n,in vec4 vRefractionMicrosurfaceInfos\n,in float alphaG\n#ifdef SS_REFRACTIONMAP_3D\n,in samplerCube refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,in samplerCube refractionSamplerLow\n,in samplerCube refractionSamplerHigh\n#endif\n#else\n,in sampler2D refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,in sampler2D refractionSamplerLow\n,in sampler2D refractionSamplerHigh\n#endif\n#endif\n#ifdef ANISOTROPIC\n,in anisotropicOutParams anisotropicOut\n#endif\n#ifdef REALTIME_FILTERING\n,in vec2 vRefractionFilteringInfo\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,in vec3 refractionPosition\n,in vec3 refractionSize\n#endif\n) {vec4 environmentRefraction=vec4(0.,0.,0.,0.);\n#ifdef ANISOTROPIC\nvec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,ior);\n#else\nvec3 refractionVector=refract(-viewDirectionW,normalW,ior);\n#endif\n#ifdef SS_REFRACTIONMAP_OPPOSITEZ\nrefractionVector.z*=-1.0;\n#endif\n#ifdef SS_REFRACTIONMAP_3D\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;vec3 refractionCoords=refractionVector;refractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));\n#else\n#ifdef SS_USE_THICKNESS_AS_DEPTH\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*thickness,1.0)));\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\n#endif\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;\n#endif\n#ifdef LODBASEDMICROSFURACE\nrefractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;\n#ifdef SS_LODINREFRACTIONALPHA\nfloat automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);float requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);\n#else\nfloat requestedRefractionLOD=refractionLOD;\n#endif\n#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)\nenvironmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);\n#else\nenvironmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);\n#endif\n#else\nfloat lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));float lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;vec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(\nsampleRefraction(refractionSamplerHigh,refractionCoords),\nenvironmentRefractionMid,\nlodRefractionNormalizedDoubled\n);} else {environmentRefraction=mix(\nenvironmentRefractionMid,\nsampleRefraction(refractionSamplerLow,refractionCoords),\nlodRefractionNormalizedDoubled-1.0\n);}\n#endif\n#ifdef SS_RGBDREFRACTION\nenvironmentRefraction.rgb=fromRGBD(environmentRefraction);\n#endif\n#ifdef SS_GAMMAREFRACTION\nenvironmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);\n#endif\nreturn environmentRefraction;}\n#endif\nvoid subSurfaceBlock(\nin vec3 vSubSurfaceIntensity,\nin vec2 vThicknessParam,\nin vec4 vTintColor,\nin vec3 normalW,\nin vec3 specularEnvironmentReflectance,\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nin vec4 thicknessMap,\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nin vec4 refractionIntensityMap,\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nin vec4 translucencyIntensityMap,\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\nin mat4 reflectionMatrix,\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nin vec3 irradianceVector_,\n#endif\n#if defined(REALTIME_FILTERING)\nin samplerCube reflectionSampler,\nin vec2 vReflectionFilteringInfo,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\nin samplerCube irradianceSampler,\n#else\nin sampler2D irradianceSampler,\n#endif\n#endif\n#endif\n#endif\n#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\nin vec3 surfaceAlbedo,\n#endif\n#ifdef SS_REFRACTION\nin vec3 vPositionW,\nin vec3 viewDirectionW,\nin mat4 view,\nin vec4 vRefractionInfos,\nin mat4 refractionMatrix,\nin vec4 vRefractionMicrosurfaceInfos,\nin vec4 vLightingIntensity,\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nin float alpha,\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nin float NdotVUnclamped,\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\nin float roughness,\n#endif\nin float alphaG,\n#ifdef SS_REFRACTIONMAP_3D\nin samplerCube refractionSampler,\n#ifndef LODBASEDMICROSFURACE\nin samplerCube refractionSamplerLow,\nin samplerCube refractionSamplerHigh,\n#endif\n#else\nin sampler2D refractionSampler,\n#ifndef LODBASEDMICROSFURACE\nin sampler2D refractionSamplerLow,\nin sampler2D refractionSamplerHigh,\n#endif\n#endif\n#ifdef ANISOTROPIC\nin anisotropicOutParams anisotropicOut,\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vRefractionFilteringInfo,\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\nin vec3 refractionPosition,\nin vec3 refractionSize,\n#endif\n#ifdef SS_DISPERSION\nin float dispersion,\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nin vec3 vDiffusionDistance,\n#endif\nout subSurfaceOutParams outParams\n)\n{outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;\n#ifdef SS_REFRACTION\nfloat refractionIntensity=vSubSurfaceIntensity.x;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nrefractionIntensity*=(1.0-alpha);outParams.alpha=1.0;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nfloat translucencyIntensity=vSubSurfaceIntensity.y;\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n#if defined(SS_USE_GLTF_TEXTURES)\nfloat thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;\n#else\nfloat thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;\n#endif\n#if DEBUGMODE>0\noutParams.thicknessMap=thicknessMap;\n#endif\n#ifdef SS_MASK_FROM_THICKNESS_TEXTURE\n#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE)\n#if defined(SS_USE_GLTF_TEXTURES)\nrefractionIntensity*=thicknessMap.r;\n#else\nrefractionIntensity*=thicknessMap.g;\n#endif\n#endif\n#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE)\ntranslucencyIntensity*=thicknessMap.b;\n#endif\n#endif\n#else\nfloat thickness=vThicknessParam.y;\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\n#ifdef SS_USE_GLTF_TEXTURES\nrefractionIntensity*=refractionIntensityMap.r;\n#else\nrefractionIntensity*=refractionIntensityMap.g;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\ntranslucencyIntensity*=translucencyIntensityMap.b;\n#endif\n#ifdef SS_TRANSLUCENCY\nthickness=maxEps(thickness);vec3 transmittance=transmittanceBRDF_Burley(vTintColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;\n#endif\n#ifdef SS_REFRACTION\nvec4 environmentRefraction=vec4(0.,0.,0.,0.);\n#ifdef SS_HAS_THICKNESS\nfloat ior=vRefractionInfos.y;\n#else\nfloat ior=vRefractionMicrosurfaceInfos.w;\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nfloat refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);\n#elif defined(SS_LINEARSPECULARREFRACTION)\nfloat refractionRoughness=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);\n#else\nfloat refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);\n#endif\n#ifdef SS_DISPERSION\nfloat realIOR=1.0/ior;float iorDispersionSpread=0.04*dispersion*(realIOR-1.0);vec3 iors=vec3(1.0/(realIOR-iorDispersionSpread),ior,1.0/(realIOR+iorDispersionSpread));for (int i=0; i<3; i++) {ior=iors[i];\n#endif\nvec4 envSample=sampleEnvironmentRefraction(ior,thickness,refractionLOD,normalW,vPositionW,viewDirectionW,view,vRefractionInfos,refractionMatrix,vRefractionMicrosurfaceInfos,alphaG\n#ifdef SS_REFRACTIONMAP_3D\n,refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,refractionSamplerLow\n,refractionSamplerHigh\n#endif\n#else\n,refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,refractionSamplerLow\n,refractionSamplerHigh\n#endif\n#endif\n#ifdef ANISOTROPIC\n,anisotropicOut\n#endif\n#ifdef REALTIME_FILTERING\n,vRefractionFilteringInfo\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,refractionPosition\n,refractionSize\n#endif\n);\n#ifdef SS_DISPERSION\nenvironmentRefraction[i]=envSample[i];}\n#else\nenvironmentRefraction=envSample;\n#endif\nenvironmentRefraction.rgb*=vRefractionInfos.x;\n#endif\n#ifdef SS_REFRACTION\nvec3 refractionTransmittance=vec3(refractionIntensity);\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,thickness);\n#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)\nfloat maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);vec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);environmentRefraction.rgb*=volumeAlbedo;\n#else\nvec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);\n#endif\n#ifdef SS_ALBEDOFORREFRACTIONTINT\nenvironmentRefraction.rgb*=surfaceAlbedo.rgb;\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);\n#ifdef REFLECTION\noutParams.refractionFactorForIrradiance=(1.-refractionIntensity);\n#endif\n#ifdef UNUSED_MULTIPLEBOUNCES\nvec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);\n#endif\nrefractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;\n#if DEBUGMODE>0\noutParams.refractionTransmittance=refractionTransmittance;\n#endif\noutParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;\n#if DEBUGMODE>0\noutParams.environmentRefraction=environmentRefraction;\n#endif\n#endif\n#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#else\nvec3 irradianceVector=irradianceVector_;\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP)\n#if defined(REALTIME_FILTERING)\nvec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo);\n#else\nvec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);\n#endif\n#elif defined(USEIRRADIANCEMAP)\n#ifdef REFLECTIONMAP_3D\nvec3 irradianceCoords=irradianceVector;\n#else\nvec2 irradianceCoords=irradianceVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nirradianceCoords/=irradianceVector.z;\n#endif\nirradianceCoords.y=1.0-irradianceCoords.y;\n#endif\nvec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);\n#ifdef RGBDREFLECTION\nrefractionIrradiance.rgb=fromRGBD(refractionIrradiance);\n#endif\n#ifdef GAMMAREFLECTION\nrefractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);\n#endif\n#else\nvec4 refractionIrradiance=vec4(0.);\n#endif\nrefractionIrradiance.rgb*=transmittance;\n#ifdef SS_ALBEDOFORTRANSLUCENCYTINT\nrefractionIrradiance.rgb*=surfaceAlbedo.rgb;\n#endif\noutParams.refractionIrradiance=refractionIrradiance.rgb;\n#endif\n}\n#endif\n";nt.IncludesShadersStore.pbrBlockNormalGeometric="vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#endif\nvec3 geometricNormalW=normalW;\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\ngeometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;\n#endif\n";nt.IncludesShadersStore.pbrBlockNormalFinal="#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nvec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#if defined(TWOSIDEDLIGHTING)\nfaceNormal=gl_FrontFacing ? faceNormal : -faceNormal;\n#endif\nnormalW*=sign(dot(normalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n";nt.IncludesShadersStore.pbrBlockLightmapInit="#ifdef LIGHTMAP\nvec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor.rgb=fromRGBD(lightmapColor);\n#endif\n#ifdef GAMMALIGHTMAP\nlightmapColor.rgb=toLinearSpace(lightmapColor.rgb);\n#endif\nlightmapColor.rgb*=vLightmapInfos.y;\n#endif\n";nt.IncludesShadersStore.pbrBlockGeometryInfo="float NdotVUnclamped=dot(normalW,viewDirectionW);float NdotV=absEps(NdotVUnclamped);float alphaG=convertRoughnessToAverageSlope(roughness);vec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);\n#ifdef SPECULARAA\nalphaG+=AARoughnessFactors.y;\n#endif\n#if defined(ENVIRONMENTBRDF)\nvec3 environmentBrdf=getBRDFLookup(NdotV,roughness);\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\n#ifdef AMBIENTINGRAYSCALE\nfloat ambientMonochrome=aoOut.ambientOcclusionColor.r;\n#else\nfloat ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);\n#endif\nfloat seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nfloat eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);\n#endif\n#endif\n#endif\n#endif\n";nt.IncludesShadersStore.pbrBlockReflectance0="float reflectance=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);vec3 specularEnvironmentR0=reflectivityOut.surfaceReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvec3 specularEnvironmentR90=vec3(metallicReflectanceFactors.a);\n#else \nvec3 specularEnvironmentR90=vec3(1.0,1.0,1.0);\n#endif\n#ifdef ALPHAFRESNEL\nfloat reflectance90=fresnelGrazingReflectance(reflectance);specularEnvironmentR90=specularEnvironmentR90*reflectance90;\n#endif\n";nt.IncludesShadersStore.pbrBlockReflectance="#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvec3 specularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);\n#ifdef RADIANCEOCCLUSION\nspecularEnvironmentReflectance*=seo;\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nspecularEnvironmentReflectance*=eho;\n#endif\n#endif\n#endif\n#else\nvec3 specularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));\n#endif\n#ifdef CLEARCOAT\nspecularEnvironmentReflectance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nspecularEnvironmentReflectance*=clearcoatOut.absorption;\n#endif\n#endif\n";nt.IncludesShadersStore.pbrBlockDirectLighting="vec3 diffuseBase=vec3(0.,0.,0.);\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\n#ifdef CLEARCOAT\nvec3 clearCoatBase=vec3(0.,0.,0.);\n#endif\n#ifdef SHEEN\nvec3 sheenBase=vec3(0.,0.,0.);\n#endif\npreLightingInfo preInfo;lightingInfo info;float shadow=1.; \nfloat aggShadow=0.;float numLights=0.;\n#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\nvec3 absorption=vec3(0.);\n#endif\n";nt.IncludesShadersStore.pbrBlockFinalLitComponents="aggShadow=aggShadow/numLights;\n#if defined(ENVIRONMENTBRDF)\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nvec3 energyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);\n#endif\n#endif\n#ifndef METALLICWORKFLOW\n#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION\nsurfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;\n#endif\n#endif\n#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)\nsurfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;\n#endif\n#ifdef REFLECTION\nvec3 finalIrradiance=reflectionOut.environmentIrradiance;\n#if defined(CLEARCOAT)\nfinalIrradiance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nfinalIrradiance*=clearcoatOut.absorption;\n#endif\n#endif\n#if defined(SS_REFRACTION)\nfinalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;\n#endif\n#if defined(SS_TRANSLUCENCY)\nfinalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;\n#endif\nfinalIrradiance*=surfaceAlbedo.rgb;finalIrradiance*=vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase;finalSpecular=max(finalSpecular,0.0);vec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalSpecularScaled*=energyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalSpecularScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n#ifdef REFLECTION\nvec3 finalRadiance=reflectionOut.environmentRadiance.rgb;finalRadiance*=subSurfaceOut.specularEnvironmentReflectance;vec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalRadianceScaled*=energyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalRadianceScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n#ifdef SHEEN\nvec3 finalSheen=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,0.0);vec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n#ifdef CLEARCOAT\nvec3 finalClearCoat=clearCoatBase;finalClearCoat=max(finalClearCoat,0.0);vec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;\n#ifdef CLEARCOAT_TINT\nsubSurfaceOut.finalRefraction*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n#ifdef ALPHABLEND\nfloat luminanceOverAlpha=0.0;\n#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalRadianceScaled);\n#if defined(CLEARCOAT)\nluminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);\n#endif\n#endif\n#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)\nluminanceOverAlpha+=getLuminance(finalSpecularScaled);\n#endif\n#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalClearCoatScaled);\n#endif\n#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)\nalpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);\n#endif\n#endif\n";nt.IncludesShadersStore.pbrBlockFinalUnlitComponents="vec3 finalDiffuse=diffuseBase;finalDiffuse*=surfaceAlbedo.rgb;finalDiffuse=max(finalDiffuse,0.0);finalDiffuse*=vLightingIntensity.x;vec3 finalAmbient=vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;vec3 finalEmissive=vEmissiveColor;\n#ifdef EMISSIVE\nvec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;\n#ifdef GAMMAEMISSIVE\nfinalEmissive*=toLinearSpace(emissiveColorTex.rgb);\n#else\nfinalEmissive*=emissiveColorTex.rgb;\n#endif\nfinalEmissive*= vEmissiveInfos.y;\n#endif\nfinalEmissive*=vLightingIntensity.y;\n#ifdef AMBIENT\nvec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);\n#else\nvec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;\n#endif\nfinalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;\n";nt.IncludesShadersStore.pbrBlockFinalColorComposition="vec4 finalColor=vec4(\n#ifndef UNLIT\n#ifdef REFLECTION\nfinalIrradiance +\n#endif\n#ifdef SPECULARTERM\nfinalSpecularScaled +\n#endif\n#ifdef SHEEN\nfinalSheenScaled +\n#endif\n#ifdef CLEARCOAT\nfinalClearCoatScaled +\n#endif\n#ifdef REFLECTION\nfinalRadianceScaled +\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled +\n#endif\n#ifdef CLEARCOAT\nclearcoatOut.finalClearCoatRadianceScaled +\n#endif\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction +\n#endif\n#endif\nfinalAmbient +\nfinalDiffuse,\nalpha);\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\nfinalColor.rgb*=lightmapColor.rgb;\n#else\nfinalColor.rgb+=lightmapColor.rgb;\n#endif\n#endif\n#endif\nfinalColor.rgb+=finalEmissive;\n#define CUSTOM_FRAGMENT_BEFORE_FOG\nfinalColor=max(finalColor,0.0);\n";nt.IncludesShadersStore.pbrBlockImageProcessing="#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)\n#if !defined(SKIPFINALCOLORCLAMP)\nfinalColor.rgb=clamp(finalColor.rgb,0.,30.0);\n#endif\n#else\nfinalColor=applyImageProcessing(finalColor);\n#endif\nfinalColor.a*=visibility;\n#ifdef PREMULTIPLYALPHA\nfinalColor.rgb*=finalColor.a;\n#endif\n";nt.IncludesShadersStore.pbrDebug="#if DEBUGMODE>0\nif (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {\n#if DEBUGMODE==1\ngl_FragColor.rgb=vPositionW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==2 && defined(NORMAL)\ngl_FragColor.rgb=vNormalW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)\ngl_FragColor.rgb=TBN[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)\ngl_FragColor.rgb=TBN[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==5\ngl_FragColor.rgb=normalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==6 && defined(MAINUV1)\ngl_FragColor.rgb=vec3(vMainUV1,0.0);\n#elif DEBUGMODE==7 && defined(MAINUV2)\ngl_FragColor.rgb=vec3(vMainUV2,0.0);\n#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\ngl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\ngl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==10 && defined(CLEARCOAT)\ngl_FragColor.rgb=clearcoatOut.clearCoatNormalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==11 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicNormal;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==12 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicTangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==13 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicBitangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==20 && defined(ALBEDO)\ngl_FragColor.rgb=albedoTexture.rgb;\n#ifndef GAMMAALBEDO\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==21 && defined(AMBIENT)\ngl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;\n#elif DEBUGMODE==22 && defined(OPACITY)\ngl_FragColor.rgb=opacityMap.rgb;\n#elif DEBUGMODE==23 && defined(EMISSIVE)\ngl_FragColor.rgb=emissiveColorTex.rgb;\n#ifndef GAMMAEMISSIVE\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==24 && defined(LIGHTMAP)\ngl_FragColor.rgb=lightmapColor.rgb;\n#ifndef GAMMALIGHTMAP\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;\n#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);\n#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\ngl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;\n#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)\ngl_FragColor.rgb=sheenOut.sheenMapData.rgb;\n#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)\ngl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;\n#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)\ngl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;\n#elif DEBUGMODE==32 && defined(BUMP)\ngl_FragColor.rgb=texture2D(bumpSampler,vBumpUV).rgb;\n#elif DEBUGMODE==40 && defined(SS_REFRACTION)\ngl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==41 && defined(REFLECTION)\ngl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;\n#ifndef GAMMAREFLECTION\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)\ngl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==50\ngl_FragColor.rgb=diffuseBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==51 && defined(SPECULARTERM)\ngl_FragColor.rgb=specularBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==52 && defined(CLEARCOAT)\ngl_FragColor.rgb=clearCoatBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==53 && defined(SHEEN)\ngl_FragColor.rgb=sheenBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==54 && defined(REFLECTION)\ngl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;\n#ifndef GAMMAREFLECTION\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==60\ngl_FragColor.rgb=surfaceAlbedo.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==61\ngl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=vec3(reflectivityOut.metallicRoughness.r);\n#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.metallicF0;\n#elif DEBUGMODE==63\ngl_FragColor.rgb=vec3(roughness);\n#elif DEBUGMODE==64\ngl_FragColor.rgb=vec3(alphaG);\n#elif DEBUGMODE==65\ngl_FragColor.rgb=vec3(NdotV);\n#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\ngl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==67 && defined(CLEARCOAT)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);\n#elif DEBUGMODE==68 && defined(CLEARCOAT)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);\n#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)\ngl_FragColor.rgb=subSurfaceOut.transmittance;\n#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)\ngl_FragColor.rgb=subSurfaceOut.refractionTransmittance;\n#elif DEBUGMODE==72\ngl_FragColor.rgb=vec3(microSurface);\n#elif DEBUGMODE==73\ngl_FragColor.rgb=vAlbedoColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)\ngl_FragColor.rgb=vReflectivityColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==75\ngl_FragColor.rgb=vEmissiveColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)\ngl_FragColor.rgb=vec3(seo);\n#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION)\ngl_FragColor.rgb=vec3(eho);\n#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)\ngl_FragColor.rgb=vec3(energyConservationFactor);\n#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ngl_FragColor.rgb=specularEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ngl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)\ngl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==86 && defined(ALPHABLEND)\ngl_FragColor.rgb=vec3(luminanceOverAlpha);\n#elif DEBUGMODE==87\ngl_FragColor.rgb=vec3(alpha);\n#elif DEBUGMODE==88 && defined(ALBEDO)\ngl_FragColor.rgb=vec3(albedoTexture.a);\n#else\nfloat stripeWidth=30.;float stripePos=floor((gl_FragCoord.x+gl_FragCoord.y)/stripeWidth);float whichColor=mod(stripePos,2.);vec3 color1=vec3(.6,.2,.2);vec3 color2=vec3(.3,.1,.1);gl_FragColor.rgb=mix(color1,color2,whichColor);\n#endif\ngl_FragColor.rgb*=vDebugMode.y;\n#ifdef DEBUGMODE_NORMALIZE\ngl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;\n#endif\n#ifdef DEBUGMODE_GAMMA\ngl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);\n#endif\ngl_FragColor.a=1.0;\n#ifdef PREPASS\ngl_FragData[0]=toLinearSpace(gl_FragColor); \ngl_FragData[1]=vec4(0.,0.,0.,0.); \n#endif\n#ifdef DEBUGMODE_FORCERETURN\nreturn;\n#endif\n}\n#endif\n";nt.ShadersStore.pbrPixelShader="#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#ifdef LODBASEDMICROSFURACE\n#extension GL_EXT_shader_texture_lod : enable\n#endif\n#define CUSTOM_FRAGMENT_BEGIN\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\nprecision highp float;\n#include<oitDeclaration>\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE\n#endif\n#include<__decl__pbrFragment>\n#include<pbrFragmentExtraDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<pbrFragmentSamplersDeclaration>\n#include<imageProcessingDeclaration>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#include<helperFunctions>\n#include<subSurfaceScatteringFunctions>\n#include<importanceSampling>\n#include<pbrHelperFunctions>\n#include<imageProcessingFunctions>\n#include<shadowsFragmentFunctions>\n#include<harmonicsFunctions>\n#include<pbrDirectLightingSetupFunctions>\n#include<pbrDirectLightingFalloffFunctions>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\n#include<pbrDirectLightingFunctions>\n#include<pbrIBLFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#ifdef REFLECTION\n#include<reflectionFunction>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#include<pbrBlockAlbedoOpacity>\n#include<pbrBlockReflectivity>\n#include<pbrBlockAmbientOcclusion>\n#include<pbrBlockAlphaFresnel>\n#include<pbrBlockAnisotropic>\n#include<pbrBlockReflection>\n#include<pbrBlockSheen>\n#include<pbrBlockClearcoat>\n#include<pbrBlockIridescence>\n#include<pbrBlockSubSurface>\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#include<pbrBlockNormalGeometric>\n#include<bumpFragment>\n#include<pbrBlockNormalFinal>\nalbedoOpacityOutParams albedoOpacityOut;\n#ifdef ALBEDO\nvec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#endif\n#ifdef DECAL\nvec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);\n#endif\nalbedoOpacityBlock(\nvAlbedoColor,\n#ifdef ALBEDO\nalbedoTexture,\nvAlbedoInfos,\n#endif\n#ifdef OPACITY\nopacityMap,\nvOpacityInfos,\n#endif\n#ifdef DETAIL\ndetailColor,\nvDetailInfos,\n#endif\n#ifdef DECAL\ndecalColor,\nvDecalInfos,\n#endif\nalbedoOpacityOut\n);vec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;float alpha=albedoOpacityOut.alpha;\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\n#include<depthPrePass>\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\nambientOcclusionOutParams aoOut;\n#ifdef AMBIENT\nvec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;\n#endif\nambientOcclusionBlock(\n#ifdef AMBIENT\nambientOcclusionColorMap,\nvAmbientInfos,\n#endif\naoOut\n);\n#include<pbrBlockLightmapInit>\n#ifdef UNLIT\nvec3 diffuseBase=vec3(1.,1.,1.);\n#else\nvec3 baseColor=surfaceAlbedo;reflectivityOutParams reflectivityOut;\n#if defined(REFLECTIVITY)\nvec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);vec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;\n#ifndef METALLICWORKFLOW\n#ifdef REFLECTIVITY_GAMMA\nsurfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);\n#endif\nsurfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;\n#endif\n#endif\n#if defined(MICROSURFACEMAP)\nvec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;\n#endif\n#ifdef METALLICWORKFLOW\nvec4 metallicReflectanceFactors=vMetallicReflectanceFactors;\n#ifdef REFLECTANCE\nvec4 reflectanceFactorsMap=texture2D(reflectanceSampler,vReflectanceUV+uvOffset);\n#ifdef REFLECTANCE_GAMMA\nreflectanceFactorsMap=toLinearSpace(reflectanceFactorsMap);\n#endif\nmetallicReflectanceFactors.rgb*=reflectanceFactorsMap.rgb;\n#endif\n#ifdef METALLIC_REFLECTANCE\nvec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);\n#ifdef METALLIC_REFLECTANCE_GAMMA\nmetallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);\n#endif\n#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY\nmetallicReflectanceFactors.rgb*=metallicReflectanceFactorsMap.rgb;\n#endif\nmetallicReflectanceFactors*=metallicReflectanceFactorsMap.a;\n#endif\n#endif\nreflectivityBlock(\nvReflectivityColor,\n#ifdef METALLICWORKFLOW\nsurfaceAlbedo,\nmetallicReflectanceFactors,\n#endif\n#ifdef REFLECTIVITY\nvReflectivityInfos,\nsurfaceMetallicOrReflectivityColorMap,\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\naoOut.ambientOcclusionColor,\n#endif\n#ifdef MICROSURFACEMAP\nmicroSurfaceTexel,\n#endif\n#ifdef DETAIL\ndetailColor,\nvDetailInfos,\n#endif\nreflectivityOut\n);float microSurface=reflectivityOut.microSurface;float roughness=reflectivityOut.roughness;\n#ifdef METALLICWORKFLOW\nsurfaceAlbedo=reflectivityOut.surfaceAlbedo;\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\naoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;\n#endif\n#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nalphaFresnelOutParams alphaFresnelOut;alphaFresnelBlock(\nnormalW,\nviewDirectionW,\nalpha,\nmicroSurface,\nalphaFresnelOut\n);alpha=alphaFresnelOut.alpha;\n#endif\n#endif\n#include<pbrBlockGeometryInfo>\n#ifdef ANISOTROPIC\nanisotropicOutParams anisotropicOut;\n#ifdef ANISOTROPIC_TEXTURE\nvec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;\n#endif\nanisotropicBlock(\nvAnisotropy,\nroughness,\n#ifdef ANISOTROPIC_TEXTURE\nanisotropyMapData,\n#endif\nTBN,\nnormalW,\nviewDirectionW,\nanisotropicOut\n);\n#endif\n#ifdef REFLECTION\nreflectionOutParams reflectionOut;\n#ifndef USE_CUSTOM_REFLECTION\nreflectionBlock(\nvPositionW,\nnormalW,\nalphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nroughness,\n#endif\nreflectionSampler,\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nvEnvironmentIrradiance,\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nreflectionMatrix,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\nirradianceSampler,\n#endif\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nreflectionOut\n);\n#else\n#define CUSTOM_REFLECTION\n#endif\n#endif\n#include<pbrBlockReflectance0>\n#ifdef SHEEN\nsheenOutParams sheenOut;\n#ifdef SHEEN_TEXTURE\nvec4 sheenMapData=texture2D(sheenSampler,vSheenUV+uvOffset);\n#endif\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;\n#endif\nsheenBlock(\nvSheenColor,\n#ifdef SHEEN_ROUGHNESS\nvSheenRoughness,\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nsheenMapRoughnessData,\n#endif\n#endif\nroughness,\n#ifdef SHEEN_TEXTURE\nsheenMapData,\nvSheenInfos.y,\n#endif\nreflectance,\n#ifdef SHEEN_LINKWITHALBEDO\nbaseColor,\nsurfaceAlbedo,\n#endif\n#ifdef ENVIRONMENTBRDF\nNdotV,\nenvironmentBrdf,\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nAARoughnessFactors,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\nvLightingIntensity,\nreflectionSampler,\nreflectionOut.reflectionCoords,\nNdotVUnclamped,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nseo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\neho,\n#endif\n#endif\nsheenOut\n);\n#ifdef SHEEN_LINKWITHALBEDO\nsurfaceAlbedo=sheenOut.surfaceAlbedo;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifdef CLEARCOAT_TEXTURE\nvec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;\n#endif\n#endif\n#ifdef IRIDESCENCE\niridescenceOutParams iridescenceOut;\n#ifdef IRIDESCENCE_TEXTURE\nvec2 iridescenceMapData=texture2D(iridescenceSampler,vIridescenceUV+uvOffset).rg*vIridescenceInfos.y;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nvec2 iridescenceThicknessMapData=texture2D(iridescenceThicknessSampler,vIridescenceThicknessUV+uvOffset).rg*vIridescenceInfos.w;\n#endif\niridescenceBlock(\nvIridescenceParams,\nNdotV,\nspecularEnvironmentR0,\n#ifdef IRIDESCENCE_TEXTURE\niridescenceMapData,\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\niridescenceThicknessMapData,\n#endif\n#ifdef CLEARCOAT\nNdotVUnclamped,\n#ifdef CLEARCOAT_TEXTURE\nclearCoatMapData,\n#endif\n#endif\niridescenceOut\n);float iridescenceIntensity=iridescenceOut.iridescenceIntensity;specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;\n#endif\nclearcoatOutParams clearcoatOut;\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;\n#endif\n#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\nvec4 clearCoatTintMapData=texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset);\n#endif\n#ifdef CLEARCOAT_BUMP\nvec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);\n#endif\nclearcoatBlock(\nvPositionW,\ngeometricNormalW,\nviewDirectionW,\nvClearCoatParams,\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nclearCoatMapRoughnessData,\n#endif\nspecularEnvironmentR0,\n#ifdef CLEARCOAT_TEXTURE\nclearCoatMapData,\n#endif\n#ifdef CLEARCOAT_TINT\nvClearCoatTintParams,\nclearCoatColorAtDistance,\nvClearCoatRefractionParams,\n#ifdef CLEARCOAT_TINT_TEXTURE\nclearCoatTintMapData,\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\nvClearCoatBumpInfos,\nclearCoatBumpMapData,\nvClearCoatBumpUV,\n#if defined(TANGENT) && defined(NORMAL)\nvTBN,\n#else\nvClearCoatTangentSpaceParams,\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nnormalMatrix,\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nfaceNormal,\n#endif\n#ifdef REFLECTION\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\nvLightingIntensity,\nreflectionSampler,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\nambientMonochrome,\n#endif\n#endif\n#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n(gl_FrontFacing ? 1. : -1.),\n#endif\nclearcoatOut\n);\n#else\nclearcoatOut.specularEnvironmentR0=specularEnvironmentR0;\n#endif\n#include<pbrBlockReflectance>\nsubSurfaceOutParams subSurfaceOut;\n#ifdef SUBSURFACE\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nvec4 refractionIntensityMap=texture2D(refractionIntensitySampler,vRefractionIntensityUV+uvOffset);\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nvec4 translucencyIntensityMap=texture2D(translucencyIntensitySampler,vTranslucencyIntensityUV+uvOffset);\n#endif\nsubSurfaceBlock(\nvSubSurfaceIntensity,\nvThicknessParam,\nvTintColor,\nnormalW,\nspecularEnvironmentReflectance,\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nthicknessMap,\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nrefractionIntensityMap,\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\ntranslucencyIntensityMap,\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\nreflectionMatrix,\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nreflectionOut.irradianceVector,\n#endif\n#if defined(REALTIME_FILTERING)\nreflectionSampler,\nvReflectionFilteringInfo,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\nirradianceSampler,\n#endif\n#endif\n#endif\n#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\nsurfaceAlbedo,\n#endif\n#ifdef SS_REFRACTION\nvPositionW,\nviewDirectionW,\nview,\nvRefractionInfos,\nrefractionMatrix,\nvRefractionMicrosurfaceInfos,\nvLightingIntensity,\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nalpha,\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nNdotVUnclamped,\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\nroughness,\n#endif\nalphaG,\nrefractionSampler,\n#ifndef LODBASEDMICROSFURACE\nrefractionSamplerLow,\nrefractionSamplerHigh,\n#endif\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif\n#ifdef REALTIME_FILTERING\nvRefractionFilteringInfo,\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\nvRefractionPosition,\nvRefractionSize,\n#endif\n#ifdef SS_DISPERSION\ndispersion,\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nvDiffusionDistance,\n#endif\nsubSurfaceOut\n);\n#ifdef SS_REFRACTION\nsurfaceAlbedo=subSurfaceOut.surfaceAlbedo;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nalpha=subSurfaceOut.alpha;\n#endif\n#endif\n#else\nsubSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;\n#endif\n#include<pbrBlockDirectLighting>\n#include<lightFragment>[0..maxSimultaneousLights]\n#include<pbrBlockFinalLitComponents>\n#endif \n#include<pbrBlockFinalUnlitComponents>\n#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION\n#include<pbrBlockFinalColorComposition>\n#include<logDepthFragment>\n#include<fogFragment>(color,finalColor)\n#include<pbrBlockImageProcessing>\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\nfloat writeGeometryInfo=finalColor.a>0.4 ? 1.0 : 0.0;\n#ifdef PREPASS_POSITION\ngl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_VELOCITY\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\nvec3 sqAlbedo=sqrt(surfaceAlbedo); \n#endif\n#ifdef PREPASS_IRRADIANCE\nvec3 irradiance=finalDiffuse;\n#ifndef UNLIT\n#ifdef REFLECTION\nirradiance+=finalIrradiance;\n#endif\n#endif\n#ifdef SS_SCATTERING\ngl_FragData[0]=vec4(finalColor.rgb-irradiance,finalColor.a); \nirradiance/=sqAlbedo;\n#else\ngl_FragData[0]=finalColor; \nfloat scatteringDiffusionProfile=255.;\n#endif\ngl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(clamp(irradiance,vec3(0.),vec3(1.)),writeGeometryInfo*scatteringDiffusionProfile/255.); \n#else\ngl_FragData[0]=vec4(finalColor.rgb,finalColor.a);\n#endif\n#ifdef PREPASS_DEPTH\ngl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_NORMAL\n#ifdef PREPASS_NORMAL_WORLDSPACE\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo); \n#else\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo); \n#endif\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\ngl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqAlbedo,writeGeometryInfo); \n#endif\n#ifdef PREPASS_REFLECTIVITY\n#ifndef UNLIT\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularEnvironmentR0,microSurface)*writeGeometryInfo;\n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4( 0.0,0.0,0.0,1.0 )*writeGeometryInfo;\n#endif\n#endif\n#endif\n#if !defined(PREPASS) || defined(WEBGL2)\ngl_FragColor=finalColor;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {frontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);} else {backColor+=finalColor;}\n#endif\n#include<pbrDebug>\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";nt.IncludesShadersStore.pbrVertexDeclaration="uniform mat4 view;uniform mat4 viewProjection;\n#ifdef ALBEDO\nuniform mat4 albedoMatrix;uniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;uniform vec4 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;\n#endif\n#ifdef REFLECTIVITY \nuniform vec3 vReflectivityInfos;uniform mat4 reflectivityMatrix;\n#endif\n#ifdef METALLIC_REFLECTANCE\nuniform vec2 vMetallicReflectanceInfos;uniform mat4 metallicReflectanceMatrix;\n#endif\n#ifdef REFLECTANCE\nuniform vec2 vReflectanceInfos;uniform mat4 reflectanceMatrix;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;uniform mat4 microSurfaceSamplerMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform mat4 bumpMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;\n#endif\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nuniform vec4 vClearCoatInfos;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nuniform mat4 clearCoatMatrix;\n#endif\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS\nuniform mat4 clearCoatRoughnessMatrix;\n#endif\n#ifdef CLEARCOAT_BUMP\nuniform vec2 vClearCoatBumpInfos;uniform mat4 clearCoatBumpMatrix;\n#endif\n#ifdef CLEARCOAT_TINT_TEXTURE\nuniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;\n#endif\n#endif\n#ifdef IRIDESCENCE\n#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)\nuniform vec4 vIridescenceInfos;\n#endif\n#ifdef IRIDESCENCE_TEXTURE\nuniform mat4 iridescenceMatrix;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nuniform mat4 iridescenceThicknessMatrix;\n#endif\n#endif\n#ifdef ANISOTROPIC\n#ifdef ANISOTROPIC_TEXTURE\nuniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;\n#endif\n#endif\n#ifdef SHEEN\n#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)\nuniform vec4 vSheenInfos;\n#endif\n#ifdef SHEEN_TEXTURE\nuniform mat4 sheenMatrix;\n#endif\n#ifdef SHEEN_TEXTURE_ROUGHNESS\nuniform mat4 sheenRoughnessMatrix;\n#endif\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\nuniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nuniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nuniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nuniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;\n#endif\n#endif\n#ifdef NORMAL\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nuniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;\n#else\nuniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;\n#endif\n#endif\n#endif\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;uniform mat4 detailMatrix;\n#endif\n#include<decalVertexDeclaration>\n#define ADDITIONAL_VERTEX_DECLARATION\n";nt.ShadersStore.pbrVertexShader="precision highp float;\n#include<__decl__pbrVertex>\n#define CUSTOM_VERTEX_BEGIN\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)\n#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\n#ifdef CLEARCOAT\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)\n#endif\nvarying vec3 vPositionW;\n#if DEBUGMODE>0\nvarying vec4 vClipSpacePosition;\n#endif\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#include<harmonicsFunctions>\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vPositionW=vec3(worldPos);\n#include<prePassVertex>\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\nvEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#if DEBUGMODE>0\nvClipSpacePosition=gl_Position;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n#ifndef UV1\nvec2 uvUpdated=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uvUpdated;\n#endif\n#include<uvVariableDeclaration>[2..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#ifdef CLEARCOAT\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)\n#endif\n#ifdef SHEEN\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.z)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)\n#endif\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";class Ed extends $t{constructor(){super(...arguments),this.CLEARCOAT=!1,this.CLEARCOAT_DEFAULTIOR=!1,this.CLEARCOAT_TEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this.CLEARCOAT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,this.CLEARCOAT_BUMP=!1,this.CLEARCOAT_BUMPDIRECTUV=0,this.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,this.CLEARCOAT_REMAP_F0=!1,this.CLEARCOAT_TINT=!1,this.CLEARCOAT_TINT_TEXTURE=!1,this.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TINT_GAMMATEXTURE=!1}}class Sd extends Fa{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"PBRClearCoat",100,new Ed,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.roughness=0,this._indexOfRefraction=Sd._DefaultIndexOfRefraction,this.indexOfRefraction=Sd._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._textureRoughness=null,this.textureRoughness=null,this._remapF0OnInterfaceChange=!0,this.remapF0OnInterfaceChange=!0,this._bumpTexture=null,this.bumpTexture=null,this._isTintEnabled=!1,this.isTintEnabled=!1,this.tintColor=N.White(),this.tintColorAtDistance=1,this.tintThickness=1,this._tintTexture=null,this.tintTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){if(!this._isEnabled)return!0;const s=this._material._disableBumpMap;if(e._areTexturesDirty&&t.texturesEnabled){if(this._texture&&Ia.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking())return!1;if(this._textureRoughness&&Ia.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())return!1;if(i.getCaps().standardDerivatives&&this._bumpTexture&&Ia.ClearCoatBumpTextureEnabled&&!s&&!this._bumpTexture.isReady())return!1;if(this._isTintEnabled&&this._tintTexture&&Ia.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.CLEARCOAT=!0,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=null!==this._texture&&this._texture._texture===(null===(i=this._textureRoughness)||void 0===i?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Ia.ClearCoatTextureEnabled?Hs.PrepareDefinesForMergedUV(this._texture,e,"CLEARCOAT_TEXTURE"):e.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&Ia.ClearCoatTextureEnabled?Hs.PrepareDefinesForMergedUV(this._textureRoughness,e,"CLEARCOAT_TEXTURE_ROUGHNESS"):e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&Ia.ClearCoatBumpTextureEnabled?Hs.PrepareDefinesForMergedUV(this._bumpTexture,e,"CLEARCOAT_BUMP"):e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===Sd._DefaultIndexOfRefraction,this._isTintEnabled?(e.CLEARCOAT_TINT=!0,this._tintTexture&&Ia.ClearCoatTintTextureEnabled?(Hs.PrepareDefinesForMergedUV(this._tintTexture,e,"CLEARCOAT_TINT_TEXTURE"),e.CLEARCOAT_TINT_GAMMATEXTURE=this._tintTexture.gammaSpace):e.CLEARCOAT_TINT_TEXTURE=!1):(e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1))):(e.CLEARCOAT=!1,e.CLEARCOAT_TEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,e.CLEARCOAT_DEFAULTIOR=!1,e.CLEARCOAT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,e.CLEARCOAT_BUMPDIRECTUV=0,e.CLEARCOAT_REMAP_F0=!1,e.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TINT_GAMMATEXTURE=!1)}bindForSubMesh(e,t,i,s){var r,n,o,a,l,h,c,u;if(!this._isEnabled)return;const d=s.materialDefines,p=this._material.isFrozen,_=this._material._disableBumpMap,f=this._material._invertNormalMapX,m=this._material._invertNormalMapY,g=d.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL;if(!e.useUbo||!p||!e.isSync){g&&Ia.ClearCoatTextureEnabled?(e.updateFloat4("vClearCoatInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),Hs.BindTextureMatrix(this._texture,e,"clearCoat")):(this._texture||this._textureRoughness)&&Ia.ClearCoatTextureEnabled&&(e.updateFloat4("vClearCoatInfos",null!==(n=null===(r=this._texture)||void 0===r?void 0:r.coordinatesIndex)&&void 0!==n?n:0,null!==(a=null===(o=this._texture)||void 0===o?void 0:o.level)&&void 0!==a?a:0,null!==(h=null===(l=this._textureRoughness)||void 0===l?void 0:l.coordinatesIndex)&&void 0!==h?h:0,null!==(u=null===(c=this._textureRoughness)||void 0===c?void 0:c.level)&&void 0!==u?u:0),this._texture&&Hs.BindTextureMatrix(this._texture,e,"clearCoat"),!this._textureRoughness||g||d.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE||Hs.BindTextureMatrix(this._textureRoughness,e,"clearCoatRoughness")),this._bumpTexture&&i.getCaps().standardDerivatives&&Ia.ClearCoatTextureEnabled&&!_&&(e.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),Hs.BindTextureMatrix(this._bumpTexture,e,"clearCoatBump"),t._mirroredCameraPosition?e.updateFloat2("vClearCoatTangentSpaceParams",f?1:-1,m?1:-1):e.updateFloat2("vClearCoatTangentSpaceParams",f?-1:1,m?-1:1)),this._tintTexture&&Ia.ClearCoatTintTextureEnabled&&(e.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),Hs.BindTextureMatrix(this._tintTexture,e,"clearCoatTint")),e.updateFloat2("vClearCoatParams",this.intensity,this.roughness);const s=1-this._indexOfRefraction,p=1+this._indexOfRefraction,v=Math.pow(-s/p,2),x=1/this._indexOfRefraction;e.updateFloat4("vClearCoatRefractionParams",v,x,s,p),this._isTintEnabled&&(e.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),e.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}t.texturesEnabled&&(this._texture&&Ia.ClearCoatTextureEnabled&&e.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!g&&!d.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&Ia.ClearCoatTextureEnabled&&e.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&i.getCaps().standardDerivatives&&Ia.ClearCoatBumpTextureEnabled&&!_&&e.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&Ia.ClearCoatTintTextureEnabled&&e.setTexture("clearCoatTintSampler",this._tintTexture))}hasTexture(e){return this._texture===e||this._textureRoughness===e||this._bumpTexture===e||this._tintTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness),this._bumpTexture&&e.push(this._bumpTexture),this._tintTexture&&e.push(this._tintTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&e.push(this._tintTexture)}dispose(e){var t,i,s,r;e&&(null===(t=this._texture)||void 0===t||t.dispose(),null===(i=this._textureRoughness)||void 0===i||i.dispose(),null===(s=this._bumpTexture)||void 0===s||s.dispose(),null===(r=this._tintTexture)||void 0===r||r.dispose())}getClassName(){return"PBRClearCoatConfiguration"}addFallbacks(e,t,i){return e.CLEARCOAT_BUMP&&t.addFallback(i++,"CLEARCOAT_BUMP"),e.CLEARCOAT_TINT&&t.addFallback(i++,"CLEARCOAT_TINT"),e.CLEARCOAT&&t.addFallback(i++,"CLEARCOAT"),i}getSamplers(e){e.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")}getUniforms(){return{ubo:[{name:"vClearCoatParams",size:2,type:"vec2"},{name:"vClearCoatRefractionParams",size:4,type:"vec4"},{name:"vClearCoatInfos",size:4,type:"vec4"},{name:"clearCoatMatrix",size:16,type:"mat4"},{name:"clearCoatRoughnessMatrix",size:16,type:"mat4"},{name:"vClearCoatBumpInfos",size:2,type:"vec2"},{name:"vClearCoatTangentSpaceParams",size:2,type:"vec2"},{name:"clearCoatBumpMatrix",size:16,type:"mat4"},{name:"vClearCoatTintParams",size:4,type:"vec4"},{name:"clearCoatColorAtDistance",size:1,type:"float"},{name:"vClearCoatTintInfos",size:2,type:"vec2"},{name:"clearCoatTintMatrix",size:16,type:"mat4"}]}}}Sd._DefaultIndexOfRefraction=1.5,me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Sd.prototype,"isEnabled",void 0),me([ie()],Sd.prototype,"intensity",void 0),me([ie()],Sd.prototype,"roughness",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Sd.prototype,"indexOfRefraction",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Sd.prototype,"texture",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Sd.prototype,"useRoughnessFromMainTexture",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Sd.prototype,"textureRoughness",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Sd.prototype,"remapF0OnInterfaceChange",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Sd.prototype,"bumpTexture",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Sd.prototype,"isTintEnabled",void 0),me([re()],Sd.prototype,"tintColor",void 0),me([ie()],Sd.prototype,"tintColorAtDistance",void 0),me([ie()],Sd.prototype,"tintThickness",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Sd.prototype,"tintTexture",void 0);class bd extends $t{constructor(){super(...arguments),this.IRIDESCENCE=!1,this.IRIDESCENCE_TEXTURE=!1,this.IRIDESCENCE_TEXTUREDIRECTUV=0,this.IRIDESCENCE_THICKNESS_TEXTURE=!1,this.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0,this.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=!1}}class Cd extends Fa{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"PBRIridescence",110,new bd,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.minimumThickness=Cd._DefaultMinimumThickness,this.maximumThickness=Cd._DefaultMaximumThickness,this.indexOfRefraction=Cd._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._thicknessTexture=null,this.thicknessTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){if(!this._isEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._texture&&Ia.IridescenceTextureEnabled&&!this._texture.isReadyOrNotBlocking())return!1;if(this._thicknessTexture&&Ia.IridescenceTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.IRIDESCENCE=!0,e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=null!==this._texture&&this._texture._texture===(null===(i=this._thicknessTexture)||void 0===i?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._thicknessTexture),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Ia.IridescenceTextureEnabled?Hs.PrepareDefinesForMergedUV(this._texture,e,"IRIDESCENCE_TEXTURE"):e.IRIDESCENCE_TEXTURE=!1,!e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&this._thicknessTexture&&Ia.IridescenceTextureEnabled?Hs.PrepareDefinesForMergedUV(this._thicknessTexture,e,"IRIDESCENCE_THICKNESS_TEXTURE"):e.IRIDESCENCE_THICKNESS_TEXTURE=!1)):(e.IRIDESCENCE=!1,e.IRIDESCENCE_TEXTURE=!1,e.IRIDESCENCE_THICKNESS_TEXTURE=!1,e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=!1,e.IRIDESCENCE_TEXTUREDIRECTUV=0,e.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0)}bindForSubMesh(e,t,i,s){var r,n,o,a,l,h,c,u;if(!this._isEnabled)return;const d=s.materialDefines,p=this._material.isFrozen,_=d.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE;e.useUbo&&p&&e.isSync||(_&&Ia.IridescenceTextureEnabled?(e.updateFloat4("vIridescenceInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),Hs.BindTextureMatrix(this._texture,e,"iridescence")):(this._texture||this._thicknessTexture)&&Ia.IridescenceTextureEnabled&&(e.updateFloat4("vIridescenceInfos",null!==(n=null===(r=this._texture)||void 0===r?void 0:r.coordinatesIndex)&&void 0!==n?n:0,null!==(a=null===(o=this._texture)||void 0===o?void 0:o.level)&&void 0!==a?a:0,null!==(h=null===(l=this._thicknessTexture)||void 0===l?void 0:l.coordinatesIndex)&&void 0!==h?h:0,null!==(u=null===(c=this._thicknessTexture)||void 0===c?void 0:c.level)&&void 0!==u?u:0),this._texture&&Hs.BindTextureMatrix(this._texture,e,"iridescence"),!this._thicknessTexture||_||d.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE||Hs.BindTextureMatrix(this._thicknessTexture,e,"iridescenceThickness")),e.updateFloat4("vIridescenceParams",this.intensity,this.indexOfRefraction,this.minimumThickness,this.maximumThickness)),t.texturesEnabled&&(this._texture&&Ia.IridescenceTextureEnabled&&e.setTexture("iridescenceSampler",this._texture),this._thicknessTexture&&!_&&!d.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&Ia.IridescenceTextureEnabled&&e.setTexture("iridescenceThicknessSampler",this._thicknessTexture))}hasTexture(e){return this._texture===e||this._thicknessTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._thicknessTexture&&e.push(this._thicknessTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture)}dispose(e){var t,i;e&&(null===(t=this._texture)||void 0===t||t.dispose(),null===(i=this._thicknessTexture)||void 0===i||i.dispose())}getClassName(){return"PBRIridescenceConfiguration"}addFallbacks(e,t,i){return e.IRIDESCENCE&&t.addFallback(i++,"IRIDESCENCE"),i}getSamplers(e){e.push("iridescenceSampler","iridescenceThicknessSampler")}getUniforms(){return{ubo:[{name:"vIridescenceParams",size:4,type:"vec4"},{name:"vIridescenceInfos",size:4,type:"vec4"},{name:"iridescenceMatrix",size:16,type:"mat4"},{name:"iridescenceThicknessMatrix",size:16,type:"mat4"}]}}}Cd._DefaultMinimumThickness=100,Cd._DefaultMaximumThickness=400,Cd._DefaultIndexOfRefraction=1.3,me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Cd.prototype,"isEnabled",void 0),me([ie()],Cd.prototype,"intensity",void 0),me([ie()],Cd.prototype,"minimumThickness",void 0),me([ie()],Cd.prototype,"maximumThickness",void 0),me([ie()],Cd.prototype,"indexOfRefraction",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Cd.prototype,"texture",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Cd.prototype,"thicknessTexture",void 0);class yd extends $t{constructor(){super(...arguments),this.ANISOTROPIC=!1,this.ANISOTROPIC_TEXTURE=!1,this.ANISOTROPIC_TEXTUREDIRECTUV=0,this.ANISOTROPIC_LEGACY=!1,this.MAINUV1=!1}}class Ad extends Fa{set angle(e){this.direction.x=Math.cos(e),this.direction.y=Math.sin(e)}get angle(){return Math.atan2(this.direction.y,this.direction.x)}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markAllSubMeshesAsMiscDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsMiscDirty()}constructor(e,t=!0){super(e,"PBRAnisotropic",110,new yd,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.direction=new E(1,0),this._texture=null,this.texture=null,this._legacy=!1,this.legacy=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16]}isReadyForSubMesh(e,t){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&this._texture&&Ia.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking())}prepareDefinesBeforeAttributes(e,t,i){this._isEnabled?(e.ANISOTROPIC=this._isEnabled,this._isEnabled&&!i.isVerticesDataPresent(hi.TangentKind)&&(e._needUVs=!0,e.MAINUV1=!0),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Ia.AnisotropicTextureEnabled?Hs.PrepareDefinesForMergedUV(this._texture,e,"ANISOTROPIC_TEXTURE"):e.ANISOTROPIC_TEXTURE=!1),e._areMiscDirty&&(e.ANISOTROPIC_LEGACY=this._legacy)):(e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1,e.ANISOTROPIC_TEXTUREDIRECTUV=0,e.ANISOTROPIC_LEGACY=!1)}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;e.useUbo&&i&&e.isSync||(this._texture&&Ia.AnisotropicTextureEnabled&&(e.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),Hs.BindTextureMatrix(this._texture,e,"anisotropy")),e.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),t.texturesEnabled&&this._texture&&Ia.AnisotropicTextureEnabled&&e.setTexture("anisotropySampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){e&&this._texture&&this._texture.dispose()}getClassName(){return"PBRAnisotropicConfiguration"}addFallbacks(e,t,i){return e.ANISOTROPIC&&t.addFallback(i++,"ANISOTROPIC"),i}getSamplers(e){e.push("anisotropySampler")}getUniforms(){return{ubo:[{name:"vAnisotropy",size:3,type:"vec3"},{name:"vAnisotropyInfos",size:2,type:"vec2"},{name:"anisotropyMatrix",size:16,type:"mat4"}]}}parse(e,t,i){super.parse(e,t,i),void 0===e.legacy&&(this.legacy=!0)}}me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Ad.prototype,"isEnabled",void 0),me([ie()],Ad.prototype,"intensity",void 0),me([oe()],Ad.prototype,"direction",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Ad.prototype,"texture",void 0),me([ie(),te("_markAllSubMeshesAsMiscDirty")],Ad.prototype,"legacy",void 0);class Rd extends $t{constructor(){super(...arguments),this.SHEEN=!1,this.SHEEN_TEXTURE=!1,this.SHEEN_GAMMATEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS=!1,this.SHEEN_TEXTUREDIRECTUV=0,this.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,this.SHEEN_LINKWITHALBEDO=!1,this.SHEEN_ROUGHNESS=!1,this.SHEEN_ALBEDOSCALING=!1,this.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1}}class Id extends Fa{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"Sheen",120,new Rd,t),this._isEnabled=!1,this.isEnabled=!1,this._linkSheenWithAlbedo=!1,this.linkSheenWithAlbedo=!1,this.intensity=1,this.color=N.White(),this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._roughness=null,this.roughness=null,this._textureRoughness=null,this.textureRoughness=null,this._albedoScaling=!1,this.albedoScaling=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){if(!this._isEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._texture&&Ia.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking())return!1;if(this._textureRoughness&&Ia.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.SHEEN=!0,e.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,e.SHEEN_ROUGHNESS=null!==this._roughness,e.SHEEN_ALBEDOSCALING=this._albedoScaling,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=null!==this._texture&&this._texture._texture===(null===(i=this._textureRoughness)||void 0===i?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Ia.SheenTextureEnabled?(Hs.PrepareDefinesForMergedUV(this._texture,e,"SHEEN_TEXTURE"),e.SHEEN_GAMMATEXTURE=this._texture.gammaSpace):e.SHEEN_TEXTURE=!1,this._textureRoughness&&Ia.SheenTextureEnabled?Hs.PrepareDefinesForMergedUV(this._textureRoughness,e,"SHEEN_TEXTURE_ROUGHNESS"):e.SHEEN_TEXTURE_ROUGHNESS=!1)):(e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1,e.SHEEN_GAMMATEXTURE=!1,e.SHEEN_TEXTUREDIRECTUV=0,e.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0)}bindForSubMesh(e,t,i,s){var r,n,o,a,l,h,c,u;if(!this._isEnabled)return;const d=s.materialDefines,p=this._material.isFrozen,_=d.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL;e.useUbo&&p&&e.isSync||(_&&Ia.SheenTextureEnabled?(e.updateFloat4("vSheenInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),Hs.BindTextureMatrix(this._texture,e,"sheen")):(this._texture||this._textureRoughness)&&Ia.SheenTextureEnabled&&(e.updateFloat4("vSheenInfos",null!==(n=null===(r=this._texture)||void 0===r?void 0:r.coordinatesIndex)&&void 0!==n?n:0,null!==(a=null===(o=this._texture)||void 0===o?void 0:o.level)&&void 0!==a?a:0,null!==(h=null===(l=this._textureRoughness)||void 0===l?void 0:l.coordinatesIndex)&&void 0!==h?h:0,null!==(u=null===(c=this._textureRoughness)||void 0===c?void 0:c.level)&&void 0!==u?u:0),this._texture&&Hs.BindTextureMatrix(this._texture,e,"sheen"),!this._textureRoughness||_||d.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE||Hs.BindTextureMatrix(this._textureRoughness,e,"sheenRoughness")),e.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),null!==this._roughness&&e.updateFloat("vSheenRoughness",this._roughness)),t.texturesEnabled&&(this._texture&&Ia.SheenTextureEnabled&&e.setTexture("sheenSampler",this._texture),this._textureRoughness&&!_&&!d.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&Ia.SheenTextureEnabled&&e.setTexture("sheenRoughnessSampler",this._textureRoughness))}hasTexture(e){return this._texture===e||this._textureRoughness===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness)}dispose(e){var t,i;e&&(null===(t=this._texture)||void 0===t||t.dispose(),null===(i=this._textureRoughness)||void 0===i||i.dispose())}getClassName(){return"PBRSheenConfiguration"}addFallbacks(e,t,i){return e.SHEEN&&t.addFallback(i++,"SHEEN"),i}getSamplers(e){e.push("sheenSampler","sheenRoughnessSampler")}getUniforms(){return{ubo:[{name:"vSheenColor",size:4,type:"vec4"},{name:"vSheenRoughness",size:1,type:"float"},{name:"vSheenInfos",size:4,type:"vec4"},{name:"sheenMatrix",size:16,type:"mat4"},{name:"sheenRoughnessMatrix",size:16,type:"mat4"}]}}}me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Id.prototype,"isEnabled",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Id.prototype,"linkSheenWithAlbedo",void 0),me([ie()],Id.prototype,"intensity",void 0),me([re()],Id.prototype,"color",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Id.prototype,"texture",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Id.prototype,"useRoughnessFromMainTexture",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Id.prototype,"roughness",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Id.prototype,"textureRoughness",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Id.prototype,"albedoScaling",void 0);class Pd extends $t{constructor(){super(...arguments),this.SUBSURFACE=!1,this.SS_REFRACTION=!1,this.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,this.SS_TRANSLUCENCY=!1,this.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,this.SS_SCATTERING=!1,this.SS_DISPERSION=!1,this.SS_THICKNESSANDMASK_TEXTURE=!1,this.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,this.SS_HAS_THICKNESS=!1,this.SS_REFRACTIONINTENSITY_TEXTURE=!1,this.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,this.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,this.SS_REFRACTIONMAP_3D=!1,this.SS_REFRACTIONMAP_OPPOSITEZ=!1,this.SS_LODINREFRACTIONALPHA=!1,this.SS_GAMMAREFRACTION=!1,this.SS_RGBDREFRACTION=!1,this.SS_LINEARSPECULARREFRACTION=!1,this.SS_LINKREFRACTIONTOTRANSPARENCY=!1,this.SS_ALBEDOFORREFRACTIONTINT=!1,this.SS_ALBEDOFORTRANSLUCENCYTINT=!1,this.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.SS_USE_THICKNESS_AS_DEPTH=!1,this.SS_MASK_FROM_THICKNESS_TEXTURE=!1,this.SS_USE_GLTF_TEXTURES=!1}}class Md extends Fa{get scatteringDiffusionProfile(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null}set scatteringDiffusionProfile(e){this._scene.enableSubSurfaceForPrePass()&&e&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(e))}get volumeIndexOfRefraction(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction}set volumeIndexOfRefraction(e){this._volumeIndexOfRefraction=e>=1?e:-1}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markScenePrePassDirty(){this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()}constructor(e,t=!0){super(e,"PBRSubSurface",130,new Pd,t),this._isRefractionEnabled=!1,this.isRefractionEnabled=!1,this._isTranslucencyEnabled=!1,this.isTranslucencyEnabled=!1,this._isDispersionEnabled=!1,this.isDispersionEnabled=!1,this._isScatteringEnabled=!1,this.isScatteringEnabled=!1,this._scatteringDiffusionProfileIndex=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=!1,this.useAlbedoToTintTranslucency=!1,this._thicknessTexture=null,this.thicknessTexture=null,this._refractionTexture=null,this.refractionTexture=null,this._indexOfRefraction=1.5,this.indexOfRefraction=1.5,this._volumeIndexOfRefraction=-1,this._invertRefractionY=!1,this.invertRefractionY=!1,this._linkRefractionWithTransparency=!1,this.linkRefractionWithTransparency=!1,this.minimumThickness=0,this.maximumThickness=1,this.useThicknessAsDepth=!1,this.tintColor=N.White(),this.tintColorAtDistance=1,this.dispersion=0,this.diffusionDistance=N.White(),this._useMaskFromThicknessTexture=!1,this.useMaskFromThicknessTexture=!1,this._refractionIntensityTexture=null,this.refractionIntensityTexture=null,this._translucencyIntensityTexture=null,this.translucencyIntensityTexture=null,this._useGltfStyleTextures=!1,this.useGltfStyleTextures=!1,this._scene=e.getScene(),this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkScenePrePassDirty=e._dirtyCallbacks[32]}isReadyForSubMesh(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._thicknessTexture&&Ia.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return!1;const e=this._getRefractionTexture(t);if(e&&Ia.RefractionTextureEnabled&&!e.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return e.SUBSURFACE=!1,e.SS_DISPERSION=!1,e.SS_TRANSLUCENCY=!1,e.SS_SCATTERING=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,e.SS_HAS_THICKNESS=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,e.SS_REFRACTIONMAP_3D=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,void(e.SS_USE_GLTF_TEXTURES=!1);if(e._areTexturesDirty){e.SUBSURFACE=!0,e.SS_DISPERSION=this._isDispersionEnabled,e.SS_TRANSLUCENCY=this._isTranslucencyEnabled,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_SCATTERING=this._isScatteringEnabled,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_HAS_THICKNESS=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_REFRACTIONMAP_3D=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1;const i=!!this._thicknessTexture&&!!this._refractionIntensityTexture&&this._refractionIntensityTexture.checkTransformsAreIdentical(this._thicknessTexture)&&this._refractionIntensityTexture._texture===this._thicknessTexture._texture,s=!!this._thicknessTexture&&!!this._translucencyIntensityTexture&&this._translucencyIntensityTexture.checkTransformsAreIdentical(this._thicknessTexture)&&this._translucencyIntensityTexture._texture===this._thicknessTexture._texture,r=(i||!this._refractionIntensityTexture)&&(s||!this._translucencyIntensityTexture);if(e._areTexturesDirty&&t.texturesEnabled&&(this._thicknessTexture&&Ia.ThicknessTextureEnabled&&Hs.PrepareDefinesForMergedUV(this._thicknessTexture,e,"SS_THICKNESSANDMASK_TEXTURE"),this._refractionIntensityTexture&&Ia.RefractionIntensityTextureEnabled&&!r&&Hs.PrepareDefinesForMergedUV(this._refractionIntensityTexture,e,"SS_REFRACTIONINTENSITY_TEXTURE"),this._translucencyIntensityTexture&&Ia.TranslucencyIntensityTextureEnabled&&!r&&Hs.PrepareDefinesForMergedUV(this._translucencyIntensityTexture,e,"SS_TRANSLUCENCYINTENSITY_TEXTURE")),e.SS_HAS_THICKNESS=this.maximumThickness-this.minimumThickness!=0,e.SS_MASK_FROM_THICKNESS_TEXTURE=(this._useMaskFromThicknessTexture||!!this._refractionIntensityTexture||!!this._translucencyIntensityTexture)&&r,e.SS_USE_GLTF_TEXTURES=this._useGltfStyleTextures,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=(this._useMaskFromThicknessTexture||!!this._refractionIntensityTexture)&&r,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=(this._useMaskFromThicknessTexture||!!this._translucencyIntensityTexture)&&r,this._isRefractionEnabled&&t.texturesEnabled){const i=this._getRefractionTexture(t);i&&Ia.RefractionTextureEnabled&&(e.SS_REFRACTION=!0,e.SS_REFRACTIONMAP_3D=i.isCube,e.SS_GAMMAREFRACTION=i.gammaSpace,e.SS_RGBDREFRACTION=i.isRGBD,e.SS_LINEARSPECULARREFRACTION=i.linearSpecularLOD,e.SS_REFRACTIONMAP_OPPOSITEZ=this._scene.useRightHandedSystem&&i.isCube?!i.invertZ:i.invertZ,e.SS_LODINREFRACTIONALPHA=i.lodLevelInAlpha,e.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,e.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=i.isCube&&i.boundingBoxSize,e.SS_USE_THICKNESS_AS_DEPTH=this.useThicknessAsDepth)}this._isTranslucencyEnabled&&(e.SS_ALBEDOFORTRANSLUCENCYTINT=this.useAlbedoToTintTranslucency)}}hardBindForSubMesh(e,t,i,s){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;s.getRenderingMesh().getWorldMatrix().decompose(R.Vector3[0]);const r=Math.max(Math.abs(R.Vector3[0].x),Math.abs(R.Vector3[0].y),Math.abs(R.Vector3[0].z));e.updateFloat2("vThicknessParam",this.minimumThickness*r,(this.maximumThickness-this.minimumThickness)*r)}bindForSubMesh(e,t,i,s){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;const r=s.materialDefines,n=this._material.isFrozen,o=this._material.realTimeFiltering,a=r.LODBASEDMICROSFURACE,h=this._getRefractionTexture(t);if(!e.useUbo||!n||!e.isSync){if(this._thicknessTexture&&Ia.ThicknessTextureEnabled&&(e.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),Hs.BindTextureMatrix(this._thicknessTexture,e,"thickness")),this._refractionIntensityTexture&&Ia.RefractionIntensityTextureEnabled&&r.SS_REFRACTIONINTENSITY_TEXTURE&&(e.updateFloat2("vRefractionIntensityInfos",this._refractionIntensityTexture.coordinatesIndex,this._refractionIntensityTexture.level),Hs.BindTextureMatrix(this._refractionIntensityTexture,e,"refractionIntensity")),this._translucencyIntensityTexture&&Ia.TranslucencyIntensityTextureEnabled&&r.SS_TRANSLUCENCYINTENSITY_TEXTURE&&(e.updateFloat2("vTranslucencyIntensityInfos",this._translucencyIntensityTexture.coordinatesIndex,this._translucencyIntensityTexture.level),Hs.BindTextureMatrix(this._translucencyIntensityTexture,e,"translucencyIntensity")),h&&Ia.RefractionTextureEnabled){e.updateMatrix("refractionMatrix",h.getRefractionTextureMatrix());let t=1;h.isCube||h.depth&&(t=h.depth);const i=h.getSize().width,s=this.volumeIndexOfRefraction;if(e.updateFloat4("vRefractionInfos",h.level,1/s,t,this._invertRefractionY?-1:1),e.updateFloat4("vRefractionMicrosurfaceInfos",i,h.lodGenerationScale,h.lodGenerationOffset,1/this.indexOfRefraction),o&&e.updateFloat2("vRefractionFilteringInfo",i,l.Log2(i)),h.boundingBoxSize){const t=h;e.updateVector3("vRefractionPosition",t.boundingBoxPosition),e.updateVector3("vRefractionSize",t.boundingBoxSize)}}this._isScatteringEnabled&&e.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),e.updateColor3("vDiffusionDistance",this.diffusionDistance),e.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintColorAtDistance)),e.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0),e.updateFloat("dispersion",this.dispersion)}t.texturesEnabled&&(this._thicknessTexture&&Ia.ThicknessTextureEnabled&&e.setTexture("thicknessSampler",this._thicknessTexture),this._refractionIntensityTexture&&Ia.RefractionIntensityTextureEnabled&&r.SS_REFRACTIONINTENSITY_TEXTURE&&e.setTexture("refractionIntensitySampler",this._refractionIntensityTexture),this._translucencyIntensityTexture&&Ia.TranslucencyIntensityTextureEnabled&&r.SS_TRANSLUCENCYINTENSITY_TEXTURE&&e.setTexture("translucencyIntensitySampler",this._translucencyIntensityTexture),h&&Ia.RefractionTextureEnabled&&(a?e.setTexture("refractionSampler",h):(e.setTexture("refractionSampler",h._lodTextureMid||h),e.setTexture("refractionSamplerLow",h._lodTextureLow||h),e.setTexture("refractionSamplerHigh",h._lodTextureHigh||h))))}_getRefractionTexture(e){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?e.environmentTexture:null}get disableAlphaBlending(){return this._isRefractionEnabled&&this._linkRefractionWithTransparency}fillRenderTargetTextures(e){Ia.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&e.push(this._refractionTexture)}hasTexture(e){return this._thicknessTexture===e||this._refractionTexture===e}hasRenderTargetTextures(){return!!(Ia.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)}getActiveTextures(e){this._thicknessTexture&&e.push(this._thicknessTexture),this._refractionTexture&&e.push(this._refractionTexture)}getAnimatables(e){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture)}dispose(e){e&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose())}getClassName(){return"PBRSubSurfaceConfiguration"}addFallbacks(e,t,i){return e.SS_SCATTERING&&t.addFallback(i++,"SS_SCATTERING"),e.SS_TRANSLUCENCY&&t.addFallback(i++,"SS_TRANSLUCENCY"),i}getSamplers(e){e.push("thicknessSampler","refractionIntensitySampler","translucencyIntensitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh")}getUniforms(){return{ubo:[{name:"vRefractionMicrosurfaceInfos",size:4,type:"vec4"},{name:"vRefractionFilteringInfo",size:2,type:"vec2"},{name:"vTranslucencyIntensityInfos",size:2,type:"vec2"},{name:"vRefractionInfos",size:4,type:"vec4"},{name:"refractionMatrix",size:16,type:"mat4"},{name:"vThicknessInfos",size:2,type:"vec2"},{name:"vRefractionIntensityInfos",size:2,type:"vec2"},{name:"thicknessMatrix",size:16,type:"mat4"},{name:"refractionIntensityMatrix",size:16,type:"mat4"},{name:"translucencyIntensityMatrix",size:16,type:"mat4"},{name:"vThicknessParam",size:2,type:"vec2"},{name:"vDiffusionDistance",size:3,type:"vec3"},{name:"vTintColor",size:4,type:"vec4"},{name:"vSubSurfaceIntensity",size:3,type:"vec3"},{name:"vRefractionPosition",size:3,type:"vec3"},{name:"vRefractionSize",size:3,type:"vec3"},{name:"scatteringDiffusionProfile",size:1,type:"float"},{name:"dispersion",size:1,type:"float"}]}}}me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Md.prototype,"isRefractionEnabled",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Md.prototype,"isTranslucencyEnabled",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Md.prototype,"isDispersionEnabled",void 0),me([ie(),te("_markScenePrePassDirty")],Md.prototype,"isScatteringEnabled",void 0),me([ie()],Md.prototype,"_scatteringDiffusionProfileIndex",void 0),me([ie()],Md.prototype,"refractionIntensity",void 0),me([ie()],Md.prototype,"translucencyIntensity",void 0),me([ie()],Md.prototype,"useAlbedoToTintRefraction",void 0),me([ie()],Md.prototype,"useAlbedoToTintTranslucency",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Md.prototype,"thicknessTexture",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Md.prototype,"refractionTexture",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Md.prototype,"indexOfRefraction",void 0),me([ie()],Md.prototype,"_volumeIndexOfRefraction",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],Md.prototype,"volumeIndexOfRefraction",null),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Md.prototype,"invertRefractionY",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Md.prototype,"linkRefractionWithTransparency",void 0),me([ie()],Md.prototype,"minimumThickness",void 0),me([ie()],Md.prototype,"maximumThickness",void 0),me([ie()],Md.prototype,"useThicknessAsDepth",void 0),me([re()],Md.prototype,"tintColor",void 0),me([ie()],Md.prototype,"tintColorAtDistance",void 0),me([ie()],Md.prototype,"dispersion",void 0),me([re()],Md.prototype,"diffusionDistance",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Md.prototype,"useMaskFromThicknessTexture",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Md.prototype,"refractionIntensityTexture",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Md.prototype,"translucencyIntensityTexture",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Md.prototype,"useGltfStyleTextures",void 0);const Od={effect:null,subMesh:null};class Dd extends $t{constructor(e){super(e),this.PBR=!0,this.NUM_SAMPLES="0",this.REALTIME_FILTERING=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.ALBEDO=!1,this.GAMMAALBEDO=!1,this.ALBEDODIRECTUV=0,this.VERTEXCOLOR=!1,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.AMBIENTINGRAYSCALE=!1,this.OPACITY=!1,this.VERTEXALPHA=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHABLEND=!1,this.ALPHAFROMALBEDO=!1,this.ALPHATESTVALUE="0.5",this.SPECULAROVERALPHA=!1,this.RADIANCEOVERALPHA=!1,this.ALPHAFRESNEL=!1,this.LINEARALPHAFRESNEL=!1,this.PREMULTIPLYALPHA=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.GAMMAEMISSIVE=!1,this.REFLECTIVITY=!1,this.REFLECTIVITY_GAMMA=!1,this.REFLECTIVITYDIRECTUV=0,this.SPECULARTERM=!1,this.MICROSURFACEFROMREFLECTIVITYMAP=!1,this.MICROSURFACEAUTOMATIC=!1,this.LODBASEDMICROSFURACE=!1,this.MICROSURFACEMAP=!1,this.MICROSURFACEMAPDIRECTUV=0,this.METALLICWORKFLOW=!1,this.ROUGHNESSSTOREINMETALMAPALPHA=!1,this.ROUGHNESSSTOREINMETALMAPGREEN=!1,this.METALLNESSSTOREINMETALMAPBLUE=!1,this.AOSTOREINMETALMAPRED=!1,this.METALLIC_REFLECTANCE=!1,this.METALLIC_REFLECTANCE_GAMMA=!1,this.METALLIC_REFLECTANCEDIRECTUV=0,this.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=!1,this.REFLECTANCE=!1,this.REFLECTANCE_GAMMA=!1,this.REFLECTANCEDIRECTUV=0,this.ENVIRONMENTBRDF=!1,this.ENVIRONMENTBRDF_RGBD=!1,this.NORMAL=!1,this.TANGENT=!1,this.BUMP=!1,this.BUMPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.NORMALXYSCALE=!0,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.USELIGHTMAPASSHADOWMAP=!1,this.GAMMALIGHTMAP=!1,this.RGBDLIGHTMAP=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.USESPHERICALFROMREFLECTIONMAP=!1,this.USEIRRADIANCEMAP=!1,this.USESPHERICALINVERTEX=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.LINEARSPECULARREFLECTION=!1,this.RADIANCEOCCLUSION=!1,this.HORIZONOCCLUSION=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.NONUNIFORMSCALING=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.USEPHYSICALLIGHTFALLOFF=!1,this.USEGLTFLIGHTFALLOFF=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.LOGARITHMICDEPTH=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.FORCENORMALFORWARD=!1,this.SPECULARAA=!1,this.UNLIT=!1,this.DECAL_AFTER_DETAIL=!1,this.DEBUGMODE=0,this.rebuild()}reset(){super.reset(),this.ALPHATESTVALUE="0.5",this.PBR=!0,this.NORMALXYSCALE=!0}}class Nd extends Xr{get realTimeFiltering(){return this._realTimeFiltering}set realTimeFiltering(e){this._realTimeFiltering=e,this.markAsDirty(1)}get realTimeFilteringQuality(){return this._realTimeFilteringQuality}set realTimeFilteringQuality(e){this._realTimeFilteringQuality=e,this.markAsDirty(1)}get canRenderToMRT(){return!0}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._markAllSubMeshesAsImageProcessingDirty()}))))}constructor(e,t){super(e,t),this._directIntensity=1,this._emissiveIntensity=1,this._environmentIntensity=1,this._specularIntensity=1,this._lightingInfos=new b(this._directIntensity,this._emissiveIntensity,this._environmentIntensity,this._specularIntensity),this._disableBumpMap=!1,this._albedoTexture=null,this._ambientTexture=null,this._ambientTextureStrength=1,this._ambientTextureImpactOnAnalyticalLights=Nd.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._reflectivityTexture=null,this._metallicTexture=null,this._metallic=null,this._roughness=null,this._metallicF0Factor=1,this._metallicReflectanceColor=N.White(),this._useOnlyMetallicFromMetallicReflectanceTexture=!1,this._metallicReflectanceTexture=null,this._reflectanceTexture=null,this._microSurfaceTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._ambientColor=new N(0,0,0),this._albedoColor=new N(1,1,1),this._reflectivityColor=new N(1,1,1),this._reflectionColor=new N(1,1,1),this._emissiveColor=new N(0,0,0),this._microSurface=.9,this._useLightmapAsShadowmap=!1,this._useHorizonOcclusion=!0,this._useRadianceOcclusion=!0,this._useAlphaFromAlbedoTexture=!1,this._useSpecularOverAlpha=!0,this._useMicroSurfaceFromReflectivityMapAlpha=!1,this._useRoughnessFromMetallicTextureAlpha=!0,this._useRoughnessFromMetallicTextureGreen=!1,this._useMetallnessFromMetallicTextureBlue=!1,this._useAmbientOcclusionFromMetallicTextureRed=!1,this._useAmbientInGrayScale=!1,this._useAutoMicroSurfaceFromReflectivityMap=!1,this._lightFalloff=Nd.LIGHTFALLOFF_PHYSICAL,this._useRadianceOverAlpha=!0,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this._parallaxScaleBias=.05,this._disableLighting=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._alphaCutOff=.4,this._forceAlphaTest=!1,this._useAlphaFresnel=!1,this._useLinearAlphaFresnel=!1,this._environmentBRDFTexture=null,this._forceIrradianceInFragment=!1,this._realTimeFiltering=!1,this._realTimeFilteringQuality=8,this._forceNormalForward=!1,this._enableSpecularAntiAliasing=!1,this._imageProcessingObserver=null,this._renderTargets=new Yt(16),this._globalAmbientColor=new N(0,0,0),this._unlit=!1,this._applyDecalMapAfterDetailMap=!1,this._debugMode=0,this.debugMode=0,this.debugLimit=-1,this.debugFactor=1,this._cacheHasRenderTargetTextures=!1,this.brdf=new Td(this),this.clearCoat=new Sd(this),this.iridescence=new Cd(this),this.anisotropy=new Ad(this),this.sheen=new Id(this),this.subSurface=new Md(this),this.detailMap=new La(this),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),Ia.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets),this._environmentBRDFTexture=vd(this.getScene()),this.prePassConfiguration=new Ra}get hasRenderTargetTextures(){return!!(Ia.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget)||this._cacheHasRenderTargetTextures}get isPrePassCapable(){return!this.disableDepthWrite}getClassName(){return"PBRBaseMaterial"}get _disableAlphaBlending(){var e;return this._transparencyMode===Nd.PBRMATERIAL_OPAQUE||this._transparencyMode===Nd.PBRMATERIAL_ALPHATEST||(null===(e=this.subSurface)||void 0===e?void 0:e.disableAlphaBlending)}needAlphaBlending(){return!this._disableAlphaBlending&&(this.alpha<1||null!=this._opacityTexture||this._shouldUseAlphaFromAlbedoTexture())}needAlphaTesting(){var e;return!!this._forceAlphaTest||!(null===(e=this.subSurface)||void 0===e?void 0:e.disableAlphaBlending)&&this._hasAlphaChannel()&&(null==this._transparencyMode||this._transparencyMode===Nd.PBRMATERIAL_ALPHATEST)}_shouldUseAlphaFromAlbedoTexture(){return null!=this._albedoTexture&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==Nd.PBRMATERIAL_OPAQUE}_hasAlphaChannel(){return null!=this._albedoTexture&&this._albedoTexture.hasAlpha||null!=this._opacityTexture}getAlphaTestTexture(){return this._albedoTexture}isReadyForSubMesh(e,t,i){var s;if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(Ys.GetDefineNames,this._eventInfo),t.materialDefines=new Dd(this._eventInfo.defineNames));const r=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const n=this.getScene(),o=n.getEngine();if(r._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,n.texturesEnabled)){if(this._albedoTexture&&Ia.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking())return!1;if(this._ambientTexture&&Ia.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking())return!1;if(this._opacityTexture&&Ia.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;const e=this._getReflectionTexture();if(e&&Ia.ReflectionTextureEnabled){if(!e.isReadyOrNotBlocking())return!1;if(e.irradianceTexture){if(!e.irradianceTexture.isReadyOrNotBlocking())return!1}else if(!e.sphericalPolynomial&&(null===(s=e.getInternalTexture())||void 0===s?void 0:s._sphericalPolynomialPromise))return!1}if(this._lightmapTexture&&Ia.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking())return!1;if(this._emissiveTexture&&Ia.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(Ia.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking())return!1;if(this._reflectanceTexture&&!this._reflectanceTexture.isReadyOrNotBlocking())return!1;if(this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(o.getCaps().standardDerivatives&&this._bumpTexture&&Ia.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady())return!1;if(this._environmentBRDFTexture&&Ia.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=r,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(r._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;o.getCaps().standardDerivatives||e.isVerticesDataPresent(hi.NormalKind)||(e.createNormals(!0),k.Warn("PBRMaterial: Normals have been created for the mesh: "+e.name));const a=t.effect,l=r._areLightsDisposed;let h=this._prepareEffect(e,r,this.onCompiled,this.onError,i,null,t.getRenderingMesh().hasThinInstances),c=!1;if(h)if(this._onEffectCreatedObservable&&(Od.effect=h,Od.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Od)),this.allowShaderHotSwapping&&a&&!h.isReady()){if(h=a,r.markAsUnprocessed(),c=this.isFrozen,l)return r._areLightsDisposed=!0,!1}else n.resetCachedMaterial(),t.setEffect(h,r,this._materialContext);return!(!t.effect||!t.effect.isReady()||(r._renderId=n.getRenderId(),t.effect._wasPreviouslyReady=!c,t.effect._wasPreviouslyUsingInstances=!!i,this._checkScenePerformancePriority(),0))}isMetallicWorkflow(){return!(null==this._metallic&&null==this._roughness&&!this._metallicTexture)}_prepareEffect(e,t,i=null,s=null,r=null,n=null,o){if(this._prepareDefines(e,t,r,n,o),!t.isDirty)return null;t.markAsProcessed();const a=this.getScene().getEngine(),l=new hn;let h=0;t.USESPHERICALINVERTEX&&l.addFallback(h++,"USESPHERICALINVERTEX"),t.FOG&&l.addFallback(h,"FOG"),t.SPECULARAA&&l.addFallback(h,"SPECULARAA"),t.POINTSIZE&&l.addFallback(h,"POINTSIZE"),t.LOGARITHMICDEPTH&&l.addFallback(h,"LOGARITHMICDEPTH"),t.PARALLAX&&l.addFallback(h,"PARALLAX"),t.PARALLAX_RHS&&l.addFallback(h,"PARALLAX_RHS"),t.PARALLAXOCCLUSION&&l.addFallback(h++,"PARALLAXOCCLUSION"),t.ENVIRONMENTBRDF&&l.addFallback(h++,"ENVIRONMENTBRDF"),t.TANGENT&&l.addFallback(h++,"TANGENT"),t.BUMP&&l.addFallback(h++,"BUMP"),h=Hs.HandleFallbacksForShadows(t,l,this._maxSimultaneousLights,h++),t.SPECULARTERM&&l.addFallback(h++,"SPECULARTERM"),t.USESPHERICALFROMREFLECTIONMAP&&l.addFallback(h++,"USESPHERICALFROMREFLECTIONMAP"),t.USEIRRADIANCEMAP&&l.addFallback(h++,"USEIRRADIANCEMAP"),t.LIGHTMAP&&l.addFallback(h++,"LIGHTMAP"),t.NORMAL&&l.addFallback(h++,"NORMAL"),t.AMBIENT&&l.addFallback(h++,"AMBIENT"),t.EMISSIVE&&l.addFallback(h++,"EMISSIVE"),t.VERTEXCOLOR&&l.addFallback(h++,"VERTEXCOLOR"),t.MORPHTARGETS&&l.addFallback(h++,"MORPHTARGETS"),t.MULTIVIEW&&l.addFallback(0,"MULTIVIEW");const c=[hi.PositionKind];t.NORMAL&&c.push(hi.NormalKind),t.TANGENT&&c.push(hi.TangentKind);for(let e=1;e<=6;++e)t["UV"+e]&&c.push(`uv${1===e?"":e}`);t.VERTEXCOLOR&&c.push(hi.ColorKind),Hs.PrepareAttributesForBones(c,e,t,l),Hs.PrepareAttributesForInstances(c,t),Hs.PrepareAttributesForMorphTargets(c,e,t),Hs.PrepareAttributesForBakedVertexAnimation(c,e,t);let u="pbr";const d=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","reflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices"],p=["albedoSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","reflectanceSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],_=["Material","Scene","Mesh"],f={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:t.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=l,this._eventInfo.fallbackRank=h,this._eventInfo.defines=t,this._eventInfo.uniforms=d,this._eventInfo.attributes=c,this._eventInfo.samplers=p,this._eventInfo.uniformBuffersNames=_,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=f,this._callbackPluginEventGeneric(Ys.PrepareEffect,this._eventInfo),Ra.AddUniforms(d),Ra.AddSamplers(p),ks(d),Zt&&(Zt.PrepareUniforms(d,t),Zt.PrepareSamplers(p,t)),Hs.PrepareUniformsAndSamplersList({uniformsNames:d,uniformBuffersNames:_,samplers:p,defines:t,maxSimultaneousLights:this._maxSimultaneousLights});const m={};this.customShaderNameResolve&&(u=this.customShaderNameResolve(u,d,_,p,t,c,m));const g=t.toString(),v=a.createEffect(u,{attributes:c,uniformsNames:d,uniformBuffersNames:_,samplers:p,defines:g,fallbacks:l,onCompiled:i,onError:s,indexParameters:f,processFinalCode:m.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:t.PREPASS},a);return this._eventInfo.customCode=void 0,v}_prepareDefines(e,t,i=null,s=null,r=!1){var n;const o=this.getScene(),a=o.getEngine();Hs.PrepareDefinesForLights(o,e,t,!0,this._maxSimultaneousLights,this._disableLighting),t._needNormals=!0,Hs.PrepareDefinesForMultiview(o,t);const l=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(Hs.PrepareDefinesForPrePass(o,t,this.canRenderToMRT&&!l),Hs.PrepareDefinesForOIT(o,t,l),t.METALLICWORKFLOW=this.isMetallicWorkflow(),t._areTexturesDirty){t._needUVs=!1;for(let e=1;e<=6;++e)t["MAINUV"+e]=!1;if(o.texturesEnabled){t.ALBEDODIRECTUV=0,t.AMBIENTDIRECTUV=0,t.OPACITYDIRECTUV=0,t.EMISSIVEDIRECTUV=0,t.REFLECTIVITYDIRECTUV=0,t.MICROSURFACEMAPDIRECTUV=0,t.METALLIC_REFLECTANCEDIRECTUV=0,t.REFLECTANCEDIRECTUV=0,t.BUMPDIRECTUV=0,t.LIGHTMAPDIRECTUV=0,a.getCaps().textureLOD&&(t.LODBASEDMICROSFURACE=!0),this._albedoTexture&&Ia.DiffuseTextureEnabled?(Hs.PrepareDefinesForMergedUV(this._albedoTexture,t,"ALBEDO"),t.GAMMAALBEDO=this._albedoTexture.gammaSpace):t.ALBEDO=!1,this._ambientTexture&&Ia.AmbientTextureEnabled?(Hs.PrepareDefinesForMergedUV(this._ambientTexture,t,"AMBIENT"),t.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):t.AMBIENT=!1,this._opacityTexture&&Ia.OpacityTextureEnabled?(Hs.PrepareDefinesForMergedUV(this._opacityTexture,t,"OPACITY"),t.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):t.OPACITY=!1;const e=this._getReflectionTexture();if(e&&Ia.ReflectionTextureEnabled){switch(t.REFLECTION=!0,t.GAMMAREFLECTION=e.gammaSpace,t.RGBDREFLECTION=e.isRGBD,t.LODINREFLECTIONALPHA=e.lodLevelInAlpha,t.LINEARSPECULARREFLECTION=e.linearSpecularLOD,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(t.NUM_SAMPLES=""+this.realTimeFilteringQuality,a._features.needTypeSuffixInShaderConstants&&(t.NUM_SAMPLES=t.NUM_SAMPLES+"u"),t.REALTIME_FILTERING=!0):t.REALTIME_FILTERING=!1,t.INVERTCUBICMAP=e.coordinatesMode===Ar.INVCUBIC_MODE,t.REFLECTIONMAP_3D=e.isCube,t.REFLECTIONMAP_OPPOSITEZ=t.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!e.invertZ:e.invertZ,t.REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,e.coordinatesMode){case Ar.EXPLICIT_MODE:t.REFLECTIONMAP_EXPLICIT=!0;break;case Ar.PLANAR_MODE:t.REFLECTIONMAP_PLANAR=!0;break;case Ar.PROJECTION_MODE:t.REFLECTIONMAP_PROJECTION=!0;break;case Ar.SKYBOX_MODE:t.REFLECTIONMAP_SKYBOX=!0;break;case Ar.SPHERICAL_MODE:t.REFLECTIONMAP_SPHERICAL=!0;break;case Ar.EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case Ar.FIXED_EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case Ar.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case Ar.CUBIC_MODE:case Ar.INVCUBIC_MODE:default:t.REFLECTIONMAP_CUBIC=!0,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!!e.boundingBoxSize}e.coordinatesMode!==Ar.SKYBOX_MODE&&(e.irradianceTexture?(t.USEIRRADIANCEMAP=!0,t.USESPHERICALFROMREFLECTIONMAP=!1):e.isCube&&(t.USESPHERICALFROMREFLECTIONMAP=!0,t.USEIRRADIANCEMAP=!1,this._forceIrradianceInFragment||this.realTimeFiltering||this._twoSidedLighting||a.getCaps().maxVaryingVectors<=8?t.USESPHERICALINVERTEX=!1:t.USESPHERICALINVERTEX=!0))}else t.REFLECTION=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.USESPHERICALFROMREFLECTIONMAP=!1,t.USEIRRADIANCEMAP=!1,t.USESPHERICALINVERTEX=!1,t.REFLECTIONMAP_OPPOSITEZ=!1,t.LODINREFLECTIONALPHA=!1,t.GAMMAREFLECTION=!1,t.RGBDREFLECTION=!1,t.LINEARSPECULARREFLECTION=!1;if(this._lightmapTexture&&Ia.LightmapTextureEnabled?(Hs.PrepareDefinesForMergedUV(this._lightmapTexture,t,"LIGHTMAP"),t.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,t.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,t.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):t.LIGHTMAP=!1,this._emissiveTexture&&Ia.EmissiveTextureEnabled?(Hs.PrepareDefinesForMergedUV(this._emissiveTexture,t,"EMISSIVE"),t.GAMMAEMISSIVE=this._emissiveTexture.gammaSpace):t.EMISSIVE=!1,Ia.SpecularTextureEnabled){if(this._metallicTexture?(Hs.PrepareDefinesForMergedUV(this._metallicTexture,t,"REFLECTIVITY"),t.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,t.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,t.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,t.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed,t.REFLECTIVITY_GAMMA=!1):this._reflectivityTexture?(Hs.PrepareDefinesForMergedUV(this._reflectivityTexture,t,"REFLECTIVITY"),t.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,t.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap,t.REFLECTIVITY_GAMMA=this._reflectivityTexture.gammaSpace):t.REFLECTIVITY=!1,this._metallicReflectanceTexture||this._reflectanceTexture){const e=null!==this._metallicReflectanceTexture&&this._metallicReflectanceTexture._texture===(null===(n=this._reflectanceTexture)||void 0===n?void 0:n._texture)&&this._metallicReflectanceTexture.checkTransformsAreIdentical(this._reflectanceTexture);t.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=this._useOnlyMetallicFromMetallicReflectanceTexture&&!e,this._metallicReflectanceTexture?(Hs.PrepareDefinesForMergedUV(this._metallicReflectanceTexture,t,"METALLIC_REFLECTANCE"),t.METALLIC_REFLECTANCE_GAMMA=this._metallicReflectanceTexture.gammaSpace):t.METALLIC_REFLECTANCE=!1,this._reflectanceTexture&&!e&&(!this._metallicReflectanceTexture||this._metallicReflectanceTexture&&this._useOnlyMetallicFromMetallicReflectanceTexture)?(Hs.PrepareDefinesForMergedUV(this._reflectanceTexture,t,"REFLECTANCE"),t.REFLECTANCE_GAMMA=this._reflectanceTexture.gammaSpace):t.REFLECTANCE=!1}else t.METALLIC_REFLECTANCE=!1,t.REFLECTANCE=!1;this._microSurfaceTexture?Hs.PrepareDefinesForMergedUV(this._microSurfaceTexture,t,"MICROSURFACEMAP"):t.MICROSURFACEMAP=!1}else t.REFLECTIVITY=!1,t.MICROSURFACEMAP=!1;a.getCaps().standardDerivatives&&this._bumpTexture&&Ia.BumpTextureEnabled&&!this._disableBumpMap?(Hs.PrepareDefinesForMergedUV(this._bumpTexture,t,"BUMP"),this._useParallax&&this._albedoTexture&&Ia.DiffuseTextureEnabled?(t.PARALLAX=!0,t.PARALLAX_RHS=o.useRightHandedSystem,t.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):t.PARALLAX=!1,t.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):(t.BUMP=!1,t.PARALLAX=!1,t.PARALLAX_RHS=!1,t.PARALLAXOCCLUSION=!1,t.OBJECTSPACE_NORMALMAP=!1),this._environmentBRDFTexture&&Ia.ReflectionTextureEnabled?(t.ENVIRONMENTBRDF=!0,t.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(t.ENVIRONMENTBRDF=!1,t.ENVIRONMENTBRDF_RGBD=!1),this._shouldUseAlphaFromAlbedoTexture()?t.ALPHAFROMALBEDO=!0:t.ALPHAFROMALBEDO=!1}t.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===Nd.LIGHTFALLOFF_STANDARD?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===Nd.LIGHTFALLOFF_GLTF?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!0):(t.USEPHYSICALLIGHTFALLOFF=!0,t.USEGLTFLIGHTFALLOFF=!1),t.RADIANCEOVERALPHA=this._useRadianceOverAlpha,!this.backFaceCulling&&this._twoSidedLighting?t.TWOSIDEDLIGHTING=!0:t.TWOSIDEDLIGHTING=!1,t.SPECULARAA=a.getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(t._areTexturesDirty||t._areMiscDirty)&&(t.ALPHATESTVALUE=`${this._alphaCutOff}${this._alphaCutOff%1==0?".":""}`,t.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,t.ALPHABLEND=this.needAlphaBlendingForMesh(e),t.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,t.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),t._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(t),t.FORCENORMALFORWARD=this._forceNormalForward,t.RADIANCEOCCLUSION=this._useRadianceOcclusion,t.HORIZONOCCLUSION=this._useHorizonOcclusion,t._areMiscDirty&&(Hs.PrepareDefinesForMisc(e,o,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,t,this._applyDecalMapAfterDetailMap),t.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(hi.NormalKind),t.DEBUGMODE=this._debugMode),Hs.PrepareDefinesForFrameBoundValues(o,a,this,t,!!i,s,r),this._eventInfo.defines=t,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),Hs.PrepareDefinesForAttributes(e,t,!0,!0,!0,this._transparencyMode!==Nd.PBRMATERIAL_OPAQUE),this._callbackPluginEventPrepareDefines(this._eventInfo)}forceCompilation(e,t,i){const s=Object.assign({clipPlane:!1,useInstances:!1},i);this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(Ys.GetDefineNames,this._eventInfo);const r=new Dd(this._eventInfo.defineNames),n=this._prepareEffect(e,r,void 0,void 0,s.useInstances,s.clipPlane,e.hasThinInstances);this._onEffectCreatedObservable&&(Od.effect=n,Od.subMesh=null,this._onEffectCreatedObservable.notifyObservers(Od)),n.isReady()?t&&t(this):n.onCompileObservable.add((()=>{t&&t(this)}))}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("vAlbedoInfos",2),e.addUniform("vAmbientInfos",4),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vReflectivityInfos",3),e.addUniform("vMicroSurfaceSamplerInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionFilteringInfo",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vBumpInfos",3),e.addUniform("albedoMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("reflectivityMatrix",16),e.addUniform("microSurfaceSamplerMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("reflectionMatrix",16),e.addUniform("vReflectionColor",3),e.addUniform("vAlbedoColor",4),e.addUniform("vLightingIntensity",4),e.addUniform("vReflectionMicrosurfaceInfos",3),e.addUniform("pointSize",1),e.addUniform("vReflectivityColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vAmbientColor",3),e.addUniform("vDebugMode",2),e.addUniform("vMetallicReflectanceFactors",4),e.addUniform("vMetallicReflectanceInfos",2),e.addUniform("metallicReflectanceMatrix",16),e.addUniform("vReflectanceInfos",2),e.addUniform("reflectanceMatrix",16),e.addUniform("vSphericalL00",3),e.addUniform("vSphericalL1_1",3),e.addUniform("vSphericalL10",3),e.addUniform("vSphericalL11",3),e.addUniform("vSphericalL2_2",3),e.addUniform("vSphericalL2_1",3),e.addUniform("vSphericalL20",3),e.addUniform("vSphericalL21",3),e.addUniform("vSphericalL22",3),e.addUniform("vSphericalX",3),e.addUniform("vSphericalY",3),e.addUniform("vSphericalZ",3),e.addUniform("vSphericalXX_ZZ",3),e.addUniform("vSphericalYY_ZZ",3),e.addUniform("vSphericalZZ",3),e.addUniform("vSphericalXY",3),e.addUniform("vSphericalYZ",3),e.addUniform("vSphericalZX",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){var s,r,n,o;const a=this.getScene(),h=i.materialDefines;if(!h)return;const c=i.effect;if(!c)return;this._activeEffect=c,t.getMeshUniformBuffer().bindToEffect(c,"Mesh"),t.transferToEffect(e);const u=a.getEngine();this._uniformBuffer.bindToEffect(c,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,a,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),h.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const d=c._forceRebindOnNextCall||this._mustRebind(a,c,t.visibility);Hs.BindBonesParameters(t,this._activeEffect,this.prePassConfiguration);let p=null;const _=this._uniformBuffer;if(d){if(this.bindViewProjection(c),p=this._getReflectionTexture(),!_.useUbo||!this.isFrozen||!_.isSync||c._forceRebindOnNextCall){if(a.texturesEnabled){if(this._albedoTexture&&Ia.DiffuseTextureEnabled&&(_.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),Hs.BindTextureMatrix(this._albedoTexture,_,"albedo")),this._ambientTexture&&Ia.AmbientTextureEnabled&&(_.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),Hs.BindTextureMatrix(this._ambientTexture,_,"ambient")),this._opacityTexture&&Ia.OpacityTextureEnabled&&(_.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),Hs.BindTextureMatrix(this._opacityTexture,_,"opacity")),p&&Ia.ReflectionTextureEnabled){if(_.updateMatrix("reflectionMatrix",p.getReflectionTextureMatrix()),_.updateFloat2("vReflectionInfos",p.level,0),p.boundingBoxSize){const e=p;_.updateVector3("vReflectionPosition",e.boundingBoxPosition),_.updateVector3("vReflectionSize",e.boundingBoxSize)}if(this.realTimeFiltering){const e=p.getSize().width;_.updateFloat2("vReflectionFilteringInfo",e,l.Log2(e))}if(!h.USEIRRADIANCEMAP){const e=p.sphericalPolynomial;if(h.USESPHERICALFROMREFLECTIONMAP&&e)if(h.SPHERICAL_HARMONICS){const t=e.preScaledHarmonics;_.updateVector3("vSphericalL00",t.l00),_.updateVector3("vSphericalL1_1",t.l1_1),_.updateVector3("vSphericalL10",t.l10),_.updateVector3("vSphericalL11",t.l11),_.updateVector3("vSphericalL2_2",t.l2_2),_.updateVector3("vSphericalL2_1",t.l2_1),_.updateVector3("vSphericalL20",t.l20),_.updateVector3("vSphericalL21",t.l21),_.updateVector3("vSphericalL22",t.l22)}else _.updateFloat3("vSphericalX",e.x.x,e.x.y,e.x.z),_.updateFloat3("vSphericalY",e.y.x,e.y.y,e.y.z),_.updateFloat3("vSphericalZ",e.z.x,e.z.y,e.z.z),_.updateFloat3("vSphericalXX_ZZ",e.xx.x-e.zz.x,e.xx.y-e.zz.y,e.xx.z-e.zz.z),_.updateFloat3("vSphericalYY_ZZ",e.yy.x-e.zz.x,e.yy.y-e.zz.y,e.yy.z-e.zz.z),_.updateFloat3("vSphericalZZ",e.zz.x,e.zz.y,e.zz.z),_.updateFloat3("vSphericalXY",e.xy.x,e.xy.y,e.xy.z),_.updateFloat3("vSphericalYZ",e.yz.x,e.yz.y,e.yz.z),_.updateFloat3("vSphericalZX",e.zx.x,e.zx.y,e.zx.z)}_.updateFloat3("vReflectionMicrosurfaceInfos",p.getSize().width,p.lodGenerationScale,p.lodGenerationOffset)}this._emissiveTexture&&Ia.EmissiveTextureEnabled&&(_.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),Hs.BindTextureMatrix(this._emissiveTexture,_,"emissive")),this._lightmapTexture&&Ia.LightmapTextureEnabled&&(_.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),Hs.BindTextureMatrix(this._lightmapTexture,_,"lightmap")),Ia.SpecularTextureEnabled&&(this._metallicTexture?(_.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),Hs.BindTextureMatrix(this._metallicTexture,_,"reflectivity")):this._reflectivityTexture&&(_.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),Hs.BindTextureMatrix(this._reflectivityTexture,_,"reflectivity")),this._metallicReflectanceTexture&&(_.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),Hs.BindTextureMatrix(this._metallicReflectanceTexture,_,"metallicReflectance")),this._reflectanceTexture&&h.REFLECTANCE&&(_.updateFloat2("vReflectanceInfos",this._reflectanceTexture.coordinatesIndex,this._reflectanceTexture.level),Hs.BindTextureMatrix(this._reflectanceTexture,_,"reflectance")),this._microSurfaceTexture&&(_.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),Hs.BindTextureMatrix(this._microSurfaceTexture,_,"microSurfaceSampler"))),this._bumpTexture&&u.getCaps().standardDerivatives&&Ia.BumpTextureEnabled&&!this._disableBumpMap&&(_.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),Hs.BindTextureMatrix(this._bumpTexture,_,"bump"),a._mirroredCameraPosition?_.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):_.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1))}if(this.pointsCloud&&_.updateFloat("pointSize",this.pointSize),h.METALLICWORKFLOW){w.Color3[0].r=void 0===this._metallic||null===this._metallic?1:this._metallic,w.Color3[0].g=void 0===this._roughness||null===this._roughness?1:this._roughness,_.updateColor4("vReflectivityColor",w.Color3[0],1);const e=null!==(r=null===(s=this.subSurface)||void 0===s?void 0:s._indexOfRefraction)&&void 0!==r?r:1.5,t=1,i=Math.pow((e-t)/(e+t),2);this._metallicReflectanceColor.scaleToRef(i*this._metallicF0Factor,w.Color3[0]);const n=this._metallicF0Factor;_.updateColor4("vMetallicReflectanceFactors",w.Color3[0],n)}else _.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);_.updateColor3("vEmissiveColor",Ia.EmissiveTextureEnabled?this._emissiveColor:N.BlackReadOnly),_.updateColor3("vReflectionColor",this._reflectionColor),!h.SS_REFRACTION&&(null===(n=this.subSurface)||void 0===n?void 0:n._linkRefractionWithTransparency)?_.updateColor4("vAlbedoColor",this._albedoColor,1):_.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*a.environmentIntensity,this._lightingInfos.w=this._specularIntensity,_.updateVector4("vLightingIntensity",this._lightingInfos),a.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),_.updateColor3("vAmbientColor",this._globalAmbientColor),_.updateFloat2("vDebugMode",this.debugLimit,this.debugFactor)}a.texturesEnabled&&(this._albedoTexture&&Ia.DiffuseTextureEnabled&&_.setTexture("albedoSampler",this._albedoTexture),this._ambientTexture&&Ia.AmbientTextureEnabled&&_.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&Ia.OpacityTextureEnabled&&_.setTexture("opacitySampler",this._opacityTexture),p&&Ia.ReflectionTextureEnabled&&(h.LODBASEDMICROSFURACE?_.setTexture("reflectionSampler",p):(_.setTexture("reflectionSampler",p._lodTextureMid||p),_.setTexture("reflectionSamplerLow",p._lodTextureLow||p),_.setTexture("reflectionSamplerHigh",p._lodTextureHigh||p)),h.USEIRRADIANCEMAP&&_.setTexture("irradianceSampler",p.irradianceTexture)),h.ENVIRONMENTBRDF&&_.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&Ia.EmissiveTextureEnabled&&_.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&Ia.LightmapTextureEnabled&&_.setTexture("lightmapSampler",this._lightmapTexture),Ia.SpecularTextureEnabled&&(this._metallicTexture?_.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&_.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&_.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._reflectanceTexture&&h.REFLECTANCE&&_.setTexture("reflectanceSampler",this._reflectanceTexture),this._microSurfaceTexture&&_.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&u.getCaps().standardDerivatives&&Ia.BumpTextureEnabled&&!this._disableBumpMap&&_.setTexture("bumpSampler",this._bumpTexture)),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(c),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),zs(this._activeEffect,this,a),this.bindEyePosition(c)}else a.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);!d&&this.isFrozen||(a.lightsEnabled&&!this._disableLighting&&Hs.BindLights(a,t,this._activeEffect,h,this._maxSimultaneousLights),(a.fogEnabled&&t.applyFog&&a.fogMode!==Yi.FOGMODE_NONE||p||this.subSurface.refractionTexture||t.receiveShadows||h.PREPASS)&&this.bindView(c),Hs.BindFogParameters(a,t,this._activeEffect,!0),h.NUM_MORPH_INFLUENCERS&&Hs.BindMorphTargetParameters(t,this._activeEffect),h.BAKED_VERTEX_ANIMATION_TEXTURE&&(null===(o=t.bakedVertexAnimationManager)||void 0===o||o.bind(c,h.INSTANCES)),this._imageProcessingConfiguration.bind(this._activeEffect),Hs.BindLogDepth(h,this._activeEffect,a)),this._afterBind(t,this._activeEffect),_.update()}getAnimatables(){const e=super.getAnimatables();return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&e.push(this._albedoTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?e.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&e.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._metallicReflectanceTexture&&this._metallicReflectanceTexture.animations&&this._metallicReflectanceTexture.animations.length>0&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&this._reflectanceTexture.animations&&this._reflectanceTexture.animations.length>0&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&this._microSurfaceTexture.animations&&this._microSurfaceTexture.animations.length>0&&e.push(this._microSurfaceTexture),e}_getReflectionTexture(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture}getActiveTextures(){const e=super.getActiveTextures();return this._albedoTexture&&e.push(this._albedoTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._reflectivityTexture&&e.push(this._reflectivityTexture),this._metallicTexture&&e.push(this._metallicTexture),this._metallicReflectanceTexture&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&e.push(this._microSurfaceTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),e}hasTexture(e){return!!super.hasTexture(e)||this._albedoTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._reflectivityTexture===e||this._metallicTexture===e||this._metallicReflectanceTexture===e||this._reflectanceTexture===e||this._microSurfaceTexture===e||this._bumpTexture===e||this._lightmapTexture===e}setPrePassRenderer(){var e;if(!(null===(e=this.subSurface)||void 0===e?void 0:e.isScatteringEnabled))return!1;const t=this.getScene().enableSubSurfaceForPrePass();return t&&(t.enabled=!0),!0}dispose(e,t){var i,s,r,n,o,a,l,h,c,u,d,p;t&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),null===(i=this._albedoTexture)||void 0===i||i.dispose(),null===(s=this._ambientTexture)||void 0===s||s.dispose(),null===(r=this._opacityTexture)||void 0===r||r.dispose(),null===(n=this._reflectionTexture)||void 0===n||n.dispose(),null===(o=this._emissiveTexture)||void 0===o||o.dispose(),null===(a=this._metallicTexture)||void 0===a||a.dispose(),null===(l=this._reflectivityTexture)||void 0===l||l.dispose(),null===(h=this._bumpTexture)||void 0===h||h.dispose(),null===(c=this._lightmapTexture)||void 0===c||c.dispose(),null===(u=this._metallicReflectanceTexture)||void 0===u||u.dispose(),null===(d=this._reflectanceTexture)||void 0===d||d.dispose(),null===(p=this._microSurfaceTexture)||void 0===p||p.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}}Nd.PBRMATERIAL_OPAQUE=sr.MATERIAL_OPAQUE,Nd.PBRMATERIAL_ALPHATEST=sr.MATERIAL_ALPHATEST,Nd.PBRMATERIAL_ALPHABLEND=sr.MATERIAL_ALPHABLEND,Nd.PBRMATERIAL_ALPHATESTANDBLEND=sr.MATERIAL_ALPHATESTANDBLEND,Nd.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0,Nd.LIGHTFALLOFF_PHYSICAL=0,Nd.LIGHTFALLOFF_GLTF=1,Nd.LIGHTFALLOFF_STANDARD=2,me([ce()],Nd.prototype,"_imageProcessingConfiguration",void 0),me([te("_markAllSubMeshesAsMiscDirty")],Nd.prototype,"debugMode",void 0);class Fd extends Nd{get refractionTexture(){return this.subSurface.refractionTexture}set refractionTexture(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)}get indexOfRefraction(){return this.subSurface.indexOfRefraction}set indexOfRefraction(e){this.subSurface.indexOfRefraction=e}get invertRefractionY(){return this.subSurface.invertRefractionY}set invertRefractionY(e){this.subSurface.invertRefractionY=e}get linkRefractionWithTransparency(){return this.subSurface.linkRefractionWithTransparency}set linkRefractionWithTransparency(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=!0)}get usePhysicalLightFalloff(){return this._lightFalloff===Nd.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),this._lightFalloff=e?Nd.LIGHTFALLOFF_PHYSICAL:Nd.LIGHTFALLOFF_STANDARD)}get useGLTFLightFalloff(){return this._lightFalloff===Nd.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),this._lightFalloff=e?Nd.LIGHTFALLOFF_GLTF:Nd.LIGHTFALLOFF_STANDARD)}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}constructor(e,t){super(e,t),this.directIntensity=1,this.emissiveIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.disableBumpMap=!1,this.ambientTextureStrength=1,this.ambientTextureImpactOnAnalyticalLights=Fd.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this.metallicF0Factor=1,this.metallicReflectanceColor=N.White(),this.useOnlyMetallicFromMetallicReflectanceTexture=!1,this.ambientColor=new N(0,0,0),this.albedoColor=new N(1,1,1),this.reflectivityColor=new N(1,1,1),this.reflectionColor=new N(1,1,1),this.emissiveColor=new N(0,0,0),this.microSurface=1,this.useLightmapAsShadowmap=!1,this.useAlphaFromAlbedoTexture=!1,this.forceAlphaTest=!1,this.alphaCutOff=.4,this.useSpecularOverAlpha=!0,this.useMicroSurfaceFromReflectivityMapAlpha=!1,this.useRoughnessFromMetallicTextureAlpha=!0,this.useRoughnessFromMetallicTextureGreen=!1,this.useMetallnessFromMetallicTextureBlue=!1,this.useAmbientOcclusionFromMetallicTextureRed=!1,this.useAmbientInGrayScale=!1,this.useAutoMicroSurfaceFromReflectivityMap=!1,this.useRadianceOverAlpha=!0,this.useObjectSpaceNormalMap=!1,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.disableLighting=!1,this.forceIrradianceInFragment=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.twoSidedLighting=!1,this.useAlphaFresnel=!1,this.useLinearAlphaFresnel=!1,this.environmentBRDFTexture=null,this.forceNormalForward=!1,this.enableSpecularAntiAliasing=!1,this.useHorizonOcclusion=!0,this.useRadianceOcclusion=!0,this.unlit=!1,this.applyDecalMapAfterDetailMap=!1,this._environmentBRDFTexture=vd(this.getScene())}getClassName(){return"PBRMaterial"}clone(e,t=!0,i=""){const s=de.Clone((()=>new Fd(e,this.getScene())),this,{cloneTexturesOnlyOnce:t});return s.id=e,s.name=e,this.stencil.copyTo(s.stencil),this._clonePlugins(s,i),s}serialize(){const e=super.serialize();return e.customType="BABYLON.PBRMaterial",e}static Parse(e,t,i){const s=de.Parse((()=>new Fd(e.name,t)),e,t,i);return e.stencil&&s.stencil.parse(e.stencil,t,i),sr._parsePlugins(e,s,t,i),e.clearCoat&&s.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&s.anisotropy.parse(e.anisotropy,t,i),e.brdf&&s.brdf.parse(e.brdf,t,i),e.sheen&&s.sheen.parse(e.sheen,t,i),e.subSurface&&s.subSurface.parse(e.subSurface,t,i),e.iridescence&&s.iridescence.parse(e.iridescence,t,i),s}}Fd.PBRMATERIAL_OPAQUE=Nd.PBRMATERIAL_OPAQUE,Fd.PBRMATERIAL_ALPHATEST=Nd.PBRMATERIAL_ALPHATEST,Fd.PBRMATERIAL_ALPHABLEND=Nd.PBRMATERIAL_ALPHABLEND,Fd.PBRMATERIAL_ALPHATESTANDBLEND=Nd.PBRMATERIAL_ALPHATESTANDBLEND,Fd.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=Nd.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"directIntensity",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"emissiveIntensity",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"environmentIntensity",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"specularIntensity",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"disableBumpMap",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"albedoTexture",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"ambientTexture",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"ambientTextureStrength",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"ambientTextureImpactOnAnalyticalLights",void 0),me([se(),te("_markAllSubMeshesAsTexturesAndMiscDirty")],Fd.prototype,"opacityTexture",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"reflectionTexture",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"emissiveTexture",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"reflectivityTexture",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"metallicTexture",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"metallic",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"roughness",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"metallicF0Factor",void 0),me([re(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"metallicReflectanceColor",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"metallicReflectanceTexture",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"reflectanceTexture",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"microSurfaceTexture",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"bumpTexture",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty",null)],Fd.prototype,"lightmapTexture",void 0),me([re("ambient"),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"ambientColor",void 0),me([re("albedo"),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"albedoColor",void 0),me([re("reflectivity"),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"reflectivityColor",void 0),me([re("reflection"),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"reflectionColor",void 0),me([re("emissive"),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"emissiveColor",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"microSurface",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"useLightmapAsShadowmap",void 0),me([ie(),te("_markAllSubMeshesAsTexturesAndMiscDirty")],Fd.prototype,"useAlphaFromAlbedoTexture",void 0),me([ie(),te("_markAllSubMeshesAsTexturesAndMiscDirty")],Fd.prototype,"forceAlphaTest",void 0),me([ie(),te("_markAllSubMeshesAsTexturesAndMiscDirty")],Fd.prototype,"alphaCutOff",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"useSpecularOverAlpha",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"useRoughnessFromMetallicTextureAlpha",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"useRoughnessFromMetallicTextureGreen",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"useMetallnessFromMetallicTextureBlue",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"useAmbientInGrayScale",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0),me([ie()],Fd.prototype,"usePhysicalLightFalloff",null),me([ie()],Fd.prototype,"useGLTFLightFalloff",null),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"useRadianceOverAlpha",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"useObjectSpaceNormalMap",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"useParallax",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"useParallaxOcclusion",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"parallaxScaleBias",void 0),me([ie(),te("_markAllSubMeshesAsLightsDirty")],Fd.prototype,"disableLighting",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"forceIrradianceInFragment",void 0),me([ie(),te("_markAllSubMeshesAsLightsDirty")],Fd.prototype,"maxSimultaneousLights",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"invertNormalMapX",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"invertNormalMapY",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"twoSidedLighting",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"useAlphaFresnel",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"useLinearAlphaFresnel",void 0),me([te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"environmentBRDFTexture",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"forceNormalForward",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"enableSpecularAntiAliasing",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"useHorizonOcclusion",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],Fd.prototype,"useRadianceOcclusion",void 0),me([ie(),te("_markAllSubMeshesAsMiscDirty")],Fd.prototype,"unlit",void 0),me([ie(),te("_markAllSubMeshesAsMiscDirty")],Fd.prototype,"applyDecalMapAfterDetailMap",void 0),m("BABYLON.PBRMaterial",Fd);const wd=131072,Ld=131072;function Bd(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}const Ud=Bd("DXT1"),Vd=Bd("DXT3"),kd=Bd("DXT5"),Gd=Bd("DX10");class zd{static GetDDSInfo(e){const t=new Int32Array(e.buffer,e.byteOffset,31),i=new Int32Array(e.buffer,e.byteOffset,35);let s=1;t[2]&wd&&(s=Math.max(1,t[7]));const r=t[21],n=r===Gd?i[32]:0;let o=0;switch(r){case 113:o=2;break;case 116:o=1;break;case Gd:if(10===n){o=2;break}if(2===n){o=1;break}}return{width:t[4],height:t[3],mipmapCount:s,isFourCC:!(4&~t[20]),isRGB:!(64&~t[20]),isLuminance:(t[20]&Ld)===Ld,isCube:!(512&~t[28]),isCompressed:r===Ud||r===Vd||r===kd,dxgiFormat:n,textureType:o}}static _GetHalfFloatAsFloatRGBAArrayBuffer(e,t,i,s,r,n){const o=new Float32Array(s),a=new Uint16Array(r,i);let l=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=4*(t+i*e);o[l]=Mh(a[s]),o[l+1]=Mh(a[s+1]),o[l+2]=Mh(a[s+2]),zd.StoreLODInAlphaChannel?o[l+3]=n:o[l+3]=Mh(a[s+3]),l+=4}return o}static _GetHalfFloatRGBAArrayBuffer(e,t,i,s,r,n){if(zd.StoreLODInAlphaChannel){const o=new Uint16Array(s),a=new Uint16Array(r,i);let l=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=4*(t+i*e);o[l]=a[s],o[l+1]=a[s+1],o[l+2]=a[s+2],o[l+3]=Ph(n),l+=4}return o}return new Uint16Array(r,i,s)}static _GetFloatRGBAArrayBuffer(e,t,i,s,r,n){if(zd.StoreLODInAlphaChannel){const o=new Float32Array(s),a=new Float32Array(r,i);let l=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=4*(t+i*e);o[l]=a[s],o[l+1]=a[s+1],o[l+2]=a[s+2],o[l+3]=n,l+=4}return o}return new Float32Array(r,i,s)}static _GetFloatAsHalfFloatRGBAArrayBuffer(e,t,i,s,r,n){const o=new Uint16Array(s),a=new Float32Array(r,i);let l=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++)o[l]=Ph(a[l]),o[l+1]=Ph(a[l+1]),o[l+2]=Ph(a[l+2]),zd.StoreLODInAlphaChannel?o[l+3]=Ph(n):o[l+3]=Ph(a[l+3]),l+=4;return o}static _GetFloatAsUIntRGBAArrayBuffer(e,t,i,s,r,n){const o=new Uint8Array(s),a=new Float32Array(r,i);let h=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=4*(t+i*e);o[h]=255*l.Clamp(a[s]),o[h+1]=255*l.Clamp(a[s+1]),o[h+2]=255*l.Clamp(a[s+2]),zd.StoreLODInAlphaChannel?o[h+3]=n:o[h+3]=255*l.Clamp(a[s+3]),h+=4}return o}static _GetHalfFloatAsUIntRGBAArrayBuffer(e,t,i,s,r,n){const o=new Uint8Array(s),a=new Uint16Array(r,i);let h=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=4*(t+i*e);o[h]=255*l.Clamp(Mh(a[s])),o[h+1]=255*l.Clamp(Mh(a[s+1])),o[h+2]=255*l.Clamp(Mh(a[s+2])),zd.StoreLODInAlphaChannel?o[h+3]=n:o[h+3]=255*l.Clamp(Mh(a[s+3])),h+=4}return o}static _GetRGBAArrayBuffer(e,t,i,s,r,n,o,a,l){const h=new Uint8Array(s),c=new Uint8Array(r,i);let u=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=4*(t+i*e);h[u]=c[s+n],h[u+1]=c[s+o],h[u+2]=c[s+a],h[u+3]=c[s+l],u+=4}return h}static _ExtractLongWordOrder(e){return 0===e||255===e||-16777216===e?0:1+zd._ExtractLongWordOrder(e>>8)}static _GetRGBArrayBuffer(e,t,i,s,r,n,o,a){const l=new Uint8Array(s),h=new Uint8Array(r,i);let c=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=3*(t+i*e);l[c]=h[s+n],l[c+1]=h[s+o],l[c+2]=h[s+a],c+=3}return l}static _GetLuminanceArrayBuffer(e,t,i,s,r){const n=new Uint8Array(s),o=new Uint8Array(r,i);let a=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=t+i*e;n[a]=o[s],a++}return n}static UploadDDSLevels(e,t,i,s,r,n,o=-1,a,l=!0){let h=null;s.sphericalPolynomial&&(h=[]);const c=!!e.getCaps().s3tc;t.generateMipMaps=r;const u=new Int32Array(i.buffer,i.byteOffset,31);let d,p,_,f,m,g,v,x=0,T=0,E=1;if(542327876!==u[0])return void k.Error("Invalid magic number in DDS header");if(!s.isFourCC&&!s.isRGB&&!s.isLuminance)return void k.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");if(s.isCompressed&&!c)return void k.Error("Compressed textures are not supported on this platform.");let S=u[22];f=u[1]+4;let b=!1;if(s.isFourCC)switch(d=u[21],d){case Ud:E=8,T=33777;break;case Vd:E=16,T=33778;break;case kd:E=16,T=33779;break;case 113:b=!0,S=64;break;case 116:b=!0,S=128;break;case Gd:{f+=20;let e=!1;switch(s.dxgiFormat){case 10:b=!0,S=64,e=!0;break;case 2:b=!0,S=128,e=!0;break;case 88:s.isRGB=!0,s.isFourCC=!1,S=32,e=!0}if(e)break}default:return void console.error("Unsupported FourCC code:",(C=d,String.fromCharCode(255&C,C>>8&255,C>>16&255,C>>24&255)))}var C;const y=zd._ExtractLongWordOrder(u[23]),A=zd._ExtractLongWordOrder(u[24]),R=zd._ExtractLongWordOrder(u[25]),I=zd._ExtractLongWordOrder(u[26]);b&&(T=e._getRGBABufferInternalSizedFormat(s.textureType)),g=1,u[2]&wd&&!1!==r&&(g=Math.max(1,u[7]));const P=a||0,M=e.getCaps();for(let r=P;r<n;r++){for(p=u[4],_=u[3],v=0;v<g;++v){if(-1===o||o===v){const n=-1===o?v:0;if(!s.isCompressed&&s.isFourCC){t.format=5,x=p*_*4;let s=null;if(e._badOS||e._badDesktopOS||!M.textureHalfFloat&&!M.textureFloat)128===S?(s=zd._GetFloatAsUIntRGBAArrayBuffer(p,_,i.byteOffset+f,x,i.buffer,n),h&&0==n&&h.push(zd._GetFloatRGBAArrayBuffer(p,_,i.byteOffset+f,x,i.buffer,n))):64===S&&(s=zd._GetHalfFloatAsUIntRGBAArrayBuffer(p,_,i.byteOffset+f,x,i.buffer,n),h&&0==n&&h.push(zd._GetHalfFloatAsFloatRGBAArrayBuffer(p,_,i.byteOffset+f,x,i.buffer,n))),t.type=0;else{const e=M.textureFloat&&(l&&M.textureFloatLinearFiltering||!l),r=M.textureHalfFloat&&(l&&M.textureHalfFloatLinearFiltering||!l),o=(128===S||64===S&&!r)&&e?1:(64===S||128===S&&!e)&&r?2:0;let a,c=null;if(128===S)switch(o){case 1:a=zd._GetFloatRGBAArrayBuffer,c=null;break;case 2:a=zd._GetFloatAsHalfFloatRGBAArrayBuffer,c=zd._GetFloatRGBAArrayBuffer;break;case 0:a=zd._GetFloatAsUIntRGBAArrayBuffer,c=zd._GetFloatRGBAArrayBuffer}else switch(o){case 1:a=zd._GetHalfFloatAsFloatRGBAArrayBuffer,c=null;break;case 2:a=zd._GetHalfFloatRGBAArrayBuffer,c=zd._GetHalfFloatAsFloatRGBAArrayBuffer;break;case 0:a=zd._GetHalfFloatAsUIntRGBAArrayBuffer,c=zd._GetHalfFloatAsFloatRGBAArrayBuffer}t.type=o,s=a(p,_,i.byteOffset+f,x,i.buffer,n),h&&0==n&&h.push(c?c(p,_,i.byteOffset+f,x,i.buffer,n):s)}s&&e._uploadDataToTextureDirectly(t,s,r,n)}else if(s.isRGB)t.type=0,24===S?(t.format=4,x=p*_*3,m=zd._GetRGBArrayBuffer(p,_,i.byteOffset+f,x,i.buffer,y,A,R),e._uploadDataToTextureDirectly(t,m,r,n)):(t.format=5,x=p*_*4,m=zd._GetRGBAArrayBuffer(p,_,i.byteOffset+f,x,i.buffer,y,A,R,I),e._uploadDataToTextureDirectly(t,m,r,n));else if(s.isLuminance){const s=e._getUnpackAlignement(),o=p;x=Math.floor((p+s-1)/s)*s*(_-1)+o,m=zd._GetLuminanceArrayBuffer(p,_,i.byteOffset+f,x,i.buffer),t.format=1,t.type=0,e._uploadDataToTextureDirectly(t,m,r,n)}else x=Math.max(4,p)/4*Math.max(4,_)/4*E,m=new Uint8Array(i.buffer,i.byteOffset+f,x),t.type=0,e._uploadCompressedDataToTextureDirectly(t,T,p,_,m,r,n)}f+=S?p*_*(S/8):x,p*=.5,_*=.5,p=Math.max(1,p),_=Math.max(1,_)}if(void 0!==a)break}h&&h.length>0?s.sphericalPolynomial=Fh.ConvertCubeMapToSphericalPolynomial({size:u[4],right:h[0],left:h[1],up:h[2],down:h[3],front:h[4],back:h[5],format:5,type:1,gammaSpace:!1}):s.sphericalPolynomial=void 0}}zd.StoreLODInAlphaChannel=!1,bt.prototype.createPrefilteredCubeTexture=function(e,t,i,s,r=null,n=null,o,a=null,h=!0){return this.createCubeTexture(e,t,null,!1,(e=>{if(!e)return void(r&&r(null));const n=e.texture;if(h?e.info.sphericalPolynomial&&(n._sphericalPolynomial=e.info.sphericalPolynomial):n._sphericalPolynomial=new yh,n._source=ut.CubePrefiltered,this.getCaps().textureLOD)return void(r&&r(n));const o=this._gl,a=e.width;if(!a)return;const c=[];for(let r=0;r<3;r++){const h=1-r/2,u=s,d=l.Log2(a)*i+s,p=u+(d-u)*h,_=Math.round(Math.min(Math.max(p,0),d)),f=new dt(this,ut.Temp);if(f.type=n.type,f.format=n.format,f.width=Math.pow(2,Math.max(l.Log2(a)-_,0)),f.height=f.width,f.isCube=!0,f._cachedWrapU=0,f._cachedWrapV=0,this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,f,!0),f.samplingMode=2,o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MIN_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),e.isDDS){const t=e.info,i=e.data;this._unpackFlipY(t.isCompressed),zd.UploadDDSLevels(this,f,i,t,!0,6,_)}else k.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,null);const m=new Cr(t);m._isCube=!0,m._texture=f,f.isReady=!0,c.push(m)}n._lodTextureHigh=c[2],n._lodTextureMid=c[1],n._lodTextureLow=c[0],r&&r(n)}),n,o,a,h,i,s)},Ns._TextureLoaders.push(new class{constructor(){this.supportCascades=!0}canLoad(e){return e.endsWith(".dds")}loadCubeData(e,t,i,s){const r=t.getEngine();let n,o=!1,a=1e3;if(Array.isArray(e))for(let i=0;i<e.length;i++){const s=e[i];n=zd.GetDDSInfo(s),t.width=n.width,t.height=n.height,o=(n.isRGB||n.isLuminance||n.mipmapCount>1)&&t.generateMipMaps,r._unpackFlipY(n.isCompressed),zd.UploadDDSLevels(r,t,s,n,o,6,-1,i),n.isFourCC||1!==n.mipmapCount?a=n.mipmapCount-1:r.generateMipMapsForCubemap(t)}else{const s=e;n=zd.GetDDSInfo(s),t.width=n.width,t.height=n.height,i&&(n.sphericalPolynomial=new yh),o=(n.isRGB||n.isLuminance||n.mipmapCount>1)&&t.generateMipMaps,r._unpackFlipY(n.isCompressed),zd.UploadDDSLevels(r,t,s,n,o,6),n.isFourCC||1!==n.mipmapCount?a=n.mipmapCount-1:r.generateMipMapsForCubemap(t,!1)}r._setCubeMapTextureParams(t,o,a),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s({isDDS:!0,width:t.width,info:n,data:e,texture:t})}loadData(e,t,i){const s=zd.GetDDSInfo(e),r=(s.isRGB||s.isLuminance||s.mipmapCount>1)&&t.generateMipMaps&&s.width>>s.mipmapCount-1==1;i(s.width,s.height,r,s.isFourCC,(()=>{zd.UploadDDSLevels(t.getEngine(),t,e,s,r,1)}))}}),Ns._TextureLoaders.push(new class{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".env")}loadCubeData(e,t,i,s,r){if(Array.isArray(e))return;const n=Uh(e);if(n){t.width=n.width,t.height=n.width;try{Wh(t,n),function(e,t,i){const s=(i=Vh(i)).specular;return s?(e._lodGenerationScale=s.lodGenerationScale,zh(e,kh(t,i),i.imageType)):Promise.resolve()}(t,e,n).then((()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()}),(e=>{null==r||r("Can not upload environment levels",e)}))}catch(e){null==r||r("Can not upload environment file",e)}}else r&&r("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}});class Wd{constructor(e,t){if(this.data=e,this.isInvalid=!1,!Wd.IsValid(e))return this.isInvalid=!0,void k.Error("texture missing KTX identifier");const i=Uint32Array.BYTES_PER_ELEMENT,s=new DataView(this.data.buffer,this.data.byteOffset+12,13*i),r=67305985===s.getUint32(0,!0);return this.glType=s.getUint32(1*i,r),this.glTypeSize=s.getUint32(2*i,r),this.glFormat=s.getUint32(3*i,r),this.glInternalFormat=s.getUint32(4*i,r),this.glBaseInternalFormat=s.getUint32(5*i,r),this.pixelWidth=s.getUint32(6*i,r),this.pixelHeight=s.getUint32(7*i,r),this.pixelDepth=s.getUint32(8*i,r),this.numberOfArrayElements=s.getUint32(9*i,r),this.numberOfFaces=s.getUint32(10*i,r),this.numberOfMipmapLevels=s.getUint32(11*i,r),this.bytesOfKeyValueData=s.getUint32(12*i,r),0!==this.glType?(k.Error("only compressed formats currently supported"),void(this.isInvalid=!0)):(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0===this.pixelHeight||0!==this.pixelDepth?(k.Error("only 2D textures currently supported"),void(this.isInvalid=!0)):0!==this.numberOfArrayElements?(k.Error("texture arrays not currently supported"),void(this.isInvalid=!0)):this.numberOfFaces!==t?(k.Error("number of faces expected"+t+", but found "+this.numberOfFaces),void(this.isInvalid=!0)):void(this.loadType=Wd.COMPRESSED_2D))}uploadLevels(e,t){switch(this.loadType){case Wd.COMPRESSED_2D:this._upload2DCompressedLevels(e,t);case Wd.TEX_2D:case Wd.COMPRESSED_3D:case Wd.TEX_3D:}}_upload2DCompressedLevels(e,t){let i=Wd.HEADER_LEN+this.bytesOfKeyValueData,s=this.pixelWidth,r=this.pixelHeight;const n=t?this.numberOfMipmapLevels:1;for(let t=0;t<n;t++){const n=new Int32Array(this.data.buffer,this.data.byteOffset+i,1)[0];i+=4;for(let o=0;o<this.numberOfFaces;o++){const a=new Uint8Array(this.data.buffer,this.data.byteOffset+i,n);e.getEngine()._uploadCompressedDataToTextureDirectly(e,e.format,s,r,a,o,t),i+=n,i+=3-(n+3)%4}s=Math.max(1,.5*s),r=Math.max(1,.5*r)}}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&49===t[5]&&49===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return!0}return!1}}Wd.HEADER_LEN=64,Wd.COMPRESSED_2D=0,Wd.COMPRESSED_3D=1,Wd.TEX_2D=2,Wd.TEX_3D=3;class Hd{constructor(e){this._pendingActions=new Array,this._workerInfos=e.map((e=>({workerPromise:Promise.resolve(e),idle:!0})))}dispose(){for(const e of this._workerInfos)e.workerPromise.then((e=>{e.terminate()}));this._workerInfos.length=0,this._pendingActions.length=0}push(e){this._executeOnIdleWorker(e)||this._pendingActions.push(e)}_executeOnIdleWorker(e){for(const t of this._workerInfos)if(t.idle)return this._execute(t,e),!0;return!1}_execute(e,t){e.idle=!1,e.workerPromise.then((i=>{t(i,(()=>{const t=this._pendingActions.shift();t?this._execute(e,t):e.idle=!0}))}))}}class Xd extends Hd{constructor(e,t,i=Xd.DefaultOptions){super([]),this._maxWorkers=e,this._createWorkerAsync=t,this._options=i}push(e){if(!this._executeOnIdleWorker(e))if(this._workerInfos.length<this._maxWorkers){const t={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(t),this._execute(t,e)}else this._pendingActions.push(e)}_execute(e,t){e.timeoutId&&(clearTimeout(e.timeoutId),delete e.timeoutId),super._execute(e,((i,s)=>{t(i,(()=>{s(),e.idle&&(e.timeoutId=setTimeout((()=>{e.workerPromise.then((e=>{e.terminate()}));const t=this._workerInfos.indexOf(e);-1!==t&&this._workerInfos.splice(t,1)}),this._options.idleTimeElapsedBeforeRelease))}))}))}}var Yd,jd,Kd;function $d(e){e.wasmUASTCToASTC&&(KTX2DECODER.LiteTranscoder_UASTC_ASTC.WasmModuleURL=e.wasmUASTCToASTC),e.wasmUASTCToBC7&&(KTX2DECODER.LiteTranscoder_UASTC_BC7.WasmModuleURL=e.wasmUASTCToBC7),e.wasmUASTCToRGBA_UNORM&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=e.wasmUASTCToRGBA_UNORM),e.wasmUASTCToRGBA_SRGB&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=e.wasmUASTCToRGBA_SRGB),e.wasmUASTCToR8_UNORM&&(KTX2DECODER.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=e.wasmUASTCToR8_UNORM),e.wasmUASTCToRG8_UNORM&&(KTX2DECODER.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=e.wasmUASTCToRG8_UNORM),e.jsMSCTranscoder&&(KTX2DECODER.MSCTranscoder.JSModuleURL=e.jsMSCTranscoder),e.wasmMSCTranscoder&&(KTX2DECODER.MSCTranscoder.WasmModuleURL=e.wasmMSCTranscoder),e.wasmZSTDDecoder&&(KTX2DECODER.ZSTDDecoder.WasmModuleURL=e.wasmZSTDDecoder)}Xd.DefaultOptions={idleTimeElapsedBeforeRelease:1e3},function(e){e[e.ETC1S=0]="ETC1S",e[e.UASTC4x4=1]="UASTC4x4"}(Yd||(Yd={})),function(e){e[e.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",e[e.BC7_RGBA=1]="BC7_RGBA",e[e.BC3_RGBA=2]="BC3_RGBA",e[e.BC1_RGB=3]="BC1_RGB",e[e.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",e[e.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",e[e.ETC2_RGBA=6]="ETC2_RGBA",e[e.ETC1_RGB=7]="ETC1_RGB",e[e.RGBA32=8]="RGBA32",e[e.R8=9]="R8",e[e.RG8=10]="RG8"}(jd||(jd={})),function(e){e[e.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",e[e.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.RGBA8Format=32856]="RGBA8Format",e[e.R8Format=33321]="R8Format",e[e.RG8Format=33323]="RG8Format"}(Kd||(Kd={}));class qd{static GetDefaultNumWorkers(){return"object"==typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static _Initialize(e){if(qd._WorkerPoolPromise||qd._DecoderModulePromise)return;const t={jsDecoderModule:Ht.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),wasmUASTCToASTC:Ht.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),wasmUASTCToBC7:Ht.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),wasmUASTCToRGBA_UNORM:Ht.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),wasmUASTCToRGBA_SRGB:Ht.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),wasmUASTCToR8_UNORM:Ht.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),wasmUASTCToRG8_UNORM:Ht.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),jsMSCTranscoder:Ht.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),wasmMSCTranscoder:Ht.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),wasmZSTDDecoder:Ht.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};e&&"function"==typeof Worker&&"undefined"!=typeof URL?qd._WorkerPoolPromise=new Promise((i=>{const s=`${$d}(${Qd})()`,r=URL.createObjectURL(new Blob([s],{type:"application/javascript"}));i(new Xd(e,(()=>new Promise(((e,i)=>{const s=new Worker(r),n=e=>{s.removeEventListener("error",n),s.removeEventListener("message",o),i(e)},o=t=>{"init"===t.data.action&&(s.removeEventListener("error",n),s.removeEventListener("message",o),e(s))};s.addEventListener("error",n),s.addEventListener("message",o),s.postMessage({action:"init",urls:t})})))))})):"undefined"==typeof KTX2DECODER?qd._DecoderModulePromise=Ht.LoadBabylonScriptAsync(t.jsDecoderModule).then((()=>(KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,$d(t),new KTX2DECODER.KTX2Decoder))):(KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,qd._DecoderModulePromise=Promise.resolve(new KTX2DECODER.KTX2Decoder))}constructor(e,t=qd.DefaultNumWorkers){this._engine=e,qd._Initialize(t)}uploadAsync(e,t,i){const s=this._engine.getCaps(),r={astc:!!s.astc,bptc:!!s.bptc,s3tc:!!s.s3tc,pvrtc:!!s.pvrtc,etc2:!!s.etc2,etc1:!!s.etc1};if(qd._WorkerPoolPromise)return qd._WorkerPoolPromise.then((s=>new Promise(((n,o)=>{s.push(((s,a)=>{const l=e=>{s.removeEventListener("error",l),s.removeEventListener("message",h),o(e),a()},h=e=>{if("decoded"===e.data.action){if(s.removeEventListener("error",l),s.removeEventListener("message",h),e.data.success)try{this._createTexture(e.data.decodedData,t,i),n()}catch(e){o({message:e})}else o({message:e.data.msg});a()}};s.addEventListener("error",l),s.addEventListener("message",h),s.postMessage({action:"setDefaultDecoderOptions",options:qd.DefaultDecoderOptions._getKTX2DecoderOptions()});const c=new Uint8Array(e.byteLength);c.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),s.postMessage({action:"decode",data:c,caps:r,options:i},[c.buffer])}))}))));if(qd._DecoderModulePromise)return qd._DecoderModulePromise.then((i=>(qd.DefaultDecoderOptions.isDirty&&(KTX2DECODER.KTX2Decoder.DefaultDecoderOptions=qd.DefaultDecoderOptions._getKTX2DecoderOptions()),new Promise(((r,n)=>{i.decode(e,s).then((e=>{this._createTexture(e,t),r()})).catch((e=>{n({message:e})}))})))));throw new Error("KTX2 decoder module is not available")}_createTexture(e,t,i){this._engine._bindTextureDirectly(3553,t),i&&(i.transcodedFormat=e.transcodedFormat,i.isInGammaSpace=e.isInGammaSpace,i.hasAlpha=e.hasAlpha,i.transcoderName=e.transcoderName);let s=!0;switch(e.transcodedFormat){case 32856:t.type=0,t.format=5;break;case 33321:t.type=0,t.format=6;break;case 33323:t.type=0,t.format=7;break;default:t.format=e.transcodedFormat,s=!1}if(t._gammaSpace=e.isInGammaSpace,t.generateMipMaps=e.mipmaps.length>1,e.errors)throw new Error("KTX2 container - could not transcode the data. "+e.errors);for(let i=0;i<e.mipmaps.length;++i){const r=e.mipmaps[i];if(!r||!r.data)throw new Error("KTX2 container - could not transcode one of the image");s?(t.width=r.width,t.height=r.height,this._engine._uploadDataToTextureDirectly(t,r.data,0,i,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(t,e.transcodedFormat,r.width,r.height,r.data,0,i)}t._extension=".ktx2",t.width=e.mipmaps[0].width,t.height=e.mipmaps[0].height,t.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&50===t[5]&&48===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return!0}return!1}}function Qd(){let e;onmessage=t=>{if(t.data)switch(t.data.action){case"init":{const i=t.data.urls;importScripts(i.jsDecoderModule),$d(i),e=new KTX2DECODER.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":KTX2DECODER.KTX2Decoder.DefaultDecoderOptions=t.data.options;break;case"decode":e.decode(t.data.data,t.data.caps,t.data.options).then((e=>{const t=[];for(let i=0;i<e.mipmaps.length;++i){const s=e.mipmaps[i];s&&s.data&&t.push(s.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:e},t)})).catch((e=>{postMessage({action:"decoded",success:!1,msg:e})}))}}}qd.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},qd.DefaultNumWorkers=qd.GetDefaultNumWorkers(),qd.DefaultDecoderOptions=new class{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(e){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==e&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=e,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(e){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==e&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=e,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(e){this._forceRGBA!==e&&(this._forceRGBA=e,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(e){this._forceR8!==e&&(this._forceR8=e,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(e){this._forceRG8!==e&&(this._forceRG8=e,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(e){this._bypassTranscoders!==e&&(this._bypassTranscoders=e,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const e={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(e.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[jd.BC1_RGB,jd.BC3_RGBA],yes:{transcodeFormat:jd.RGBA32,engineFormat:Kd.RGBA8Format,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=e,e}},Ns._TextureLoaders.unshift(new class{constructor(){this.supportCascades=!1}canLoad(e,t){return e.endsWith(".ktx")||e.endsWith(".ktx2")||"image/ktx"===t||"image/ktx2"===t}loadCubeData(e,t,i,s){if(Array.isArray(e))return;t._invertVScale=!t.invertY;const r=t.getEngine(),n=new Wd(e,6),o=n.numberOfMipmapLevels>1&&t.generateMipMaps;r._unpackFlipY(!0),n.uploadLevels(t,t.generateMipMaps),t.width=n.pixelWidth,t.height=n.pixelHeight,r._setCubeMapTextureParams(t,o,n.numberOfMipmapLevels-1),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()}loadData(e,t,i,s){if(Wd.IsValid(e)){t._invertVScale=!t.invertY;const s=new Wd(e,1),r=function(e){switch(e){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(s.glInternalFormat);r?(t.format=r,t._useSRGBBuffer=t.getEngine()._getUseSRGBBuffer(!0,t.generateMipMaps),t._gammaSpace=!0):t.format=s.glInternalFormat,i(s.pixelWidth,s.pixelHeight,t.generateMipMaps,!0,(()=>{s.uploadLevels(t,t.generateMipMaps)}),s.isInvalid)}else qd.IsValid(e)?new qd(t.getEngine()).uploadAsync(e,t,s).then((()=>{i(t.width,t.height,t.generateMipMaps,!0,(()=>{}),!1)}),(e=>{k.Warn(`Failed to load KTX2 texture data: ${e.message}`),i(0,0,!1,!1,(()=>{}),!0)})):(k.Error("texture missing KTX identifier"),i(0,0,!1,!1,(()=>{}),!0))}});class Zd extends zo{constructor(e,t,i){super(e,S.Zero(),t),this._xrSessionManager=i,this._firstFrame=!1,this._referenceQuaternion=C.Identity(),this._referencedPosition=new S,this._trackingState=Za.NOT_TRACKING,this.onXRCameraInitializedObservable=new a,this.onBeforeCameraTeleport=new a,this.onAfterCameraTeleport=new a,this.onTrackingStateChanged=new a,this.compensateOnFirstFrame=!0,this._rotate180=new C(0,1,0,0),this.minZ=.1,this.rotationQuaternion=new C,this.cameraRigMode=ps.RIG_MODE_CUSTOM,this.updateUpVectorFromRotation=!0,this._updateNumberOfRigCameras(1),this.freezeProjectionMatrix(),this._deferOnly=!0,this._xrSessionManager.onXRSessionInit.add((()=>{this._referencedPosition.copyFromFloats(0,0,0),this._referenceQuaternion.copyFromFloats(0,0,0,1),this._firstFrame=this.compensateOnFirstFrame})),this._xrSessionManager.onXRFrameObservable.add((()=>{this._firstFrame&&this._updateFromXRSession(),this.onXRCameraInitializedObservable.hasObservers()&&(this.onXRCameraInitializedObservable.notifyObservers(this),this.onXRCameraInitializedObservable.clear()),this._deferredUpdated&&(this.position.copyFrom(this._deferredPositionUpdate),this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate)),this._updateReferenceSpace(),this._updateFromXRSession()}),void 0,!0)}get trackingState(){return this._trackingState}_setTrackingState(e){this._trackingState!==e&&(this._trackingState=e,this.onTrackingStateChanged.notifyObservers(e))}get realWorldHeight(){const e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.baseReferenceSpace);return e&&e.transform?e.transform.position.y:0}_updateForDualEyeDebugging(){this._updateNumberOfRigCameras(2),this.rigCameras[0].viewport=new ds(0,0,.5,1),this.rigCameras[0].outputRenderTarget=null,this.rigCameras[1].viewport=new ds(.5,0,.5,1),this.rigCameras[1].outputRenderTarget=null}setTransformationFromNonVRCamera(e=this.getScene().activeCamera,t=!0){e&&e!==this&&(e.computeWorldMatrix().decompose(void 0,this.rotationQuaternion,this.position),this.position.y=0,C.FromEulerAnglesToRef(0,this.rotationQuaternion.toEulerAngles().y,0,this.rotationQuaternion),this._firstFrame=!0,t&&this._xrSessionManager.resetReferenceSpace())}getClassName(){return"WebXRCamera"}setTarget(e){const t=R.Vector3[1];e.subtractToRef(this.position,t),t.y=0,t.normalize();const i=Math.atan2(t.x,t.z);this.rotationQuaternion.toEulerAnglesToRef(t),C.FromEulerAnglesToRef(t.x,i,t.z,this.rotationQuaternion)}dispose(){super.dispose(),this._lastXRViewerPose=void 0}_updateFromXRSession(){const e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.referenceSpace);if(this._lastXRViewerPose=e||void 0,!e)return void this._setTrackingState(Za.NOT_TRACKING);const t=e.emulatedPosition?Za.TRACKING_LOST:Za.TRACKING;if(this._setTrackingState(t),this.minZ!==this._cache.minZ||this.maxZ!==this._cache.maxZ){const e={depthFar:this.maxZ||1e4,depthNear:this.minZ};this._xrSessionManager.updateRenderState(e),this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ}if(e.transform){const t=e.transform.orientation;if(void 0===e.transform.orientation.x)return;const i=e.transform.position;this._referencedPosition.set(i.x,i.y,i.z),this._referenceQuaternion.set(t.x,t.y,t.z,t.w),this._scene.useRightHandedSystem||(this._referencedPosition.z*=-1,this._referenceQuaternion.z*=-1,this._referenceQuaternion.w*=-1),this._firstFrame?(this._firstFrame=!1,this.position.y+=this._referencedPosition.y,this._referenceQuaternion.copyFromFloats(0,0,0,1)):(this.rotationQuaternion.copyFrom(this._referenceQuaternion),this.position.copyFrom(this._referencedPosition))}this.rigCameras.length!==e.views.length&&this._updateNumberOfRigCameras(e.views.length),e.views.forEach(((e,t)=>{var i;const s=this.rigCameras[t];s.isLeftCamera||s.isRightCamera||("right"===e.eye?s._isRightCamera=!0:"left"===e.eye&&(s._isLeftCamera=!0));const r=e.transform.position,n=e.transform.orientation;s.parent=this.parent,s.position.set(r.x,r.y,r.z),s.rotationQuaternion.set(n.x,n.y,n.z,n.w),this._scene.useRightHandedSystem?s.rotationQuaternion.multiplyInPlace(this._rotate180):(s.position.z*=-1,s.rotationQuaternion.z*=-1,s.rotationQuaternion.w*=-1),y.FromFloat32ArrayToRefScaled(e.projectionMatrix,0,1,s._projectionMatrix),this._scene.useRightHandedSystem||s._projectionMatrix.toggleProjectionMatrixHandInPlace(),0===t&&this._projectionMatrix.copyFrom(s._projectionMatrix);const o=this._xrSessionManager.getRenderTargetTextureForView(e);this._renderingMultiview=(null===(i=null==o?void 0:o._texture)||void 0===i?void 0:i.isMultiview)||!1,this._renderingMultiview?0==t&&(this._xrSessionManager.trySetViewportForView(this.viewport,e),this.outputRenderTarget=o):(this._xrSessionManager.trySetViewportForView(s.viewport,e),s.outputRenderTarget=o||this._xrSessionManager.getRenderTargetTextureForView(e)),s.layerMask=this.layerMask}))}_updateNumberOfRigCameras(e=1){for(;this.rigCameras.length<e;){const e=new Go("XR-RigCamera: "+this.rigCameras.length,S.Zero(),this.getScene());e.minZ=.1,e.rotationQuaternion=new C,e.updateUpVectorFromRotation=!0,e.isRigCamera=!0,e.rigParent=this,e.freezeProjectionMatrix(),this.rigCameras.push(e)}for(;this.rigCameras.length>e;){const e=this.rigCameras.pop();e&&e.dispose()}}_updateReferenceSpace(){if(!this.position.equals(this._referencedPosition)||!this.rotationQuaternion.equals(this._referenceQuaternion)){const e=R.Matrix[0],t=R.Matrix[1],i=R.Matrix[2];y.ComposeToRef(Zd._ScaleReadOnly,this._referenceQuaternion,this._referencedPosition,e),y.ComposeToRef(Zd._ScaleReadOnly,this.rotationQuaternion,this.position,t),e.invert().multiplyToRef(t,i),i.invert(),this._scene.useRightHandedSystem||i.toggleModelMatrixHandInPlace(),i.decompose(void 0,this._referenceQuaternion,this._referencedPosition);const s=new XRRigidTransform({x:this._referencedPosition.x,y:this._referencedPosition.y,z:this._referencedPosition.z},{x:this._referenceQuaternion.x,y:this._referenceQuaternion.y,z:this._referenceQuaternion.z,w:this._referenceQuaternion.w});this._xrSessionManager.referenceSpace=this._xrSessionManager.referenceSpace.getOffsetReferenceSpace(s)}}}Zd._ScaleReadOnly=S.One();class Jd{constructor(e){this._scene=e,this._nonVRCamera=null,this._attachedToElement=!1,this._spectatorCamera=null,this._originalSceneAutoClear=!0,this._supported=!1,this._spectatorMode=!1,this._lastTimestamp=0,this.onInitialXRPoseSetObservable=new a,this.onStateChangedObservable=new a,this.state=Qa.NOT_IN_XR,this.sessionManager=new qa(e),this.camera=new Zd("webxr",e,this.sessionManager),this.featuresManager=new kr(this.sessionManager),e.onDisposeObservable.addOnce((()=>{this.dispose()}))}static CreateAsync(e){const t=new Jd(e);return t.sessionManager.initializeAsync().then((()=>(t._supported=!0,t))).catch((e=>{throw t._setState(Qa.NOT_IN_XR),t.dispose(),e}))}dispose(){var e;this.exitXRAsync(),this.camera.dispose(),this.onStateChangedObservable.clear(),this.onInitialXRPoseSetObservable.clear(),this.sessionManager.dispose(),null===(e=this._spectatorCamera)||void 0===e||e.dispose(),this._nonVRCamera&&(this._scene.activeCamera=this._nonVRCamera)}async enterXRAsync(e,t,i=this.sessionManager.getWebXRRenderTarget(),s={}){var r,n,o;if(!this._supported)throw"WebXR not supported in this browser or environment";this._setState(Qa.ENTERING_XR),"viewer"!==t&&"local"!==t&&(s.optionalFeatures=s.optionalFeatures||[],s.optionalFeatures.push(t)),s=await this.featuresManager._extendXRSessionInitObject(s),"immersive-ar"===e&&"unbounded"!==t&&k.Warn("We recommend using 'unbounded' reference space type when using 'immersive-ar' session mode");try{await this.sessionManager.initializeSessionAsync(e,s),await this.sessionManager.setReferenceSpaceTypeAsync(t);const a=await i.initializeXRLayerAsync(this.sessionManager.session),l={depthFar:this.camera.maxZ||1e4,depthNear:this.camera.minZ};return this.featuresManager.getEnabledFeature(Vr.LAYERS)||(l.baseLayer=a),this.sessionManager.updateRenderState(l),this.sessionManager.runXRRenderLoop(),this._originalSceneAutoClear=this._scene.autoClear,this._nonVRCamera=this._scene.activeCamera,this._attachedToElement=!!(null===(n=null===(r=this._nonVRCamera)||void 0===r?void 0:r.inputs)||void 0===n?void 0:n.attachedToElement),null===(o=this._nonVRCamera)||void 0===o||o.detachControl(),this._scene.activeCamera=this.camera,"immersive-ar"!==e?this._nonXRToXRCamera():(this._scene.autoClear=!1,this.camera.compensateOnFirstFrame=!1,this.camera.position.set(0,0,0),this.camera.rotationQuaternion.set(0,0,0,1),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)),this.sessionManager.onXRSessionEnded.addOnce((()=>{this.state!==Qa.EXITING_XR&&this._setState(Qa.EXITING_XR),this.camera.rigCameras.forEach((e=>{e.outputRenderTarget=null})),this._scene.autoClear=this._originalSceneAutoClear,this._scene.activeCamera=this._nonVRCamera,this._attachedToElement&&this._nonVRCamera&&this._nonVRCamera.attachControl(!!this._nonVRCamera.inputs.noPreventDefault),"immersive-ar"!==e&&this.camera.compensateOnFirstFrame&&(this._nonVRCamera.setPosition?this._nonVRCamera.setPosition(this.camera.position):this._nonVRCamera.position.copyFrom(this.camera.position)),this._setState(Qa.NOT_IN_XR)})),this.sessionManager.onXRFrameObservable.addOnce((()=>{this._setState(Qa.IN_XR)})),this.sessionManager}catch(e){throw console.log(e),console.log(e.message),this._setState(Qa.NOT_IN_XR),e}}exitXRAsync(){return this.state!==Qa.IN_XR?Promise.resolve():(this._setState(Qa.EXITING_XR),this.sessionManager.exitXRAsync())}enableSpectatorMode(e){this._spectatorMode||(this._spectatorMode=!0,this._switchSpectatorMode(e))}disableSpecatatorMode(){this._spectatorMode&&(this._spectatorMode=!1,this._switchSpectatorMode())}_switchSpectatorMode(e){const t=1/((null==e?void 0:e.fps)?e.fps:1e3)*1e3,i=(null==e?void 0:e.preferredCameraIndex)?null==e?void 0:e.preferredCameraIndex:0,s=()=>{this._spectatorCamera&&this.sessionManager.currentTimestamp-this._lastTimestamp>=t&&(this._lastTimestamp=this.sessionManager.currentTimestamp,this._spectatorCamera.position.copyFrom(this.camera.rigCameras[i].globalPosition),this._spectatorCamera.rotationQuaternion.copyFrom(this.camera.rigCameras[i].absoluteRotation))};if(this._spectatorMode){if(i>=this.camera.rigCameras.length)throw new Error("the preferred camera index is beyond the length of rig camera array.");const e=()=>{this.state===Qa.IN_XR?(this._spectatorCamera=new ta("webxr-spectator",S.Zero(),this._scene),this._spectatorCamera.rotationQuaternion=new C,this._scene.activeCameras=[this.camera,this._spectatorCamera],this.sessionManager.onXRFrameObservable.add(s),this._scene.onAfterRenderCameraObservable.add((e=>{e===this.camera&&(this._scene.getEngine().framebufferDimensionsObject=null)}))):this.state===Qa.EXITING_XR&&(this.sessionManager.onXRFrameObservable.removeCallback(s),this._scene.activeCameras=null)};this.onStateChangedObservable.add(e),e()}else this.sessionManager.onXRFrameObservable.removeCallback(s),this._scene.activeCameras=[this.camera]}_nonXRToXRCamera(){this.camera.setTransformationFromNonVRCamera(this._nonVRCamera),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)}_setState(e){this.state!==e&&(this.state=e,this.onStateChangedObservable.notifyObservers(this.state))}}class ep{constructor(e,t,i=-1,s=[]){this.id=e,this.type=t,this._buttonIndex=i,this._axesIndices=s,this._axes={x:0,y:0},this._changes={},this._currentValue=0,this._hasChanges=!1,this._pressed=!1,this._touched=!1,this.onAxisValueChangedObservable=new a,this.onButtonStateChangedObservable=new a}get axes(){return this._axes}get changes(){return this._changes}get hasChanges(){return this._hasChanges}get pressed(){return this._pressed}get touched(){return this._touched}get value(){return this._currentValue}dispose(){this.onAxisValueChangedObservable.clear(),this.onButtonStateChangedObservable.clear()}isAxes(){return 0!==this._axesIndices.length}isButton(){return-1!==this._buttonIndex}update(e){let t=!1,i=!1;if(this._hasChanges=!1,this._changes={},this.isButton()){const i=e.buttons[this._buttonIndex];if(!i)return;this._currentValue!==i.value&&(this.changes.value={current:i.value,previous:this._currentValue},t=!0,this._currentValue=i.value),this._touched!==i.touched&&(this.changes.touched={current:i.touched,previous:this._touched},t=!0,this._touched=i.touched),this._pressed!==i.pressed&&(this.changes.pressed={current:i.pressed,previous:this._pressed},t=!0,this._pressed=i.pressed)}this.isAxes()&&(this._axes.x!==e.axes[this._axesIndices[0]]&&(this.changes.axes={current:{x:e.axes[this._axesIndices[0]],y:this._axes.y},previous:{x:this._axes.x,y:this._axes.y}},this._axes.x=e.axes[this._axesIndices[0]],i=!0),this._axes.y!==e.axes[this._axesIndices[1]]&&(this.changes.axes?this.changes.axes.current.y=e.axes[this._axesIndices[1]]:this.changes.axes={current:{x:this._axes.x,y:e.axes[this._axesIndices[1]]},previous:{x:this._axes.x,y:this._axes.y}},this._axes.y=e.axes[this._axesIndices[1]],i=!0)),t&&(this._hasChanges=!0,this.onButtonStateChangedObservable.notifyObservers(this)),i&&(this._hasChanges=!0,this.onAxisValueChangedObservable.notifyObservers(this._axes))}}ep.BUTTON_TYPE="button",ep.SQUEEZE_TYPE="squeeze",ep.THUMBSTICK_TYPE="thumbstick",ep.TOUCHPAD_TYPE="touchpad",ep.TRIGGER_TYPE="trigger";class tp{constructor(e,t,i,s,r=!1,n){this.scene=e,this.layout=t,this.gamepadObject=i,this.handedness=s,this._doNotLoadControllerMesh=r,this._controllerCache=n,this._initComponent=e=>{if(!e)return;const t=this.layout.components[e],i=t.type,s=t.gamepadIndices.button,r=[];void 0!==t.gamepadIndices.xAxis&&void 0!==t.gamepadIndices.yAxis&&r.push(t.gamepadIndices.xAxis,t.gamepadIndices.yAxis),this.components[e]=new ep(e,i,s,r)},this._modelReady=!1,this.components={},this.disableAnimation=!1,this.onModelLoadedObservable=new a,t.components&&Object.keys(t.components).forEach(this._initComponent)}dispose(){this.getComponentIds().forEach((e=>this.getComponent(e).dispose())),this.rootMesh&&(this.rootMesh.getChildren(void 0,!0).forEach((e=>{e.setEnabled(!1)})),this.rootMesh.dispose(!!this._controllerCache,!this._controllerCache))}getAllComponentsOfType(e){return this.getComponentIds().map((e=>this.components[e])).filter((t=>t.type===e))}getComponent(e){return this.components[e]}getComponentIds(){return Object.keys(this.components)}getComponentOfType(e){return this.getAllComponentsOfType(e)[0]||null}getMainComponent(){return this.getComponent(this.layout.selectComponentId)}async loadModel(){const e=!this._getModelLoadingConstraints();let t=this._getGenericFilenameAndPath();return e?k.Warn("Falling back to generic models"):t=this._getFilenameAndPath(),new Promise(((i,s)=>{const r=t=>{e?this._getGenericParentMesh(t):this._setRootMesh(t),this._processLoadedModel(t),this._modelReady=!0,this.onModelLoadedObservable.notifyObservers(this),i(!0)};if(this._controllerCache){const e=this._controllerCache.filter((e=>e.filename===t.filename&&e.path===t.path));if(e[0])return e[0].meshes.forEach((e=>e.setEnabled(!0))),void r(e[0].meshes)}Hr.ImportMesh("",t.path,t.filename,this.scene,(e=>{this._controllerCache&&this._controllerCache.push(Object.assign(Object.assign({},t),{meshes:e})),r(e)}),null,((e,i)=>{k.Log(i),k.Warn(`Failed to retrieve controller model of type ${this.profileId} from the remote server: ${t.path}${t.filename}`),s(i)}))}))}updateFromXRFrame(e){this.getComponentIds().forEach((e=>this.getComponent(e).update(this.gamepadObject))),this.updateModel(e)}get handness(){return this.handedness}pulse(e,t,i=0){return this.gamepadObject.hapticActuators&&this.gamepadObject.hapticActuators[i]?this.gamepadObject.hapticActuators[i].pulse(e,t):Promise.resolve(!1)}_getChildByName(e,t){return e.getChildren((e=>e.name===t),!1)[0]}_getImmediateChildByName(e,t){return e.getChildren((e=>e.name==t),!0)[0]}_lerpTransform(e,t,i){if(!e.minMesh||!e.maxMesh||!e.valueMesh)return;if(!e.minMesh.rotationQuaternion||!e.maxMesh.rotationQuaternion||!e.valueMesh.rotationQuaternion)return;const s=i?.5*t+.5:t;C.SlerpToRef(e.minMesh.rotationQuaternion,e.maxMesh.rotationQuaternion,s,e.valueMesh.rotationQuaternion),S.LerpToRef(e.minMesh.position,e.maxMesh.position,s,e.valueMesh.position)}updateModel(e){this._modelReady&&this._updateModel(e)}_getGenericFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getGenericParentMesh(e){this.rootMesh=new ur(this.profileId+" "+this.handedness,this.scene),e.forEach((e=>{e.parent||(e.isPickable=!1,e.setParent(this.rootMesh))})),this.rootMesh.rotationQuaternion=C.FromEulerAngles(0,Math.PI,0)}}class ip extends tp{constructor(e,t,i){super(e,sp[i],t,i),this.profileId=ip.ProfileId}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){}_setRootMesh(e){this.rootMesh=new ur(this.profileId+" "+this.handedness,this.scene),e.forEach((e=>{e.isPickable=!1,e.parent||e.setParent(this.rootMesh)})),this.rootMesh.rotationQuaternion=C.FromEulerAngles(0,Math.PI,0)}_updateModel(){}}ip.ProfileId="generic-trigger";const sp={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-none",assetPath:"none.glb"}};class rp extends tp{constructor(e,t,i,s,r){super(e,i.layouts[t.handedness||"none"],t.gamepad,t.handedness,void 0,r),this._repositoryUrl=s,this.controllerCache=r,this._buttonMeshMapping={},this._touchDots={},this.profileId=i.profileId}dispose(){super.dispose(),this.controllerCache||Object.keys(this._touchDots).forEach((e=>{this._touchDots[e].dispose()}))}_getFilenameAndPath(){return{filename:this.layout.assetPath,path:`${this._repositoryUrl}/profiles/${this.profileId}/`}}_getModelLoadingConstraints(){const e=Hr.IsPluginForExtensionAvailable(".glb");return e||k.Warn("glTF / glb loader was not registered, using generic controller instead"),e}_processLoadedModel(e){this.getComponentIds().forEach((e=>{const t=this.layout.components[e];this._buttonMeshMapping[e]={mainMesh:this._getChildByName(this.rootMesh,t.rootNodeName),states:{}},Object.keys(t.visualResponses).forEach((i=>{const s=t.visualResponses[i];if("transform"===s.valueNodeProperty)this._buttonMeshMapping[e].states[i]={valueMesh:this._getChildByName(this.rootMesh,s.valueNodeName),minMesh:this._getChildByName(this.rootMesh,s.minNodeName),maxMesh:this._getChildByName(this.rootMesh,s.maxNodeName)};else{const r=t.type===ep.TOUCHPAD_TYPE&&t.touchPointNodeName?t.touchPointNodeName:s.valueNodeName;if(this._buttonMeshMapping[e].states[i]={valueMesh:this._getChildByName(this.rootMesh,r)},t.type===ep.TOUCHPAD_TYPE&&!this._touchDots[i]){const t=Ol(i+"dot",{diameter:.0015,segments:8},this.scene);t.material=new Va(i+"mat",this.scene),t.material.diffuseColor=N.Red(),t.parent=this._buttonMeshMapping[e].states[i].valueMesh||null,t.isVisible=!1,this._touchDots[i]=t}}}))}))}_setRootMesh(e){let t;this.rootMesh=new ur(this.profileId+"-"+this.handedness,this.scene),this.rootMesh.isPickable=!1;for(let i=0;i<e.length;i++){const s=e[i];s.isPickable=!1,s.parent||(t=s)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||this.rootMesh.rotate(ji.Y,Math.PI,Gi.WORLD)}_updateModel(e){this.disableAnimation||this.getComponentIds().forEach((e=>{const t=this.getComponent(e);if(!t.hasChanges)return;const i=this._buttonMeshMapping[e],s=this.layout.components[e];Object.keys(s.visualResponses).forEach((e=>{const r=s.visualResponses[e];let n=t.value;if("xAxis"===r.componentProperty?n=t.axes.x:"yAxis"===r.componentProperty&&(n=t.axes.y),"transform"===r.valueNodeProperty)this._lerpTransform(i.states[e],n,"button"!==r.componentProperty);else{const s=i.states[e].valueMesh;s&&(s.isVisible=t.touched||t.pressed),this._touchDots[e]&&(this._touchDots[e].isVisible=t.touched||t.pressed)}}))}))}}const np=[];class op{static ClearProfilesCache(){this._ProfilesList=null,this._ProfileLoadingPromises={}}static DefaultFallbacks(){this.RegisterFallbacksForProfileId("google-daydream",["generic-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive-focus",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("magicleap-one",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("windows-mixed-reality",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("microsoft-mixed-reality",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-go",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("oculus-touch-v2",["oculus-touch","generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-touch",["generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-gearvr",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-odyssey",["generic-touchpad"]),this.RegisterFallbacksForProfileId("valve-index",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("generic-hand-select",["generic-trigger"])}static FindFallbackWithProfileId(e){const t=this._Fallbacks[e]||[];return t.unshift(e),t}static GetMotionControllerWithXRInput(e,t,i){const s=[];i&&s.push(i),s.push(...e.profiles||[]),s.length&&!s[0]&&s.pop(),e.gamepad&&e.gamepad.id&&e.gamepad.id===(e.gamepad.id.match(/oculus touch/gi)?e.gamepad.id:void 0)&&s.push("oculus-touch-v2");const r=s.indexOf("windows-mixed-reality");if(-1!==r&&s.splice(r,0,"microsoft-mixed-reality"),s.length||s.push("generic-trigger"),this.UseOnlineRepository){const i=this.PrioritizeOnlineRepository?this._LoadProfileFromRepository:this._LoadProfilesFromAvailableControllers,r=this.PrioritizeOnlineRepository?this._LoadProfilesFromAvailableControllers:this._LoadProfileFromRepository;return i.call(this,s,e,t).catch((()=>r.call(this,s,e,t)))}return this._LoadProfilesFromAvailableControllers(s,e,t)}static RegisterController(e,t){this._AvailableControllers[e]=t}static RegisterFallbacksForProfileId(e,t){this._Fallbacks[e]?this._Fallbacks[e].push(...t):this._Fallbacks[e]=t}static UpdateProfilesList(){return this._ProfilesList=Ht.LoadFileAsync(this.BaseRepositoryUrl+"/profiles/profilesList.json",!1).then((e=>JSON.parse(e.toString()))),this._ProfilesList}static ClearControllerCache(){np.forEach((e=>{e.meshes.forEach((e=>{e.dispose(!1,!0)}))})),np.length=0}static _LoadProfileFromRepository(e,t,i){return Promise.resolve().then((()=>this._ProfilesList?this._ProfilesList:this.UpdateProfilesList())).then((t=>{for(let i=0;i<e.length;++i)if(e[i]&&t[e[i]])return e[i];throw new Error(`neither controller ${e[0]} nor all fallbacks were found in the repository,`)})).then((e=>(this._ProfileLoadingPromises[e]||(this._ProfileLoadingPromises[e]=Ht.LoadFileAsync(`${this.BaseRepositoryUrl}/profiles/${e}/profile.json`,!1).then((e=>JSON.parse(e)))),this._ProfileLoadingPromises[e]))).then((e=>new rp(i,t,e,this.BaseRepositoryUrl,this.DisableControllerCache?void 0:np)))}static _LoadProfilesFromAvailableControllers(e,t,i){for(let s=0;s<e.length;++s){if(!e[s])continue;const r=this.FindFallbackWithProfileId(e[s]);for(let e=0;e<r.length;++e){const s=this._AvailableControllers[r[e]];if(s)return Promise.resolve(s(t,i))}}throw new Error("no controller requested was found in the available controllers list")}}op._AvailableControllers={},op._Fallbacks={},op._ProfileLoadingPromises={},op.BaseRepositoryUrl="https://immersive-web.github.io/webxr-input-profiles/packages/viewer/dist",op.PrioritizeOnlineRepository=!0,op.UseOnlineRepository=!0,op.DisableControllerCache=!0,op.RegisterController(ip.ProfileId,((e,t)=>new ip(t,e.gamepad,e.handedness))),op.DefaultFallbacks();let ap=0;class lp{constructor(e,t,i={}){this._scene=e,this.inputSource=t,this._options=i,this._tmpVector=new S,this._disposed=!1,this.onDisposeObservable=new a,this.onMeshLoadedObservable=new a,this.onMotionControllerInitObservable=new a,this._uniqueId=`controller-${ap++}-${t.targetRayMode}-${t.handedness}`,this.pointer=new Vs(`${this._uniqueId}-pointer`,e),this.pointer.rotationQuaternion=new C,this.inputSource.gripSpace&&(this.grip=new Vs(`${this._uniqueId}-grip`,this._scene),this.grip.rotationQuaternion=new C),this._tmpVector.set(0,0,this._scene.useRightHandedSystem?-1:1),this.inputSource.gamepad&&"tracked-pointer"===this.inputSource.targetRayMode&&op.GetMotionControllerWithXRInput(t,e,this._options.forceControllerProfile).then((e=>{this.motionController=e,this.onMotionControllerInitObservable.notifyObservers(e),this._options.doNotLoadControllerMesh||this.motionController._doNotLoadControllerMesh||this.motionController.loadModel().then((e=>{var t;e&&this.motionController&&this.motionController.rootMesh&&(this._options.renderingGroupId&&(this.motionController.rootMesh.renderingGroupId=this._options.renderingGroupId,this.motionController.rootMesh.getChildMeshes(!1).forEach((e=>e.renderingGroupId=this._options.renderingGroupId))),this.onMeshLoadedObservable.notifyObservers(this.motionController.rootMesh),this.motionController.rootMesh.parent=this.grip||this.pointer,this.motionController.disableAnimation=!!this._options.disableMotionControllerAnimation),this._disposed&&(null===(t=this.motionController)||void 0===t||t.dispose())}))}),(()=>{Ht.Warn("Could not find a matching motion controller for the registered input source")}))}get uniqueId(){return this._uniqueId}dispose(){this.grip&&this.grip.dispose(!0),this.motionController&&this.motionController.dispose(),this.pointer.dispose(!0),this.onMotionControllerInitObservable.clear(),this.onMeshLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._disposed=!0}getWorldPointerRayToRef(e,t=!1){const i=t&&this.grip?this.grip:this.pointer;S.TransformNormalToRef(this._tmpVector,i.getWorldMatrix(),e.direction),e.direction.normalize(),e.origin.copyFrom(i.absolutePosition),e.length=1e3}updateFromXRFrame(e,t,i){const s=e.getPose(this.inputSource.targetRaySpace,t);if(this._lastXRPose=s,s){const e=s.transform.position;this.pointer.position.set(e.x,e.y,e.z);const t=s.transform.orientation;this.pointer.rotationQuaternion.set(t.x,t.y,t.z,t.w),this._scene.useRightHandedSystem||(this.pointer.position.z*=-1,this.pointer.rotationQuaternion.z*=-1,this.pointer.rotationQuaternion.w*=-1),this.pointer.parent=i.parent}if(this.inputSource.gripSpace&&this.grip){const s=e.getPose(this.inputSource.gripSpace,t);if(s){const e=s.transform.position,t=s.transform.orientation;this.grip.position.set(e.x,e.y,e.z),this.grip.rotationQuaternion.set(t.x,t.y,t.z,t.w),this._scene.useRightHandedSystem||(this.grip.position.z*=-1,this.grip.rotationQuaternion.z*=-1,this.grip.rotationQuaternion.w*=-1)}this.grip.parent=i.parent}this.motionController&&this.motionController.updateFromXRFrame(e)}}class hp{constructor(e,t,i={}){if(this.xrSessionManager=e,this.xrCamera=t,this._options=i,this.controllers=[],this.onControllerAddedObservable=new a,this.onControllerRemovedObservable=new a,this._onInputSourcesChange=e=>{this._addAndRemoveControllers(e.added,e.removed)},this._sessionEndedObserver=this.xrSessionManager.onXRSessionEnded.add((()=>{this._addAndRemoveControllers([],this.controllers.map((e=>e.inputSource)))})),this._sessionInitObserver=this.xrSessionManager.onXRSessionInit.add((e=>{e.addEventListener("inputsourceschange",this._onInputSourcesChange)})),this._frameObserver=this.xrSessionManager.onXRFrameObservable.add((e=>{this.controllers.forEach((t=>{t.updateFromXRFrame(e,this.xrSessionManager.referenceSpace,this.xrCamera)}))})),this._options.customControllersRepositoryURL&&(op.BaseRepositoryUrl=this._options.customControllersRepositoryURL),op.UseOnlineRepository=!this._options.disableOnlineControllerRepository,op.UseOnlineRepository)try{op.UpdateProfilesList().catch((()=>{op.UseOnlineRepository=!1}))}catch(e){op.UseOnlineRepository=!1}}_addAndRemoveControllers(e,t){const i=this.controllers.map((e=>e.inputSource));for(const t of e)if(-1===i.indexOf(t)){const e=new lp(this.xrSessionManager.scene,t,Object.assign(Object.assign({},this._options.controllerOptions||{}),{forceControllerProfile:this._options.forceInputProfile,doNotLoadControllerMesh:this._options.doNotLoadControllerMeshes,disableMotionControllerAnimation:this._options.disableControllerAnimation}));this.controllers.push(e),this.onControllerAddedObservable.notifyObservers(e)}const s=[],r=[];this.controllers.forEach((e=>{-1===t.indexOf(e.inputSource)?s.push(e):r.push(e)})),this.controllers=s,r.forEach((e=>{this.onControllerRemovedObservable.notifyObservers(e),e.dispose()}))}dispose(){this.controllers.forEach((e=>{e.dispose()})),this.xrSessionManager.onXRFrameObservable.remove(this._frameObserver),this.xrSessionManager.onXRSessionInit.remove(this._sessionInitObserver),this.xrSessionManager.onXRSessionEnded.remove(this._sessionEndedObserver),this.onControllerAddedObservable.clear(),this.onControllerRemovedObservable.clear(),op.ClearControllerCache()}}class cp extends Gr{constructor(e,t){super(e),this._options=t,this._attachController=e=>{if(this._controllers[e.uniqueId])return;const{laserPointer:t,selectionMesh:i}=this._generateNewMeshPair(e.pointer);switch(this._controllers[e.uniqueId]={xrController:e,laserPointer:t,selectionMesh:i,meshUnderPointer:null,pick:null,tmpRay:new Fr(new S,new S),disabledByNearInteraction:!1,id:cp._IdCounter++},this._attachedController?!this._options.enablePointerSelectionOnAllControllers&&this._options.preferredHandedness&&e.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=e.uniqueId):this._options.enablePointerSelectionOnAllControllers||(this._attachedController=e.uniqueId),e.inputSource.targetRayMode){case"tracked-pointer":return this._attachTrackedPointerRayMode(e);case"gaze":return this._attachGazeMode(e);case"screen":return this._attachScreenRayMode(e)}},this._controllers={},this._tmpVectorForPickCompare=new S,this.disablePointerLighting=!0,this.disableSelectionMeshLighting=!0,this.displayLaserPointer=!0,this.displaySelectionMesh=!0,this.laserPointerPickedColor=new N(.9,.9,.9),this.laserPointerDefaultColor=new N(.7,.7,.7),this.selectionMeshDefaultColor=new N(.8,.8,.8),this.selectionMeshPickedColor=new N(.3,.3,1),this._identityMatrix=y.Identity(),this._screenCoordinatesRef=S.Zero(),this._viewportRef=new ds(0,0,0,0),this._scene=this._xrSessionManager.scene}attach(){if(!super.attach())return!1;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)})),this._scene.constantlyUpdateMeshUnderPointer=!0,this._options.gazeCamera){const e=this._options.gazeCamera,{laserPointer:t,selectionMesh:i}=this._generateNewMeshPair(e);this._controllers.camera={webXRCamera:e,laserPointer:t,selectionMesh:i,meshUnderPointer:null,pick:null,tmpRay:new Fr(new S,new S),disabledByNearInteraction:!1,id:cp._IdCounter++},this._attachGazeMode()}return!0}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),!0)}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}_getPointerSelectionDisabledByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].disabledByNearInteraction;return!0}_setPointerSelectionDisabledByPointerId(e,t){const i=Object.keys(this._controllers);for(let s=0;s<i.length;++s)if(this._controllers[i[s]].id===e)return void(this._controllers[i[s]].disabledByNearInteraction=t)}_onXRFrame(e){Object.keys(this._controllers).forEach((e=>{const t=this._controllers[e];if(!this._options.enablePointerSelectionOnAllControllers&&e!==this._attachedController||t.disabledByNearInteraction)return t.selectionMesh.isVisible=!1,t.laserPointer.isVisible=!1,void(t.pick=null);let i;if(t.laserPointer.isVisible=this.displayLaserPointer,t.xrController)i=t.xrController.pointer.position,t.xrController.getWorldPointerRayToRef(t.tmpRay);else{if(!t.webXRCamera)return;i=t.webXRCamera.position,t.webXRCamera.getForwardRayToRef(t.tmpRay)}if(this._options.maxPointerDistance&&(t.tmpRay.length=this._options.maxPointerDistance),!this._options.disableScenePointerVectorUpdate&&i){const e=this._xrSessionManager.scene,s=this._options.xrInput.xrCamera;s&&(s.viewport.toGlobalToRef(e.getEngine().getRenderWidth(),e.getEngine().getRenderHeight(),this._viewportRef),S.ProjectToRef(i,this._identityMatrix,e.getTransformMatrix(),this._viewportRef,this._screenCoordinatesRef),"number"!=typeof this._screenCoordinatesRef.x||"number"!=typeof this._screenCoordinatesRef.y||isNaN(this._screenCoordinatesRef.x)||isNaN(this._screenCoordinatesRef.y)||(e.pointerX=this._screenCoordinatesRef.x,e.pointerY=this._screenCoordinatesRef.y,t.screenCoordinates={x:this._screenCoordinatesRef.x,y:this._screenCoordinatesRef.y}))}let s=null;this._utilityLayerScene&&(s=this._utilityLayerScene.pickWithRay(t.tmpRay,this._utilityLayerScene.pointerMovePredicate||this.raySelectionPredicate));const r=this._scene.pickWithRay(t.tmpRay,this._scene.pointerMovePredicate||this.raySelectionPredicate);s&&s.hit?r&&r.hit?s.distance<r.distance?t.pick=s:t.pick=r:t.pick=s:t.pick=r,t.pick&&t.xrController&&(t.pick.aimTransform=t.xrController.pointer,t.pick.gripTransform=t.xrController.grip||null);const n=t.pick;if(n&&n.pickedPoint&&n.hit){this._updatePointerDistance(t.laserPointer,n.distance),t.selectionMesh.position.copyFrom(n.pickedPoint),t.selectionMesh.scaling.x=Math.sqrt(n.distance),t.selectionMesh.scaling.y=Math.sqrt(n.distance),t.selectionMesh.scaling.z=Math.sqrt(n.distance);const e=this._convertNormalToDirectionOfRay(n.getNormal(!0),t.tmpRay),i=.001;if(t.selectionMesh.position.copyFrom(n.pickedPoint),e){const s=S.Cross(ji.Y,e),r=S.Cross(e,s);S.RotationFromAxisToRef(r,e,s,t.selectionMesh.rotation),t.selectionMesh.position.addInPlace(e.scale(i))}t.selectionMesh.isVisible=this.displaySelectionMesh,t.meshUnderPointer=n.pickedMesh}else t.selectionMesh.isVisible=!1,this._updatePointerDistance(t.laserPointer,1),t.meshUnderPointer=null}))}get _utilityLayerScene(){return this._options.customUtilityLayerScene||yl.DefaultUtilityLayer.utilityLayerScene}_attachGazeMode(e){const t=this._controllers[e&&e.uniqueId||"camera"],i=this._options.timeToSelect||3e3,s=this._options.useUtilityLayer?this._utilityLayerScene:this._scene;let r=new ci;const n=nl("selection",{diameter:.0525,thickness:.015,tessellation:20},s);n.isVisible=!1,n.isPickable=!1,n.parent=t.selectionMesh;let o=0,a=!1;const l={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add((()=>{if(t.pick){if(this._augmentPointerInit(l,t.id,t.screenCoordinates),t.laserPointer.material.alpha=0,n.isVisible=!1,t.pick.hit)if(this._pickingMoved(r,t.pick))a&&(this._options.disablePointerUpOnTouchOut||this._scene.simulatePointerUp(t.pick,l)),a=!1,o=0;else if(o>i/10&&(n.isVisible=!0),o+=this._scene.getEngine().getDeltaTime(),o>=i)this._scene.simulatePointerDown(t.pick,l),a=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,l),n.isVisible=!1;else{const e=1-o/i;n.scaling.set(e,e,e)}else a=!1,o=0;this._scene.simulatePointerMove(t.pick,l),r=t.pick}})),void 0!==this._options.renderingGroupId&&(n.renderingGroupId=this._options.renderingGroupId),e&&e.onDisposeObservable.addOnce((()=>{t.pick&&!this._options.disablePointerUpOnTouchOut&&a&&(this._scene.simulatePointerUp(t.pick,l),t.finalPointerUpTriggered=!0),n.dispose()}))}_attachScreenRayMode(e){const t=this._controllers[e.uniqueId];let i=!1;const s={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add((()=>{this._augmentPointerInit(s,t.id,t.screenCoordinates),!t.pick||this._options.disablePointerUpOnTouchOut&&i||(i?this._scene.simulatePointerMove(t.pick,s):(this._scene.simulatePointerDown(t.pick,s),t.pointerDownTriggered=!0,i=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,s)))})),e.onDisposeObservable.addOnce((()=>{this._augmentPointerInit(s,t.id,t.screenCoordinates),this._xrSessionManager.runInXRFrame((()=>{t.pick&&!t.finalPointerUpTriggered&&i&&!this._options.disablePointerUpOnTouchOut&&(this._scene.simulatePointerUp(t.pick,s),t.finalPointerUpTriggered=!0)}))}))}_attachTrackedPointerRayMode(e){const t=this._controllers[e.uniqueId];if(this._options.forceGazeMode)return this._attachGazeMode(e);const i={pointerId:t.id,pointerType:"xr"};if(t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add((()=>{t.laserPointer.material.disableLighting=this.disablePointerLighting,t.selectionMesh.material.disableLighting=this.disableSelectionMeshLighting,t.pick&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerMove(t.pick,i))})),e.inputSource.gamepad){const s=s=>{this._options.overrideButtonId&&(t.selectionComponent=s.getComponent(this._options.overrideButtonId)),t.selectionComponent||(t.selectionComponent=s.getMainComponent()),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add((s=>{if(s.changes.pressed){const r=s.changes.pressed.current;t.pick?(this._options.enablePointerSelectionOnAllControllers||e.uniqueId===this._attachedController)&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),r?(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor):(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)):!r||this._options.enablePointerSelectionOnAllControllers||this._options.disableSwitchOnClick||(this._attachedController=e.uniqueId)}}))};e.motionController?s(e.motionController):e.onMotionControllerInitObservable.add(s)}else{const e=e=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor)},s=e=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)};t.eventListeners={selectend:s,selectstart:e},this._xrSessionManager.session.addEventListener("selectstart",e),this._xrSessionManager.session.addEventListener("selectend",s)}}_convertNormalToDirectionOfRay(e,t){return e&&Math.acos(S.Dot(e,t.direction))<Math.PI/2&&e.scaleInPlace(-1),e}_detachController(e){const t=this._controllers[e];if(t){if(t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach((e=>{const i=t.eventListeners&&t.eventListeners[e];i&&this._xrSessionManager.session.removeEventListener(e,i)})),!t.finalPointerUpTriggered&&t.pointerDownTriggered){const e={pointerId:t.id,pointerType:"xr"};this._xrSessionManager.runInXRFrame((()=>{this._augmentPointerInit(e,t.id,t.screenCoordinates),this._scene.simulatePointerUp(t.pick||new ci,e),t.finalPointerUpTriggered=!0}))}this._xrSessionManager.scene.onBeforeRenderObservable.addOnce((()=>{try{if(t.selectionMesh.dispose(),t.laserPointer.dispose(),delete this._controllers[e],this._attachedController===e){const e=Object.keys(this._controllers);e.length?this._attachedController=e[0]:this._attachedController=""}}catch(e){Ht.Warn("controller already detached.")}}))}}_generateNewMeshPair(e){const t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||yl.DefaultUtilityLayer.utilityLayerScene:this._scene,i=this._options.customLasterPointerMeshGenerator?this._options.customLasterPointerMeshGenerator():bl("laserPointer",{height:1,diameterTop:2e-4,diameterBottom:.004,tessellation:20,subdivisions:1},t);i.parent=e;const s=new Va("laserPointerMat",t);s.emissiveColor=this.laserPointerDefaultColor,s.alpha=.7,i.material=s,i.rotation.x=Math.PI/2,this._updatePointerDistance(i,1),i.isPickable=!1,i.isVisible=!1;const r=this._options.customSelectionMeshGenerator?this._options.customSelectionMeshGenerator():nl("gazeTracker",{diameter:.0105,thickness:.0075,tessellation:20},t);r.bakeCurrentTransformIntoVertices(),r.isPickable=!1,r.isVisible=!1;const n=new Va("targetMat",t);return n.specularColor=N.Black(),n.emissiveColor=this.selectionMeshDefaultColor,n.backFaceCulling=!1,r.material=n,void 0!==this._options.renderingGroupId&&(i.renderingGroupId=this._options.renderingGroupId,r.renderingGroupId=this._options.renderingGroupId),{laserPointer:i,selectionMesh:r}}_pickingMoved(e,t){var i;if(!e.hit||!t.hit)return!0;if(!(e.pickedMesh&&e.pickedPoint&&t.pickedMesh&&t.pickedPoint))return!0;if(e.pickedMesh!==t.pickedMesh)return!0;null===(i=e.pickedPoint)||void 0===i||i.subtractToRef(t.pickedPoint,this._tmpVectorForPickCompare),this._tmpVectorForPickCompare.set(Math.abs(this._tmpVectorForPickCompare.x),Math.abs(this._tmpVectorForPickCompare.y),Math.abs(this._tmpVectorForPickCompare.z));const s=.01*(this._options.gazeModePointerMovedFactor||1)*t.distance;return this._tmpVectorForPickCompare.length()>s}_updatePointerDistance(e,t=100){e.scaling.y=t,this._scene.useRightHandedSystem&&(t*=-1),e.position.z=t/2+.05}_augmentPointerInit(e,t,i){e.pointerId=t,e.pointerType="xr",i&&(e.screenX=i.x,e.screenY=i.y)}get lasterPointerDefaultColor(){return this.laserPointerDefaultColor}}var up,dp,pp;cp._IdCounter=200,cp.Name=Vr.POINTER_SELECTION,cp.Version=1,kr.AddWebXRFeature(cp.Name,((e,t)=>()=>new cp(e,t)),cp.Version,!0),Cs.prototype._projectOnTrianglesToRef=function(e,t,i,s,r,n){const o=R.Vector3[0],a=R.Vector3[1];let l=1/0;for(let n=this.indexStart;n<this.indexStart+this.indexCount-(3-s);n+=s){const s=i[n],h=i[n+1],c=i[n+2];if(r&&4294967295===c){n+=2;continue}const u=t[s],d=t[h],p=t[c];if(!u||!d||!p)continue;const _=S.ProjectOnTriangleToRef(e,u,d,p,a);_<l&&(o.copyFrom(a),l=_)}return n.copyFrom(o),l},Cs.prototype._projectOnUnIndexedTrianglesToRef=function(e,t,i,s){const r=R.Vector3[0],n=R.Vector3[1];let o=1/0;for(let i=this.verticesStart;i<this.verticesStart+this.verticesCount;i+=3){const s=t[i],a=t[i+1],l=t[i+2],h=S.ProjectOnTriangleToRef(e,s,a,l,n);h<o&&(r.copyFrom(n),o=h)}return s.copyFrom(r),o},Cs.prototype.projectToRef=function(e,t,i,s){const r=this.getMaterial();if(!r)return-1;let n=3,o=!1;switch(r.fillMode){case 3:case 5:case 6:case 8:return-1;case 7:n=1,o=!0}return 4===r.fillMode?-1:!i.length&&this._mesh._unIndexed?this._projectOnUnIndexedTrianglesToRef(e,t,i,s):this._projectOnTrianglesToRef(e,t,i,n,o,s)},function(e){e[e.DEHYDRATED=0]="DEHYDRATED",e[e.HOVER=1]="HOVER",e[e.TOUCH=2]="TOUCH"}(up||(up={})),function(e){e[e.DISABLED=0]="DISABLED",e[e.CENTERED_ON_CONTROLLER=1]="CENTERED_ON_CONTROLLER",e[e.CENTERED_IN_FRONT=2]="CENTERED_IN_FRONT"}(dp||(dp={}));class _p extends Gr{constructor(e,t){super(e),this._options=t,this._tmpRay=new Fr(new S,new S),this._attachController=e=>{if(this._controllers[e.uniqueId])return;const{touchCollisionMesh:t,touchCollisionMeshFunction:i,hydrateCollisionMeshFunction:s}=this._generateNewTouchPointMesh(),r=this._generateVisualCue();switch(this._controllers[e.uniqueId]={xrController:e,meshUnderPointer:null,nearInteractionTargetMesh:null,pick:null,stalePick:null,touchCollisionMesh:t,touchCollisionMeshFunction:i,hydrateCollisionMeshFunction:s,currentAnimationState:up.DEHYDRATED,grabRay:new Fr(new S,new S),hoverInteraction:!1,nearInteraction:!1,grabInteraction:!1,id:_p._IdCounter++,pickedPointVisualCue:r},this._attachedController?!this._options.enableNearInteractionOnAllControllers&&this._options.preferredHandedness&&e.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=e.uniqueId):this._options.enableNearInteractionOnAllControllers||(this._attachedController=e.uniqueId),e.inputSource.targetRayMode){case"tracked-pointer":return this._attachNearInteractionMode(e);case"gaze":case"screen":return null}},this._controllers={},this._farInteractionFeature=null,this.selectionMeshDefaultColor=new N(.8,.8,.8),this.selectionMeshPickedColor=new N(.3,.3,1),this._hoverRadius=.1,this._pickRadius=.02,this._controllerPickRadius=.03,this._nearGrabLengthScale=5,this._scene=this._xrSessionManager.scene,void 0===this._options.nearInteractionControllerMode&&(this._options.nearInteractionControllerMode=dp.CENTERED_IN_FRONT),this._options.farInteractionFeature&&(this._farInteractionFeature=this._options.farInteractionFeature)}attach(){return!!super.attach()&&(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)})),this._scene.constantlyUpdateMeshUnderPointer=!0,!0)}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),!0)}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}setFarInteractionFeature(e){this._farInteractionFeature=e}_nearPickPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearPickable}_nearGrabPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearGrabbable}_nearInteractionPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&(e.isNearPickable||e.isNearGrabbable)}_controllerAvailablePredicate(e,t){let i=e;for(;i;){if(i.reservedDataStore&&i.reservedDataStore.nearInteraction&&i.reservedDataStore.nearInteraction.excludedControllerId===t)return!1;i=i.parent}return!0}_handleTransitionAnimation(e,t){var i;if(e.currentAnimationState!==t&&this._options.nearInteractionControllerMode===dp.CENTERED_IN_FRONT&&!(null===(i=e.xrController)||void 0===i?void 0:i.inputSource.hand)){if(t>e.currentAnimationState)switch(e.currentAnimationState){case up.DEHYDRATED:if(e.hydrateCollisionMeshFunction(!0),t===up.HOVER)break;case up.HOVER:if(e.touchCollisionMeshFunction(!0),t===up.TOUCH)break}else switch(e.currentAnimationState){case up.TOUCH:if(e.touchCollisionMeshFunction(!1),t===up.HOVER)break;case up.HOVER:if(e.hydrateCollisionMeshFunction(!1),t===up.DEHYDRATED)break}e.currentAnimationState=t}}_processTouchPoint(e,t,i){var s;const r=this._controllers[e];r.grabRay.origin.copyFrom(t),i.toEulerAnglesToRef(R.Vector3[0]),r.grabRay.direction.copyFrom(R.Vector3[0]),this._options.nearInteractionControllerMode!==dp.CENTERED_IN_FRONT||(null===(s=r.xrController)||void 0===s?void 0:s.inputSource.hand)||(r.xrController.getWorldPointerRayToRef(this._tmpRay),r.grabRay.origin.addInPlace(this._tmpRay.direction.scale(.05))),r.grabRay.length=this._nearGrabLengthScale*this._hoverRadius,r.touchCollisionMesh.position.copyFrom(r.grabRay.origin)}_onXRFrame(e){Object.keys(this._controllers).forEach((t=>{var i;const s=this._controllers[t],r=null===(i=s.xrController)||void 0===i?void 0:i.inputSource.hand;if(!this._options.enableNearInteractionOnAllControllers&&t!==this._attachedController||!s.xrController||!r&&(!this._options.nearInteractionControllerMode||!s.xrController.inputSource.gamepad))return void(s.pick=null);if(s.hoverInteraction=!1,s.nearInteraction=!1,!s.xrController)return;if(r){const i=r.get("index-finger-tip");if(i){const s=e.getJointPose(i,this._xrSessionManager.referenceSpace);if(s&&s.transform){const e=this._scene.useRightHandedSystem?1:-1;R.Vector3[0].set(s.transform.position.x,s.transform.position.y,s.transform.position.z*e),R.Quaternion[0].set(s.transform.orientation.x,s.transform.orientation.y,s.transform.orientation.z*e,s.transform.orientation.w*e),this._processTouchPoint(t,R.Vector3[0],R.Quaternion[0])}}}else if(s.xrController.inputSource.gamepad&&this._options.nearInteractionControllerMode!==dp.DISABLED){let e=s.xrController.pointer;s.xrController.grip&&this._options.nearInteractionControllerMode===dp.CENTERED_ON_CONTROLLER&&(e=s.xrController.grip),this._processTouchPoint(t,e.position,e.rotationQuaternion)}const n=(e,t)=>{let i=null;return i=t&&t.hit?e&&e.hit?t.distance<e.distance?t:e:t:e,i},o=e=>{let t=new ci,i=!1;const s=e&&e.pickedPoint&&e.hit;return(null==e?void 0:e.pickedPoint)&&(i=0===e.pickedPoint.x&&0===e.pickedPoint.y&&0===e.pickedPoint.z),s&&!i&&(t=e),t};if(!s.grabInteraction){let e=null,t=null;this._options.useUtilityLayer&&this._utilityLayerScene&&(t=this._pickWithSphere(s,this._hoverRadius,this._utilityLayerScene,(e=>this._nearInteractionPredicate(e))));const i=n(this._pickWithSphere(s,this._hoverRadius,this._scene,(e=>this._nearInteractionPredicate(e))),t);if(i&&i.hit&&(e=o(i),e.hit&&(s.hoverInteraction=!0)),s.hoverInteraction){let t=null;const i=r?this._pickRadius:this._controllerPickRadius;this._options.useUtilityLayer&&this._utilityLayerScene&&(t=this._pickWithSphere(s,i,this._utilityLayerScene,(e=>this._nearPickPredicate(e))));const a=o(n(this._pickWithSphere(s,i,this._scene,(e=>this._nearPickPredicate(e))),t));a.hit&&(e=a,s.nearInteraction=!0)}s.stalePick=s.pick,s.pick=e,s.pick&&s.pick.pickedPoint&&s.pick.hit?(s.meshUnderPointer=s.pick.pickedMesh,s.pickedPointVisualCue.position.copyFrom(s.pick.pickedPoint),s.pickedPointVisualCue.isVisible=!0,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(s.id,!0)):(s.meshUnderPointer=null,s.pickedPointVisualCue.isVisible=!1,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(s.id,!1))}let a=up.DEHYDRATED;s.grabInteraction||s.nearInteraction?a=up.TOUCH:s.hoverInteraction&&(a=up.HOVER),this._handleTransitionAnimation(s,a)}))}get _utilityLayerScene(){return this._options.customUtilityLayerScene||yl.DefaultUtilityLayer.utilityLayerScene}_generateVisualCue(){const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||yl.DefaultUtilityLayer.utilityLayerScene:this._scene,t=Ol("nearInteraction",{diameter:.0105},e);t.bakeCurrentTransformIntoVertices(),t.isPickable=!1,t.isVisible=!1,t.rotationQuaternion=C.Identity();const i=new Va("targetMat",e);return i.specularColor=N.Black(),i.emissiveColor=this.selectionMeshDefaultColor,i.backFaceCulling=!1,t.material=i,t}_isControllerReadyForNearInteraction(e){return!this._farInteractionFeature||this._farInteractionFeature._getPointerSelectionDisabledByPointerId(e)}_attachNearInteractionMode(e){const t=this._controllers[e.uniqueId],i={pointerId:t.id,pointerType:"xr-near"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add((()=>{(this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController)&&t.xrController&&(t.xrController.inputSource.hand||this._options.nearInteractionControllerMode&&t.xrController.inputSource.gamepad)&&(t.pick&&(t.pick.ray=t.grabRay),t.pick&&this._isControllerReadyForNearInteraction(t.id)&&this._scene.simulatePointerMove(t.pick,i),t.nearInteraction&&t.pick&&t.pick.hit?t.nearInteractionTargetMesh||(this._scene.simulatePointerDown(t.pick,i),t.nearInteractionTargetMesh=t.meshUnderPointer):t.nearInteractionTargetMesh&&t.stalePick&&(this._scene.simulatePointerUp(t.stalePick,i),t.nearInteractionTargetMesh=null))}));const s=s=>{this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController&&this._isControllerReadyForNearInteraction(t.id)?(t.pick&&(t.pick.ray=t.grabRay),s&&t.pick&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)?(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i)):!s&&t.pick&&t.grabInteraction&&(this._scene.simulatePointerUp(t.pick,i),t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!0)):!s||this._options.enableNearInteractionOnAllControllers||this._options.disableSwitchOnClick||(this._attachedController=e.uniqueId)};if(e.inputSource.gamepad){const i=e=>{t.squeezeComponent=e.getComponent("grasp"),t.squeezeComponent?t.onSqueezeButtonChangedObserver=t.squeezeComponent.onButtonStateChangedObservable.add((e=>{if(e.changes.pressed){const t=e.changes.pressed.current;s(t)}})):(t.selectionComponent=e.getMainComponent(),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add((e=>{if(e.changes.pressed){const t=e.changes.pressed.current;s(t)}})))};e.motionController?i(e.motionController):e.onMotionControllerInitObservable.add(i)}else{const e=e=>{t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)&&(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i))},s=e=>{t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&(this._scene.simulatePointerUp(t.pick,i),t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!0)};t.eventListeners={selectend:s,selectstart:e},this._xrSessionManager.session.addEventListener("selectstart",e),this._xrSessionManager.session.addEventListener("selectend",s)}}_detachController(e){const t=this._controllers[e];if(t&&(t.squeezeComponent&&t.onSqueezeButtonChangedObserver&&t.squeezeComponent.onButtonStateChangedObservable.remove(t.onSqueezeButtonChangedObserver),t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach((e=>{const i=t.eventListeners&&t.eventListeners[e];i&&this._xrSessionManager.session.removeEventListener(e,i)})),t.touchCollisionMesh.dispose(),t.pickedPointVisualCue.dispose(),this._xrSessionManager.runInXRFrame((()=>{const e={pointerId:t.id,pointerType:"xr-near"};this._scene.simulatePointerUp(new ci,e)})),delete this._controllers[e],this._attachedController===e)){const e=Object.keys(this._controllers);e.length?this._attachedController=e[0]:this._attachedController=""}}_generateNewTouchPointMesh(){const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||yl.DefaultUtilityLayer.utilityLayerScene:this._scene,t=Ol("PickSphere",{diameter:1},e);t.isVisible=!1,this._options.motionControllerOrbMaterial?t.material=this._options.motionControllerOrbMaterial:Hn.ParseFromSnippetAsync("8RUNKL#3",e).then((e=>{t.material=e}));const i=new ss;i.setEasingMode(ts.EASINGMODE_EASEINOUT);const s=new S(this._controllerPickRadius,this._controllerPickRadius,this._controllerPickRadius),r=this._controllerPickRadius*(4/3),n=new S(r,r,r),o=this._controllerPickRadius*(7/6),a=new S(o,o,o),l=.8*this._controllerPickRadius,h=new S(l,l,l),c=1.5*this._controllerPickRadius,u=[{frame:0,value:s},{frame:10,value:new S(c,c,c)},{frame:18,value:n}],d=[{frame:0,value:n},{frame:10,value:h},{frame:18,value:s}],p=[{frame:0,value:S.ZeroReadOnly},{frame:12,value:a},{frame:15,value:s}],_=[{frame:0,value:s},{frame:10,value:S.ZeroReadOnly},{frame:15,value:S.ZeroReadOnly}],f=new Ie("touch","scaling",60,Ie.ANIMATIONTYPE_VECTOR3,Ie.ANIMATIONLOOPMODE_CONSTANT),m=new Ie("release","scaling",60,Ie.ANIMATIONTYPE_VECTOR3,Ie.ANIMATIONLOOPMODE_CONSTANT),g=new Ie("hydrate","scaling",60,Ie.ANIMATIONTYPE_VECTOR3,Ie.ANIMATIONLOOPMODE_CONSTANT),v=new Ie("dehydrate","scaling",60,Ie.ANIMATIONTYPE_VECTOR3,Ie.ANIMATIONLOOPMODE_CONSTANT);return f.setEasingFunction(i),m.setEasingFunction(i),g.setEasingFunction(i),v.setEasingFunction(i),f.setKeys(u),m.setKeys(d),g.setKeys(p),v.setKeys(_),{touchCollisionMesh:t,touchCollisionMeshFunction:i=>{const s=i?f:m;e.beginDirectAnimation(t,[s],0,18,!1,1)},hydrateCollisionMeshFunction:i=>{const s=i?g:v;i&&(t.isVisible=!0),e.beginDirectAnimation(t,[s],0,15,!1,1,(()=>{i||(t.isVisible=!1)}))}}}_pickWithSphere(e,t,i,s){const r=new ci;if(r.distance=1/0,e.touchCollisionMesh&&e.xrController){const n=e.touchCollisionMesh.position,o=ms.CreateFromCenterAndRadius(n,t);for(let t=0;t<i.meshes.length;t++){const n=i.meshes[t];if(!s(n)||!this._controllerAvailablePredicate(n,e.xrController.uniqueId))continue;const a=_p.PickMeshWithSphere(n,o);a&&a.hit&&a.distance<r.distance&&(r.hit=a.hit,r.pickedMesh=n,r.pickedPoint=a.pickedPoint,r.aimTransform=e.xrController.pointer,r.gripTransform=e.xrController.grip||null,r.originMesh=e.touchCollisionMesh,r.distance=a.distance)}}return r}static PickMeshWithSphere(e,t,i=!1){const s=e.subMeshes,r=new ci,n=e.getBoundingInfo();if(!e._generatePointsArray())return r;if(!e.subMeshes||!n)return r;if(!i&&!ms.Intersects(n.boundingSphere,t))return r;const o=R.Vector3[0],a=R.Vector3[1];let l,h,c,u=1/0;const d=R.Vector3[2],p=R.Matrix[0];p.copyFrom(e.getWorldMatrix()),p.invert(),S.TransformCoordinatesToRef(t.center,p,d);for(let i=0;i<s.length;i++)s[i].projectToRef(d,e._positions,e.getIndices(),a),S.TransformCoordinatesToRef(a,e.getWorldMatrix(),a),l=S.Distance(a,t.center),c=S.Distance(a,e.getAbsolutePosition()),h=S.Distance(t.center,e.getAbsolutePosition()),-1!==h&&-1!==c&&c>h&&(l=0,a.copyFrom(t.center)),-1!==l&&l<u&&(u=l,o.copyFrom(a));return u<t.radius&&(r.hit=!0,r.distance=u,r.pickedMesh=e,r.pickedPoint=o.clone()),r}}_p._IdCounter=200,_p.Name=Vr.NEAR_INTERACTION,_p.Version=1,kr.AddWebXRFeature(_p.Name,((e,t)=>()=>new _p(e,t)),_p.Version,!0);class fp{constructor(e,t,i){this.element=e,this.sessionMode=t,this.referenceSpaceType=i}update(e){}}class mp{constructor(e,t){if(this._scene=e,this.options=t,this._activeButton=null,this._buttons=[],this.activeButtonChangedObservable=new a,this._onSessionGranted=e=>{this._helper&&this._enterXRWithButtonIndex(0)},this.overlay=document.createElement("div"),this.overlay.classList.add("xr-button-overlay"),!t.ignoreSessionGrantedEvent&&navigator.xr&&navigator.xr.addEventListener("sessiongranted",this._onSessionGranted),"undefined"!=typeof window&&window.location&&"http:"===window.location.protocol&&"localhost"!==window.location.hostname)throw Ht.Warn("WebXR can only be served over HTTPS"),new Error("WebXR can only be served over HTTPS");if(t.customButtons)this._buttons=t.customButtons;else{this.overlay.style.cssText="z-index:11;position: absolute; right: 20px;bottom: 50px;";const e=t.sessionMode||"immersive-vr",i=t.referenceSpaceType||"local-floor";let s=".babylonVRicon { color: #868686; border-color: #868686; border-style: solid; margin-left: 10px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+("undefined"==typeof SVGSVGElement?"https://cdn.babylonjs.com/Assets/vrButton.png":"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";s+='.babylonVRicon.vrdisplaypresenting { background-image: none;} .vrdisplaypresenting::after { content: "EXIT"} .xr-error::after { content: "ERROR"}';const r=document.createElement("style");r.appendChild(document.createTextNode(s)),document.getElementsByTagName("head")[0].appendChild(r);const n=document.createElement("button");n.className="babylonVRicon",n.title=`${e} - ${i}`,this._buttons.push(new fp(n,e,i)),this._buttons[this._buttons.length-1].update=function(e){this.element.style.display=null===e||e===this?"":"none",n.className="babylonVRicon"+(e===this?" vrdisplaypresenting":"")},this._updateButtons(null)}const i=e.getEngine().getInputElement();i&&i.parentNode&&(i.parentNode.appendChild(this.overlay),e.onDisposeObservable.addOnce((()=>{this.dispose()})))}async setHelperAsync(e,t){this._helper=e,this._renderTarget=t;const i=this._buttons.map((t=>e.sessionManager.isSessionSupportedAsync(t.sessionMode)));e.onStateChangedObservable.add((e=>{e==Qa.NOT_IN_XR&&this._updateButtons(null)})),(await Promise.all(i)).forEach(((e,t)=>{e?(this.overlay.appendChild(this._buttons[t].element),this._buttons[t].element.onclick=this._enterXRWithButtonIndex.bind(this,t)):Ht.Warn(`Session mode "${this._buttons[t].sessionMode}" not supported in browser`)}))}static async CreateAsync(e,t,i){const s=new mp(e,i);return await s.setHelperAsync(t,i.renderTarget||void 0),s}async _enterXRWithButtonIndex(e=0){if(this._helper.state==Qa.IN_XR)await this._helper.exitXRAsync(),this._updateButtons(null);else if(this._helper.state==Qa.NOT_IN_XR)try{await this._helper.enterXRAsync(this._buttons[e].sessionMode,this._buttons[e].referenceSpaceType,this._renderTarget,{optionalFeatures:this.options.optionalFeatures,requiredFeatures:this.options.requiredFeatures}),this._updateButtons(this._buttons[e])}catch(t){this._updateButtons(null);const i=this._buttons[e].element,s=i.title;i.title="Error entering XR session : "+s,i.classList.add("xr-error"),this.options.onError&&this.options.onError(t)}}dispose(){const e=this._scene.getEngine().getInputElement();e&&e.parentNode&&e.parentNode.contains(this.overlay)&&e.parentNode.removeChild(this.overlay),this.activeButtonChangedObservable.clear(),navigator.xr.removeEventListener("sessiongranted",this._onSessionGranted)}_updateButtons(e){this._activeButton=e,this._buttons.forEach((e=>{e.update(this._activeButton)})),this.activeButtonChangedObservable.notifyObservers(this._activeButton)}}function gp(e){var t;let i=0;const s=Date.now();e.observableParameters=null!==(t=e.observableParameters)&&void 0!==t?t:{};const r=e.contextObservable.add((t=>{const n=Date.now();i=n-s;const o={startTime:s,currentTime:n,deltaTime:i,completeRate:i/e.timeout,payload:t};e.onTick&&e.onTick(o),e.breakCondition&&e.breakCondition()&&(e.contextObservable.remove(r),e.onAborted&&e.onAborted(o)),i>=e.timeout&&(e.contextObservable.remove(r),e.onEnded&&e.onEnded(o))}),e.observableParameters.mask,e.observableParameters.insertFirst,e.observableParameters.scope);return r}!function(e){e[e.INIT=0]="INIT",e[e.STARTED=1]="STARTED",e[e.ENDED=2]="ENDED"}(pp||(pp={}));class vp{constructor(e){var t,i;this.onEachCountObservable=new a,this.onTimerAbortedObservable=new a,this.onTimerEndedObservable=new a,this.onStateChangedObservable=new a,this._observer=null,this._breakOnNextTick=!1,this._tick=e=>{const t=Date.now();this._timer=t-this._startTime;const i={startTime:this._startTime,currentTime:t,deltaTime:this._timer,completeRate:this._timer/this._timeToEnd,payload:e},s=this._breakOnNextTick||this._breakCondition(i);s||this._timer>=this._timeToEnd?this._stop(i,s):this.onEachCountObservable.notifyObservers(i)},this._setState(pp.INIT),this._contextObservable=e.contextObservable,this._observableParameters=null!==(t=e.observableParameters)&&void 0!==t?t:{},this._breakCondition=null!==(i=e.breakCondition)&&void 0!==i?i:()=>!1,this._timeToEnd=e.timeout,e.onEnded&&this.onTimerEndedObservable.add(e.onEnded),e.onTick&&this.onEachCountObservable.add(e.onTick),e.onAborted&&this.onTimerAbortedObservable.add(e.onAborted)}set breakCondition(e){this._breakCondition=e}clearObservables(){this.onEachCountObservable.clear(),this.onTimerAbortedObservable.clear(),this.onTimerEndedObservable.clear(),this.onStateChangedObservable.clear()}start(e=this._timeToEnd){if(this._state===pp.STARTED)throw new Error("Timer already started. Please stop it before starting again");this._timeToEnd=e,this._startTime=Date.now(),this._timer=0,this._observer=this._contextObservable.add(this._tick,this._observableParameters.mask,this._observableParameters.insertFirst,this._observableParameters.scope),this._setState(pp.STARTED)}stop(){this._state===pp.STARTED&&(this._breakOnNextTick=!0)}dispose(){this._observer&&this._contextObservable.remove(this._observer),this.clearObservables()}_setState(e){this._state=e,this.onStateChangedObservable.notifyObservers(this._state)}_stop(e,t=!1){this._contextObservable.remove(this._observer),this._setState(pp.ENDED),t?this.onTimerAbortedObservable.notifyObservers(e):this.onTimerEndedObservable.notifyObservers(e)}}class xp extends Gr{get rotationEnabled(){return this._rotationEnabled}set rotationEnabled(e){if(this._rotationEnabled=e,this._options.teleportationTargetMesh){const t=this._options.teleportationTargetMesh.getChildMeshes(!1,(e=>"rotationCone"===e.name));t[0]&&t[0].setEnabled(e)}}get teleportationTargetMesh(){return this._options.teleportationTargetMesh||null}constructor(e,t){super(e),this._options=t,this._controllers={},this._snappedToPoint=!1,this._cachedColor4White=new F(1,1,1,1),this._tmpRay=new Fr(new S,new S),this._tmpVector=new S,this._tmpQuaternion=new C,this.skipNextTeleportation=!1,this.backwardsMovementEnabled=!0,this.backwardsTeleportationDistance=.7,this.parabolicCheckRadius=5,this.parabolicRayEnabled=!0,this.straightRayEnabled=!0,this.rotationAngle=Math.PI/8,this.onTargetMeshPositionUpdatedObservable=new a,this.teleportationEnabled=!0,this._rotationEnabled=!0,this._attachController=e=>{if(this._controllers[e.uniqueId]||this._options.forceHandedness&&e.inputSource.handedness!==this._options.forceHandedness)return;this._controllers[e.uniqueId]={xrController:e,teleportationState:{forward:!1,backwards:!1,rotating:!1,currentRotation:0,baseRotation:0,blocked:!1}};const t=this._controllers[e.uniqueId];if("tracked-pointer"===t.xrController.inputSource.targetRayMode&&t.xrController.inputSource.gamepad){const i=()=>{if(e.motionController){const i=e.motionController.getComponentOfType(ep.THUMBSTICK_TYPE)||e.motionController.getComponentOfType(ep.TOUCHPAD_TYPE);if(!i||this._options.useMainComponentOnly){const i=e.motionController.getMainComponent();if(!i)return;t.teleportationComponent=i,t.onButtonChangedObserver=i.onButtonStateChangedObservable.add((()=>{this.teleportationEnabled&&i.changes.pressed&&(i.changes.pressed.current?(t.teleportationState.forward=!0,this._currentTeleportationControllerId=t.xrController.uniqueId,t.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,t.teleportationState.currentRotation=0,gp({timeout:this._options.timeToTeleport||3e3,contextObservable:this._xrSessionManager.onXRFrameObservable,breakCondition:()=>!i.pressed,onEnded:()=>{this._currentTeleportationControllerId===t.xrController.uniqueId&&t.teleportationState.forward&&this._teleportForward(e.uniqueId)}})):(t.teleportationState.forward=!1,this._currentTeleportationControllerId=""))}))}else t.teleportationComponent=i,t.onAxisChangedObserver=i.onAxisValueChangedObservable.add((i=>{if(i.y<=.7&&t.teleportationState.backwards&&(t.teleportationState.backwards=!1),i.y>.7&&!t.teleportationState.forward&&this.backwardsMovementEnabled&&!this.snapPointsOnly&&!t.teleportationState.backwards){t.teleportationState.backwards=!0,this._tmpQuaternion.copyFrom(this._options.xrInput.xrCamera.rotationQuaternion),this._tmpQuaternion.toEulerAnglesToRef(this._tmpVector),this._tmpVector.x=0,this._tmpVector.z=0,C.FromEulerVectorToRef(this._tmpVector,this._tmpQuaternion),this._tmpVector.set(0,0,this.backwardsTeleportationDistance*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),this._tmpVector.rotateByQuaternionToRef(this._tmpQuaternion,this._tmpVector),this._tmpVector.addInPlace(this._options.xrInput.xrCamera.position),this._tmpRay.origin.copyFrom(this._tmpVector),this._tmpRay.length=this._options.xrInput.xrCamera.realWorldHeight+.1,this._tmpRay.direction.set(0,-1,0);const e=this._xrSessionManager.scene.pickWithRay(this._tmpRay,(e=>-1!==this._floorMeshes.indexOf(e)));e&&e.pickedPoint&&(this._options.xrInput.xrCamera.position.x=e.pickedPoint.x,this._options.xrInput.xrCamera.position.z=e.pickedPoint.z)}if(i.y<-.7&&!this._currentTeleportationControllerId&&!t.teleportationState.rotating&&this.teleportationEnabled&&(t.teleportationState.forward=!0,this._currentTeleportationControllerId=t.xrController.uniqueId,t.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y),i.x){if(t.teleportationState.forward)this._currentTeleportationControllerId===t.xrController.uniqueId&&(this.rotationEnabled?setTimeout((()=>{t.teleportationState.currentRotation=Math.atan2(i.x,i.y*(this._xrSessionManager.scene.useRightHandedSystem?1:-1))})):t.teleportationState.currentRotation=0);else if(!t.teleportationState.rotating&&Math.abs(i.x)>.7){t.teleportationState.rotating=!0;const e=this.rotationAngle*(i.x>0?1:-1)*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);C.FromEulerAngles(0,e,0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion)}}else t.teleportationState.rotating=!1;0===i.x&&0===i.y&&(t.teleportationState.blocked&&(t.teleportationState.blocked=!1,this._setTargetMeshVisibility(!1)),t.teleportationState.forward&&this._teleportForward(e.uniqueId))}))}};e.motionController?i():e.onMotionControllerInitObservable.addOnce((()=>{i()}))}else this._xrSessionManager.scene.onPointerObservable.add((i=>{i.type===gi.POINTERDOWN?(t.teleportationState.forward=!0,this._currentTeleportationControllerId=t.xrController.uniqueId,t.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,t.teleportationState.currentRotation=0,gp({timeout:this._options.timeToTeleport||3e3,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===t.xrController.uniqueId&&t.teleportationState.forward&&this._teleportForward(e.uniqueId)}})):i.type===gi.POINTERUP&&(t.teleportationState.forward=!1,this._currentTeleportationControllerId="")}))},this._options.teleportationTargetMesh||this._createDefaultTargetMesh(),this._floorMeshes=this._options.floorMeshes||[],this._snapToPositions=this._options.snapPositions||[],this._blockedRayColor=this._options.blockedRayColor||new F(1,0,0,.75),this._setTargetMeshVisibility(!1)}get snapPointsOnly(){return!!this._options.snapPointsOnly}set snapPointsOnly(e){this._options.snapPointsOnly=e}addFloorMesh(e){this._floorMeshes.push(e)}addBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[],this._options.pickBlockerMeshes.push(e)}addSnapPoint(e){this._snapToPositions.push(e)}attach(){return!!super.attach()&&(this._currentTeleportationControllerId="",this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)})),!0)}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),this._setTargetMeshVisibility(!1),this._currentTeleportationControllerId="",this._controllers={},!0)}dispose(){super.dispose(),this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.dispose(!1,!0)}removeFloorMesh(e){const t=this._floorMeshes.indexOf(e);-1!==t&&this._floorMeshes.splice(t,1)}removeBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[];const t=this._options.pickBlockerMeshes.indexOf(e);-1!==t&&this._options.pickBlockerMeshes.splice(t,1)}removeFloorMeshByName(e){const t=this._xrSessionManager.scene.getMeshByName(e);t&&this.removeFloorMesh(t)}removeSnapPoint(e){let t=this._snapToPositions.indexOf(e);if(-1===t)for(let i=0;i<this._snapToPositions.length;++i)if(this._snapToPositions[i].equals(e)){t=i;break}return-1!==t&&(this._snapToPositions.splice(t,1),!0)}setSelectionFeature(e){this._selectionFeature=e}_onXRFrame(e){const t=this._xrSessionManager.currentFrame,i=this._xrSessionManager.scene;if(!this.attach||!t)return;const s=this._options.teleportationTargetMesh;if(this._currentTeleportationControllerId){if(!s)return;s.rotationQuaternion=s.rotationQuaternion||new C;const e=this._controllers[this._currentTeleportationControllerId];if(e&&e.teleportationState.forward){C.RotationYawPitchRollToRef(e.teleportationState.currentRotation+e.teleportationState.baseRotation,0,0,s.rotationQuaternion);let t=!1;if(e.xrController.getWorldPointerRayToRef(this._tmpRay),this.straightRayEnabled){const s=i.pickWithRay(this._tmpRay,(e=>{if(this._options.pickBlockerMeshes&&-1!==this._options.pickBlockerMeshes.indexOf(e))return!0;const t=this._floorMeshes.indexOf(e);return-1!==t&&this._floorMeshes[t].absolutePosition.y<this._options.xrInput.xrCamera.globalPosition.y}));if(s&&s.pickedMesh&&this._options.pickBlockerMeshes&&-1!==this._options.pickBlockerMeshes.indexOf(s.pickedMesh))return e.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1),void this._showParabolicPath(s);s&&s.pickedPoint&&(e.teleportationState.blocked=!1,t=!0,this._setTargetMeshPosition(s),this._setTargetMeshVisibility(!0),this._showParabolicPath(s))}if(this.parabolicRayEnabled&&!t){const s=e.xrController.pointer.rotationQuaternion.toEulerAngles().x,r=Math.PI/2-Math.abs(s)+1,n=this.parabolicCheckRadius*r;this._tmpRay.origin.addToRef(this._tmpRay.direction.scale(2*n),this._tmpVector),this._tmpVector.y=this._tmpRay.origin.y,this._tmpRay.origin.addInPlace(this._tmpRay.direction.scale(n)),this._tmpVector.subtractToRef(this._tmpRay.origin,this._tmpRay.direction),this._tmpRay.direction.normalize();const o=i.pickWithRay(this._tmpRay,(e=>!(!this._options.pickBlockerMeshes||-1===this._options.pickBlockerMeshes.indexOf(e))||-1!==this._floorMeshes.indexOf(e)));if(o&&o.pickedMesh&&this._options.pickBlockerMeshes&&-1!==this._options.pickBlockerMeshes.indexOf(o.pickedMesh))return e.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1),void this._showParabolicPath(o);o&&o.pickedPoint&&(e.teleportationState.blocked=!1,t=!0,this._setTargetMeshPosition(o),this._setTargetMeshVisibility(!0),this._showParabolicPath(o))}this._setTargetMeshVisibility(t)}else this._setTargetMeshVisibility(!1)}else this._disposeBezierCurve(),this._setTargetMeshVisibility(!1)}_createDefaultTargetMesh(){this._options.defaultTargetMeshOptions=this._options.defaultTargetMeshOptions||{};const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||yl.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,t=sl("teleportationTarget",{width:2,height:2,subdivisions:2},e);if(t.isPickable=!1,this._options.defaultTargetMeshOptions.teleportationCircleMaterial)t.material=this._options.defaultTargetMeshOptions.teleportationCircleMaterial;else{const i=512,s=new ka("teleportationPlaneDynamicTexture",i,e,!0);s.hasAlpha=!0;const r=s.getContext(),n=i/2,o=i/2,a=200;r.beginPath(),r.arc(n,o,a,0,2*Math.PI,!1),r.fillStyle=this._options.defaultTargetMeshOptions.teleportationFillColor||"#444444",r.fill(),r.lineWidth=10,r.strokeStyle=this._options.defaultTargetMeshOptions.teleportationBorderColor||"#FFFFFF",r.stroke(),r.closePath(),s.update();const l=new Va("teleportationPlaneMaterial",e);l.diffuseTexture=s,t.material=l}const i=nl("torusTeleportation",{diameter:.75,thickness:.1,tessellation:20},e);if(i.isPickable=!1,i.parent=t,!this._options.defaultTargetMeshOptions.disableAnimation){const t=new Ie("animationInnerCircle","position.y",30,Ie.ANIMATIONTYPE_FLOAT,Ie.ANIMATIONLOOPMODE_CYCLE),s=[];s.push({frame:0,value:0}),s.push({frame:30,value:.4}),s.push({frame:60,value:0}),t.setKeys(s);const r=new rs;r.setEasingMode(ts.EASINGMODE_EASEINOUT),t.setEasingFunction(r),i.animations=[],i.animations.push(t),e.beginAnimation(i,0,60,!0)}const s=bl("rotationCone",{diameterTop:0,tessellation:4},e);if(s.isPickable=!1,s.scaling.set(.5,.12,.2),s.rotate(ji.X,Math.PI/2),s.position.z=.6,s.parent=i,this._options.defaultTargetMeshOptions.torusArrowMaterial)i.material=this._options.defaultTargetMeshOptions.torusArrowMaterial,s.material=this._options.defaultTargetMeshOptions.torusArrowMaterial;else{const t=new Va("torusConsMat",e);t.disableLighting=!!this._options.defaultTargetMeshOptions.disableLighting,t.disableLighting?t.emissiveColor=new N(.3,.3,1):t.diffuseColor=new N(.3,.3,1),t.alpha=.9,i.material=t,s.material=t,this._teleportationRingMaterial=t}void 0!==this._options.renderingGroupId&&(t.renderingGroupId=this._options.renderingGroupId,i.renderingGroupId=this._options.renderingGroupId,s.renderingGroupId=this._options.renderingGroupId),this._options.teleportationTargetMesh=t,this._setTargetMeshVisibility(!1)}_detachController(e){const t=this._controllers[e];t&&(t.teleportationComponent&&(t.onAxisChangedObserver&&t.teleportationComponent.onAxisValueChangedObservable.remove(t.onAxisChangedObserver),t.onButtonChangedObserver&&t.teleportationComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver)),delete this._controllers[e])}_findClosestSnapPointWithRadius(e,t=this._options.snapToPositionRadius||.8){let i=null,s=Number.MAX_VALUE;if(this._snapToPositions.length){const r=t*t;this._snapToPositions.forEach((t=>{const n=S.DistanceSquared(t,e);n<=r&&n<s&&(s=n,i=t)}))}return i}_setTargetMeshPosition(e){const t=e.pickedPoint;if(!this._options.teleportationTargetMesh||!t)return;const i=this._findClosestSnapPointWithRadius(t);this._snappedToPoint=!!i,this.snapPointsOnly&&!this._snappedToPoint&&this._teleportationRingMaterial?this._teleportationRingMaterial.diffuseColor.set(1,.3,.3):this.snapPointsOnly&&this._snappedToPoint&&this._teleportationRingMaterial&&this._teleportationRingMaterial.diffuseColor.set(.3,.3,1),this._options.teleportationTargetMesh.position.copyFrom(i||t),this._options.teleportationTargetMesh.position.y+=.01,this.onTargetMeshPositionUpdatedObservable.notifyObservers(e)}_setTargetMeshVisibility(e,t){this._options.teleportationTargetMesh&&(this._options.teleportationTargetMesh.isVisible!==e||t)&&(this._options.teleportationTargetMesh.isVisible=e,this._options.teleportationTargetMesh.getChildren(void 0,!1).forEach((t=>{t.isVisible=e})),e?this._selectionFeature&&this._selectionFeature.detach():(this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null),this._selectionFeature&&this._selectionFeature.attach()))}_disposeBezierCurve(){this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null)}_showParabolicPath(e){if(!e.pickedPoint||!this._currentTeleportationControllerId)return;const t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||yl.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,i=this._controllers[this._currentTeleportationControllerId],s=es.CreateQuadraticBezier(i.xrController.pointer.absolutePosition,e.ray.origin,e.pickedPoint,25),r=i.teleportationState.blocked?this._blockedRayColor:void 0,n=new Array(26).fill(r||this._cachedColor4White);this._options.generateRayPathMesh?this._quadraticBezierCurve=this._options.generateRayPathMesh(s.getPoints(),e):this._quadraticBezierCurve=Yl("teleportation path line",{points:s.getPoints(),instance:this._quadraticBezierCurve,updatable:!0,colors:n},t),this._quadraticBezierCurve.isPickable=!1,void 0!==this._options.renderingGroupId&&(this._quadraticBezierCurve.renderingGroupId=this._options.renderingGroupId)}_teleportForward(e){const t=this._controllers[e];if(t&&t.teleportationState.forward&&this.teleportationEnabled&&(t.teleportationState.forward=!1,this._currentTeleportationControllerId="",!this.snapPointsOnly||this._snappedToPoint))if(this.skipNextTeleportation)this.skipNextTeleportation=!1;else if(this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.isVisible){const e=this._options.xrInput.xrCamera.realWorldHeight;this._options.xrInput.xrCamera.onBeforeCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position),this._options.xrInput.xrCamera.position.copyFrom(this._options.teleportationTargetMesh.position),this._options.xrInput.xrCamera.position.y+=e,C.FromEulerAngles(0,t.teleportationState.currentRotation-(this._xrSessionManager.scene.useRightHandedSystem?Math.PI:0),0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this._options.xrInput.xrCamera.onAfterCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position)}}}xp.Name=Vr.TELEPORTATION,xp.Version=1,kr.AddWebXRFeature(xp.Name,((e,t)=>()=>new xp(e,t)),xp.Version,!0);class Tp{constructor(){}static CreateAsync(e,t={}){const i=new Tp;if(e.onDisposeObservable.addOnce((()=>{i.dispose()})),!t.disableDefaultUI){const s=Object.assign({renderTarget:i.renderTarget},t.uiOptions||{});t.optionalFeatures&&("boolean"==typeof t.optionalFeatures?s.optionalFeatures=["hit-test","anchors","plane-detection","hand-tracking"]:s.optionalFeatures=t.optionalFeatures),i.enterExitUI=new mp(e,s)}return Jd.CreateAsync(e).then((e=>{if(i.baseExperience=e,t.ignoreNativeCameraTransformation&&(i.baseExperience.camera.compensateOnFirstFrame=!1),i.input=new hp(e.sessionManager,e.camera,Object.assign({controllerOptions:{renderingGroupId:t.renderingGroupId}},t.inputOptions||{})),!t.disablePointerSelection){const e=Object.assign(Object.assign({},t.pointerSelectionOptions),{xrInput:i.input,renderingGroupId:t.renderingGroupId});i.pointerSelection=i.baseExperience.featuresManager.enableFeature(cp.Name,t.useStablePlugins?"stable":"latest",e),t.disableTeleportation||(i.teleportation=i.baseExperience.featuresManager.enableFeature(xp.Name,t.useStablePlugins?"stable":"latest",Object.assign({floorMeshes:t.floorMeshes,xrInput:i.input,renderingGroupId:t.renderingGroupId},t.teleportationOptions)),i.teleportation.setSelectionFeature(i.pointerSelection))}return t.disableNearInteraction||(i.nearInteraction=i.baseExperience.featuresManager.enableFeature(_p.Name,t.useStablePlugins?"stable":"latest",Object.assign({xrInput:i.input,farInteractionFeature:i.pointerSelection,renderingGroupId:t.renderingGroupId,useUtilityLayer:!0,enableNearInteractionOnAllControllers:!0},t.nearInteractionOptions))),i.renderTarget=i.baseExperience.sessionManager.getWebXRRenderTarget(t.outputCanvasOptions),t.disableDefaultUI?void 0:i.enterExitUI.setHelperAsync(i.baseExperience,i.renderTarget)})).then((()=>i)).catch((e=>(k.Error("Error initializing XR"),k.Error(e),i)))}dispose(){this.baseExperience&&this.baseExperience.dispose(),this.input&&this.input.dispose(),this.enterExitUI&&this.enterExitUI.dispose(),this.renderTarget&&this.renderTarget.dispose()}}function Ep(e){for(;e.firstChild;)e.removeChild(e.firstChild);e.srcObject=null,e.src="",e.removeAttribute("src")}Yi.prototype.createDefaultLight=function(e=!1){if(e&&this.lights)for(let e=0;e<this.lights.length;e++)this.lights[e].dispose();0===this.lights.length&&new Cl("default light",S.Up(),this)},Yi.prototype.createDefaultCamera=function(e=!1,t=!1,i=!1){if(t&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){const t=this.getWorldExtends((e=>e.isVisible&&e.isEnabled())),s=t.max.subtract(t.min),r=t.min.add(s.scale(.5));let n,o=1.5*s.length();if(isFinite(o)||(o=1,r.copyFromFloats(0,0,0)),e){const e=new Ho("default camera",-Math.PI/2,Math.PI/2,o,r,this);e.lowerRadiusLimit=.01*o,e.wheelPrecision=100/o,n=e}else{const e=new zo("default camera",new S(r.x,r.y,-o),this);e.setTarget(r),n=e}n.minZ=.01*o,n.maxZ=1e3*o,n.speed=.2*o,this.activeCamera=n,i&&n.attachControl()}},Yi.prototype.createDefaultCameraOrLight=function(e=!1,t=!1,i=!1){this.createDefaultLight(t),this.createDefaultCamera(e,t,i)},Yi.prototype.createDefaultSkybox=function(e,t=!1,i=1e3,s=0,r=!0){if(!e)return k.Warn("Can not create default skybox without environment texture."),null;r&&e&&(this.environmentTexture=e);const n=Pl("hdrSkyBox",{size:i},this);if(t){const t=new Fd("skyBox",this);t.backFaceCulling=!1,t.reflectionTexture=e.clone(),t.reflectionTexture&&(t.reflectionTexture.coordinatesMode=Ar.SKYBOX_MODE),t.microSurface=1-s,t.disableLighting=!0,t.twoSidedLighting=!0,n.material=t}else{const t=new Va("skyBox",this);t.backFaceCulling=!1,t.reflectionTexture=e.clone(),t.reflectionTexture&&(t.reflectionTexture.coordinatesMode=Ar.SKYBOX_MODE),t.disableLighting=!0,n.material=t}return n.isPickable=!1,n.infiniteDistance=!0,n.ignoreCameraMaxZ=!0,n},Yi.prototype.createDefaultEnvironment=function(e){return _d?new _d(e,this):null},Yi.prototype.createDefaultVRExperience=function(e={}){return new ll(this,e)},Yi.prototype.createDefaultXRExperienceAsync=function(e={}){return Tp.CreateAsync(this,e).then((e=>e))};class Sp extends Ar{get onUserActionRequestedObservable(){return this._onUserActionRequestedObservable||(this._onUserActionRequestedObservable=new a),this._onUserActionRequestedObservable}_processError(e){this._errorFound=!0,this._onError?this._onError(null==e?void 0:e.message):k.Error(null==e?void 0:e.message)}_handlePlay(){this._errorFound=!1,this.video.play().catch((e=>{if("NotAllowedError"===(null==e?void 0:e.name)){if(this._onUserActionRequestedObservable&&this._onUserActionRequestedObservable.hasObservers())return void this._onUserActionRequestedObservable.notifyObservers(this);if(!this.video.muted)return k.Warn("Unable to autoplay a video with sound. Trying again with muted turned true"),this.video.muted=!0,this._errorFound=!1,void this.video.play().catch((e=>{this._processError(e)}))}this._processError(e)}))}constructor(e,t,i,s=!1,r=!1,n=Ar.TRILINEAR_SAMPLINGMODE,o={},a,l=5){var h,c;super(null,i,!s,r),this._onUserActionRequestedObservable=null,this._stillImageCaptured=!1,this._displayingPosterTexture=!1,this._frameId=-1,this._currentSrc=null,this._errorFound=!1,this.isVideo=!0,this._resizeInternalTexture=()=>{var e;null!=this._texture&&this._texture.dispose(),!this._getEngine().needPOTTextures||Ht.IsExponentOfTwo(this.video.videoWidth)&&Ht.IsExponentOfTwo(this.video.videoHeight)?(this.wrapU=Ar.WRAP_ADDRESSMODE,this.wrapV=Ar.WRAP_ADDRESSMODE):(this.wrapU=Ar.CLAMP_ADDRESSMODE,this.wrapV=Ar.CLAMP_ADDRESSMODE,this._generateMipMaps=!1),this._texture=this._getEngine().createDynamicTexture(this.video.videoWidth,this.video.videoHeight,this._generateMipMaps,this.samplingMode),this._texture.format=null!==(e=this._format)&&void 0!==e?e:5,this._frameId=-1,this._updateInternalTexture()},this._createInternalTexture=()=>{if(null!=this._texture){if(!this._displayingPosterTexture)return;this._displayingPosterTexture=!1}if(this.video.addEventListener("resize",this._resizeInternalTexture),this._resizeInternalTexture(),this.video.autoplay||this._settings.poster||this._settings.independentVideoSource)this._updateInternalTexture(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this);else{const e=this.video.onplaying,t=this.video.muted;this.video.muted=!0,this.video.onplaying=()=>{this.video.muted=t,this.video.onplaying=e,this._updateInternalTexture(),this._errorFound||this.video.pause(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this)},this._handlePlay()}},this._reset=()=>{null!=this._texture&&(this._displayingPosterTexture||(this._texture.dispose(),this._texture=null))},this._updateInternalTexture=()=>{if(null==this._texture)return;if(this.video.readyState<this.video.HAVE_CURRENT_DATA)return;if(this._displayingPosterTexture)return;const e=this.getScene().getFrameId();this._frameId!==e&&(this._frameId=e,this._getEngine().updateVideoTexture(this._texture,this._externalTexture?this._externalTexture:this.video,this._invertY))},this._settings=Object.assign({autoPlay:!0,loop:!0,autoUpdateTexture:!0},o),this._onError=a,this._generateMipMaps=s,this._initialSamplingMode=n,this.autoUpdateTexture=this._settings.autoUpdateTexture,this._currentSrc=t,this.name=e||this._getName(t),this.video=this._getVideo(t),this._externalTexture=null!==(c=null===(h=this._engine)||void 0===h?void 0:h.createExternalTexture(this.video))&&void 0!==c?c:null,this._settings.independentVideoSource||(this._settings.poster&&(this.video.poster=this._settings.poster),void 0!==this._settings.autoPlay&&(this.video.autoplay=this._settings.autoPlay),void 0!==this._settings.loop&&(this.video.loop=this._settings.loop),void 0!==this._settings.muted&&(this.video.muted=this._settings.muted),this.video.setAttribute("playsinline",""),this.video.addEventListener("paused",this._updateInternalTexture),this.video.addEventListener("seeked",this._updateInternalTexture),this.video.addEventListener("emptied",this._reset),this._settings.autoPlay&&this._handlePlay()),this._createInternalTextureOnEvent=this._settings.poster&&!this._settings.autoPlay?"play":"canplay",this.video.addEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this._format=l;const u=this.video.readyState>=this.video.HAVE_CURRENT_DATA;!this._settings.poster||this._settings.autoPlay&&u?u&&this._createInternalTexture():(this._texture=this._getEngine().createTexture(this._settings.poster,!1,!this.invertY,i),this._displayingPosterTexture=!0)}getClassName(){return"VideoTexture"}_getName(e){return e instanceof HTMLVideoElement?e.currentSrc:"object"==typeof e?e.toString():e}_getVideo(e){if(e.isNative)return e;if(e instanceof HTMLVideoElement)return Ht.SetCorsBehavior(e.currentSrc,e),e;const t=document.createElement("video");return"string"==typeof e?(Ht.SetCorsBehavior(e,t),t.src=e):(Ht.SetCorsBehavior(e[0],t),e.forEach((e=>{const i=document.createElement("source");i.src=e,t.appendChild(i)}))),this.onDisposeObservable.addOnce((()=>{Ep(t)})),t}_rebuild(){this.update()}update(){this.autoUpdateTexture&&this.updateTexture(!0)}updateTexture(e){e&&(this.video.paused&&this._stillImageCaptured||(this._stillImageCaptured=!0,this._updateInternalTexture()))}get externalTexture(){return this._externalTexture}updateURL(e){this.video.src=e,this._currentSrc=e}clone(){return new Sp(this.name,this._currentSrc,this.getScene(),this._generateMipMaps,this.invertY,this.samplingMode,this._settings)}dispose(){var e;super.dispose(),this._currentSrc=null,this._onUserActionRequestedObservable&&(this._onUserActionRequestedObservable.clear(),this._onUserActionRequestedObservable=null),this.video.removeEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this._settings.independentVideoSource||(this.video.removeEventListener("paused",this._updateInternalTexture),this.video.removeEventListener("seeked",this._updateInternalTexture),this.video.removeEventListener("emptied",this._reset),this.video.removeEventListener("resize",this._resizeInternalTexture),this.video.pause()),null===(e=this._externalTexture)||void 0===e||e.dispose()}static CreateFromStreamAsync(e,t,i,s=!0){const r=e.getEngine().createVideoElement(i);return e.getEngine()._badOS&&(document.body.appendChild(r),r.style.transform="scale(0.0001, 0.0001)",r.style.opacity="0",r.style.position="fixed",r.style.bottom="0px",r.style.right="0px"),r.setAttribute("autoplay",""),r.setAttribute("muted","true"),r.setAttribute("playsinline",""),r.muted=!0,r.isNative||(void 0!==r.mozSrcObject?r.mozSrcObject=t:"object"==typeof r.srcObject?r.srcObject=t:r.src=window.URL&&window.URL.createObjectURL(t)),new Promise((t=>{const i=()=>{const n=new Sp("video",r,e,!0,s,void 0,void 0,void 0,4);e.getEngine()._badOS&&n.onDisposeObservable.addOnce((()=>{r.remove()})),n.onDisposeObservable.addOnce((()=>{Ep(r)})),t(n),r.removeEventListener("playing",i)};r.addEventListener("playing",i),r.play()}))}static async CreateFromWebCamAsync(e,t,i=!1,s=!0){if(navigator.mediaDevices){const r=await navigator.mediaDevices.getUserMedia({video:t,audio:i}),n=await this.CreateFromStreamAsync(e,r,t,s);return n.onDisposeObservable.addOnce((()=>{r.getTracks().forEach((e=>{e.stop()}))})),n}return Promise.reject("No support for userMedia on this device")}static CreateFromWebCam(e,t,i,s=!1,r=!0){this.CreateFromWebCamAsync(e,i,s,r).then((function(e){t&&t(e)})).catch((function(e){k.Error(e.name)}))}}me([ie("settings")],Sp.prototype,"_settings",void 0),me([ie("src")],Sp.prototype,"_currentSrc",void 0),me([ie()],Sp.prototype,"isVideo",void 0),Ar._CreateVideoTexture=(e,t,i,s=!1,r=!1,n=Ar.TRILINEAR_SAMPLINGMODE,o={},a,l=5)=>new Sp(e,t,i,s,r,n,o,a,l),m("BABYLON.VideoTexture",Sp);class bp extends fd{get videoTexture(){return this._texture}get videoMode(){return this.textureMode}set videoMode(e){this.textureMode=e}_initTexture(e,t,i){const s={loop:i.loop,autoPlay:i.autoPlay,autoUpdateTexture:!0,poster:i.poster},r=new Sp((this.name||"videoDome")+"_texture",e,t,i.generateMipMaps,this._useDirectMapping,Ar.TRILINEAR_SAMPLINGMODE,s);return i.clickToPlay&&(this._pointerObserver=t.onPointerObservable.add((e=>{var t;(null===(t=e.pickInfo)||void 0===t?void 0:t.pickedMesh)===this.mesh&&this._texture.video.play()}),gi.POINTERDOWN)),this._textureObserver=r.onLoadObservable.add((()=>{this.onLoadObservable.notifyObservers()})),r}dispose(e,t=!1){this._texture.onLoadObservable.remove(this._textureObserver),this._scene.onPointerObservable.remove(this._pointerObserver),super.dispose(e,t)}}bp.MODE_MONOSCOPIC=fd.MODE_MONOSCOPIC,bp.MODE_TOPBOTTOM=fd.MODE_TOPBOTTOM,bp.MODE_SIDEBYSIDE=fd.MODE_SIDEBYSIDE;nt.ShadersStore.glowMapGenerationPixelShader="#if defined(DIFFUSE_ISLINEAR) || defined(EMISSIVE_ISLINEAR)\n#include<helperFunctions>\n#endif\n#ifdef DIFFUSE\nvarying vec2 vUVDiffuse;uniform sampler2D diffuseSampler;\n#endif\n#ifdef OPACITY\nvarying vec2 vUVOpacity;uniform sampler2D opacitySampler;uniform float opacityIntensity;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;uniform sampler2D emissiveSampler;\n#endif\n#ifdef VERTEXALPHA\nvarying vec4 vColor;\n#endif\nuniform vec4 glowColor;uniform float glowIntensity;\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\nvec4 finalColor=glowColor;\n#ifdef DIFFUSE\nvec4 albedoTexture=texture2D(diffuseSampler,vUVDiffuse);\n#ifdef DIFFUSE_ISLINEAR\nalbedoTexture=toGammaSpace(albedoTexture);\n#endif\n#ifdef GLOW\nfinalColor.a*=albedoTexture.a;\n#endif\n#ifdef HIGHLIGHT\nfinalColor.a=albedoTexture.a;\n#endif\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vUVOpacity);\n#ifdef OPACITYRGB\nfinalColor.a*=getLuminance(opacityMap.rgb);\n#else\nfinalColor.a*=opacityMap.a;\n#endif\nfinalColor.a*=opacityIntensity;\n#endif\n#ifdef VERTEXALPHA\nfinalColor.a*=vColor.a;\n#endif\n#ifdef ALPHATEST\nif (finalColor.a<ALPHATESTVALUE)\ndiscard;\n#endif\n#ifdef EMISSIVE\nvec4 emissive=texture2D(emissiveSampler,vUVEmissive);\n#ifdef EMISSIVE_ISLINEAR\nemissive=toGammaSpace(emissive);\n#endif\ngl_FragColor=emissive*finalColor*glowIntensity;\n#else\ngl_FragColor=finalColor*glowIntensity;\n#endif\n#ifdef HIGHLIGHT\ngl_FragColor.a=glowColor.a;\n#endif\n}";nt.ShadersStore.glowMapGenerationVertexShader="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;varying vec4 vPosition;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef DIFFUSE\nvarying vec2 vUVDiffuse;uniform mat4 diffuseMatrix;\n#endif\n#ifdef OPACITY\nvarying vec2 vUVOpacity;uniform mat4 opacityMatrix;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;uniform mat4 emissiveMatrix;\n#endif\n#ifdef VERTEXALPHA\nattribute vec4 color;varying vec4 vColor;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef CUBEMAP\nvPosition=worldPos;gl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#else\nvPosition=viewProjection*worldPos;gl_Position=vPosition;\n#endif\n#ifdef DIFFUSE\n#ifdef DIFFUSEUV1\nvUVDiffuse=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef DIFFUSEUV2\nvUVDiffuse=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef OPACITY\n#ifdef OPACITYUV1\nvUVOpacity=vec2(opacityMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef OPACITYUV2\nvUVOpacity=vec2(opacityMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef EMISSIVE\n#ifdef EMISSIVEUV1\nvUVEmissive=vec2(emissiveMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef EMISSIVEUV2\nvUVEmissive=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef VERTEXALPHA\nvColor=color;\n#endif\n#include<clipPlaneVertex>\n}";class Cp{get camera(){return this._effectLayerOptions.camera}get renderingGroupId(){return this._effectLayerOptions.renderingGroupId}set renderingGroupId(e){this._effectLayerOptions.renderingGroupId=e}get mainTexture(){return this._mainTexture}setMaterialForRendering(e,t){if(this._mainTexture.setMaterialForRendering(e,t),Array.isArray(e))for(let i=0;i<e.length;++i){const s=e[i];t?this._materialForRendering[s.uniqueId]=[s,t]:delete this._materialForRendering[s.uniqueId]}else t?this._materialForRendering[e.uniqueId]=[e,t]:delete this._materialForRendering[e.uniqueId]}getEffectIntensity(e){var t;return null!==(t=this._effectIntensity[e.uniqueId])&&void 0!==t?t:1}setEffectIntensity(e,t){this._effectIntensity[e.uniqueId]=t}constructor(e,t){this._vertexBuffers={},this._maxSize=0,this._mainTextureDesiredSize={width:0,height:0},this._shouldRender=!0,this._postProcesses=[],this._textures=[],this._emissiveTextureAndColor={texture:null,color:new F},this._effectIntensity={},this.neutralColor=new F,this.isEnabled=!0,this.disableBoundingBoxesFromEffectLayer=!1,this.onDisposeObservable=new a,this.onBeforeRenderMainTextureObservable=new a,this.onBeforeComposeObservable=new a,this.onBeforeRenderMeshToEffect=new a,this.onAfterRenderMeshToEffect=new a,this.onAfterComposeObservable=new a,this.onSizeChangedObservable=new a,this._materialForRendering={},this.name=e,this._scene=t||x.LastCreatedScene,Cp._SceneComponentInitialization(this._scene),this._engine=this._scene.getEngine(),this._maxSize=this._engine.getCaps().maxTextureSize,this._scene.effectLayers.push(this),this._mergeDrawWrapper=[],this._generateIndexBuffer(),this._generateVertexBuffer()}_numInternalDraws(){return 1}_init(e){this._effectLayerOptions=Object.assign({mainTextureRatio:.5,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0,generateStencilBuffer:!1},e),this._setMainTextureSize(),this._createMainTexture(),this._createTextureAndPostProcesses()}_generateIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._engine.createIndexBuffer(e)}_generateVertexBuffer(){const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1);const t=new hi(this._engine,e,hi.PositionKind,!1,!1,2);this._vertexBuffers[hi.PositionKind]=t}_setMainTextureSize(){this._effectLayerOptions.mainTextureFixedSize?(this._mainTextureDesiredSize.width=this._effectLayerOptions.mainTextureFixedSize,this._mainTextureDesiredSize.height=this._effectLayerOptions.mainTextureFixedSize):(this._mainTextureDesiredSize.width=this._engine.getRenderWidth()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.height=this._engine.getRenderHeight()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.width=this._engine.needPOTTextures?Ns.GetExponentOfTwo(this._mainTextureDesiredSize.width,this._maxSize):this._mainTextureDesiredSize.width,this._mainTextureDesiredSize.height=this._engine.needPOTTextures?Ns.GetExponentOfTwo(this._mainTextureDesiredSize.height,this._maxSize):this._mainTextureDesiredSize.height),this._mainTextureDesiredSize.width=Math.floor(this._mainTextureDesiredSize.width),this._mainTextureDesiredSize.height=Math.floor(this._mainTextureDesiredSize.height)}_createMainTexture(){this._mainTexture=new Bn("EffectLayerMainRTT",{width:this._mainTextureDesiredSize.width,height:this._mainTextureDesiredSize.height},this._scene,!1,!0,this._effectLayerOptions.mainTextureType,!1,Ar.TRILINEAR_SAMPLINGMODE,!0,this._effectLayerOptions.generateStencilBuffer),this._mainTexture.activeCamera=this._effectLayerOptions.camera,this._mainTexture.wrapU=Ar.CLAMP_ADDRESSMODE,this._mainTexture.wrapV=Ar.CLAMP_ADDRESSMODE,this._mainTexture.anisotropicFilteringLevel=1,this._mainTexture.updateSamplingMode(Ar.BILINEAR_SAMPLINGMODE),this._mainTexture.renderParticles=!1,this._mainTexture.renderList=null,this._mainTexture.ignoreCameraViewport=!0;for(const e in this._materialForRendering){const[t,i]=this._materialForRendering[e];this._mainTexture.setMaterialForRendering(t,i)}if(this._mainTexture.customIsReadyFunction=(e,t,i)=>{if((i||0===t)&&e.subMeshes)for(let t=0;t<e.subMeshes.length;++t){const i=e.subMeshes[t],s=i.getMaterial(),r=i.getRenderingMesh();if(!s)continue;const n=r._getInstancesRenderList(i._id,!!i.getReplacementMesh()).hardwareInstancedRendering[i._id]||r.hasThinInstances;if(this._setEmissiveTextureAndColor(r,i,s),!this._isReady(i,n,this._emissiveTextureAndColor.texture))return!1}return!0},this._mainTexture.customRenderFunction=(e,t,i,s)=>{let r;this.onBeforeRenderMainTextureObservable.notifyObservers(this);const n=this._scene.getEngine();if(s.length){for(n.setColorWrite(!1),r=0;r<s.length;r++)this._renderSubMesh(s.data[r]);n.setColorWrite(!0)}for(r=0;r<e.length;r++)this._renderSubMesh(e.data[r]);for(r=0;r<t.length;r++)this._renderSubMesh(t.data[r]);const o=n.getAlphaMode();for(r=0;r<i.length;r++)this._renderSubMesh(i.data[r],!0);n.setAlphaMode(o)},this._mainTexture.onClearObservable.add((e=>{e.clear(this.neutralColor,!0,!0,!0)})),this._scene.getBoundingBoxRenderer){const e=this._scene.getBoundingBoxRenderer().enabled;this._mainTexture.onBeforeBindObservable.add((()=>{this._scene.getBoundingBoxRenderer().enabled=!this.disableBoundingBoxesFromEffectLayer&&e})),this._mainTexture.onAfterUnbindObservable.add((()=>{this._scene.getBoundingBoxRenderer().enabled=e}))}}_addCustomEffectDefines(e){}_isReady(e,t,i){var s;const r=this._scene.getEngine(),n=e.getMesh(),o=null===(s=n._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===s?void 0:s[r.currentRenderPassId];if(o)return o.isReadyForSubMesh(n,e,t);const a=e.getMaterial();if(!a)return!1;if(this._useMeshMaterial(e.getRenderingMesh()))return a.isReadyForSubMesh(e.getMesh(),e,t);const l=[],h=[hi.PositionKind];let c=!1,u=!1;if(a){const e=a.needAlphaTesting(),t=a.getAlphaTestTexture(),i=t&&t.hasAlpha&&(a.useAlphaFromDiffuseTexture||a._useAlphaFromAlbedoTexture);t&&(e||i)&&(l.push("#define DIFFUSE"),n.isVerticesDataPresent(hi.UV2Kind)&&1===t.coordinatesIndex?(l.push("#define DIFFUSEUV2"),u=!0):n.isVerticesDataPresent(hi.UVKind)&&(l.push("#define DIFFUSEUV1"),c=!0),e&&(l.push("#define ALPHATEST"),l.push("#define ALPHATESTVALUE 0.4")),t.gammaSpace||l.push("#define DIFFUSE_ISLINEAR"));const s=a.opacityTexture;s&&(l.push("#define OPACITY"),n.isVerticesDataPresent(hi.UV2Kind)&&1===s.coordinatesIndex?(l.push("#define OPACITYUV2"),u=!0):n.isVerticesDataPresent(hi.UVKind)&&(l.push("#define OPACITYUV1"),c=!0))}i&&(l.push("#define EMISSIVE"),n.isVerticesDataPresent(hi.UV2Kind)&&1===i.coordinatesIndex?(l.push("#define EMISSIVEUV2"),u=!0):n.isVerticesDataPresent(hi.UVKind)&&(l.push("#define EMISSIVEUV1"),c=!0),i.gammaSpace||l.push("#define EMISSIVE_ISLINEAR")),n.useVertexColors&&n.isVerticesDataPresent(hi.ColorKind)&&n.hasVertexAlpha&&a.transparencyMode!==sr.MATERIAL_OPAQUE&&(h.push(hi.ColorKind),l.push("#define VERTEXALPHA")),c&&(h.push(hi.UVKind),l.push("#define UV1")),u&&(h.push(hi.UV2Kind),l.push("#define UV2"));const d=new hn;if(n.useBones&&n.computeBonesUsingShaders){h.push(hi.MatricesIndicesKind),h.push(hi.MatricesWeightsKind),n.numBoneInfluencers>4&&(h.push(hi.MatricesIndicesExtraKind),h.push(hi.MatricesWeightsExtraKind)),l.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers);const e=n.skeleton;e&&e.isUsingTextureForMatrices?l.push("#define BONETEXTURE"):l.push("#define BonesPerMesh "+(e?e.bones.length+1:0)),n.numBoneInfluencers>0&&d.addCPUSkinningFallback(0,n)}else l.push("#define NUM_BONE_INFLUENCERS 0");const p=n.morphTargetManager;let _=0;p&&p.numInfluencers>0&&(l.push("#define MORPHTARGETS"),_=p.numInfluencers,l.push("#define NUM_MORPH_INFLUENCERS "+_),p.isUsingTextureForTargets&&l.push("#define MORPHTARGETS_TEXTURE"),Hs.PrepareAttributesForMorphTargetsInfluencers(h,n,_)),t&&(l.push("#define INSTANCES"),Hs.PushAttributesForInstances(h),e.getRenderingMesh().hasThinInstances&&l.push("#define THIN_INSTANCES")),Gs(a,this._scene,l),this._addCustomEffectDefines(l);const f=e._getDrawWrapper(void 0,!0),m=f.defines,g=l.join("\n");if(m!==g){const e=["world","mBones","viewProjection","glowColor","morphTargetInfluences","boneTextureWidth","diffuseMatrix","emissiveMatrix","opacityMatrix","opacityIntensity","morphTargetTextureInfo","morphTargetTextureIndices","glowIntensity"];ks(e),f.setEffect(this._engine.createEffect("glowMapGeneration",h,e,["diffuseSampler","emissiveSampler","opacitySampler","boneSampler","morphTargets"],g,d,void 0,void 0,{maxSimultaneousMorphTargets:_}),g)}return f.effect.isReady()}render(){for(let e=0;e<this._postProcesses.length;e++)if(!this._postProcesses[e].isReady())return;const e=this._scene.getEngine(),t=this._numInternalDraws();let i=!0;for(let e=0;e<t;++e){let t=this._mergeDrawWrapper[e];t||(t=this._mergeDrawWrapper[e]=new Tt(this._engine),t.setEffect(this._createMergeEffect())),i=i&&t.effect.isReady()}if(!i)return;this.onBeforeComposeObservable.notifyObservers(this);const s=e.getAlphaMode();for(let i=0;i<t;++i){const t=this._mergeDrawWrapper[i];e.enableEffect(t),e.setState(!1),e.bindBuffers(this._vertexBuffers,this._indexBuffer,t.effect),e.setAlphaMode(this._effectLayerOptions.alphaBlendingMode),this._internalRender(t.effect,i)}e.setAlphaMode(s),this.onAfterComposeObservable.notifyObservers(this);const r=this._mainTexture.getSize();this._setMainTextureSize(),r.width===this._mainTextureDesiredSize.width&&r.height===this._mainTextureDesiredSize.height||0===this._mainTextureDesiredSize.width||0===this._mainTextureDesiredSize.height||(this.onSizeChangedObservable.notifyObservers(this),this._disposeTextureAndPostProcesses(),this._createMainTexture(),this._createTextureAndPostProcesses())}hasMesh(e){return-1===this.renderingGroupId||e.renderingGroupId===this.renderingGroupId}shouldRender(){return this.isEnabled&&this._shouldRender}_shouldRenderMesh(e){return!0}_canRenderMesh(e,t){return!t.needAlphaBlendingForMesh(e)}_shouldRenderEmissiveTextureForMesh(){return!0}_renderSubMesh(e,t=!1){var i,s;if(!this.shouldRender())return;const r=e.getMaterial(),n=e.getMesh(),o=e.getReplacementMesh(),a=e.getRenderingMesh(),l=e.getEffectiveMesh(),h=this._scene,c=h.getEngine();if(l._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!r)return;if(!this._canRenderMesh(a,r))return;let u=null!==(i=a.overrideMaterialSideOrientation)&&void 0!==i?i:r.sideOrientation;l._getWorldMatrixDeterminant()<0&&(u=u===sr.ClockWiseSideOrientation?sr.CounterClockWiseSideOrientation:sr.ClockWiseSideOrientation);const d=u===sr.ClockWiseSideOrientation;c.setState(r.backFaceCulling,r.zOffset,void 0,d,r.cullBackFaces,void 0,r.zOffsetUnits);const p=a._getInstancesRenderList(e._id,!!o);if(p.mustReturn)return;if(!this._shouldRenderMesh(a))return;const _=p.hardwareInstancedRendering[e._id]||a.hasThinInstances;if(this._setEmissiveTextureAndColor(a,e,r),this.onBeforeRenderMeshToEffect.notifyObservers(n),this._useMeshMaterial(a))a.render(e,t,o||void 0);else if(this._isReady(e,_,this._emissiveTextureAndColor.texture)){const i=null===(s=l._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===s?void 0:s[c.currentRenderPassId];let n=e._getDrawWrapper();if(!n&&i&&(n=i._getDrawWrapper()),!n)return;const o=n.effect;if(c.enableEffect(n),_||a._bind(e,o,r.fillMode),i?i.bindForSubMesh(l.getWorldMatrix(),l,e):(o.setMatrix("viewProjection",h.getTransformMatrix()),o.setMatrix("world",l.getWorldMatrix()),o.setFloat4("glowColor",this._emissiveTextureAndColor.color.r,this._emissiveTextureAndColor.color.g,this._emissiveTextureAndColor.color.b,this._emissiveTextureAndColor.color.a)),!i){const e=r.needAlphaTesting(),i=r.getAlphaTestTexture(),s=i&&i.hasAlpha&&(r.useAlphaFromDiffuseTexture||r._useAlphaFromAlbedoTexture);if(i&&(e||s)){o.setTexture("diffuseSampler",i);const e=i.getTextureMatrix();e&&o.setMatrix("diffuseMatrix",e)}const n=r.opacityTexture;if(n){o.setTexture("opacitySampler",n),o.setFloat("opacityIntensity",n.level);const e=n.getTextureMatrix();e&&o.setMatrix("opacityMatrix",e)}if(this._emissiveTextureAndColor.texture&&(o.setTexture("emissiveSampler",this._emissiveTextureAndColor.texture),o.setMatrix("emissiveMatrix",this._emissiveTextureAndColor.texture.getTextureMatrix())),a.useBones&&a.computeBonesUsingShaders&&a.skeleton){const e=a.skeleton;if(e.isUsingTextureForMatrices){const t=e.getTransformMatrixTexture(a);if(!t)return;o.setTexture("boneSampler",t),o.setFloat("boneTextureWidth",4*(e.bones.length+1))}else o.setMatrices("mBones",e.getTransformMatrices(a))}Hs.BindMorphTargetParameters(a,o),a.morphTargetManager&&a.morphTargetManager.isUsingTextureForTargets&&a.morphTargetManager._bind(o),t&&c.setAlphaMode(r.alphaMode),o.setFloat("glowIntensity",this.getEffectIntensity(a)),zs(o,r,h)}a._processRendering(l,e,o,r.fillMode,p,_,((e,t)=>o.setMatrix("world",t)))}else this._mainTexture.resetRefreshCounter();this.onAfterRenderMeshToEffect.notifyObservers(n)}_useMeshMaterial(e){return!1}_rebuild(){const e=this._vertexBuffers[hi.PositionKind];e&&e._rebuild(),this._generateIndexBuffer()}_disposeTextureAndPostProcesses(){this._mainTexture.dispose();for(let e=0;e<this._postProcesses.length;e++)this._postProcesses[e]&&this._postProcesses[e].dispose();this._postProcesses=[];for(let e=0;e<this._textures.length;e++)this._textures[e]&&this._textures[e].dispose();this._textures=[]}dispose(){const e=this._vertexBuffers[hi.PositionKind];e&&(e.dispose(),this._vertexBuffers[hi.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);for(const e of this._mergeDrawWrapper)e.dispose();this._mergeDrawWrapper=[],this._disposeTextureAndPostProcesses();const t=this._scene.effectLayers.indexOf(this,0);t>-1&&this._scene.effectLayers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderMainTextureObservable.clear(),this.onBeforeComposeObservable.clear(),this.onBeforeRenderMeshToEffect.clear(),this.onAfterRenderMeshToEffect.clear(),this.onAfterComposeObservable.clear(),this.onSizeChangedObservable.clear()}getClassName(){return"EffectLayer"}static Parse(e,t,i){return Ht.Instantiate(e.customType).Parse(e,t,i)}}Cp._SceneComponentInitialization=e=>{throw $("EffectLayerSceneComponent")},me([ie()],Cp.prototype,"name",void 0),me([he()],Cp.prototype,"neutralColor",void 0),me([ie()],Cp.prototype,"isEnabled",void 0),me([ee(11,void 0)],Cp.prototype,"camera",null),me([ie()],Cp.prototype,"renderingGroupId",null),me([ie()],Cp.prototype,"disableBoundingBoxesFromEffectLayer",void 0),s.AddParser(fi.NAME_EFFECTLAYER,((e,t,i,s)=>{if(e.effectLayers){i.effectLayers||(i.effectLayers=[]);for(let r=0;r<e.effectLayers.length;r++){const n=Cp.Parse(e.effectLayers[r],t,s);i.effectLayers.push(n)}}})),s.prototype.removeEffectLayer=function(e){const t=this.effectLayers.indexOf(e);return-1!==t&&this.effectLayers.splice(t,1),t},s.prototype.addEffectLayer=function(e){this.effectLayers.push(e)};class yp{constructor(e){this.name=fi.NAME_EFFECTLAYER,this._renderEffects=!1,this._needStencil=!1,this._previousStencilState=!1,this.scene=e||x.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine(),this.scene.effectLayers=[])}register(){this.scene._isReadyForMeshStage.registerStep(fi.STEP_ISREADYFORMESH_EFFECTLAYER,this,this._isReadyForMesh),this.scene._cameraDrawRenderTargetStage.registerStep(fi.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER,this,this._renderMainTexture),this.scene._beforeCameraDrawStage.registerStep(fi.STEP_BEFORECAMERADRAW_EFFECTLAYER,this,this._setStencil),this.scene._afterRenderingGroupDrawStage.registerStep(fi.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW,this,this._drawRenderingGroup),this.scene._afterCameraDrawStage.registerStep(fi.STEP_AFTERCAMERADRAW_EFFECTLAYER,this,this._setStencilBack),this.scene._afterCameraDrawStage.registerStep(fi.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW,this,this._drawCamera)}rebuild(){const e=this.scene.effectLayers;for(const t of e)t._rebuild()}serialize(e){e.effectLayers=[];const t=this.scene.effectLayers;for(const i of t)i.serialize&&e.effectLayers.push(i.serialize())}addFromContainer(e){e.effectLayers&&e.effectLayers.forEach((e=>{this.scene.addEffectLayer(e)}))}removeFromContainer(e,t){e.effectLayers&&e.effectLayers.forEach((e=>{this.scene.removeEffectLayer(e),t&&e.dispose()}))}dispose(){const e=this.scene.effectLayers;for(;e.length;)e[0].dispose()}_isReadyForMesh(e,t){const i=this._engine.currentRenderPassId,s=this.scene.effectLayers;for(const r of s){if(!r.hasMesh(e))continue;const s=r._mainTexture;this._engine.currentRenderPassId=s.renderPassId;for(const s of e.subMeshes)if(!r.isReady(s,t))return this._engine.currentRenderPassId=i,!1}return this._engine.currentRenderPassId=i,!0}_renderMainTexture(e){this._renderEffects=!1,this._needStencil=!1;let t=!1;const i=this.scene.effectLayers;if(i&&i.length>0){this._previousStencilState=this._engine.getStencilBuffer();for(const s of i)if(s.shouldRender()&&(!s.camera||s.camera.cameraRigMode===ps.RIG_MODE_NONE&&e===s.camera||s.camera.cameraRigMode!==ps.RIG_MODE_NONE&&s.camera._rigCameras.indexOf(e)>-1)){this._renderEffects=!0,this._needStencil=this._needStencil||s.needStencil();const e=s._mainTexture;e._shouldRender()&&(this.scene.incrementRenderId(),e.render(!1,!1),t=!0)}this.scene.incrementRenderId()}return t}_setStencil(){this._needStencil&&this._engine.setStencilBuffer(!0)}_setStencilBack(){this._needStencil&&this._engine.setStencilBuffer(this._previousStencilState)}_draw(e){if(this._renderEffects){this._engine.setDepthBuffer(!1);const t=this.scene.effectLayers;for(let i=0;i<t.length;i++){const s=t[i];s.renderingGroupId===e&&s.shouldRender()&&s.render()}this._engine.setDepthBuffer(!0)}}_drawCamera(){this._renderEffects&&this._draw(-1)}_drawRenderingGroup(e){!this.scene._isInIntermediateRendering()&&this._renderEffects&&this._draw(e)}}Cp._SceneComponentInitialization=e=>{let t=e._getComponent(fi.NAME_EFFECTLAYER);t||(t=new yp(e),e._addComponent(t))};nt.ShadersStore.glowMapMergePixelShader="varying vec2 vUV;uniform sampler2D textureSampler;\n#ifdef EMISSIVE\nuniform sampler2D textureSampler2;\n#endif\nuniform float offset;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 baseColor=texture2D(textureSampler,vUV);\n#ifdef EMISSIVE\nbaseColor+=texture2D(textureSampler2,vUV);baseColor*=offset;\n#else\nbaseColor.a=abs(offset-baseColor.a);\n#ifdef STROKE\nfloat alpha=smoothstep(.0,.1,baseColor.a);baseColor.a=alpha;baseColor.rgb=baseColor.rgb*alpha;\n#endif\n#endif\n#if LDR\nbaseColor=clamp(baseColor,0.,1.0);\n#endif\ngl_FragColor=baseColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";nt.ShadersStore.glowMapMergeVertexShader="attribute vec2 position;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=position*madd+madd;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}",s.prototype.getGlowLayerByName=function(e){var t;for(let i=0;i<(null===(t=this.effectLayers)||void 0===t?void 0:t.length);i++)if(this.effectLayers[i].name===e&&this.effectLayers[i].getEffectName()===Ap.EffectName)return this.effectLayers[i];return null};class Ap extends Cp{set blurKernelSize(e){if(e===this._options.blurKernelSize)return;this._options.blurKernelSize=e;const t=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1.kernel=t,this._verticalBlurPostprocess1.kernel=t,this._horizontalBlurPostprocess2.kernel=t,this._verticalBlurPostprocess2.kernel=t}get blurKernelSize(){return this._options.blurKernelSize}set intensity(e){this._intensity=e}get intensity(){return this._intensity}constructor(e,t,i){super(e,t),this._intensity=1,this._includedOnlyMeshes=[],this._excludedMeshes=[],this._meshesUsingTheirOwnMaterials=[],this.neutralColor=new F(0,0,0,1),this._options=Object.assign({mainTextureRatio:Ap.DefaultTextureRatio,blurKernelSize:32,mainTextureFixedSize:void 0,camera:null,mainTextureSamples:1,renderingGroupId:-1,ldrMerge:!1,alphaBlendingMode:1,mainTextureType:0,generateStencilBuffer:!1},i),this._init({alphaBlendingMode:this._options.alphaBlendingMode,camera:this._options.camera,mainTextureFixedSize:this._options.mainTextureFixedSize,mainTextureRatio:this._options.mainTextureRatio,renderingGroupId:this._options.renderingGroupId,mainTextureType:this._options.mainTextureType,generateStencilBuffer:this._options.generateStencilBuffer})}getEffectName(){return Ap.EffectName}_createMergeEffect(){let e="#define EMISSIVE \n";return this._options.ldrMerge&&(e+="#define LDR \n"),this._engine.createEffect("glowMapMerge",[hi.PositionKind],["offset"],["textureSampler","textureSampler2"],e)}_createTextureAndPostProcesses(){let e=this._mainTextureDesiredSize.width,t=this._mainTextureDesiredSize.height;e=this._engine.needPOTTextures?Ns.GetExponentOfTwo(e,this._maxSize):e,t=this._engine.needPOTTextures?Ns.GetExponentOfTwo(t,this._maxSize):t;let i=0;i=this._engine.getCaps().textureHalfFloatRender?2:0,this._blurTexture1=new Bn("GlowLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture1.wrapU=Ar.CLAMP_ADDRESSMODE,this._blurTexture1.wrapV=Ar.CLAMP_ADDRESSMODE,this._blurTexture1.updateSamplingMode(Ar.BILINEAR_SAMPLINGMODE),this._blurTexture1.renderParticles=!1,this._blurTexture1.ignoreCameraViewport=!0;const s=Math.floor(e/2),r=Math.floor(t/2);this._blurTexture2=new Bn("GlowLayerBlurRTT2",{width:s,height:r},this._scene,!1,!0,i),this._blurTexture2.wrapU=Ar.CLAMP_ADDRESSMODE,this._blurTexture2.wrapV=Ar.CLAMP_ADDRESSMODE,this._blurTexture2.updateSamplingMode(Ar.BILINEAR_SAMPLINGMODE),this._blurTexture2.renderParticles=!1,this._blurTexture2.ignoreCameraViewport=!0,this._textures=[this._blurTexture1,this._blurTexture2];const n=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1=new hd("GlowLayerHBP1",new E(1,0),n,{width:e,height:t},null,Ar.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess1.width=e,this._horizontalBlurPostprocess1.height=t,this._horizontalBlurPostprocess1.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess1.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._mainTexture)})),this._verticalBlurPostprocess1=new hd("GlowLayerVBP1",new E(0,1),n,{width:e,height:t},null,Ar.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess2=new hd("GlowLayerHBP2",new E(1,0),n,{width:s,height:r},null,Ar.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess2.width=s,this._horizontalBlurPostprocess2.height=r,this._horizontalBlurPostprocess2.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess2.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._blurTexture1)})),this._verticalBlurPostprocess2=new hd("GlowLayerVBP2",new E(0,1),n,{width:s,height:r},null,Ar.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._postProcesses1=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1],this._postProcesses2=[this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._mainTexture.samples=this._options.mainTextureSamples,this._mainTexture.onAfterUnbindObservable.add((()=>{const e=this._blurTexture1.renderTarget;if(e){this._scene.postProcessManager.directRender(this._postProcesses1,e,!0);const t=this._blurTexture2.renderTarget;t&&this._scene.postProcessManager.directRender(this._postProcesses2,t,!0),this._engine.unBindFramebuffer(null!=t?t:e,!0)}})),this._postProcesses.map((e=>{e.autoClear=!1}))}_getEffectiveBlurKernelSize(){return this._options.blurKernelSize/2}isReady(e,t){const i=e.getMaterial(),s=e.getRenderingMesh();if(!i||!s)return!1;const r=i.emissiveTexture;return super._isReady(e,t,r)}needStencil(){return!1}_canRenderMesh(e,t){return!0}_internalRender(e){e.setTexture("textureSampler",this._blurTexture1),e.setTexture("textureSampler2",this._blurTexture2),e.setFloat("offset",this._intensity);const t=this._engine,i=t.getStencilBuffer();t.setStencilBuffer(!1),t.drawElementsType(sr.TriangleFillMode,0,6),t.setStencilBuffer(i)}_setEmissiveTextureAndColor(e,t,i){var s;let r=1;this.customEmissiveTextureSelector?this._emissiveTextureAndColor.texture=this.customEmissiveTextureSelector(e,t,i):i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.texture&&(r=this._emissiveTextureAndColor.texture.level)):this._emissiveTextureAndColor.texture=null,this.customEmissiveColorSelector?this.customEmissiveColorSelector(e,t,i,this._emissiveTextureAndColor.color):i.emissiveColor?(r*=null!==(s=i.emissiveIntensity)&&void 0!==s?s:1,this._emissiveTextureAndColor.color.set(i.emissiveColor.r*r,i.emissiveColor.g*r,i.emissiveColor.b*r,i.alpha)):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a)}_shouldRenderMesh(e){return this.hasMesh(e)}_addCustomEffectDefines(e){e.push("#define GLOW")}addExcludedMesh(e){-1===this._excludedMeshes.indexOf(e.uniqueId)&&this._excludedMeshes.push(e.uniqueId)}removeExcludedMesh(e){const t=this._excludedMeshes.indexOf(e.uniqueId);-1!==t&&this._excludedMeshes.splice(t,1)}addIncludedOnlyMesh(e){-1===this._includedOnlyMeshes.indexOf(e.uniqueId)&&this._includedOnlyMeshes.push(e.uniqueId)}removeIncludedOnlyMesh(e){const t=this._includedOnlyMeshes.indexOf(e.uniqueId);-1!==t&&this._includedOnlyMeshes.splice(t,1)}hasMesh(e){return!!super.hasMesh(e)&&(this._includedOnlyMeshes.length?-1!==this._includedOnlyMeshes.indexOf(e.uniqueId):!this._excludedMeshes.length||-1===this._excludedMeshes.indexOf(e.uniqueId))}_useMeshMaterial(e){return 0!=this._meshesUsingTheirOwnMaterials.length&&this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId)>-1}referenceMeshToUseItsOwnMaterial(e){e.resetDrawCache(this._mainTexture.renderPassId),this._meshesUsingTheirOwnMaterials.push(e.uniqueId),e.onDisposeObservable.add((()=>{this._disposeMesh(e)}))}unReferenceMeshFromUsingItsOwnMaterial(e){let t=this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId);for(;t>=0;)this._meshesUsingTheirOwnMaterials.splice(t,1),t=this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId);e.resetDrawCache(this._mainTexture.renderPassId)}_disposeMesh(e){this.removeIncludedOnlyMesh(e),this.removeExcludedMesh(e)}getClassName(){return"GlowLayer"}serialize(){const e=de.Serialize(this);let t;if(e.customType="BABYLON.GlowLayer",e.includedMeshes=[],this._includedOnlyMeshes.length)for(t=0;t<this._includedOnlyMeshes.length;t++){const i=this._scene.getMeshByUniqueId(this._includedOnlyMeshes[t]);i&&e.includedMeshes.push(i.id)}if(e.excludedMeshes=[],this._excludedMeshes.length)for(t=0;t<this._excludedMeshes.length;t++){const i=this._scene.getMeshByUniqueId(this._excludedMeshes[t]);i&&e.excludedMeshes.push(i.id)}return e}static Parse(e,t,i){const s=de.Parse((()=>new Ap(e.name,t,e.options)),e,t,i);let r;for(r=0;r<e.excludedMeshes.length;r++){const i=t.getMeshById(e.excludedMeshes[r]);i&&s.addExcludedMesh(i)}for(r=0;r<e.includedMeshes.length;r++){const i=t.getMeshById(e.includedMeshes[r]);i&&s.addIncludedOnlyMesh(i)}return s}}Ap.EffectName="GlowLayer",Ap.DefaultBlurKernelSize=32,Ap.DefaultTextureRatio=.5,me([ie()],Ap.prototype,"blurKernelSize",null),me([ie()],Ap.prototype,"intensity",null),me([ie("options")],Ap.prototype,"_options",void 0),m("BABYLON.GlowLayer",Ap);nt.ShadersStore.glowBlurPostProcessPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform vec2 direction;uniform float blurWidth;float getLuminance(vec3 color)\n{return dot(color,vec3(0.2126,0.7152,0.0722));}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float weights[7];weights[0]=0.05;weights[1]=0.1;weights[2]=0.2;weights[3]=0.3;weights[4]=0.2;weights[5]=0.1;weights[6]=0.05;vec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);vec2 texelStep=texelSize*direction*blurWidth;vec2 start=vUV-3.0*texelStep;vec4 baseColor=vec4(0.,0.,0.,0.);vec2 texelOffset=vec2(0.,0.);for (int i=0; i<7; i++)\n{vec4 texel=texture2D(textureSampler,start+texelOffset);baseColor.a+=texel.a*weights[i];float luminance=getLuminance(baseColor.rgb);float luminanceTexel=getLuminance(texel.rgb);float choice=step(luminanceTexel,luminance);baseColor.rgb=choice*baseColor.rgb+(1.0-choice)*texel.rgb;texelOffset+=texelStep;}\ngl_FragColor=baseColor;}",s.prototype.getHighlightLayerByName=function(e){var t;for(let i=0;i<(null===(t=this.effectLayers)||void 0===t?void 0:t.length);i++)if(this.effectLayers[i].name===e&&this.effectLayers[i].getEffectName()===Ip.EffectName)return this.effectLayers[i];return null};class Rp extends dn{constructor(e,t,i,s,r,n=Ar.BILINEAR_SAMPLINGMODE,o,a){super(e,"glowBlurPostProcess",["screenSize","direction","blurWidth"],null,s,r,n,o,a),this.direction=t,this.kernel=i,this.onApplyObservable.add((e=>{e.setFloat2("screenSize",this.width,this.height),e.setVector2("direction",this.direction),e.setFloat("blurWidth",this.kernel)}))}}class Ip extends Cp{set blurHorizontalSize(e){this._horizontalBlurPostprocess.kernel=e,this._options.blurHorizontalSize=e}set blurVerticalSize(e){this._verticalBlurPostprocess.kernel=e,this._options.blurVerticalSize=e}get blurHorizontalSize(){return this._horizontalBlurPostprocess.kernel}get blurVerticalSize(){return this._verticalBlurPostprocess.kernel}constructor(e,t,i){super(e,t),this.name=e,this.innerGlow=!0,this.outerGlow=!0,this.onBeforeBlurObservable=new a,this.onAfterBlurObservable=new a,this._instanceGlowingMeshStencilReference=Ip.GlowingMeshStencilReference++,this._meshes={},this._excludedMeshes={},this.neutralColor=Ip.NeutralColor,this._engine.isStencilEnable||k.Warn("Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new Engine(canvas, antialias, { stencil: true }"),this._options=Object.assign({mainTextureRatio:.5,blurTextureSizeRatio:.5,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0},i),this._init({alphaBlendingMode:this._options.alphaBlendingMode,camera:this._options.camera,mainTextureFixedSize:this._options.mainTextureFixedSize,mainTextureRatio:this._options.mainTextureRatio,renderingGroupId:this._options.renderingGroupId,mainTextureType:this._options.mainTextureType}),this._shouldRender=!1}getEffectName(){return Ip.EffectName}_numInternalDraws(){return 2}_createMergeEffect(){return this._engine.createEffect("glowMapMerge",[hi.PositionKind],["offset"],["textureSampler"],this._options.isStroke?"#define STROKE \n":void 0)}_createTextureAndPostProcesses(){let e=this._mainTextureDesiredSize.width*this._options.blurTextureSizeRatio,t=this._mainTextureDesiredSize.height*this._options.blurTextureSizeRatio;e=this._engine.needPOTTextures?Ns.GetExponentOfTwo(e,this._maxSize):e,t=this._engine.needPOTTextures?Ns.GetExponentOfTwo(t,this._maxSize):t;let i=0;i=this._engine.getCaps().textureHalfFloatRender?2:0,this._blurTexture=new Bn("HighlightLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture.wrapU=Ar.CLAMP_ADDRESSMODE,this._blurTexture.wrapV=Ar.CLAMP_ADDRESSMODE,this._blurTexture.anisotropicFilteringLevel=16,this._blurTexture.updateSamplingMode(Ar.TRILINEAR_SAMPLINGMODE),this._blurTexture.renderParticles=!1,this._blurTexture.ignoreCameraViewport=!0,this._textures=[this._blurTexture],2===this._options.alphaBlendingMode?(this._downSamplePostprocess=new sa("HighlightLayerPPP",this._options.blurTextureSizeRatio,null,Ar.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._downSamplePostprocess.externalTextureSamplerBinding=!0,this._downSamplePostprocess.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._mainTexture)})),this._horizontalBlurPostprocess=new Rp("HighlightLayerHBP",new E(1,0),this._options.blurHorizontalSize,1,null,Ar.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._horizontalBlurPostprocess.onApplyObservable.add((i=>{i.setFloat2("screenSize",e,t)})),this._verticalBlurPostprocess=new Rp("HighlightLayerVBP",new E(0,1),this._options.blurVerticalSize,1,null,Ar.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._verticalBlurPostprocess.onApplyObservable.add((i=>{i.setFloat2("screenSize",e,t)})),this._postProcesses=[this._downSamplePostprocess,this._horizontalBlurPostprocess,this._verticalBlurPostprocess]):(this._horizontalBlurPostprocess=new hd("HighlightLayerHBP",new E(1,0),this._options.blurHorizontalSize/2,{width:e,height:t},null,Ar.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess.width=e,this._horizontalBlurPostprocess.height=t,this._horizontalBlurPostprocess.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._mainTexture)})),this._verticalBlurPostprocess=new hd("HighlightLayerVBP",new E(0,1),this._options.blurVerticalSize/2,{width:e,height:t},null,Ar.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._postProcesses=[this._horizontalBlurPostprocess,this._verticalBlurPostprocess]),this._mainTexture.onAfterUnbindObservable.add((()=>{this.onBeforeBlurObservable.notifyObservers(this);const e=this._blurTexture.renderTarget;e&&(this._scene.postProcessManager.directRender(this._postProcesses,e,!0),this._engine.unBindFramebuffer(e,!0)),this.onAfterBlurObservable.notifyObservers(this)})),this._postProcesses.map((e=>{e.autoClear=!1}))}needStencil(){return!0}isReady(e,t){const i=e.getMaterial(),s=e.getRenderingMesh();if(!i||!s||!this._meshes)return!1;let r=null;const n=this._meshes[s.uniqueId];return n&&n.glowEmissiveOnly&&i&&(r=i.emissiveTexture),super._isReady(e,t,r)}_internalRender(e,t){e.setTexture("textureSampler",this._blurTexture);const i=this._engine;i.cacheStencilState(),i.setStencilOperationPass(7681),i.setStencilOperationFail(7680),i.setStencilOperationDepthFail(7680),i.setStencilMask(0),i.setStencilBuffer(!0),i.setStencilFunctionReference(this._instanceGlowingMeshStencilReference),this.outerGlow&&0===t&&(e.setFloat("offset",0),i.setStencilFunction(517),i.drawElementsType(sr.TriangleFillMode,0,6)),this.innerGlow&&1===t&&(e.setFloat("offset",1),i.setStencilFunction(514),i.drawElementsType(sr.TriangleFillMode,0,6)),i.restoreStencilState()}shouldRender(){return!!super.shouldRender()&&!!this._meshes}_shouldRenderMesh(e){return!(this._excludedMeshes&&this._excludedMeshes[e.uniqueId]||!super.hasMesh(e))}_canRenderMesh(e,t){return!0}_addCustomEffectDefines(e){e.push("#define HIGHLIGHT")}_setEmissiveTextureAndColor(e,t,i){const s=this._meshes[e.uniqueId];s?this._emissiveTextureAndColor.color.set(s.color.r,s.color.g,s.color.b,1):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a),s&&s.glowEmissiveOnly&&i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.color.set(1,1,1,1)):this._emissiveTextureAndColor.texture=null}addExcludedMesh(e){if(this._excludedMeshes&&!this._excludedMeshes[e.uniqueId]){const t={mesh:e,beforeBind:null,afterRender:null,stencilState:!1};t.beforeBind=e.onBeforeBindObservable.add((e=>{t.stencilState=e.getEngine().getStencilBuffer(),e.getEngine().setStencilBuffer(!1)})),t.afterRender=e.onAfterRenderObservable.add((e=>{e.getEngine().setStencilBuffer(t.stencilState)})),this._excludedMeshes[e.uniqueId]=t}}removeExcludedMesh(e){if(!this._excludedMeshes)return;const t=this._excludedMeshes[e.uniqueId];t&&(t.beforeBind&&e.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&e.onAfterRenderObservable.remove(t.afterRender)),this._excludedMeshes[e.uniqueId]=null}hasMesh(e){return!!this._meshes&&!!super.hasMesh(e)&&void 0!==this._meshes[e.uniqueId]&&null!==this._meshes[e.uniqueId]}addMesh(e,t,i=!1){if(!this._meshes)return;const s=this._meshes[e.uniqueId];s?s.color=t:(this._meshes[e.uniqueId]={mesh:e,color:t,observerHighlight:e.onBeforeBindObservable.add((e=>{this.isEnabled&&(this._excludedMeshes&&this._excludedMeshes[e.uniqueId]?this._defaultStencilReference(e):e.getScene().getEngine().setStencilFunctionReference(this._instanceGlowingMeshStencilReference))})),observerDefault:e.onAfterRenderObservable.add((e=>{this.isEnabled&&this._defaultStencilReference(e)})),glowEmissiveOnly:i},e.onDisposeObservable.add((()=>{this._disposeMesh(e)}))),this._shouldRender=!0}removeMesh(e){if(!this._meshes)return;const t=this._meshes[e.uniqueId];t&&(t.observerHighlight&&e.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&e.onAfterRenderObservable.remove(t.observerDefault),delete this._meshes[e.uniqueId]),this._shouldRender=!1;for(const e in this._meshes)if(this._meshes[e]){this._shouldRender=!0;break}}removeAllMeshes(){if(this._meshes)for(const e in this._meshes)if(Object.prototype.hasOwnProperty.call(this._meshes,e)){const t=this._meshes[e];t&&this.removeMesh(t.mesh)}}_defaultStencilReference(e){e.getScene().getEngine().setStencilFunctionReference(Ip.NormalMeshStencilReference)}_disposeMesh(e){this.removeMesh(e),this.removeExcludedMesh(e)}dispose(){if(this._meshes){for(const e in this._meshes){const t=this._meshes[e];t&&t.mesh&&(t.observerHighlight&&t.mesh.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&t.mesh.onAfterRenderObservable.remove(t.observerDefault))}this._meshes=null}if(this._excludedMeshes){for(const e in this._excludedMeshes){const t=this._excludedMeshes[e];t&&(t.beforeBind&&t.mesh.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&t.mesh.onAfterRenderObservable.remove(t.afterRender))}this._excludedMeshes=null}super.dispose()}getClassName(){return"HighlightLayer"}serialize(){const e=de.Serialize(this);if(e.customType="BABYLON.HighlightLayer",e.meshes=[],this._meshes)for(const t in this._meshes){const i=this._meshes[t];i&&e.meshes.push({glowEmissiveOnly:i.glowEmissiveOnly,color:i.color.asArray(),meshId:i.mesh.id})}if(e.excludedMeshes=[],this._excludedMeshes)for(const t in this._excludedMeshes){const i=this._excludedMeshes[t];i&&e.excludedMeshes.push(i.mesh.id)}return e}static Parse(e,t,i){const s=de.Parse((()=>new Ip(e.name,t,e.options)),e,t,i);let r;for(r=0;r<e.excludedMeshes.length;r++){const i=t.getMeshById(e.excludedMeshes[r]);i&&s.addExcludedMesh(i)}for(r=0;r<e.meshes.length;r++){const i=e.meshes[r],n=t.getMeshById(i.meshId);n&&s.addMesh(n,N.FromArray(i.color),i.glowEmissiveOnly)}return s}}Ip.EffectName="HighlightLayer",Ip.NeutralColor=new F(0,0,0,0),Ip.GlowingMeshStencilReference=2,Ip.NormalMeshStencilReference=1,me([ie()],Ip.prototype,"innerGlow",void 0),me([ie()],Ip.prototype,"outerGlow",void 0),me([ie()],Ip.prototype,"blurHorizontalSize",null),me([ie()],Ip.prototype,"blurVerticalSize",null),me([ie("options")],Ip.prototype,"_options",void 0),m("BABYLON.HighlightLayer",Ip);nt.ShadersStore.layerPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec4 color;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 baseColor=texture2D(textureSampler,vUV);\n#ifdef LINEAR\nbaseColor.rgb=toGammaSpace(baseColor.rgb);\n#endif\n#ifdef ALPHATEST\nif (baseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=baseColor*color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";nt.ShadersStore.layerVertexShader="attribute vec2 position;uniform vec2 scale;uniform vec2 offset;uniform mat4 textureMatrix;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec2 shiftedPosition=position*scale+offset;vUV=vec2(textureMatrix*vec4(shiftedPosition*madd+madd,1.0,0.0));gl_Position=vec4(shiftedPosition,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";class Pp{static AddFlare(e,t,i,s,r){return new Pp(e,t,i,s,r)}constructor(e,t,i,s,r){this.size=e,this.position=t,this.alphaMode=6,this.color=i||new N(1,1,1),this.texture=s?new Ar(s,r.getScene(),!0):null,this._system=r;const n=r.scene.getEngine();this._drawWrapper=new Tt(n),this._drawWrapper.effect=n.createEffect("lensFlare",[hi.PositionKind],["color","viewportMatrix"],["textureSampler"],""),r.lensFlares.push(this)}dispose(){this.texture&&this.texture.dispose();const e=this._system.lensFlares.indexOf(this);this._system.lensFlares.splice(e,1)}}nt.ShadersStore.lensFlarePixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec4 color;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 baseColor=texture2D(textureSampler,vUV);gl_FragColor=baseColor*color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";nt.ShadersStore.lensFlareVertexShader="attribute vec2 position;uniform mat4 viewportMatrix;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=position*madd+madd;gl_Position=viewportMatrix*vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";class Mp{get scene(){return this._scene}constructor(e,t,i){this.name=e,this.lensFlares=[],this.borderLimit=300,this.viewportBorder=0,this.layerMask=268435455,this._vertexBuffers={},this._isEnabled=!0,this._scene=i||x.LastCreatedScene,Mp._SceneComponentInitialization(this._scene),this._emitter=t,this.id=e,i.lensFlareSystems.push(this),this.meshesSelectionPredicate=e=>i.activeCamera&&e.material&&e.isVisible&&e.isEnabled()&&e.isBlocker&&!!(e.layerMask&i.activeCamera.layerMask);const s=i.getEngine(),r=[];r.push(1,1),r.push(-1,1),r.push(-1,-1),r.push(1,-1),this._vertexBuffers[hi.PositionKind]=new hi(s,r,hi.PositionKind,!1,!1,2),this._createIndexBuffer()}_createIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled=e}getScene(){return this._scene}getEmitter(){return this._emitter}setEmitter(e){this._emitter=e}getEmitterPosition(){return this._emitter.getAbsolutePosition?this._emitter.getAbsolutePosition():this._emitter.position}computeEffectivePosition(e){let t=this.getEmitterPosition();t=S.Project(t,y.Identity(),this._scene.getTransformMatrix(),e),this._positionX=t.x,this._positionY=t.y,t=S.TransformCoordinates(this.getEmitterPosition(),this._scene.getViewMatrix()),this.viewportBorder>0&&(e.x-=this.viewportBorder,e.y-=this.viewportBorder,e.width+=2*this.viewportBorder,e.height+=2*this.viewportBorder,t.x+=this.viewportBorder,t.y+=this.viewportBorder,this._positionX+=this.viewportBorder,this._positionY+=this.viewportBorder);const i=this._scene.useRightHandedSystem;return!!(t.z>0&&!i||t.z<0&&i)&&(this._positionX>e.x&&this._positionX<e.x+e.width&&this._positionY>e.y&&(this._positionY,e.y,e.height),!0)}_isVisible(){if(!this._isEnabled||!this._scene.activeCamera)return!1;const e=this.getEmitterPosition().subtract(this._scene.activeCamera.globalPosition),t=e.length();e.normalize();const i=new Fr(this._scene.activeCamera.globalPosition,e),s=this._scene.pickWithRay(i,this.meshesSelectionPredicate,!0);return!s||!s.hit||s.distance>t}render(){if(!this._scene.activeCamera)return!1;const e=this._scene.getEngine(),t=this._scene.activeCamera.viewport.toGlobal(e.getRenderWidth(!0),e.getRenderHeight(!0));if(!this.computeEffectivePosition(t))return!1;if(!this._isVisible())return!1;let i,s;i=this._positionX<this.borderLimit+t.x?this.borderLimit+t.x-this._positionX:this._positionX>t.x+t.width-this.borderLimit?this._positionX-t.x-t.width+this.borderLimit:0,s=this._positionY<this.borderLimit+t.y?this.borderLimit+t.y-this._positionY:this._positionY>t.y+t.height-this.borderLimit?this._positionY-t.y-t.height+this.borderLimit:0;let r=i>s?i:s;r-=this.viewportBorder,r>this.borderLimit&&(r=this.borderLimit);let n=1-l.Clamp(r/this.borderLimit,0,1);if(n<0)return!1;n>1&&(n=1),this.viewportBorder>0&&(t.x+=this.viewportBorder,t.y+=this.viewportBorder,t.width-=2*this.viewportBorder,t.height-=2*this.viewportBorder,this._positionX-=this.viewportBorder,this._positionY-=this.viewportBorder);const o=t.x+t.width/2,a=t.y+t.height/2,h=o-this._positionX,c=a-this._positionY;e.setState(!1),e.setDepthBuffer(!1);for(let i=0;i<this.lensFlares.length;i++){const s=this.lensFlares[i];if(!s._drawWrapper.effect.isReady()||s.texture&&!s.texture.isReady())continue;e.enableEffect(s._drawWrapper),e.bindBuffers(this._vertexBuffers,this._indexBuffer,s._drawWrapper.effect),e.setAlphaMode(s.alphaMode);const r=o-h*s.position,l=a-c*s.position,u=s.size,d=s.size*e.getAspectRatio(this._scene.activeCamera,!0),p=r/(t.width+2*t.x)*2-1,_=1-l/(t.height+2*t.y)*2,f=y.FromValues(u/2,0,0,0,0,d/2,0,0,0,0,1,0,p,_,0,1);s._drawWrapper.effect.setMatrix("viewportMatrix",f),s._drawWrapper.effect.setTexture("textureSampler",s.texture),s._drawWrapper.effect.setFloat4("color",s.color.r*n,s.color.g*n,s.color.b*n,1),e.drawElementsType(sr.TriangleFillMode,0,6)}return e.setDepthBuffer(!0),e.setAlphaMode(0),!0}rebuild(){var e;this._createIndexBuffer();for(const t in this._vertexBuffers)null===(e=this._vertexBuffers[t])||void 0===e||e._rebuild()}dispose(){const e=this._vertexBuffers[hi.PositionKind];for(e&&(e.dispose(),this._vertexBuffers[hi.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this.lensFlares.length;)this.lensFlares[0].dispose();const t=this._scene.lensFlareSystems.indexOf(this);this._scene.lensFlareSystems.splice(t,1)}static Parse(e,t,i){const s=t.getLastEntryById(e.emitterId),r=e.name||"lensFlareSystem#"+e.emitterId,n=new Mp(r,s,t);n.id=e.id||r,n.borderLimit=e.borderLimit;for(let t=0;t<e.flares.length;t++){const s=e.flares[t];Pp.AddFlare(s.size,s.position,N.FromArray(s.color),s.textureName?i+s.textureName:"",n)}return n}serialize(){const e={};e.id=this.id,e.name=this.name,e.emitterId=this.getEmitter().id,e.borderLimit=this.borderLimit,e.flares=[];for(let t=0;t<this.lensFlares.length;t++){const i=this.lensFlares[t];e.flares.push({size:i.size,position:i.position,color:i.color.asArray(),textureName:Ht.GetFilename(i.texture?i.texture.name:"")})}return e}}Mp._SceneComponentInitialization=e=>{throw $("LensFlareSystemSceneComponent")},s.AddParser(fi.NAME_LENSFLARESYSTEM,((e,t,i,s)=>{if(void 0!==e.lensFlareSystems&&null!==e.lensFlareSystems){i.lensFlareSystems||(i.lensFlareSystems=[]);for(let r=0,n=e.lensFlareSystems.length;r<n;r++){const n=e.lensFlareSystems[r],o=Mp.Parse(n,t,s);i.lensFlareSystems.push(o)}}})),s.prototype.getLensFlareSystemByName=function(e){for(let t=0;t<this.lensFlareSystems.length;t++)if(this.lensFlareSystems[t].name===e)return this.lensFlareSystems[t];return null},s.prototype.getLensFlareSystemById=function(e){for(let t=0;t<this.lensFlareSystems.length;t++)if(this.lensFlareSystems[t].id===e)return this.lensFlareSystems[t];return null},s.prototype.getLensFlareSystemByID=function(e){return this.getLensFlareSystemById(e)},s.prototype.removeLensFlareSystem=function(e){const t=this.lensFlareSystems.indexOf(e);return-1!==t&&this.lensFlareSystems.splice(t,1),t},s.prototype.addLensFlareSystem=function(e){this.lensFlareSystems.push(e)};class Op{constructor(e){this.name=fi.NAME_LENSFLARESYSTEM,this.scene=e,e.lensFlareSystems=[]}register(){this.scene._afterCameraDrawStage.registerStep(fi.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM,this,this._draw)}rebuild(){for(let e=0;e<this.scene.lensFlareSystems.length;e++)this.scene.lensFlareSystems[e].rebuild()}addFromContainer(e){e.lensFlareSystems&&e.lensFlareSystems.forEach((e=>{this.scene.addLensFlareSystem(e)}))}removeFromContainer(e,t){e.lensFlareSystems&&e.lensFlareSystems.forEach((e=>{this.scene.removeLensFlareSystem(e),t&&e.dispose()}))}serialize(e){e.lensFlareSystems=[];const t=this.scene.lensFlareSystems;for(const i of t)e.lensFlareSystems.push(i.serialize())}dispose(){const e=this.scene.lensFlareSystems;for(;e.length;)e[0].dispose()}_draw(e){if(this.scene.lensFlaresEnabled){const t=this.scene.lensFlareSystems;Ht.StartPerformanceCounter("Lens flares",t.length>0);for(const i of t)e.layerMask&i.layerMask&&i.render();Ht.EndPerformanceCounter("Lens flares",t.length>0)}}}Mp._SceneComponentInitialization=e=>{let t=e._getComponent(fi.NAME_LENSFLARESYSTEM);t||(t=new Op(e),e._addComponent(t))};nt.IncludesShadersStore.bayerDitherFunctions="float bayerDither2(vec2 _P) {return mod(2.0*_P.y+_P.x+1.0,4.0);}\nfloat bayerDither4(vec2 _P) {vec2 P1=mod(_P,2.0); \nvec2 P2=floor(0.5*mod(_P,4.0)); \nreturn 4.0*bayerDither2(P1)+bayerDither2(P2);}\nfloat bayerDither8(vec2 _P) {vec2 P1=mod(_P,2.0); \nvec2 P2=floor(0.5 *mod(_P,4.0)); \nvec2 P4=floor(0.25*mod(_P,8.0)); \nreturn 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);}\n";nt.IncludesShadersStore.shadowMapFragmentExtraDeclaration="#if SM_FLOAT==0\n#include<packingFunctions>\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#include<bayerDitherFunctions>\nuniform float softTransparentShadowSM;\n#endif\nvarying float vDepthMetricSM;\n#if SM_USEDISTANCE==1\nuniform vec3 lightDataSM;varying vec3 vPositionWSM;\n#endif\nuniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying float zSM;\n#endif\n";nt.IncludesShadersStore.shadowMapFragment="float depthSM=vDepthMetricSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\n#if SM_USEDISTANCE==1\ndepthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\ndepthSM=(-zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\ndepthSM=(zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\ngl_FragDepth=clamp(1.0-depthSM,0.0,1.0);\n#else\ngl_FragDepth=clamp(depthSM,0.0,1.0); \n#endif\n#elif SM_USEDISTANCE==1\ndepthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#if SM_ESM==1\ndepthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);\n#endif\n#if SM_FLOAT==1\ngl_FragColor=vec4(depthSM,1.0,1.0,1.0);\n#else\ngl_FragColor=pack(depthSM);\n#endif\nreturn;";nt.ShadersStore.shadowMapPixelShader="#include<shadowMapFragmentExtraDeclaration>\n#ifdef ALPHATEXTURE\nvarying vec2 vUV;uniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\n#ifdef ALPHATEXTURE\nfloat alphaFromAlphaTexture=texture2D(diffuseSampler,vUV).a;\n#ifdef ALPHATESTVALUE\nif (alphaFromAlphaTexture<ALPHATESTVALUE)\ndiscard;\n#endif\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#ifdef ALPHATEXTURE\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alphaFromAlphaTexture) discard;\n#else\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM) discard;\n#endif\n#endif\n#include<shadowMapFragment>\n}";nt.IncludesShadersStore.sceneVertexDeclaration="uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\nuniform mat4 view;uniform mat4 projection;uniform vec4 vEyePosition;\n";nt.IncludesShadersStore.meshVertexDeclaration="uniform mat4 world;uniform float visibility;\n";nt.IncludesShadersStore.shadowMapVertexDeclaration="#include<sceneVertexDeclaration>\n#include<meshVertexDeclaration>\n";nt.IncludesShadersStore.shadowMapUboDeclaration="layout(std140,column_major) uniform;\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";nt.IncludesShadersStore.shadowMapVertexExtraDeclaration="#if SM_NORMALBIAS==1\nuniform vec3 lightDataSM;\n#endif\nuniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;varying float vDepthMetricSM;\n#if SM_USEDISTANCE==1\nvarying vec3 vPositionWSM;\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying float zSM;\n#endif\n";nt.IncludesShadersStore.shadowMapVertexNormalBias="#if SM_NORMALBIAS==1\n#if SM_DIRECTIONINLIGHTDATA==1\nvec3 worldLightDirSM=normalize(-lightDataSM.xyz);\n#else\nvec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;vec3 worldLightDirSM=normalize(directionToLightSM);\n#endif\nfloat ndlSM=dot(vNormalW,worldLightDirSM);float sinNLSM=sqrt(1.0-ndlSM*ndlSM);float normalBiasSM=biasAndScaleSM.y*sinNLSM;worldPos.xyz-=vNormalW*normalBiasSM;\n#endif\n";nt.IncludesShadersStore.shadowMapVertexMetric="#if SM_USEDISTANCE==1\nvPositionWSM=worldPos.xyz;\n#endif\n#if SM_DEPTHTEXTURE==1\n#ifdef IS_NDC_HALF_ZRANGE\n#define BIASFACTOR 0.5\n#else\n#define BIASFACTOR 1.0\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\ngl_Position.z-=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;\n#else\ngl_Position.z+=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;\n#endif\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nzSM=gl_Position.z;gl_Position.z=0.0;\n#elif SM_USEDISTANCE==0\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetricSM=(-gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\nvDepthMetricSM=(gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#endif\n";nt.ShadersStore.shadowMapVertexShader="attribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef INSTANCES\nattribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;\n#endif\n#include<helperFunctions>\n#include<__decl__shadowMapVertex>\n#ifdef ALPHATEXTURE\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#include<shadowMapVertexExtraDeclaration>\n#include<clipPlaneVertexDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef NORMAL\nmat3 normWorldSM=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvec3 vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormWorldSM=transposeMat3(inverseMat3(normWorldSM));\n#endif\nvec3 vNormalW=normalize(normWorldSM*normalUpdated);\n#endif\n#endif\n#include<shadowMapVertexNormalBias>\ngl_Position=viewProjection*worldPos;\n#include<shadowMapVertexMetric>\n#ifdef ALPHATEXTURE\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#include<clipPlaneVertex>\n}";nt.ShadersStore.depthBoxBlurPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 colorDepth=vec4(0.0);for (int x=-OFFSET; x<=OFFSET; x++)\nfor (int y=-OFFSET; y<=OFFSET; y++)\ncolorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);gl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));}";nt.IncludesShadersStore.shadowMapFragmentSoftTransparentShadow="#if SM_SOFTTRANSPARENTSHADOW==1\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alpha) discard;\n#endif\n";class Dp{get bias(){return this._bias}set bias(e){this._bias=e}get normalBias(){return this._normalBias}set normalBias(e){this._normalBias=e}get blurBoxOffset(){return this._blurBoxOffset}set blurBoxOffset(e){this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._disposeBlurPostProcesses())}get blurScale(){return this._blurScale}set blurScale(e){this._blurScale!==e&&(this._blurScale=e,this._disposeBlurPostProcesses())}get blurKernel(){return this._blurKernel}set blurKernel(e){this._blurKernel!==e&&(this._blurKernel=e,this._disposeBlurPostProcesses())}get useKernelBlur(){return this._useKernelBlur}set useKernelBlur(e){this._useKernelBlur!==e&&(this._useKernelBlur=e,this._disposeBlurPostProcesses())}get depthScale(){return void 0!==this._depthScale?this._depthScale:this._light.getDepthScale()}set depthScale(e){this._depthScale=e}_validateFilter(e){return e}get filter(){return this._filter}set filter(e){if(e=this._validateFilter(e),this._light.needCube()){if(e===Dp.FILTER_BLUREXPONENTIALSHADOWMAP)return void(this.useExponentialShadowMap=!0);if(e===Dp.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)return void(this.useCloseExponentialShadowMap=!0);if(e===Dp.FILTER_PCF||e===Dp.FILTER_PCSS)return void(this.usePoissonSampling=!0)}e!==Dp.FILTER_PCF&&e!==Dp.FILTER_PCSS||this._scene.getEngine()._features.supportShadowSamplers?this._filter!==e&&(this._filter=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty()):this.usePoissonSampling=!0}get usePoissonSampling(){return this.filter===Dp.FILTER_POISSONSAMPLING}set usePoissonSampling(e){const t=this._validateFilter(Dp.FILTER_POISSONSAMPLING);(e||this.filter===Dp.FILTER_POISSONSAMPLING)&&(this.filter=e?t:Dp.FILTER_NONE)}get useExponentialShadowMap(){return this.filter===Dp.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(e){const t=this._validateFilter(Dp.FILTER_EXPONENTIALSHADOWMAP);(e||this.filter===Dp.FILTER_EXPONENTIALSHADOWMAP)&&(this.filter=e?t:Dp.FILTER_NONE)}get useBlurExponentialShadowMap(){return this.filter===Dp.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(e){const t=this._validateFilter(Dp.FILTER_BLUREXPONENTIALSHADOWMAP);(e||this.filter===Dp.FILTER_BLUREXPONENTIALSHADOWMAP)&&(this.filter=e?t:Dp.FILTER_NONE)}get useCloseExponentialShadowMap(){return this.filter===Dp.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(e){const t=this._validateFilter(Dp.FILTER_CLOSEEXPONENTIALSHADOWMAP);(e||this.filter===Dp.FILTER_CLOSEEXPONENTIALSHADOWMAP)&&(this.filter=e?t:Dp.FILTER_NONE)}get useBlurCloseExponentialShadowMap(){return this.filter===Dp.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(e){const t=this._validateFilter(Dp.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);(e||this.filter===Dp.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)&&(this.filter=e?t:Dp.FILTER_NONE)}get usePercentageCloserFiltering(){return this.filter===Dp.FILTER_PCF}set usePercentageCloserFiltering(e){const t=this._validateFilter(Dp.FILTER_PCF);(e||this.filter===Dp.FILTER_PCF)&&(this.filter=e?t:Dp.FILTER_NONE)}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){this._filteringQuality!==e&&(this._filteringQuality=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get useContactHardeningShadow(){return this.filter===Dp.FILTER_PCSS}set useContactHardeningShadow(e){const t=this._validateFilter(Dp.FILTER_PCSS);(e||this.filter===Dp.FILTER_PCSS)&&(this.filter=e?t:Dp.FILTER_NONE)}get contactHardeningLightSizeUVRatio(){return this._contactHardeningLightSizeUVRatio}set contactHardeningLightSizeUVRatio(e){this._contactHardeningLightSizeUVRatio=e}get darkness(){return this._darkness}set darkness(e){this.setDarkness(e)}getDarkness(){return this._darkness}setDarkness(e){return this._darkness=e>=1?1:e<=0?0:e,this}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){this.setTransparencyShadow(e)}setTransparencyShadow(e){return this._transparencyShadow=e,this}getShadowMap(){return this._shadowMap}getShadowMapForRendering(){return this._shadowMap2?this._shadowMap2:this._shadowMap}getClassName(){return Dp.CLASSNAME}addShadowCaster(e,t=!0){if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),-1===this._shadowMap.renderList.indexOf(e)&&this._shadowMap.renderList.push(e),t)for(const t of e.getChildMeshes())-1===this._shadowMap.renderList.indexOf(t)&&this._shadowMap.renderList.push(t);return this}removeShadowCaster(e,t=!0){if(!this._shadowMap||!this._shadowMap.renderList)return this;const i=this._shadowMap.renderList.indexOf(e);if(-1!==i&&this._shadowMap.renderList.splice(i,1),t)for(const t of e.getChildren())this.removeShadowCaster(t);return this}getLight(){return this._light}_getCamera(){var e;return null!==(e=this._camera)&&void 0!==e?e:this._scene.activeCamera}get mapSize(){return this._mapSize}set mapSize(e){this._mapSize=e,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}constructor(e,t,i,s,r){this.onBeforeShadowMapRenderObservable=new a,this.onAfterShadowMapRenderObservable=new a,this.onBeforeShadowMapRenderMeshObservable=new a,this.onAfterShadowMapRenderMeshObservable=new a,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=Dp.FILTER_NONE,this._filteringQuality=Dp.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this.forceBackFacesOnly=!1,this._lightDirection=S.Zero(),this._viewMatrix=y.Zero(),this._projectionMatrix=y.Zero(),this._transformMatrix=y.Zero(),this._cachedPosition=new S(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new S(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=y.Identity(),this._mapSize=e,this._light=t,this._scene=t.getScene(),this._camera=null!=s?s:null,this._useRedTextureType=!!r;let n=t._shadowGenerators;n||(n=t._shadowGenerators=new Map),n.set(this._camera,this),this.id=t.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this._light.name}")`))),Dp._SceneComponentInitialization(this._scene);const o=this._scene.getEngine().getCaps();i?o.textureFloatRender&&o.textureFloatLinearFiltering?this._textureType=1:o.textureHalfFloatRender&&o.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:o.textureHalfFloatRender&&o.textureHalfFloatLinearFiltering?this._textureType=2:o.textureFloatRender&&o.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}_initializeGenerator(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()}_createTargetRenderTexture(){const e=this._scene.getEngine();e._features.supportDepthStencilTexture?(this._shadowMap=new Bn(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0)):this._shadowMap=new Bn(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube()),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(this._createTargetRenderTexture(),null===this._shadowMap)return;this._shadowMap.wrapU=Ar.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=Ar.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(Ar.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=(e,t,i,s)=>this._renderForShadowMap(e,t,i,s),this._shadowMap.customIsReadyFunction=()=>!0;const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add((()=>{var t;this._currentSceneUBO=this._scene.getSceneUniformBuffer(),null===(t=e._debugPushGroup)||void 0===t||t.call(e,`shadow map generation for pass id ${e.currentRenderPassId}`,1)})),this._shadowMap.onBeforeRenderObservable.add((t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[0]),this._currentFaceIndex=t,this._filter===Dp.FILTER_PCF&&e.setColorWrite(!1),this.getTransformMatrix(),this._scene.setTransformMatrix(this._viewMatrix,this._projectionMatrix),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())})),this._shadowMap.onAfterUnbindObservable.add((()=>{var t,i;if(this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),this._scene.updateTransformMatrix(),this._filter===Dp.FILTER_PCF&&e.setColorWrite(!0),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap)return void(null===(t=e._debugPopGroup)||void 0===t||t.call(e,1));const s=this.getShadowMapForRendering();s&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,s.renderTarget,!0),e.unBindFramebuffer(s.renderTarget,!0),null===(i=e._debugPopGroup)||void 0===i||i.call(e,1))}));const t=new F(0,0,0,0),i=new F(1,1,1,1);this._shadowMap.onClearObservable.add((e=>{this._filter===Dp.FILTER_PCF?e.clear(i,!1,!0,!1):this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e.clear(t,!0,!0,!1):e.clear(i,!0,!0,!1)})),this._shadowMap.onResizeObservable.add((e=>{this._storedUniqueId=this._shadowMap.uniqueId,this._mapSize=e.getRenderSize(),this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}));for(let e=_i.MIN_RENDERINGGROUPS;e<_i.MAX_RENDERINGGROUPS;e++)this._shadowMap.setRenderingAutoClearDepthStencil(e,!1)}_initializeBlurRTTAndPostProcesses(){const e=this._scene.getEngine(),t=this._mapSize/this.blurScale;this.useKernelBlur&&1===this.blurScale||(this._shadowMap2=new Bn(this._light.name+"_shadowMap2",t,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=Ar.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=Ar.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(Ar.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new hd(this._light.name+"KernelBlurX",new E(1,0),this.blurKernel,1,null,Ar.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.width=t,this._kernelBlurXPostprocess.height=t,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._shadowMap)})),this._kernelBlurYPostprocess=new hd(this._light.name+"KernelBlurY",new E(0,1),this.blurKernel,1,null,Ar.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,0===this._textureType&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new dn(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,Ar.BILINEAR_SAMPLINGMODE,e,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add((e=>{e.setFloat2("screenSize",t,t),e.setTexture("textureSampler",this._shadowMap)})),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])}_renderForShadowMap(e,t,i,s){let r;if(s.length)for(r=0;r<s.length;r++)this._renderSubMeshForShadowMap(s.data[r]);for(r=0;r<e.length;r++)this._renderSubMeshForShadowMap(e.data[r]);for(r=0;r<t.length;r++)this._renderSubMeshForShadowMap(t.data[r]);if(this._transparencyShadow)for(r=0;r<i.length;r++)this._renderSubMeshForShadowMap(i.data[r],!0);else for(r=0;r<i.length;r++)i.data[r].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}_bindCustomEffectForRenderSubMeshForShadowMap(e,t,i){t.setMatrix("viewProjection",this.getTransformMatrix())}_renderSubMeshForShadowMap(e,t=!1){var i,s;const r=e.getRenderingMesh(),n=e.getEffectiveMesh(),o=this._scene,a=o.getEngine(),l=e.getMaterial();if(n._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!l||0===e.verticesCount||e._renderId===o.getRenderId())return;const h=n._getWorldMatrixDeterminant()<0;let c=null!==(i=r.overrideMaterialSideOrientation)&&void 0!==i?i:l.sideOrientation;h&&(c=0===c?1:0);const u=0===c;a.setState(l.backFaceCulling,void 0,void 0,u,l.cullBackFaces);const d=r._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(d.mustReturn)return;const p=a.getCaps().instancedArrays&&(null!==d.visibleInstances[e._id]&&void 0!==d.visibleInstances[e._id]||r.hasThinInstances);if(!this.customAllowRendering||this.customAllowRendering(e))if(this.isReady(e,p,t)){e._renderId=o.getRenderId();const i=l.shadowDepthWrapper,h=null!==(s=null==i?void 0:i.getEffect(e,this,a.currentRenderPassId))&&void 0!==s?s:e._getDrawWrapper(),c=Tt.GetEffect(h);a.enableEffect(h),p||r._bind(e,c,l.fillMode),this.getTransformMatrix(),c.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===pr.LIGHTTYPEID_DIRECTIONALLIGHT?c.setVector3("lightDataSM",this._cachedDirection):c.setVector3("lightDataSM",this._cachedPosition);const u=this._getCamera();if(u&&c.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(u),this.getLight().getDepthMinZ(u)+this.getLight().getDepthMaxZ(u)),t&&this.enableSoftTransparentShadow&&c.setFloat("softTransparentShadowSM",n.visibility*l.alpha),i)e._setMainDrawWrapperOverride(h),i.standalone?i.baseMaterial.bindForSubMesh(n.getWorldMatrix(),r,e):l.bindForSubMesh(n.getWorldMatrix(),r,e),e._setMainDrawWrapperOverride(null);else{if(this._opacityTexture&&(c.setTexture("diffuseSampler",this._opacityTexture),c.setMatrix("diffuseMatrix",this._opacityTexture.getTextureMatrix()||this._defaultTextureMatrix)),r.useBones&&r.computeBonesUsingShaders&&r.skeleton){const e=r.skeleton;if(e.isUsingTextureForMatrices){const t=e.getTransformMatrixTexture(r);if(!t)return;c.setTexture("boneSampler",t),c.setFloat("boneTextureWidth",4*(e.bones.length+1))}else c.setMatrices("mBones",e.getTransformMatrices(r))}Hs.BindMorphTargetParameters(r,c),r.morphTargetManager&&r.morphTargetManager.isUsingTextureForTargets&&r.morphTargetManager._bind(c),zs(c,l,o)}this._useUBO||i||this._bindCustomEffectForRenderSubMeshForShadowMap(e,c,n),Hs.BindSceneUniformBuffer(c,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();const _=n.getWorldMatrix();p&&(n.getMeshUniformBuffer().bindToEffect(c,"Mesh"),n.transferToEffect(_)),this.forceBackFacesOnly&&a.setState(!0,0,!1,!0,l.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(r),this.onBeforeShadowMapRenderObservable.notifyObservers(c),r._processRendering(n,e,c,l.fillMode,d,p,((e,t)=>{n===r||e?(n.getMeshUniformBuffer().bindToEffect(c,"Mesh"),n.transferToEffect(e?t:_)):(r.getMeshUniformBuffer().bindToEffect(c,"Mesh"),r.transferToEffect(t))})),this.forceBackFacesOnly&&a.setState(!0,0,!1,!1,l.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(c),this.onAfterShadowMapRenderMeshObservable.notifyObservers(r)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}_applyFilterValues(){this._shadowMap&&(this.filter===Dp.FILTER_NONE||this.filter===Dp.FILTER_PCSS?this._shadowMap.updateSamplingMode(Ar.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(Ar.BILINEAR_SAMPLINGMODE))}forceCompilation(e,t){const i=Object.assign({useInstances:!1},t),s=this.getShadowMap();if(!s)return void(e&&e(this));const r=s.renderList;if(!r)return void(e&&e(this));const n=[];for(const e of r)n.push(...e.subMeshes);if(0===n.length)return void(e&&e(this));let o=0;const a=()=>{var t,s;if(this._scene&&this._scene.getEngine()){for(;this.isReady(n[o],i.useInstances,null!==(s=null===(t=n[o].getMaterial())||void 0===t?void 0:t.needAlphaBlendingForMesh(n[o].getMesh()))&&void 0!==s&&s);)if(o++,o>=n.length)return void(e&&e(this));setTimeout(a,16)}};a()}forceCompilationAsync(e){return new Promise((t=>{this.forceCompilation((()=>{t()}),e)}))}_isReadyCustomDefines(e,t,i){}_prepareShadowDefines(e,t,i,s){i.push("#define SM_LIGHTTYPE_"+this._light.getClassName().toUpperCase()),i.push("#define SM_FLOAT "+(0!==this._textureType?"1":"0")),i.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),i.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));const r=e.getMesh();return i.push("#define SM_NORMALBIAS "+(this.normalBias&&r.isVerticesDataPresent(hi.NormalKind)?"1":"0")),i.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===pr.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),i.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),i.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&s?"1":"0")),this._isReadyCustomDefines(i,e,t),i}isReady(e,t,i){var s;const r=e.getMaterial(),n=null==r?void 0:r.shadowDepthWrapper;if(this._opacityTexture=null,!r)return!1;const o=[];if(this._prepareShadowDefines(e,t,o,i),n){if(!n.isReadyForSubMesh(e,o,this,t,this._scene.getEngine().currentRenderPassId))return!1}else{const i=e._getDrawWrapper(void 0,!0);let n=i.effect,a=i.defines;const l=[hi.PositionKind],h=e.getMesh();this.normalBias&&h.isVerticesDataPresent(hi.NormalKind)&&(l.push(hi.NormalKind),o.push("#define NORMAL"),h.nonUniformScaling&&o.push("#define NONUNIFORMSCALING"));const c=r.needAlphaTesting();if((c||r.needAlphaBlending())&&(this.useOpacityTextureForTransparentShadow?this._opacityTexture=r.opacityTexture:this._opacityTexture=r.getAlphaTestTexture(),this._opacityTexture)){if(!this._opacityTexture.isReady())return!1;const e=null!==(s=r.alphaCutOff)&&void 0!==s?s:Dp.DEFAULT_ALPHA_CUTOFF;o.push("#define ALPHATEXTURE"),c&&o.push(`#define ALPHATESTVALUE ${e}${e%1==0?".":""}`),h.isVerticesDataPresent(hi.UVKind)&&(l.push(hi.UVKind),o.push("#define UV1")),h.isVerticesDataPresent(hi.UV2Kind)&&1===this._opacityTexture.coordinatesIndex&&(l.push(hi.UV2Kind),o.push("#define UV2"))}const u=new hn;if(h.useBones&&h.computeBonesUsingShaders&&h.skeleton){l.push(hi.MatricesIndicesKind),l.push(hi.MatricesWeightsKind),h.numBoneInfluencers>4&&(l.push(hi.MatricesIndicesExtraKind),l.push(hi.MatricesWeightsExtraKind));const e=h.skeleton;o.push("#define NUM_BONE_INFLUENCERS "+h.numBoneInfluencers),h.numBoneInfluencers>0&&u.addCPUSkinningFallback(0,h),e.isUsingTextureForMatrices?o.push("#define BONETEXTURE"):o.push("#define BonesPerMesh "+(e.bones.length+1))}else o.push("#define NUM_BONE_INFLUENCERS 0");const d=h.morphTargetManager;let p=0;if(d&&d.numInfluencers>0&&(o.push("#define MORPHTARGETS"),p=d.numInfluencers,o.push("#define NUM_MORPH_INFLUENCERS "+p),d.isUsingTextureForTargets&&o.push("#define MORPHTARGETS_TEXTURE"),Hs.PrepareAttributesForMorphTargetsInfluencers(l,h,p)),Gs(r,this._scene,o),t&&(o.push("#define INSTANCES"),Hs.PushAttributesForInstances(l),e.getRenderingMesh().hasThinInstances&&o.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(const e of this.customShaderOptions.defines)-1===o.indexOf(e)&&o.push(e);const _=o.join("\n");if(a!==_){a=_;let e="shadowMap";const t=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices"],s=["diffuseSampler","boneSampler","morphTargets"],r=["Scene","Mesh"];if(ks(t),this.customShaderOptions){if(e=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(const e of this.customShaderOptions.attributes)-1===l.indexOf(e)&&l.push(e);if(this.customShaderOptions.uniforms)for(const e of this.customShaderOptions.uniforms)-1===t.indexOf(e)&&t.push(e);if(this.customShaderOptions.samplers)for(const e of this.customShaderOptions.samplers)-1===s.indexOf(e)&&s.push(e)}const o=this._scene.getEngine();n=o.createEffect(e,{attributes:l,uniformsNames:t,uniformBuffersNames:r,samplers:s,defines:_,fallbacks:u,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:p}},o),i.setEffect(n,a)}if(!n.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(this._blurPostProcesses&&this._blurPostProcesses.length||this._initializeBlurRTTAndPostProcesses()),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady())}prepareDefines(e,t){const i=this._scene,s=this._light;i.shadowsEnabled&&s.shadowEnabled&&(e["SHADOW"+t]=!0,this.useContactHardeningShadow?(e["SHADOWPCSS"+t]=!0,this._filteringQuality===Dp.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===Dp.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePercentageCloserFiltering?(e["SHADOWPCF"+t]=!0,this._filteringQuality===Dp.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===Dp.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePoissonSampling?e["SHADOWPOISSON"+t]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e["SHADOWESM"+t]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(e["SHADOWCLOSEESM"+t]=!0),s.needCube()&&(e["SHADOWCUBE"+t]=!0))}bindShadowLight(e,t){const i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;const s=this._getCamera();if(!s)return;const r=this.getShadowMap();r&&(i.needCube()||t.setMatrix("lightMatrix"+e,this.getTransformMatrix()),this._filter===Dp.FILTER_PCF?(t.setDepthStencilTexture("shadowSampler"+e,this.getShadowMapForRendering()),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),r.getSize().width,1/r.getSize().width,this.frustumEdgeFalloff,e)):this._filter===Dp.FILTER_PCSS?(t.setDepthStencilTexture("shadowSampler"+e,this.getShadowMapForRendering()),t.setTexture("depthSampler"+e,this.getShadowMapForRendering()),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/r.getSize().width,this._contactHardeningLightSizeUVRatio*r.getSize().width,this.frustumEdgeFalloff,e)):(t.setTexture("shadowSampler"+e,this.getShadowMapForRendering()),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/r.getSize().width,this.depthScale,this.frustumEdgeFalloff,e)),i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(s),this.getLight().getDepthMinZ(s)+this.getLight().getDepthMaxZ(s),e))}get viewMatrix(){return this._viewMatrix}get projectionMatrix(){return this._projectionMatrix}getTransformMatrix(){const e=this._scene;if(this._currentRenderId===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;let t=this._light.position;if(this._light.computeTransformedInformation()&&(t=this._light.transformedPosition),S.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),1===Math.abs(S.Dot(this._lightDirection,S.Up()))&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!t.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(t),this._cachedDirection.copyFrom(this._lightDirection),y.LookAtLHToRef(t,t.add(this._lightDirection),S.Up(),this._viewMatrix);const e=this.getShadowMap();if(e){const t=e.renderList;t&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,t)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix}recreateShadowMap(){const e=this._shadowMap;if(!e)return;const t=e.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),t){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(const e of t)this._shadowMap.renderList.push(e)}else this._shadowMap.renderList=null}_disposeBlurPostProcesses(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]}_disposeRTTandPostProcesses(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()}_disposeSceneUBOs(){if(this._sceneUBOs){for(const e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}dispose(){if(this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light){if(this._light._shadowGenerators){const e=this._light._shadowGenerators.entries();for(let t=e.next();!0!==t.done;t=e.next()){const[e,i]=t.value;i===this&&this._light._shadowGenerators.delete(e)}0===this._light._shadowGenerators.size&&(this._light._shadowGenerators=null)}this._light._markMeshesAsLightDirty()}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}serialize(){var e;const t={},i=this.getShadowMap();if(!i)return t;if(t.className=this.getClassName(),t.lightId=this._light.id,t.cameraId=null===(e=this._camera)||void 0===e?void 0:e.id,t.id=this.id,t.mapSize=i.getRenderSize(),t.forceBackFacesOnly=this.forceBackFacesOnly,t.darkness=this.getDarkness(),t.transparencyShadow=this._transparencyShadow,t.frustumEdgeFalloff=this.frustumEdgeFalloff,t.bias=this.bias,t.normalBias=this.normalBias,t.usePercentageCloserFiltering=this.usePercentageCloserFiltering,t.useContactHardeningShadow=this.useContactHardeningShadow,t.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,t.filteringQuality=this.filteringQuality,t.useExponentialShadowMap=this.useExponentialShadowMap,t.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,t.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,t.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,t.usePoissonSampling=this.usePoissonSampling,t.depthScale=this.depthScale,t.blurBoxOffset=this.blurBoxOffset,t.blurKernel=this.blurKernel,t.blurScale=this.blurScale,t.useKernelBlur=this.useKernelBlur,t.renderList=[],i.renderList)for(let e=0;e<i.renderList.length;e++){const s=i.renderList[e];t.renderList.push(s.id)}return t}static Parse(e,t,i){const s=t.getLightById(e.lightId),r=void 0!==e.cameraId?t.getCameraById(e.cameraId):null,n=i?i(e.mapSize,s,r):new Dp(e.mapSize,s,void 0,r),o=n.getShadowMap();for(let i=0;i<e.renderList.length;i++)t.getMeshesById(e.renderList[i]).forEach((function(e){o&&(o.renderList||(o.renderList=[]),o.renderList.push(e))}));return void 0!==e.id&&(n.id=e.id),n.forceBackFacesOnly=!!e.forceBackFacesOnly,void 0!==e.darkness&&n.setDarkness(e.darkness),e.transparencyShadow&&n.setTransparencyShadow(!0),void 0!==e.frustumEdgeFalloff&&(n.frustumEdgeFalloff=e.frustumEdgeFalloff),void 0!==e.bias&&(n.bias=e.bias),void 0!==e.normalBias&&(n.normalBias=e.normalBias),e.usePercentageCloserFiltering?n.usePercentageCloserFiltering=!0:e.useContactHardeningShadow?n.useContactHardeningShadow=!0:e.usePoissonSampling?n.usePoissonSampling=!0:e.useExponentialShadowMap?n.useExponentialShadowMap=!0:e.useBlurExponentialShadowMap?n.useBlurExponentialShadowMap=!0:e.useCloseExponentialShadowMap?n.useCloseExponentialShadowMap=!0:e.useBlurCloseExponentialShadowMap?n.useBlurCloseExponentialShadowMap=!0:e.useVarianceShadowMap?n.useExponentialShadowMap=!0:e.useBlurVarianceShadowMap&&(n.useBlurExponentialShadowMap=!0),void 0!==e.contactHardeningLightSizeUVRatio&&(n.contactHardeningLightSizeUVRatio=e.contactHardeningLightSizeUVRatio),void 0!==e.filteringQuality&&(n.filteringQuality=e.filteringQuality),e.depthScale&&(n.depthScale=e.depthScale),e.blurScale&&(n.blurScale=e.blurScale),e.blurBoxOffset&&(n.blurBoxOffset=e.blurBoxOffset),e.useKernelBlur&&(n.useKernelBlur=e.useKernelBlur),e.blurKernel&&(n.blurKernel=e.blurKernel),n}}Dp.CLASSNAME="ShadowGenerator",Dp.FILTER_NONE=0,Dp.FILTER_EXPONENTIALSHADOWMAP=1,Dp.FILTER_POISSONSAMPLING=2,Dp.FILTER_BLUREXPONENTIALSHADOWMAP=3,Dp.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,Dp.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,Dp.FILTER_PCF=6,Dp.FILTER_PCSS=7,Dp.QUALITY_HIGH=0,Dp.QUALITY_MEDIUM=1,Dp.QUALITY_LOW=2,Dp.DEFAULT_ALPHA_CUTOFF=.5,Dp._SceneComponentInitialization=e=>{throw $("ShadowGeneratorSceneComponent")};nt.ShadersStore.depthPixelShader="#ifdef ALPHATEST\nvarying vec2 vUV;uniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\nvarying float vDepthMetric;\n#ifdef PACKED\n#include<packingFunctions>\n#endif\n#ifdef STORE_CAMERASPACE_Z\nvarying vec4 vViewPos;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#ifdef STORE_CAMERASPACE_Z\n#ifdef PACKED\ngl_FragColor=pack(vViewPos.z);\n#else\ngl_FragColor=vec4(vViewPos.z,0.0,0.0,1.0);\n#endif\n#else\n#ifdef NONLINEARDEPTH\n#ifdef PACKED\ngl_FragColor=pack(gl_FragCoord.z);\n#else\ngl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);\n#endif\n#else\n#ifdef PACKED\ngl_FragColor=pack(vDepthMetric);\n#else\ngl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);\n#endif\n#endif\n#endif\n}";nt.IncludesShadersStore.pointCloudVertexDeclaration="#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n";nt.ShadersStore.depthVertexShader="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;uniform vec2 depthValues;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#ifdef STORE_CAMERASPACE_Z\nuniform mat4 view;varying vec4 vViewPos;\n#endif\n#include<pointCloudVertexDeclaration>\nvarying float vDepthMetric;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#include<clipPlaneVertex>\ngl_Position=viewProjection*worldPos;\n#ifdef STORE_CAMERASPACE_Z\nvViewPos=view*worldPos;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric=((-gl_Position.z+depthValues.x)/(depthValues.y));\n#else\nvDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));\n#endif\n#endif\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#include<pointCloudVertex>\n}\n";class Np{setMaterialForRendering(e,t){this._depthMap.setMaterialForRendering(e,t)}constructor(e,t=1,i=null,s=!1,r=Ar.TRILINEAR_SAMPLINGMODE,n=!1,o){this.enabled=!0,this.forceDepthWriteTransparentMeshes=!1,this.useOnlyInActiveCamera=!1,this.reverseCulling=!1,this._scene=e,this._storeNonLinearDepth=s,this._storeCameraSpaceZ=n,this.isPacked=0===t,this.isPacked?this.clearColor=new F(1,1,1,1):this.clearColor=new F(n?1e8:1,0,0,1),Np._SceneComponentInitialization(this._scene);const a=e.getEngine();this._camera=i,r!==Ar.NEAREST_SAMPLINGMODE&&(1!==t||a._caps.textureFloatLinearFiltering||(r=Ar.NEAREST_SAMPLINGMODE),2!==t||a._caps.textureHalfFloatLinearFiltering||(r=Ar.NEAREST_SAMPLINGMODE));const l=this.isPacked||!a._features.supportExtendedTextureFormats?5:6;this._depthMap=new Bn(null!=o?o:"DepthRenderer",{width:a.getRenderWidth(),height:a.getRenderHeight()},this._scene,!1,!0,t,!1,r,void 0,void 0,void 0,l),this._depthMap.wrapU=Ar.CLAMP_ADDRESSMODE,this._depthMap.wrapV=Ar.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.noPrePassRenderer=!0,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add((e=>{e.clear(this.clearColor,!0,!0,!0)})),this._depthMap.onBeforeBindObservable.add((()=>{var e;null===(e=a._debugPushGroup)||void 0===e||e.call(a,"depth renderer",1)})),this._depthMap.onAfterUnbindObservable.add((()=>{var e;null===(e=a._debugPopGroup)||void 0===e||e.call(a,1)})),this._depthMap.customIsReadyFunction=(e,t,i)=>{if((i||0===t)&&e.subMeshes)for(let t=0;t<e.subMeshes.length;++t){const i=e.subMeshes[t],s=i.getRenderingMesh(),r=s._getInstancesRenderList(i._id,!!i.getReplacementMesh()),n=a.getCaps().instancedArrays&&(null!==r.visibleInstances[i._id]&&void 0!==r.visibleInstances[i._id]||s.hasThinInstances);if(!this.isReady(i,n))return!1}return!0};const h=e=>{var t,i;const s=e.getRenderingMesh(),r=e.getEffectiveMesh(),n=this._scene,o=n.getEngine(),a=e.getMaterial();if(r._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!a||r.infiniteDistance||a.disableDepthWrite||0===e.verticesCount||e._renderId===n.getRenderId())return;const l=r._getWorldMatrixDeterminant()<0;let h=null!==(t=s.overrideMaterialSideOrientation)&&void 0!==t?t:a.sideOrientation;l&&(h=0===h?1:0);const c=0===h;o.setState(a.backFaceCulling,0,!1,c,this.reverseCulling?!a.cullBackFaces:a.cullBackFaces);const u=s._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(u.mustReturn)return;const d=o.getCaps().instancedArrays&&(null!==u.visibleInstances[e._id]&&void 0!==u.visibleInstances[e._id]||s.hasThinInstances),p=this._camera||n.activeCamera;if(this.isReady(e,d)&&p){e._renderId=n.getRenderId();const t=null===(i=r._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===i?void 0:i[o.currentRenderPassId];let l=e._getDrawWrapper();!l&&t&&(l=t._getDrawWrapper());const h=p.mode===ps.ORTHOGRAPHIC_CAMERA;if(!l)return;const c=l.effect;let _,f;if(o.enableEffect(l),d||s._bind(e,c,a.fillMode),t?t.bindForSubMesh(r.getWorldMatrix(),r,e):(c.setMatrix("viewProjection",n.getTransformMatrix()),c.setMatrix("world",r.getWorldMatrix()),this._storeCameraSpaceZ&&c.setMatrix("view",n.getViewMatrix())),h?(_=!o.useReverseDepthBuffer&&o.isNDCHalfZRange?0:1,f=o.useReverseDepthBuffer&&o.isNDCHalfZRange?0:1):(_=o.useReverseDepthBuffer&&o.isNDCHalfZRange?p.minZ:o.isNDCHalfZRange?0:p.minZ,f=o.useReverseDepthBuffer&&o.isNDCHalfZRange?0:p.maxZ),c.setFloat2("depthValues",_,_+f),!t){if(a.needAlphaTesting()){const e=a.getAlphaTestTexture();e&&(c.setTexture("diffuseSampler",e),c.setMatrix("diffuseMatrix",e.getTextureMatrix()))}if(s.useBones&&s.computeBonesUsingShaders&&s.skeleton){const e=s.skeleton;if(e.isUsingTextureForMatrices){const t=e.getTransformMatrixTexture(s);if(!t)return;c.setTexture("boneSampler",t),c.setFloat("boneTextureWidth",4*(e.bones.length+1))}else c.setMatrices("mBones",e.getTransformMatrices(s))}zs(c,a,n),Hs.BindMorphTargetParameters(s,c),s.morphTargetManager&&s.morphTargetManager.isUsingTextureForTargets&&s.morphTargetManager._bind(c),a.pointsCloud&&c.setFloat("pointSize",a.pointSize)}s._processRendering(r,e,c,a.fillMode,u,d,((e,t)=>c.setMatrix("world",t)))}};this._depthMap.customRenderFunction=(e,t,i,s)=>{let r;if(s.length)for(r=0;r<s.length;r++)h(s.data[r]);for(r=0;r<e.length;r++)h(e.data[r]);for(r=0;r<t.length;r++)h(t.data[r]);if(this.forceDepthWriteTransparentMeshes)for(r=0;r<i.length;r++)h(i.data[r]);else for(r=0;r<i.length;r++)i.data[r].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}}isReady(e,t){var i;const s=this._scene.getEngine(),r=e.getMesh(),n=r.getScene(),o=null===(i=r._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===i?void 0:i[s.currentRenderPassId];if(o)return o.isReadyForSubMesh(r,e,t);const a=e.getMaterial();if(!a||a.disableDepthWrite)return!1;const l=[],h=[hi.PositionKind];if(a&&a.needAlphaTesting()&&a.getAlphaTestTexture()&&(l.push("#define ALPHATEST"),r.isVerticesDataPresent(hi.UVKind)&&(h.push(hi.UVKind),l.push("#define UV1")),r.isVerticesDataPresent(hi.UV2Kind)&&(h.push(hi.UV2Kind),l.push("#define UV2"))),r.useBones&&r.computeBonesUsingShaders){h.push(hi.MatricesIndicesKind),h.push(hi.MatricesWeightsKind),r.numBoneInfluencers>4&&(h.push(hi.MatricesIndicesExtraKind),h.push(hi.MatricesWeightsExtraKind)),l.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers),l.push("#define BonesPerMesh "+(r.skeleton?r.skeleton.bones.length+1:0));const t=e.getRenderingMesh().skeleton;(null==t?void 0:t.isUsingTextureForMatrices)&&l.push("#define BONETEXTURE")}else l.push("#define NUM_BONE_INFLUENCERS 0");const c=r.morphTargetManager;let u=0;c&&c.numInfluencers>0&&(u=c.numInfluencers,l.push("#define MORPHTARGETS"),l.push("#define NUM_MORPH_INFLUENCERS "+u),c.isUsingTextureForTargets&&l.push("#define MORPHTARGETS_TEXTURE"),Hs.PrepareAttributesForMorphTargetsInfluencers(h,r,u)),a.pointsCloud&&l.push("#define POINTSIZE"),t&&(l.push("#define INSTANCES"),Hs.PushAttributesForInstances(h),e.getRenderingMesh().hasThinInstances&&l.push("#define THIN_INSTANCES")),this._storeNonLinearDepth&&l.push("#define NONLINEARDEPTH"),this._storeCameraSpaceZ&&l.push("#define STORE_CAMERASPACE_Z"),this.isPacked&&l.push("#define PACKED"),Gs(a,n,l);const d=e._getDrawWrapper(void 0,!0),p=d.defines,_=l.join("\n");if(p!==_){const e=["world","mBones","boneTextureWidth","pointSize","viewProjection","view","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"];ks(e),d.setEffect(s.createEffect("depth",h,e,["diffuseSampler","morphTargets","boneSampler"],_,void 0,void 0,void 0,{maxSimultaneousMorphTargets:u}),_)}return d.effect.isReady()}getDepthMap(){return this._depthMap}dispose(){const e=[];for(const t in this._scene._depthRenderer)this._scene._depthRenderer[t]===this&&e.push(t);if(e.length>0){this._depthMap.dispose();for(const t of e)delete this._scene._depthRenderer[t]}}}Np._SceneComponentInitialization=e=>{throw $("DepthRendererSceneComponent")};nt.ShadersStore.minmaxReduxPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;\n#if defined(INITIAL)\nuniform sampler2D sourceTexture;uniform vec2 texSize;void main(void)\n{ivec2 coord=ivec2(vUV*(texSize-1.0));float f1=texelFetch(sourceTexture,coord,0).r;float f2=texelFetch(sourceTexture,coord+ivec2(1,0),0).r;float f3=texelFetch(sourceTexture,coord+ivec2(1,1),0).r;float f4=texelFetch(sourceTexture,coord+ivec2(0,1),0).r;float minz=min(min(min(f1,f2),f3),f4);\n#ifdef DEPTH_REDUX\nfloat maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);\n#else\nfloat maxz=max(max(max(f1,f2),f3),f4);\n#endif\nglFragColor=vec4(minz,maxz,0.,0.);}\n#elif defined(MAIN)\nuniform vec2 texSize;void main(void)\n{ivec2 coord=ivec2(vUV*(texSize-1.0));vec2 f1=texelFetch(textureSampler,coord,0).rg;vec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;vec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;vec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;float minz=min(min(min(f1.x,f2.x),f3.x),f4.x);float maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);glFragColor=vec4(minz,maxz,0.,0.);}\n#elif defined(ONEBEFORELAST)\nuniform ivec2 texSize;void main(void)\n{ivec2 coord=ivec2(vUV*vec2(texSize-1));vec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;vec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;vec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;vec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;float minz=min(f1.x,f2.x);float maxz=max(f1.y,f2.y);glFragColor=vec4(minz,maxz,0.,0.);}\n#elif defined(LAST)\nvoid main(void)\n{glFragColor=vec4(0.);if (true) { \ndiscard;}}\n#endif\n";class Fp{constructor(e){this.onAfterReductionPerformed=new a,this._forceFullscreenViewport=!0,this._activated=!1,this._camera=e,this._postProcessManager=new ui(e.getScene()),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add((()=>{this._postProcessManager._rebuild()}))}get sourceTexture(){return this._sourceTexture}setSourceTexture(e,t,i=2,s=!0){if(e===this._sourceTexture)return;this.dispose(!1),this._sourceTexture=e,this._reductionSteps=[],this._forceFullscreenViewport=s;const r=this._camera.getScene(),n=new dn("Initial reduction phase","minmaxRedux",["texSize"],["sourceTexture"],1,null,1,r.getEngine(),!1,"#define INITIAL"+(t?"\n#define DEPTH_REDUX":""),i,void 0,void 0,void 0,7);n.autoClear=!1,n.forceFullscreenViewport=s;let o=this._sourceTexture.getRenderWidth(),a=this._sourceTexture.getRenderHeight();n.onApply=((e,t)=>i=>{i.setTexture("sourceTexture",this._sourceTexture),i.setFloat2("texSize",e,t)})(o,a),this._reductionSteps.push(n);let l=1;for(;o>1||a>1;){o=Math.max(Math.round(o/2),1),a=Math.max(Math.round(a/2),1);const e=new dn("Reduction phase "+l,"minmaxRedux",["texSize"],null,{width:o,height:a},null,1,r.getEngine(),!1,"#define "+(1==o&&1==a?"LAST":1==o||1==a?"ONEBEFORELAST":"MAIN"),i,void 0,void 0,void 0,7);if(e.autoClear=!1,e.forceFullscreenViewport=s,e.onApply=((e,t)=>i=>{1==e||1==t?i.setInt2("texSize",e,t):i.setFloat2("texSize",e,t)})(o,a),this._reductionSteps.push(e),l++,1==o&&1==a){const t=(e,t,i)=>{const s=new Float32Array(4*e*t),n={min:0,max:0};return()=>{r.getEngine()._readTexturePixels(i.inputTexture.texture,e,t,-1,0,s,!1),n.min=s[0],n.max=s[1],this.onAfterReductionPerformed.notifyObservers(n)}};e.onAfterRenderObservable.add(t(o,a,e))}}}get refreshRate(){return this._sourceTexture?this._sourceTexture.refreshRate:-1}set refreshRate(e){this._sourceTexture&&(this._sourceTexture.refreshRate=e)}get activated(){return this._activated}activate(){!this._onAfterUnbindObserver&&this._sourceTexture&&(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add((()=>{var e,t;const i=this._camera.getScene().getEngine();null===(e=i._debugPushGroup)||void 0===e||e.call(i,"min max reduction",1),this._reductionSteps[0].activate(this._camera),this._postProcessManager.directRender(this._reductionSteps,this._reductionSteps[0].inputTexture,this._forceFullscreenViewport),i.unBindFramebuffer(this._reductionSteps[0].inputTexture,!1),null===(t=i._debugPopGroup)||void 0===t||t.call(i,1)})),this._activated=!0)}deactivate(){this._onAfterUnbindObserver&&this._sourceTexture&&(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=!1)}dispose(e=!0){if(e&&(this.onAfterReductionPerformed.clear(),this._onContextRestoredObserver&&(this._camera.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)),this.deactivate(),this._reductionSteps){for(let e=0;e<this._reductionSteps.length;++e)this._reductionSteps[e].dispose();this._reductionSteps=null}this._postProcessManager&&e&&this._postProcessManager.dispose(),this._sourceTexture=null}}class wp extends Fp{get depthRenderer(){return this._depthRenderer}constructor(e){super(e)}setDepthRenderer(e=null,t=2,i=!0){const s=this._camera.getScene();this._depthRenderer&&(delete s._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),null===e&&(s._depthRenderer||(s._depthRenderer={}),(e=this._depthRenderer=new Np(s,t,this._camera,!1,1)).enabled=!1,this._depthRendererId="minmax"+this._camera.id,s._depthRenderer[this._depthRendererId]=e),super.setSourceTexture(e.getDepthMap(),!0,t,i)}setSourceTexture(e,t,i=2,s=!0){super.setSourceTexture(e,t,i,s)}activate(){this._depthRenderer&&(this._depthRenderer.enabled=!0),super.activate()}deactivate(){super.deactivate(),this._depthRenderer&&(this._depthRenderer.enabled=!1)}dispose(e=!0){if(super.dispose(e),this._depthRenderer&&e){const e=this._depthRenderer.getDepthMap().getScene();e&&delete e._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null}}}const Lp=S.Up(),Bp=S.Zero(),Up=new S,Vp=new S,kp=new y;class Gp extends Dp{_validateFilter(e){return e===Dp.FILTER_NONE||e===Dp.FILTER_PCF||e===Dp.FILTER_PCSS?e:(console.error('Unsupported filter "'+e+'"!'),Dp.FILTER_NONE)}get numCascades(){return this._numCascades}set numCascades(e){(e=Math.min(Math.max(e,Gp.MIN_CASCADES_COUNT),Gp.MAX_CASCADES_COUNT))!==this._numCascades&&(this._numCascades=e,this.recreateShadowMap(),this._recreateSceneUBOs())}get freezeShadowCastersBoundingInfo(){return this._freezeShadowCastersBoundingInfo}set freezeShadowCastersBoundingInfo(e){this._freezeShadowCastersBoundingInfoObservable&&e&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._freezeShadowCastersBoundingInfoObservable||e||(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add((()=>this._computeShadowCastersBoundingInfo()))),this._freezeShadowCastersBoundingInfo=e,e&&this._computeShadowCastersBoundingInfo()}_computeShadowCastersBoundingInfo(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._shadowMap&&this._shadowMap.renderList){const e=this._shadowMap.renderList;for(let t=0;t<e.length;t++){const i=e[t];if(!i)continue;const s=i.getBoundingInfo().boundingBox;this._scbiMin.minimizeInPlace(s.minimumWorld),this._scbiMax.maximizeInPlace(s.maximumWorld)}const t=this._scene.meshes;for(let e=0;e<t.length;e++){const i=t[e];if(!(i&&i.isVisible&&i.isEnabled&&i.receiveShadows))continue;const s=i.getBoundingInfo().boundingBox;this._scbiMin.minimizeInPlace(s.minimumWorld),this._scbiMax.maximizeInPlace(s.maximumWorld)}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)}get shadowCastersBoundingInfo(){return this._shadowCastersBoundingInfo}set shadowCastersBoundingInfo(e){this._shadowCastersBoundingInfo=e}setMinMaxDistance(e,t){this._minDistance===e&&this._maxDistance===t||(e>t&&(e=0,t=1),e<0&&(e=0),t>1&&(t=1),this._minDistance=e,this._maxDistance=t,this._breaksAreDirty=!0)}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}getClassName(){return Gp.CLASSNAME}getCascadeMinExtents(e){return e>=0&&e<this._numCascades?this._cascadeMinExtents[e]:null}getCascadeMaxExtents(e){return e>=0&&e<this._numCascades?this._cascadeMaxExtents[e]:null}get shadowMaxZ(){return this._getCamera()?this._shadowMaxZ:0}set shadowMaxZ(e){const t=this._getCamera();t?this._shadowMaxZ===e||e<t.minZ||e>t.maxZ&&0!==t.maxZ||(this._shadowMaxZ=e,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0):this._shadowMaxZ=e}get debug(){return this._debug}set debug(e){this._debug=e,this._light._markMeshesAsLightDirty()}get depthClamp(){return this._depthClamp}set depthClamp(e){this._depthClamp=e}get cascadeBlendPercentage(){return this._cascadeBlendPercentage}set cascadeBlendPercentage(e){this._cascadeBlendPercentage=e,this._light._markMeshesAsLightDirty()}get lambda(){return this._lambda}set lambda(e){const t=Math.min(Math.max(e,0),1);this._lambda!=t&&(this._lambda=t,this._breaksAreDirty=!0)}getCascadeViewMatrix(e){return e>=0&&e<this._numCascades?this._viewMatrices[e]:null}getCascadeProjectionMatrix(e){return e>=0&&e<this._numCascades?this._projectionMatrices[e]:null}getCascadeTransformMatrix(e){return e>=0&&e<this._numCascades?this._transformMatrices[e]:null}setDepthRenderer(e){this._depthRenderer=e,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)}get autoCalcDepthBounds(){return this._autoCalcDepthBounds}set autoCalcDepthBounds(e){const t=this._getCamera();if(t){if(this._autoCalcDepthBounds=e,!e)return this._depthReducer&&this._depthReducer.deactivate(),void this.setMinMaxDistance(0,1);this._depthReducer||(this._depthReducer=new wp(t),this._depthReducer.onAfterReductionPerformed.add((e=>{let t=e.min,i=e.max;t>=i&&(t=0,i=1),t==this._minDistance&&i==this._maxDistance||this.setMinMaxDistance(t,i)})),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()}}get autoCalcDepthBoundsRefreshRate(){var e,t,i;return null!==(i=null===(t=null===(e=this._depthReducer)||void 0===e?void 0:e.depthRenderer)||void 0===t?void 0:t.getDepthMap().refreshRate)&&void 0!==i?i:-1}set autoCalcDepthBoundsRefreshRate(e){var t;(null===(t=this._depthReducer)||void 0===t?void 0:t.depthRenderer)&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=e)}splitFrustum(){this._breaksAreDirty=!0}_splitFrustum(){const e=this._getCamera();if(!e)return;const t=e.minZ,i=e.maxZ||this._shadowMaxZ,s=i-t,r=this._minDistance,n=t+r*s,o=t+(this._shadowMaxZ<i&&this._shadowMaxZ>=t?Math.min((this._shadowMaxZ-t)/(i-t),this._maxDistance):this._maxDistance)*s,a=o-n,l=o/n;for(let e=0;e<this._cascades.length;++e){const i=(e+1)/this._numCascades,o=n*l**i,h=n+a*i,c=this._lambda*(o-h)+h;this._cascades[e].prevBreakDistance=0===e?r:this._cascades[e-1].breakDistance,this._cascades[e].breakDistance=(c-t)/s,this._viewSpaceFrustumsZ[e]=c,this._frustumLengths[e]=(this._cascades[e].breakDistance-this._cascades[e].prevBreakDistance)*s}this._breaksAreDirty=!1}_computeMatrices(){const e=this._scene;if(!this._getCamera())return;S.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),1===Math.abs(S.Dot(this._lightDirection,S.Up()))&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);const t=e.getEngine().useReverseDepthBuffer;for(let i=0;i<this._numCascades;++i){this._computeFrustumInWorldSpace(i),this._computeCascadeFrustum(i),this._cascadeMaxExtents[i].subtractToRef(this._cascadeMinExtents[i],Up),this._frustumCenter[i].addToRef(this._lightDirection.scale(this._cascadeMinExtents[i].z),this._shadowCameraPos[i]),y.LookAtLHToRef(this._shadowCameraPos[i],this._frustumCenter[i],Lp,this._viewMatrices[i]);let s=0,r=Up.z;const n=this._shadowCastersBoundingInfo;n.update(this._viewMatrices[i]),r=Math.min(r,n.boundingBox.maximumWorld.z),s=this._depthClamp&&this.filter!==Dp.FILTER_PCSS?Math.max(s,n.boundingBox.minimumWorld.z):Math.min(s,n.boundingBox.minimumWorld.z),y.OrthoOffCenterLHToRef(this._cascadeMinExtents[i].x,this._cascadeMaxExtents[i].x,this._cascadeMinExtents[i].y,this._cascadeMaxExtents[i].y,t?r:s,t?s:r,this._projectionMatrices[i],e.getEngine().isNDCHalfZRange),this._cascadeMinExtents[i].z=s,this._cascadeMaxExtents[i].z=r,this._viewMatrices[i].multiplyToRef(this._projectionMatrices[i],this._transformMatrices[i]),S.TransformCoordinatesToRef(Bp,this._transformMatrices[i],Up),Up.scaleInPlace(this._mapSize/2),Vp.copyFromFloats(Math.round(Up.x),Math.round(Up.y),Math.round(Up.z)),Vp.subtractInPlace(Up).scaleInPlace(2/this._mapSize),y.TranslationToRef(Vp.x,Vp.y,0,kp),this._projectionMatrices[i].multiplyToRef(kp,this._projectionMatrices[i]),this._viewMatrices[i].multiplyToRef(this._projectionMatrices[i],this._transformMatrices[i]),this._transformMatrices[i].copyToArray(this._transformMatricesAsArray,16*i)}}_computeFrustumInWorldSpace(e){const t=this._getCamera();if(!t)return;const i=this._cascades[e].prevBreakDistance,s=this._cascades[e].breakDistance,r=this._scene.getEngine().isNDCHalfZRange;t.getViewMatrix();const n=0===t.maxZ,o=t.maxZ;n&&(t.maxZ=this._shadowMaxZ,t.getProjectionMatrix(!0));const a=y.Invert(t.getTransformationMatrix());n&&(t.maxZ=o,t.getProjectionMatrix(!0));const l=this._scene.getEngine().useReverseDepthBuffer?4:0;for(let t=0;t<Gp._FrustumCornersNDCSpace.length;++t)Up.copyFrom(Gp._FrustumCornersNDCSpace[(t+l)%Gp._FrustumCornersNDCSpace.length]),r&&-1===Up.z&&(Up.z=0),S.TransformCoordinatesToRef(Up,a,this._frustumCornersWorldSpace[e][t]);for(let t=0;t<Gp._FrustumCornersNDCSpace.length/2;++t)Up.copyFrom(this._frustumCornersWorldSpace[e][t+4]).subtractInPlace(this._frustumCornersWorldSpace[e][t]),Vp.copyFrom(Up).scaleInPlace(i),Up.scaleInPlace(s),Up.addInPlace(this._frustumCornersWorldSpace[e][t]),this._frustumCornersWorldSpace[e][t+4].copyFrom(Up),this._frustumCornersWorldSpace[e][t].addInPlace(Vp)}_computeCascadeFrustum(e){if(this._cascadeMinExtents[e].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[e].copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._frustumCenter[e].copyFromFloats(0,0,0),this._getCamera()){for(let t=0;t<this._frustumCornersWorldSpace[e].length;++t)this._frustumCenter[e].addInPlace(this._frustumCornersWorldSpace[e][t]);if(this._frustumCenter[e].scaleInPlace(1/this._frustumCornersWorldSpace[e].length),this.stabilizeCascades){let t=0;for(let i=0;i<this._frustumCornersWorldSpace[e].length;++i){const s=this._frustumCornersWorldSpace[e][i].subtractToRef(this._frustumCenter[e],Up).length();t=Math.max(t,s)}t=Math.ceil(16*t)/16,this._cascadeMaxExtents[e].copyFromFloats(t,t,t),this._cascadeMinExtents[e].copyFromFloats(-t,-t,-t)}else{const t=this._frustumCenter[e];this._frustumCenter[e].addToRef(this._lightDirection,Up),y.LookAtLHToRef(t,Up,Lp,kp);for(let t=0;t<this._frustumCornersWorldSpace[e].length;++t)S.TransformCoordinatesToRef(this._frustumCornersWorldSpace[e][t],kp,Up),this._cascadeMinExtents[e].minimizeInPlace(Up),this._cascadeMaxExtents[e].maximizeInPlace(Up)}}}_recreateSceneUBOs(){if(this._disposeSceneUBOs(),this._sceneUBOs)for(let e=0;e<this._numCascades;++e)this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for CSM Shadow Generator (light "${this._light.name}" cascade #${e})`))}static get IsSupported(){const e=x.LastCreatedEngine;return!!e&&e._features.supportCSM}constructor(e,t,i,s,r=!0){Gp.IsSupported?(super(e,t,i,s,r),this.usePercentageCloserFiltering=!0):k.Error("CascadedShadowMap is not supported by the current engine.")}_initializeGenerator(){var e,t,i,s,r,n,o,a,l,h,c,u,d,p,_,f,m,g,v,x;this.penumbraDarkness=null!==(e=this.penumbraDarkness)&&void 0!==e?e:1,this._numCascades=null!==(t=this._numCascades)&&void 0!==t?t:Gp.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=null!==(i=this.stabilizeCascades)&&void 0!==i&&i,this._freezeShadowCastersBoundingInfoObservable=null!==(s=this._freezeShadowCastersBoundingInfoObservable)&&void 0!==s?s:null,this.freezeShadowCastersBoundingInfo=null!==(r=this.freezeShadowCastersBoundingInfo)&&void 0!==r&&r,this._scbiMin=null!==(n=this._scbiMin)&&void 0!==n?n:new S(0,0,0),this._scbiMax=null!==(o=this._scbiMax)&&void 0!==o?o:new S(0,0,0),this._shadowCastersBoundingInfo=null!==(a=this._shadowCastersBoundingInfo)&&void 0!==a?a:new Es(new S(0,0,0),new S(0,0,0)),this._breaksAreDirty=null===(l=this._breaksAreDirty)||void 0===l||l,this._minDistance=null!==(h=this._minDistance)&&void 0!==h?h:0,this._maxDistance=null!==(c=this._maxDistance)&&void 0!==c?c:1,this._currentLayer=null!==(u=this._currentLayer)&&void 0!==u?u:0,this._shadowMaxZ=null!==(_=null!==(d=this._shadowMaxZ)&&void 0!==d?d:null===(p=this._getCamera())||void 0===p?void 0:p.maxZ)&&void 0!==_?_:1e4,this._debug=null!==(f=this._debug)&&void 0!==f&&f,this._depthClamp=null===(m=this._depthClamp)||void 0===m||m,this._cascadeBlendPercentage=null!==(g=this._cascadeBlendPercentage)&&void 0!==g?g:.1,this._lambda=null!==(v=this._lambda)&&void 0!==v?v:.5,this._autoCalcDepthBounds=null!==(x=this._autoCalcDepthBounds)&&void 0!==x&&x,this._recreateSceneUBOs(),super._initializeGenerator()}_createTargetRenderTexture(){const e=this._scene.getEngine(),t={width:this._mapSize,height:this._mapSize,layers:this.numCascades};this._shadowMap=new Bn(this._light.name+"_CSMShadowMap",t,this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(super._initializeShadowMap(),null===this._shadowMap)return;this._transformMatricesAsArray=new Float32Array(16*this._numCascades),this._viewSpaceFrustumsZ=new Array(this._numCascades),this._frustumLengths=new Array(this._numCascades),this._lightSizeUVCorrection=new Array(2*this._numCascades),this._depthCorrection=new Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(let e=0;e<this._numCascades;++e){this._cascades[e]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[e]=y.Zero(),this._projectionMatrices[e]=y.Zero(),this._transformMatrices[e]=y.Zero(),this._cascadeMinExtents[e]=new S,this._cascadeMaxExtents[e]=new S,this._frustumCenter[e]=new S,this._shadowCameraPos[e]=new S,this._frustumCornersWorldSpace[e]=new Array(Gp._FrustumCornersNDCSpace.length);for(let t=0;t<Gp._FrustumCornersNDCSpace.length;++t)this._frustumCornersWorldSpace[e][t]=new S}const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add((t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[t]),this._currentLayer=t,this._filter===Dp.FILTER_PCF&&e.setColorWrite(!1),this._scene.setTransformMatrix(this.getCascadeViewMatrix(t),this.getCascadeProjectionMatrix(t)),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())})),this._shadowMap.onBeforeBindObservable.add((()=>{var t;this._currentSceneUBO=this._scene.getSceneUniformBuffer(),null===(t=e._debugPushGroup)||void 0===t||t.call(e,`cascaded shadow map generation for pass id ${e.currentRenderPassId}`,1),this._breaksAreDirty&&this._splitFrustum(),this._computeMatrices()})),this._splitFrustum()}_bindCustomEffectForRenderSubMeshForShadowMap(e,t){t.setMatrix("viewProjection",this.getCascadeTransformMatrix(this._currentLayer))}_isReadyCustomDefines(e){e.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==Dp.FILTER_PCSS?"1":"0"))}prepareDefines(e,t){super.prepareDefines(e,t);const i=this._scene,s=this._light;if(!i.shadowsEnabled||!s.shadowEnabled)return;e["SHADOWCSM"+t]=!0,e["SHADOWCSMDEBUG"+t]=this.debug,e["SHADOWCSMNUM_CASCADES"+t]=this.numCascades,e["SHADOWCSM_RIGHTHANDED"+t]=i.useRightHandedSystem;const r=this._getCamera();r&&this._shadowMaxZ<=(r.maxZ||this._shadowMaxZ)&&(e["SHADOWCSMUSESHADOWMAXZ"+t]=!0),0===this.cascadeBlendPercentage&&(e["SHADOWCSMNOBLEND"+t]=!0)}bindShadowLight(e,t){const i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;const s=this._getCamera();if(!s)return;const r=this.getShadowMap();if(!r)return;const n=r.getSize().width;if(t.setMatrices("lightMatrix"+e,this._transformMatricesAsArray),t.setArray("viewFrustumZ"+e,this._viewSpaceFrustumsZ),t.setFloat("cascadeBlendFactor"+e,0===this.cascadeBlendPercentage?1e4:1/this.cascadeBlendPercentage),t.setArray("frustumLengths"+e,this._frustumLengths),this._filter===Dp.FILTER_PCF)t.setDepthStencilTexture("shadowSampler"+e,r),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),n,1/n,this.frustumEdgeFalloff,e);else if(this._filter===Dp.FILTER_PCSS){for(let e=0;e<this._numCascades;++e)this._lightSizeUVCorrection[2*e+0]=0===e?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[e].x-this._cascadeMinExtents[e].x),this._lightSizeUVCorrection[2*e+1]=0===e?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[e].y-this._cascadeMinExtents[e].y),this._depthCorrection[e]=0===e?1:(this._cascadeMaxExtents[e].z-this._cascadeMinExtents[e].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);t.setDepthStencilTexture("shadowSampler"+e,r),t.setTexture("depthSampler"+e,r),t.setArray2("lightSizeUVCorrection"+e,this._lightSizeUVCorrection),t.setArray("depthCorrection"+e,this._depthCorrection),t.setFloat("penumbraDarkness"+e,this.penumbraDarkness),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/n,this._contactHardeningLightSizeUVRatio*n,this.frustumEdgeFalloff,e)}else t.setTexture("shadowSampler"+e,r),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),n,1/n,this.frustumEdgeFalloff,e);i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(s),this.getLight().getDepthMinZ(s)+this.getLight().getDepthMaxZ(s),e)}getTransformMatrix(){return this.getCascadeTransformMatrix(0)}dispose(){super.dispose(),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)}serialize(){const e=super.serialize(),t=this.getShadowMap();if(!t)return e;if(e.numCascades=this._numCascades,e.debug=this._debug,e.stabilizeCascades=this.stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this.cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.autoCalcDepthBounds=this.autoCalcDepthBounds,e.shadowMaxZ=this._shadowMaxZ,e.penumbraDarkness=this.penumbraDarkness,e.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,e.minDistance=this.minDistance,e.maxDistance=this.maxDistance,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++){const s=t.renderList[i];e.renderList.push(s.id)}return e}static Parse(e,t){const i=Dp.Parse(e,t,((e,t,i)=>new Gp(e,t,void 0,i)));return void 0!==e.numCascades&&(i.numCascades=e.numCascades),void 0!==e.debug&&(i.debug=e.debug),void 0!==e.stabilizeCascades&&(i.stabilizeCascades=e.stabilizeCascades),void 0!==e.lambda&&(i.lambda=e.lambda),void 0!==e.cascadeBlendPercentage&&(i.cascadeBlendPercentage=e.cascadeBlendPercentage),void 0!==e.depthClamp&&(i.depthClamp=e.depthClamp),void 0!==e.autoCalcDepthBounds&&(i.autoCalcDepthBounds=e.autoCalcDepthBounds),void 0!==e.shadowMaxZ&&(i.shadowMaxZ=e.shadowMaxZ),void 0!==e.penumbraDarkness&&(i.penumbraDarkness=e.penumbraDarkness),void 0!==e.freezeShadowCastersBoundingInfo&&(i.freezeShadowCastersBoundingInfo=e.freezeShadowCastersBoundingInfo),void 0!==e.minDistance&&void 0!==e.maxDistance&&i.setMinMaxDistance(e.minDistance,e.maxDistance),i}}Gp._FrustumCornersNDCSpace=[new S(-1,1,-1),new S(1,1,-1),new S(1,-1,-1),new S(-1,-1,-1),new S(-1,1,1),new S(1,1,1),new S(1,-1,1),new S(-1,-1,1)],Gp.CLASSNAME="CascadedShadowGenerator",Gp.DEFAULT_CASCADES_COUNT=4,Gp.MIN_CASCADES_COUNT=2,Gp.MAX_CASCADES_COUNT=4,Gp._SceneComponentInitialization=e=>{throw $("ShadowGeneratorSceneComponent")},s.AddParser(fi.NAME_SHADOWGENERATOR,((e,t)=>{if(void 0!==e.shadowGenerators&&null!==e.shadowGenerators)for(let i=0,s=e.shadowGenerators.length;i<s;i++){const s=e.shadowGenerators[i];s.className===Gp.CLASSNAME?Gp.Parse(s,t):Dp.Parse(s,t)}}));class zp{constructor(e){this.name=fi.NAME_SHADOWGENERATOR,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(fi.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)}rebuild(){}serialize(e){e.shadowGenerators=[];const t=this.scene.lights;for(const i of t){const t=i.getShadowGenerators();if(t){const i=t.values();for(let t=i.next();!0!==t.done;t=i.next()){const i=t.value;e.shadowGenerators.push(i.serialize())}}}}addFromContainer(e){}removeFromContainer(e,t){}dispose(){}_gatherRenderTargets(e){const t=this.scene;if(this.scene.shadowsEnabled)for(let i=0;i<t.lights.length;i++){const s=t.lights[i],r=s.getShadowGenerators();if(s.isEnabled()&&s.shadowEnabled&&r){const i=r.values();for(let s=i.next();!0!==s.done;s=i.next()){const i=s.value.getShadowMap();-1!==t.textures.indexOf(i)&&e.push(i)}}}}}Dp._SceneComponentInitialization=e=>{let t=e._getComponent(fi.NAME_SHADOWGENERATOR);t||(t=new zp(e),e._addComponent(t))},ve.AddNodeConstructor("Light_Type_0",((e,t)=>()=>new Wp(e,S.Zero(),t)));class Wp extends sd{get shadowAngle(){return this._shadowAngle}set shadowAngle(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()}get direction(){return this._direction}set direction(e){const t=this.needCube();if(this._direction=e,this.needCube()!==t&&this._shadowGenerators){const e=this._shadowGenerators.values();for(let t=e.next();!0!==t.done;t=e.next())t.value.recreateShadowMap()}}constructor(e,t,i){super(e,i),this._shadowAngle=Math.PI/2,this.position=t}getClassName(){return"PointLight"}getTypeID(){return pr.LIGHTTYPEID_POINTLIGHT}needCube(){return!this.direction}getShadowDirection(e){if(this.direction)return super.getShadowDirection(e);switch(e){case 0:return new S(1,0,0);case 1:return new S(-1,0,0);case 2:return new S(0,-1,0);case 3:return new S(0,1,0);case 4:return new S(0,0,1);case 5:return new S(0,0,-1)}return S.Zero()}_setDefaultShadowProjectionMatrix(e,t,i){const s=this.getScene().activeCamera;if(!s)return;const r=void 0!==this.shadowMinZ?this.shadowMinZ:s.minZ,n=void 0!==this.shadowMaxZ?this.shadowMaxZ:s.maxZ,o=this.getScene().getEngine().useReverseDepthBuffer;y.PerspectiveFovLHToRef(this.shadowAngle,1,o?n:r,o?r:n,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,o)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,t):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,t),this}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?e.setFloat3(t,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(t,this.position.x,this.position.y,this.position.z),this}prepareLightSpecificDefines(e,t){e["POINTLIGHT"+t]=!0}}me([ie()],Wp.prototype,"shadowAngle",null);class Hp{constructor(e,t="",i="black"){this._renderingCanvas=e,this._loadingText=t,this._loadingDivBackgroundColor=i,this._resizeLoadingUI=()=>{const e=this._renderingCanvas.getBoundingClientRect(),t=window.getComputedStyle(this._renderingCanvas).position;this._loadingDiv&&(this._loadingDiv.style.position="fixed"===t?"fixed":"absolute",this._loadingDiv.style.left=e.left+"px",this._loadingDiv.style.top=e.top+"px",this._loadingDiv.style.width=e.width+"px",this._loadingDiv.style.height=e.height+"px")}}displayLoadingUI(){if(this._loadingDiv)return;this._loadingDiv=document.createElement("div"),this._loadingDiv.id="babylonjsLoadingDiv",this._loadingDiv.style.opacity="0",this._loadingDiv.style.transition="opacity 1.5s ease",this._loadingDiv.style.pointerEvents="none",this._loadingDiv.style.display="grid",this._loadingDiv.style.gridTemplateRows="100%",this._loadingDiv.style.gridTemplateColumns="100%",this._loadingDiv.style.justifyItems="center",this._loadingDiv.style.alignItems="center",this._loadingTextDiv=document.createElement("div"),this._loadingTextDiv.style.position="absolute",this._loadingTextDiv.style.left="0",this._loadingTextDiv.style.top="50%",this._loadingTextDiv.style.marginTop="80px",this._loadingTextDiv.style.width="100%",this._loadingTextDiv.style.height="20px",this._loadingTextDiv.style.fontFamily="Arial",this._loadingTextDiv.style.fontSize="14px",this._loadingTextDiv.style.color="white",this._loadingTextDiv.style.textAlign="center",this._loadingTextDiv.style.zIndex="1",this._loadingTextDiv.innerHTML="Loading",this._loadingDiv.appendChild(this._loadingTextDiv),this._loadingTextDiv.innerHTML=this._loadingText,this._style=document.createElement("style"),this._style.type="text/css",this._style.innerHTML="@-webkit-keyframes spin1 {                    0% { -webkit-transform: rotate(0deg);}\n                    100% { -webkit-transform: rotate(360deg);}\n                }                @keyframes spin1 {                    0% { transform: rotate(0deg);}\n                    100% { transform: rotate(360deg);}\n                }",document.getElementsByTagName("head")[0].appendChild(this._style);const e=!!window.SVGSVGElement,t=new Image;Hp.DefaultLogoUrl?t.src=Hp.DefaultLogoUrl:t.src=e?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAuMTcgMjA4LjA0Ij48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2ZmZjt9LmNscy0ye2ZpbGw6I2UwNjg0Yjt9LmNscy0ze2ZpbGw6I2JiNDY0Yjt9LmNscy00e2ZpbGw6I2UwZGVkODt9LmNscy01e2ZpbGw6I2Q1ZDJjYTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPkJhYnlsb25Mb2dvPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iUGFnZV9FbGVtZW50cyIgZGF0YS1uYW1lPSJQYWdlIEVsZW1lbnRzIj48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik05MC4wOSwwLDAsNTJWMTU2bDkwLjA5LDUyLDkwLjA4LTUyVjUyWiIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMiIgcG9pbnRzPSIxODAuMTcgNTIuMDEgMTUxLjk3IDM1LjczIDEyNC44NSA1MS4zOSAxNTMuMDUgNjcuNjcgMTgwLjE3IDUyLjAxIi8+PHBvbHlnb24gY2xhc3M9ImNscy0yIiBwb2ludHM9IjI3LjEyIDY3LjY3IDExNy4yMSAxNS42NiA5MC4wOCAwIDAgNTIuMDEgMjcuMTIgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTIiIHBvaW50cz0iNjEuODkgMTIwLjMgOTAuMDggMTM2LjU4IDExOC4yOCAxMjAuMyA5MC4wOCAxMDQuMDIgNjEuODkgMTIwLjMiLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDE1My4wNSAxNDAuMzcgOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyAwIDUyLjAxIDAgMTU2LjAzIDkwLjA4IDIwOC4wNCAxODAuMTcgMTU2LjAzIDE4MC4xNyA1Mi4wMSAxNTMuMDUgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iOTAuMDggNzEuNDYgNjEuODkgODcuNzQgNjEuODkgMTIwLjMgOTAuMDggMTA0LjAyIDExOC4yOCAxMjAuMyAxMTguMjggODcuNzQgOTAuMDggNzEuNDYiLz48cG9seWdvbiBjbGFzcz0iY2xzLTQiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDExOC4yOCA4Ny43NCAxMTguMjggMTIwLjMgOTAuMDggMTM2LjU4IDkwLjA4IDE3Ni43MiAxNTMuMDUgMTQwLjM3IDE1My4wNSA2Ny42NyIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtNSIgcG9pbnRzPSIyNy4xMiA2Ny42NyA2MS44OSA4Ny43NCA2MS44OSAxMjAuMyA5MC4wOCAxMzYuNTggOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyIvPjwvZz48L2c+PC9zdmc+":"https://cdn.babylonjs.com/Assets/babylonLogo.png",t.style.width="150px",t.style.gridColumn="1",t.style.gridRow="1",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.position="absolute";const i=document.createElement("div");i.style.width="300px",i.style.gridColumn="1",i.style.gridRow="1",i.style.top="50%",i.style.left="50%",i.style.transform="translate(-50%, -50%)",i.style.position="absolute";const s=new Image;if(Hp.DefaultSpinnerUrl?s.src=Hp.DefaultSpinnerUrl:s.src=e?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTIgMzkyIj48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2UwNjg0Yjt9LmNscy0ye2ZpbGw6bm9uZTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPlNwaW5uZXJJY29uPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iU3Bpbm5lciI+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNNDAuMjEsMTI2LjQzYzMuNy03LjMxLDcuNjctMTQuNDQsMTItMjEuMzJsMy4zNi01LjEsMy41Mi01YzEuMjMtMS42MywyLjQxLTMuMjksMy42NS00LjkxczIuNTMtMy4yMSwzLjgyLTQuNzlBMTg1LjIsMTg1LjIsMCwwLDEsODMuNCw2Ny40M2EyMDgsMjA4LDAsMCwxLDE5LTE1LjY2YzMuMzUtMi40MSw2Ljc0LTQuNzgsMTAuMjUtN3M3LjExLTQuMjgsMTAuNzUtNi4zMmM3LjI5LTQsMTQuNzMtOCwyMi41My0xMS40OSwzLjktMS43Miw3Ljg4LTMuMywxMi00LjY0YTEwNC4yMiwxMDQuMjIsMCwwLDEsMTIuNDQtMy4yMyw2Mi40NCw2Mi40NCwwLDAsMSwxMi43OC0xLjM5QTI1LjkyLDI1LjkyLDAsMCwxLDE5NiwyMS40NGE2LjU1LDYuNTUsMCwwLDEsMi4wNSw5LDYuNjYsNi42NiwwLDAsMS0xLjY0LDEuNzhsLS40MS4yOWEyMi4wNywyMi4wNywwLDAsMS01Ljc4LDMsMzAuNDIsMzAuNDIsMCwwLDEtNS42NywxLjYyLDM3LjgyLDM3LjgyLDAsMCwxLTUuNjkuNzFjLTEsMC0xLjkuMTgtMi44NS4yNmwtMi44NS4yNHEtNS43Mi41MS0xMS40OCwxLjFjLTMuODQuNC03LjcxLjgyLTExLjU4LDEuNGExMTIuMzQsMTEyLjM0LDAsMCwwLTIyLjk0LDUuNjFjLTMuNzIsMS4zNS03LjM0LDMtMTAuOTQsNC42NHMtNy4xNCwzLjUxLTEwLjYsNS41MUExNTEuNiwxNTEuNiwwLDAsMCw2OC41Niw4N0M2Ny4yMyw4OC40OCw2Niw5MCw2NC42NCw5MS41NnMtMi41MSwzLjE1LTMuNzUsNC43M2wtMy41NCw0LjljLTEuMTMsMS42Ni0yLjIzLDMuMzUtMy4zMyw1YTEyNywxMjcsMCwwLDAtMTAuOTMsMjEuNDksMS41OCwxLjU4LDAsMSwxLTMtMS4xNVM0MC4xOSwxMjYuNDcsNDAuMjEsMTI2LjQzWiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgd2lkdGg9IjM5MiIgaGVpZ2h0PSIzOTIiLz48L2c+PC9nPjwvc3ZnPg==":"https://cdn.babylonjs.com/Assets/loadingIcon.png",s.style.animation="spin1 0.75s infinite linear",s.style.webkitAnimation="spin1 0.75s infinite linear",s.style.transformOrigin="50% 50%",s.style.webkitTransformOrigin="50% 50%",!e){const e={w:16,h:18.5},i={w:30,h:30};t.style.width=`${e.w}vh`,t.style.height=`${e.h}vh`,t.style.left=`calc(50% - ${e.w/2}vh)`,t.style.top=`calc(50% - ${e.h/2}vh)`,s.style.width=`${i.w}vh`,s.style.height=`${i.h}vh`,s.style.left=`calc(50% - ${i.w/2}vh)`,s.style.top=`calc(50% - ${i.h/2}vh)`}i.appendChild(s),this._loadingDiv.appendChild(t),this._loadingDiv.appendChild(i),this._resizeLoadingUI(),window.addEventListener("resize",this._resizeLoadingUI),this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor,document.body.appendChild(this._loadingDiv),this._loadingDiv.style.opacity="1"}hideLoadingUI(){this._loadingDiv&&(this._loadingDiv.style.opacity="0",this._loadingDiv.addEventListener("transitionend",(()=>{this._loadingTextDiv&&(this._loadingTextDiv.remove(),this._loadingTextDiv=null),this._loadingDiv&&(this._loadingDiv.remove(),this._loadingDiv=null),this._style&&(this._style.remove(),this._style=null),window.removeEventListener("resize",this._resizeLoadingUI)})))}set loadingUIText(e){this._loadingText=e,this._loadingTextDiv&&(this._loadingTextDiv.innerHTML=this._loadingText)}get loadingUIText(){return this._loadingText}get loadingUIBackgroundColor(){return this._loadingDivBackgroundColor}set loadingUIBackgroundColor(e){this._loadingDivBackgroundColor=e,this._loadingDiv&&(this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor)}}Hp.DefaultLogoUrl="",Hp.DefaultSpinnerUrl="",Ns.DefaultLoadingScreenFactory=e=>new Hp(e);class Xp{static ConvertPanoramaToCubemap(e,t,i,s,r=!1){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";if(e.length!=t*i*3)throw"ConvertPanoramaToCubemap: input size is wrong";return{front:this.CreateCubemapTexture(s,this.FACE_FRONT,e,t,i,r),back:this.CreateCubemapTexture(s,this.FACE_BACK,e,t,i,r),left:this.CreateCubemapTexture(s,this.FACE_LEFT,e,t,i,r),right:this.CreateCubemapTexture(s,this.FACE_RIGHT,e,t,i,r),up:this.CreateCubemapTexture(s,this.FACE_UP,e,t,i,r),down:this.CreateCubemapTexture(s,this.FACE_DOWN,e,t,i,r),size:s,type:1,format:4,gammaSpace:!1}}static CreateCubemapTexture(e,t,i,s,r,n=!1){const o=new ArrayBuffer(e*e*4*3),a=new Float32Array(o),l=n?Math.max(1,Math.round(s/4/e)):1,h=1/l,c=h*h,u=t[1].subtract(t[0]).scale(h/e),d=t[3].subtract(t[2]).scale(h/e),p=1/e;let _=0;for(let n=0;n<e;n++)for(let o=0;o<l;o++){let o=t[0],f=t[2];for(let t=0;t<e;t++)for(let h=0;h<l;h++){const l=f.subtract(o).scale(_).add(o);l.normalize();const h=this.CalcProjectionSpherical(l,i,s,r);a[n*e*3+3*t+0]+=h.r*c,a[n*e*3+3*t+1]+=h.g*c,a[n*e*3+3*t+2]+=h.b*c,o=o.add(u),f=f.add(d)}_+=p*h}return a}static CalcProjectionSpherical(e,t,i,s){let r=Math.atan2(e.z,e.x);const n=Math.acos(e.y);for(;r<-Math.PI;)r+=2*Math.PI;for(;r>Math.PI;)r-=2*Math.PI;let o=r/Math.PI;const a=n/Math.PI;o=.5*o+.5;let l=Math.round(o*i);l<0?l=0:l>=i&&(l=i-1);let h=Math.round(a*s);h<0?h=0:h>=s&&(h=s-1);const c=s-h-1;return{r:t[c*i*3+3*l+0],g:t[c*i*3+3*l+1],b:t[c*i*3+3*l+2]}}}Xp.FACE_LEFT=[new S(-1,-1,-1),new S(1,-1,-1),new S(-1,1,-1),new S(1,1,-1)],Xp.FACE_RIGHT=[new S(1,-1,1),new S(-1,-1,1),new S(1,1,1),new S(-1,1,1)],Xp.FACE_FRONT=[new S(1,-1,-1),new S(1,-1,1),new S(1,1,-1),new S(1,1,1)],Xp.FACE_BACK=[new S(-1,-1,1),new S(-1,-1,-1),new S(-1,1,1),new S(-1,1,-1)],Xp.FACE_DOWN=[new S(1,1,-1),new S(1,1,1),new S(-1,1,-1),new S(-1,1,1)],Xp.FACE_UP=[new S(-1,-1,-1),new S(-1,-1,1),new S(1,-1,-1),new S(1,-1,1)];class Yp{static _Ldexp(e,t){return t>1023?e*Math.pow(2,1023)*Math.pow(2,t-1023):t<-1074?e*Math.pow(2,-1074)*Math.pow(2,t+1074):e*Math.pow(2,t)}static _Rgbe2float(e,t,i,s,r,n){r>0?(r=this._Ldexp(1,r-136),e[n+0]=t*r,e[n+1]=i*r,e[n+2]=s*r):(e[n+0]=0,e[n+1]=0,e[n+2]=0)}static _ReadStringLine(e,t){let i="",s="";for(let r=t;r<e.length-t&&(s=String.fromCharCode(e[r]),"\n"!=s);r++)i+=s;return i}static RGBE_ReadHeader(e){let t=0,i=0,s=this._ReadStringLine(e,0);if("#"!=s[0]||"?"!=s[1])throw"Bad HDR Format.";let r=!1,n=!1,o=0;do{o+=s.length+1,s=this._ReadStringLine(e,o),"FORMAT=32-bit_rle_rgbe"==s?n=!0:0==s.length&&(r=!0)}while(!r);if(!n)throw"HDR Bad header format, unsupported FORMAT";o+=s.length+1,s=this._ReadStringLine(e,o);const a=/^-Y (.*) \+X (.*)$/g.exec(s);if(!a||a.length<3)throw"HDR Bad header format, no size";if(i=parseInt(a[2]),t=parseInt(a[1]),i<8||i>32767)throw"HDR Bad header format, unsupported size";return o+=s.length+1,{height:t,width:i,dataPosition:o}}static GetCubeMapTextureData(e,t,i=!1){const s=new Uint8Array(e),r=this.RGBE_ReadHeader(s),n=this.RGBE_ReadPixels(s,r);return Xp.ConvertPanoramaToCubemap(n,r.width,r.height,t,i)}static RGBE_ReadPixels(e,t){return this._RGBEReadPixelsRLE(e,t)}static _RGBEReadPixelsRLE(e,t){let i=t.height;const s=t.width;let r,n,o,a,l,h=t.dataPosition,c=0,u=0,d=0;const p=new ArrayBuffer(4*s),_=new Uint8Array(p),f=new ArrayBuffer(t.width*t.height*4*3),m=new Float32Array(f);for(;i>0;){if(r=e[h++],n=e[h++],o=e[h++],a=e[h++],2!=r||2!=n||128&o||t.width<8||t.width>32767)return this._RGBEReadPixelsNOTRLE(e,t);if((o<<8|a)!=s)throw"HDR Bad header format, wrong scan line width";for(c=0,d=0;d<4;d++)for(u=(d+1)*s;c<u;)if(r=e[h++],n=e[h++],r>128){if(l=r-128,0==l||l>u-c)throw"HDR Bad Format, bad scanline data (run)";for(;l-- >0;)_[c++]=n}else{if(l=r,0==l||l>u-c)throw"HDR Bad Format, bad scanline data (non-run)";if(_[c++]=n,--l>0)for(let t=0;t<l;t++)_[c++]=e[h++]}for(d=0;d<s;d++)r=_[d],n=_[d+s],o=_[d+2*s],a=_[d+3*s],this._Rgbe2float(m,r,n,o,a,(t.height-i)*s*3+3*d);i--}return m}static _RGBEReadPixelsNOTRLE(e,t){let i=t.height;const s=t.width;let r,n,o,a,l,h=t.dataPosition;const c=new ArrayBuffer(t.width*t.height*4*3),u=new Float32Array(c);for(;i>0;){for(l=0;l<t.width;l++)r=e[h++],n=e[h++],o=e[h++],a=e[h++],this._Rgbe2float(u,r,n,o,a,(t.height-i)*s*3+3*l);i--}return u}}nt.ShadersStore.hdrFilteringVertexShader="attribute vec2 position;varying vec3 direction;uniform vec3 up;uniform vec3 right;uniform vec3 front;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nmat3 view=mat3(up,right,front);direction=view*vec3(position,1.0);gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";nt.ShadersStore.hdrFilteringPixelShader="#include<helperFunctions>\n#include<importanceSampling>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\nuniform float alphaG;uniform samplerCube inputTexture;uniform vec2 vFilteringInfo;uniform float hdrScale;varying vec3 direction;void main() {vec3 color=radiance(alphaG,inputTexture,direction,vFilteringInfo);gl_FragColor=vec4(color*hdrScale,1.0);}";class jp{constructor(e,t={}){this._lodGenerationOffset=0,this._lodGenerationScale=.8,this.quality=4096,this.hdrScale=1,this._engine=e,this.hdrScale=t.hdrScale||this.hdrScale,this.quality=t.quality||this.quality}_createRenderTarget(e){let t=0;this._engine.getCaps().textureHalfFloatRender?t=2:this._engine.getCaps().textureFloatRender&&(t=1);const i=this._engine.createRenderTargetCubeTexture(e,{format:5,type:t,createMipMaps:!0,generateMipMaps:!1,generateDepthBuffer:!1,generateStencilBuffer:!1,samplingMode:1});return this._engine.updateTextureWrappingMode(i.texture,0,0,0),this._engine.updateTextureSamplingMode(3,i.texture,!0),i}_prefilterInternal(e){const t=e.getSize().width,i=l.ILog2(t)+1,s=this._effectWrapper.effect,r=this._createRenderTarget(t);this._effectRenderer.saveStates(),this._effectRenderer.setViewport();const n=e.getInternalTexture();n&&this._engine.updateTextureSamplingMode(3,n,!0),this._effectRenderer.applyEffectWrapper(this._effectWrapper);const o=[[new S(0,0,-1),new S(0,-1,0),new S(1,0,0)],[new S(0,0,1),new S(0,-1,0),new S(-1,0,0)],[new S(1,0,0),new S(0,0,1),new S(0,1,0)],[new S(1,0,0),new S(0,0,-1),new S(0,-1,0)],[new S(1,0,0),new S(0,-1,0),new S(0,0,1)],[new S(-1,0,0),new S(0,-1,0),new S(0,0,-1)]];s.setFloat("hdrScale",this.hdrScale),s.setFloat2("vFilteringInfo",e.getSize().width,i),s.setTexture("inputTexture",e);for(let e=0;e<6;e++){s.setVector3("up",o[e][0]),s.setVector3("right",o[e][1]),s.setVector3("front",o[e][2]);for(let n=0;n<i;n++){this._engine.bindFramebuffer(r,e,void 0,void 0,!0,n),this._effectRenderer.applyEffectWrapper(this._effectWrapper);let i=Math.pow(2,(n-this._lodGenerationOffset)/this._lodGenerationScale)/t;0===n&&(i=0),s.setFloat("alphaG",i),this._effectRenderer.draw()}}this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),this._engine._releaseTexture(e._texture);const a=r.texture.type,h=r.texture.format;return r._swapAndDie(e._texture),e._texture.type=a,e._texture.format=h,e.gammaSpace=!1,e.lodGenerationOffset=this._lodGenerationOffset,e.lodGenerationScale=this._lodGenerationScale,e._prefiltered=!0,e}_createEffect(e,t){const i=[];return e.gammaSpace&&i.push("#define GAMMA_INPUT"),i.push("#define NUM_SAMPLES "+this.quality+"u"),new On({engine:this._engine,name:"hdrFiltering",vertexShader:"hdrFiltering",fragmentShader:"hdrFiltering",samplerNames:["inputTexture"],uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale","alphaG"],useShaderStore:!0,defines:i,onCompiled:t})}isReady(e){return e.isReady()&&this._effectWrapper.effect.isReady()}prefilter(e,t=null){return this._engine._features.allowTexturePrefiltering?new Promise((i=>{this._effectRenderer=new Mn(this._engine),this._effectWrapper=this._createEffect(e),this._effectWrapper.effect.executeWhenCompiled((()=>{this._prefilterInternal(e),this._effectRenderer.dispose(),this._effectWrapper.dispose(),i(),t&&t()}))})):(k.Warn("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."),Promise.reject("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."))}}class Kp extends Cr{set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(y.RotationY(this._rotationY))}get rotationY(){return this._rotationY}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}constructor(e,t,i,s=!1,r=!0,n=!1,o=!1,l=null,h=null,c=!1){var u;super(t),this._generateHarmonics=!0,this._onError=null,this._isBlocking=!0,this._rotationY=0,this.boundingBoxPosition=S.Zero(),this.onLoadObservable=new a,e&&(this._coordinatesMode=Ar.CUBIC_MODE,this.name=e,this.url=e,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=y.Identity(),this._prefilterOnLoad=o,this._onLoad=()=>{this.onLoadObservable.notifyObservers(this),l&&l()},this._onError=h,this.gammaSpace=n,this._noMipmap=s,this._size=i,this._supersample=c,this._generateHarmonics=r,this._texture=this._getFromCache(e,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?this._texture.isReady?Ht.SetImmediate((()=>this._onLoad())):this._texture.onLoadedObservable.add(this._onLoad):(null===(u=this.getScene())||void 0===u?void 0:u.useDelayedTextureLoading)?this.delayLoadState=4:this._loadTexture())}getClassName(){return"HDRCubeTexture"}_loadTexture(){const e=this._getEngine(),t=e.getCaps();let i=0;if(t.textureFloat&&t.textureFloatLinearFiltering?i=1:t.textureHalfFloat&&t.textureHalfFloatLinearFiltering&&(i=2),e._features.allowTexturePrefiltering&&this._prefilterOnLoad){const t=this._onLoad,i=new jp(e);this._onLoad=()=>{i.prefilter(this,t)}}this._texture=e.createRawCubeTextureFromUrl(this.url,this.getScene(),this._size,4,i,this._noMipmap,(e=>{this.lodGenerationOffset=0,this.lodGenerationScale=.8;const t=Yp.GetCubeMapTextureData(e,this._size,this._supersample);if(this._generateHarmonics){const e=Fh.ConvertCubeMapToSphericalPolynomial(t);this.sphericalPolynomial=e}const s=[];let r=null,n=null;for(let e=0;e<6;e++){2===i?n=new Uint16Array(this._size*this._size*3):0===i&&(r=new Uint8Array(this._size*this._size*3));const o=t[Kp._FacesMapping[e]];if(this.gammaSpace||n||r)for(let e=0;e<this._size*this._size;e++)if(this.gammaSpace&&(o[3*e+0]=Math.pow(o[3*e+0],h),o[3*e+1]=Math.pow(o[3*e+1],h),o[3*e+2]=Math.pow(o[3*e+2],h)),n&&(n[3*e+0]=Ph(o[3*e+0]),n[3*e+1]=Ph(o[3*e+1]),n[3*e+2]=Ph(o[3*e+2])),r){let t=Math.max(255*o[3*e+0],0),i=Math.max(255*o[3*e+1],0),s=Math.max(255*o[3*e+2],0);const n=Math.max(Math.max(t,i),s);if(n>255){const e=255/n;t*=e,i*=e,s*=e}r[3*e+0]=t,r[3*e+1]=i,r[3*e+2]=s}n?s.push(n):r?s.push(r):s.push(o)}return s}),null,this._onLoad,this._onError)}clone(){const e=new Kp(this.url,this.getScene()||this._getEngine(),this._size,this._noMipmap,this._generateHarmonics,this.gammaSpace);return e.level=this.level,e.wrapU=this.wrapU,e.wrapV=this.wrapV,e.coordinatesIndex=this.coordinatesIndex,e.coordinatesMode=this.coordinatesMode,e}delayLoad(){4===this.delayLoadState&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||this._loadTexture())}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){var t;this._textureMatrix=e,e.updateFlag!==this._textureMatrix.updateFlag&&e.isIdentity()!==this._textureMatrix.isIdentity()&&(null===(t=this.getScene())||void 0===t||t.markAllMaterialsAsDirty(1,(e=>-1!==e.getActiveTextures().indexOf(this))))}dispose(){this.onLoadObservable.clear(),super.dispose()}static Parse(e,t,i){let s=null;return e.name&&!e.isRenderTarget&&(s=new Kp(i+e.name,t,e.size,e.noMipmap,e.generateHarmonics,e.useInGammaSpace),s.name=e.name,s.hasAlpha=e.hasAlpha,s.level=e.level,s.coordinatesMode=e.coordinatesMode,s.isBlocking=e.isBlocking),s&&(e.boundingBoxPosition&&(s.boundingBoxPosition=S.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(s.boundingBoxSize=S.FromArray(e.boundingBoxSize)),e.rotationY&&(s.rotationY=e.rotationY)),s}serialize(){if(!this.name)return null;const e={};return e.name=this.name,e.hasAlpha=this.hasAlpha,e.isCube=!0,e.level=this.level,e.size=this._size,e.coordinatesMode=this.coordinatesMode,e.useInGammaSpace=this.gammaSpace,e.generateHarmonics=this._generateHarmonics,e.customType="BABYLON.HDRCubeTexture",e.noMipmap=this._noMipmap,e.isBlocking=this._isBlocking,e.rotationY=this._rotationY,e}}Kp._FacesMapping=["right","left","up","down","front","back"],m("BABYLON.HDRCubeTexture",Kp);class $p{get influence(){return this._influence}set influence(e){if(this._influence===e)return;const t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(0===t||0===e)}get animationPropertiesOverride(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}constructor(e,t=0,i=null){this.name=e,this.animations=[],this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uniqueId=0,this.onInfluenceChanged=new a,this._onDataLayoutChanged=new a,this._animationPropertiesOverride=null,this._scene=i||x.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId())}get uniqueId(){return this._uniqueId}get hasPositions(){return!!this._positions}get hasNormals(){return!!this._normals}get hasTangents(){return!!this._tangents}get hasUVs(){return!!this._uvs}setPositions(e){const t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)}getPositions(){return this._positions}setNormals(e){const t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)}getNormals(){return this._normals}setTangents(e){const t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)}getTangents(){return this._tangents}setUVs(e){const t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)}getUVs(){return this._uvs}clone(){const e=de.Clone((()=>new $p(this.name,this.influence,this._scene)),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e}serialize(){const e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),null!=this.id&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),de.AppendSerializedAnimations(this,e),e}getClassName(){return"MorphTarget"}static Parse(e,t){const i=new $p(e.name,e.influence);if(i.setPositions(e.positions),null!=e.id&&(i.id=e.id),e.normals&&i.setNormals(e.normals),e.tangents&&i.setTangents(e.tangents),e.uvs&&i.setUVs(e.uvs),e.animations){for(let t=0;t<e.animations.length;t++){const s=e.animations[t],r=g("BABYLON.Animation");r&&i.animations.push(r.Parse(s))}e.autoAnimate&&t&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return i}static FromMesh(e,t,i){t||(t=e.name);const s=new $p(t,i,e.getScene());return s.setPositions(e.getVerticesData(hi.PositionKind)),e.isVerticesDataPresent(hi.NormalKind)&&s.setNormals(e.getVerticesData(hi.NormalKind)),e.isVerticesDataPresent(hi.TangentKind)&&s.setTangents(e.getVerticesData(hi.TangentKind)),e.isVerticesDataPresent(hi.UVKind)&&s.setUVs(e.getVerticesData(hi.UVKind)),s}}me([ie()],$p.prototype,"id",void 0);class qp extends Ar{get depth(){return this._depth}constructor(e,t,i,s,r,n,o=!0,a=!1,l=Ar.TRILINEAR_SAMPLINGMODE,h=0,c){super(null,n,!o,a),this.format=r,this._texture=n.getEngine().createRawTexture2DArray(e,t,i,s,r,o,a,l,null,h,c),this._depth=s,this.is2DArray=!0}update(e){this._texture&&this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}static CreateRGBATexture(e,t,i,s,r,n=!0,o=!1,a=3,l=0){return new qp(e,t,i,s,5,r,n,o,a,l)}}class Qp{set areUpdatesFrozen(e){e?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(!0)))}get areUpdatesFrozen(){return this._blockCounter>0}constructor(e=null){if(this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new Yt(16),this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._vertexCount=0,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._parentContainer=null,this.optimizeInfluencers=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this._useTextureToStoreTargets=!0,e||(e=x.LastCreatedScene),this._scene=e,this._scene){this._scene.addMorphTargetManager(this),this._uniqueId=this._scene.getUniqueId();const e=this._scene.getEngine().getCaps();this._canUseTextureForTargets=e.canUseGLVertexID&&e.textureFloat&&e.maxVertexTextureImageUnits>0&&e.texture2DArrayMaxLayerCount>1}}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get numTargets(){return this._targets.length}get numInfluencers(){return this._activeTargets.length}get influences(){return this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(e){this._useTextureToStoreTargets=e}get isUsingTextureForTargets(){var e;return Qp.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets&&!(null===(e=this._scene)||void 0===e?void 0:e.getEngine().getCaps().disableMorphTargetTexture)}getActiveTarget(e){return this._activeTargets.data[e]}getTarget(e){return this._targets[e]}addTarget(e){this._targets.push(e),this._targetInfluenceChangedObservers.push(e.onInfluenceChanged.add((e=>{this._syncActiveTargets(e)}))),this._targetDataLayoutChangedObservers.push(e._onDataLayoutChanged.add((()=>{this._syncActiveTargets(!0)}))),this._syncActiveTargets(!0)}removeTarget(e){const t=this._targets.indexOf(e);t>=0&&(this._targets.splice(t,1),e.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(t,1)[0]),e._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(t,1)[0]),this._syncActiveTargets(!0)),this._scene&&this._scene.stopAnimation(e)}_bind(e){e.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),e.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),e.setTexture("morphTargets",this._targetStoreTexture)}clone(){const e=new Qp(this._scene);for(const t of this._targets)e.addTarget(t.clone());return e.enableNormalMorphing=this.enableNormalMorphing,e.enableTangentMorphing=this.enableTangentMorphing,e.enableUVMorphing=this.enableUVMorphing,e}serialize(){const e={};e.id=this.uniqueId,e.targets=[];for(const t of this._targets)e.targets.push(t.serialize());return e}_syncActiveTargets(e){if(this.areUpdatesFrozen)return;let t=0;this._activeTargets.reset(),this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._vertexCount=0,this._scene&&this._targets.length>this._scene.getEngine().getCaps().texture2DArrayMaxLayerCount&&(this.useTextureToStoreTargets=!1),this._morphTargetTextureIndices&&this._morphTargetTextureIndices.length===this._targets.length||(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let i=-1;for(const e of this._targets){if(i++,0===e.influence&&this.optimizeInfluencers)continue;if(this._activeTargets.length>=Qp.MaxActiveMorphTargetsInVertexAttributeMode&&!this.isUsingTextureForTargets)break;this._activeTargets.push(e),this._morphTargetTextureIndices[t]=i,this._tempInfluences[t++]=e.influence,this._supportsNormals=this._supportsNormals&&e.hasNormals,this._supportsTangents=this._supportsTangents&&e.hasTangents,this._supportsUVs=this._supportsUVs&&e.hasUVs;const s=e.getPositions();if(s){const e=s.length/3;if(0===this._vertexCount)this._vertexCount=e;else if(this._vertexCount!==e)return void k.Error("Incompatible target. Targets must all have the same vertices count.")}}this._morphTargetTextureIndices.length!==t&&(this._morphTargetTextureIndices=this._morphTargetTextureIndices.slice(0,t)),this._influences&&this._influences.length===t||(this._influences=new Float32Array(t));for(let e=0;e<t;e++)this._influences[e]=this._tempInfluences[e];e&&this.synchronize()}synchronize(){if(this._scene&&!this.areUpdatesFrozen){if(this.isUsingTextureForTargets&&this._vertexCount){this._textureVertexStride=1,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride,this._textureHeight=1;const e=this._scene.getEngine().getCaps().maxTextureSize;this._textureWidth>e&&(this._textureHeight=Math.ceil(this._textureWidth/e),this._textureWidth=e);let t=!0;if(this._targetStoreTexture){const e=this._targetStoreTexture.getSize();e.width===this._textureWidth&&e.height===this._textureHeight&&this._targetStoreTexture.depth===this._targets.length&&(t=!1)}if(t){this._targetStoreTexture&&this._targetStoreTexture.dispose();const e=this._targets.length,t=new Float32Array(e*this._textureWidth*this._textureHeight*4);let i=0;for(let s=0;s<e;s++){const e=this._targets[s],r=e.getPositions(),n=e.getNormals(),o=e.getUVs(),a=e.getTangents();if(!r)return void(0===s&&k.Error("Invalid morph target. Target must have positions."));i=s*this._textureWidth*this._textureHeight*4;for(let e=0;e<this._vertexCount;e++)t[i]=r[3*e],t[i+1]=r[3*e+1],t[i+2]=r[3*e+2],i+=4,this._supportsNormals&&n&&(t[i]=n[3*e],t[i+1]=n[3*e+1],t[i+2]=n[3*e+2],i+=4),this._supportsUVs&&o&&(t[i]=o[2*e],t[i+1]=o[2*e+1],i+=4),this._supportsTangents&&a&&(t[i]=a[3*e],t[i+1]=a[3*e+1],t[i+2]=a[3*e+2],i+=4)}this._targetStoreTexture=qp.CreateRGBATexture(t,this._textureWidth,this._textureHeight,e,this._scene,!1,!1,1,1)}}for(const e of this._scene.meshes)e.morphTargetManager===this&&e._syncGeometryWithMorphTargetManager()}}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this._scene){if(this._scene.removeMorphTargetManager(this),this._parentContainer){const e=this._parentContainer.morphTargetManagers.indexOf(this);e>-1&&this._parentContainer.morphTargetManagers.splice(e,1),this._parentContainer=null}for(const e of this._targets)this._scene.stopAnimation(e)}}static Parse(e,t){const i=new Qp(t);i._uniqueId=e.id;for(const s of e.targets)i.addTarget($p.Parse(s,t));return i}}Qp.EnableTextureStorage=!0,Qp.MaxActiveMorphTargetsInVertexAttributeMode=8;class Zp{constructor(){this._hasHit=!1,this._hitDistance=0,this._hitNormalWorld=S.Zero(),this._hitPointWorld=S.Zero(),this._rayFromWorld=S.Zero(),this._rayToWorld=S.Zero(),this._triangleIndex=-1}get hasHit(){return this._hasHit}get hitDistance(){return this._hitDistance}get hitNormalWorld(){return this._hitNormalWorld}get hitPointWorld(){return this._hitPointWorld}get rayFromWorld(){return this._rayFromWorld}get rayToWorld(){return this._rayToWorld}get triangleIndex(){return this._triangleIndex}setHitData(e,t,i){this._hasHit=!0,this._hitNormalWorld.set(e.x,e.y,e.z),this._hitPointWorld.set(t.x,t.y,t.z),this._triangleIndex=null!=i?i:-1}setHitDistance(e){this._hitDistance=e}calculateHitDistance(){this._hitDistance=S.Distance(this._rayFromWorld,this._hitPointWorld)}reset(e=S.Zero(),t=S.Zero()){this._rayFromWorld.copyFrom(e),this._rayToWorld.copyFrom(t),this._hasHit=!1,this._hitDistance=0,this._hitNormalWorld.setAll(0),this._hitPointWorld.setAll(0),this._triangleIndex=-1,this.body=void 0,this.bodyIndex=void 0}}class Jp{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw $("CannonJSPlugin")}constructor(e,t=Jp.DefaultPluginFactory()){if(this._physicsPlugin=t,this._impostors=[],this._joints=[],this._subTimeStep=0,this._uniqueIdCounter=0,!this._physicsPlugin.isSupported())throw new Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. Please make sure it is included.");e=e||new S(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._impostors.forEach((function(e){e.dispose()})),this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}addImpostor(e){this._impostors.push(e),e.uniqueId=this._uniqueIdCounter++,e.parent||this._physicsPlugin.generatePhysicsBody(e)}removeImpostor(e){const t=this._impostors.indexOf(e);t>-1&&this._impostors.splice(t,1).length&&this.getPhysicsPlugin().removePhysicsBody(e)}addJoint(e,t,i){const s={mainImpostor:e,connectedImpostor:t,joint:i};i.physicsPlugin=this._physicsPlugin,this._joints.push(s),this._physicsPlugin.generateJoint(s)}removeJoint(e,t,i){const s=this._joints.filter((function(s){return s.connectedImpostor===t&&s.joint===i&&s.mainImpostor===e}));s.length&&this._physicsPlugin.removeJoint(s[0])}_step(e){this._impostors.forEach((e=>{e.isBodyInitRequired()&&this._physicsPlugin.generatePhysicsBody(e)})),e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._impostors)}getPhysicsPlugin(){return this._physicsPlugin}getImpostors(){return this._impostors}getImpostorForPhysicsObject(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].object===e)return this._impostors[t];return null}getImpostorWithPhysicsBody(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].physicsBody===e)return this._impostors[t];return null}raycast(e,t){return this._physicsPlugin.raycast(e,t)}raycastToRef(e,t,i){return this._physicsPlugin.raycastToRef(e,t,i)}}class e_{constructor(e=!0,t=10,i=CANNON){this._useDeltaForWorldStep=e,this.name="CannonJSPlugin",this._physicsMaterials=new Array,this._fixedTimeStep=1/60,this._physicsBodiesToRemoveAfterStep=new Array,this._firstFrame=!0,this._tmpQuaternion=new C,this._minus90X=new C(-.7071067811865475,0,0,.7071067811865475),this._plus90X=new C(.7071067811865475,0,0,.7071067811865475),this._tmpPosition=S.Zero(),this._tmpDeltaPosition=S.Zero(),this._tmpUnityRotation=new C,this.BJSCANNON=i,this.isSupported()?(this._extendNamespace(),this.world=new this.BJSCANNON.World,this.world.broadphase=new this.BJSCANNON.NaiveBroadphase,this.world.solver.iterations=t,this._cannonRaycastResult=new this.BJSCANNON.RaycastResult,this._raycastResult=new Zp):k.Error("CannonJS is not available. Please make sure you included the js file.")}getPluginVersion(){return 1}setGravity(e){const t=e;this.world.gravity.set(t.x,t.y,t.z)}setTimeStep(e){this._fixedTimeStep=e}getTimeStep(){return this._fixedTimeStep}executeStep(e,t){if(this._firstFrame){this._firstFrame=!1;for(const e of t)e.type!=Wr.HeightmapImpostor&&e.type!==Wr.PlaneImpostor&&e.beforeStep()}this.world.step(this._useDeltaForWorldStep?e:this._fixedTimeStep),this._removeMarkedPhysicsBodiesFromWorld()}_removeMarkedPhysicsBodiesFromWorld(){this._physicsBodiesToRemoveAfterStep.length>0&&(this._physicsBodiesToRemoveAfterStep.forEach((e=>{"function"==typeof this.world.removeBody?this.world.removeBody(e):this.world.remove(e)})),this._physicsBodiesToRemoveAfterStep.length=0)}applyImpulse(e,t,i){const s=new this.BJSCANNON.Vec3(i.x,i.y,i.z),r=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyImpulse(r,s)}applyForce(e,t,i){const s=new this.BJSCANNON.Vec3(i.x,i.y,i.z),r=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyForce(r,s)}generatePhysicsBody(e){if(this._removeMarkedPhysicsBodiesFromWorld(),e.parent)e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());else{if(e.isBodyInitRequired()){const t=this._createShape(e);if(!t)return void k.Warn("It was not possible to create a physics body for this object.");const i=e.physicsBody;i&&this.removePhysicsBody(e);const s=this._addMaterial("mat-"+e.uniqueId,e.getParam("friction"),e.getParam("restitution")),r={mass:e.getParam("mass"),material:s},n=e.getParam("nativeOptions");for(const e in n)Object.prototype.hasOwnProperty.call(n,e)&&(r[e]=n[e]);e.physicsBody=new this.BJSCANNON.Body(r),e.physicsBody.addEventListener("collide",e.onCollide),this.world.addEventListener("preStep",e.beforeStep),this.world.addEventListener("postStep",e.afterStep),e.physicsBody.addShape(t),"function"==typeof this.world.addBody?this.world.addBody(e.physicsBody):this.world.add(e.physicsBody),i&&["force","torque","velocity","angularVelocity"].forEach((function(t){const s=i[t];e.physicsBody[t].set(s.x,s.y,s.z)})),this._processChildMeshes(e)}this._updatePhysicsBodyTransformation(e)}}_processChildMeshes(e){const t=e.object.getChildMeshes?e.object.getChildMeshes(!0):[],i=e.object.rotationQuaternion;if(i?i.conjugateToRef(this._tmpQuaternion):this._tmpQuaternion.set(0,0,0,1),t.length){const i=t=>{if(!t.rotationQuaternion)return;const s=t.getPhysicsImpostor();if(s&&s.parent!==e&&t.parent){const i=t.getAbsolutePosition().subtract(t.parent.getAbsolutePosition()),r=t.rotationQuaternion.multiply(this._tmpQuaternion);s.physicsBody&&(this.removePhysicsBody(s),s.physicsBody=null),s.parent=e,s.resetUpdateFlags(),e.physicsBody.addShape(this._createShape(s),new this.BJSCANNON.Vec3(i.x,i.y,i.z),new this.BJSCANNON.Quaternion(r.x,r.y,r.z,r.w)),e.physicsBody.mass+=s.getParam("mass")}t.getChildMeshes(!0).filter((e=>!!e.physicsImpostor)).forEach(i)};t.filter((e=>!!e.physicsImpostor)).forEach(i)}}removePhysicsBody(e){e.physicsBody.removeEventListener("collide",e.onCollide),this.world.removeEventListener("preStep",e.beforeStep),this.world.removeEventListener("postStep",e.afterStep),-1===this._physicsBodiesToRemoveAfterStep.indexOf(e.physicsBody)&&this._physicsBodiesToRemoveAfterStep.push(e.physicsBody)}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;let s;const r=e.joint.jointData,n={pivotA:r.mainPivot?(new this.BJSCANNON.Vec3).set(r.mainPivot.x,r.mainPivot.y,r.mainPivot.z):null,pivotB:r.connectedPivot?(new this.BJSCANNON.Vec3).set(r.connectedPivot.x,r.connectedPivot.y,r.connectedPivot.z):null,axisA:r.mainAxis?(new this.BJSCANNON.Vec3).set(r.mainAxis.x,r.mainAxis.y,r.mainAxis.z):null,axisB:r.connectedAxis?(new this.BJSCANNON.Vec3).set(r.connectedAxis.x,r.connectedAxis.y,r.connectedAxis.z):null,maxForce:r.nativeParams.maxForce,collideConnected:!!r.collision};switch(e.joint.type){case zr.HingeJoint:case zr.Hinge2Joint:s=new this.BJSCANNON.HingeConstraint(t,i,n);break;case zr.DistanceJoint:s=new this.BJSCANNON.DistanceConstraint(t,i,r.maxDistance||2);break;case zr.SpringJoint:{const e=r;s=new this.BJSCANNON.Spring(t,i,{restLength:e.length,stiffness:e.stiffness,damping:e.damping,localAnchorA:n.pivotA,localAnchorB:n.pivotB});break}case zr.LockJoint:s=new this.BJSCANNON.LockConstraint(t,i,n);break;case zr.PointToPointJoint:case zr.BallAndSocketJoint:default:s=new this.BJSCANNON.PointToPointConstraint(t,n.pivotA,i,n.pivotB,n.maxForce)}s.collideConnected=!!r.collision,e.joint.physicsJoint=s,e.joint.type!==zr.SpringJoint?this.world.addConstraint(s):(e.joint.jointData.forceApplicationCallback=e.joint.jointData.forceApplicationCallback||function(){s.applyForce()},e.mainImpostor.registerAfterPhysicsStep(e.joint.jointData.forceApplicationCallback))}removeJoint(e){e.joint.type!==zr.SpringJoint?this.world.removeConstraint(e.joint.physicsJoint):e.mainImpostor.unregisterAfterPhysicsStep(e.joint.jointData.forceApplicationCallback)}_addMaterial(e,t,i){let s,r;for(s=0;s<this._physicsMaterials.length;s++)if(r=this._physicsMaterials[s],r.friction===t&&r.restitution===i)return r;const n=new this.BJSCANNON.Material(e);return n.friction=t,n.restitution=i,this._physicsMaterials.push(n),n}_checkWithEpsilon(e){return e<u?u:e}_createShape(e){const t=e.object;let i;const s=e.getObjectExtents();switch(e.type){case Wr.SphereImpostor:{const e=s.x,t=s.y,r=s.z;i=new this.BJSCANNON.Sphere(Math.max(this._checkWithEpsilon(e),this._checkWithEpsilon(t),this._checkWithEpsilon(r))/2);break}case Wr.CylinderImpostor:{let t=e.getParam("nativeOptions");t||(t={});const r=void 0!==t.radiusTop?t.radiusTop:this._checkWithEpsilon(s.x)/2,n=void 0!==t.radiusBottom?t.radiusBottom:this._checkWithEpsilon(s.x)/2,o=void 0!==t.height?t.height:this._checkWithEpsilon(s.y),a=void 0!==t.numSegments?t.numSegments:16;i=new this.BJSCANNON.Cylinder(r,n,o,a);const l=new this.BJSCANNON.Quaternion;l.setFromAxisAngle(new this.BJSCANNON.Vec3(1,0,0),-Math.PI/2);const h=new this.BJSCANNON.Vec3(0,0,0);i.transformAllPoints(h,l);break}case Wr.BoxImpostor:{const e=s.scale(.5);i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this._checkWithEpsilon(e.x),this._checkWithEpsilon(e.y),this._checkWithEpsilon(e.z)));break}case Wr.PlaneImpostor:k.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead"),i=new this.BJSCANNON.Plane;break;case Wr.MeshImpostor:{const s=t.getVerticesData?t.getVerticesData(hi.PositionKind):[],r=t.getIndices?t.getIndices():[];if(!s)return void k.Warn("Tried to create a MeshImpostor for an object without vertices. This will fail.");const n=t.position.clone(),o=t.rotation&&t.rotation.clone(),a=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace();const l=t.computeWorldMatrix(!0),h=[];let c;for(c=0;c<s.length;c+=3)S.TransformCoordinates(S.FromArray(s,c),l).toArray(h,c);k.Warn("MeshImpostor only collides against spheres."),i=new this.BJSCANNON.Trimesh(h,r),t.position.copyFrom(n),o&&t.rotation&&t.rotation.copyFrom(o),a&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(a);break}case Wr.HeightmapImpostor:{const s=t.position.clone(),r=t.rotation&&t.rotation.clone(),n=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace(),t.rotationQuaternion&&t.rotationQuaternion.multiplyInPlace(this._minus90X),i=this._createHeightmap(t),t.position.copyFrom(s),r&&t.rotation&&t.rotation.copyFrom(r),n&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(n),t.computeWorldMatrix(!0);break}case Wr.ParticleImpostor:i=new this.BJSCANNON.Particle;break;case Wr.NoImpostor:i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(0,0,0))}return i}_createHeightmap(e,t){let i=e.getVerticesData(hi.PositionKind);const s=e.computeWorldMatrix(!0),r=[];let n;for(n=0;n<i.length;n+=3)S.TransformCoordinates(S.FromArray(i,n),s).toArray(r,n);i=r;const o=new Array,a=t||~~(Math.sqrt(i.length/3)-1),l=e.getBoundingInfo(),h=Math.min(l.boundingBox.extendSizeWorld.x,l.boundingBox.extendSizeWorld.y),c=l.boundingBox.extendSizeWorld.z,u=2*h/a;for(let e=0;e<i.length;e+=3){const t=Math.round(i[e+0]/u+a/2),s=Math.round(-1*(i[e+1]/u-a/2)),r=-i[e+2]+c;o[t]||(o[t]=[]),o[t][s]||(o[t][s]=r),o[t][s]=Math.max(r,o[t][s])}for(let e=0;e<=a;++e){if(!o[e]){let t=1;for(;!o[(e+t)%a];)t++;o[e]=o[(e+t)%a].slice()}for(let t=0;t<=a;++t)if(!o[e][t]){let i,s=1;for(;void 0===i;)i=o[e][(t+s++)%a];o[e][t]=i}}const d=new this.BJSCANNON.Heightfield(o,{elementSize:u});return d.minY=c,d}_updatePhysicsBodyTransformation(e){const t=e.object;if(t.computeWorldMatrix&&t.computeWorldMatrix(!0),!t.getBoundingInfo())return;const i=e.getObjectCenter();this._tmpDeltaPosition.copyFrom(t.getAbsolutePivotPoint().subtract(i)),this._tmpDeltaPosition.divideInPlace(e.object.scaling),this._tmpPosition.copyFrom(i);let s=t.rotationQuaternion;if(s){if(e.type!==Wr.PlaneImpostor&&e.type!==Wr.HeightmapImpostor||(s=s.multiply(this._minus90X),e.setDeltaRotation(this._plus90X)),e.type===Wr.HeightmapImpostor){const e=t;let s=e.getBoundingInfo();const r=e.rotationQuaternion;e.rotationQuaternion=this._tmpUnityRotation,e.computeWorldMatrix(!0);const n=i.clone();let o=e.getPivotMatrix();o=o?o.clone():y.Identity();const a=y.Translation(s.boundingBox.extendSizeWorld.x,0,-s.boundingBox.extendSizeWorld.z);e.setPreTransformMatrix(a),e.computeWorldMatrix(!0),s=e.getBoundingInfo();const l=s.boundingBox.centerWorld.subtract(i).subtract(e.position).negate();this._tmpPosition.copyFromFloats(l.x,l.y-s.boundingBox.extendSizeWorld.y,l.z),this._tmpDeltaPosition.copyFrom(s.boundingBox.centerWorld.subtract(n)),this._tmpDeltaPosition.y+=s.boundingBox.extendSizeWorld.y,e.rotationQuaternion=r,e.setPreTransformMatrix(o),e.computeWorldMatrix(!0)}else e.type===Wr.MeshImpostor&&this._tmpDeltaPosition.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpDeltaPosition),e.physicsBody.position.set(this._tmpPosition.x,this._tmpPosition.y,this._tmpPosition.z),e.physicsBody.quaternion.set(s.x,s.y,s.z,s.w)}}setTransformationFromPhysicsBody(e){if(e.object.position.set(e.physicsBody.position.x,e.physicsBody.position.y,e.physicsBody.position.z),e.object.rotationQuaternion){const t=e.physicsBody.quaternion;e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}setPhysicsBodyTransformation(e,t,i){e.physicsBody.position.set(t.x,t.y,t.z),e.physicsBody.quaternion.set(i.x,i.y,i.z,i.w)}isSupported(){return void 0!==this.BJSCANNON}setLinearVelocity(e,t){e.physicsBody.velocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){const t=e.physicsBody.velocity;return t?new S(t.x,t.y,t.z):null}getAngularVelocity(e){const t=e.physicsBody.angularVelocity;return t?new S(t.x,t.y,t.z):null}setBodyMass(e,t){e.physicsBody.mass=t,e.physicsBody.updateMassProperties()}getBodyMass(e){return e.physicsBody.mass}getBodyFriction(e){return e.physicsBody.material.friction}setBodyFriction(e,t){e.physicsBody.material.friction=t}getBodyRestitution(e){return e.physicsBody.material.restitution}setBodyRestitution(e,t){e.physicsBody.material.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.wakeUp()}updateDistanceJoint(e,t){e.physicsJoint.distance=t}setMotor(e,t,i,s){s||(e.physicsJoint.enableMotor(),e.physicsJoint.setMotorSpeed(t),i&&this.setLimit(e,i))}setLimit(e,t,i){e.physicsJoint.motorEquation.maxForce=i,e.physicsJoint.motorEquation.minForce=void 0===t?-t:t}syncMeshWithImpostor(e,t){const i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.quaternion.x,e.rotationQuaternion.y=i.quaternion.y,e.rotationQuaternion.z=i.quaternion.z,e.rotationQuaternion.w=i.quaternion.w)}getRadius(e){return e.physicsBody.shapes[0].boundingSphereRadius}getBoxSizeToRef(e,t){const i=e.physicsBody.shapes[0];t.x=2*i.halfExtents.x,t.y=2*i.halfExtents.y,t.z=2*i.halfExtents.z}dispose(){}_extendNamespace(){const e=new this.BJSCANNON.Vec3,t=this.BJSCANNON;this.BJSCANNON.World.prototype.step=function(i,s,r){if(r=r||10,0===(s=s||0))this.internalStep(i),this.time+=i;else{let n=Math.floor((this.time+s)/i)-Math.floor(this.time/i);n=Math.min(n,r)||1;const o=performance.now();for(let e=0;e!==n&&(this.internalStep(i),!(performance.now()-o>1e3*i));e++);this.time+=s;const a=this.time%i/i,l=e,h=this.bodies;for(let e=0;e!==h.length;e++){const i=h[e];i.type!==t.Body.STATIC&&i.sleepState!==t.Body.SLEEPING?(i.position.vsub(i.previousPosition,l),l.scale(a,l),i.position.vadd(l,i.interpolatedPosition)):(i.interpolatedPosition.set(i.position.x,i.position.y,i.position.z),i.interpolatedQuaternion.set(i.quaternion.x,i.quaternion.y,i.quaternion.z,i.quaternion.w))}}}}raycast(e,t){return this._raycastResult.reset(e,t),this.raycastToRef(e,t,this._raycastResult),this._raycastResult}raycastToRef(e,t,i){this._cannonRaycastResult.reset(),this.world.raycastClosest(e,t,{},this._cannonRaycastResult),i.reset(e,t),this._cannonRaycastResult.hasHit&&(i.setHitData({x:this._cannonRaycastResult.hitNormalWorld.x,y:this._cannonRaycastResult.hitNormalWorld.y,z:this._cannonRaycastResult.hitNormalWorld.z},{x:this._cannonRaycastResult.hitPointWorld.x,y:this._cannonRaycastResult.hitPointWorld.y,z:this._cannonRaycastResult.hitPointWorld.z}),i.setHitDistance(this._cannonRaycastResult.distance))}}Jp.DefaultPluginFactory=()=>new e_;class t_{constructor(e=!0,t,i=OIMO){this._useDeltaForWorldStep=e,this.name="OimoJSPlugin",this._fixedTimeStep=1/60,this._tmpImpostorsArray=[],this._tmpPositionVector=S.Zero(),this.BJSOIMO=i,this.world=new this.BJSOIMO.World({iterations:t}),this.world.clear(),this._raycastResult=new Zp}getPluginVersion(){return 1}setGravity(e){this.world.gravity.set(e.x,e.y,e.z)}setTimeStep(e){this.world.timeStep=e}getTimeStep(){return this.world.timeStep}executeStep(e,t){t.forEach((function(e){e.beforeStep()})),this.world.timeStep=this._useDeltaForWorldStep?e:this._fixedTimeStep,this.world.step(),t.forEach((e=>{e.afterStep(),this._tmpImpostorsArray[e.uniqueId]=e}));let i=this.world.contacts;for(;null!==i;){if(i.touching&&!i.body1.sleeping&&!i.body2.sleeping){i=i.next;continue}const e=this._tmpImpostorsArray[+i.body1.name],t=this._tmpImpostorsArray[+i.body2.name];e&&t?(e.onCollide({body:t.physicsBody,point:null,distance:0,impulse:0,normal:null}),t.onCollide({body:e.physicsBody,point:null,distance:0,impulse:0,normal:null}),i=i.next):i=i.next}}applyImpulse(e,t,i){const s=e.physicsBody.mass;e.physicsBody.applyImpulse(i.scale(this.world.invScale),t.scale(this.world.invScale*s))}applyForce(e,t,i){k.Warn("Oimo doesn't support applying force. Using impulse instead."),this.applyImpulse(e,t,i)}generatePhysicsBody(e){if(e.parent)e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());else{if(e.isBodyInitRequired()){const i={name:e.uniqueId,config:[e.getParam("mass")||.001,e.getParam("friction"),e.getParam("restitution")],size:[],type:[],pos:[],posShape:[],rot:[],rotShape:[],move:0!==e.getParam("mass"),density:e.getParam("mass"),friction:e.getParam("friction"),restitution:e.getParam("restitution"),world:this.world},s=[e];(t=e.object).getChildMeshes&&t.getChildMeshes().forEach((function(e){e.physicsImpostor&&s.push(e.physicsImpostor)}));const r=e=>Math.max(e,u),n=new C;s.forEach((t=>{if(!t.object.rotationQuaternion)return;const s=t.object.rotationQuaternion;n.copyFrom(s),t.object.rotationQuaternion.set(0,0,0,1),t.object.computeWorldMatrix(!0);const o=n.toEulerAngles(),a=t.getObjectExtents(),l=57.29577951308232;if(t===e){const t=e.getObjectCenter();e.object.getAbsolutePivotPoint().subtractToRef(t,this._tmpPositionVector),this._tmpPositionVector.divideInPlace(e.object.scaling),i.pos.push(t.x),i.pos.push(t.y),i.pos.push(t.z),i.posShape.push(0,0,0),i.rotShape.push(0,0,0)}else{const e=t.object.position.clone();i.posShape.push(e.x),i.posShape.push(e.y),i.posShape.push(e.z),i.rotShape.push(o.x*l,o.y*l,o.z*l)}switch(t.object.rotationQuaternion.copyFrom(n),t.type){case Wr.ParticleImpostor:k.Warn("No Particle support in OIMO.js. using SphereImpostor instead");case Wr.SphereImpostor:{const e=a.x,t=a.y,s=a.z,n=Math.max(r(e),r(t),r(s))/2;i.type.push("sphere"),i.size.push(n),i.size.push(n),i.size.push(n);break}case Wr.CylinderImpostor:{const e=r(a.x)/2,t=r(a.y);i.type.push("cylinder"),i.size.push(e),i.size.push(t),i.size.push(t);break}case Wr.PlaneImpostor:case Wr.BoxImpostor:default:{const e=r(a.x),t=r(a.y),s=r(a.z);i.type.push("box"),i.size.push(e),i.size.push(t),i.size.push(s);break}}t.object.rotationQuaternion=s})),e.physicsBody=this.world.add(i),e.physicsBody.resetQuaternion(n),e.physicsBody.updatePosition(0)}else this._tmpPositionVector.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpPositionVector)}var t}removePhysicsBody(e){this.world.removeRigidBody(e.physicsBody)}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;const s=e.joint.jointData,r=s.nativeParams||{};let n;const o={body1:t,body2:i,axe1:r.axe1||(s.mainAxis?s.mainAxis.asArray():null),axe2:r.axe2||(s.connectedAxis?s.connectedAxis.asArray():null),pos1:r.pos1||(s.mainPivot?s.mainPivot.asArray():null),pos2:r.pos2||(s.connectedPivot?s.connectedPivot.asArray():null),min:r.min,max:r.max,collision:r.collision||s.collision,spring:r.spring,world:this.world};switch(e.joint.type){case zr.BallAndSocketJoint:n="jointBall";break;case zr.SpringJoint:{k.Warn("OIMO.js doesn't support Spring Constraint. Simulating using DistanceJoint instead");const e=s;o.min=e.length||o.min,o.max=Math.max(o.min,o.max)}case zr.DistanceJoint:n="jointDistance",o.max=s.maxDistance;break;case zr.PrismaticJoint:n="jointPrisme";break;case zr.SliderJoint:n="jointSlide";break;case zr.WheelJoint:n="jointWheel";break;case zr.HingeJoint:default:n="jointHinge"}o.type=n,e.joint.physicsJoint=this.world.add(o)}removeJoint(e){try{this.world.removeJoint(e.joint.physicsJoint)}catch(e){k.Warn(e)}}isSupported(){return void 0!==this.BJSOIMO}setTransformationFromPhysicsBody(e){if(!e.physicsBody.sleeping){if(e.physicsBody.shapes.next){let t=e.physicsBody.shapes;for(;t.next;)t=t.next;e.object.position.set(t.position.x,t.position.y,t.position.z)}else{const t=e.physicsBody.getPosition();e.object.position.set(t.x,t.y,t.z)}if(e.object.rotationQuaternion){const t=e.physicsBody.getQuaternion();e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}}setPhysicsBodyTransformation(e,t,i){const s=e.physicsBody;e.physicsBody.shapes.next||(s.position.set(t.x,t.y,t.z),s.orientation.set(i.x,i.y,i.z,i.w),s.syncShapes(),s.awake())}setLinearVelocity(e,t){e.physicsBody.linearVelocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){const t=e.physicsBody.linearVelocity;return t?new S(t.x,t.y,t.z):null}getAngularVelocity(e){const t=e.physicsBody.angularVelocity;return t?new S(t.x,t.y,t.z):null}setBodyMass(e,t){const i=0===t;e.physicsBody.shapes.density=i?1:t,e.physicsBody.setupMass(i?2:1)}getBodyMass(e){return e.physicsBody.shapes.density}getBodyFriction(e){return e.physicsBody.shapes.friction}setBodyFriction(e,t){e.physicsBody.shapes.friction=t}getBodyRestitution(e){return e.physicsBody.shapes.restitution}setBodyRestitution(e,t){e.physicsBody.shapes.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.awake()}updateDistanceJoint(e,t,i){e.physicsJoint.limitMotor.upperLimit=t,void 0!==i&&(e.physicsJoint.limitMotor.lowerLimit=i)}setMotor(e,t,i,s){void 0!==i?k.Warn("OimoJS plugin currently has unexpected behavior when using setMotor with force parameter"):i=1e6,t*=-1;const r=s?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;r&&r.setMotor(t,i)}setLimit(e,t,i,s){const r=s?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;r&&r.setLimit(t,void 0===i?-t:i)}syncMeshWithImpostor(e,t){const i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.orientation.x,e.rotationQuaternion.y=i.orientation.y,e.rotationQuaternion.z=i.orientation.z,e.rotationQuaternion.w=i.orientation.w)}getRadius(e){return e.physicsBody.shapes.radius}getBoxSizeToRef(e,t){const i=e.physicsBody.shapes;t.x=2*i.halfWidth,t.y=2*i.halfHeight,t.z=2*i.halfDepth}dispose(){this.world.clear()}raycast(e,t){return k.Warn("raycast is not currently supported by the Oimo physics plugin"),this._raycastResult.reset(e,t),this._raycastResult}raycastToRef(e,t,i){k.Warn("raycast is not currently supported by the Oimo physics plugin"),i.reset(e,t)}}class i_{constructor(e=!0,t=Ammo,i=null){this._useDeltaForWorldStep=e,this.bjsAMMO={},this.name="AmmoJSPlugin",this._timeStep=1/60,this._fixedTimeStep=1/60,this._maxSteps=5,this._tmpQuaternion=new C,this._tmpContactCallbackResult=!1,this._tmpContactPoint=new S,this._tmpContactNormal=new S,this._tmpVec3=new S,this._tmpMatrix=new y,"function"!=typeof t?(this.bjsAMMO=t,this.isSupported()?(this._collisionConfiguration=new this.bjsAMMO.btSoftBodyRigidBodyCollisionConfiguration,this._dispatcher=new this.bjsAMMO.btCollisionDispatcher(this._collisionConfiguration),this._overlappingPairCache=i||new this.bjsAMMO.btDbvtBroadphase,this._solver=new this.bjsAMMO.btSequentialImpulseConstraintSolver,this._softBodySolver=new this.bjsAMMO.btDefaultSoftBodySolver,this.world=new this.bjsAMMO.btSoftRigidDynamicsWorld(this._dispatcher,this._overlappingPairCache,this._solver,this._collisionConfiguration,this._softBodySolver),this._tmpAmmoConcreteContactResultCallback=new this.bjsAMMO.ConcreteContactResultCallback,this._tmpAmmoConcreteContactResultCallback.addSingleResult=e=>{const t=(e=this.bjsAMMO.wrapPointer(e,this.bjsAMMO.btManifoldPoint)).getPositionWorldOnA(),i=e.m_normalWorldOnB;this._tmpContactPoint.x=t.x(),this._tmpContactPoint.y=t.y(),this._tmpContactPoint.z=t.z(),this._tmpContactNormal.x=i.x(),this._tmpContactNormal.y=i.y(),this._tmpContactNormal.z=i.z(),this._tmpContactImpulse=e.getAppliedImpulse(),this._tmpContactDistance=e.getDistance(),this._tmpContactCallbackResult=!0},this._raycastResult=new Zp,this._tmpAmmoTransform=new this.bjsAMMO.btTransform,this._tmpAmmoTransform.setIdentity(),this._tmpAmmoQuaternion=new this.bjsAMMO.btQuaternion(0,0,0,1),this._tmpAmmoVectorA=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorB=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorC=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorD=new this.bjsAMMO.btVector3(0,0,0)):k.Error("AmmoJS is not available. Please make sure you included the js file.")):k.Error("AmmoJS is not ready. Please make sure you await Ammo() before using the plugin.")}getPluginVersion(){return 1}setGravity(e){this._tmpAmmoVectorA.setValue(e.x,e.y,e.z),this.world.setGravity(this._tmpAmmoVectorA),this.world.getWorldInfo().set_m_gravity(this._tmpAmmoVectorA)}setTimeStep(e){this._timeStep=e}setFixedTimeStep(e){this._fixedTimeStep=e}setMaxSteps(e){this._maxSteps=e}getTimeStep(){return this._timeStep}_isImpostorInContact(e){return this._tmpContactCallbackResult=!1,this.world.contactTest(e.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_isImpostorPairInContact(e,t){return this._tmpContactCallbackResult=!1,this.world.contactPairTest(e.physicsBody,t.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_stepSimulation(e=1/60,t=10,i=1/60){if(0==t)this.world.stepSimulation(e,0);else for(;t>0&&e>0;)e-i<i?(this.world.stepSimulation(e,0),e=0):(e-=i,this.world.stepSimulation(i,0)),t--}executeStep(e,t){for(const e of t)e.soft||e.beforeStep();this._stepSimulation(this._useDeltaForWorldStep?e:this._timeStep,this._maxSteps,this._fixedTimeStep);for(const e of t)if(e.soft?this._afterSoftStep(e):e.afterStep(),e._onPhysicsCollideCallbacks.length>0&&this._isImpostorInContact(e))for(const t of e._onPhysicsCollideCallbacks)for(const i of t.otherImpostors)(e.physicsBody.isActive()||i.physicsBody.isActive())&&this._isImpostorPairInContact(e,i)&&(e.onCollide({body:i.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}),i.onCollide({body:e.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}))}_afterSoftStep(e){e.type===Wr.RopeImpostor?this._ropeStep(e):this._softbodyOrClothStep(e)}_ropeStep(e){const t=e.physicsBody.get_m_nodes(),i=t.size();let s,r,n,o,a;const l=new Array;for(let e=0;e<i;e++)s=t.at(e),r=s.get_m_x(),n=r.x(),o=r.y(),a=r.z(),l.push(new S(n,o,a));const h=e.object,c=e.getParam("shape");e._isFromLine?e.object=Yl("lines",{points:l,instance:h}):e.object=Zl("ext",{shape:c,path:l,instance:h})}_softbodyOrClothStep(e){const t=e.type===Wr.ClothImpostor?1:-1,i=e.object;let s=i.getVerticesData(hi.PositionKind);s||(s=[]);let r=i.getVerticesData(hi.NormalKind);r||(r=[]);const n=s.length/3,o=e.physicsBody.get_m_nodes();let a,l,h,c,u,d,p,_;for(let e=0;e<n;e++){a=o.at(e),l=a.get_m_x(),h=l.x(),c=l.y(),u=l.z()*t;const i=a.get_m_n();d=i.x(),p=i.y(),_=i.z()*t,s[3*e]=h,s[3*e+1]=c,s[3*e+2]=u,r[3*e]=d,r[3*e+1]=p,r[3*e+2]=_}const f=new As;f.positions=s,f.normals=r,f.uvs=i.getVerticesData(hi.UVKind),f.colors=i.getVerticesData(hi.ColorKind),i&&i.getIndices&&(f.indices=i.getIndices()),f.applyToMesh(i)}applyImpulse(e,t,i){if(e.soft)k.Warn("Cannot be applied to a soft body");else{e.physicsBody.activate();const s=this._tmpAmmoVectorA,r=this._tmpAmmoVectorB;e.object&&e.object.getWorldMatrix&&i.subtractInPlace(e.object.getWorldMatrix().getTranslation()),s.setValue(i.x,i.y,i.z),r.setValue(t.x,t.y,t.z),e.physicsBody.applyImpulse(r,s)}}applyForce(e,t,i){if(e.soft)k.Warn("Cannot be applied to a soft body");else{e.physicsBody.activate();const s=this._tmpAmmoVectorA,r=this._tmpAmmoVectorB;if(e.object&&e.object.getWorldMatrix){const t=e.object.getWorldMatrix().getTranslation();s.setValue(i.x-t.x,i.y-t.y,i.z-t.z)}else s.setValue(i.x,i.y,i.z);r.setValue(t.x,t.y,t.z),e.physicsBody.applyForce(r,s)}}generatePhysicsBody(e){if(e._pluginData.toDispose=[],e.parent)e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());else if(e.isBodyInitRequired()){const t=this._createShape(e),i=e.getParam("mass");if(e._pluginData.mass=i,e.soft)t.get_m_cfg().set_collisions(17),t.get_m_cfg().set_kDP(e.getParam("damping")),this.bjsAMMO.castObject(t,this.bjsAMMO.btCollisionObject).getCollisionShape().setMargin(e.getParam("margin")),t.setActivationState(i_._DISABLE_DEACTIVATION_FLAG),this.world.addSoftBody(t,1,-1),e.physicsBody=t,e._pluginData.toDispose.push(t),this.setBodyPressure(e,0),e.type===Wr.SoftbodyImpostor&&this.setBodyPressure(e,e.getParam("pressure")),this.setBodyStiffness(e,e.getParam("stiffness")),this.setBodyVelocityIterations(e,e.getParam("velocityIterations")),this.setBodyPositionIterations(e,e.getParam("positionIterations"));else{const s=new this.bjsAMMO.btVector3(0,0,0),r=new this.bjsAMMO.btTransform;e.object.computeWorldMatrix(!0),r.setIdentity(),0!==i&&t.calculateLocalInertia(i,s),this._tmpAmmoVectorA.setValue(e.object.position.x,e.object.position.y,e.object.position.z),this._tmpAmmoQuaternion.setValue(e.object.rotationQuaternion.x,e.object.rotationQuaternion.y,e.object.rotationQuaternion.z,e.object.rotationQuaternion.w),r.setOrigin(this._tmpAmmoVectorA),r.setRotation(this._tmpAmmoQuaternion);const n=new this.bjsAMMO.btDefaultMotionState(r),o=new this.bjsAMMO.btRigidBodyConstructionInfo(i,n,t,s),a=new this.bjsAMMO.btRigidBody(o);if(0===i&&(a.setCollisionFlags(a.getCollisionFlags()|i_._KINEMATIC_FLAG),a.setActivationState(i_._DISABLE_DEACTIVATION_FLAG)),e.type!=Wr.NoImpostor||t.getChildShape||a.setCollisionFlags(a.getCollisionFlags()|i_._DISABLE_COLLISION_FLAG),e.type!==Wr.MeshImpostor&&e.type!==Wr.NoImpostor){const t=e.object.getBoundingInfo();this._tmpVec3.copyFrom(e.object.getAbsolutePosition()),this._tmpVec3.subtractInPlace(t.boundingBox.centerWorld),this._tmpVec3.x/=e.object.scaling.x,this._tmpVec3.y/=e.object.scaling.y,this._tmpVec3.z/=e.object.scaling.z,e.setDeltaPosition(this._tmpVec3)}const l=e.getParam("group"),h=e.getParam("mask");l&&h?this.world.addRigidBody(a,l,h):this.world.addRigidBody(a),e.physicsBody=a,e._pluginData.toDispose=e._pluginData.toDispose.concat([a,o,n,r,s,t])}this.setBodyRestitution(e,e.getParam("restitution")),this.setBodyFriction(e,e.getParam("friction"))}}removePhysicsBody(e){this.world&&(e.soft?this.world.removeSoftBody(e.physicsBody):this.world.removeRigidBody(e.physicsBody),e._pluginData&&(e._pluginData.toDispose.forEach((e=>{this.bjsAMMO.destroy(e)})),e._pluginData.toDispose=[]))}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;const s=e.joint.jointData;let r;switch(s.mainPivot||(s.mainPivot=new S(0,0,0)),s.connectedPivot||(s.connectedPivot=new S(0,0,0)),e.joint.type){case zr.DistanceJoint:{const e=s.maxDistance;e&&(s.mainPivot=new S(0,-e/2,0),s.connectedPivot=new S(0,e/2,0)),r=new this.bjsAMMO.btPoint2PointConstraint(t,i,new this.bjsAMMO.btVector3(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z),new this.bjsAMMO.btVector3(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z));break}case zr.HingeJoint:{s.mainAxis||(s.mainAxis=new S(0,0,0)),s.connectedAxis||(s.connectedAxis=new S(0,0,0));const e=new this.bjsAMMO.btVector3(s.mainAxis.x,s.mainAxis.y,s.mainAxis.z),n=new this.bjsAMMO.btVector3(s.connectedAxis.x,s.connectedAxis.y,s.connectedAxis.z);r=new this.bjsAMMO.btHingeConstraint(t,i,new this.bjsAMMO.btVector3(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z),new this.bjsAMMO.btVector3(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z),e,n);break}case zr.BallAndSocketJoint:r=new this.bjsAMMO.btPoint2PointConstraint(t,i,new this.bjsAMMO.btVector3(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z),new this.bjsAMMO.btVector3(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z));break;default:k.Warn("JointType not currently supported by the Ammo plugin, falling back to PhysicsJoint.BallAndSocketJoint"),r=new this.bjsAMMO.btPoint2PointConstraint(t,i,new this.bjsAMMO.btVector3(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z),new this.bjsAMMO.btVector3(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z))}this.world.addConstraint(r,!e.joint.jointData.collision),e.joint.physicsJoint=r}removeJoint(e){this.world&&this.world.removeConstraint(e.joint.physicsJoint)}_addMeshVerts(e,t,i){let s=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let r=i.getIndices();r||(r=[]);let n,o=i.getVerticesData(hi.PositionKind);if(o||(o=[]),t&&t!==i){let e;e=t.rotationQuaternion?t.rotationQuaternion:t.rotation?C.FromEulerAngles(t.rotation.x,t.rotation.y,t.rotation.z):C.Identity(),y.Compose(S.One(),e,t.position).invertToRef(this._tmpMatrix),n=i.computeWorldMatrix(!1).multiply(this._tmpMatrix)}else y.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,this._tmpMatrix),n=this._tmpMatrix;const a=r.length/3;for(let t=0;t<a;t++){const i=[];for(let e=0;e<3;e++){let s,a=new S(o[3*r[3*t+e]+0],o[3*r[3*t+e]+1],o[3*r[3*t+e]+2]);a=S.TransformCoordinates(a,n),s=0==e?this._tmpAmmoVectorA:1==e?this._tmpAmmoVectorB:this._tmpAmmoVectorC,s.setValue(a.x,a.y,a.z),i.push(s)}e.addTriangle(i[0],i[1],i[2]),s++}i.getChildMeshes().forEach((i=>{s+=this._addMeshVerts(e,t,i)}))}return s}_softVertexData(e){const t=e.object;if(t&&t.getIndices&&t.getWorldMatrix&&t.getChildMeshes){let e=t.getIndices();e||(e=[]);let i=t.getVerticesData(hi.PositionKind);i||(i=[]);let s=t.getVerticesData(hi.NormalKind);s||(s=[]),t.computeWorldMatrix(!1);const r=[],n=[];for(let e=0;e<i.length;e+=3){let o=new S(i[e],i[e+1],i[e+2]),a=new S(s[e],s[e+1],s[e+2]);o=S.TransformCoordinates(o,t.getWorldMatrix()),a=S.TransformNormal(a,t.getWorldMatrix()),r.push(o.x,o.y,o.z),n.push(a.x,a.y,a.z)}const o=new As;return o.positions=r,o.normals=n,o.uvs=t.getVerticesData(hi.UVKind),o.colors=t.getVerticesData(hi.ColorKind),t&&t.getIndices&&(o.indices=t.getIndices()),o.applyToMesh(t),t.position=S.Zero(),t.rotationQuaternion=null,t.rotation=S.Zero(),t.computeWorldMatrix(!0),o}return As.ExtractFromMesh(t)}_createSoftbody(e){const t=e.object;if(t&&t.getIndices){let i=t.getIndices();i||(i=[]);const s=this._softVertexData(e),r=s.positions,n=s.normals;if(null===r||null===n)return new this.bjsAMMO.btCompoundShape;{const e=[],s=[];for(let t=0;t<r.length;t+=3){const i=new S(r[t],r[t+1],r[t+2]),o=new S(n[t],n[t+1],n[t+2]);e.push(i.x,i.y,-i.z),s.push(o.x,o.y,-o.z)}const o=(new this.bjsAMMO.btSoftBodyHelpers).CreateFromTriMesh(this.world.getWorldInfo(),e,t.getIndices(),i.length/3,!0),a=r.length/3,l=o.get_m_nodes();let h,c;for(let e=0;e<a;e++)h=l.at(e),c=h.get_m_n(),c.setX(s[3*e]),c.setY(s[3*e+1]),c.setZ(s[3*e+2]);return o}}}_createCloth(e){const t=e.object;if(t&&t.getIndices){let i=t.getIndices();i||(i=[]);const s=this._softVertexData(e),r=s.positions,n=s.normals;if(null===r||null===n)return new this.bjsAMMO.btCompoundShape;{const t=r.length,i=Math.sqrt(t/3);e.segments=i;const s=i-1;return this._tmpAmmoVectorA.setValue(r[0],r[1],r[2]),this._tmpAmmoVectorB.setValue(r[3*s],r[3*s+1],r[3*s+2]),this._tmpAmmoVectorD.setValue(r[t-3],r[t-2],r[t-1]),this._tmpAmmoVectorC.setValue(r[t-3-3*s],r[t-2-3*s],r[t-1-3*s]),(new this.bjsAMMO.btSoftBodyHelpers).CreatePatch(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,this._tmpAmmoVectorC,this._tmpAmmoVectorD,i,i,e.getParam("fixedPoints"),!0)}}}_createRope(e){let t,i;const s=this._softVertexData(e),r=s.positions,n=s.normals;if(null===r||null===n)return new this.bjsAMMO.btCompoundShape;if(s.applyToMesh(e.object,!0),e._isFromLine=!0,0===n.map((e=>e*e)).reduce(((e,t)=>e+t)))t=r.length,i=t/3-1,this._tmpAmmoVectorA.setValue(r[0],r[1],r[2]),this._tmpAmmoVectorB.setValue(r[t-3],r[t-2],r[t-1]);else{e._isFromLine=!1;const s=e.getParam("path");if(null===e.getParam("shape"))return k.Warn("No shape available for extruded mesh"),new this.bjsAMMO.btCompoundShape;t=s.length,i=t-1,this._tmpAmmoVectorA.setValue(s[0].x,s[0].y,s[0].z),this._tmpAmmoVectorB.setValue(s[t-1].x,s[t-1].y,s[t-1].z)}e.segments=i;let o=e.getParam("fixedPoints");o=o>3?3:o;const a=(new this.bjsAMMO.btSoftBodyHelpers).CreateRope(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,i-1,o);return a.get_m_cfg().set_collisions(17),a}_createCustom(e){let t=null;return this.onCreateCustomShape&&(t=this.onCreateCustomShape(e)),null==t&&(t=new this.bjsAMMO.btCompoundShape),t}_addHullVerts(e,t,i){let s=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let r=i.getIndices();r||(r=[]);let n=i.getVerticesData(hi.PositionKind);n||(n=[]),i.computeWorldMatrix(!1);const o=r.length/3;for(let t=0;t<o;t++){const o=[];for(let e=0;e<3;e++){let s,a=new S(n[3*r[3*t+e]+0],n[3*r[3*t+e]+1],n[3*r[3*t+e]+2]);y.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,this._tmpMatrix),a=S.TransformCoordinates(a,this._tmpMatrix),s=0==e?this._tmpAmmoVectorA:1==e?this._tmpAmmoVectorB:this._tmpAmmoVectorC,s.setValue(a.x,a.y,a.z),o.push(s)}e.addPoint(o[0],!0),e.addPoint(o[1],!0),e.addPoint(o[2],!0),s++}i.getChildMeshes().forEach((i=>{s+=this._addHullVerts(e,t,i)}))}return s}_createShape(e,t=!1){const i=e.object;let s;const r=e.getObjectExtents();if(!t){const t=e.object.getChildMeshes?e.object.getChildMeshes(!0):[];s=new this.bjsAMMO.btCompoundShape;let i=0;if(t.forEach((e=>{const t=e.getPhysicsImpostor();if(t){if(t.type==Wr.MeshImpostor)throw"A child MeshImpostor is not supported. Only primitive impostors are supported as children (eg. box or sphere)";const r=this._createShape(t),n=e.parent.getWorldMatrix().clone(),o=new S;n.decompose(o),this._tmpAmmoTransform.getOrigin().setValue(e.position.x*o.x,e.position.y*o.y,e.position.z*o.z),this._tmpAmmoQuaternion.setValue(e.rotationQuaternion.x,e.rotationQuaternion.y,e.rotationQuaternion.z,e.rotationQuaternion.w),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),s.addChildShape(this._tmpAmmoTransform,r),t.dispose(),i++}})),i>0){if(e.type!=Wr.NoImpostor){const t=this._createShape(e,!0);t&&(this._tmpAmmoTransform.getOrigin().setValue(0,0,0),this._tmpAmmoQuaternion.setValue(0,0,0,1),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),s.addChildShape(this._tmpAmmoTransform,t))}return s}this.bjsAMMO.destroy(s),s=null}switch(e.type){case Wr.SphereImpostor:if(l.WithinEpsilon(r.x,r.y,1e-4)&&l.WithinEpsilon(r.x,r.z,1e-4))s=new this.bjsAMMO.btSphereShape(r.x/2);else{const e=[new this.bjsAMMO.btVector3(0,0,0)],t=[1];s=new this.bjsAMMO.btMultiSphereShape(e,t,1),s.setLocalScaling(new this.bjsAMMO.btVector3(r.x/2,r.y/2,r.z/2))}break;case Wr.CapsuleImpostor:{const e=r.x/2;s=new this.bjsAMMO.btCapsuleShape(e,r.y-2*e)}break;case Wr.CylinderImpostor:this._tmpAmmoVectorA.setValue(r.x/2,r.y/2,r.z/2),s=new this.bjsAMMO.btCylinderShape(this._tmpAmmoVectorA);break;case Wr.PlaneImpostor:case Wr.BoxImpostor:this._tmpAmmoVectorA.setValue(r.x/2,r.y/2,r.z/2),s=new this.bjsAMMO.btBoxShape(this._tmpAmmoVectorA);break;case Wr.MeshImpostor:if(0==e.getParam("mass")){if(this.onCreateCustomMeshImpostor)s=this.onCreateCustomMeshImpostor(e);else{const t=new this.bjsAMMO.btTriangleMesh;e._pluginData.toDispose.push(t);const r=this._addMeshVerts(t,i,i);s=0==r?new this.bjsAMMO.btCompoundShape:new this.bjsAMMO.btBvhTriangleMeshShape(t)}break}case Wr.ConvexHullImpostor:if(this.onCreateCustomConvexHullImpostor)s=this.onCreateCustomConvexHullImpostor(e);else{const t=new this.bjsAMMO.btConvexHullShape;0==this._addHullVerts(t,i,i)?(e._pluginData.toDispose.push(t),s=new this.bjsAMMO.btCompoundShape):s=t}break;case Wr.NoImpostor:s=new this.bjsAMMO.btSphereShape(r.x/2);break;case Wr.CustomImpostor:s=this._createCustom(e);break;case Wr.SoftbodyImpostor:s=this._createSoftbody(e);break;case Wr.ClothImpostor:s=this._createCloth(e);break;case Wr.RopeImpostor:s=this._createRope(e);break;default:k.Warn("The impostor type is not currently supported by the ammo plugin.")}return s}setTransformationFromPhysicsBody(e){e.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),e.object.position.set(this._tmpAmmoTransform.getOrigin().x(),this._tmpAmmoTransform.getOrigin().y(),this._tmpAmmoTransform.getOrigin().z()),e.object.rotationQuaternion?e.object.rotationQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()):e.object.rotation&&(this._tmpQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()),this._tmpQuaternion.toEulerAnglesToRef(e.object.rotation))}setPhysicsBodyTransformation(e,t,i){const s=e.physicsBody.getWorldTransform();if(Math.abs(s.getOrigin().x()-t.x)>u||Math.abs(s.getOrigin().y()-t.y)>u||Math.abs(s.getOrigin().z()-t.z)>u||Math.abs(s.getRotation().x()-i.x)>u||Math.abs(s.getRotation().y()-i.y)>u||Math.abs(s.getRotation().z()-i.z)>u||Math.abs(s.getRotation().w()-i.w)>u)if(this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),s.setOrigin(this._tmpAmmoVectorA),this._tmpAmmoQuaternion.setValue(i.x,i.y,i.z,i.w),s.setRotation(this._tmpAmmoQuaternion),e.physicsBody.setWorldTransform(s),0==e.mass){const t=e.physicsBody.getMotionState();t&&t.setWorldTransform(s)}else e.physicsBody.activate()}isSupported(){return void 0!==this.bjsAMMO}setLinearVelocity(e,t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),e.soft?e.physicsBody.linearVelocity(this._tmpAmmoVectorA):e.physicsBody.setLinearVelocity(this._tmpAmmoVectorA)}setAngularVelocity(e,t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),e.soft?e.physicsBody.angularVelocity(this._tmpAmmoVectorA):e.physicsBody.setAngularVelocity(this._tmpAmmoVectorA)}getLinearVelocity(e){let t;if(t=e.soft?e.physicsBody.linearVelocity():e.physicsBody.getLinearVelocity(),!t)return null;const i=new S(t.x(),t.y(),t.z());return this.bjsAMMO.destroy(t),i}getAngularVelocity(e){let t;if(t=e.soft?e.physicsBody.angularVelocity():e.physicsBody.getAngularVelocity(),!t)return null;const i=new S(t.x(),t.y(),t.z());return this.bjsAMMO.destroy(t),i}setBodyMass(e,t){e.soft?e.physicsBody.setTotalMass(t,!1):e.physicsBody.setMassProps(t),e._pluginData.mass=t}getBodyMass(e){return e._pluginData.mass||0}getBodyFriction(e){return e._pluginData.friction||0}setBodyFriction(e,t){e.soft?e.physicsBody.get_m_cfg().set_kDF(t):e.physicsBody.setFriction(t),e._pluginData.friction=t}getBodyRestitution(e){return e._pluginData.restitution||0}setBodyRestitution(e,t){e.physicsBody.setRestitution(t),e._pluginData.restitution=t}getBodyPressure(e){return e.soft?e._pluginData.pressure||0:(k.Warn("Pressure is not a property of a rigid body"),0)}setBodyPressure(e,t){e.soft?e.type===Wr.SoftbodyImpostor?(e.physicsBody.get_m_cfg().set_kPR(t),e._pluginData.pressure=t):(e.physicsBody.get_m_cfg().set_kPR(0),e._pluginData.pressure=0):k.Warn("Pressure can only be applied to a softbody")}getBodyStiffness(e){return e.soft?e._pluginData.stiffness||0:(k.Warn("Stiffness is not a property of a rigid body"),0)}setBodyStiffness(e,t){e.soft?(t=(t=t<0?0:t)>1?1:t,e.physicsBody.get_m_materials().at(0).set_m_kLST(t),e._pluginData.stiffness=t):k.Warn("Stiffness cannot be applied to a rigid body")}getBodyVelocityIterations(e){return e.soft?e._pluginData.velocityIterations||0:(k.Warn("Velocity iterations is not a property of a rigid body"),0)}setBodyVelocityIterations(e,t){e.soft?(t=t<0?0:t,e.physicsBody.get_m_cfg().set_viterations(t),e._pluginData.velocityIterations=t):k.Warn("Velocity iterations cannot be applied to a rigid body")}getBodyPositionIterations(e){return e.soft?e._pluginData.positionIterations||0:(k.Warn("Position iterations is not a property of a rigid body"),0)}setBodyPositionIterations(e,t){e.soft?(t=t<0?0:t,e.physicsBody.get_m_cfg().set_piterations(t),e._pluginData.positionIterations=t):k.Warn("Position iterations cannot be applied to a rigid body")}appendAnchor(e,t,i,s,r=1,n=!1){const o=e.segments,a=Math.round((o-1)*i)+o*(o-1-Math.round((o-1)*s));e.physicsBody.appendAnchor(a,t.physicsBody,n,r)}appendHook(e,t,i,s=1,r=!1){const n=Math.round(e.segments*i);e.physicsBody.appendAnchor(n,t.physicsBody,r,s)}sleepBody(e){e.physicsBody.forceActivationState(0)}wakeUpBody(e){e.physicsBody.activate()}updateDistanceJoint(){k.Warn("updateDistanceJoint is not currently supported by the Ammo physics plugin")}setMotor(e,t,i){e.physicsJoint.enableAngularMotor(!0,t,i)}setLimit(){k.Warn("setLimit is not currently supported by the Ammo physics plugin")}syncMeshWithImpostor(e,t){t.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),e.position.x=this._tmpAmmoTransform.getOrigin().x(),e.position.y=this._tmpAmmoTransform.getOrigin().y(),e.position.z=this._tmpAmmoTransform.getOrigin().z(),e.rotationQuaternion&&(e.rotationQuaternion.x=this._tmpAmmoTransform.getRotation().x(),e.rotationQuaternion.y=this._tmpAmmoTransform.getRotation().y(),e.rotationQuaternion.z=this._tmpAmmoTransform.getRotation().z(),e.rotationQuaternion.w=this._tmpAmmoTransform.getRotation().w())}getRadius(e){return e.getObjectExtents().x/2}getBoxSizeToRef(e,t){const i=e.getObjectExtents();t.x=i.x,t.y=i.y,t.z=i.z}dispose(){this.bjsAMMO.destroy(this.world),this.bjsAMMO.destroy(this._solver),this.bjsAMMO.destroy(this._overlappingPairCache),this.bjsAMMO.destroy(this._dispatcher),this.bjsAMMO.destroy(this._collisionConfiguration),this.bjsAMMO.destroy(this._tmpAmmoVectorA),this.bjsAMMO.destroy(this._tmpAmmoVectorB),this.bjsAMMO.destroy(this._tmpAmmoVectorC),this.bjsAMMO.destroy(this._tmpAmmoTransform),this.bjsAMMO.destroy(this._tmpAmmoQuaternion),this.bjsAMMO.destroy(this._tmpAmmoConcreteContactResultCallback),this.world=null}raycast(e,t){return this.raycastToRef(e,t,this._raycastResult),this._raycastResult}raycastToRef(e,t,i){this._tmpAmmoVectorRCA=new this.bjsAMMO.btVector3(e.x,e.y,e.z),this._tmpAmmoVectorRCB=new this.bjsAMMO.btVector3(t.x,t.y,t.z);const s=new this.bjsAMMO.ClosestRayResultCallback(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB);this.world.rayTest(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB,s),i.reset(e,t),s.hasHit()&&(i.setHitData({x:s.get_m_hitNormalWorld().x(),y:s.get_m_hitNormalWorld().y(),z:s.get_m_hitNormalWorld().z()},{x:s.get_m_hitPointWorld().x(),y:s.get_m_hitPointWorld().y(),z:s.get_m_hitPointWorld().z()}),i.calculateHitDistance()),this.bjsAMMO.destroy(s),this.bjsAMMO.destroy(this._tmpAmmoVectorRCA),this.bjsAMMO.destroy(this._tmpAmmoVectorRCB)}}i_._DISABLE_COLLISION_FLAG=4,i_._KINEMATIC_FLAG=2,i_._DISABLE_DEACTIVATION_FLAG=4,s.prototype.removeReflectionProbe=function(e){if(!this.reflectionProbes)return-1;const t=this.reflectionProbes.indexOf(e);return-1!==t&&this.reflectionProbes.splice(t,1),t},s.prototype.addReflectionProbe=function(e){this.reflectionProbes||(this.reflectionProbes=[]),this.reflectionProbes.push(e)};class s_{constructor(e,t,i,s=!0,r=!1,n=!1){if(this.name=e,this._viewMatrix=y.Identity(),this._target=S.Zero(),this._add=S.Zero(),this._invertYAxis=!1,this.position=S.Zero(),this.metadata=null,this._parentContainer=null,this._scene=i,i.getEngine().supportsUniformBuffers){this._sceneUBOs=[];for(let t=0;t<6;++t)this._sceneUBOs.push(i.createSceneUniformBuffer(`Scene for Reflection Probe (name "${e}") face #${t}`))}this._scene.reflectionProbes||(this._scene.reflectionProbes=[]),this._scene.reflectionProbes.push(this);let o=0;if(r){const e=this._scene.getEngine().getCaps();e.textureHalfFloatRender?o=2:e.textureFloatRender&&(o=1)}this._renderTargetTexture=new Bn(e,t,i,s,!0,o,!0),this._renderTargetTexture.gammaSpace=!n,this._renderTargetTexture.invertZ=i.useRightHandedSystem;const a=i.getEngine().useReverseDepthBuffer;let l;this._renderTargetTexture.onBeforeRenderObservable.add((e=>{switch(this._sceneUBOs&&(i.setSceneUniformBuffer(this._sceneUBOs[e]),i.getSceneUniformBuffer().unbindEffect()),e){case 0:this._add.copyFromFloats(1,0,0);break;case 1:this._add.copyFromFloats(-1,0,0);break;case 2:this._add.copyFromFloats(0,this._invertYAxis?1:-1,0);break;case 3:this._add.copyFromFloats(0,this._invertYAxis?-1:1,0);break;case 4:this._add.copyFromFloats(0,0,i.useRightHandedSystem?-1:1);break;case 5:this._add.copyFromFloats(0,0,i.useRightHandedSystem?1:-1)}this._attachedMesh&&this.position.copyFrom(this._attachedMesh.getAbsolutePosition()),this.position.addToRef(this._add,this._target);const t=i.useRightHandedSystem?y.LookAtRHToRef:y.LookAtLHToRef,s=i.useRightHandedSystem?y.PerspectiveFovRH:y.PerspectiveFovLH;t(this.position,this._target,S.Up(),this._viewMatrix),i.activeCamera&&(this._projectionMatrix=s(Math.PI/2,1,a?i.activeCamera.maxZ:i.activeCamera.minZ,a?i.activeCamera.minZ:i.activeCamera.maxZ,this._scene.getEngine().isNDCHalfZRange),i.setTransformMatrix(this._viewMatrix,this._projectionMatrix),i.activeCamera.isRigCamera&&!this._renderTargetTexture.activeCamera&&(this._renderTargetTexture.activeCamera=i.activeCamera.rigParent||null)),i._forcedViewPosition=this.position})),this._renderTargetTexture.onBeforeBindObservable.add((()=>{var t,s;this._currentSceneUBO=i.getSceneUniformBuffer(),null===(s=(t=i.getEngine())._debugPushGroup)||void 0===s||s.call(t,`reflection probe generation for ${e}`,1),l=this._scene.imageProcessingConfiguration.applyByPostProcess,n&&(i.imageProcessingConfiguration.applyByPostProcess=!0)})),this._renderTargetTexture.onAfterUnbindObservable.add((()=>{var e,t;i.imageProcessingConfiguration.applyByPostProcess=l,i._forcedViewPosition=null,this._sceneUBOs&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(!0),null===(t=(e=i.getEngine())._debugPopGroup)||void 0===t||t.call(e,1)}))}get samples(){return this._renderTargetTexture.samples}set samples(e){this._renderTargetTexture.samples=e}get refreshRate(){return this._renderTargetTexture.refreshRate}set refreshRate(e){this._renderTargetTexture.refreshRate=e}getScene(){return this._scene}get cubeTexture(){return this._renderTargetTexture}get renderList(){return this._renderTargetTexture.renderList}set renderList(e){this._renderTargetTexture.renderList=e}attachToMesh(e){this._attachedMesh=e}setRenderingAutoClearDepthStencil(e,t){this._renderTargetTexture.setRenderingAutoClearDepthStencil(e,t)}dispose(){const e=this._scene.reflectionProbes.indexOf(this);if(-1!==e&&this._scene.reflectionProbes.splice(e,1),this._parentContainer){const e=this._parentContainer.reflectionProbes.indexOf(this);e>-1&&this._parentContainer.reflectionProbes.splice(e,1),this._parentContainer=null}if(this._renderTargetTexture&&(this._renderTargetTexture.dispose(),this._renderTargetTexture=null),this._sceneUBOs){for(const e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}toString(e){let t="Name: "+this.name;return e&&(t+=", position: "+this.position.toString(),this._attachedMesh&&(t+=", attached mesh: "+this._attachedMesh.name)),t}getClassName(){return"ReflectionProbe"}serialize(){const e=de.Serialize(this,this._renderTargetTexture.serialize());return e.isReflectionProbe=!0,e.metadata=this.metadata,e}static Parse(e,t,i){let s=null;if(t.reflectionProbes)for(let i=0;i<t.reflectionProbes.length;i++){const r=t.reflectionProbes[i];if(r.name===e.name){s=r;break}}return s=de.Parse((()=>s||new s_(e.name,e.renderTargetSize,t,e._generateMipMaps)),e,t,i),s.cubeTexture._waitingRenderList=e.renderList,e._attachedMesh&&s.attachToMesh(t.getMeshById(e._attachedMesh)),e.metadata&&(s.metadata=e.metadata),s}}me([le()],s_.prototype,"_attachedMesh",void 0),me([ae()],s_.prototype,"position",void 0);class r_{}r_.LoaderInjectedPhysicsEngine=void 0;let n_={},o_={};const a_=(e,t,i,s)=>{if(!t.materials)return null;for(let r=0,n=t.materials.length;r<n;r++){const n=t.materials[r];if(e(n))return{parsedMaterial:n,material:sr.Parse(n,i,s)}}return null},l_=(e,t,i)=>{for(const s in t)if(e.name===t[s])return i.push(e.id),!0;return void 0!==e.parentId&&-1!==i.indexOf(e.parentId)&&(i.push(e.id),!0)},h_=(e,t)=>e+" of "+(t?t.file+" from "+t.name+" version: "+t.version+", exporter version: "+t.exporter_version:"unknown"),c_=(e,t)=>{const i=t;if(t._waitingData.lods){if(t._waitingData.lods.ids&&t._waitingData.lods.ids.length>0){const s=t._waitingData.lods.ids,r=i.isEnabled(!1);if(t._waitingData.lods.distances){const n=t._waitingData.lods.distances;if(n.length>=s.length){const t=n.length>s.length?n[n.length-1]:0;i.setEnabled(!1);for(let t=0;t<s.length;t++){const r=s[t],o=e.getMeshById(r);null!=o&&i.addLODLevel(n[t],o)}t>0&&i.addLODLevel(t,null),!0===r&&i.setEnabled(!0)}else Ht.Warn("Invalid level of detail distances for "+t.name)}}t._waitingData.lods=null}},u_=(e,t,i)=>{if("number"!=typeof e){const s=i.getLastEntryById(e);return s&&null!=t?s.instances[parseInt(t)]:s}const s=n_[e];return s&&null!=t?s.instances[parseInt(t)]:s},d_=(e,t)=>"number"!=typeof e?t.getLastMaterialById(e,!0):o_[e],p_=(e,t,i,r,n=!1)=>{const o=new mr(e);let a="importScene has failed JSON parse";try{var l=JSON.parse(t);a="";const r=Hr.loggingLevel===Hr.DETAILED_LOGGING;let n,h;if(void 0!==l.environmentTexture&&null!==l.environmentTexture){const t=void 0===l.isPBR||l.isPBR;if(l.environmentTextureType&&"BABYLON.HDRCubeTexture"===l.environmentTextureType){const s=l.environmentTextureSize?l.environmentTextureSize:128,r=new Kp((l.environmentTexture.match(/https?:\/\//g)?"":i)+l.environmentTexture,e,s,!0,!t,void 0,l.environmentTexturePrefilterOnLoad);l.environmentTextureRotationY&&(r.rotationY=l.environmentTextureRotationY),e.environmentTexture=r}else if("object"==typeof l.environmentTexture){const t=ud.Parse(l.environmentTexture,e,i);e.environmentTexture=t}else if(l.environmentTexture.endsWith(".env")){const t=new ud((l.environmentTexture.match(/https?:\/\//g)?"":i)+l.environmentTexture,e,l.environmentTextureForcedExtension);l.environmentTextureRotationY&&(t.rotationY=l.environmentTextureRotationY),e.environmentTexture=t}else{const t=ud.CreateFromPrefilteredData((l.environmentTexture.match(/https?:\/\//g)?"":i)+l.environmentTexture,e,l.environmentTextureForcedExtension);l.environmentTextureRotationY&&(t.rotationY=l.environmentTextureRotationY),e.environmentTexture=t}if(!0===l.createDefaultSkybox){const i=void 0!==e.activeCamera&&null!==e.activeCamera?(e.activeCamera.maxZ-e.activeCamera.minZ)/2:1e3,s=l.skyboxBlurLevel||0;e.createDefaultSkybox(e.environmentTexture,t,i,s)}o.environmentTexture=e.environmentTexture}if(void 0!==l.environmentIntensity&&null!==l.environmentIntensity&&(e.environmentIntensity=l.environmentIntensity),void 0!==l.lights&&null!==l.lights)for(n=0,h=l.lights.length;n<h;n++){const t=l.lights[n],i=pr.Parse(t,e);i&&(n_[t.uniqueId]=i,o.lights.push(i),i._parentContainer=o,a+=0===n?"\n\tLights:":"",a+="\n\t\t"+i.toString(r))}if(void 0!==l.reflectionProbes&&null!==l.reflectionProbes)for(n=0,h=l.reflectionProbes.length;n<h;n++){const t=l.reflectionProbes[n],s=s_.Parse(t,e,i);s&&(o.reflectionProbes.push(s),s._parentContainer=o,a+=0===n?"\n\tReflection Probes:":"",a+="\n\t\t"+s.toString(r))}if(void 0!==l.animations&&null!==l.animations)for(n=0,h=l.animations.length;n<h;n++){const t=l.animations[n],i=g("BABYLON.Animation");if(i){const s=i.Parse(t);e.animations.push(s),o.animations.push(s),a+=0===n?"\n\tAnimations:":"",a+="\n\t\t"+s.toString(r)}}if(void 0!==l.materials&&null!==l.materials)for(n=0,h=l.materials.length;n<h;n++){const t=l.materials[n],s=sr.Parse(t,e,i);s&&(o_[t.uniqueId||t.id]=s,o.materials.push(s),s._parentContainer=o,a+=0===n?"\n\tMaterials:":"",a+="\n\t\t"+s.toString(r),s.getActiveTextures().forEach((e=>{-1==o.textures.indexOf(e)&&(o.textures.push(e),e._parentContainer=o)})))}if(void 0!==l.multiMaterials&&null!==l.multiMaterials)for(n=0,h=l.multiMaterials.length;n<h;n++){const t=l.multiMaterials[n],i=rr.ParseMultiMaterial(t,e);o_[t.uniqueId||t.id]=i,o.multiMaterials.push(i),i._parentContainer=o,a+=0===n?"\n\tMultiMaterials:":"",a+="\n\t\t"+i.toString(r),i.getActiveTextures().forEach((e=>{-1==o.textures.indexOf(e)&&(o.textures.push(e),e._parentContainer=o)}))}if(void 0!==l.morphTargetManagers&&null!==l.morphTargetManagers)for(const t of l.morphTargetManagers){const i=Qp.Parse(t,e);o.morphTargetManagers.push(i),i._parentContainer=o}if(void 0!==l.skeletons&&null!==l.skeletons)for(n=0,h=l.skeletons.length;n<h;n++){const t=l.skeletons[n],i=no.Parse(t,e);o.skeletons.push(i),i._parentContainer=o,a+=0===n?"\n\tSkeletons:":"",a+="\n\t\t"+i.toString(r)}const c=l.geometries;if(null!=c){const t=new Array,s=c.vertexData;if(null!=s)for(n=0,h=s.length;n<h;n++){const r=s[n];t.push(Ps.Parse(r,e,i))}t.forEach((e=>{e&&(o.geometries.push(e),e._parentContainer=o)}))}if(void 0!==l.transformNodes&&null!==l.transformNodes)for(n=0,h=l.transformNodes.length;n<h;n++){const t=l.transformNodes[n],s=ws.Parse(t,e,i);n_[t.uniqueId]=s,o.transformNodes.push(s),s._parentContainer=o}if(void 0!==l.meshes&&null!==l.meshes)for(n=0,h=l.meshes.length;n<h;n++){const t=l.meshes[n],s=ur.Parse(t,e,i);if(n_[t.uniqueId]=s,o.meshes.push(s),s._parentContainer=o,s.hasInstances)for(const e of s.instances)o.meshes.push(e),e._parentContainer=o;a+=0===n?"\n\tMeshes:":"",a+="\n\t\t"+s.toString(r)}if(void 0!==l.cameras&&null!==l.cameras)for(n=0,h=l.cameras.length;n<h;n++){const t=l.cameras[n],i=ps.Parse(t,e);n_[t.uniqueId]=i,o.cameras.push(i),i._parentContainer=o,a+=0===n?"\n\tCameras:":"",a+="\n\t\t"+i.toString(r)}if(void 0!==l.postProcesses&&null!==l.postProcesses)for(n=0,h=l.postProcesses.length;n<h;n++){const t=l.postProcesses[n],s=dn.Parse(t,e,i);s&&(o.postProcesses.push(s),s._parentContainer=o,a+=0===n?"\nPostprocesses:":"",a+="\n\t\t"+s.toString())}if(void 0!==l.animationGroups&&null!==l.animationGroups)for(n=0,h=l.animationGroups.length;n<h;n++){const t=l.animationGroups[n],i=as.Parse(t,e);o.animationGroups.push(i),i._parentContainer=o,a+=0===n?"\n\tAnimationGroups:":"",a+="\n\t\t"+i.toString(r)}for(n=0,h=e.cameras.length;n<h;n++){const t=e.cameras[n];null!==t._waitingParentId&&(t.parent=u_(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null)}for(n=0,h=e.lights.length;n<h;n++){const t=e.lights[n];t&&null!==t._waitingParentId&&(t.parent=u_(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null)}for(n=0,h=e.transformNodes.length;n<h;n++){const t=e.transformNodes[n];null!==t._waitingParentId&&(t.parent=u_(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null)}for(n=0,h=e.meshes.length;n<h;n++){const t=e.meshes[n];null!==t._waitingParentId&&(t.parent=u_(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null),t._waitingData.lods&&c_(e,t)}for(e.multiMaterials.forEach((t=>{t._waitingSubMaterialsUniqueIds.forEach((i=>{t.subMaterials.push(d_(i,e))})),t._waitingSubMaterialsUniqueIds=[]})),e.meshes.forEach((t=>{null!==t._waitingMaterialId&&(t.material=d_(t._waitingMaterialId,e),t._waitingMaterialId=null)})),n=0,h=e.skeletons.length;n<h;n++){const t=e.skeletons[n];t._hasWaitingData&&(null!=t.bones&&t.bones.forEach((t=>{if(t._waitingTransformNodeId){const i=e.getLastEntryById(t._waitingTransformNodeId);i&&t.linkTransformNode(i),t._waitingTransformNodeId=null}})),t._hasWaitingData=null)}for(n=0,h=e.meshes.length;n<h;n++){const t=e.meshes[n];t._waitingData.freezeWorldMatrix?(t.freezeWorldMatrix(),t._waitingData.freezeWorldMatrix=null):t.computeWorldMatrix(!0)}for(n=0,h=e.lights.length;n<h;n++){const t=e.lights[n];if(t._excludedMeshesIds.length>0){for(let i=0;i<t._excludedMeshesIds.length;i++){const s=e.getMeshById(t._excludedMeshesIds[i]);s&&t.excludedMeshes.push(s)}t._excludedMeshesIds=[]}if(t._includedOnlyMeshesIds.length>0){for(let i=0;i<t._includedOnlyMeshesIds.length;i++){const s=e.getMeshById(t._includedOnlyMeshesIds[i]);s&&t.includedOnlyMeshes.push(s)}t._includedOnlyMeshesIds=[]}}for(e.geometries.forEach((e=>{e._loadedUniqueId=""})),s.Parse(l,e,o,i),n=0,h=e.meshes.length;n<h;n++){const t=e.meshes[n];t._waitingData.actions&&(X.Parse(t._waitingData.actions,t,e),t._waitingData.actions=null)}void 0!==l.actions&&null!==l.actions&&X.Parse(l.actions,null,e)}catch(e){const t=h_("loadAssets",l?l.producer:"Unknown")+a;if(!r)throw k.Log(t),e;r(t,e)}finally{n_={},o_={},n||o.removeAllFromScene(),null!==a&&Hr.loggingLevel!==Hr.NO_LOGGING&&k.Log(h_("loadAssets",l?l.producer:"Unknown")+(Hr.loggingLevel!==Hr.MINIMAL_LOGGING?a:""))}return o};Hr.RegisterPlugin({name:"babylon.js",extensions:".babylon",canDirectLoad:e=>-1!==e.indexOf("babylon"),importMesh:(e,t,i,r,n,o,a,l)=>{var h;let c="importMesh has failed JSON parse";try{var u=JSON.parse(i);c="";const l=Hr.loggingLevel===Hr.DETAILED_LOGGING;e?Array.isArray(e)||(e=[e]):e=null;const d=[],p=new Map,_=[];if(void 0!==u.transformNodes&&null!==u.transformNodes)for(let e=0,i=u.transformNodes.length;e<i;e++){const i=u.transformNodes[e],s=ws.Parse(i,t,r);_.push(s),p.set(s._waitingParsedUniqueId,s),s._waitingParsedUniqueId=null}if(void 0!==u.meshes&&null!==u.meshes){const i=[],s=[],o=[],f=[];for(let h=0,_=u.meshes.length;h<_;h++){const _=u.meshes[h];if(null===e||l_(_,e,d)){if(null!==e&&delete e[e.indexOf(_.name)],void 0!==_.geometryId&&null!==_.geometryId&&void 0!==u.geometries&&null!==u.geometries){let e=!1;["boxes","spheres","cylinders","toruses","grounds","planes","torusKnots","vertexData"].forEach((i=>{!0!==e&&u.geometries[i]&&Array.isArray(u.geometries[i])&&u.geometries[i].forEach((s=>{s.id===_.geometryId&&("vertexData"===i&&Ps.Parse(s,t,r),e=!0)}))})),!1===e&&k.Warn("Geometry not found for mesh "+_.id)}if(_.materialUniqueId||_.materialId){const e=_.materialUniqueId?o:s;let i=-1!==e.indexOf(_.materialUniqueId||_.materialId);if(!1===i&&void 0!==u.multiMaterials&&null!==u.multiMaterials){const s=(i,s)=>{e.push(i);const n=a_(s,u,t,r);n&&n.material&&(o_[n.parsedMaterial.uniqueId||n.parsedMaterial.id]=n.material,c+="\n\tMaterial "+n.material.toString(l))};for(let r=0,n=u.multiMaterials.length;r<n;r++){const n=u.multiMaterials[r];if(_.materialUniqueId&&n.uniqueId===_.materialUniqueId||n.id===_.materialId){n.materialsUniqueIds?n.materialsUniqueIds.forEach((e=>s(e,(t=>t.uniqueId===e)))):n.materials.forEach((e=>s(e,(t=>t.id===e)))),e.push(n.uniqueId||n.id);const r=rr.ParseMultiMaterial(n,t);o_[n.uniqueId||n.id]=r,r&&(i=!0,c+="\n\tMulti-Material "+r.toString(l));break}}}if(!1===i){e.push(_.materialUniqueId||_.materialId);const i=a_((e=>_.materialUniqueId&&e.uniqueId===_.materialUniqueId||e.id===_.materialId),u,t,r);i&&i.material?(o_[i.parsedMaterial.uniqueId||i.parsedMaterial.id]=i.material,c+="\n\tMaterial "+i.material.toString(l)):k.Warn("Material not found for mesh "+_.id)}}if(null!==_.skeletonId&&void 0!==_.skeletonId&&-1!==u.skeletonId&&void 0!==u.skeletons&&null!==u.skeletons&&!(i.indexOf(_.skeletonId)>-1))for(let e=0,s=u.skeletons.length;e<s;e++){const s=u.skeletons[e];if(s.id===_.skeletonId){const e=no.Parse(s,t);a.push(e),i.push(s.id),c+="\n\tSkeleton "+e.toString(l)}}if(_.morphTargetManagerId>-1&&void 0!==u.morphTargetManagers&&null!==u.morphTargetManagers&&!(f.indexOf(_.morphTargetManagerId)>-1))for(let e=0,i=u.morphTargetManagers.length;e<i;e++){const i=u.morphTargetManagers[e];if(i.id===_.morphTargetManagerId){const e=Qp.Parse(i,t);f.push(e.uniqueId),c+="\nMorph target "+e.toString()}}const h=ur.Parse(_,t,r);n.push(h),p.set(h._waitingParsedUniqueId,h),h._waitingParsedUniqueId=null,c+="\n\tMesh "+h.toString(l)}}t.multiMaterials.forEach((e=>{e._waitingSubMaterialsUniqueIds.forEach((i=>{e.subMaterials.push(d_(i,t))})),e._waitingSubMaterialsUniqueIds=[]})),t.meshes.forEach((e=>{null!==e._waitingMaterialId&&(e.material=d_(e._waitingMaterialId,t),e._waitingMaterialId=null)}));for(let e=0,i=t.transformNodes.length;e<i;e++){const i=t.transformNodes[e];if(null!==i._waitingParentId){let e=p.get(parseInt(i._waitingParentId))||null;null===e&&(e=t.getLastEntryById(i._waitingParentId));let s=e;i._waitingParentInstanceIndex&&(s=e.instances[parseInt(i._waitingParentInstanceIndex)],i._waitingParentInstanceIndex=null),i.parent=s,i._waitingParentId=null}}let m;for(let e=0,i=t.meshes.length;e<i;e++){if(m=t.meshes[e],m._waitingParentId){let e=p.get(parseInt(m._waitingParentId))||null;null===e&&(e=t.getLastEntryById(m._waitingParentId));let i=e;if(m._waitingParentInstanceIndex&&(i=e.instances[parseInt(m._waitingParentInstanceIndex)],m._waitingParentInstanceIndex=null),m.parent=i,"TransformNode"===(null===(h=m.parent)||void 0===h?void 0:h.getClassName())){const e=_.indexOf(m.parent);e>-1&&_.splice(e,1)}m._waitingParentId=null}m._waitingData.lods&&c_(t,m)}for(const e of _)e.dispose();for(let e=0,i=t.skeletons.length;e<i;e++){const i=t.skeletons[e];i._hasWaitingData&&(null!=i.bones&&i.bones.forEach((e=>{if(e._waitingTransformNodeId){const i=t.getLastEntryById(e._waitingTransformNodeId);i&&e.linkTransformNode(i),e._waitingTransformNodeId=null}})),i._hasWaitingData=null)}for(let e=0,i=t.meshes.length;e<i;e++)m=t.meshes[e],m._waitingData.freezeWorldMatrix?(m.freezeWorldMatrix(),m._waitingData.freezeWorldMatrix=null):m.computeWorldMatrix(!0)}if(void 0!==u.particleSystems&&null!==u.particleSystems){const e=s.GetIndividualParser(fi.NAME_PARTICLESYSTEM);if(e)for(let i=0,s=u.particleSystems.length;i<s;i++){const s=u.particleSystems[i];-1!==d.indexOf(s.emitterId)&&o.push(e(s,t,r))}}return t.geometries.forEach((e=>{e._loadedUniqueId=""})),!0}catch(e){const t=h_("importMesh",u?u.producer:"Unknown")+c;if(!l)throw k.Log(t),e;l(t,e)}finally{null!==c&&Hr.loggingLevel!==Hr.NO_LOGGING&&k.Log(h_("importMesh",u?u.producer:"Unknown")+(Hr.loggingLevel!==Hr.MINIMAL_LOGGING?c:"")),o_={}}return!1},load:(e,t,i,s)=>{let r="importScene has failed JSON parse";try{var n=JSON.parse(t);if(r="",void 0!==n.useDelayedTextureLoading&&null!==n.useDelayedTextureLoading&&(e.useDelayedTextureLoading=n.useDelayedTextureLoading&&!Hr.ForceFullSceneLoadingForIncremental),void 0!==n.autoClear&&null!==n.autoClear&&(e.autoClear=n.autoClear),void 0!==n.clearColor&&null!==n.clearColor&&(e.clearColor=F.FromArray(n.clearColor)),void 0!==n.ambientColor&&null!==n.ambientColor&&(e.ambientColor=N.FromArray(n.ambientColor)),void 0!==n.gravity&&null!==n.gravity&&(e.gravity=S.FromArray(n.gravity)),void 0!==n.useRightHandedSystem&&(e.useRightHandedSystem=!!n.useRightHandedSystem),n.fogMode&&0!==n.fogMode)switch(e.fogMode=n.fogMode,e.fogColor=N.FromArray(n.fogColor),e.fogStart=n.fogStart,e.fogEnd=n.fogEnd,e.fogDensity=n.fogDensity,r+="\tFog mode for scene:  ",e.fogMode){case 1:r+="exp\n";break;case 2:r+="exp2\n";break;case 3:r+="linear\n"}if(n.physicsEnabled){let t;"cannon"===n.physicsEngine||n.physicsEngine===e_.name?t=new e_(void 0,void 0,r_.LoaderInjectedPhysicsEngine):"oimo"===n.physicsEngine||n.physicsEngine===t_.name?t=new t_(void 0,r_.LoaderInjectedPhysicsEngine):"ammo"!==n.physicsEngine&&n.physicsEngine!==i_.name||(t=new i_(void 0,r_.LoaderInjectedPhysicsEngine,void 0)),r="\tPhysics engine "+(n.physicsEngine?n.physicsEngine:"oimo")+" enabled\n";const i=n.physicsGravity?S.FromArray(n.physicsGravity):null;e.enablePhysics(i,t)}return void 0!==n.metadata&&null!==n.metadata&&(e.metadata=n.metadata),void 0!==n.collisionsEnabled&&null!==n.collisionsEnabled&&(e.collisionsEnabled=n.collisionsEnabled),!!p_(e,t,i,s,!0)&&(n.autoAnimate&&e.beginAnimation(e,n.autoAnimateFrom,n.autoAnimateTo,n.autoAnimateLoop,n.autoAnimateSpeed||1),void 0!==n.activeCameraID&&null!==n.activeCameraID&&e.setActiveCameraById(n.activeCameraID),!0)}catch(e){const t=h_("importScene",n?n.producer:"Unknown")+r;if(!s)throw k.Log(t),e;s(t,e)}finally{null!==r&&Hr.loggingLevel!==Hr.NO_LOGGING&&k.Log(h_("importScene",n?n.producer:"Unknown")+(Hr.loggingLevel!==Hr.MINIMAL_LOGGING?r:""))}return!1},loadAssetContainer:(e,t,i,s)=>p_(e,t,i,s)});class __{get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,Ns.MarkAllMaterialsAsDirty(20))}constructor(e={}){this._isEnabled=!0,this.bias=void 0===e.bias?0:e.bias,this.power=void 0===e.power?1:e.power,this.leftColor=e.leftColor||N.White(),this.rightColor=e.rightColor||N.Black(),!1===e.isEnabled&&(this.isEnabled=!1)}clone(){const e=new __;return H.DeepCopy(this,e),e}equals(e){return e&&this.bias===e.bias&&this.power===e.power&&this.leftColor.equals(e.leftColor)&&this.rightColor.equals(e.rightColor)&&this.isEnabled===e.isEnabled}serialize(){return{isEnabled:this.isEnabled,leftColor:this.leftColor.asArray(),rightColor:this.rightColor.asArray(),bias:this.bias,power:this.power}}static Parse(e){return new __({isEnabled:e.isEnabled,leftColor:N.FromArray(e.leftColor),rightColor:N.FromArray(e.rightColor),bias:e.bias,power:e.power||1})}}de._FresnelParametersParser=__.Parse;class f_ extends Nd{get doubleSided(){return this._twoSidedLighting}set doubleSided(e){this._twoSidedLighting!==e&&(this._twoSidedLighting=e,this.backFaceCulling=!e,this._markAllSubMeshesAsTexturesDirty())}constructor(e,t){super(e,t),this.maxSimultaneousLights=4,this.disableLighting=!1,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.emissiveColor=new N(0,0,0),this.occlusionStrength=1,this.useLightmapAsShadowmap=!1,this._useAlphaFromAlbedoTexture=!0,this._useAmbientInGrayScale=!0}getClassName(){return"PBRBaseSimpleMaterial"}}me([ie(),te("_markAllSubMeshesAsLightsDirty")],f_.prototype,"maxSimultaneousLights",void 0),me([ie(),te("_markAllSubMeshesAsLightsDirty")],f_.prototype,"disableLighting",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty","_reflectionTexture")],f_.prototype,"environmentTexture",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],f_.prototype,"invertNormalMapX",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],f_.prototype,"invertNormalMapY",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty","_bumpTexture")],f_.prototype,"normalTexture",void 0),me([re("emissive"),te("_markAllSubMeshesAsTexturesDirty")],f_.prototype,"emissiveColor",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty")],f_.prototype,"emissiveTexture",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty","_ambientTextureStrength")],f_.prototype,"occlusionStrength",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty","_ambientTexture")],f_.prototype,"occlusionTexture",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty","_alphaCutOff")],f_.prototype,"alphaCutOff",void 0),me([ie()],f_.prototype,"doubleSided",null),me([se(),te("_markAllSubMeshesAsTexturesDirty",null)],f_.prototype,"lightmapTexture",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],f_.prototype,"useLightmapAsShadowmap",void 0);class m_ extends f_{constructor(e,t){super(e,t),this._useRoughnessFromMetallicTextureAlpha=!1,this._useRoughnessFromMetallicTextureGreen=!0,this._useMetallnessFromMetallicTextureBlue=!0,this.metallic=1,this.roughness=1}getClassName(){return"PBRMetallicRoughnessMaterial"}clone(e){const t=de.Clone((()=>new m_(e,this.getScene())),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=de.Serialize(this);return e.customType="BABYLON.PBRMetallicRoughnessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){const s=de.Parse((()=>new m_(e.name,t)),e,t,i);return e.clearCoat&&s.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&s.anisotropy.parse(e.anisotropy,t,i),e.brdf&&s.brdf.parse(e.brdf,t,i),e.sheen&&s.sheen.parse(e.sheen,t,i),e.subSurface&&s.subSurface.parse(e.subSurface,t,i),e.iridescence&&s.iridescence.parse(e.iridescence,t,i),s}}me([re(),te("_markAllSubMeshesAsTexturesDirty","_albedoColor")],m_.prototype,"baseColor",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],m_.prototype,"baseTexture",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],m_.prototype,"metallic",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],m_.prototype,"roughness",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty","_metallicTexture")],m_.prototype,"metallicRoughnessTexture",void 0),m("BABYLON.PBRMetallicRoughnessMaterial",m_);class g_ extends f_{get useMicroSurfaceFromReflectivityMapAlpha(){return this._useMicroSurfaceFromReflectivityMapAlpha}constructor(e,t){super(e,t),this._useMicroSurfaceFromReflectivityMapAlpha=!0}getClassName(){return"PBRSpecularGlossinessMaterial"}clone(e){const t=de.Clone((()=>new g_(e,this.getScene())),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=de.Serialize(this);return e.customType="BABYLON.PBRSpecularGlossinessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){const s=de.Parse((()=>new g_(e.name,t)),e,t,i);return e.clearCoat&&s.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&s.anisotropy.parse(e.anisotropy,t,i),e.brdf&&s.brdf.parse(e.brdf,t,i),e.sheen&&s.sheen.parse(e.sheen,t,i),e.subSurface&&s.subSurface.parse(e.subSurface,t,i),e.iridescence&&s.iridescence.parse(e.iridescence,t,i),s}}me([re("diffuse"),te("_markAllSubMeshesAsTexturesDirty","_albedoColor")],g_.prototype,"diffuseColor",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],g_.prototype,"diffuseTexture",void 0),me([re("specular"),te("_markAllSubMeshesAsTexturesDirty","_reflectivityColor")],g_.prototype,"specularColor",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty","_microSurface")],g_.prototype,"glossiness",void 0),me([se(),te("_markAllSubMeshesAsTexturesDirty","_reflectivityTexture")],g_.prototype,"specularGlossinessTexture",void 0),m("BABYLON.PBRSpecularGlossinessMaterial",g_);class v_ extends Cr{constructor(e,t,i=null){if(super(t),e)if(this._textureMatrix=y.Identity(),this.name=e,this.url=e,this._onLoad=i,this._texture=this._getFromCache(e,!0),this._texture)this._triggerOnLoad();else{const e=this.getScene();e&&e.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture()}}_triggerOnLoad(){this._onLoad&&this._onLoad()}getTextureMatrix(){return this._textureMatrix}_load3dlTexture(){const e=this._getEngine();let t;t=e._features.support3DTextures?e.createRawTexture3D(null,1,1,1,5,!1,!1,2,null,0):e.createRawTexture(null,1,1,5,!1,!1,2,null,0),this._texture=t,this._texture.isReady=!1,this.isCube=!1,this.is3D=e._features.support3DTextures,this.wrapU=0,this.wrapV=0,this.wrapR=0,this.anisotropicFilteringLevel=1;const i=i=>{if("string"!=typeof i)return;let s,r=null,n=null;const o=i.split("\n");let a=0,l=0,h=0,c=0,u=0;for(let e=0;e<o.length;e++){if(s=o[e],!v_._NoneEmptyLineRegex.test(s))continue;if(0===s.indexOf("#"))continue;const t=s.split(" ");if(0!==a){if(0!=a){const e=Math.max(parseInt(t[0]),0),i=Math.max(parseInt(t[1]),0),s=Math.max(parseInt(t[2]),0);u=Math.max(e,u),u=Math.max(i,u),u=Math.max(s,u);const r=4*(l+c*a+h*a*a);n&&(n[r+0]=e,n[r+1]=i,n[r+2]=s),h++,h%a==0&&(c++,h=0,c%a==0&&(l++,c=0))}}else a=t.length,r=new Uint8Array(a*a*a*4),n=new Float32Array(a*a*a*4)}if(n&&r)for(let e=0;e<n.length;e++)if(e>0&&(e+1)%4==0)r[e]=255;else{const t=n[e];r[e]=t/u*255}t.is3D?(t.updateSize(a,a,a),e.updateRawTexture3D(t,r,5,!1)):(t.updateSize(a*a,a),e.updateRawTexture(t,r,5,!1)),t.isReady=!0,this._triggerOnLoad()},s=this.getScene();return s?s._loadFile(this.url,i):e._loadFile(this.url,i),this._texture}_loadTexture(){this.url&&this.url.toLocaleLowerCase().indexOf(".3dl")==this.url.length-4&&this._load3dlTexture()}clone(){const e=new v_(this.url,this.getScene()||this._getEngine());return e.level=this.level,e}delayLoad(){4===this.delayLoadState&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,!0),this._texture||this._loadTexture())}static Parse(e,t){let i=null;return e.name&&!e.isRenderTarget&&(i=new v_(e.name,t),i.name=e.name,i.level=e.level),i}serialize(){if(!this.name)return null;const e={};return e.name=this.name,e.level=this.level,e.customType="BABYLON.ColorGradingTexture",e}}v_._NoneEmptyLineRegex=/\S+/,m("BABYLON.ColorGradingTexture",v_);class x_ extends Cr{constructor(e,t,i,s=!1,r=!0,n=null,o=null,a=!1){if(super(t),this._onLoad=null,this._onError=null,!e)throw new Error("Image url is not set");this._coordinatesMode=Ar.CUBIC_MODE,this.name=e,this.url=e,this._size=i,this._supersample=a,this._noMipmap=s,this.gammaSpace=r,this._onLoad=n,this._onError=o,this.hasAlpha=!1,this.isCube=!0,this._texture=this._getFromCache(e,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?n&&(this._texture.isReady?Ht.SetImmediate((()=>n())):this._texture.onLoadedObservable.add(n)):t.useDelayedTextureLoading?this.delayLoadState=4:this._loadImage((()=>this._loadTexture()),this._onError)}_loadImage(e,t){const i=this.getScene();if(!i)return;const s=i.getEngine().createRawCubeTexture(null,this._size,4,i.getEngine().getCaps().textureFloat?1:7,this._noMipmap,!1,3);s.generateMipMaps=!this._noMipmap,i.addPendingData(s),s.url=this.url,s.isReady=!1,i.getEngine()._internalTexturesCache.push(s),this._texture=s;const r=document.createElement("canvas");Dt(this.url,(t=>{this._width=t.width,this._height=t.height,r.width=this._width,r.height=this._height;const i=r.getContext("2d");i.drawImage(t,0,0);const s=i.getImageData(0,0,t.width,t.height);this._buffer=s.data.buffer,r.remove(),e()}),((e,r)=>{i.removePendingData(s),t&&t(`${this.getClassName()} could not be loaded`,r)}),i?i.offlineProvider:null)}_loadTexture(){const e=this.getScene();if(!e)return;const t=(()=>{const e=this._getFloat32ArrayFromArrayBuffer(this._buffer),t=Xp.ConvertPanoramaToCubemap(e,this._width,this._height,this._size,this._supersample),i=[];for(let e=0;e<6;e++){const s=t[x_._FacesMapping[e]];i.push(s)}return i})(),i=this._texture;e.getEngine().updateRawCubeTexture(i,t,i.format,i.type,i.invertY),i.isReady=!0,e.removePendingData(i),i.onLoadedObservable.notifyObservers(i),i.onLoadedObservable.clear(),this._onLoad&&this._onLoad()}_getFloat32ArrayFromArrayBuffer(e){const t=new DataView(e),i=new Float32Array(3*e.byteLength/4);let s=0;for(let r=0;r<e.byteLength;r++)(r+1)%4!=0&&(i[s++]=t.getUint8(r)/255);return i}getClassName(){return"EquiRectangularCubeTexture"}clone(){const e=this.getScene();if(!e)return this;const t=new x_(this.url,e,this._size,this._noMipmap,this.gammaSpace);return t.level=this.level,t.wrapU=this.wrapU,t.wrapV=this.wrapV,t.coordinatesIndex=this.coordinatesIndex,t.coordinatesMode=this.coordinatesMode,t}}x_._FacesMapping=["right","left","up","down","front","back"];class T_ extends Cr{constructor(e,t,i){var s,r;super(i.scene||i.engine),this.onLoadObservable=new a,t&&(i.engine||i.scene)&&(i=Object.assign(Object.assign({},T_._DefaultOptions),i),this._generateMipMaps=i.generateMipMaps,this._samplingMode=i.samplingMode,this._textureMatrix=y.Identity(),this._format=i.format,this.name=e,this.element=t,this._isVideo=!!t.getVideoPlaybackQuality,this._externalTexture=this._isVideo&&null!==(r=null===(s=this._engine)||void 0===s?void 0:s.createExternalTexture(t))&&void 0!==r?r:null,this.anisotropicFilteringLevel=1,this._createInternalTexture())}_createInternalTexture(){let e=0,t=0;this._isVideo?(e=this.element.videoWidth,t=this.element.videoHeight):(e=this.element.width,t=this.element.height);const i=this._getEngine();i&&(this._texture=i.createDynamicTexture(e,t,this._generateMipMaps,this._samplingMode),this._texture.format=this._format),this.update()}getTextureMatrix(){return this._textureMatrix}update(e=null){const t=this._getEngine();if(null==this._texture||null==t)return;const i=this.isReady();if(this._isVideo){const i=this.element;if(i.readyState<i.HAVE_CURRENT_DATA)return;t.updateVideoTexture(this._texture,this._externalTexture?this._externalTexture:i,null===e||e)}else{const i=this.element;t.updateDynamicTexture(this._texture,i,null===e||e,!1,this._format)}!i&&this.isReady()&&this.onLoadObservable.notifyObservers(this)}dispose(){this.onLoadObservable.clear(),super.dispose()}}function E_(e){let t=0;return{id_length:e[t++],colormap_type:e[t++],image_type:e[t++],colormap_index:e[t++]|e[t++]<<8,colormap_length:e[t++]|e[t++]<<8,colormap_size:e[t++],origin:[e[t++]|e[t++]<<8,e[t++]|e[t++]<<8],width:e[t++]|e[t++]<<8,height:e[t++]|e[t++]<<8,pixel_size:e[t++],flags:e[t++]}}function S_(e,t){if(t.length<19)return void k.Error("Unable to load TGA file - Not enough data to contain header");let i=18;const s=E_(t);if(s.id_length+i>t.length)return void k.Error("Unable to load TGA file - Not enough data");i+=s.id_length;let r,n=!1,o=!1,a=!1;switch(s.image_type){case 9:n=!0;case 1:o=!0;break;case 10:n=!0;case 2:break;case 11:n=!0;case 3:a=!0}const l=s.pixel_size>>3,h=s.width*s.height*l;let c,u,d,p,_,f,m;if(o&&(c=t.subarray(i,i+=s.colormap_length*(s.colormap_size>>3))),n){let e,s,n;r=new Uint8Array(h);let o=0;const a=new Uint8Array(l);for(;i<h&&o<h;)if(e=t[i++],s=1+(127&e),128&e){for(n=0;n<l;++n)a[n]=t[i++];for(n=0;n<s;++n)r.set(a,o+n*l);o+=l*s}else{for(s*=l,n=0;n<s;++n)r[o+n]=t[i++];o+=s}}else r=t.subarray(i,i+=o?s.width*s.height:h);switch((48&s.flags)>>4){default:case 2:u=0,p=1,m=s.width,d=0,_=1,f=s.height;break;case 0:u=0,p=1,m=s.width,d=s.height-1,_=-1,f=-1;break;case 3:u=s.width-1,p=-1,m=-1,d=0,_=1,f=s.height;break;case 1:u=s.width-1,p=-1,m=-1,d=s.height-1,_=-1,f=-1}const g="_getImageData"+(a?"Grey":"")+s.pixel_size+"bits",v=b_[g](s,c,r,d,_,f,u,p,m);e.getEngine()._uploadDataToTextureDirectly(e,v)}T_._DefaultOptions={generateMipMaps:!1,samplingMode:2,format:5,engine:null,scene:null};const b_={GetTGAHeader:E_,UploadContent:S_,_getImageData8bits:function(e,t,i,s,r,n,o,a,l){const h=i,c=t,u=e.width,d=e.height;let p,_,f,m=0;const g=new Uint8Array(u*d*4);for(f=s;f!==n;f+=r)for(_=o;_!==l;_+=a,m++)p=h[m],g[4*(_+u*f)+3]=255,g[4*(_+u*f)+2]=c[3*p+0],g[4*(_+u*f)+1]=c[3*p+1],g[4*(_+u*f)+0]=c[3*p+2];return g},_getImageData16bits:function(e,t,i,s,r,n,o,a,l){const h=i,c=e.width,u=e.height;let d,p,_,f=0;const m=new Uint8Array(c*u*4);for(_=s;_!==n;_+=r)for(p=o;p!==l;p+=a,f+=2){d=h[f+0]+(h[f+1]<<8);const e=255*((31744&d)>>10)/31|0,t=255*((992&d)>>5)/31|0,i=255*(31&d)/31|0;m[4*(p+c*_)+0]=e,m[4*(p+c*_)+1]=t,m[4*(p+c*_)+2]=i,m[4*(p+c*_)+3]=32768&d?0:255}return m},_getImageData24bits:function(e,t,i,s,r,n,o,a,l){const h=i,c=e.width,u=e.height;let d,p,_=0;const f=new Uint8Array(c*u*4);for(p=s;p!==n;p+=r)for(d=o;d!==l;d+=a,_+=3)f[4*(d+c*p)+3]=255,f[4*(d+c*p)+2]=h[_+0],f[4*(d+c*p)+1]=h[_+1],f[4*(d+c*p)+0]=h[_+2];return f},_getImageData32bits:function(e,t,i,s,r,n,o,a,l){const h=i,c=e.width,u=e.height;let d,p,_=0;const f=new Uint8Array(c*u*4);for(p=s;p!==n;p+=r)for(d=o;d!==l;d+=a,_+=4)f[4*(d+c*p)+2]=h[_+0],f[4*(d+c*p)+1]=h[_+1],f[4*(d+c*p)+0]=h[_+2],f[4*(d+c*p)+3]=h[_+3];return f},_getImageDataGrey8bits:function(e,t,i,s,r,n,o,a,l){const h=i,c=e.width,u=e.height;let d,p,_,f=0;const m=new Uint8Array(c*u*4);for(_=s;_!==n;_+=r)for(p=o;p!==l;p+=a,f++)d=h[f],m[4*(p+c*_)+0]=d,m[4*(p+c*_)+1]=d,m[4*(p+c*_)+2]=d,m[4*(p+c*_)+3]=255;return m},_getImageDataGrey16bits:function(e,t,i,s,r,n,o,a,l){const h=i,c=e.width,u=e.height;let d,p,_=0;const f=new Uint8Array(c*u*4);for(p=s;p!==n;p+=r)for(d=o;d!==l;d+=a,_+=2)f[4*(d+c*p)+0]=h[_+0],f[4*(d+c*p)+1]=h[_+0],f[4*(d+c*p)+2]=h[_+0],f[4*(d+c*p)+3]=h[_+1];return f}};var C_;Ns._TextureLoaders.push(new class{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".tga")}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){const s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),r=E_(s);i(r.width,r.height,t.generateMipMaps,!1,(()=>{S_(t,s)}))}}),Ns._TextureLoaders.push(new class{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".hdr")}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){const s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),r=Yp.RGBE_ReadHeader(s),n=Yp.RGBE_ReadPixels(s,r),o=r.width*r.height,a=new Float32Array(4*o);for(let e=0;e<o;e+=1)a[4*e]=n[3*e],a[4*e+1]=n[3*e+1],a[4*e+2]=n[3*e+2],a[4*e+3]=1;i(r.width,r.height,t.generateMipMaps,!1,(()=>{const e=t.getEngine();t.type=1,t.format=5,t._gammaSpace=!1,e._uploadDataToTextureDirectly(t,a)}))}}),function(e){e[e.cTFETC1=0]="cTFETC1",e[e.cTFETC2=1]="cTFETC2",e[e.cTFBC1=2]="cTFBC1",e[e.cTFBC3=3]="cTFBC3",e[e.cTFBC4=4]="cTFBC4",e[e.cTFBC5=5]="cTFBC5",e[e.cTFBC7=6]="cTFBC7",e[e.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",e[e.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",e[e.cTFASTC_4x4=10]="cTFASTC_4x4",e[e.cTFATC_RGB=11]="cTFATC_RGB",e[e.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",e[e.cTFRGBA32=13]="cTFRGBA32",e[e.cTFRGB565=14]="cTFRGB565",e[e.cTFBGR565=15]="cTFBGR565",e[e.cTFRGBA4444=16]="cTFRGBA4444",e[e.cTFFXT1_RGB=17]="cTFFXT1_RGB",e[e.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",e[e.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",e[e.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",e[e.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(C_||(C_={}));const y_={JSModuleURL:`${Ht._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${Ht._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let A_=null,R_=null,I_=0;const P_=(e,t)=>{const i=e instanceof ArrayBuffer?new Uint8Array(e):e;return new Promise(((e,s)=>{(A_||(A_=new Promise(((e,t)=>{R_?e(R_):Ht.LoadFileAsync(Ht.GetBabylonScriptURL(y_.WasmModuleURL)).then((i=>{if("function"!=typeof URL)return t("Basis transcoder requires an environment with a URL constructor");const s=URL.createObjectURL(new Blob([`(${N_})()`],{type:"application/javascript"}));R_=new Worker(s);const r=i=>{"init"===i.data.action?(R_.removeEventListener("message",r),e(R_)):"error"===i.data.action&&t(i.data.error||"error initializing worker")};R_.addEventListener("message",r),R_.postMessage({action:"init",url:Ht.GetBabylonScriptURL(y_.JSModuleURL),wasmBinary:i})})).catch(t)}))),A_).then((()=>{const r=I_++,n=t=>{"transcode"===t.data.action&&t.data.id===r&&(R_.removeEventListener("message",n),t.data.success?e(t.data):s("Transcode is not supported on this device"))};R_.addEventListener("message",n);const o=new Uint8Array(i.byteLength);o.set(new Uint8Array(i.buffer,i.byteOffset,i.byteLength)),R_.postMessage({action:"transcode",id:r,imageData:o,config:t,ignoreSupportedFormats:!1},[o.buffer])}),(e=>{s(e)}))}))},M_=(e,t)=>{var i,s;let r=null===(i=t._gl)||void 0===i?void 0:i.TEXTURE_2D;e.isCube&&(r=null===(s=t._gl)||void 0===s?void 0:s.TEXTURE_CUBE_MAP),t._bindTextureDirectly(r,e,!0)},O_=(e,t)=>{const i=e.getEngine();for(let s=0;s<t.fileInfo.images.length;s++){const r=t.fileInfo.images[s].levels[0];if(e._invertVScale=e.invertY,-1===t.format||t.format===C_.cTFRGB565)if(e.type=10,e.format=4,!i._features.basisNeedsPOT||l.Log2(r.width)%1==0&&l.Log2(r.height)%1==0)e._invertVScale=!e.invertY,e.width=r.width+3&-4,e.height=r.height+3&-4,e.samplingMode=2,M_(e,i),i._uploadDataToTextureDirectly(e,new Uint16Array(r.transcodedPixels.buffer),s,0,4,!0);else{const t=new dt(i,ut.Temp);e._invertVScale=e.invertY,t.type=10,t.format=4,t.width=r.width+3&-4,t.height=r.height+3&-4,M_(t,i),i._uploadDataToTextureDirectly(t,new Uint16Array(r.transcodedPixels.buffer),s,0,4,!0),i._rescaleTexture(t,e,i.scenes[0],i._getInternalFormat(4),(()=>{i._releaseTexture(t),M_(e,i)}))}else{e.width=r.width,e.height=r.height,e.generateMipMaps=t.fileInfo.images[s].levels.length>1;const n=D_.GetInternalFormatFromBasisFormat(t.format,i);e.format=n,M_(e,i),t.fileInfo.images[s].levels.forEach(((t,r)=>{i._uploadCompressedDataToTextureDirectly(e,n,t.width,t.height,t.transcodedPixels,s,r)})),!i._features.basisNeedsPOT||l.Log2(e.width)%1==0&&l.Log2(e.height)%1==0||(Ht.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),e._cachedWrapU=Ar.CLAMP_ADDRESSMODE,e._cachedWrapV=Ar.CLAMP_ADDRESSMODE)}}},D_={JSModuleURL:y_.JSModuleURL,WasmModuleURL:y_.WasmModuleURL,GetInternalFormatFromBasisFormat:(e,t)=>{let i;switch(e){case C_.cTFETC1:i=36196;break;case C_.cTFBC1:i=33776;break;case C_.cTFBC4:i=33779;break;case C_.cTFASTC_4x4:i=37808;break;case C_.cTFETC2:i=37496;break;case C_.cTFBC7:i=36492}if(void 0===i)throw"The chosen Basis transcoder format is not currently supported";return i},TranscodeAsync:P_,LoadTextureFromTranscodeResult:O_};function N_(){let e=null;function t(e,t,i,s,r){const n=e.getImageTranscodedSizeInBytes(t,i,s);let o=new Uint8Array(n);return e.transcodeImage(o,t,i,s,1,0)?(r&&(o=function(e,t,i,s){const r=new Uint16Array(4),n=new Uint16Array(i*s),o=i/4,a=s/4;for(let t=0;t<a;t++)for(let s=0;s<o;s++){const a=0+8*(t*o+s);r[0]=e[a]|e[a+1]<<8,r[1]=e[a+2]|e[a+3]<<8,r[2]=(2*(31&r[0])+1*(31&r[1]))/3|(2*(2016&r[0])+1*(2016&r[1]))/3&2016|(2*(63488&r[0])+1*(63488&r[1]))/3&63488,r[3]=(2*(31&r[1])+1*(31&r[0]))/3|(2*(2016&r[1])+1*(2016&r[0]))/3&2016|(2*(63488&r[1])+1*(63488&r[0]))/3&63488;for(let o=0;o<4;o++){const l=e[a+4+o];let h=(4*t+o)*i+4*s;n[h++]=r[3&l],n[h++]=r[l>>2&3],n[h++]=r[l>>4&3],n[h++]=r[l>>6&3]}}return n}(o,0,e.getImageWidth(t,i)+3&-4,e.getImageHeight(t,i)+3&-4)),o):null}onmessage=i=>{if("init"===i.data.action){if(!e){try{importScripts(i.data.url)}catch(e){postMessage({action:"error",error:e})}e=BASIS({wasmBinary:i.data.wasmBinary})}null!==e&&e.then((e=>{BASIS=e,e.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===i.data.action){const e=i.data.config,s=i.data.imageData,r=new BASIS.BasisFile(s),n=function(e){const t=e.getHasAlpha(),i=e.getNumImages(),s=[];for(let t=0;t<i;t++){const i={levels:[]},r=e.getNumLevels(t);for(let s=0;s<r;s++){const r={width:e.getImageWidth(t,s),height:e.getImageHeight(t,s)};i.levels.push(r)}s.push(i)}return{hasAlpha:t,images:s}}(r);let o=i.data.ignoreSupportedFormats?null:function(e,t){let i=null;return e.supportedCompressionFormats&&(i=e.supportedCompressionFormats.astc?10:e.supportedCompressionFormats.bc7?6:e.supportedCompressionFormats.s3tc?t.hasAlpha?3:2:e.supportedCompressionFormats.pvrtc?t.hasAlpha?9:8:e.supportedCompressionFormats.etc2?1:e.supportedCompressionFormats.etc1?0:14),i}(i.data.config,n),a=!1;null===o&&(a=!0,o=n.hasAlpha?3:2);let l=!0;r.startTranscoding()||(l=!1);const h=[];for(let i=0;i<n.images.length&&l;i++){const s=n.images[i];if(void 0===e.loadSingleImage||e.loadSingleImage===i){let n=s.levels.length;!1===e.loadMipmapLevels&&(n=1);for(let e=0;e<n;e++){const n=s.levels[e],c=t(r,i,e,o,a);if(!c){l=!1;break}n.transcodedPixels=c,h.push(n.transcodedPixels.buffer)}}}r.close(),r.delete(),a&&(o=-1),l?postMessage({action:"transcode",success:l,id:i.data.id,fileInfo:n,format:o},h):postMessage({action:"transcode",success:l,id:i.data.id})}}}Object.defineProperty(D_,"JSModuleURL",{get:function(){return y_.JSModuleURL},set:function(e){y_.JSModuleURL=e}}),Object.defineProperty(D_,"WasmModuleURL",{get:function(){return y_.WasmModuleURL},set:function(e){y_.WasmModuleURL=e}}),Ns._TextureLoaders.push(new class{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".basis")}loadCubeData(e,t,i,s,r){if(Array.isArray(e))return;const n=t.getEngine().getCaps(),o={supportedCompressionFormats:{etc1:!!n.etc1,s3tc:!!n.s3tc,pvrtc:!!n.pvrtc,etc2:!!n.etc2,astc:!!n.astc,bc7:!!n.bptc}};P_(e,o).then((e=>{const i=e.fileInfo.images[0].levels.length>1&&t.generateMipMaps;O_(t,e),t.getEngine()._setCubeMapTextureParams(t,i),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()})).catch((e=>{Ht.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),t.isReady=!0,r&&r(e)}))}loadData(e,t,i){const s=t.getEngine().getCaps(),r={supportedCompressionFormats:{etc1:!!s.etc1,s3tc:!!s.s3tc,pvrtc:!!s.pvrtc,etc2:!!s.etc2,astc:!!s.astc,bc7:!!s.bptc}};P_(e,r).then((e=>{const s=e.fileInfo.images[0].levels[0],r=e.fileInfo.images[0].levels.length>1&&t.generateMipMaps;i(s.width,s.height,r,-1!==e.format,(()=>{O_(t,e)}))})).catch((e=>{Ht.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),Ht.Warn(`Failed to transcode Basis file: ${e}`),i(0,0,!1,!1,(()=>{}),!0)}))}});class F_ extends Bn{get isSupported(){var e,t;return null!==(t=null===(e=this._engine)||void 0===e?void 0:e.getCaps().drawBuffersExtension)&&void 0!==t&&t}get textures(){return this._textures}get count(){return this._count}get depthTexture(){return this._textures[this._textures.length-1]}set wrapU(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapU=e}set wrapV(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapV=e}constructor(e,t,i,s,r,n){const o=!(!r||!r.generateMipMaps)&&r.generateMipMaps,a=!(!r||!r.generateDepthTexture)&&r.generateDepthTexture,l=r&&r.depthTextureFormat?r.depthTextureFormat:15,h=!r||void 0===r.doNotChangeAspectRatio||r.doNotChangeAspectRatio,c=!(!r||!r.drawOnlyOnFirstAttachmentByDefault)&&r.drawOnlyOnFirstAttachmentByDefault;if(super(e,t,s,o,h,void 0,void 0,void 0,void 0,void 0,void 0,void 0,!0),!this.isSupported)return void this.dispose();this._textureNames=n;const u=[],d=[],p=[],_=[],f=[],m=[],g=[],v=[];this._initTypes(i,u,d,p,_,f,m,g,v,r);const x=!r||void 0===r.generateDepthBuffer||r.generateDepthBuffer,T=!(!r||void 0===r.generateStencilBuffer)&&r.generateStencilBuffer;this._multiRenderTargetOptions={samplingModes:d,generateMipMaps:o,generateDepthBuffer:x,generateStencilBuffer:T,generateDepthTexture:a,depthTextureFormat:l,types:u,textureCount:i,useSRGBBuffers:p,formats:_,targetTypes:f,faceIndex:m,layerIndex:g,layerCounts:v,labels:n},this._count=i,this._drawOnlyOnFirstAttachmentByDefault=c,i>0&&(this._createInternalTextures(),this._createTextures(n))}_initTypes(e,t,i,s,r,n,o,a,l,h){for(let c=0;c<e;c++)h&&h.types&&void 0!==h.types[c]?t.push(h.types[c]):t.push(h&&h.defaultType?h.defaultType:0),h&&h.samplingModes&&void 0!==h.samplingModes[c]?i.push(h.samplingModes[c]):i.push(Ar.BILINEAR_SAMPLINGMODE),h&&h.useSRGBBuffers&&void 0!==h.useSRGBBuffers[c]?s.push(h.useSRGBBuffers[c]):s.push(!1),h&&h.formats&&void 0!==h.formats[c]?r.push(h.formats[c]):r.push(5),h&&h.targetTypes&&void 0!==h.targetTypes[c]?n.push(h.targetTypes[c]):n.push(3553),h&&h.faceIndex&&void 0!==h.faceIndex[c]?o.push(h.faceIndex[c]):o.push(0),h&&h.layerIndex&&void 0!==h.layerIndex[c]?a.push(h.layerIndex[c]):a.push(0),h&&h.layerCounts&&void 0!==h.layerCounts[c]?l.push(h.layerCounts[c]):l.push(1)}_createInternaTextureIndexMapping(){const e={},t=[];if(!this._renderTarget)return t;const i=this._renderTarget.textures;for(let s=0;s<i.length;s++){const r=i[s];if(!r)continue;const n=e[r.uniqueId];void 0!==n?t[s]=n:e[r.uniqueId]=s}return t}_rebuild(e=!1,t){if(this._count<1)return;const i=this._createInternaTextureIndexMapping();this.releaseInternalTextures(),this._createInternalTextures(),e&&(this._releaseTextures(),this._createTextures(t));const s=this._renderTarget.textures;for(let e=0;e<s.length;e++){const t=this._textures[e];void 0!==i[e]&&this._renderTarget.setTexture(s[i[e]],e),t._texture=s[e],t._texture&&(t._noMipmap=!t._texture.useMipMaps,t._useSRGBBuffer=t._texture._useSRGBBuffer)}1!==this.samples&&this._renderTarget.setSamples(this.samples,!this._drawOnlyOnFirstAttachmentByDefault,!0)}_createInternalTextures(){this._renderTarget=this._getEngine().createMultipleRenderTarget(this._size,this._multiRenderTargetOptions,!this._drawOnlyOnFirstAttachmentByDefault),this._texture=this._renderTarget.texture}_releaseTextures(){if(this._textures)for(let e=0;e<this._textures.length;e++)this._textures[e]._texture=null,this._textures[e].dispose()}_createTextures(e){const t=this._renderTarget.textures;this._textures=[];for(let i=0;i<t.length;i++){const s=new Ar(null,this.getScene());(null==e?void 0:e[i])&&(s.name=e[i]),s._texture=t[i],s._texture&&(s._noMipmap=!s._texture.useMipMaps,s._useSRGBBuffer=s._texture._useSRGBBuffer),this._textures.push(s)}}setInternalTexture(e,t,i=!0){var s,r;if(this.renderTarget&&(0===t&&(this._texture=e),this.renderTarget.setTexture(e,t,i),this.textures[t]||(this.textures[t]=new Ar(null,this.getScene()),this.textures[t].name=null!==(r=null===(s=this._textureNames)||void 0===s?void 0:s[t])&&void 0!==r?r:this.textures[t].name),this.textures[t]._texture=e,this.textures[t]._noMipmap=!e.useMipMaps,this.textures[t]._useSRGBBuffer=e._useSRGBBuffer,this._count=this.renderTarget.textures?this.renderTarget.textures.length:0,this._multiRenderTargetOptions.types&&(this._multiRenderTargetOptions.types[t]=e.type),this._multiRenderTargetOptions.samplingModes&&(this._multiRenderTargetOptions.samplingModes[t]=e.samplingMode),this._multiRenderTargetOptions.useSRGBBuffers&&(this._multiRenderTargetOptions.useSRGBBuffers[t]=e._useSRGBBuffer),this._multiRenderTargetOptions.targetTypes&&-1!==this._multiRenderTargetOptions.targetTypes[t])){let i=0;i=e.is2DArray?35866:e.isCube?34067:e.is3D?32879:3553,this._multiRenderTargetOptions.targetTypes[t]=i}}setLayerAndFaceIndex(e,t=-1,i=-1){this.textures[e]&&this.renderTarget&&(this._multiRenderTargetOptions.layerIndex&&(this._multiRenderTargetOptions.layerIndex[e]=t),this._multiRenderTargetOptions.faceIndex&&(this._multiRenderTargetOptions.faceIndex[e]=i),this.renderTarget.setLayerAndFaceIndex(e,t,i))}setLayerAndFaceIndices(e,t){this.renderTarget&&(this._multiRenderTargetOptions.layerIndex=e,this._multiRenderTargetOptions.faceIndex=t,this.renderTarget.setLayerAndFaceIndices(e,t))}get samples(){return this._samples}set samples(e){this._renderTarget?this._samples=this._renderTarget.setSamples(e):this._samples=e}resize(e){this._processSizeParameter(e,!1),this._rebuild(void 0,this._textureNames)}updateCount(e,t,i){this._multiRenderTargetOptions.textureCount=e,this._count=e;const s=[],r=[],n=[],o=[],a=[],l=[],h=[],c=[];this._textureNames=i,this._initTypes(e,s,r,n,o,a,l,h,c,t),this._multiRenderTargetOptions.types=s,this._multiRenderTargetOptions.samplingModes=r,this._multiRenderTargetOptions.useSRGBBuffers=n,this._multiRenderTargetOptions.formats=o,this._multiRenderTargetOptions.targetTypes=a,this._multiRenderTargetOptions.faceIndex=l,this._multiRenderTargetOptions.layerIndex=h,this._multiRenderTargetOptions.layerCounts=c,this._multiRenderTargetOptions.labels=i,this._rebuild(!0,i)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindMultiColorAttachmentFramebuffer(this._renderTarget,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(t)}))}dispose(e=!1){this._releaseTextures(),e?this._texture=null:this.releaseInternalTextures(),super.dispose()}releaseInternalTextures(){var e,t;const i=null===(e=this._renderTarget)||void 0===e?void 0:e.textures;if(i){for(let e=i.length-1;e>=0;e--)this._textures[e]._texture=null;null===(t=this._renderTarget)||void 0===t||t.dispose(),this._renderTarget=null}}}class w_{constructor(e,t,i){this.id=e,this.scale=t,this.offset=i}}class L_{constructor(e,t,i,s){var r,n,o,a,l,h,c,u,d,p,_,f,m;return this.name=e,this.meshes=t,this.scene=s,this.options=i,this.options.map=null!==(r=this.options.map)&&void 0!==r?r:["ambientTexture","bumpTexture","diffuseTexture","emissiveTexture","lightmapTexture","opacityTexture","reflectionTexture","refractionTexture","specularTexture"],this.options.uvsIn=null!==(n=this.options.uvsIn)&&void 0!==n?n:hi.UVKind,this.options.uvsOut=null!==(o=this.options.uvsOut)&&void 0!==o?o:hi.UVKind,this.options.layout=null!==(a=this.options.layout)&&void 0!==a?a:L_.LAYOUT_STRIP,this.options.layout===L_.LAYOUT_COLNUM&&(this.options.colnum=null!==(l=this.options.colnum)&&void 0!==l?l:8),this.options.updateInputMeshes=null===(h=this.options.updateInputMeshes)||void 0===h||h,this.options.disposeSources=null===(c=this.options.disposeSources)||void 0===c||c,this._expecting=0,this.options.fillBlanks=null===(u=this.options.fillBlanks)||void 0===u||u,!0===this.options.fillBlanks&&(this.options.customFillColor=null!==(d=this.options.customFillColor)&&void 0!==d?d:"black"),this.options.frameSize=null!==(p=this.options.frameSize)&&void 0!==p?p:256,this.options.paddingRatio=null!==(_=this.options.paddingRatio)&&void 0!==_?_:.0115,this._paddingValue=Math.ceil(this.options.frameSize*this.options.paddingRatio),this._paddingValue%2!=0&&this._paddingValue++,this.options.paddingMode=null!==(f=this.options.paddingMode)&&void 0!==f?f:L_.SUBUV_WRAP,this.options.paddingMode===L_.SUBUV_COLOR&&(this.options.paddingColor=null!==(m=this.options.paddingColor)&&void 0!==m?m:new F(0,0,0,1)),this.sets={},this.frames=[],this}_createFrames(e){const t=this._calculateSize(),i=new E(1,1).divide(t);let s=0;const r=this._expecting,n=this.meshes.length,o=Object.keys(this.sets);for(let e=0;e<o.length;e++){const i=o[e],s=new ka(this.name+".TexturePack."+i+"Set",{width:t.x,height:t.y},this.scene,!0,Ar.TRILINEAR_SAMPLINGMODE,Ns.TEXTUREFORMAT_RGBA),r=s.getContext();r.fillStyle="rgba(0,0,0,0)",r.fillRect(0,0,t.x,t.y),s.update(!1),this.sets[i]=s}const a=this.options.frameSize||256,l=this._paddingValue,h=a+2*l,c=()=>{this._calculateMeshUVFrames(a,l,t,i,this.options.updateInputMeshes||!1)};for(let i=0;i<n;i++){const n=this.meshes[i].material;for(let u=0;u<o.length;u++){const d=new ka("temp",h,this.scene,!0),p=d.getContext(),_=this._getFrameOffset(i),f=()=>{s++,d.update(!1);const i=p.getImageData(0,0,h,h),n=this.sets[m];if(n.getContext().putImageData(i,t.x*_.x,t.y*_.y),d.dispose(),n.update(!1),s==r)return c(),void e()},m=o[u]||"_blank";if(n&&null!==n[m]){const e=n[m],t=new Image;t.src=e instanceof ka?e.getContext().canvas.toDataURL("image/png"):e.url,Ht.SetCorsBehavior(t.src,t),t.onload=()=>{p.fillStyle="rgba(0,0,0,0)",p.fillRect(0,0,h,h),d.update(!1),p.setTransform(1,0,0,-1,0,0);const e=[0,0,1,0,1,1,0,1,-1,1,-1,0,-2,0,-1,1,-1];switch(this.options.paddingMode){case 0:for(let i=0;i<9;i++)p.drawImage(t,0,0,t.width,t.height,l+a*e[i],l+a*e[i+1]-h,a,a);break;case 1:for(let i=0;i<l;i++)p.drawImage(t,0,0,t.width,t.height,i+a*e[0],l-h,a,a),p.drawImage(t,0,0,t.width,t.height,2*l-i,l-h,a,a),p.drawImage(t,0,0,t.width,t.height,l,i-h,a,a),p.drawImage(t,0,0,t.width,t.height,l,2*l-i-h,a,a);p.drawImage(t,0,0,t.width,t.height,l+a*e[0],l+a*e[1]-h,a,a);break;case 2:p.fillStyle=(this.options.paddingColor||N.Black()).toHexString(),p.fillRect(0,0,h,-h),p.clearRect(l,l,a,a),p.drawImage(t,0,0,t.width,t.height,l+a*e[0],l+a*e[1]-h,a,a)}p.setTransform(1,0,0,1,0,0),f()}}else p.fillStyle="rgba(0,0,0,0)",this.options.fillBlanks&&(p.fillStyle=this.options.customFillColor),p.fillRect(0,0,h,h),f()}}}_calculateSize(){const e=this.meshes.length||0,t=this.options.frameSize||0,i=this._paddingValue||0;switch(this.options.layout){case 0:return new E(t*e+2*i*e,t+2*i);case 1:{const s=Math.max(2,Math.ceil(Math.sqrt(e))),r=t*s+2*i*s;return new E(r,r)}case 2:{const s=this.options.colnum||1,r=Math.max(1,Math.ceil(e/s));return new E(t*s+2*i*s,t*r+2*i*r)}}return E.Zero()}_calculateMeshUVFrames(e,t,i,s,r){const n=this.meshes.length;for(let o=0;o<n;o++){const n=this.meshes[o],a=new E(e/i.x,e/i.y),l=s.clone().scale(t),h=this._getFrameOffset(o).add(l),c=new w_(o,a,h);this.frames.push(c),r&&(this._updateMeshUV(n,o),this._updateTextureReferences(n))}}_getFrameOffset(e){const t=this.meshes.length;let i,s,r;switch(this.options.layout){case 0:return i=1/t,new E(e*i,0);case 1:{const n=Math.max(2,Math.ceil(Math.sqrt(t)));return s=Math.floor(e/n),r=e-s*n,i=1/n,new E(r*i,s*i)}case 2:{const n=this.options.colnum||1,o=Math.max(1,Math.ceil(t/n));return r=Math.floor(e/o),s=e-r*o,i=new E(1/n,1/o),new E(r*i.x,s*i.y)}}return E.Zero()}_updateMeshUV(e,t){const i=this.frames[t],s=e.getVerticesData(this.options.uvsIn||hi.UVKind),r=[];let n=0;s.length&&(n=s.length||0);for(let e=0;e<n;e+=2)r.push(s[e]*i.scale.x+i.offset.x,s[e+1]*i.scale.y+i.offset.y);e.setVerticesData(this.options.uvsOut||hi.UVKind,r)}_updateTextureReferences(e,t=!1){const i=e.material,s=Object.keys(this.sets),r=e=>{e.dispose&&e.dispose()};for(let e=0;e<s.length;e++){const n=s[e];if(t)null!==i[n]&&r(i[n]),i[n]=this.sets[n];else{if(!i)return;null!==i[n]&&(r(i[n]),i[n]=this.sets[n])}}}setMeshToFrame(e,t,i=!1){this._updateMeshUV(e,t),i&&this._updateTextureReferences(e,!0)}processAsync(){return new Promise(((e,t)=>{try{if(0===this.meshes.length)return void e();let t=0;const i=i=>{if(t++,this.options.map){for(let e=0;e<this.options.map.length;e++)null!==i[this.options.map[e]]&&(this.sets[this.options.map[e]]||(this.sets[this.options.map[e]]=!0),this._expecting++);t===this.meshes.length&&this._createFrames(e)}};for(let s=0;s<this.meshes.length;s++){const r=this.meshes[s],n=r.material;if(n)n.forceCompilationAsync(r).then((()=>{i(n)}));else if(t++,t===this.meshes.length)return this._createFrames(e)}}catch(e){return t(e)}}))}dispose(){const e=Object.keys(this.sets);for(let t=0;t<e.length;t++){const i=e[t];this.sets[i].dispose()}}download(e="png",t=1){setTimeout((()=>{const i={name:this.name,sets:{},options:{},frames:[]},s=Object.keys(this.sets),r=Object.keys(this.options);try{for(let r=0;r<s.length;r++){const n=s[r],o=this.sets[n];i.sets[n]=o.getContext().canvas.toDataURL("image/"+e,t)}for(let e=0;e<r.length;e++){const t=r[e];i.options[t]=this.options[t]}for(let e=0;e<this.frames.length;e++){const t=this.frames[e];i.frames.push(t.scale.x,t.scale.y,t.offset.x,t.offset.y)}}catch(e){return void k.Warn("Unable to download: "+e)}const n="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(i,null,4)),o=document.createElement("a");o.setAttribute("href",n),o.setAttribute("download",this.name+"_texurePackage.json"),document.body.appendChild(o),o.click(),o.remove()}),0)}updateFromJSON(e){try{const t=JSON.parse(e);this.name=t.name;const i=Object.keys(t.options);for(let e=0;e<i.length;e++)this.options[i[e]]=t.options[i[e]];for(let e=0;e<t.frames.length;e+=4){const i=new w_(e/4,new E(t.frames[e],t.frames[e+1]),new E(t.frames[e+2],t.frames[e+3]));this.frames.push(i)}const s=Object.keys(t.sets);for(let e=0;e<s.length;e++){const i=new Ar(t.sets[s[e]],this.scene,!1,!1);this.sets[s[e]]=i}}catch(e){k.Warn("Unable to update from JSON: "+e)}}}L_.LAYOUT_STRIP=0,L_.LAYOUT_POWER2=1,L_.LAYOUT_COLNUM=2,L_.SUBUV_WRAP=0,L_.SUBUV_EXTEND=1,L_.SUBUV_COLOR=2;nt.ShadersStore.noisePixelShader="uniform float brightness;uniform float persistence;uniform float timeScale;varying vec2 vUV;vec2 hash22(vec2 p)\n{p=p*mat2(127.1,311.7,269.5,183.3);p=-1.0+2.0*fract(sin(p)*43758.5453123);return sin(p*6.283+timeScale);}\nfloat interpolationNoise(vec2 p)\n{vec2 pi=floor(p);vec2 pf=p-pi;vec2 w=pf*pf*(3.-2.*pf);float f00=dot(hash22(pi+vec2(.0,.0)),pf-vec2(.0,.0));float f01=dot(hash22(pi+vec2(.0,1.)),pf-vec2(.0,1.));float f10=dot(hash22(pi+vec2(1.0,0.)),pf-vec2(1.0,0.));float f11=dot(hash22(pi+vec2(1.0,1.)),pf-vec2(1.0,1.));float xm1=mix(f00,f10,w.x);float xm2=mix(f01,f11,w.x);float ym=mix(xm1,xm2,w.y); \nreturn ym;}\nfloat perlinNoise2D(float x,float y)\n{float sum=0.0;float frequency=0.0;float amplitude=0.0;for(int i=0; i<OCTAVES; i++)\n{frequency=pow(2.0,float(i));amplitude=pow(persistence,float(i));sum=sum+interpolationNoise(vec2(x*frequency,y*frequency))*amplitude;}\nreturn sum;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float x=abs(vUV.x);float y=abs(vUV.y);float noise=brightness+(1.0-brightness)*perlinNoise2D(x,y);gl_FragColor=vec4(noise,noise,noise,1.0);}\n";class B_ extends Vn{constructor(e,t=256,i=x.LastCreatedScene,s,r){super(e,t,"noise",i,s,r),this.time=0,this.brightness=.2,this.octaves=3,this.persistence=.8,this.animationSpeedFactor=1,this.autoClear=!1,this._updateShaderUniforms()}_updateShaderUniforms(){const e=this.getScene();e&&(this.time+=e.getAnimationRatio()*this.animationSpeedFactor*.01,this.setFloat("brightness",this.brightness),this.setFloat("persistence",this.persistence),this.setFloat("timeScale",this.time))}_getDefines(){return"#define OCTAVES "+(0|this.octaves)}render(e){this._updateShaderUniforms(),super.render(e)}serialize(){const e={customType:"BABYLON.NoiseProceduralTexture"};return e.brightness=this.brightness,e.octaves=this.octaves,e.persistence=this.persistence,e.animationSpeedFactor=this.animationSpeedFactor,e.size=this.getSize().width,e.generateMipMaps=this._generateMipMaps,e.time=this.time,e}clone(){const e=this.getSize(),t=new B_(this.name,e.width,this.getScene(),this._fallbackTexture?this._fallbackTexture:void 0,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t.brightness=this.brightness,t.octaves=this.octaves,t.persistence=this.persistence,t.animationSpeedFactor=this.animationSpeedFactor,t.time=this.time,t}static Parse(e,t){var i;const s=new B_(e.name,e.size,t,void 0,e.generateMipMaps);return s.brightness=e.brightness,s.octaves=e.octaves,s.persistence=e.persistence,s.animationSpeedFactor=e.animationSpeedFactor,s.time=null!==(i=e.time)&&void 0!==i?i:0,s}}m("BABYLON.NoiseProceduralTexture",B_);class U_ extends ud{constructor(e,t,i,s=5,r=0,n=!1,o=!1,a=3,l=null){super("",e),this._texture=e.getEngine().createRawCubeTexture(t,i,s,r,n,o,a,l)}update(e,t,i,s,r=null){this._texture.getEngine().updateRawCubeTexture(this._texture,e,t,i,s,r)}updateRGBDAsync(e,t=null,i=.8,s=0){return function(e,t,i,s,r){const n=zh(e.getEngine().createRawCubeTexture(null,e.width,e.format,e.type,e.generateMipMaps,e.invertY,e.samplingMode,e._compression),t).then((()=>e));return e.onRebuildCallback=e=>({proxy:n,isReady:!0,isAsync:!0}),e._source=ut.CubeRawRGBD,e._bufferViewArrayArray=t,e._lodGenerationScale=s,e._lodGenerationOffset=r,e._sphericalPolynomial=i,zh(e,t).then((()=>(e.isReady=!0,e)))}(this._texture,e,t,i,s).then((()=>{}))}clone(){return de.Clone((()=>{const e=this.getScene(),t=this._texture,i=new U_(e,t._bufferViewArray,t.width,t.format,t.type,t.generateMipMaps,t.invertY,t.samplingMode,t._compression);return t.source===ut.CubeRawRGBD&&i.updateRGBDAsync(t._bufferViewArrayArray,t._sphericalPolynomial,t._lodGenerationScale,t._lodGenerationOffset),i}),this)}}class V_ extends Kr{constructor(e,t,i,s,r){super(e,t,i),this._blockType=s,this._blockName=r,this.needDualDirectionValidation=!0}checkCompatibilityState(e){return e instanceof V_&&e._blockName===this._blockName?Qs.Compatible:Qs.TypeIncompatible}createCustomInputBlock(){return[new this._blockType(this._blockName),this.name]}}m("BABYLON.BonesBlock",class extends $r{constructor(e){super(e,qs.Vertex),this.registerInput("matricesIndices",$s.Vector4),this.registerInput("matricesWeights",$s.Vector4),this.registerInput("matricesIndicesExtra",$s.Vector4,!0),this.registerInput("matricesWeightsExtra",$s.Vector4,!0),this.registerInput("world",$s.Matrix),this.registerOutput("output",$s.Matrix)}initialize(e){e._excludeVariableName("boneSampler"),e._excludeVariableName("boneTextureWidth"),e._excludeVariableName("mBones"),e._excludeVariableName("BonesPerMesh")}getClassName(){return"BonesBlock"}get matricesIndices(){return this._inputs[0]}get matricesWeights(){return this._inputs[1]}get matricesIndicesExtra(){return this._inputs[2]}get matricesWeightsExtra(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}autoConfigure(e,t=()=>!0){if(!this.matricesIndices.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"matricesIndices"===e.name&&t(e)));i||(i=new rn("matricesIndices"),i.setAsAttribute("matricesIndices")),i.output.connectTo(this.matricesIndices)}if(!this.matricesWeights.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"matricesWeights"===e.name&&t(e)));i||(i=new rn("matricesWeights"),i.setAsAttribute("matricesWeights")),i.output.connectTo(this.matricesWeights)}if(!this.world.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===tr.World&&t(e)));i||(i=new rn("world"),i.setAsSystemValue(tr.World)),i.output.connectTo(this.world)}}provideFallbacks(e,t){e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton&&t.addCPUSkinningFallback(0,e)}bind(e,t,i){Hs.BindBonesParameters(i,e)}prepareDefines(e,t,i){i._areAttributesDirty&&Hs.PrepareDefinesForBones(e,i)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithFallbacks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.uniforms.push("boneTextureWidth"),e.uniforms.push("mBones"),e.samplers.push("boneSampler");const t=`//${this.name}`;e._emitFunctionFromInclude("bonesDeclaration",t,{removeAttributes:!0,removeUniforms:!1,removeVaryings:!0,removeIfDef:!1});const i=e._getFreeVariableName("influence");e.compilationString+=e._emitCodeFromInclude("bonesVertex",t,{replaceStrings:[{search:/finalWorld=finalWorld\*influence;/,replace:""},{search:/influence/gm,replace:i}]});const s=this._outputs[0],r=this.world;return e.compilationString+="#if NUM_BONE_INFLUENCERS>0\n",e.compilationString+=this._declareOutput(s,e)+` = ${r.associatedVariableName} * ${i};\n`,e.compilationString+="#else\n",e.compilationString+=this._declareOutput(s,e)+` = ${r.associatedVariableName};\n`,e.compilationString+="#endif\n",this}}),m("BABYLON.InstancesBlock",class extends $r{constructor(e){super(e,qs.Vertex),this.registerInput("world0",$s.Vector4),this.registerInput("world1",$s.Vector4),this.registerInput("world2",$s.Vector4),this.registerInput("world3",$s.Vector4),this.registerInput("world",$s.Matrix,!0),this.registerOutput("output",$s.Matrix),this.registerOutput("instanceID",$s.Float)}getClassName(){return"InstancesBlock"}get world0(){return this._inputs[0]}get world1(){return this._inputs[1]}get world2(){return this._inputs[2]}get world3(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}get instanceID(){return this._outputs[1]}autoConfigure(e,t=()=>!0){if(!this.world0.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world0"===e.name&&t(e)));i||(i=new rn("world0"),i.setAsAttribute("world0")),i.output.connectTo(this.world0)}if(!this.world1.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world1"===e.name&&t(e)));i||(i=new rn("world1"),i.setAsAttribute("world1")),i.output.connectTo(this.world1)}if(!this.world2.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world2"===e.name&&t(e)));i||(i=new rn("world2"),i.setAsAttribute("world2")),i.output.connectTo(this.world2)}if(!this.world3.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world3"===e.name&&t(e)));i||(i=new rn("world3"),i.setAsAttribute("world3")),i.output.connectTo(this.world3)}if(!this.world.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world"===e.name&&t(e)));i||(i=new rn("world"),i.setAsSystemValue(tr.World)),i.output.connectTo(this.world)}this.world.define="!INSTANCES || THIN_INSTANCES"}prepareDefines(e,t,i,s=!1,r){let n=!1;i.INSTANCES!==s&&(i.setValue("INSTANCES",s),n=!0),r&&i.THIN_INSTANCES!==!!(null==r?void 0:r.getRenderingMesh().hasThinInstances)&&(i.setValue("THIN_INSTANCES",!!(null==r?void 0:r.getRenderingMesh().hasThinInstances)),n=!0),n&&i.markAsUnprocessed()}_buildBlock(e){super._buildBlock(e);const t=e.sharedData.scene.getEngine();e.sharedData.blocksWithDefines.push(this);const i=this._outputs[0],s=this._outputs[1],r=this.world0,n=this.world1,o=this.world2,a=this.world3;return e.compilationString+="#ifdef INSTANCES\n",e.compilationString+=this._declareOutput(i,e)+` = mat4(${r.associatedVariableName}, ${n.associatedVariableName}, ${o.associatedVariableName}, ${a.associatedVariableName});\n`,e.compilationString+="#ifdef THIN_INSTANCES\n",e.compilationString+=`${i.associatedVariableName} = ${this.world.associatedVariableName} * ${i.associatedVariableName};\n`,e.compilationString+="#endif\n",t._caps.canUseGLInstanceID?e.compilationString+=this._declareOutput(s,e)+" = float(gl_InstanceID);\n":e.compilationString+=this._declareOutput(s,e)+" = 0.0;\n",e.compilationString+="#else\n",e.compilationString+=this._declareOutput(i,e)+` = ${this.world.associatedVariableName};\n`,e.compilationString+=this._declareOutput(s,e)+" = 0.0;\n",e.compilationString+="#endif\n",this}});class k_ extends $r{constructor(e){super(e,qs.Vertex),this.registerInput("position",$s.Vector3),this.registerInput("normal",$s.Vector3),this.registerInput("tangent",$s.AutoDetect),this.tangent.addExcludedConnectionPointFromAllowedTypes($s.Color4|$s.Vector4|$s.Vector3),this.registerInput("uv",$s.Vector2),this.registerOutput("positionOutput",$s.Vector3),this.registerOutput("normalOutput",$s.Vector3),this.registerOutput("tangentOutput",$s.Vector4),this.registerOutput("uvOutput",$s.Vector2)}getClassName(){return"MorphTargetsBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get tangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get positionOutput(){return this._outputs[0]}get normalOutput(){return this._outputs[1]}get tangentOutput(){return this._outputs[2]}get uvOutput(){return this._outputs[3]}initialize(e){e._excludeVariableName("morphTargetInfluences")}autoConfigure(e,t=()=>!0){if(!this.position.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"position"===e.name&&t(e)));i||(i=new rn("position"),i.setAsAttribute()),i.output.connectTo(this.position)}if(!this.normal.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"normal"===e.name&&t(e)));i||(i=new rn("normal"),i.setAsAttribute("normal")),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"tangent"===e.name&&t(e)));i||(i=new rn("tangent"),i.setAsAttribute("tangent")),i.output.connectTo(this.tangent)}if(!this.uv.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"uv"===e.name&&t(e)));i||(i=new rn("uv"),i.setAsAttribute("uv")),i.output.connectTo(this.uv)}}prepareDefines(e,t,i){if(e.morphTargetManager){const t=e.morphTargetManager;(null==t?void 0:t.isUsingTextureForTargets)&&t.numInfluencers!==i.NUM_MORPH_INFLUENCERS&&i.markAsAttributesDirty()}i._areAttributesDirty&&Hs.PrepareDefinesForMorphTargets(e,i)}bind(e,t,i){i&&i.morphTargetManager&&i.morphTargetManager.numInfluencers>0&&(Hs.BindMorphTargetParameters(i,e),i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(e))}replaceRepeatableContent(e,t,i,s){const r=this.position,n=this.normal,o=this.tangent,a=this.uv,l=this.positionOutput,h=this.normalOutput,c=this.tangentOutput,u=this.uvOutput,d=e,p=s.NUM_MORPH_INFLUENCERS,_=i.morphTargetManager,f=_&&_.supportsNormals&&s.NORMAL,m=_&&_.supportsTangents&&s.TANGENT,g=_&&_.supportsUVs&&s.UV1;let v="";(null==_?void 0:_.isUsingTextureForTargets)&&p>0&&(v+="float vertexID;\n");for(let e=0;e<p;e++)v+="#ifdef MORPHTARGETS\n",(null==_?void 0:_.isUsingTextureForTargets)?(v+="vertexID = float(gl_VertexID) * morphTargetTextureInfo.x;\n",v+=`${l.associatedVariableName} += (readVector3FromRawSampler(${e}, vertexID) - ${r.associatedVariableName}) * morphTargetInfluences[${e}];\n`,v+="vertexID += 1.0;\n"):v+=`${l.associatedVariableName} += (position${e} - ${r.associatedVariableName}) * morphTargetInfluences[${e}];\n`,f&&(v+="#ifdef MORPHTARGETS_NORMAL\n",(null==_?void 0:_.isUsingTextureForTargets)?(v+=`${h.associatedVariableName} += (readVector3FromRawSampler(${e}, vertexID) - ${n.associatedVariableName}) * morphTargetInfluences[${e}];\n`,v+="vertexID += 1.0;\n"):v+=`${h.associatedVariableName} += (normal${e} - ${n.associatedVariableName}) * morphTargetInfluences[${e}];\n`,v+="#endif\n"),g&&(v+="#ifdef MORPHTARGETS_UV\n",(null==_?void 0:_.isUsingTextureForTargets)?(v+=`${u.associatedVariableName} += (readVector3FromRawSampler(${e}, vertexID).xy - ${a.associatedVariableName}) * morphTargetInfluences[${e}];\n`,v+="vertexID += 1.0;\n"):v+=`${u.associatedVariableName}.xy += (uv_${e} - ${a.associatedVariableName}.xy) * morphTargetInfluences[${e}];\n`,v+="#endif\n"),m&&(v+="#ifdef MORPHTARGETS_TANGENT\n",(null==_?void 0:_.isUsingTextureForTargets)?v+=`${c.associatedVariableName}.xyz += (readVector3FromRawSampler(${e}, vertexID) - ${o.associatedVariableName}.xyz) * morphTargetInfluences[${e}];\n`:v+=`${c.associatedVariableName}.xyz += (tangent${e} - ${o.associatedVariableName}.xyz) * morphTargetInfluences[${e}];\n`,o.type===$s.Vector4?v+=`${c.associatedVariableName}.w = ${o.associatedVariableName}.w;\n`:v+=`${c.associatedVariableName}.w = 1.;\n`,v+="#endif\n"),v+="#endif\n";if(d.compilationString=d.compilationString.replace(this._repeatableContentAnchor,v),p>0)for(let e=0;e<p;e++)d.attributes.push(hi.PositionKind+e),f&&d.attributes.push(hi.NormalKind+e),m&&d.attributes.push(hi.TangentKind+e),g&&d.attributes.push(hi.UVKind+"_"+e)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e.sharedData.repeatableContentBlocks.push(this);const t=this.position,i=this.normal,s=this.tangent,r=this.uv,n=this.positionOutput,o=this.normalOutput,a=this.tangentOutput,l=this.uvOutput,h=`//${this.name}`;return e.uniforms.push("morphTargetInfluences"),e.uniforms.push("morphTargetTextureInfo"),e.uniforms.push("morphTargetTextureIndices"),e.samplers.push("morphTargets"),e._emitFunctionFromInclude("morphTargetsVertexGlobalDeclaration",h),e._emitFunctionFromInclude("morphTargetsVertexDeclaration",h,{repeatKey:"maxSimultaneousMorphTargets"}),e.compilationString+=`${this._declareOutput(n,e)} = ${t.associatedVariableName};\n`,e.compilationString+="#ifdef NORMAL\n",e.compilationString+=`${this._declareOutput(o,e)} = ${i.associatedVariableName};\n`,e.compilationString+="#else\n",e.compilationString+=`${this._declareOutput(o,e)} = vec3(0., 0., 0.);\n`,e.compilationString+="#endif\n",e.compilationString+="#ifdef TANGENT\n",e.compilationString+=`${this._declareOutput(a,e)} = ${s.associatedVariableName};\n`,e.compilationString+="#else\n",e.compilationString+=`${this._declareOutput(a,e)} = vec4(0., 0., 0., 0.);\n`,e.compilationString+="#endif\n",e.compilationString+="#ifdef UV1\n",e.compilationString+=`${this._declareOutput(l,e)} = ${r.associatedVariableName};\n`,e.compilationString+="#else\n",e.compilationString+=`${this._declareOutput(l,e)} = vec2(0., 0.);\n`,e.compilationString+="#endif\n",this._repeatableContentAnchor=e._repeatableContentAnchor,e.compilationString+=this._repeatableContentAnchor,this}}m("BABYLON.MorphTargetsBlock",k_),m("BABYLON.LightInformationBlock",class extends $r{constructor(e){super(e,qs.Vertex),this.registerInput("worldPosition",$s.Vector4,!1,qs.Vertex),this.registerOutput("direction",$s.Vector3),this.registerOutput("color",$s.Color3),this.registerOutput("intensity",$s.Float),this.registerOutput("shadowBias",$s.Float),this.registerOutput("shadowNormalBias",$s.Float),this.registerOutput("shadowDepthScale",$s.Float),this.registerOutput("shadowDepthRange",$s.Vector2)}getClassName(){return"LightInformationBlock"}get worldPosition(){return this._inputs[0]}get direction(){return this._outputs[0]}get color(){return this._outputs[1]}get intensity(){return this._outputs[2]}get shadowBias(){return this._outputs[3]}get shadowNormalBias(){return this._outputs[4]}get shadowDepthScale(){return this._outputs[5]}get shadowDepthRange(){return this._outputs[6]}bind(e,t,i){if(!i)return;this.light&&this.light.isDisposed()&&(this.light=null);let s=this.light;const r=t.getScene();if(!s&&r.lights.length&&(s=this.light=r.lights[0],this._forcePrepareDefines=!0),!s||!s.isEnabled)return e.setFloat3(this._lightDataUniformName,0,0,0),void e.setFloat4(this._lightColorUniformName,0,0,0,0);s.transferToNodeMaterialEffect(e,this._lightDataUniformName),e.setColor4(this._lightColorUniformName,s.diffuse,s.intensity);const n=s.getShadowGenerator();if((this.shadowBias.hasEndpoints||this.shadowNormalBias.hasEndpoints||this.shadowDepthScale.hasEndpoints)&&(n?e.setFloat3(this._lightShadowUniformName,n.bias,n.normalBias,n.depthScale):e.setFloat3(this._lightShadowUniformName,0,0,0)),this.shadowDepthRange)if(n&&r.activeCamera){const t=s;e.setFloat2(this._lightShadowExtraUniformName,t.getDepthMinZ(r.activeCamera),t.getDepthMinZ(r.activeCamera)+t.getDepthMaxZ(r.activeCamera))}else e.setFloat2(this._lightShadowExtraUniformName,0,0)}prepareDefines(e,t,i){if(!i._areLightsDirty&&!this._forcePrepareDefines)return;this._forcePrepareDefines=!1;const s=this.light;i.setValue(this._lightTypeDefineName,!!(s&&s instanceof Wp),!0)}_buildBlock(e){super._buildBlock(e),e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const t=this.direction,i=this.color,s=this.intensity,r=this.shadowBias,n=this.shadowNormalBias,o=this.shadowDepthScale,a=this.shadowDepthRange;return this._lightDataUniformName=e._getFreeVariableName("lightData"),this._lightColorUniformName=e._getFreeVariableName("lightColor"),this._lightShadowUniformName=e._getFreeVariableName("shadowData"),this._lightShadowExtraUniformName=e._getFreeVariableName("shadowExtraData"),this._lightTypeDefineName=e._getFreeDefineName("LIGHTPOINTTYPE"),e._emitUniformFromString(this._lightDataUniformName,"vec3"),e._emitUniformFromString(this._lightColorUniformName,"vec4"),e.compilationString+=`#ifdef ${this._lightTypeDefineName}\n`,e.compilationString+=this._declareOutput(t,e)+` = normalize(${this.worldPosition.associatedVariableName}.xyz - ${this._lightDataUniformName});\n`,e.compilationString+="#else\n",e.compilationString+=this._declareOutput(t,e)+` = ${this._lightDataUniformName};\n`,e.compilationString+="#endif\n",e.compilationString+=this._declareOutput(i,e)+` = ${this._lightColorUniformName}.rgb;\n`,e.compilationString+=this._declareOutput(s,e)+` = ${this._lightColorUniformName}.a;\n`,(r.hasEndpoints||n.hasEndpoints||o.hasEndpoints)&&(e._emitUniformFromString(this._lightShadowUniformName,"vec3"),r.hasEndpoints&&(e.compilationString+=this._declareOutput(r,e)+` = ${this._lightShadowUniformName}.x;\n`),n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = ${this._lightShadowUniformName}.y;\n`),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = ${this._lightShadowUniformName}.z;\n`)),a.hasEndpoints&&(e._emitUniformFromString(this._lightShadowExtraUniformName,"vec2"),e.compilationString+=this._declareOutput(a,e)+` = ${this._lightShadowUniformName};\n`),this}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId))}});class G_ extends $r{constructor(e){super(e,qs.Fragment),this.convertInputToLinearSpace=!0,this.registerInput("color",$s.AutoDetect),this.registerOutput("output",$s.Color4),this.registerOutput("rgb",$s.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes($s.Color3|$s.Color4|$s.Vector3|$s.Vector4)}getClassName(){return"ImageProcessingBlock"}get color(){return this._inputs[0]}get output(){return this._outputs[0]}get rgb(){return this._outputs[1]}initialize(e){e._excludeVariableName("exposureLinear"),e._excludeVariableName("contrast"),e._excludeVariableName("vInverseScreenSize"),e._excludeVariableName("vignetteSettings1"),e._excludeVariableName("vignetteSettings2"),e._excludeVariableName("vCameraColorCurveNegative"),e._excludeVariableName("vCameraColorCurveNeutral"),e._excludeVariableName("vCameraColorCurvePositive"),e._excludeVariableName("txColorTransform"),e._excludeVariableName("colorTransformSettings"),e._excludeVariableName("ditherIntensity")}isReady(e,t,i){return!(i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}prepareDefines(e,t,i){i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i)}bind(e,t,i){i&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_buildBlock(e){var t;super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),e.sharedData.bindableBlocks.push(this),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity");const i=this.color,s=this._outputs[0],r=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",r),e._emitFunctionFromInclude("imageProcessingDeclaration",r),e._emitFunctionFromInclude("imageProcessingFunctions",r),(null===(t=i.connectedPoint)||void 0===t?void 0:t.isConnected)&&(i.connectedPoint.type===$s.Color4||i.connectedPoint.type===$s.Vector4?e.compilationString+=`${this._declareOutput(s,e)} = ${i.associatedVariableName};\n`:e.compilationString+=`${this._declareOutput(s,e)} = vec4(${i.associatedVariableName}, 1.0);\n`,e.compilationString+="#ifdef IMAGEPROCESSINGPOSTPROCESS\n",this.convertInputToLinearSpace&&(e.compilationString+=`${s.associatedVariableName}.rgb = toLinearSpace(${i.associatedVariableName}.rgb);\n`),e.compilationString+="#else\n",e.compilationString+="#ifdef IMAGEPROCESSING\n",this.convertInputToLinearSpace&&(e.compilationString+=`${s.associatedVariableName}.rgb = toLinearSpace(${i.associatedVariableName}.rgb);\n`),e.compilationString+=`${s.associatedVariableName} = applyImageProcessing(${s.associatedVariableName});\n`,e.compilationString+="#endif\n",e.compilationString+="#endif\n",this.rgb.hasEndpoints&&(e.compilationString+=this._declareOutput(this.rgb,e)+` = ${this.output.associatedVariableName}.xyz;\n`)),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertInputToLinearSpace = ${this.convertInputToLinearSpace};\n`,e}serialize(){const e=super.serialize();return e.convertInputToLinearSpace=this.convertInputToLinearSpace,e}_deserialize(e,t,i){var s;super._deserialize(e,t,i),this.convertInputToLinearSpace=null===(s=e.convertInputToLinearSpace)||void 0===s||s}}me([Zr("Convert input to linear space",Js.Boolean,"ADVANCED")],G_.prototype,"convertInputToLinearSpace",void 0),m("BABYLON.ImageProcessingBlock",G_);class z_ extends $r{constructor(e){super(e,qs.Fragment,!0),this.registerInput("normal",$s.AutoDetect,!1),this.normal.addExcludedConnectionPointFromAllowedTypes($s.Color4|$s.Vector4|$s.Vector3),this.registerInput("tangent",$s.Vector4,!1),this.registerInput("world",$s.Matrix,!1),this.registerOutput("TBN",$s.Object,qs.Fragment,new V_("TBN",this,Zs.Output,z_,"TBNBlock")),this.registerOutput("row0",$s.Vector3,qs.Fragment),this.registerOutput("row1",$s.Vector3,qs.Fragment),this.registerOutput("row2",$s.Vector3,qs.Fragment)}getClassName(){return"TBNBlock"}initialize(e){e._excludeVariableName("tbnNormal"),e._excludeVariableName("tbnTangent"),e._excludeVariableName("tbnBitangent"),e._excludeVariableName("TBN")}get normal(){return this._inputs[0]}get tangent(){return this._inputs[1]}get world(){return this._inputs[2]}get TBN(){return this._outputs[0]}get row0(){return this._outputs[1]}get row1(){return this._outputs[2]}get row2(){return this._outputs[3]}get target(){return qs.Fragment}set target(e){}autoConfigure(e,t=()=>!0){if(!this.world.isConnected){let i=e.getInputBlockByPredicate((e=>e.isSystemValue&&e.systemValue===tr.World&&t(e)));i||(i=new rn("world"),i.setAsSystemValue(tr.World)),i.output.connectTo(this.world)}if(!this.normal.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"normal"===e.name&&t(e)));i||(i=new rn("normal"),i.setAsAttribute("normal")),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"tangent"===e.name&&e.type===$s.Vector4&&t(e)));i||(i=new rn("tangent"),i.setAsAttribute("tangent")),i.output.connectTo(this.tangent)}}prepareDefines(e,t,i){var s,r,n,o;const a=this.normal,l=this.tangent;let h=a.isConnected;(null===(s=a.connectInputBlock)||void 0===s?void 0:s.isAttribute)&&!e.isVerticesDataPresent(null===(r=a.connectInputBlock)||void 0===r?void 0:r.name)&&(h=!1);let c=l.isConnected;(null===(n=l.connectInputBlock)||void 0===n?void 0:n.isAttribute)&&!e.isVerticesDataPresent(null===(o=l.connectInputBlock)||void 0===o?void 0:o.name)&&(c=!1);const u=h&&c;i.setValue("TBNBLOCK",u,!0)}_buildBlock(e){super._buildBlock(e);const t=this.normal,i=this.tangent,s=this.world,r=this.TBN,n=this.row0,o=this.row1,a=this.row2;return e.target===qs.Fragment&&(e.compilationString+=`\n                // ${this.name}\n                vec3 tbnNormal = normalize(${t.associatedVariableName}).xyz;\n                vec3 tbnTangent = normalize(${i.associatedVariableName}.xyz);\n                vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${i.associatedVariableName}.w;\n                mat3 ${r.associatedVariableName} = mat3(${s.associatedVariableName}) * mat3(tbnTangent, tbnBitangent, tbnNormal);\n            `,n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = vec3(${r.associatedVariableName}[0][0], ${r.associatedVariableName}[0][1], ${r.associatedVariableName}[0][2]);\n`),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = vec3(${r.associatedVariableName}[1[0], ${r.associatedVariableName}[1][1], ${r.associatedVariableName}[1][2]);\n`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = vec3(${r.associatedVariableName}[2][0], ${r.associatedVariableName}[2][1], ${r.associatedVariableName}[2][2]);\n`),e.sharedData.blocksWithDefines.push(this)),this}}m("BABYLON.TBNBlock",z_);class W_ extends $r{constructor(e){super(e,qs.Fragment),this._tangentSpaceParameterName="",this._tangentCorrectionFactorName="",this._worldMatrixName="",this.invertX=!1,this.invertY=!1,this.useParallaxOcclusion=!1,this.useObjectSpaceNormalMap=!1,this._isUnique=!0,this.registerInput("worldPosition",$s.Vector4,!1),this.registerInput("worldNormal",$s.Vector4,!1),this.registerInput("worldTangent",$s.Vector4,!0),this.registerInput("uv",$s.Vector2,!1),this.registerInput("normalMapColor",$s.Color3,!1),this.registerInput("strength",$s.Float,!1),this.registerInput("viewDirection",$s.Vector3,!0),this.registerInput("parallaxScale",$s.Float,!0),this.registerInput("parallaxHeight",$s.Float,!0),this.registerInput("TBN",$s.Object,!0,qs.VertexAndFragment,new V_("TBN",this,Zs.Input,z_,"TBNBlock")),this.registerInput("world",$s.Matrix,!0),this.registerOutput("output",$s.Vector4),this.registerOutput("uvOffset",$s.Vector2)}getClassName(){return"PerturbNormalBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get worldTangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get normalMapColor(){return this._inputs[4]}get strength(){return this._inputs[5]}get viewDirection(){return this._inputs[6]}get parallaxScale(){return this._inputs[7]}get parallaxHeight(){return this._inputs[8]}get TBN(){return this._inputs[9]}get world(){return this._inputs[10]}get output(){return this._outputs[0]}get uvOffset(){return this._outputs[1]}prepareDefines(e,t,i){const s=this.normalMapColor.connectedPoint._ownerBlock.samplerName,r=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&s||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected);i.setValue("BUMP",!0),i.setValue("PARALLAX",r,!0),i.setValue("PARALLAX_RHS",t.getScene().useRightHandedSystem,!0),i.setValue("PARALLAXOCCLUSION",this.useParallaxOcclusion,!0),i.setValue("OBJECTSPACE_NORMALMAP",this.useObjectSpaceNormalMap,!0)}bind(e,t,i){t.getScene()._mirroredCameraPosition?e.setFloat2(this._tangentSpaceParameterName,this.invertX?1:-1,this.invertY?1:-1):e.setFloat2(this._tangentSpaceParameterName,this.invertX?-1:1,this.invertY?-1:1),i&&(e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1),this.useObjectSpaceNormalMap&&!this.world.isConnected&&e.setMatrix(this._worldMatrixName,i.getWorldMatrix()))}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"uv"===e.name&&t(e)));i||(i=new rn("uv"),i.setAsAttribute()),i.output.connectTo(this.uv)}if(!this.strength.isConnected){const e=new rn("strength");e.value=1,e.output.connectTo(this.strength)}}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`,i=this.uv,s=this.worldPosition,r=this.worldNormal,n=this.worldTangent;e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentSpaceParameterName=e._getFreeDefineName("tangentSpaceParameter"),e._emitUniformFromString(this._tangentSpaceParameterName,"vec2"),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,"float"),this._worldMatrixName=e._getFreeDefineName("perturbNormalWorldMatrix"),e._emitUniformFromString(this._worldMatrixName,"mat4");let o=null;this.normalMapColor.connectedPoint&&(o=this.normalMapColor.connectedPoint._ownerBlock.samplerName);const a=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&o||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected),l=this.parallaxScale.isConnectedToInputBlock?this.parallaxScale.connectInputBlock.isConstant?e._emitFloat(this.parallaxScale.connectInputBlock.value):this.parallaxScale.associatedVariableName:"0.05",h=this.strength.isConnectedToInputBlock&&this.strength.connectInputBlock.isConstant?`\n#if !defined(NORMALXYSCALE)\n1.0/\n#endif\n${e._emitFloat(this.strength.connectInputBlock.value)}`:`\n#if !defined(NORMALXYSCALE)\n1.0/\n#endif\n${this.strength.associatedVariableName}`;e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const c={search:/defined\(TANGENT\)/g,replace:n.isConnected?"defined(TANGENT)":"defined(IGNORE)"},u=this.TBN;u.isConnected?e.compilationString+=`\n            #ifdef TBNBLOCK\n            mat3 vTBN = ${u.associatedVariableName};\n            #endif\n            `:n.isConnected&&(e.compilationString+=`vec3 tbnNormal = normalize(${r.associatedVariableName}.xyz);\n`,e.compilationString+=`vec3 tbnTangent = normalize(${n.associatedVariableName}.xyz);\n`,e.compilationString+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\n`,e.compilationString+="mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\n"),e._emitFunctionFromInclude("bumpFragmentMainFunctions",t,{replaceStrings:[c,{search:/varying mat3 vTBN;/g,replace:""},{search:/uniform mat4 normalMatrix;/g,replace:""}]}),e._emitFunctionFromInclude("bumpFragmentFunctions",t,{replaceStrings:[{search:/#include<samplerFragmentDeclaration>\(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump\)/g,replace:""},{search:/uniform sampler2D bumpSampler;/g,replace:""},{search:/vec2 parallaxOcclusion\(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale\)/g,replace:"#define inline\nvec2 parallaxOcclusion(vec3 vViewDirCoT, vec3 vNormalCoT, vec2 texCoord, float parallaxScale, sampler2D bumpSampler)"},{search:/vec2 parallaxOffset\(vec3 viewDir,float heightScale\)/g,replace:"vec2 parallaxOffset(vec3 viewDir, float heightScale, float height_)"},{search:/texture2D\(bumpSampler,vBumpUV\)\.w/g,replace:"height_"}]});const d=a&&o?`texture2D(${o}, ${i.associatedVariableName} + uvOffset).xyz`:this.normalMapColor.associatedVariableName;return e.compilationString+=this._declareOutput(this.output,e)+" = vec4(0.);\n",e.compilationString+=e._emitCodeFromInclude("bumpFragment",t,{replaceStrings:[{search:/texture2D\(bumpSampler,vBumpUV\)/g,replace:`${d}`},{search:/#define CUSTOM_FRAGMENT_BUMP_FRAGMENT/g,replace:`mat4 normalMatrix = toNormalMatrix(${this.world.isConnected?this.world.associatedVariableName:this._worldMatrixName});`},{search:/perturbNormal\(TBN,texture2D\(bumpSampler,vBumpUV\+uvOffset\).xyz,vBumpInfos.y\)/g,replace:`perturbNormal(TBN, ${d}, vBumpInfos.y)`},{search:/parallaxOcclusion\(invTBN\*-viewDirectionW,invTBN\*normalW,vBumpUV,vBumpInfos.z\)/g,replace:`parallaxOcclusion((invTBN * -viewDirectionW), (invTBN * normalW), vBumpUV, vBumpInfos.z, ${a&&this.useParallaxOcclusion?o:"bumpSampler"})`},{search:/parallaxOffset\(invTBN\*viewDirectionW,vBumpInfos\.z\)/g,replace:`parallaxOffset(invTBN * viewDirectionW, vBumpInfos.z, ${a?this.parallaxHeight.associatedVariableName:"0."})`},{search:/vTangentSpaceParams/g,replace:this._tangentSpaceParameterName},{search:/vBumpInfos.y/g,replace:h},{search:/vBumpInfos.z/g,replace:l},{search:/vBumpUV/g,replace:i.associatedVariableName},{search:/vPositionW/g,replace:s.associatedVariableName+".xyz"},{search:/normalW=/g,replace:this.output.associatedVariableName+".xyz = "},{search:/mat3\(normalMatrix\)\*normalW/g,replace:"mat3(normalMatrix) * "+this.output.associatedVariableName+".xyz"},{search:/normalW/g,replace:r.associatedVariableName+".xyz"},{search:/viewDirectionW/g,replace:a?this.viewDirection.associatedVariableName:"vec3(0.)"},c]}),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.invertX = ${this.invertX};\n`;return e+=`${this._codeVariableName}.invertY = ${this.invertY};\n`,e+=`${this._codeVariableName}.useParallaxOcclusion = ${this.useParallaxOcclusion};\n`,e+=`${this._codeVariableName}.useObjectSpaceNormalMap = ${this.useObjectSpaceNormalMap};\n`,e}serialize(){const e=super.serialize();return e.invertX=this.invertX,e.invertY=this.invertY,e.useParallaxOcclusion=this.useParallaxOcclusion,e.useObjectSpaceNormalMap=this.useObjectSpaceNormalMap,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.invertX=e.invertX,this.invertY=e.invertY,this.useParallaxOcclusion=!!e.useParallaxOcclusion,this.useObjectSpaceNormalMap=!!e.useObjectSpaceNormalMap}}me([Zr("Invert X axis",Js.Boolean,"PROPERTIES",{notifiers:{update:!1}})],W_.prototype,"invertX",void 0),me([Zr("Invert Y axis",Js.Boolean,"PROPERTIES",{notifiers:{update:!1}})],W_.prototype,"invertY",void 0),me([Zr("Use parallax occlusion",Js.Boolean)],W_.prototype,"useParallaxOcclusion",void 0),me([Zr("Object Space Mode",Js.Boolean,"PROPERTIES",{notifiers:{update:!1}})],W_.prototype,"useObjectSpaceNormalMap",void 0),m("BABYLON.PerturbNormalBlock",W_),m("BABYLON.DiscardBlock",class extends $r{constructor(e){super(e,qs.Fragment,!0),this.registerInput("value",$s.Float,!0),this.registerInput("cutoff",$s.Float,!0)}getClassName(){return"DiscardBlock"}get value(){return this._inputs[0]}get cutoff(){return this._inputs[1]}_buildBlock(e){if(super._buildBlock(e),e.sharedData.hints.needAlphaTesting=!0,this.cutoff.isConnected&&this.value.isConnected)return e.compilationString+=`if (${this.value.associatedVariableName} < ${this.cutoff.associatedVariableName}) discard;\n`,this}}),m("BABYLON.FrontFacingBlock",class extends $r{constructor(e){super(e,qs.Fragment),this.registerOutput("output",$s.Float,qs.Fragment)}getClassName(){return"FrontFacingBlock"}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),e.target===qs.Vertex)throw"FrontFacingBlock must only be used in a fragment shader";const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = gl_FrontFacing ? 1.0 : 0.0;\n",this}}),m("BABYLON.DerivativeBlock",class extends $r{constructor(e){super(e,qs.Fragment),this.registerInput("input",$s.AutoDetect,!1),this.registerOutput("dx",$s.BasedOnInput),this.registerOutput("dy",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[1]._typeConnectionSource=this._inputs[0]}getClassName(){return"DerivativeBlock"}get input(){return this._inputs[0]}get dx(){return this._outputs[0]}get dy(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._outputs[1];return e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),t.hasEndpoints&&(e.compilationString+=this._declareOutput(t,e)+` = dFdx(${this.input.associatedVariableName});\n`),i.hasEndpoints&&(e.compilationString+=this._declareOutput(i,e)+` = dFdy(${this.input.associatedVariableName});\n`),this}}),m("BABYLON.FragCoordBlock",class extends $r{constructor(e){super(e,qs.Fragment),this.registerOutput("xy",$s.Vector2,qs.Fragment),this.registerOutput("xyz",$s.Vector3,qs.Fragment),this.registerOutput("xyzw",$s.Vector4,qs.Fragment),this.registerOutput("x",$s.Float,qs.Fragment),this.registerOutput("y",$s.Float,qs.Fragment),this.registerOutput("z",$s.Float,qs.Fragment),this.registerOutput("w",$s.Float,qs.Fragment)}getClassName(){return"FragCoordBlock"}get xy(){return this._outputs[0]}get xyz(){return this._outputs[1]}get xyzw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get output(){return this._outputs[6]}writeOutputs(e){let t="";for(const i of this._outputs)i.hasEndpoints&&(t+=`${this._declareOutput(i,e)} = gl_FragCoord.${i.name};\n`);return t}_buildBlock(e){if(super._buildBlock(e),e.target===qs.Vertex)throw"FragCoordBlock must only be used in a fragment shader";return e.compilationString+=this.writeOutputs(e),this}}),m("BABYLON.ScreenSizeBlock",class extends $r{constructor(e){super(e,qs.Fragment),this.registerOutput("xy",$s.Vector2,qs.Fragment),this.registerOutput("x",$s.Float,qs.Fragment),this.registerOutput("y",$s.Float,qs.Fragment)}getClassName(){return"ScreenSizeBlock"}get xy(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}bind(e){const t=this._scene.getEngine();e.setFloat2(this._varName,t.getRenderWidth(),t.getRenderHeight())}writeOutputs(e,t){let i="";for(const s of this._outputs)s.hasEndpoints&&(i+=`${this._declareOutput(s,e)} = ${t}.${s.name};\n`);return i}_buildBlock(e){if(super._buildBlock(e),this._scene=e.sharedData.scene,e.target===qs.Vertex)throw"ScreenSizeBlock must only be used in a fragment shader";return e.sharedData.bindableBlocks.push(this),this._varName=e._getFreeVariableName("screenSize"),e._emitUniformFromString(this._varName,"vec2"),e.compilationString+=this.writeOutputs(e,this._varName),this}}),m("BABYLON.ScreenSpaceBlock",class extends $r{constructor(e){super(e,qs.Fragment),this.registerInput("vector",$s.AutoDetect),this.registerInput("worldViewProjection",$s.Matrix),this.registerOutput("output",$s.Vector2),this.registerOutput("x",$s.Float),this.registerOutput("y",$s.Float),this.inputs[0].addExcludedConnectionPointFromAllowedTypes($s.Color3|$s.Vector3|$s.Vector4)}getClassName(){return"ScreenSpaceBlock"}get vector(){return this._inputs[0]}get worldViewProjection(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(e,t=()=>!0){if(!this.worldViewProjection.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===tr.WorldViewProjection&&t(e)));i||(i=new rn("worldViewProjection"),i.setAsSystemValue(tr.WorldViewProjection)),i.output.connectTo(this.worldViewProjection)}}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.worldViewProjection;if(!t.connectedPoint)return;const s=i.associatedVariableName,r=e._getFreeVariableName("screenSpaceTemp");switch(t.connectedPoint.type){case $s.Vector3:e.compilationString+=`vec4 ${r} = ${s} * vec4(${t.associatedVariableName}, 1.0);\n`;break;case $s.Vector4:e.compilationString+=`vec4 ${r} = ${s} * ${t.associatedVariableName};\n`}return e.compilationString+=`${r}.xy /= ${r}.w;`,e.compilationString+=`${r}.xy = ${r}.xy * 0.5 + vec2(0.5, 0.5);`,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${r}.xy;\n`),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+` = ${r}.x;\n`),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+` = ${r}.y;\n`),this}}),m("BABYLON.TwirlBlock",class extends $r{constructor(e){super(e,qs.Fragment),this.registerInput("input",$s.Vector2),this.registerInput("strength",$s.Float),this.registerInput("center",$s.Vector2),this.registerInput("offset",$s.Vector2),this.registerOutput("output",$s.Vector2),this.registerOutput("x",$s.Float),this.registerOutput("y",$s.Float)}getClassName(){return"TwirlBlock"}get input(){return this._inputs[0]}get strength(){return this._inputs[1]}get center(){return this._inputs[2]}get offset(){return this._inputs[3]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(){if(!this.center.isConnected){const e=new rn("center");e.value=new E(.5,.5),e.output.connectTo(this.center)}if(!this.strength.isConnected){const e=new rn("strength");e.value=1,e.output.connectTo(this.strength)}if(!this.offset.isConnected){const e=new rn("offset");e.value=new E(0,0),e.output.connectTo(this.offset)}}_buildBlock(e){super._buildBlock(e);const t=e._getFreeVariableName("delta"),i=e._getFreeVariableName("angle"),s=e._getFreeVariableName("x"),r=e._getFreeVariableName("y"),n=e._getFreeVariableName("result");return e.compilationString+=`\n            vec2 ${t} = ${this.input.associatedVariableName} - ${this.center.associatedVariableName};\n            float ${i} = ${this.strength.associatedVariableName} * length(${t});\n            float ${s} = cos(${i}) * ${t}.x - sin(${i}) * ${t}.y;\n            float ${r} = sin(${i}) * ${t}.x + cos(${i}) * ${t}.y;\n            vec2 ${n} = vec2(${s} + ${this.center.associatedVariableName}.x + ${this.offset.associatedVariableName}.x, ${r} + ${this.center.associatedVariableName}.y + ${this.offset.associatedVariableName}.y);\n        `,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${n};\n`),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+` = ${n}.x;\n`),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+` = ${n}.y;\n`),this}});class H_ extends $r{constructor(e){super(e,qs.Fragment),this.generateInWorldSpace=!1,this.automaticNormalizationNormal=!0,this.automaticNormalizationTangent=!0,this.registerInput("input",$s.Float),this.registerInput("worldPosition",$s.Vector3),this.registerInput("worldNormal",$s.Vector3),this.registerInput("worldTangent",$s.AutoDetect,!0),this.registerOutput("output",$s.Vector4),this.registerOutput("xyz",$s.Vector3),this._inputs[3].addExcludedConnectionPointFromAllowedTypes($s.Color3|$s.Vector3|$s.Vector4)}getClassName(){return"HeightToNormalBlock"}get input(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];this.generateInWorldSpace||this.worldTangent.isConnected||console.error(`You must connect the 'worldTangent' input of the ${this.name} block!`);const i=this.generateInWorldSpace?"":"\n            vec3 biTangent = cross(normal, tangent);\n            mat3 TBN = mat3(tangent, biTangent, normal);\n            ",s=this.generateInWorldSpace?"":"\n            result = TBN * result;\n            result = result * vec3(0.5) + vec3(0.5);\n            ",r=`\n            vec4 heightToNormal(in float height, in vec3 position, in vec3 tangent, in vec3 normal) {\n                ${i}\n                ${this.automaticNormalizationTangent?"tangent = normalize(tangent);":""}\n                ${this.automaticNormalizationNormal?"normal = normalize(normal);":""}\n                vec3 worlddX = dFdx(position);\n                vec3 worlddY = dFdy(position);\n                vec3 crossX = cross(normal, worlddX);\n                vec3 crossY = cross(normal, worlddY);\n                float d = abs(dot(crossY, worlddX));\n                vec3 inToNormal = vec3(((((height + dFdx(height)) - height) * crossY) + (((height + dFdy(height)) - height) * crossX)) * sign(d));\n                inToNormal.y *= -1.0;\n                vec3 result = normalize((d * normal) - inToNormal);\n                ${s}\n                return vec4(result, 0.);\n            }`;return e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitFunction("heightToNormal",r,"// heightToNormal"),e.compilationString+=this._declareOutput(t,e)+` = heightToNormal(${this.input.associatedVariableName}, ${this.worldPosition.associatedVariableName}, ${this.worldTangent.isConnected?this.worldTangent.associatedVariableName:"vec3(0.)"}.xyz, ${this.worldNormal.associatedVariableName});\n`,this.xyz.hasEndpoints&&(e.compilationString+=this._declareOutput(this.xyz,e)+` = ${this.output.associatedVariableName}.xyz;\n`),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.generateInWorldSpace = ${this.generateInWorldSpace};\n`,e+=`${this._codeVariableName}.automaticNormalizationNormal = ${this.automaticNormalizationNormal};\n`,e+=`${this._codeVariableName}.automaticNormalizationTangent = ${this.automaticNormalizationTangent};\n`,e}serialize(){const e=super.serialize();return e.generateInWorldSpace=this.generateInWorldSpace,e.automaticNormalizationNormal=this.automaticNormalizationNormal,e.automaticNormalizationTangent=this.automaticNormalizationTangent,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.generateInWorldSpace=e.generateInWorldSpace,this.automaticNormalizationNormal=e.automaticNormalizationNormal,this.automaticNormalizationTangent=e.automaticNormalizationTangent}}me([Zr("Generate in world space instead of tangent space",Js.Boolean,"PROPERTIES",{notifiers:{update:!0}})],H_.prototype,"generateInWorldSpace",void 0),me([Zr("Force normalization for the worldNormal input",Js.Boolean,"PROPERTIES",{notifiers:{update:!0}})],H_.prototype,"automaticNormalizationNormal",void 0),me([Zr("Force normalization for the worldTangent input",Js.Boolean,"PROPERTIES",{notifiers:{update:!0}})],H_.prototype,"automaticNormalizationTangent",void 0),m("BABYLON.HeightToNormalBlock",H_),m("BABYLON.FragDepthBlock",class extends $r{constructor(e){super(e,qs.Fragment,!0),this.registerInput("depth",$s.Float,!0),this.registerInput("worldPos",$s.Vector4,!0),this.registerInput("viewProjection",$s.Matrix,!0)}getClassName(){return"FragDepthBlock"}get depth(){return this._inputs[0]}get worldPos(){return this._inputs[1]}get viewProjection(){return this._inputs[2]}_buildBlock(e){return super._buildBlock(e),this.depth.isConnected?e.compilationString+=`gl_FragDepth = ${this.depth.associatedVariableName};\n`:this.worldPos.isConnected&&this.viewProjection.isConnected?e.compilationString+=`\n                vec4 p = ${this.viewProjection.associatedVariableName} * ${this.worldPos.associatedVariableName};\n                float v = p.z / p.w;\n                #ifndef IS_NDC_HALF_ZRANGE\n                    v = v * 0.5 + 0.5;\n                #endif\n                gl_FragDepth = v;\n    \n            `:console.warn("FragDepthBlock: either the depth input or both the worldPos and viewProjection inputs must be connected!"),this}}),m("BABYLON.ShadowMapBlock",class extends $r{constructor(e){super(e,qs.Fragment),this.registerInput("worldPosition",$s.Vector4,!1),this.registerInput("viewProjection",$s.Matrix,!1),this.registerInput("worldNormal",$s.AutoDetect,!0),this.registerOutput("depth",$s.Vector3),this.worldNormal.addExcludedConnectionPointFromAllowedTypes($s.Color3|$s.Vector3|$s.Vector4)}getClassName(){return"ShadowMapBlock"}initialize(e){e._excludeVariableName("vPositionWSM"),e._excludeVariableName("lightDataSM"),e._excludeVariableName("biasAndScaleSM"),e._excludeVariableName("depthValuesSM"),e._excludeVariableName("clipPos"),e._excludeVariableName("worldPos"),e._excludeVariableName("zSM")}get worldPosition(){return this._inputs[0]}get viewProjection(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get depth(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;return e._emitUniformFromString("biasAndScaleSM","vec3"),e._emitUniformFromString("lightDataSM","vec3"),e._emitUniformFromString("depthValuesSM","vec2"),e._emitFunctionFromInclude("packingFunctions",t),e.compilationString+=`vec4 worldPos = ${this.worldPosition.associatedVariableName};\n`,e.compilationString+="vec3 vPositionWSM;\n",e.compilationString+="float vDepthMetricSM = 0.0;\n",e.compilationString+="float zSM;\n",this.worldNormal.isConnected&&(e.compilationString+=`vec3 vNormalW = ${this.worldNormal.associatedVariableName}.xyz;\n`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexNormalBias",t)),e.compilationString+=`vec4 clipPos = ${this.viewProjection.associatedVariableName} * worldPos;\n`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexMetric",t,{replaceStrings:[{search:/gl_Position/g,replace:"clipPos"}]}),e.compilationString+=e._emitCodeFromInclude("shadowMapFragment",t,{replaceStrings:[{search:/return;/g,replace:""}]}),e.compilationString+="\n            #if SM_DEPTHTEXTURE == 1\n                #ifdef IS_NDC_HALF_ZRANGE\n                    gl_FragDepth = (clipPos.z / clipPos.w);\n                #else\n                    gl_FragDepth = (clipPos.z / clipPos.w) * 0.5 + 0.5;\n                #endif\n            #endif\n        ",e.compilationString+=`${this._declareOutput(this.depth,e)} = vec3(depthSM, 1., 1.);\n`,this}}),m("BABYLON.PrePassOutputBlock",class extends $r{constructor(e){super(e,qs.Fragment,!0),this.registerInput("viewDepth",$s.Float,!0),this.registerInput("worldPosition",$s.AutoDetect,!0),this.registerInput("viewNormal",$s.AutoDetect,!0),this.registerInput("reflectivity",$s.AutoDetect,!0),this.inputs[1].addExcludedConnectionPointFromAllowedTypes($s.Vector3|$s.Vector4),this.inputs[2].addExcludedConnectionPointFromAllowedTypes($s.Vector3|$s.Vector4),this.inputs[3].addExcludedConnectionPointFromAllowedTypes($s.Vector3|$s.Vector4|$s.Color3|$s.Color4)}getClassName(){return"PrePassOutputBlock"}get viewDepth(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get viewNormal(){return this._inputs[2]}get reflectivity(){return this._inputs[3]}_buildBlock(e){super._buildBlock(e);const t=this.worldPosition,i=this.viewNormal,s=this.viewDepth,r=this.reflectivity;e.sharedData.blocksWithDefines.push(this);const n=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",n),e.compilationString+="#if defined(PREPASS)\r\n",e.compilationString+="#ifdef PREPASS_DEPTH\r\n",s.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_DEPTH_INDEX] = vec4(${s.associatedVariableName}, 0.0, 0.0, 1.0);\r\n`:e.compilationString+=" gl_FragData[PREPASS_DEPTH_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r\n",e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_POSITION\r\n",t.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_POSITION_INDEX] = vec4(${t.associatedVariableName}.rgb, ${t.connectedPoint.type===$s.Vector4?t.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=" gl_FragData[PREPASS_POSITION_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r\n",e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_NORMAL\r\n",i.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_NORMAL_INDEX] = vec4(${i.associatedVariableName}.rgb, ${i.connectedPoint.type===$s.Vector4?i.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=" gl_FragData[PREPASS_NORMAL_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r\n",e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_REFLECTIVITY\r\n",r.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_REFLECTIVITY_INDEX] = vec4(${r.associatedVariableName}.rgb, ${r.connectedPoint.type===$s.Vector4?r.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=" gl_FragData[PREPASS_REFLECTIVITY_INDEX] = vec4(0.0, 0.0, 0.0, 1.0);\r\n",e.compilationString+="#endif\r\n",e.compilationString+="#endif\r\n",this}}),m("BABYLON.FogBlock",class extends $r{constructor(e){super(e,qs.VertexAndFragment,!1),this.registerInput("worldPosition",$s.Vector4,!1,qs.Vertex),this.registerInput("view",$s.Matrix,!1,qs.Vertex),this.registerInput("input",$s.AutoDetect,!1,qs.Fragment),this.registerInput("fogColor",$s.AutoDetect,!1,qs.Fragment),this.registerOutput("output",$s.Color3,qs.Fragment),this.input.addExcludedConnectionPointFromAllowedTypes($s.Color3|$s.Vector3|$s.Color4),this.fogColor.addExcludedConnectionPointFromAllowedTypes($s.Color3|$s.Vector3|$s.Color4)}getClassName(){return"FogBlock"}get worldPosition(){return this._inputs[0]}get view(){return this._inputs[1]}get input(){return this._inputs[2]}get fogColor(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(e,t=()=>!0){if(!this.view.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===tr.View&&t(e)));i||(i=new rn("view"),i.setAsSystemValue(tr.View)),i.output.connectTo(this.view)}if(!this.fogColor.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===tr.FogColor&&t(e)));i||(i=new rn("fogColor",void 0,$s.Color3),i.setAsSystemValue(tr.FogColor)),i.output.connectTo(this.fogColor)}}prepareDefines(e,t,i){const s=e.getScene();i.setValue("FOG",t.fogEnabled&&Hs.GetFogState(e,s))}bind(e,t,i){if(!i)return;const s=i.getScene();e.setFloat4(this._fogParameters,s.fogMode,s.fogStart,s.fogEnd,s.fogDensity)}_buildBlock(e){if(super._buildBlock(e),e.target===qs.Fragment){e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e._emitFunctionFromInclude("fogFragmentDeclaration",`//${this.name}`,{removeUniforms:!0,removeVaryings:!0,removeIfDef:!1,replaceStrings:[{search:/float CalcFogFactor\(\)/,replace:"float CalcFogFactor(vec3 vFogDistance, vec4 vFogInfos)"}]});const t=e._getFreeVariableName("fog"),i=this.input,s=this.fogColor;this._fogParameters=e._getFreeVariableName("fogParameters");const r=this._outputs[0];e._emitUniformFromString(this._fogParameters,"vec4"),e.compilationString+="#ifdef FOG\n",e.compilationString+=`float ${t} = CalcFogFactor(${this._fogDistanceName}, ${this._fogParameters});\n`,e.compilationString+=this._declareOutput(r,e)+` = ${t} * ${i.associatedVariableName}.rgb + (1.0 - ${t}) * ${s.associatedVariableName}.rgb;\n`,e.compilationString+=`#else\n${this._declareOutput(r,e)} =  ${i.associatedVariableName}.rgb;\n`,e.compilationString+="#endif\n"}else{const t=this.worldPosition,i=this.view;this._fogDistanceName=e._getFreeVariableName("vFogDistance"),e._emitVaryingFromString(this._fogDistanceName,"vec3"),e.compilationString+=`${this._fogDistanceName} = (${i.associatedVariableName} * ${t.associatedVariableName}).xyz;\n`}return this}});class X_ extends $r{static _OnGenerateOnlyFragmentCodeChanged(e,t){const i=e;return i.worldPosition.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,console.error("The worldPosition input must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?qs.Fragment:qs.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?qs.Fragment:qs.Vertex}constructor(e){super(e,qs.VertexAndFragment),this._lightId=0,this.generateOnlyFragmentCode=!1,this._isUnique=!0,this.registerInput("worldPosition",$s.Vector4,!1,qs.Vertex),this.registerInput("worldNormal",$s.Vector4,!1,qs.Fragment),this.registerInput("cameraPosition",$s.Vector3,!1,qs.Fragment),this.registerInput("glossiness",$s.Float,!0,qs.Fragment),this.registerInput("glossPower",$s.Float,!0,qs.Fragment),this.registerInput("diffuseColor",$s.Color3,!0,qs.Fragment),this.registerInput("specularColor",$s.Color3,!0,qs.Fragment),this.registerInput("view",$s.Matrix,!0),this.registerOutput("diffuseOutput",$s.Color3,qs.Fragment),this.registerOutput("specularOutput",$s.Color3,qs.Fragment),this.registerOutput("shadow",$s.Float,qs.Fragment)}getClassName(){return"LightBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get cameraPosition(){return this._inputs[2]}get glossiness(){return this._inputs[3]}get glossPower(){return this._inputs[4]}get diffuseColor(){return this._inputs[5]}get specularColor(){return this._inputs[6]}get view(){return this._inputs[7]}get diffuseOutput(){return this._outputs[0]}get specularOutput(){return this._outputs[1]}get shadow(){return this._outputs[2]}autoConfigure(e,t=()=>!0){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===tr.CameraPosition&&t(e)));i||(i=new rn("cameraPosition"),i.setAsSystemValue(tr.CameraPosition)),i.output.connectTo(this.cameraPosition)}}prepareDefines(e,t,i){if(!i._areLightsDirty)return;const s=e.getScene();if(this.light){const t={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};Hs.PrepareDefinesForLight(s,e,this.light,this._lightId,i,!0,t),t.needRebuild&&i.rebuild()}else Hs.PrepareDefinesForLights(s,e,i,!0,t.maxSimultaneousLights)}updateUniformsAndSamples(e,t,i,s){for(let r=0;r<t.maxSimultaneousLights&&i["LIGHT"+r];r++){const t=e.uniforms.indexOf("vLightData"+r)>=0;Hs.PrepareUniformsAndSamplersForLight(r,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+r],s,t)}}bind(e,t,i){if(!i)return;const s=i.getScene();this.light?Hs.BindLight(this.light,this._lightId,s,e,!0):Hs.BindLights(s,i,e,!0,t.maxSimultaneousLights)}_injectVertexCode(e){const t=this.worldPosition,i=`//${this.name}`;this.light?(this._lightId=(void 0!==e.counters.lightCounter?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const s="v_"+t.associatedVariableName;e._emitVaryingFromString(s,"vec4")&&(e.compilationString+=`${s} = ${t.associatedVariableName};\n`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+=`vec4 worldPos = ${t.associatedVariableName};\n`,this.view.isConnected&&(e.compilationString+=`mat4 view = ${this.view.associatedVariableName};\n`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{repeatKey:"maxSimultaneousLights"}))}_buildBlock(e){if(super._buildBlock(e),e.target!==qs.Fragment)return void this._injectVertexCode(e);this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const t=`//${this.name}`,i=this.worldPosition;let s=i.associatedVariableName;this.generateOnlyFragmentCode?(s=e._getFreeVariableName("globalWorldPos"),e._emitFunction("light_globalworldpos",`vec3 ${s};\n`,t),e.compilationString+=`${s} = ${i.associatedVariableName}.xyz;\n`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",t,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${i.associatedVariableName}`:void 0})):s="v_"+s+".xyz",e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("lightsFragmentFunctions",t,{replaceStrings:[{search:/vPositionW/g,replace:s}]}),e._emitFunctionFromInclude("shadowsFragmentFunctions",t,{replaceStrings:[{search:/vPositionW/g,replace:s}]}),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0}),0===this._lightId&&(e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`vec3 viewDirectionW = normalize(${this.cameraPosition.associatedVariableName} - ${s});\n`),e.compilationString+="lightingInfo info;\n",e.compilationString+="float shadow = 1.;\n",e.compilationString+="float aggShadow = 0.;\n",e.compilationString+="float numLights = 0.;\n",e.compilationString+=`float glossiness = ${this.glossiness.isConnected?this.glossiness.associatedVariableName:"1.0"} * ${this.glossPower.isConnected?this.glossPower.associatedVariableName:"1024.0"};\n`,e.compilationString+="vec3 diffuseBase = vec3(0., 0., 0.);\n",e.compilationString+="vec3 specularBase = vec3(0., 0., 0.);\n",e.compilationString+=`vec3 normalW = ${this.worldNormal.associatedVariableName}.xyz;\n`),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/vPositionW/g,replace:s+".xyz"}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",t,{repeatKey:"maxSimultaneousLights",substitutionVars:`vPositionW,${s}.xyz`}),0===this._lightId&&(e.compilationString+="aggShadow = aggShadow / numLights;\n");const r=this.diffuseOutput,n=this.specularOutput;return e.compilationString+=this._declareOutput(r,e)+` = diffuseBase${this.diffuseColor.isConnected?" * "+this.diffuseColor.associatedVariableName:""};\n`,n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = specularBase${this.specularColor.isConnected?" * "+this.specularColor.associatedVariableName:""};\n`),this.shadow.hasEndpoints&&(e.compilationString+=this._declareOutput(this.shadow,e)+" = aggShadow;\n"),this}serialize(){const e=super.serialize();return e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}me([Zr("Generate only fragment code",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:X_._OnGenerateOnlyFragmentCodeChanged}})],X_.prototype,"generateOnlyFragmentCode",void 0),m("BABYLON.LightBlock",X_);class Y_ extends $r{get texture(){return this._texture}set texture(e){var t;if(this._texture===e)return;const i=null!==(t=null==e?void 0:e.getScene())&&void 0!==t?t:x.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this._texture))),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,(t=>t.hasTexture(e)))}get samplerName(){return this._samplerName}constructor(e){super(e,qs.VertexAndFragment),this.registerOutput("source",$s.Object,qs.VertexAndFragment,new V_("source",this,Zs.Output,Y_,"ImageSourceBlock"))}bind(e){this.texture&&e.setTexture(this._samplerName,this.texture)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}getClassName(){return"ImageSourceBlock"}get source(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.target===qs.Vertex&&(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this)),e._emit2DSampler(this._samplerName),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture?(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\n`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\n`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\n`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\n`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\n`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\n`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\n`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\n`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\n`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`,e):e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&"VideoTexture"!==this.texture.getClassName()&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&!Hn.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=Ar.Parse(e.texture,t,i))}}m("BABYLON.ImageSourceBlock",Y_);class j_ extends $r{get texture(){var e;return this.source.isConnected?(null===(e=this.source.connectedPoint)||void 0===e?void 0:e.ownerBlock).texture:this._texture}set texture(e){var t;if(this._texture===e)return;const i=null!==(t=null==e?void 0:e.getScene())&&void 0!==t?t:x.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this._texture))),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,(t=>t.hasTexture(e)))}static _IsPrePassTextureBlock(e){return"PrePassTextureBlock"===(null==e?void 0:e.getClassName())}get _isSourcePrePass(){return j_._IsPrePassTextureBlock(this._imageSource)}get samplerName(){if(this._imageSource){if(!j_._IsPrePassTextureBlock(this._imageSource))return this._imageSource.samplerName;if(this.source.connectedPoint)return this._imageSource.getSamplerName(this.source.connectedPoint)}return this._samplerName}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){var t;if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){const e=null!==(t=this.texture.getScene())&&void 0!==t?t:x.LastCreatedScene;null==e||e.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this.texture)))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){var t;if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){const e=null!==(t=this.texture.getScene())&&void 0!==t?t:x.LastCreatedScene;null==e||e.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this.texture)))}}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,t?qs.Fragment:qs.VertexAndFragment),this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this._fragmentOnly=t,this.registerInput("uv",$s.AutoDetect,!1,qs.VertexAndFragment),this.registerInput("source",$s.Object,!0,qs.VertexAndFragment,new V_("source",this,Zs.Input,Y_,"ImageSourceBlock")),this.registerInput("layer",$s.Float,!0),this.registerInput("lod",$s.Float,!0),this.registerOutput("rgba",$s.Color4,qs.Neutral),this.registerOutput("rgb",$s.Color3,qs.Neutral),this.registerOutput("r",$s.Float,qs.Neutral),this.registerOutput("g",$s.Float,qs.Neutral),this.registerOutput("b",$s.Float,qs.Neutral),this.registerOutput("a",$s.Float,qs.Neutral),this.registerOutput("level",$s.Float,qs.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes($s.Vector2|$s.Vector3|$s.Vector4),this._inputs[0]._prioritizeVertex=!t}getClassName(){return"TextureBlock"}get uv(){return this._inputs[0]}get source(){return this._inputs[1]}get layer(){return this._inputs[2]}get lod(){return this._inputs[3]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}get target(){if(this._fragmentOnly)return qs.Fragment;if(!this.uv.isConnected)return qs.VertexAndFragment;if(this.uv.sourceBlock.isInput)return qs.VertexAndFragment;let e=this.uv.connectedPoint;for(;e;){if(e.target===qs.Fragment)return qs.Fragment;if(e.target===qs.Vertex)return qs.VertexAndFragment;if(e.target===qs.Neutral||e.target===qs.VertexAndFragment){const t=e.ownerBlock;if(t.target===qs.Fragment)return qs.Fragment;e=null;for(const i of t.inputs)if(i.connectedPoint){e=i.connectedPoint;break}}}return qs.VertexAndFragment}set target(e){}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected)if(e.mode===mn.PostProcess){const i=e.getBlockByPredicate((e=>"uv"===e.name&&t(e)));i&&i.connectTo(this)}else{const i=e.mode===mn.Particle?"particle_uv":"uv";let s=e.getInputBlockByPredicate((e=>e.isAttribute&&e.name===i&&t(e)));s||(s=new rn("uv"),s.setAsAttribute(i)),s.output.connectTo(this.uv)}}initializeDefines(e,t,i){i._areTexturesDirty&&void 0!==this._mainUVDefineName&&i.setValue(this._mainUVDefineName,!1,!0)}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;if(!this.texture||!this.texture.getTextureMatrix)return void(this._isMixed&&(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)));const s=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,r=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,s,!0),i.setValue(this._gammaDefineName,r,!0),this._isMixed&&(this.texture.getTextureMatrix().isIdentityAs3x2()?(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)):(i.setValue(this._defineName,!0),null==i[this._mainUVDefineName]&&i.setValue(this._mainUVDefineName,!1,!0)))}isReady(){return!!this._isSourcePrePass||!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){this._isSourcePrePass&&e.setFloat(this._textureInfoName,1),this.texture&&(this._isMixed&&(e.setFloat(this._textureInfoName,this.texture.level),e.setMatrix(this._textureTransformName,this.texture.getTextureMatrix())),this._imageSource||e.setTexture(this._samplerName,this.texture))}get _isMixed(){return this.target!==qs.Fragment}_injectVertexCode(e){const t=this.uv;if(this._defineName=e._getFreeDefineName("UVTRANSFORM"),this._mainUVDefineName="VMAIN"+t.associatedVariableName.toUpperCase(),this._mainUVName="vMain"+t.associatedVariableName,this._transformedUVName=e._getFreeVariableName("transformedUV"),this._textureTransformName=e._getFreeVariableName("textureTransform"),this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=this._textureInfoName,e._emitVaryingFromString(this._transformedUVName,"vec2",this._defineName),e._emitVaryingFromString(this._mainUVName,"vec2",this._mainUVDefineName),e._emitUniformFromString(this._textureTransformName,"mat4",this._defineName),e.compilationString+=`#ifdef ${this._defineName}\n`,e.compilationString+=`${this._transformedUVName} = vec2(${this._textureTransformName} * vec4(${t.associatedVariableName}.xy, 1.0, 0.0));\n`,e.compilationString+=`#elif defined(${this._mainUVDefineName})\n`,e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\n`,e.compilationString+="#endif\n",this._outputs.some((e=>e.isConnectedInVertexShader))){this._writeTextureRead(e,!0);for(const t of this._outputs)t.hasEndpoints&&"level"!==t.name&&this._writeOutput(e,t,t.name,!0)}}_getUVW(e){var t,i,s;let r=e;return null!==(s=null===(i=null===(t=this._texture)||void 0===t?void 0:t._texture)||void 0===i?void 0:i.is2DArray)&&void 0!==s&&s&&(r=`vec3(${e}, ${this.layer.isConnected?this.layer.associatedVariableName:"0"})`),r}get _samplerFunc(){return this.lod.isConnected?"texture2DLodEXT":"texture2D"}get _samplerLodSuffix(){return this.lod.isConnected?`, ${this.lod.associatedVariableName}`:""}_generateTextureLookup(e){const t=this.samplerName;e.compilationString+=`#ifdef ${this._defineName}\n`,e.compilationString+=`vec4 ${this._tempTextureRead} = ${this._samplerFunc}(${t}, ${this._getUVW(this._transformedUVName)}${this._samplerLodSuffix});\n`,e.compilationString+=`#elif defined(${this._mainUVDefineName})\n`,e.compilationString+=`vec4 ${this._tempTextureRead} = ${this._samplerFunc}(${t}, ${this._getUVW(this._mainUVName?this._mainUVName:this.uv.associatedVariableName)}${this._samplerLodSuffix});\n`,e.compilationString+="#endif\n"}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===qs.Fragment)return;this._generateTextureLookup(e)}else this.uv.ownerBlock.target!==qs.Fragment?this._generateTextureLookup(e):e.compilationString+=`vec4 ${this._tempTextureRead} = ${this._samplerFunc}(${this.samplerName}, ${this._getUVW(i.associatedVariableName)}${this._samplerLodSuffix});\n`}_generateConversionCode(e,t,i){"a"!==i&&(this.texture&&this.texture.gammaSpace||(e.compilationString+=`#ifdef ${this._linearDefineName}\n                    ${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\n                    #endif\n                `),e.compilationString+=`#ifdef ${this._gammaDefineName}\n                ${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\n                #endif\n            `)}_writeOutput(e,t,i,s=!1){if(s){if(e.target===qs.Fragment)return;return e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\n`,void this._generateConversionCode(e,t,i)}if(this.uv.ownerBlock.target===qs.Fragment)return e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\n`,void this._generateConversionCode(e,t,i);let r="";this.disableLevelMultiplication||(r=` * ${this._textureInfoName}`),e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i}${r};\n`,this._generateConversionCode(e,t,i)}_buildBlock(e){var t,i,s,r;if(super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,(e.target===qs.Vertex||this._fragmentOnly||e.target===qs.Fragment)&&(this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA")),(!this._isMixed&&e.target===qs.Fragment||this._isMixed&&e.target===qs.Vertex)&&(this._imageSource||(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),(null===(i=null===(t=this._texture)||void 0===t?void 0:t._texture)||void 0===i?void 0:i.is2DArray)?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName)),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this)),e.target!==qs.Fragment)return void this._injectVertexCode(e);if(!this._outputs.some((e=>e.isConnectedInFragmentShader)))return;this._isMixed&&!this._imageSource&&((null===(r=null===(s=this._texture)||void 0===s?void 0:s._texture)||void 0===r?void 0:r.is2DArray)?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName));const n=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",n),this._isMixed&&e._emitUniformFromString(this._textureInfoName,"float"),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&"level"!==t.name&&this._writeOutput(e,t,t.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\n`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\n`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};\n`,this.texture?(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\n`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\n`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\n`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\n`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\n`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\n`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\n`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\n`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\n`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`,e):e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.fragmentOnly=this._fragmentOnly,e.disableLevelMultiplication=this.disableLevelMultiplication,this.hasImageSource||!this.texture||this.texture.isRenderTarget||"VideoTexture"===this.texture.getClassName()||(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this._fragmentOnly=!!e.fragmentOnly,this.disableLevelMultiplication=!!e.disableLevelMultiplication,e.texture&&!Hn.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=Ar.Parse(e.texture,t,i))}}m("BABYLON.TextureBlock",j_);class K_ extends $r{get texture(){return this._texture}set texture(e){var t;if(this._texture===e)return;const i=null!==(t=null==e?void 0:e.getScene())&&void 0!==t?t:x.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this._texture))),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,(t=>t.hasTexture(e)))}static _OnGenerateOnlyFragmentCodeChanged(e,t){return e._onGenerateOnlyFragmentCodeChanged()}_onGenerateOnlyFragmentCodeChanged(){return this._setTarget(),!0}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?qs.Fragment:qs.VertexAndFragment)}constructor(e){super(e,qs.VertexAndFragment),this.generateOnlyFragmentCode=!1}getClassName(){return"ReflectionTextureBaseBlock"}_getTexture(){return this.texture}autoConfigure(e,t=()=>!0){if(!this.position.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"position"===e.name&&t(e)));i||(i=new rn("position"),i.setAsAttribute()),i.output.connectTo(this.position)}if(!this.world.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===tr.World&&t(e)));i||(i=new rn("world"),i.setAsSystemValue(tr.World)),i.output.connectTo(this.world)}if(this.view&&!this.view.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===tr.View&&t(e)));i||(i=new rn("view"),i.setAsSystemValue(tr.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;const s=this._getTexture();s&&s.getTextureMatrix&&(i.setValue(this._define3DName,s.isCube,!0),i.setValue(this._defineLocalCubicName,!!s.boundingBoxSize,!0),i.setValue(this._defineExplicitName,0===s.coordinatesMode,!0),i.setValue(this._defineSkyboxName,5===s.coordinatesMode,!0),i.setValue(this._defineCubicName,3===s.coordinatesMode||6===s.coordinatesMode,!0),i.setValue("INVERTCUBICMAP",6===s.coordinatesMode,!0),i.setValue(this._defineSphericalName,1===s.coordinatesMode,!0),i.setValue(this._definePlanarName,2===s.coordinatesMode,!0),i.setValue(this._defineProjectionName,4===s.coordinatesMode,!0),i.setValue(this._defineEquirectangularName,7===s.coordinatesMode,!0),i.setValue(this._defineEquirectangularFixedName,8===s.coordinatesMode,!0),i.setValue(this._defineMirroredEquirectangularFixedName,9===s.coordinatesMode,!0))}isReady(){const e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i){const s=this._getTexture();if(i&&s&&(e.setMatrix(this._reflectionMatrixName,s.getReflectionTextureMatrix()),s.isCube?e.setTexture(this._cubeSamplerName,s):e.setTexture(this._2DSamplerName,s),s.boundingBoxSize)){const t=s;e.setVector3(this._reflectionPositionName,t.boundingBoxPosition),e.setVector3(this._reflectionSizeName,t.boundingBoxSize)}}handleVertexSide(e){if(this.generateOnlyFragmentCode&&e.target===qs.Vertex)return"";this._define3DName=e._getFreeDefineName("REFLECTIONMAP_3D"),this._defineCubicName=e._getFreeDefineName("REFLECTIONMAP_CUBIC"),this._defineSphericalName=e._getFreeDefineName("REFLECTIONMAP_SPHERICAL"),this._definePlanarName=e._getFreeDefineName("REFLECTIONMAP_PLANAR"),this._defineProjectionName=e._getFreeDefineName("REFLECTIONMAP_PROJECTION"),this._defineExplicitName=e._getFreeDefineName("REFLECTIONMAP_EXPLICIT"),this._defineEquirectangularName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR"),this._defineLocalCubicName=e._getFreeDefineName("USE_LOCAL_REFLECTIONMAP_CUBIC"),this._defineMirroredEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"),this._defineEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR_FIXED"),this._defineSkyboxName=e._getFreeDefineName("REFLECTIONMAP_SKYBOX"),this._defineOppositeZ=e._getFreeDefineName("REFLECTIONMAP_OPPOSITEZ"),this._reflectionMatrixName=e._getFreeVariableName("reflectionMatrix"),e._emitUniformFromString(this._reflectionMatrixName,"mat4");let t="";this._worldPositionNameInFragmentOnlyMode=e._getFreeVariableName("worldPosition");const i=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:"v_"+this.worldPosition.associatedVariableName;return(this.generateOnlyFragmentCode||e._emitVaryingFromString(i,"vec4"))&&(t+=`${this.generateOnlyFragmentCode?"vec4 ":""}${i} = ${this.worldPosition.associatedVariableName};\n`),this._positionUVWName=e._getFreeVariableName("positionUVW"),this._directionWName=e._getFreeVariableName("directionW"),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._positionUVWName,"vec3",this._defineSkyboxName))&&(t+=`#ifdef ${this._defineSkyboxName}\n`,t+=`${this.generateOnlyFragmentCode?"vec3 ":""}${this._positionUVWName} = ${this.position.associatedVariableName}.xyz;\n`,t+="#endif\n"),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._directionWName,"vec3",`defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})`))&&(t+=`#if defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})\n`,t+=`${this.generateOnlyFragmentCode?"vec3 ":""}${this._directionWName} = normalize(vec3(${this.world.associatedVariableName} * vec4(${this.position.associatedVariableName}.xyz, 0.0)));\n`,t+="#endif\n"),t}handleFragmentSideInits(e){e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),e._samplerDeclaration+=`#ifdef ${this._define3DName}\n`,e._samplerDeclaration+=`uniform samplerCube ${this._cubeSamplerName};\n`,e._samplerDeclaration+="#else\n",e._samplerDeclaration+=`uniform sampler2D ${this._2DSamplerName};\n`,e._samplerDeclaration+="#endif\n",e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("reflectionFunction",t,{replaceStrings:[{search:/vec3 computeReflectionCoords/g,replace:"void DUMMYFUNC"}]}),this._reflectionColorName=e._getFreeVariableName("reflectionColor"),this._reflectionVectorName=e._getFreeVariableName("reflectionUVW"),this._reflectionCoordsName=e._getFreeVariableName("reflectionCoords"),this._reflectionPositionName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionPositionName,"vec3"),this._reflectionSizeName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionSizeName,"vec3")}handleFragmentSideCodeReflectionCoords(e,t,i=!1,s=!1){t||(t=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:`v_${this.worldPosition.associatedVariableName}`);const r=this._reflectionMatrixName,n=`normalize(${this._directionWName})`,o=`${this._positionUVWName}`,a=`${this.cameraPosition.associatedVariableName}`,l=`${this.view.associatedVariableName}`;e+=".xyz";let h=`\n            #ifdef ${this._defineMirroredEquirectangularFixedName}\n                vec3 ${this._reflectionVectorName} = computeMirroredFixedEquirectangularCoords(${t}, ${e}, ${n});\n            #endif\n\n            #ifdef ${this._defineEquirectangularFixedName}\n                vec3 ${this._reflectionVectorName} = computeFixedEquirectangularCoords(${t}, ${e}, ${n});\n            #endif\n\n            #ifdef ${this._defineEquirectangularName}\n                vec3 ${this._reflectionVectorName} = computeEquirectangularCoords(${t}, ${e}, ${a}.xyz, ${r});\n            #endif\n\n            #ifdef ${this._defineSphericalName}\n                vec3 ${this._reflectionVectorName} = computeSphericalCoords(${t}, ${e}, ${l}, ${r});\n            #endif\n\n            #ifdef ${this._definePlanarName}\n                vec3 ${this._reflectionVectorName} = computePlanarCoords(${t}, ${e}, ${a}.xyz, ${r});\n            #endif\n\n            #ifdef ${this._defineCubicName}\n                #ifdef ${this._defineLocalCubicName}\n                    vec3 ${this._reflectionVectorName} = computeCubicLocalCoords(${t}, ${e}, ${a}.xyz, ${r}, ${this._reflectionSizeName}, ${this._reflectionPositionName});\n                #else\n                vec3 ${this._reflectionVectorName} = computeCubicCoords(${t}, ${e}, ${a}.xyz, ${r});\n                #endif\n            #endif\n\n            #ifdef ${this._defineProjectionName}\n                vec3 ${this._reflectionVectorName} = computeProjectionCoords(${t}, ${l}, ${r});\n            #endif\n\n            #ifdef ${this._defineSkyboxName}\n                vec3 ${this._reflectionVectorName} = computeSkyBoxCoords(${o}, ${r});\n            #endif\n\n            #ifdef ${this._defineExplicitName}\n                vec3 ${this._reflectionVectorName} = vec3(0, 0, 0);\n            #endif\n`;return s||(h+=`#ifdef ${this._defineOppositeZ}\n                ${this._reflectionVectorName}.z *= -1.0;\n            #endif\n`),i||(h+=`\n                #ifdef ${this._define3DName}\n                    vec3 ${this._reflectionCoordsName} = ${this._reflectionVectorName};\n                #else\n                    vec2 ${this._reflectionCoordsName} = ${this._reflectionVectorName}.xy;\n                    #ifdef ${this._defineProjectionName}\n                        ${this._reflectionCoordsName} /= ${this._reflectionVectorName}.z;\n                    #endif\n                    ${this._reflectionCoordsName}.y = 1.0 - ${this._reflectionCoordsName}.y;\n                #endif\n`),h}handleFragmentSideCodeReflectionColor(e,t=".rgb"){let i=`${"vec"+(0===t.length?"4":t.length-1)} ${this._reflectionColorName};\n            #ifdef ${this._define3DName}\n`;return i+=e?`${this._reflectionColorName} = textureCubeLodEXT(${this._cubeSamplerName}, ${this._reflectionVectorName}, ${e})${t};\n`:`${this._reflectionColorName} = textureCube(${this._cubeSamplerName}, ${this._reflectionVectorName})${t};\n`,i+="\n            #else\n",i+=e?`${this._reflectionColorName} = texture2DLodEXT(${this._2DSamplerName}, ${this._reflectionCoordsName}, ${e})${t};\n`:`${this._reflectionColorName} = texture2D(${this._2DSamplerName}, ${this._reflectionCoordsName})${t};\n`,i+="#endif\n",i}writeOutputs(e,t){let i="";if(e.target===qs.Fragment)for(const s of this._outputs)s.hasEndpoints&&(i+=`${this._declareOutput(s,e)} = ${t}.${s.name};\n`);return i}_buildBlock(e){return super._buildBlock(e),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();if(!this.texture)return e;if(this.texture.isCube){const t=this.texture.forcedExtension;e+=`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}", undefined, undefined, ${this.texture.noMipmap}, null, undefined, undefined, undefined, ${this.texture._prefiltered}, ${t?'"'+t+'"':"null"});\n`}else e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null);\n`;return e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`,e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&!Hn.IgnoreTexturesAtLoadTime&&(i=0===e.texture.url.indexOf("data:")?"":i,e.texture.isCube?this.texture=ud.Parse(e.texture,t,i):this.texture=Ar.Parse(e.texture,t,i)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}me([Zr("Generate only fragment code",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:K_._OnGenerateOnlyFragmentCodeChanged}})],K_.prototype,"generateOnlyFragmentCode",void 0),m("BABYLON.ReflectionTextureBaseBlock",K_),m("BABYLON.ReflectionTextureBlock",class extends K_{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,console.error("The position input must not be connected to be able to switch!"),!1):this.worldPosition.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,console.error("The worldPosition input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?qs.Fragment:qs.Vertex,this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?qs.Fragment:qs.Vertex}constructor(e){super(e),this.registerInput("position",$s.AutoDetect,!1,qs.Vertex),this.registerInput("worldPosition",$s.Vector4,!1,qs.Vertex),this.registerInput("worldNormal",$s.Vector4,!1,qs.Fragment),this.registerInput("world",$s.Matrix,!1,qs.Vertex),this.registerInput("cameraPosition",$s.Vector3,!1,qs.Fragment),this.registerInput("view",$s.Matrix,!1,qs.Fragment),this.registerOutput("rgb",$s.Color3,qs.Fragment),this.registerOutput("rgba",$s.Color4,qs.Fragment),this.registerOutput("r",$s.Float,qs.Fragment),this.registerOutput("g",$s.Float,qs.Fragment),this.registerOutput("b",$s.Float,qs.Fragment),this.registerOutput("a",$s.Float,qs.Fragment),this._inputs[0].addExcludedConnectionPointFromAllowedTypes($s.Color3|$s.Vector3|$s.Vector4)}getClassName(){return"ReflectionTextureBlock"}get position(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get world(){return this._inputs[3]}get cameraPosition(){return this._inputs[4]}get view(){return this._inputs[5]}get rgb(){return this._outputs[0]}get rgba(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}autoConfigure(e,t=()=>!0){if(super.autoConfigure(e),!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===tr.CameraPosition&&t(e)));i||(i=new rn("cameraPosition"),i.setAsSystemValue(tr.CameraPosition)),i.output.connectTo(this.cameraPosition)}}_buildBlock(e){if(super._buildBlock(e),!this.texture)return e.compilationString+=this.writeOutputs(e,"vec4(0.)"),this;if(e.target!==qs.Fragment)return e.compilationString+=this.handleVertexSide(e),this;this.generateOnlyFragmentCode&&(e.compilationString+=this.handleVertexSide(e)),this.handleFragmentSideInits(e);const t=e._getFreeVariableName("normalWUnit");return e.compilationString+=`vec4 ${t} = normalize(${this.worldNormal.associatedVariableName});\n`,e.compilationString+=this.handleFragmentSideCodeReflectionCoords(t),e.compilationString+=this.handleFragmentSideCodeReflectionColor(void 0,""),e.compilationString+=this.writeOutputs(e,this._reflectionColorName),this}});class $_ extends $r{constructor(e){super(e,qs.VertexAndFragment),this.useNonLinearDepth=!1,this.storeCameraSpaceZ=!1,this.force32itsFloat=!1,this._isUnique=!0,this.registerInput("uv",$s.AutoDetect,!1,qs.VertexAndFragment),this.registerOutput("depth",$s.Float,qs.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes($s.Vector2|$s.Vector3|$s.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"SceneDepthBlock"}get uv(){return this._inputs[0]}get depth(){return this._outputs[0]}initialize(e){e._excludeVariableName("textureSampler")}get target(){return this.uv.isConnected?this.uv.sourceBlock.isInput?qs.VertexAndFragment:qs.Fragment:qs.VertexAndFragment}_getTexture(e){return e.enableDepthRenderer(void 0,this.useNonLinearDepth,this.force32itsFloat,void 0,this.storeCameraSpaceZ).getDepthMap()}bind(e,t){const i=this._getTexture(t.getScene());e.setTexture(this._samplerName,i)}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,"vec"+(t.type===$s.Vector3?"3":t.type===$s.Vector4?"4":"2"))),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,"vec2"),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\n`,this._outputs.some((e=>e.isConnectedInVertexShader))){this._writeTextureRead(e,!0);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,"r",!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===qs.Fragment)return;e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName}.xy);\n`}else this.uv.ownerBlock.target!==qs.Fragment?e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this._mainUVName});\n`:e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName}.xy);\n`}_writeOutput(e,t,i,s=!1){if(s){if(e.target===qs.Fragment)return;e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\n`}else this.uv.ownerBlock.target,qs.Fragment,e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\n`}_buildBlock(e){if(super._buildBlock(e),this._samplerName=e._getFreeVariableName(this.name+"Sampler"),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.bindableBlocks.indexOf(this)<0&&e.sharedData.bindableBlocks.push(this),e.target!==qs.Fragment)return e._emit2DSampler(this._samplerName),void this._injectVertexCode(e);if(this._outputs.some((e=>e.isConnectedInFragmentShader))){e._emit2DSampler(this._samplerName),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,"r");return this}}serialize(){const e=super.serialize();return e.useNonLinearDepth=this.useNonLinearDepth,e.storeCameraSpaceZ=this.storeCameraSpaceZ,e.force32itsFloat=this.force32itsFloat,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.useNonLinearDepth=e.useNonLinearDepth,this.storeCameraSpaceZ=!!e.storeCameraSpaceZ,this.force32itsFloat=e.force32itsFloat}}me([Zr("Use non linear depth",Js.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:(e,t)=>{const i=t;let s=!1;return i.useNonLinearDepth&&(i.storeCameraSpaceZ=!1,s=!0),e&&e.disableDepthRenderer(),s}}})],$_.prototype,"useNonLinearDepth",void 0),me([Zr("Store Camera space Z",Js.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:(e,t)=>{const i=t;let s=!1;return i.storeCameraSpaceZ&&(i.useNonLinearDepth=!1,s=!0),e&&e.disableDepthRenderer(),s}}})],$_.prototype,"storeCameraSpaceZ",void 0),me([Zr("Force 32 bits float",Js.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:e=>null==e?void 0:e.disableDepthRenderer()}})],$_.prototype,"force32itsFloat",void 0),m("BABYLON.SceneDepthBlock",$_),m("BABYLON.ClipPlanesBlock",class extends $r{constructor(e){super(e,qs.VertexAndFragment,!0),this.registerInput("worldPosition",$s.Vector4,!1)}getClassName(){return"ClipPlanesBlock"}initialize(e){e._excludeVariableName("vClipPlane"),e._excludeVariableName("fClipDistance"),e._excludeVariableName("vClipPlane2"),e._excludeVariableName("fClipDistance2"),e._excludeVariableName("vClipPlane3"),e._excludeVariableName("fClipDistance3"),e._excludeVariableName("vClipPlane4"),e._excludeVariableName("fClipDistance4"),e._excludeVariableName("vClipPlane5"),e._excludeVariableName("fClipDistance5"),e._excludeVariableName("vClipPlane6"),e._excludeVariableName("fClipDistance6")}get worldPosition(){return this._inputs[0]}get target(){return qs.VertexAndFragment}set target(e){}prepareDefines(e,t,i){var s,r,n,o,a,l;const h=e.getScene(),c=!!(null!==(s=t.clipPlane)&&void 0!==s?s:h.clipPlane),u=!!(null!==(r=t.clipPlane2)&&void 0!==r?r:h.clipPlane2),d=!!(null!==(n=t.clipPlane3)&&void 0!==n?n:h.clipPlane3),p=!!(null!==(o=t.clipPlane4)&&void 0!==o?o:h.clipPlane4),_=!!(null!==(a=t.clipPlane5)&&void 0!==a?a:h.clipPlane5),f=!!(null!==(l=t.clipPlane6)&&void 0!==l?l:h.clipPlane6);i.setValue("CLIPPLANE",c,!0),i.setValue("CLIPPLANE2",u,!0),i.setValue("CLIPPLANE3",d,!0),i.setValue("CLIPPLANE4",p,!0),i.setValue("CLIPPLANE5",_,!0),i.setValue("CLIPPLANE6",f,!0)}bind(e,t,i){i&&zs(e,t,i.getScene())}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;if(e.target!==qs.Fragment){const i=this.worldPosition;return e._emitFunctionFromInclude("clipPlaneVertexDeclaration",t,{replaceStrings:[{search:/uniform vec4 vClipPlane\d*;/g,replace:""}]}),e.compilationString+=e._emitCodeFromInclude("clipPlaneVertex",t,{replaceStrings:[{search:/worldPos/g,replace:i.associatedVariableName}]}),e._emitUniformFromString("vClipPlane","vec4"),e._emitUniformFromString("vClipPlane2","vec4"),e._emitUniformFromString("vClipPlane3","vec4"),e._emitUniformFromString("vClipPlane4","vec4"),e._emitUniformFromString("vClipPlane5","vec4"),void e._emitUniformFromString("vClipPlane6","vec4")}return e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e._emitFunctionFromInclude("clipPlaneFragmentDeclaration",t),e.compilationString+=e._emitCodeFromInclude("clipPlaneFragment",t),this}}),m("BABYLON.PrePassTextureBlock",class extends $r{get texture(){return null}set texture(e){}constructor(e,t=qs.VertexAndFragment){super(e,t,!1),this.registerOutput("position",$s.Object,qs.VertexAndFragment,new V_("position",this,Zs.Output,Y_,"ImageSourceBlock")),this.registerOutput("depth",$s.Object,qs.VertexAndFragment,new V_("depth",this,Zs.Output,Y_,"ImageSourceBlock")),this.registerOutput("normal",$s.Object,qs.VertexAndFragment,new V_("normal",this,Zs.Output,Y_,"ImageSourceBlock"))}getSamplerName(e){return e===this._outputs[0]?this._positionSamplerName:e===this._outputs[1]?this._depthSamplerName:e===this._outputs[2]?this._normalSamplerName:""}get position(){return this._outputs[0]}get depth(){return this._outputs[1]}get normal(){return this._outputs[2]}get positionSamplerName(){return this._positionSamplerName}get normalSamplerName(){return this._normalSamplerName}get depthSamplerName(){return this._depthSamplerName}getClassName(){return"PrePassTextureBlock"}_buildBlock(e){if(super._buildBlock(e),e.target!==qs.Vertex)return this._positionSamplerName="prepassPositionSampler",this._depthSamplerName="prepassDepthSampler",this._normalSamplerName="prepassNormalSampler",e.sharedData.variableNames.prepassPositionSampler=0,e.sharedData.variableNames.prepassDepthSampler=0,e.sharedData.variableNames.prepassNormalSampler=0,e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this),e._emit2DSampler(this._positionSamplerName),e._emit2DSampler(this._depthSamplerName),e._emit2DSampler(this._normalSamplerName),this}bind(e,t){const i=t.getScene().enablePrePassRenderer();if(!i)return;const s=i.defaultRT;s.textures&&(this.position.isConnected&&e.setTexture(this._positionSamplerName,s.textures[i.getIndex(1)]),this.depth.isConnected&&e.setTexture(this._depthSamplerName,s.textures[i.getIndex(5)]),this.normal.isConnected&&e.setTexture(this._normalSamplerName,s.textures[i.getIndex(6)]))}}),m("BABYLON.NodeMaterialTeleportInBlock",class extends $r{get endpoints(){return this._endpoints}get target(){const e=this._inputs[0];if(e.isConnected){const t=e.connectedPoint.ownerBlock;if(t.target!==qs.VertexAndFragment)return t.target;if(e.connectedPoint.target!==qs.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){this._target&e||(this._target=e)}constructor(e){super(e,qs.Neutral),this._endpoints=[],this.registerInput("input",$s.AutoDetect)}getClassName(){return"NodeMaterialTeleportInBlock"}get input(){return this._inputs[0]}isConnectedInFragmentShader(){return this.endpoints.some((e=>e.output.isConnectedInFragmentShader))}_dumpCode(e,t){let i=super._dumpCode(e,t);for(const s of this.endpoints)-1===t.indexOf(s)&&(i+=s._dumpCode(e,t));return i}isAnAncestorOf(e){for(const t of this.endpoints){if(t===e)return!0;if(t.isAnAncestorOf(e))return!0}return!1}attachToEndpoint(e){e.detach(),this._endpoints.push(e),e._entryPoint=this,e._outputs[0]._typeConnectionSource=this._inputs[0],e._tempEntryPointUniqueId=null,e.name="> "+this.name}detachFromEndpoint(e){const t=this._endpoints.indexOf(e);-1!==t&&(this._endpoints.splice(t,1),e._outputs[0]._typeConnectionSource=null,e._entryPoint=null)}dispose(){super.dispose();for(const e of this._endpoints)this.detachFromEndpoint(e);this._endpoints=[]}}),m("BABYLON.NodeMaterialTeleportOutBlock",class extends $r{constructor(e){super(e,qs.Neutral),this._entryPoint=null,this._tempEntryPointUniqueId=null,this.registerOutput("output",$s.BasedOnInput)}get entryPoint(){return this._entryPoint}getClassName(){return"NodeMaterialTeleportOutBlock"}get output(){return this._outputs[0]}get target(){return this._entryPoint?this._entryPoint.target:this._target}set target(e){this._target&e||(this._target=e)}detach(){this._entryPoint&&this._entryPoint.detachFromEndpoint(this)}_buildBlock(e){super._buildBlock(e),this.entryPoint&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${this.entryPoint.input.associatedVariableName};\n`)}clone(e,t=""){const i=super.clone(e,t);return this.entryPoint&&this.entryPoint.attachToEndpoint(i),i}_customBuildStep(e,t){this.entryPoint&&this.entryPoint.build(e,t)}_dumpCode(e,t){let i="";return this.entryPoint&&-1===t.indexOf(this.entryPoint)&&(i+=this.entryPoint._dumpCode(e,t)),i+super._dumpCode(e,t)}_dumpCodeForOutputConnections(e){let t=super._dumpCodeForOutputConnections(e);return this.entryPoint&&(t+=this.entryPoint._dumpCodeForOutputConnections(e)),t}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.entryPoint&&(e+=`${this.entryPoint._codeVariableName}.attachToEndpoint(${this._codeVariableName});\n`),e}serialize(){var e,t;const i=super.serialize();return i.entryPoint=null!==(t=null===(e=this.entryPoint)||void 0===e?void 0:e.uniqueId)&&void 0!==t?t:"",i}_deserialize(e,t,i){super._deserialize(e,t,i),this._tempEntryPointUniqueId=e.entryPoint}}),m("BABYLON.AddBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("left",$s.AutoDetect),this.registerInput("right",$s.AutoDetect),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].acceptedConnectionPointTypes.push($s.Float),this._inputs[1].acceptedConnectionPointTypes.push($s.Float)}getClassName(){return"AddBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.left.associatedVariableName} + ${this.right.associatedVariableName};\n`,this}}),m("BABYLON.ScaleBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("input",$s.AutoDetect),this.registerInput("factor",$s.Float),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ScaleBlock"}get input(){return this._inputs[0]}get factor(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.input.associatedVariableName} * ${this.factor.associatedVariableName};\n`,this}});class q_ extends $r{constructor(e){super(e,qs.Neutral),this.minimum=0,this.maximum=1,this.registerInput("value",$s.AutoDetect),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ClampBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = clamp(${this.value.associatedVariableName}, ${this._writeFloat(this.minimum)}, ${this._writeFloat(this.maximum)});\n`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.minimum = ${this.minimum};\n`;return e+=`${this._codeVariableName}.maximum = ${this.maximum};\n`,e}serialize(){const e=super.serialize();return e.minimum=this.minimum,e.maximum=this.maximum,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.minimum=e.minimum,this.maximum=e.maximum}}me([Zr("Minimum",Js.Float)],q_.prototype,"minimum",void 0),me([Zr("Maximum",Js.Float)],q_.prototype,"maximum",void 0),m("BABYLON.ClampBlock",q_),m("BABYLON.CrossBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("left",$s.AutoDetect),this.registerInput("right",$s.AutoDetect),this.registerOutput("output",$s.Vector3),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push($s.Float),this._inputs[0].excludedConnectionPointTypes.push($s.Matrix),this._inputs[0].excludedConnectionPointTypes.push($s.Vector2),this._inputs[1].excludedConnectionPointTypes.push($s.Float),this._inputs[1].excludedConnectionPointTypes.push($s.Matrix),this._inputs[1].excludedConnectionPointTypes.push($s.Vector2)}getClassName(){return"CrossBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = cross(${this.left.associatedVariableName}.xyz, ${this.right.associatedVariableName}.xyz);\n`,this}}),m("BABYLON.CustomBlock",class extends $r{get options(){return this._options}set options(e){this._deserializeOptions(e)}constructor(e){super(e)}getClassName(){return"CustomBlock"}_buildBlock(e){super._buildBlock(e);let t=this._code,i=this._options.functionName;this._inputs.forEach((s=>{const r=new RegExp("\\{TYPE_"+s.name+"\\}","gm"),n=e._getGLType(s.type);t=t.replace(r,n),i=i.replace(r,n)})),this._outputs.forEach((s=>{const r=new RegExp("\\{TYPE_"+s.name+"\\}","gm"),n=e._getGLType(s.type);t=t.replace(r,n),i=i.replace(r,n)})),e._emitFunction(i,t,""),this._outputs.forEach((t=>{e.compilationString+=this._declareOutput(t,e)+";\n"})),e.compilationString+=i+"(";let s=!1;return this._inputs.forEach(((t,i)=>{var r,n,o;i>0&&(e.compilationString+=", "),this._inputSamplers&&-1!==this._inputSamplers.indexOf(t.name)?e.compilationString+=null!==(o=null===(n=null===(r=t.connectedPoint)||void 0===r?void 0:r.ownerBlock)||void 0===n?void 0:n.samplerName)&&void 0!==o?o:t.associatedVariableName:e.compilationString+=t.associatedVariableName,s=!0})),this._outputs.forEach(((t,i)=>{(i>0||s)&&(e.compilationString+=", "),e.compilationString+=t.associatedVariableName})),e.compilationString+=");\n",this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.options = ${JSON.stringify(this._options)};\n`,e}serialize(){const e=super.serialize();return e.options=this._options,e}_deserialize(e,t,i){this._deserializeOptions(e.options),super._deserialize(e,t,i)}_deserializeOptions(e){var t,i,s;this._options=e,this._code=e.code.join("\n")+"\n",this.name=this.name||e.name,this.target=qs[e.target],null===(t=e.inParameters)||void 0===t||t.forEach(((e,t)=>{const i=$s[e.type];"sampler2D"===e.type||"samplerCube"===e.type?(this._inputSamplers=this._inputSamplers||[],this._inputSamplers.push(e.name),this.registerInput(e.name,$s.Object,!0,qs.VertexAndFragment,new V_(e.name,this,Zs.Input,Y_,"ImageSourceBlock"))):this.registerInput(e.name,i),Object.defineProperty(this,e.name,{get:function(){return this._inputs[t]},enumerable:!0,configurable:!0})})),null===(i=e.outParameters)||void 0===i||i.forEach(((e,t)=>{this.registerOutput(e.name,$s[e.type]),Object.defineProperty(this,e.name,{get:function(){return this._outputs[t]},enumerable:!0,configurable:!0}),"BasedOnInput"===e.type&&(this._outputs[t]._typeConnectionSource=this._findInputByName(e.typeFromInput)[0])})),null===(s=e.inLinkedConnectionTypes)||void 0===s||s.forEach((e=>{this._linkConnectionTypes(this._findInputByName(e.input1)[1],this._findInputByName(e.input2)[1])}))}_findInputByName(e){if(!e)return null;for(let t=0;t<this._inputs.length;t++)if(this._inputs[t].name===e)return[this._inputs[t],t];return null}}),m("BABYLON.DotBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("left",$s.AutoDetect),this.registerInput("right",$s.AutoDetect),this.registerOutput("output",$s.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push($s.Float),this._inputs[0].excludedConnectionPointTypes.push($s.Matrix),this._inputs[1].excludedConnectionPointTypes.push($s.Float),this._inputs[1].excludedConnectionPointTypes.push($s.Matrix)}getClassName(){return"DotBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = dot(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`,this}}),m("BABYLON.NormalizeBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("input",$s.AutoDetect),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push($s.Float),this._inputs[0].excludedConnectionPointTypes.push($s.Matrix)}getClassName(){return"NormalizeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];return e.compilationString+=this._declareOutput(t,e)+` = normalize(${i.associatedVariableName});\n`,this}}),m("BABYLON.ColorMergerBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.rSwizzle="r",this.gSwizzle="g",this.bSwizzle="b",this.aSwizzle="a",this.registerInput("rgb ",$s.Color3,!0),this.registerInput("r",$s.Float,!0),this.registerInput("g",$s.Float,!0),this.registerInput("b",$s.Float,!0),this.registerInput("a",$s.Float,!0),this.registerOutput("rgba",$s.Color4),this.registerOutput("rgb",$s.Color3)}getClassName(){return"ColorMergerBlock"}get rgbIn(){return this._inputs[0]}get r(){return this._inputs[1]}get g(){return this._inputs[2]}get b(){return this._inputs[3]}get a(){return this._inputs[4]}get rgba(){return this._outputs[0]}get rgbOut(){return this._outputs[1]}get rgb(){return this.rgbOut}_inputRename(e){return"rgb "===e?"rgbIn":e}_buildSwizzle(e){return"."+(this.rSwizzle+this.gSwizzle+this.bSwizzle+this.aSwizzle).substr(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.r,i=this.g,s=this.b,r=this.a,n=this.rgbIn,o=this._outputs[0],a=this._outputs[1];return n.isConnected?(o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = vec4(${n.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(4)};\n`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = ${n.associatedVariableName}${this._buildSwizzle(3)};\n`)):(o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = vec4(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(4)};\n`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = vec3(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(3)};\n`)),this}serialize(){const e=super.serialize();return e.rSwizzle=this.rSwizzle,e.gSwizzle=this.gSwizzle,e.bSwizzle=this.bSwizzle,e.aSwizzle=this.aSwizzle,e}_deserialize(e,t,i){var s,r,n,o;super._deserialize(e,t,i),this.rSwizzle=null!==(s=e.rSwizzle)&&void 0!==s?s:"r",this.gSwizzle=null!==(r=e.gSwizzle)&&void 0!==r?r:"g",this.bSwizzle=null!==(n=e.bSwizzle)&&void 0!==n?n:"b",this.aSwizzle=null!==(o=e.aSwizzle)&&void 0!==o?o:"a"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.rSwizzle = "${this.rSwizzle}";\n`,e+=`${this._codeVariableName}.gSwizzle = "${this.gSwizzle}";\n`,e+=`${this._codeVariableName}.bSwizzle = "${this.bSwizzle}";\n`,e+=`${this._codeVariableName}.aSwizzle = "${this.aSwizzle}";\n`,e}}),m("BABYLON.VectorSplitterBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("xyzw",$s.Vector4,!0),this.registerInput("xyz ",$s.Vector3,!0),this.registerInput("xy ",$s.Vector2,!0),this.registerOutput("xyz",$s.Vector3),this.registerOutput("xy",$s.Vector2),this.registerOutput("zw",$s.Vector2),this.registerOutput("x",$s.Float),this.registerOutput("y",$s.Float),this.registerOutput("z",$s.Float),this.registerOutput("w",$s.Float),this.inputsAreExclusive=!0}getClassName(){return"VectorSplitterBlock"}get xyzw(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get xyzOut(){return this._outputs[0]}get xyOut(){return this._outputs[1]}get zw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get w(){return this._outputs[6]}_inputRename(e){switch(e){case"xy ":return"xyIn";case"xyz ":return"xyzIn";default:return e}}_outputRename(e){switch(e){case"xy":return"xyOut";case"xyz":return"xyzOut";default:return e}}_buildBlock(e){super._buildBlock(e);const t=this.xyzw.isConnected?this.xyzw:this.xyzIn.isConnected?this.xyzIn:this.xyIn,i=this._outputs[0],s=this._outputs[1],r=this._outputs[2],n=this._outputs[3],o=this._outputs[4],a=this._outputs[5],l=this._outputs[6];return i.hasEndpoints&&(t===this.xyIn?e.compilationString+=this._declareOutput(i,e)+` = vec3(${t.associatedVariableName}, 0.0);\n`:e.compilationString+=this._declareOutput(i,e)+` = ${t.associatedVariableName}.xyz;\n`),r.hasEndpoints&&this.xyzw.isConnected&&(e.compilationString+=this._declareOutput(r,e)+` = ${this.xyzw.associatedVariableName}.zw;\n`),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+` = ${t.associatedVariableName}.xy;\n`),n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = ${t.associatedVariableName}.x;\n`),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = ${t.associatedVariableName}.y;\n`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = ${t.associatedVariableName}.z;\n`),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+` = ${t.associatedVariableName}.w;\n`),this}}),m("BABYLON.LerpBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("left",$s.AutoDetect),this.registerInput("right",$s.AutoDetect),this.registerInput("gradient",$s.AutoDetect),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push($s.Float)}getClassName(){return"LerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName});\n`,this}}),m("BABYLON.DivideBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("left",$s.AutoDetect),this.registerInput("right",$s.AutoDetect),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].acceptedConnectionPointTypes.push($s.Float),this._inputs[1].acceptedConnectionPointTypes.push($s.Float)}getClassName(){return"DivideBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.left.associatedVariableName} / ${this.right.associatedVariableName};\n`,this}}),m("BABYLON.SubtractBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("left",$s.AutoDetect),this.registerInput("right",$s.AutoDetect),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].acceptedConnectionPointTypes.push($s.Float),this._inputs[1].acceptedConnectionPointTypes.push($s.Float)}getClassName(){return"SubtractBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.left.associatedVariableName} - ${this.right.associatedVariableName};\n`,this}}),m("BABYLON.StepBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("value",$s.Float),this.registerInput("edge",$s.Float),this.registerOutput("output",$s.Float)}getClassName(){return"StepBlock"}get value(){return this._inputs[0]}get edge(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = step(${this.edge.associatedVariableName}, ${this.value.associatedVariableName});\n`,this}});class Q_ extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("input",$s.AutoDetect),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0].excludedConnectionPointTypes.push($s.Matrix)}getClassName(){return"OneMinusBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = 1. - ${this.input.associatedVariableName};\n`,this}}m("BABYLON.OneMinusBlock",Q_),m("BABYLON.OppositeBlock",Q_);class Z_ extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("worldPosition",$s.Vector4),this.registerInput("cameraPosition",$s.Vector3),this.registerOutput("output",$s.Vector3)}getClassName(){return"ViewDirectionBlock"}get worldPosition(){return this._inputs[0]}get cameraPosition(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(e,t=()=>!0){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===tr.CameraPosition&&t(e)));i||(i=new rn("cameraPosition"),i.setAsSystemValue(tr.CameraPosition)),i.output.connectTo(this.cameraPosition)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = normalize(${this.cameraPosition.associatedVariableName} - ${this.worldPosition.associatedVariableName}.xyz);\n`,this}}var J_;m("BABYLON.ViewDirectionBlock",Z_),m("BABYLON.FresnelBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("worldNormal",$s.Vector4),this.registerInput("viewDirection",$s.Vector3),this.registerInput("bias",$s.Float),this.registerInput("power",$s.Float),this.registerOutput("fresnel",$s.Float)}getClassName(){return"FresnelBlock"}get worldNormal(){return this._inputs[0]}get viewDirection(){return this._inputs[1]}get bias(){return this._inputs[2]}get power(){return this._inputs[3]}get fresnel(){return this._outputs[0]}autoConfigure(e){if(!this.viewDirection.isConnected){const t=new Z_("View direction");t.output.connectTo(this.viewDirection),t.autoConfigure(e)}if(!this.bias.isConnected){const e=new rn("bias");e.value=0,e.output.connectTo(this.bias)}if(!this.power.isConnected){const e=new rn("power");e.value=1,e.output.connectTo(this.power)}}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;return e._emitFunctionFromInclude("fresnelFunction",t,{removeIfDef:!0}),e.compilationString+=this._declareOutput(this.fresnel,e)+` = computeFresnelTerm(${this.viewDirection.associatedVariableName}.xyz, ${this.worldNormal.associatedVariableName}.xyz, ${this.bias.associatedVariableName}, ${this.power.associatedVariableName});\n`,this}}),m("BABYLON.MaxBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("left",$s.AutoDetect),this.registerInput("right",$s.AutoDetect),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MaxBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = max(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`,this}}),m("BABYLON.MinBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("left",$s.AutoDetect),this.registerInput("right",$s.AutoDetect),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MinBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = min(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`,this}}),m("BABYLON.DistanceBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("left",$s.AutoDetect),this.registerInput("right",$s.AutoDetect),this.registerOutput("output",$s.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push($s.Float),this._inputs[0].excludedConnectionPointTypes.push($s.Matrix),this._inputs[1].excludedConnectionPointTypes.push($s.Float),this._inputs[1].excludedConnectionPointTypes.push($s.Matrix)}getClassName(){return"DistanceBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = length(${this.left.associatedVariableName} - ${this.right.associatedVariableName});\n`,this}}),m("BABYLON.LengthBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("value",$s.AutoDetect),this.registerOutput("output",$s.Float),this._inputs[0].excludedConnectionPointTypes.push($s.Float),this._inputs[0].excludedConnectionPointTypes.push($s.Matrix)}getClassName(){return"LengthBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = length(${this.value.associatedVariableName});\n`,this}}),m("BABYLON.NegateBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("value",$s.AutoDetect),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NegateBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = -1.0 * ${this.value.associatedVariableName};\n`,this}}),m("BABYLON.PowBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("value",$s.AutoDetect),this.registerInput("power",$s.AutoDetect),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"PowBlock"}get value(){return this._inputs[0]}get power(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = pow(${this.value.associatedVariableName}, ${this.power.associatedVariableName});\n`,this}}),m("BABYLON.RandomNumberBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("seed",$s.AutoDetect),this.registerOutput("output",$s.Float),this._inputs[0].addExcludedConnectionPointFromAllowedTypes($s.Vector2|$s.Vector3|$s.Vector4|$s.Color3|$s.Color4)}getClassName(){return"RandomNumberBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",i),e.compilationString+=this._declareOutput(t,e)+` = getRand(${this.seed.associatedVariableName}.xy);\n`,this}}),m("BABYLON.ArcTan2Block",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("x",$s.Float),this.registerInput("y",$s.Float),this.registerOutput("output",$s.Float)}getClassName(){return"ArcTan2Block"}get x(){return this._inputs[0]}get y(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = atan(${this.x.associatedVariableName}, ${this.y.associatedVariableName});\n`,this}}),m("BABYLON.SmoothStepBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("value",$s.AutoDetect),this.registerInput("edge0",$s.Float),this.registerInput("edge1",$s.Float),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"SmoothStepBlock"}get value(){return this._inputs[0]}get edge0(){return this._inputs[1]}get edge1(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = smoothstep(${this.edge0.associatedVariableName}, ${this.edge1.associatedVariableName}, ${this.value.associatedVariableName});\n`,this}}),m("BABYLON.ReciprocalBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("input",$s.AutoDetect),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ReciprocalBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return this.input.type===$s.Matrix?e.compilationString+=this._declareOutput(t,e)+` = inverse(${this.input.associatedVariableName});\n`:e.compilationString+=this._declareOutput(t,e)+` = 1. / ${this.input.associatedVariableName};\n`,this}}),m("BABYLON.ReplaceColorBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("value",$s.AutoDetect),this.registerInput("reference",$s.AutoDetect),this.registerInput("distance",$s.Float),this.registerInput("replacement",$s.AutoDetect),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(0,3),this._inputs[0].excludedConnectionPointTypes.push($s.Float),this._inputs[0].excludedConnectionPointTypes.push($s.Matrix),this._inputs[1].excludedConnectionPointTypes.push($s.Float),this._inputs[1].excludedConnectionPointTypes.push($s.Matrix),this._inputs[3].excludedConnectionPointTypes.push($s.Float),this._inputs[3].excludedConnectionPointTypes.push($s.Matrix)}getClassName(){return"ReplaceColorBlock"}get value(){return this._inputs[0]}get reference(){return this._inputs[1]}get distance(){return this._inputs[2]}get replacement(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+";\n",e.compilationString+=`if (length(${this.value.associatedVariableName} - ${this.reference.associatedVariableName}) < ${this.distance.associatedVariableName}) {\n`,e.compilationString+=`${t.associatedVariableName} = ${this.replacement.associatedVariableName};\n`,e.compilationString+="} else {\n",e.compilationString+=`${t.associatedVariableName} = ${this.value.associatedVariableName};\n`,e.compilationString+="}\n",this}}),m("BABYLON.PosterizeBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("value",$s.AutoDetect),this.registerInput("steps",$s.AutoDetect),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push($s.Matrix),this._inputs[1].excludedConnectionPointTypes.push($s.Matrix)}getClassName(){return"PosterizeBlock"}get value(){return this._inputs[0]}get steps(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = floor(${this.value.associatedVariableName} / (1.0 / ${this.steps.associatedVariableName})) * (1.0 / ${this.steps.associatedVariableName});\n`,this}}),function(e){e[e.SawTooth=0]="SawTooth",e[e.Square=1]="Square",e[e.Triangle=2]="Triangle"}(J_||(J_={})),m("BABYLON.WaveBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.kind=J_.SawTooth,this.registerInput("input",$s.AutoDetect),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push($s.Matrix)}getClassName(){return"WaveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];switch(this.kind){case J_.SawTooth:e.compilationString+=this._declareOutput(t,e)+` = ${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName});\n`;break;case J_.Square:e.compilationString+=this._declareOutput(t,e)+` = 1.0 - 2.0 * round(fract(${this.input.associatedVariableName}));\n`;break;case J_.Triangle:e.compilationString+=this._declareOutput(t,e)+` = 2.0 * abs(2.0 * (${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName}))) - 1.0;\n`}return this}serialize(){const e=super.serialize();return e.kind=this.kind,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.kind=e.kind}});class ef{get step(){return this._step}set step(e){this._step=e}get color(){return this._color}set color(e){this._color=e}constructor(e,t){this.step=e,this.color=t}}m("BABYLON.GradientBlock",class extends $r{colorStepsUpdated(){this.onValueChangedObservable.notifyObservers(this)}constructor(e){super(e,qs.Neutral),this.colorSteps=[new ef(0,N.Black()),new ef(1,N.White())],this.onValueChangedObservable=new a,this.registerInput("gradient",$s.AutoDetect),this.registerOutput("output",$s.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes($s.Float|$s.Vector2|$s.Vector3|$s.Vector4|$s.Color3|$s.Color4)}getClassName(){return"GradientBlock"}get gradient(){return this._inputs[0]}get output(){return this._outputs[0]}_writeColorConstant(e){const t=this.colorSteps[e];return`vec3(${t.color.r}, ${t.color.g}, ${t.color.b})`}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];if(!this.colorSteps.length||!this.gradient.connectedPoint)return void(e.compilationString+=this._declareOutput(t,e)+" = vec3(0., 0., 0.);\n");const i=e._getFreeVariableName("gradientTempColor"),s=e._getFreeVariableName("gradientTempPosition");e.compilationString+=`vec3 ${i} = ${this._writeColorConstant(0)};\n`,e.compilationString+=`float ${s};\n`;let r=this.gradient.associatedVariableName;this.gradient.connectedPoint.type!==$s.Float&&(r+=".x");for(let t=1;t<this.colorSteps.length;t++){const n=this.colorSteps[t],o=this.colorSteps[t-1];e.compilationString+=`${s} = clamp((${r} - ${e._emitFloat(o.step)}) / (${e._emitFloat(n.step)} -  ${e._emitFloat(o.step)}), 0.0, 1.0) * step(${e._emitFloat(t)}, ${e._emitFloat(this.colorSteps.length-1)});\n`,e.compilationString+=`${i} = mix(${i}, ${this._writeColorConstant(t)}, ${s});\n`}return e.compilationString+=this._declareOutput(t,e)+` = ${i};\n`,this}serialize(){const e=super.serialize();e.colorSteps=[];for(const t of this.colorSteps)e.colorSteps.push({step:t.step,color:{r:t.color.r,g:t.color.g,b:t.color.b}});return e}_deserialize(e,t,i){super._deserialize(e,t,i),this.colorSteps.length=0;for(const t of e.colorSteps)this.colorSteps.push(new ef(t.step,new N(t.color.r,t.color.g,t.color.b)))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();e+=`${this._codeVariableName}.colorSteps = [];\n`;for(const t of this.colorSteps)e+=`${this._codeVariableName}.colorSteps.push(new BABYLON.GradientBlockColorStep(${t.step}, new BABYLON.Color3(${t.color.r}, ${t.color.g}, ${t.color.b})));\n`;return e}}),m("BABYLON.NLerpBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("left",$s.AutoDetect),this.registerInput("right",$s.AutoDetect),this.registerInput("gradient",$s.AutoDetect),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push($s.Float)}getClassName(){return"NLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = normalize(mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName}));\n`,this}});class tf extends $r{constructor(e){super(e,qs.Neutral),this.manhattanDistance=!1,this.registerInput("seed",$s.Vector3),this.registerInput("jitter",$s.Float),this.registerOutput("output",$s.Vector2),this.registerOutput("x",$s.Float),this.registerOutput("y",$s.Float)}getClassName(){return"WorleyNoise3DBlock"}get seed(){return this._inputs[0]}get jitter(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;if(!this.output.hasEndpoints&&!this.x.hasEndpoints&&!this.y.hasEndpoints)return;let t="vec3 permute(vec3 x){\n";t+="    return mod((34.0 * x + 1.0) * x, 289.0);\n",t+="}\n\n",t+="vec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){\n",t+="    return manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z);\n",t+="}\n\n",t+="vec2 worley(vec3 P, float jitter, bool manhattanDistance){\n",t+="    float K = 0.142857142857; // 1/7\n",t+="    float Ko = 0.428571428571; // 1/2-K/2\n",t+="    float  K2 = 0.020408163265306; // 1/(7*7)\n",t+="    float Kz = 0.166666666667; // 1/6\n",t+="    float Kzo = 0.416666666667; // 1/2-1/6*2\n",t+="\n",t+="    vec3 Pi = mod(floor(P), 289.0);\n",t+="    vec3 Pf = fract(P) - 0.5;\n",t+="\n",t+="    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);\n",t+="    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);\n",t+="    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);\n",t+="\n",t+="    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));\n",t+="    vec3 p1 = permute(p + Pi.y - 1.0);\n",t+="    vec3 p2 = permute(p + Pi.y);\n",t+="    vec3 p3 = permute(p + Pi.y + 1.0);\n",t+="\n",t+="    vec3 p11 = permute(p1 + Pi.z - 1.0);\n",t+="    vec3 p12 = permute(p1 + Pi.z);\n",t+="    vec3 p13 = permute(p1 + Pi.z + 1.0);\n",t+="\n",t+="    vec3 p21 = permute(p2 + Pi.z - 1.0);\n",t+="    vec3 p22 = permute(p2 + Pi.z);\n",t+="    vec3 p23 = permute(p2 + Pi.z + 1.0);\n",t+="\n",t+="    vec3 p31 = permute(p3 + Pi.z - 1.0);\n",t+="    vec3 p32 = permute(p3 + Pi.z);\n",t+="    vec3 p33 = permute(p3 + Pi.z + 1.0);\n",t+="\n",t+="    vec3 ox11 = fract(p11*K) - Ko;\n",t+="    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;\n",t+="    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed\n",t+="\n",t+="    vec3 ox12 = fract(p12*K) - Ko;\n",t+="    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;\n",t+="    vec3 oz12 = floor(p12*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox13 = fract(p13*K) - Ko;\n",t+="    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;\n",t+="    vec3 oz13 = floor(p13*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox21 = fract(p21*K) - Ko;\n",t+="    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;\n",t+="    vec3 oz21 = floor(p21*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox22 = fract(p22*K) - Ko;\n",t+="    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;\n",t+="    vec3 oz22 = floor(p22*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox23 = fract(p23*K) - Ko;\n",t+="    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;\n",t+="    vec3 oz23 = floor(p23*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox31 = fract(p31*K) - Ko;\n",t+="    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;\n",t+="    vec3 oz31 = floor(p31*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox32 = fract(p32*K) - Ko;\n",t+="    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;\n",t+="    vec3 oz32 = floor(p32*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox33 = fract(p33*K) - Ko;\n",t+="    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;\n",t+="    vec3 oz33 = floor(p33*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 dx11 = Pfx + jitter*ox11;\n",t+="    vec3 dy11 = Pfy.x + jitter*oy11;\n",t+="    vec3 dz11 = Pfz.x + jitter*oz11;\n",t+="\n",t+="    vec3 dx12 = Pfx + jitter*ox12;\n",t+="    vec3 dy12 = Pfy.x + jitter*oy12;\n",t+="    vec3 dz12 = Pfz.y + jitter*oz12;\n",t+="\n",t+="    vec3 dx13 = Pfx + jitter*ox13;\n",t+="    vec3 dy13 = Pfy.x + jitter*oy13;\n",t+="    vec3 dz13 = Pfz.z + jitter*oz13;\n",t+="\n",t+="    vec3 dx21 = Pfx + jitter*ox21;\n",t+="    vec3 dy21 = Pfy.y + jitter*oy21;\n",t+="    vec3 dz21 = Pfz.x + jitter*oz21;\n",t+="\n",t+="    vec3 dx22 = Pfx + jitter*ox22;\n",t+="    vec3 dy22 = Pfy.y + jitter*oy22;\n",t+="    vec3 dz22 = Pfz.y + jitter*oz22;\n",t+="\n",t+="    vec3 dx23 = Pfx + jitter*ox23;\n",t+="    vec3 dy23 = Pfy.y + jitter*oy23;\n",t+="    vec3 dz23 = Pfz.z + jitter*oz23;\n",t+="\n",t+="    vec3 dx31 = Pfx + jitter*ox31;\n",t+="    vec3 dy31 = Pfy.z + jitter*oy31;\n",t+="    vec3 dz31 = Pfz.x + jitter*oz31;\n",t+="\n",t+="    vec3 dx32 = Pfx + jitter*ox32;\n",t+="    vec3 dy32 = Pfy.z + jitter*oy32;\n",t+="    vec3 dz32 = Pfz.y + jitter*oz32;\n",t+="\n",t+="    vec3 dx33 = Pfx + jitter*ox33;\n",t+="    vec3 dy33 = Pfy.z + jitter*oy33;\n",t+="    vec3 dz33 = Pfz.z + jitter*oz33;\n",t+="\n",t+="    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);\n",t+="    vec3 d12 =dist(dx12, dy12, dz12, manhattanDistance);\n",t+="    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);\n",t+="    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);\n",t+="    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);\n",t+="    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);\n",t+="    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);\n",t+="    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);\n",t+="    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);\n",t+="\n",t+="    vec3 d1a = min(d11, d12);\n",t+="    d12 = max(d11, d12);\n",t+="    d11 = min(d1a, d13); // Smallest now not in d12 or d13\n",t+="    d13 = max(d1a, d13);\n",t+="    d12 = min(d12, d13); // 2nd smallest now not in d13\n",t+="    vec3 d2a = min(d21, d22);\n",t+="    d22 = max(d21, d22);\n",t+="    d21 = min(d2a, d23); // Smallest now not in d22 or d23\n",t+="    d23 = max(d2a, d23);\n",t+="    d22 = min(d22, d23); // 2nd smallest now not in d23\n",t+="    vec3 d3a = min(d31, d32);\n",t+="    d32 = max(d31, d32);\n",t+="    d31 = min(d3a, d33); // Smallest now not in d32 or d33\n",t+="    d33 = max(d3a, d33);\n",t+="    d32 = min(d32, d33); // 2nd smallest now not in d33\n",t+="    vec3 da = min(d11, d21);\n",t+="    d21 = max(d11, d21);\n",t+="    d11 = min(da, d31); // Smallest now in d11\n",t+="    d31 = max(da, d31); // 2nd smallest now not in d31\n",t+="    d11.xy = (d11.x < d11.y) ? d11.xy : d11.yx;\n",t+="    d11.xz = (d11.x < d11.z) ? d11.xz : d11.zx; // d11.x now smallest\n",t+="    d12 = min(d12, d21); // 2nd smallest now not in d21\n",t+="    d12 = min(d12, d22); // nor in d22\n",t+="    d12 = min(d12, d31); // nor in d31\n",t+="    d12 = min(d12, d32); // nor in d32\n",t+="    d11.yz = min(d11.yz,d12.xy); // nor in d12.yz\n",t+="    d11.y = min(d11.y,d12.z); // Only two more to go\n",t+="    d11.y = min(d11.y,d11.z); // Done! (Phew!)\n",t+="    return sqrt(d11.xy); // F1, F2\n",t+="}\n\n",e._emitFunction("worley3D","vec3 permute(vec3 x){\n    return mod((34.0 * x + 1.0) * x, 289.0);\n}\n\nvec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){\n    return manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z);\n}\n\nvec2 worley(vec3 P, float jitter, bool manhattanDistance){\n    float K = 0.142857142857; // 1/7\n    float Ko = 0.428571428571; // 1/2-K/2\n    float  K2 = 0.020408163265306; // 1/(7*7)\n    float Kz = 0.166666666667; // 1/6\n    float Kzo = 0.416666666667; // 1/2-1/6*2\n\n    vec3 Pi = mod(floor(P), 289.0);\n    vec3 Pf = fract(P) - 0.5;\n\n    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);\n    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);\n    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);\n\n    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));\n    vec3 p1 = permute(p + Pi.y - 1.0);\n    vec3 p2 = permute(p + Pi.y);\n    vec3 p3 = permute(p + Pi.y + 1.0);\n\n    vec3 p11 = permute(p1 + Pi.z - 1.0);\n    vec3 p12 = permute(p1 + Pi.z);\n    vec3 p13 = permute(p1 + Pi.z + 1.0);\n\n    vec3 p21 = permute(p2 + Pi.z - 1.0);\n    vec3 p22 = permute(p2 + Pi.z);\n    vec3 p23 = permute(p2 + Pi.z + 1.0);\n\n    vec3 p31 = permute(p3 + Pi.z - 1.0);\n    vec3 p32 = permute(p3 + Pi.z);\n    vec3 p33 = permute(p3 + Pi.z + 1.0);\n\n    vec3 ox11 = fract(p11*K) - Ko;\n    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;\n    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed\n\n    vec3 ox12 = fract(p12*K) - Ko;\n    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;\n    vec3 oz12 = floor(p12*K2)*Kz - Kzo;\n\n    vec3 ox13 = fract(p13*K) - Ko;\n    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;\n    vec3 oz13 = floor(p13*K2)*Kz - Kzo;\n\n    vec3 ox21 = fract(p21*K) - Ko;\n    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;\n    vec3 oz21 = floor(p21*K2)*Kz - Kzo;\n\n    vec3 ox22 = fract(p22*K) - Ko;\n    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;\n    vec3 oz22 = floor(p22*K2)*Kz - Kzo;\n\n    vec3 ox23 = fract(p23*K) - Ko;\n    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;\n    vec3 oz23 = floor(p23*K2)*Kz - Kzo;\n\n    vec3 ox31 = fract(p31*K) - Ko;\n    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;\n    vec3 oz31 = floor(p31*K2)*Kz - Kzo;\n\n    vec3 ox32 = fract(p32*K) - Ko;\n    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;\n    vec3 oz32 = floor(p32*K2)*Kz - Kzo;\n\n    vec3 ox33 = fract(p33*K) - Ko;\n    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;\n    vec3 oz33 = floor(p33*K2)*Kz - Kzo;\n\n    vec3 dx11 = Pfx + jitter*ox11;\n    vec3 dy11 = Pfy.x + jitter*oy11;\n    vec3 dz11 = Pfz.x + jitter*oz11;\n\n    vec3 dx12 = Pfx + jitter*ox12;\n    vec3 dy12 = Pfy.x + jitter*oy12;\n    vec3 dz12 = Pfz.y + jitter*oz12;\n\n    vec3 dx13 = Pfx + jitter*ox13;\n    vec3 dy13 = Pfy.x + jitter*oy13;\n    vec3 dz13 = Pfz.z + jitter*oz13;\n\n    vec3 dx21 = Pfx + jitter*ox21;\n    vec3 dy21 = Pfy.y + jitter*oy21;\n    vec3 dz21 = Pfz.x + jitter*oz21;\n\n    vec3 dx22 = Pfx + jitter*ox22;\n    vec3 dy22 = Pfy.y + jitter*oy22;\n    vec3 dz22 = Pfz.y + jitter*oz22;\n\n    vec3 dx23 = Pfx + jitter*ox23;\n    vec3 dy23 = Pfy.y + jitter*oy23;\n    vec3 dz23 = Pfz.z + jitter*oz23;\n\n    vec3 dx31 = Pfx + jitter*ox31;\n    vec3 dy31 = Pfy.z + jitter*oy31;\n    vec3 dz31 = Pfz.x + jitter*oz31;\n\n    vec3 dx32 = Pfx + jitter*ox32;\n    vec3 dy32 = Pfy.z + jitter*oy32;\n    vec3 dz32 = Pfz.y + jitter*oz32;\n\n    vec3 dx33 = Pfx + jitter*ox33;\n    vec3 dy33 = Pfy.z + jitter*oy33;\n    vec3 dz33 = Pfz.z + jitter*oz33;\n\n    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);\n    vec3 d12 =dist(dx12, dy12, dz12, manhattanDistance);\n    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);\n    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);\n    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);\n    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);\n    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);\n    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);\n    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);\n\n    vec3 d1a = min(d11, d12);\n    d12 = max(d11, d12);\n    d11 = min(d1a, d13); // Smallest now not in d12 or d13\n    d13 = max(d1a, d13);\n    d12 = min(d12, d13); // 2nd smallest now not in d13\n    vec3 d2a = min(d21, d22);\n    d22 = max(d21, d22);\n    d21 = min(d2a, d23); // Smallest now not in d22 or d23\n    d23 = max(d2a, d23);\n    d22 = min(d22, d23); // 2nd smallest now not in d23\n    vec3 d3a = min(d31, d32);\n    d32 = max(d31, d32);\n    d31 = min(d3a, d33); // Smallest now not in d32 or d33\n    d33 = max(d3a, d33);\n    d32 = min(d32, d33); // 2nd smallest now not in d33\n    vec3 da = min(d11, d21);\n    d21 = max(d11, d21);\n    d11 = min(da, d31); // Smallest now in d11\n    d31 = max(da, d31); // 2nd smallest now not in d31\n    d11.xy = (d11.x < d11.y) ? d11.xy : d11.yx;\n    d11.xz = (d11.x < d11.z) ? d11.xz : d11.zx; // d11.x now smallest\n    d12 = min(d12, d21); // 2nd smallest now not in d21\n    d12 = min(d12, d22); // nor in d22\n    d12 = min(d12, d31); // nor in d31\n    d12 = min(d12, d32); // nor in d32\n    d11.yz = min(d11.yz,d12.xy); // nor in d12.yz\n    d11.y = min(d11.y,d12.z); // Only two more to go\n    d11.y = min(d11.y,d11.z); // Done! (Phew!)\n    return sqrt(d11.xy); // F1, F2\n}\n\n","// Worley3D");const i=e._getFreeVariableName("worleyTemp");return e.compilationString+=`vec2 ${i} = worley(${this.seed.associatedVariableName}, ${this.jitter.associatedVariableName}, ${this.manhattanDistance});\n`,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${i};\n`),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+` = ${i}.x;\n`),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+` = ${i}.y;\n`),this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.manhattanDistance = ${this.manhattanDistance};\n`}serialize(){const e=super.serialize();return e.manhattanDistance=this.manhattanDistance,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.manhattanDistance=e.manhattanDistance}}me([Zr("Use Manhattan Distance",Js.Boolean,"PROPERTIES",{notifiers:{update:!1}})],tf.prototype,"manhattanDistance",void 0),m("BABYLON.WorleyNoise3DBlock",tf),m("BABYLON.SimplexPerlin3DBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("seed",$s.Vector3),this.registerOutput("output",$s.Float)}getClassName(){return"SimplexPerlin3DBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;if(!this._outputs[0].hasEndpoints)return;let t="const float SKEWFACTOR = 1.0/3.0;\n";return t+="const float UNSKEWFACTOR = 1.0/6.0;\n",t+="const float SIMPLEX_CORNER_POS = 0.5;\n",t+="const float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;\n",t+="float SimplexPerlin3D( vec3 P ){\n",t+="    P.x = P == vec3(0., 0., 0.) ? 0.00001 : P.x;\n",t+="    P *= SIMPLEX_TETRAHADRON_HEIGHT;\n",t+="    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );",t+="    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );\n",t+="    vec3 g = step(x0.yzx, x0.xyz);\n",t+="    vec3 l = 1.0 - g;\n",t+="    vec3 Pi_1 = min( g.xyz, l.zxy );\n",t+="    vec3 Pi_2 = max( g.xyz, l.zxy );\n",t+="    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;\n",t+="    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;\n",t+="    vec3 x3 = x0 - SIMPLEX_CORNER_POS;\n",t+="    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );\n",t+="    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );\n",t+="    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );\n",t+="    Pi.xyz = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;\n",t+="    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );\n",t+="    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;\n",t+="    Pt *= Pt;\n",t+="    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );\n",t+="    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );\n",t+="    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );\n",t+="    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );\n",t+="    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );\n",t+="    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );\n",t+="    Pi_1 = ( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods;\n",t+="    Pi_2 = ( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods;\n",t+="    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;\n",t+="    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;\n",t+="    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;\n",t+="    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );\n",t+="    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;\n",t+="    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;\n",t+="    kernel_weights = max(0.5 - kernel_weights, 0.0);\n",t+="    kernel_weights = kernel_weights*kernel_weights*kernel_weights;\n",t+="    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;\n",t+="}\n",e._emitFunction("SimplexPerlin3D","const float SKEWFACTOR = 1.0/3.0;\nconst float UNSKEWFACTOR = 1.0/6.0;\nconst float SIMPLEX_CORNER_POS = 0.5;\nconst float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;\nfloat SimplexPerlin3D( vec3 P ){\n    P.x = P == vec3(0., 0., 0.) ? 0.00001 : P.x;\n    P *= SIMPLEX_TETRAHADRON_HEIGHT;\n    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );\n    vec3 g = step(x0.yzx, x0.xyz);\n    vec3 l = 1.0 - g;\n    vec3 Pi_1 = min( g.xyz, l.zxy );\n    vec3 Pi_2 = max( g.xyz, l.zxy );\n    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;\n    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;\n    vec3 x3 = x0 - SIMPLEX_CORNER_POS;\n    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );\n    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );\n    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );\n    Pi.xyz = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;\n    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );\n    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;\n    Pt *= Pt;\n    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );\n    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );\n    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );\n    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );\n    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );\n    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );\n    Pi_1 = ( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods;\n    Pi_2 = ( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods;\n    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;\n    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;\n    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;\n    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );\n    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;\n    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;\n    kernel_weights = max(0.5 - kernel_weights, 0.0);\n    kernel_weights = kernel_weights*kernel_weights*kernel_weights;\n    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;\n}\n","// SimplexPerlin3D"),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = SimplexPerlin3D(${this.seed.associatedVariableName});\n`,this}}),m("BABYLON.NormalBlendBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("normalMap0",$s.AutoDetect),this.registerInput("normalMap1",$s.AutoDetect),this.registerOutput("output",$s.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes($s.Color3|$s.Color4|$s.Vector3|$s.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes($s.Color3|$s.Color4|$s.Vector3|$s.Vector4)}getClassName(){return"NormalBlendBlock"}get normalMap0(){return this._inputs[0]}get normalMap1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0],s=this._inputs[1],r=e._getFreeVariableName("stepR"),n=e._getFreeVariableName("stepG");return e.compilationString+=`float ${r} = step(0.5, ${i.associatedVariableName}.r);\n`,e.compilationString+=`float ${n} = step(0.5, ${i.associatedVariableName}.g);\n`,e.compilationString+=this._declareOutput(t,e)+";\n",e.compilationString+=`${t.associatedVariableName}.r = (1.0 - ${r}) * ${i.associatedVariableName}.r * ${s.associatedVariableName}.r * 2.0 + ${r} * (1.0 - (1.0 - ${i.associatedVariableName}.r) * (1.0 - ${s.associatedVariableName}.r) * 2.0);\n`,e.compilationString+=`${t.associatedVariableName}.g = (1.0 - ${n}) * ${i.associatedVariableName}.g * ${s.associatedVariableName}.g * 2.0 + ${n} * (1.0 - (1.0 - ${i.associatedVariableName}.g) * (1.0 - ${s.associatedVariableName}.g) * 2.0);\n`,e.compilationString+=`${t.associatedVariableName}.b = ${i.associatedVariableName}.b * ${s.associatedVariableName}.b;\n`,this}}),m("BABYLON.Rotate2dBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("input",$s.Vector2),this.registerInput("angle",$s.Float),this.registerOutput("output",$s.Vector2)}getClassName(){return"Rotate2dBlock"}get input(){return this._inputs[0]}get angle(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){const e=new rn("angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.angle,s=this.input;return e.compilationString+=this._declareOutput(t,e)+` = vec2(cos(${i.associatedVariableName}) * ${s.associatedVariableName}.x - sin(${i.associatedVariableName}) * ${s.associatedVariableName}.y, sin(${i.associatedVariableName}) * ${s.associatedVariableName}.x + cos(${i.associatedVariableName}) * ${s.associatedVariableName}.y);\n`,this}}),m("BABYLON.ReflectBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("incident",$s.AutoDetect),this.registerInput("normal",$s.AutoDetect),this.registerOutput("output",$s.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes($s.Vector3|$s.Vector4|$s.Color3|$s.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes($s.Vector3|$s.Vector4|$s.Color3|$s.Color4)}getClassName(){return"ReflectBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = reflect(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz);\n`,this}}),m("BABYLON.RefractBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("incident",$s.AutoDetect),this.registerInput("normal",$s.AutoDetect),this.registerInput("ior",$s.Float),this.registerOutput("output",$s.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes($s.Vector3|$s.Vector4|$s.Color3|$s.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes($s.Vector3|$s.Vector4|$s.Color3|$s.Color4)}getClassName(){return"RefractBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get ior(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = refract(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz, ${this.ior.associatedVariableName});\n`,this}}),m("BABYLON.DesaturateBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("color",$s.Color3),this.registerInput("level",$s.Float),this.registerOutput("output",$s.Color3)}getClassName(){return"DesaturateBlock"}get color(){return this._inputs[0]}get level(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.color.associatedVariableName,s=e._getFreeVariableName("colorMin"),r=e._getFreeVariableName("colorMax"),n=e._getFreeVariableName("colorMerge");return e.compilationString+=`float ${s} = min(min(${i}.x, ${i}.y), ${i}.z);\n`,e.compilationString+=`float ${r} = max(max(${i}.x, ${i}.y), ${i}.z);\n`,e.compilationString+=`float ${n} = 0.5 * (${s} + ${r});\n`,e.compilationString+=this._declareOutput(t,e)+` = mix(${i}, vec3(${n}, ${n}, ${n}), ${this.level.associatedVariableName});\n`,this}});class sf extends $r{constructor(e){super(e,qs.Fragment),this.albedoScaling=!1,this.linkSheenWithAlbedo=!1,this._isUnique=!0,this.registerInput("intensity",$s.Float,!0,qs.Fragment),this.registerInput("color",$s.Color3,!0,qs.Fragment),this.registerInput("roughness",$s.Float,!0,qs.Fragment),this.registerOutput("sheen",$s.Object,qs.Fragment,new V_("sheen",this,Zs.Output,sf,"SheenBlock"))}initialize(e){e._excludeVariableName("sheenOut"),e._excludeVariableName("sheenMapData"),e._excludeVariableName("vSheenColor"),e._excludeVariableName("vSheenRoughness")}getClassName(){return"SheenBlock"}get intensity(){return this._inputs[0]}get color(){return this._inputs[1]}get roughness(){return this._inputs[2]}get sheen(){return this._outputs[0]}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("SHEEN",!0),i.setValue("SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("SHEEN_LINKWITHALBEDO",this.linkSheenWithAlbedo,!0),i.setValue("SHEEN_ROUGHNESS",this.roughness.isConnected,!0),i.setValue("SHEEN_ALBEDOSCALING",this.albedoScaling,!0)}getCode(e){let t="";return t=`#ifdef SHEEN\n            sheenOutParams sheenOut;\n\n            vec4 vSheenColor = vec4(${this.color.isConnected?this.color.associatedVariableName:"vec3(1.)"}, ${this.intensity.isConnected?this.intensity.associatedVariableName:"1."});\n\n            sheenBlock(\n                vSheenColor,\n            #ifdef SHEEN_ROUGHNESS\n                ${this.roughness.isConnected?this.roughness.associatedVariableName:"0."},\n            #endif\n                roughness,\n            #ifdef SHEEN_TEXTURE\n                vec4(0.),\n                1.0,\n            #endif\n                reflectance,\n            #ifdef SHEEN_LINKWITHALBEDO\n                baseColor,\n                surfaceAlbedo,\n            #endif\n            #ifdef ENVIRONMENTBRDF\n                NdotV,\n                environmentBrdf,\n            #endif\n            #if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n                AARoughnessFactors,\n                ${null==e?void 0:e._vReflectionMicrosurfaceInfosName},\n                ${null==e?void 0:e._vReflectionInfosName},\n                ${null==e?void 0:e.reflectionColor},\n                vLightingIntensity,\n                #ifdef ${null==e?void 0:e._define3DName}\n                    ${null==e?void 0:e._cubeSamplerName},\n                #else\n                    ${null==e?void 0:e._2DSamplerName},\n                #endif\n                reflectionOut.reflectionCoords,\n                NdotVUnclamped,\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${null==e?void 0:e._define3DName}\n                        ${null==e?void 0:e._cubeSamplerName},\n                        ${null==e?void 0:e._cubeSamplerName},\n                    #else\n                        ${null==e?void 0:e._2DSamplerName},\n                        ${null==e?void 0:e._2DSamplerName},\n                    #endif\n                #endif\n                #if !defined(${null==e?void 0:e._defineSkyboxName}) && defined(RADIANCEOCCLUSION)\n                    seo,\n                #endif\n                #if !defined(${null==e?void 0:e._defineSkyboxName}) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(${null==e?void 0:e._define3DName})\n                    eho,\n                #endif\n            #endif\n                sheenOut\n            );\n\n            #ifdef SHEEN_LINKWITHALBEDO\n                surfaceAlbedo = sheenOut.surfaceAlbedo;\n            #endif\n        #endif\n`,t}_buildBlock(e){return e.target===qs.Fragment&&e.sharedData.blocksWithDefines.push(this),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.albedoScaling = ${this.albedoScaling};\n`,e+=`${this._codeVariableName}.linkSheenWithAlbedo = ${this.linkSheenWithAlbedo};\n`,e}serialize(){const e=super.serialize();return e.albedoScaling=this.albedoScaling,e.linkSheenWithAlbedo=this.linkSheenWithAlbedo,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.albedoScaling=e.albedoScaling,this.linkSheenWithAlbedo=e.linkSheenWithAlbedo}}me([Zr("Albedo scaling",Js.Boolean,"PROPERTIES",{notifiers:{update:!0}})],sf.prototype,"albedoScaling",void 0),me([Zr("Link sheen with albedo",Js.Boolean,"PROPERTIES",{notifiers:{update:!0}})],sf.prototype,"linkSheenWithAlbedo",void 0),m("BABYLON.SheenBlock",sf);class rf extends $r{constructor(e){super(e,qs.Fragment),this._tangentCorrectionFactorName="",this._isUnique=!0,this.registerInput("intensity",$s.Float,!0,qs.Fragment),this.registerInput("direction",$s.Vector2,!0,qs.Fragment),this.registerInput("uv",$s.Vector2,!0),this.registerInput("worldTangent",$s.Vector4,!0),this.registerInput("TBN",$s.Object,!0,qs.VertexAndFragment,new V_("TBN",this,Zs.Input,z_,"TBNBlock")),this.registerInput("roughness",$s.Float,!0,qs.Fragment),this.registerOutput("anisotropy",$s.Object,qs.Fragment,new V_("anisotropy",this,Zs.Output,rf,"AnisotropyBlock"))}initialize(e){e._excludeVariableName("anisotropicOut"),e._excludeVariableName("TBN")}getClassName(){return"AnisotropyBlock"}get intensity(){return this._inputs[0]}get direction(){return this._inputs[1]}get uv(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get TBN(){return this._inputs[4]}get roughness(){return this._inputs[5]}get anisotropy(){return this._outputs[0]}_generateTBNSpace(e){let t="";const i=`//${this.name}`,s=this.uv,r=this.worldPositionConnectionPoint,n=this.worldNormalConnectionPoint,o=this.worldTangent;s.isConnected||console.error("You must connect the 'uv' input of the Anisotropy block!"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const a={search:/defined\(TANGENT\)/g,replace:o.isConnected?"defined(TANGENT)":"defined(IGNORE)"},l=this.TBN;return l.isConnected?e.compilationString+=`\n            #ifdef TBNBLOCK\n            mat3 vTBN = ${l.associatedVariableName};\n            #endif\n            `:o.isConnected&&(t+=`vec3 tbnNormal = normalize(${n.associatedVariableName}.xyz);\n`,t+=`vec3 tbnTangent = normalize(${o.associatedVariableName}.xyz);\n`,t+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\n`,t+="mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\n"),t+=`\n            #if defined(${o.isConnected?"TANGENT":"IGNORE"}) && defined(NORMAL)\n                mat3 TBN = vTBN;\n            #else\n                mat3 TBN = cotangent_frame(${n.associatedVariableName+".xyz"}, ${"v_"+r.associatedVariableName+".xyz"}, ${s.isConnected?s.associatedVariableName:"vec2(0.)"}, vec2(1., 1.));\n            #endif\n`,e._emitFunctionFromInclude("bumpFragmentMainFunctions",i,{replaceStrings:[a]}),t}getCode(e,t=!1){let i="";t&&(i+=this._generateTBNSpace(e));const s=this.intensity.isConnected?this.intensity.associatedVariableName:"1.0";return i+=`anisotropicOutParams anisotropicOut;\n            anisotropicBlock(\n                vec3(${this.direction.isConnected?this.direction.associatedVariableName:"vec2(1., 0.)"}, ${s}),\n                ${this.roughness.isConnected?this.roughness.associatedVariableName:"0."},\n            #ifdef ANISOTROPIC_TEXTURE\n                vec3(0.),\n            #endif\n                TBN,\n                normalW,\n                viewDirectionW,\n                anisotropicOut\n            );\n`,i}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("ANISOTROPIC",!0),i.setValue("ANISOTROPIC_TEXTURE",!1,!0),i.setValue("ANISOTROPIC_LEGACY",!this.roughness.isConnected)}bind(e,t,i){super.bind(e,t,i),i&&e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1)}_buildBlock(e){return e.target===qs.Fragment&&(e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,"float")),this}}m("BABYLON.AnisotropyBlock",rf);class nf extends K_{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,console.error("The position input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?qs.Fragment:qs.Vertex,this.generateOnlyFragmentCode&&(this.forceIrradianceInFragment=!0)}constructor(e){super(e),this.useSphericalHarmonics=!0,this.forceIrradianceInFragment=!1,this._isUnique=!0,this.registerInput("position",$s.AutoDetect,!1,qs.Vertex),this.registerInput("world",$s.Matrix,!1,qs.Vertex),this.registerInput("color",$s.Color3,!0,qs.Fragment),this.registerOutput("reflection",$s.Object,qs.Fragment,new V_("reflection",this,Zs.Output,nf,"ReflectionBlock")),this.position.addExcludedConnectionPointFromAllowedTypes($s.Color3|$s.Vector3|$s.Vector4)}getClassName(){return"ReflectionBlock"}get position(){return this._inputs[0]}get worldPosition(){return this.worldPositionConnectionPoint}get worldNormal(){return this.worldNormalConnectionPoint}get world(){return this._inputs[1]}get cameraPosition(){return this.cameraPositionConnectionPoint}get view(){return this.viewConnectionPoint}get color(){return this._inputs[2]}get reflection(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}get reflectionColor(){return this.color.isConnected?this.color.associatedVariableName:"vec3(1., 1., 1.)"}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const s=this._getTexture(),r=s&&s.getTextureMatrix;i.setValue("REFLECTION",r,!0),r&&(i.setValue(this._defineLODReflectionAlpha,s.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularReflection,s.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!s.invertZ:s.invertZ,!0),i.setValue("SPHERICAL_HARMONICS",this.useSphericalHarmonics,!0),i.setValue("GAMMAREFLECTION",s.gammaSpace,!0),i.setValue("RGBDREFLECTION",s.isRGBD,!0),s&&s.coordinatesMode!==Ar.SKYBOX_MODE&&s.isCube&&(i.setValue("USESPHERICALFROMREFLECTIONMAP",!0),i.setValue("USEIRRADIANCEMAP",!1),this.forceIrradianceInFragment||this._scene.getEngine().getCaps().maxVaryingVectors<=8?i.setValue("USESPHERICALINVERTEX",!1):i.setValue("USESPHERICALINVERTEX",!0)))}bind(e,t,i,s){super.bind(e,t,i);const r=this._getTexture();if(!r||!s)return;r.isCube?e.setTexture(this._cubeSamplerName,r):e.setTexture(this._2DSamplerName,r);const n=r.getSize().width;e.setFloat3(this._vReflectionMicrosurfaceInfosName,n,r.lodGenerationScale,r.lodGenerationOffset),e.setFloat2(this._vReflectionFilteringInfoName,n,l.Log2(n));const o=s.materialDefines,a=r.sphericalPolynomial;if(o.USESPHERICALFROMREFLECTIONMAP&&a)if(o.SPHERICAL_HARMONICS){const t=a.preScaledHarmonics;e.setVector3("vSphericalL00",t.l00),e.setVector3("vSphericalL1_1",t.l1_1),e.setVector3("vSphericalL10",t.l10),e.setVector3("vSphericalL11",t.l11),e.setVector3("vSphericalL2_2",t.l2_2),e.setVector3("vSphericalL2_1",t.l2_1),e.setVector3("vSphericalL20",t.l20),e.setVector3("vSphericalL21",t.l21),e.setVector3("vSphericalL22",t.l22)}else e.setFloat3("vSphericalX",a.x.x,a.x.y,a.x.z),e.setFloat3("vSphericalY",a.y.x,a.y.y,a.y.z),e.setFloat3("vSphericalZ",a.z.x,a.z.y,a.z.z),e.setFloat3("vSphericalXX_ZZ",a.xx.x-a.zz.x,a.xx.y-a.zz.y,a.xx.z-a.zz.z),e.setFloat3("vSphericalYY_ZZ",a.yy.x-a.zz.x,a.yy.y-a.zz.y,a.yy.z-a.zz.z),e.setFloat3("vSphericalZZ",a.zz.x,a.zz.y,a.zz.z),e.setFloat3("vSphericalXY",a.xy.x,a.xy.y,a.xy.z),e.setFloat3("vSphericalYZ",a.yz.x,a.yz.y,a.yz.z),e.setFloat3("vSphericalZX",a.zx.x,a.zx.y,a.zx.z)}handleVertexSide(e){let t=super.handleVertexSide(e);e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]});const i=e._getFreeVariableName("reflectionVector");return this._vEnvironmentIrradianceName=e._getFreeVariableName("vEnvironmentIrradiance"),e._emitVaryingFromString(this._vEnvironmentIrradianceName,"vec3","defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)"),e._emitUniformFromString("vSphericalL00","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL1_1","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL10","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL11","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_2","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_1","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL20","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL21","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL22","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalX","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalY","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXX_ZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYY_ZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXY","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZX","vec3","SPHERICAL_HARMONICS",!0),t+=`#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\n                vec3 ${i} = vec3(${this._reflectionMatrixName} * vec4(normalize(${this.worldNormal.associatedVariableName}).xyz, 0)).xyz;\n                #ifdef ${this._defineOppositeZ}\n                    ${i}.z *= -1.0;\n                #endif\n                ${this._vEnvironmentIrradianceName} = computeEnvironmentIrradiance(${i});\n            #endif\n`,t}getCode(e,t){let i="";this.handleFragmentSideInits(e),e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]}),e._emitFunction("sampleReflection",`\n            #ifdef ${this._define3DName}\n                #define sampleReflection(s, c) textureCube(s, c)\n            #else\n                #define sampleReflection(s, c) texture2D(s, c)\n            #endif\n`,`//${this.name}`),e._emitFunction("sampleReflectionLod",`\n            #ifdef ${this._define3DName}\n                #define sampleReflectionLod(s, c, l) textureCubeLodEXT(s, c, l)\n            #else\n                #define sampleReflectionLod(s, c, l) texture2DLodEXT(s, c, l)\n            #endif\n`,`//${this.name}`);const s=`\n            vec3 computeReflectionCoordsPBR(vec4 worldPos, vec3 worldNormal) {\n                ${this.handleFragmentSideCodeReflectionCoords("worldNormal","worldPos",!0,!0)}\n                return ${this._reflectionVectorName};\n            }\n`;return e._emitFunction("computeReflectionCoordsPBR",s,`//${this.name}`),this._vReflectionMicrosurfaceInfosName=e._getFreeVariableName("vReflectionMicrosurfaceInfos"),e._emitUniformFromString(this._vReflectionMicrosurfaceInfosName,"vec3"),this._vReflectionInfosName=e._getFreeVariableName("vReflectionInfos"),this._vReflectionFilteringInfoName=e._getFreeVariableName("vReflectionFilteringInfo"),e._emitUniformFromString(this._vReflectionFilteringInfoName,"vec2"),i+=`#ifdef REFLECTION\n            vec2 ${this._vReflectionInfosName} = vec2(1., 0.);\n\n            reflectionOutParams reflectionOut;\n\n            reflectionBlock(\n                ${this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:"v_"+this.worldPosition.associatedVariableName}.xyz,\n                ${t},\n                alphaG,\n                ${this._vReflectionMicrosurfaceInfosName},\n                ${this._vReflectionInfosName},\n                ${this.reflectionColor},\n            #ifdef ANISOTROPIC\n                anisotropicOut,\n            #endif\n            #if defined(${this._defineLODReflectionAlpha}) && !defined(${this._defineSkyboxName})\n                NdotVUnclamped,\n            #endif\n            #ifdef ${this._defineLinearSpecularReflection}\n                roughness,\n            #endif\n            #ifdef ${this._define3DName}\n                ${this._cubeSamplerName},\n            #else\n                ${this._2DSamplerName},\n            #endif\n            #if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n                ${this._vEnvironmentIrradianceName},\n            #endif\n            #ifdef USESPHERICALFROMREFLECTIONMAP\n                #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n                    ${this._reflectionMatrixName},\n                #endif\n            #endif\n            #ifdef USEIRRADIANCEMAP\n                irradianceSampler, // ** not handled **\n            #endif\n            #ifndef LODBASEDMICROSFURACE\n                #ifdef ${this._define3DName}\n                    ${this._cubeSamplerName},\n                    ${this._cubeSamplerName},\n                #else\n                    ${this._2DSamplerName},\n                    ${this._2DSamplerName},\n                #endif\n            #endif\n            #ifdef REALTIME_FILTERING\n                ${this._vReflectionFilteringInfoName},\n            #endif\n                reflectionOut\n            );\n        #endif\n`,i}_buildBlock(e){return this._scene=e.sharedData.scene,e.target!==qs.Fragment&&(this._defineLODReflectionAlpha=e._getFreeDefineName("LODINREFLECTIONALPHA"),this._defineLinearSpecularReflection=e._getFreeDefineName("LINEARSPECULARREFLECTION")),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e+=`${this._codeVariableName}.texture.gammaSpace = ${this.texture.gammaSpace};\n`),e+=`${this._codeVariableName}.useSphericalHarmonics = ${this.useSphericalHarmonics};\n`,e+=`${this._codeVariableName}.forceIrradianceInFragment = ${this.forceIrradianceInFragment};\n`,e}serialize(){var e,t;const i=super.serialize();return i.useSphericalHarmonics=this.useSphericalHarmonics,i.forceIrradianceInFragment=this.forceIrradianceInFragment,i.gammaSpace=null===(t=null===(e=this.texture)||void 0===e?void 0:e.gammaSpace)||void 0===t||t,i}_deserialize(e,t,i){super._deserialize(e,t,i),this.useSphericalHarmonics=e.useSphericalHarmonics,this.forceIrradianceInFragment=e.forceIrradianceInFragment,this.texture&&(this.texture.gammaSpace=e.gammaSpace)}}me([Zr("Spherical Harmonics",Js.Boolean,"ADVANCED",{notifiers:{update:!0}})],nf.prototype,"useSphericalHarmonics",void 0),me([Zr("Force irradiance in fragment",Js.Boolean,"ADVANCED",{notifiers:{update:!0}})],nf.prototype,"forceIrradianceInFragment",void 0),m("BABYLON.ReflectionBlock",nf);class of extends $r{constructor(e){super(e,qs.Fragment),this._tangentCorrectionFactorName="",this.remapF0OnInterfaceChange=!0,this._isUnique=!0,this.registerInput("intensity",$s.Float,!1,qs.Fragment),this.registerInput("roughness",$s.Float,!0,qs.Fragment),this.registerInput("indexOfRefraction",$s.Float,!0,qs.Fragment),this.registerInput("normalMapColor",$s.Color3,!0,qs.Fragment),this.registerInput("uv",$s.Vector2,!0,qs.Fragment),this.registerInput("tintColor",$s.Color3,!0,qs.Fragment),this.registerInput("tintAtDistance",$s.Float,!0,qs.Fragment),this.registerInput("tintThickness",$s.Float,!0,qs.Fragment),this.registerInput("worldTangent",$s.Vector4,!0),this.registerInput("worldNormal",$s.AutoDetect,!0),this.worldNormal.addExcludedConnectionPointFromAllowedTypes($s.Color4|$s.Vector4|$s.Vector3),this.registerInput("TBN",$s.Object,!0,qs.VertexAndFragment,new V_("TBN",this,Zs.Input,z_,"TBNBlock")),this.registerOutput("clearcoat",$s.Object,qs.Fragment,new V_("clearcoat",this,Zs.Output,of,"ClearCoatBlock"))}initialize(e){e._excludeVariableName("clearcoatOut"),e._excludeVariableName("vClearCoatParams"),e._excludeVariableName("vClearCoatTintParams"),e._excludeVariableName("vClearCoatRefractionParams"),e._excludeVariableName("vClearCoatTangentSpaceParams"),e._excludeVariableName("vGeometricNormaClearCoatW")}getClassName(){return"ClearCoatBlock"}get intensity(){return this._inputs[0]}get roughness(){return this._inputs[1]}get indexOfRefraction(){return this._inputs[2]}get normalMapColor(){return this._inputs[3]}get uv(){return this._inputs[4]}get tintColor(){return this._inputs[5]}get tintAtDistance(){return this._inputs[6]}get tintThickness(){return this._inputs[7]}get worldTangent(){return this._inputs[8]}get worldNormal(){return this._inputs[9]}get TBN(){return this._inputs[10]}get clearcoat(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){const e=new rn("ClearCoat intensity",qs.Fragment,$s.Float);e.value=1,e.output.connectTo(this.intensity)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("CLEARCOAT",!0),i.setValue("CLEARCOAT_TEXTURE",!1,!0),i.setValue("CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("CLEARCOAT_TINT",this.tintColor.isConnected||this.tintThickness.isConnected||this.tintAtDistance.isConnected,!0),i.setValue("CLEARCOAT_BUMP",this.normalMapColor.isConnected,!0),i.setValue("CLEARCOAT_DEFAULTIOR",!this.indexOfRefraction.isConnected||this.indexOfRefraction.connectInputBlock.value===Sd._DefaultIndexOfRefraction,!0),i.setValue("CLEARCOAT_REMAP_F0",this.remapF0OnInterfaceChange,!0)}bind(e,t,i){var s,r;super.bind(e,t,i);const n=null!==(r=null===(s=this.indexOfRefraction.connectInputBlock)||void 0===s?void 0:s.value)&&void 0!==r?r:Sd._DefaultIndexOfRefraction,o=1-n,a=1+n,l=Math.pow(-o/a,2),h=1/n;e.setFloat4("vClearCoatRefractionParams",l,h,o,a);const c=this.clearcoat.hasEndpoints?this.clearcoat.endpoints[0].ownerBlock:null,u=(null==c?void 0:c.perturbedNormal.isConnected)?c.perturbedNormal.connectedPoint.ownerBlock:null;this._scene._mirroredCameraPosition?e.setFloat2("vClearCoatTangentSpaceParams",(null==u?void 0:u.invertX)?1:-1,(null==u?void 0:u.invertY)?1:-1):e.setFloat2("vClearCoatTangentSpaceParams",(null==u?void 0:u.invertX)?-1:1,(null==u?void 0:u.invertY)?-1:1),i&&e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1)}_generateTBNSpace(e,t,i){let s="";const r=`//${this.name}`,n=this.worldTangent;e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const o={search:/defined\(TANGENT\)/g,replace:n.isConnected?"defined(TANGENT)":"defined(IGNORE)"},a=this.TBN;return a.isConnected?e.compilationString+=`\n            #ifdef TBNBLOCK\n            mat3 vTBN = ${a.associatedVariableName};\n            #endif\n            `:n.isConnected&&(s+=`vec3 tbnNormal = normalize(${i}.xyz);\n`,s+=`vec3 tbnTangent = normalize(${n.associatedVariableName}.xyz);\n`,s+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\n`,s+="mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\n"),e._emitFunctionFromInclude("bumpFragmentMainFunctions",r,{replaceStrings:[o]}),s}static GetCode(e,t,i,s,r,n,o){let a="";const l=(null==t?void 0:t.intensity.isConnected)?t.intensity.associatedVariableName:"1.",h=(null==t?void 0:t.roughness.isConnected)?t.roughness.associatedVariableName:"0.",c=(null==t?void 0:t.normalMapColor.isConnected)?t.normalMapColor.associatedVariableName:"vec3(0.)",u=(null==t?void 0:t.uv.isConnected)?t.uv.associatedVariableName:"vec2(0.)",d=(null==t?void 0:t.tintColor.isConnected)?t.tintColor.associatedVariableName:"vec3(1.)",p=(null==t?void 0:t.tintThickness.isConnected)?t.tintThickness.associatedVariableName:"1.",_=(null==t?void 0:t.tintAtDistance.isConnected)?t.tintAtDistance.associatedVariableName:"1.";if(t){e._emitUniformFromString("vClearCoatRefractionParams","vec4"),e._emitUniformFromString("vClearCoatTangentSpaceParams","vec2");const i=t.worldNormal;a+=`vec3 vGeometricNormaClearCoatW = ${i.isConnected?"normalize("+i.associatedVariableName+".xyz)":"geometricNormalW"};\n`}else a+="vec3 vGeometricNormaClearCoatW = geometricNormalW;\n";return r&&t&&(a+=t._generateTBNSpace(e,s,o),n=t.worldTangent.isConnected),a+=`clearcoatOutParams clearcoatOut;\n\n        #ifdef CLEARCOAT\n            vec2 vClearCoatParams = vec2(${l}, ${h});\n            vec4 vClearCoatTintParams = vec4(${d}, ${p});\n\n            clearcoatBlock(\n                ${s}.xyz,\n                vGeometricNormaClearCoatW,\n                viewDirectionW,\n                vClearCoatParams,\n                specularEnvironmentR0,\n            #ifdef CLEARCOAT_TEXTURE\n                vec2(0.),\n            #endif\n            #ifdef CLEARCOAT_TINT\n                vClearCoatTintParams,\n                ${_},\n                vClearCoatRefractionParams,\n                #ifdef CLEARCOAT_TINT_TEXTURE\n                    vec4(0.),\n                #endif\n            #endif\n            #ifdef CLEARCOAT_BUMP\n                vec2(0., 1.),\n                vec4(${c}, 0.),\n                ${u},\n                #if defined(${n?"TANGENT":"IGNORE"}) && defined(NORMAL)\n                    vTBN,\n                #else\n                    vClearCoatTangentSpaceParams,\n                #endif\n                #ifdef OBJECTSPACE_NORMALMAP\n                    normalMatrix,\n                #endif\n            #endif\n            #if defined(FORCENORMALFORWARD) && defined(NORMAL)\n                faceNormal,\n            #endif\n            #ifdef REFLECTION\n                ${null==i?void 0:i._vReflectionMicrosurfaceInfosName},\n                ${null==i?void 0:i._vReflectionInfosName},\n                ${null==i?void 0:i.reflectionColor},\n                vLightingIntensity,\n                #ifdef ${null==i?void 0:i._define3DName}\n                    ${null==i?void 0:i._cubeSamplerName},\n                #else\n                    ${null==i?void 0:i._2DSamplerName},\n                #endif\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${null==i?void 0:i._define3DName}\n                        ${null==i?void 0:i._cubeSamplerName},\n                        ${null==i?void 0:i._cubeSamplerName},\n                    #else\n                        ${null==i?void 0:i._2DSamplerName},\n                        ${null==i?void 0:i._2DSamplerName},\n                    #endif\n                #endif\n            #endif\n            #if defined(ENVIRONMENTBRDF) && !defined(${null==i?void 0:i._defineSkyboxName})\n                #ifdef RADIANCEOCCLUSION\n                    ambientMonochrome,\n                #endif\n            #endif\n            #if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n                (gl_FrontFacing ? 1. : -1.),\n            #endif\n                clearcoatOut\n            );\n        #else\n            clearcoatOut.specularEnvironmentR0 = specularEnvironmentR0;\n        #endif\n`,a}_buildBlock(e){return this._scene=e.sharedData.scene,e.target===qs.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,"float")),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.remapF0OnInterfaceChange = ${this.remapF0OnInterfaceChange};\n`,e}serialize(){const e=super.serialize();return e.remapF0OnInterfaceChange=this.remapF0OnInterfaceChange,e}_deserialize(e,t,i){var s;super._deserialize(e,t,i),this.remapF0OnInterfaceChange=null===(s=e.remapF0OnInterfaceChange)||void 0===s||s}}me([Zr("Remap F0 on interface change",Js.Boolean,"ADVANCED")],of.prototype,"remapF0OnInterfaceChange",void 0),m("BABYLON.ClearCoatBlock",of);class af extends $r{constructor(e){super(e,qs.Fragment),this._isUnique=!0,this.registerInput("intensity",$s.Float,!0,qs.Fragment),this.registerInput("indexOfRefraction",$s.Float,!0,qs.Fragment),this.registerInput("thickness",$s.Float,!0,qs.Fragment),this.registerOutput("iridescence",$s.Object,qs.Fragment,new V_("iridescence",this,Zs.Output,af,"IridescenceBlock"))}initialize(e){e._excludeVariableName("iridescenceOut"),e._excludeVariableName("vIridescenceParams")}getClassName(){return"IridescenceBlock"}get intensity(){return this._inputs[0]}get indexOfRefraction(){return this._inputs[1]}get thickness(){return this._inputs[2]}get iridescence(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){const e=new rn("Iridescence intensity",qs.Fragment,$s.Float);e.value=1,e.output.connectTo(this.intensity);const t=new rn("Iridescence ior",qs.Fragment,$s.Float);t.value=1.3,t.output.connectTo(this.indexOfRefraction);const i=new rn("Iridescence thickness",qs.Fragment,$s.Float);i.value=400,i.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("IRIDESCENCE",!0,!0),i.setValue("IRIDESCENCE_TEXTURE",!1,!0),i.setValue("IRIDESCENCE_THICKNESS_TEXTURE",!1,!0)}static GetCode(e){let t="";return t+=`iridescenceOutParams iridescenceOut;\n\n        #ifdef IRIDESCENCE\n            iridescenceBlock(\n                vec4(${(null==e?void 0:e.intensity.isConnected)?e.intensity.associatedVariableName:"1."}, ${(null==e?void 0:e.indexOfRefraction.isConnected)?e.indexOfRefraction.associatedVariableName:Cd._DefaultIndexOfRefraction}, 1., ${(null==e?void 0:e.thickness.isConnected)?e.thickness.associatedVariableName:Cd._DefaultMaximumThickness}),\n                NdotV,\n                specularEnvironmentR0,\n                #ifdef CLEARCOAT\n                    NdotVUnclamped,\n                #endif\n                iridescenceOut\n            );\n\n            float iridescenceIntensity = iridescenceOut.iridescenceIntensity;\n            specularEnvironmentR0 = iridescenceOut.specularEnvironmentR0;\n        #endif\n`,t}_buildBlock(e){return e.target===qs.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this)),this}serialize(){return super.serialize()}_deserialize(e,t,i){super._deserialize(e,t,i)}}m("BABYLON.IridescenceBlock",af);class lf extends $r{constructor(e){super(e,qs.Fragment),this.linkRefractionWithTransparency=!1,this.invertRefractionY=!1,this.useThicknessAsDepth=!1,this._isUnique=!0,this.registerInput("intensity",$s.Float,!1,qs.Fragment),this.registerInput("tintAtDistance",$s.Float,!0,qs.Fragment),this.registerInput("volumeIndexOfRefraction",$s.Float,!0,qs.Fragment),this.registerOutput("refraction",$s.Object,qs.Fragment,new V_("refraction",this,Zs.Output,lf,"RefractionBlock"))}initialize(e){e._excludeVariableName("vRefractionPosition"),e._excludeVariableName("vRefractionSize")}getClassName(){return"RefractionBlock"}get intensity(){return this._inputs[0]}get tintAtDistance(){return this._inputs[1]}get volumeIndexOfRefraction(){return this._inputs[2]}get view(){return this.viewConnectionPoint}get refraction(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}autoConfigure(e,t=()=>!0){if(!this.intensity.isConnected){const e=new rn("Refraction intensity",qs.Fragment,$s.Float);e.value=1,e.output.connectTo(this.intensity)}if(this.view&&!this.view.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===tr.View&&t(e)));i||(i=new rn("view"),i.setAsSystemValue(tr.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const s=this._getTexture(),r=s&&s.getTextureMatrix;i.setValue("SS_REFRACTION",r,!0),r&&(i.setValue(this._define3DName,s.isCube,!0),i.setValue(this._defineLODRefractionAlpha,s.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularRefraction,s.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem&&s.isCube?!s.invertZ:s.invertZ,!0),i.setValue("SS_LINKREFRACTIONTOTRANSPARENCY",this.linkRefractionWithTransparency,!0),i.setValue("SS_GAMMAREFRACTION",s.gammaSpace,!0),i.setValue("SS_RGBDREFRACTION",s.isRGBD,!0),i.setValue("SS_USE_LOCAL_REFRACTIONMAP_CUBIC",!!s.boundingBoxSize,!0),i.setValue("SS_USE_THICKNESS_AS_DEPTH",this.useThicknessAsDepth,!0))}isReady(){const e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i){var s,r,n,o;super.bind(e,t,i);const a=this._getTexture();if(!a)return;a.isCube?e.setTexture(this._cubeSamplerName,a):e.setTexture(this._2DSamplerName,a),e.setMatrix(this._refractionMatrixName,a.getRefractionTextureMatrix());let h=1;a.isCube||a.depth&&(h=a.depth);const c=null!==(o=null!==(r=null===(s=this.volumeIndexOfRefraction.connectInputBlock)||void 0===s?void 0:s.value)&&void 0!==r?r:null===(n=this.indexOfRefractionConnectionPoint.connectInputBlock)||void 0===n?void 0:n.value)&&void 0!==o?o:1.5;e.setFloat4(this._vRefractionInfosName,a.level,1/c,h,this.invertRefractionY?-1:1),e.setFloat4(this._vRefractionMicrosurfaceInfosName,a.getSize().width,a.lodGenerationScale,a.lodGenerationOffset,1/c);const u=a.getSize().width;if(e.setFloat2(this._vRefractionFilteringInfoName,u,l.Log2(u)),a.boundingBoxSize){const t=a;e.setVector3("vRefractionPosition",t.boundingBoxPosition),e.setVector3("vRefractionSize",t.boundingBoxSize)}}getCode(e){return e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),this._define3DName=e._getFreeDefineName("SS_REFRACTIONMAP_3D"),e._samplerDeclaration+=`#ifdef ${this._define3DName}\n`,e._samplerDeclaration+=`uniform samplerCube ${this._cubeSamplerName};\n`,e._samplerDeclaration+="#else\n",e._samplerDeclaration+=`uniform sampler2D ${this._2DSamplerName};\n`,e._samplerDeclaration+="#endif\n",e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._defineLODRefractionAlpha=e._getFreeDefineName("SS_LODINREFRACTIONALPHA"),this._defineLinearSpecularRefraction=e._getFreeDefineName("SS_LINEARSPECULARREFRACTION"),this._defineOppositeZ=e._getFreeDefineName("SS_REFRACTIONMAP_OPPOSITEZ"),this._refractionMatrixName=e._getFreeVariableName("refractionMatrix"),e._emitUniformFromString(this._refractionMatrixName,"mat4"),e._emitFunction("sampleRefraction",`\n            #ifdef ${this._define3DName}\n                #define sampleRefraction(s, c) textureCube(s, c)\n            #else\n                #define sampleRefraction(s, c) texture2D(s, c)\n            #endif\n`,`//${this.name}`),e._emitFunction("sampleRefractionLod",`\n            #ifdef ${this._define3DName}\n                #define sampleRefractionLod(s, c, l) textureCubeLodEXT(s, c, l)\n            #else\n                #define sampleRefractionLod(s, c, l) texture2DLodEXT(s, c, l)\n            #endif\n`,`//${this.name}`),this._vRefractionMicrosurfaceInfosName=e._getFreeVariableName("vRefractionMicrosurfaceInfos"),e._emitUniformFromString(this._vRefractionMicrosurfaceInfosName,"vec4"),this._vRefractionInfosName=e._getFreeVariableName("vRefractionInfos"),e._emitUniformFromString(this._vRefractionInfosName,"vec4"),this._vRefractionFilteringInfoName=e._getFreeVariableName("vRefractionFilteringInfo"),e._emitUniformFromString(this._vRefractionFilteringInfoName,"vec2"),e._emitUniformFromString("vRefractionPosition","vec3"),e._emitUniformFromString("vRefractionSize","vec3"),""}_buildBlock(e){return this._scene=e.sharedData.scene,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e=this.texture.isCube?`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}");\n`:`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}");\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`),e+=`${this._codeVariableName}.linkRefractionWithTransparency = ${this.linkRefractionWithTransparency};\n`,e+=`${this._codeVariableName}.invertRefractionY = ${this.invertRefractionY};\n`,e+=`${this._codeVariableName}.useThicknessAsDepth = ${this.useThicknessAsDepth};\n`,e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.linkRefractionWithTransparency=this.linkRefractionWithTransparency,e.invertRefractionY=this.invertRefractionY,e.useThicknessAsDepth=this.useThicknessAsDepth,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,e.texture.isCube?this.texture=ud.Parse(e.texture,t,i):this.texture=Ar.Parse(e.texture,t,i)),this.linkRefractionWithTransparency=e.linkRefractionWithTransparency,this.invertRefractionY=e.invertRefractionY,this.useThicknessAsDepth=!!e.useThicknessAsDepth}}me([Zr("Link refraction to transparency",Js.Boolean,"ADVANCED",{notifiers:{update:!0}})],lf.prototype,"linkRefractionWithTransparency",void 0),me([Zr("Invert refraction Y",Js.Boolean,"ADVANCED",{notifiers:{update:!0}})],lf.prototype,"invertRefractionY",void 0),me([Zr("Use thickness as depth",Js.Boolean,"ADVANCED",{notifiers:{update:!0}})],lf.prototype,"useThicknessAsDepth",void 0),m("BABYLON.RefractionBlock",lf);class hf extends $r{constructor(e){super(e,qs.Fragment),this._isUnique=!0,this.registerInput("thickness",$s.Float,!1,qs.Fragment),this.registerInput("tintColor",$s.Color3,!0,qs.Fragment),this.registerInput("translucencyIntensity",$s.Float,!0,qs.Fragment),this.registerInput("translucencyDiffusionDist",$s.Color3,!0,qs.Fragment),this.registerInput("refraction",$s.Object,!0,qs.Fragment,new V_("refraction",this,Zs.Input,lf,"RefractionBlock")),this.registerInput("dispersion",$s.Float,!0,qs.Fragment),this.registerOutput("subsurface",$s.Object,qs.Fragment,new V_("subsurface",this,Zs.Output,hf,"SubSurfaceBlock"))}initialize(e){e._excludeVariableName("subSurfaceOut"),e._excludeVariableName("vThicknessParam"),e._excludeVariableName("vTintColor"),e._excludeVariableName("vSubSurfaceIntensity"),e._excludeVariableName("dispersion")}getClassName(){return"SubSurfaceBlock"}get thickness(){return this._inputs[0]}get tintColor(){return this._inputs[1]}get translucencyIntensity(){return this._inputs[2]}get translucencyDiffusionDist(){return this._inputs[3]}get refraction(){return this._inputs[4]}get dispersion(){return this._inputs[5]}get subsurface(){return this._outputs[0]}autoConfigure(){if(!this.thickness.isConnected){const e=new rn("SubSurface thickness",qs.Fragment,$s.Float);e.value=0,e.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const s=this.translucencyDiffusionDist.isConnected||this.translucencyIntensity.isConnected;i.setValue("SUBSURFACE",s||this.refraction.isConnected,!0),i.setValue("SS_TRANSLUCENCY",s,!0),i.setValue("SS_THICKNESSANDMASK_TEXTURE",!1,!0),i.setValue("SS_REFRACTIONINTENSITY_TEXTURE",!1,!0),i.setValue("SS_TRANSLUCENCYINTENSITY_TEXTURE",!1,!0),i.setValue("SS_MASK_FROM_THICKNESS_TEXTURE",!1,!0),i.setValue("SS_USE_GLTF_TEXTURES",!1,!0),i.setValue("SS_DISPERSION",this.dispersion.isConnected,!0)}static GetCode(e,t,i,s){var r,n,o,a,l,h,c,u,d,p,_,f,m,g,v,x;let T="";const E=(null==t?void 0:t.thickness.isConnected)?t.thickness.associatedVariableName:"0.",S=(null==t?void 0:t.tintColor.isConnected)?t.tintColor.associatedVariableName:"vec3(1.)",b=(null==t?void 0:t.translucencyIntensity.isConnected)?null==t?void 0:t.translucencyIntensity.associatedVariableName:"1.",C=(null==t?void 0:t.translucencyDiffusionDist.isConnected)?null==t?void 0:t.translucencyDiffusionDist.associatedVariableName:"vec3(1.)",y=(null==t?void 0:t.refraction.isConnected)?null===(r=null==t?void 0:t.refraction.connectedPoint)||void 0===r?void 0:r.ownerBlock:null,A=(null==y?void 0:y.tintAtDistance.isConnected)?y.tintAtDistance.associatedVariableName:"1.",R=(null==y?void 0:y.intensity.isConnected)?y.intensity.associatedVariableName:"1.",I=(null==y?void 0:y.view.isConnected)?y.view.associatedVariableName:"",P=(null==t?void 0:t.dispersion.isConnected)?null==t?void 0:t.dispersion.associatedVariableName:"0.0";return T+=null!==(n=null==y?void 0:y.getCode(e))&&void 0!==n?n:"",T+=`subSurfaceOutParams subSurfaceOut;\n\n        #ifdef SUBSURFACE\n            vec2 vThicknessParam = vec2(0., ${E});\n            vec4 vTintColor = vec4(${S}, ${A});\n            vec3 vSubSurfaceIntensity = vec3(${R}, ${b}, 0.);\n            float dispersion = ${P};\n            subSurfaceBlock(\n                vSubSurfaceIntensity,\n                vThicknessParam,\n                vTintColor,\n                normalW,\n                specularEnvironmentReflectance,\n            #ifdef SS_THICKNESSANDMASK_TEXTURE\n                vec4(0.),\n            #endif\n            #ifdef REFLECTION\n                #ifdef SS_TRANSLUCENCY\n                    ${null==i?void 0:i._reflectionMatrixName},\n                    #ifdef USESPHERICALFROMREFLECTIONMAP\n                        #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n                            reflectionOut.irradianceVector,\n                        #endif\n                        #if defined(REALTIME_FILTERING)\n                            ${null==i?void 0:i._cubeSamplerName},\n                            ${null==i?void 0:i._vReflectionFilteringInfoName},\n                        #endif\n                        #endif\n                    #ifdef USEIRRADIANCEMAP\n                        irradianceSampler,\n                    #endif\n                #endif\n            #endif\n            #if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\n                surfaceAlbedo,\n            #endif\n            #ifdef SS_REFRACTION\n                ${s}.xyz,\n                viewDirectionW,\n                ${I},\n                ${null!==(o=null==y?void 0:y._vRefractionInfosName)&&void 0!==o?o:""},\n                ${null!==(a=null==y?void 0:y._refractionMatrixName)&&void 0!==a?a:""},\n                ${null!==(l=null==y?void 0:y._vRefractionMicrosurfaceInfosName)&&void 0!==l?l:""},\n                vLightingIntensity,\n                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n                    alpha,\n                #endif\n                #ifdef ${null!==(h=null==y?void 0:y._defineLODRefractionAlpha)&&void 0!==h?h:"IGNORE"}\n                    NdotVUnclamped,\n                #endif\n                #ifdef ${null!==(c=null==y?void 0:y._defineLinearSpecularRefraction)&&void 0!==c?c:"IGNORE"}\n                    roughness,\n                #endif\n                alphaG,\n                #ifdef ${null!==(u=null==y?void 0:y._define3DName)&&void 0!==u?u:"IGNORE"}\n                    ${null!==(d=null==y?void 0:y._cubeSamplerName)&&void 0!==d?d:""},\n                #else\n                    ${null!==(p=null==y?void 0:y._2DSamplerName)&&void 0!==p?p:""},\n                #endif\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${null!==(_=null==y?void 0:y._define3DName)&&void 0!==_?_:"IGNORE"}\n                        ${null!==(f=null==y?void 0:y._cubeSamplerName)&&void 0!==f?f:""},\n                        ${null!==(m=null==y?void 0:y._cubeSamplerName)&&void 0!==m?m:""},\n                    #else\n                        ${null!==(g=null==y?void 0:y._2DSamplerName)&&void 0!==g?g:""},\n                        ${null!==(v=null==y?void 0:y._2DSamplerName)&&void 0!==v?v:""},\n                    #endif\n                #endif\n                #ifdef ANISOTROPIC\n                    anisotropicOut,\n                #endif\n                #ifdef REALTIME_FILTERING\n                    ${null!==(x=null==y?void 0:y._vRefractionFilteringInfoName)&&void 0!==x?x:""},\n                #endif\n                #ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n                    vRefractionPosition,\n                    vRefractionSize,\n                #endif\n                #ifdef SS_DISPERSION\n                    dispersion,\n                #endif\n            #endif\n            #ifdef SS_TRANSLUCENCY\n                ${C},\n            #endif\n                subSurfaceOut\n            );\n\n            #ifdef SS_REFRACTION\n                surfaceAlbedo = subSurfaceOut.surfaceAlbedo;\n                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n                    alpha = subSurfaceOut.alpha;\n                #endif\n            #endif\n        #else\n            subSurfaceOut.specularEnvironmentReflectance = specularEnvironmentReflectance;\n        #endif\n`,T}_buildBlock(e){return e.target===qs.Fragment&&e.sharedData.blocksWithDefines.push(this),this}}m("BABYLON.SubSurfaceBlock",hf);const cf={ambientClr:["finalAmbient",""],diffuseDir:["finalDiffuse",""],specularDir:["finalSpecularScaled","!defined(UNLIT) && defined(SPECULARTERM)"],clearcoatDir:["finalClearCoatScaled","!defined(UNLIT) && defined(CLEARCOAT)"],sheenDir:["finalSheenScaled","!defined(UNLIT) && defined(SHEEN)"],diffuseInd:["finalIrradiance","!defined(UNLIT) && defined(REFLECTION)"],specularInd:["finalRadianceScaled","!defined(UNLIT) && defined(REFLECTION)"],clearcoatInd:["clearcoatOut.finalClearCoatRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(CLEARCOAT)"],sheenInd:["sheenOut.finalSheenRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(SHEEN) && defined(ENVIRONMENTBRDF)"],refraction:["subSurfaceOut.finalRefraction","!defined(UNLIT) && defined(SS_REFRACTION)"],lighting:["finalColor.rgb",""],shadow:["aggShadow",""],alpha:["alpha",""]};class uf extends $r{static _OnGenerateOnlyFragmentCodeChanged(e,t){const i=e;return i.worldPosition.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,console.error("The worldPosition input must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?qs.Fragment:qs.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?qs.Fragment:qs.Vertex}constructor(e){super(e,qs.VertexAndFragment),this._environmentBRDFTexture=null,this._metallicReflectanceColor=N.White(),this._metallicF0Factor=1,this.directIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.lightFalloff=0,this.useAlphaTest=!1,this.alphaTestCutoff=.5,this.useAlphaBlending=!1,this.useRadianceOverAlpha=!0,this.useSpecularOverAlpha=!0,this.enableSpecularAntiAliasing=!1,this.realTimeFiltering=!1,this.realTimeFilteringQuality=8,this.useEnergyConservation=!0,this.useRadianceOcclusion=!0,this.useHorizonOcclusion=!0,this.unlit=!1,this.forceNormalForward=!1,this.generateOnlyFragmentCode=!1,this.debugMode=0,this.debugLimit=0,this.debugFactor=1,this._isUnique=!0,this.registerInput("worldPosition",$s.Vector4,!1,qs.Vertex),this.registerInput("worldNormal",$s.Vector4,!1,qs.Fragment),this.registerInput("view",$s.Matrix,!1),this.registerInput("cameraPosition",$s.Vector3,!1,qs.Fragment),this.registerInput("perturbedNormal",$s.Vector4,!0,qs.Fragment),this.registerInput("baseColor",$s.Color3,!0,qs.Fragment),this.registerInput("metallic",$s.Float,!1,qs.Fragment),this.registerInput("roughness",$s.Float,!1,qs.Fragment),this.registerInput("ambientOcc",$s.Float,!0,qs.Fragment),this.registerInput("opacity",$s.Float,!0,qs.Fragment),this.registerInput("indexOfRefraction",$s.Float,!0,qs.Fragment),this.registerInput("ambientColor",$s.Color3,!0,qs.Fragment),this.registerInput("reflection",$s.Object,!0,qs.Fragment,new V_("reflection",this,Zs.Input,nf,"ReflectionBlock")),this.registerInput("clearcoat",$s.Object,!0,qs.Fragment,new V_("clearcoat",this,Zs.Input,of,"ClearCoatBlock")),this.registerInput("sheen",$s.Object,!0,qs.Fragment,new V_("sheen",this,Zs.Input,sf,"SheenBlock")),this.registerInput("subsurface",$s.Object,!0,qs.Fragment,new V_("subsurface",this,Zs.Input,hf,"SubSurfaceBlock")),this.registerInput("anisotropy",$s.Object,!0,qs.Fragment,new V_("anisotropy",this,Zs.Input,rf,"AnisotropyBlock")),this.registerInput("iridescence",$s.Object,!0,qs.Fragment,new V_("iridescence",this,Zs.Input,af,"IridescenceBlock")),this.registerOutput("ambientClr",$s.Color3,qs.Fragment),this.registerOutput("diffuseDir",$s.Color3,qs.Fragment),this.registerOutput("specularDir",$s.Color3,qs.Fragment),this.registerOutput("clearcoatDir",$s.Color3,qs.Fragment),this.registerOutput("sheenDir",$s.Color3,qs.Fragment),this.registerOutput("diffuseInd",$s.Color3,qs.Fragment),this.registerOutput("specularInd",$s.Color3,qs.Fragment),this.registerOutput("clearcoatInd",$s.Color3,qs.Fragment),this.registerOutput("sheenInd",$s.Color3,qs.Fragment),this.registerOutput("refraction",$s.Color3,qs.Fragment),this.registerOutput("lighting",$s.Color3,qs.Fragment),this.registerOutput("shadow",$s.Float,qs.Fragment),this.registerOutput("alpha",$s.Float,qs.Fragment)}initialize(e){e._excludeVariableName("vLightingIntensity"),e._excludeVariableName("geometricNormalW"),e._excludeVariableName("normalW"),e._excludeVariableName("faceNormal"),e._excludeVariableName("albedoOpacityOut"),e._excludeVariableName("surfaceAlbedo"),e._excludeVariableName("alpha"),e._excludeVariableName("aoOut"),e._excludeVariableName("baseColor"),e._excludeVariableName("reflectivityOut"),e._excludeVariableName("microSurface"),e._excludeVariableName("roughness"),e._excludeVariableName("NdotVUnclamped"),e._excludeVariableName("NdotV"),e._excludeVariableName("alphaG"),e._excludeVariableName("AARoughnessFactors"),e._excludeVariableName("environmentBrdf"),e._excludeVariableName("ambientMonochrome"),e._excludeVariableName("seo"),e._excludeVariableName("eho"),e._excludeVariableName("environmentRadiance"),e._excludeVariableName("irradianceVector"),e._excludeVariableName("environmentIrradiance"),e._excludeVariableName("diffuseBase"),e._excludeVariableName("specularBase"),e._excludeVariableName("preInfo"),e._excludeVariableName("info"),e._excludeVariableName("shadow"),e._excludeVariableName("finalDiffuse"),e._excludeVariableName("finalAmbient"),e._excludeVariableName("ambientOcclusionForDirectDiffuse"),e._excludeVariableName("finalColor"),e._excludeVariableName("vClipSpacePosition"),e._excludeVariableName("vDebugMode")}getClassName(){return"PBRMetallicRoughnessBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get view(){return this._inputs[2]}get cameraPosition(){return this._inputs[3]}get perturbedNormal(){return this._inputs[4]}get baseColor(){return this._inputs[5]}get metallic(){return this._inputs[6]}get roughness(){return this._inputs[7]}get ambientOcc(){return this._inputs[8]}get opacity(){return this._inputs[9]}get indexOfRefraction(){return this._inputs[10]}get ambientColor(){return this._inputs[11]}get reflection(){return this._inputs[12]}get clearcoat(){return this._inputs[13]}get sheen(){return this._inputs[14]}get subsurface(){return this._inputs[15]}get anisotropy(){return this._inputs[16]}get iridescence(){return this._inputs[17]}get ambientClr(){return this._outputs[0]}get diffuseDir(){return this._outputs[1]}get specularDir(){return this._outputs[2]}get clearcoatDir(){return this._outputs[3]}get sheenDir(){return this._outputs[4]}get diffuseInd(){return this._outputs[5]}get specularInd(){return this._outputs[6]}get clearcoatInd(){return this._outputs[7]}get sheenInd(){return this._outputs[8]}get refraction(){return this._outputs[9]}get lighting(){return this._outputs[10]}get shadow(){return this._outputs[11]}get alpha(){return this._outputs[12]}autoConfigure(e,t=()=>!0){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===tr.CameraPosition&&t(e)));i||(i=new rn("cameraPosition"),i.setAsSystemValue(tr.CameraPosition)),i.output.connectTo(this.cameraPosition)}if(!this.view.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===tr.View&&t(e)));i||(i=new rn("view"),i.setAsSystemValue(tr.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){i.setValue("PBR",!0),i.setValue("METALLICWORKFLOW",!0),i.setValue("DEBUGMODE",this.debugMode,!0),i.setValue("DEBUGMODE_FORCERETURN",!0),i.setValue("NORMALXYSCALE",!0),i.setValue("BUMP",this.perturbedNormal.isConnected,!0),i.setValue("LODBASEDMICROSFURACE",this._scene.getEngine().getCaps().textureLOD),i.setValue("ALBEDO",!1,!0),i.setValue("OPACITY",this.opacity.isConnected,!0),i.setValue("AMBIENT",!0,!0),i.setValue("AMBIENTINGRAYSCALE",!1,!0),i.setValue("REFLECTIVITY",!1,!0),i.setValue("AOSTOREINMETALMAPRED",!1,!0),i.setValue("METALLNESSSTOREINMETALMAPBLUE",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPALPHA",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPGREEN",!1,!0),this.lightFalloff===Nd.LIGHTFALLOFF_STANDARD?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!1)):this.lightFalloff===Nd.LIGHTFALLOFF_GLTF?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!0)):(i.setValue("USEPHYSICALLIGHTFALLOFF",!0),i.setValue("USEGLTFLIGHTFALLOFF",!1));const s=this.alphaTestCutoff.toString();i.setValue("ALPHABLEND",this.useAlphaBlending,!0),i.setValue("ALPHAFROMALBEDO",!1,!0),i.setValue("ALPHATEST",this.useAlphaTest,!0),i.setValue("ALPHATESTVALUE",s.indexOf(".")<0?s+".":s,!0),i.setValue("OPACITYRGB",!1,!0),i.setValue("RADIANCEOVERALPHA",this.useRadianceOverAlpha,!0),i.setValue("SPECULAROVERALPHA",this.useSpecularOverAlpha,!0),i.setValue("SPECULARAA",this._scene.getEngine().getCaps().standardDerivatives&&this.enableSpecularAntiAliasing,!0),i.setValue("REALTIME_FILTERING",this.realTimeFiltering,!0);const r=e.getScene();if(r.getEngine()._features.needTypeSuffixInShaderConstants?i.setValue("NUM_SAMPLES",this.realTimeFilteringQuality+"u",!0):i.setValue("NUM_SAMPLES",""+this.realTimeFilteringQuality,!0),i.setValue("BRDF_V_HEIGHT_CORRELATED",!0),i.setValue("MS_BRDF_ENERGY_CONSERVATION",this.useEnergyConservation,!0),i.setValue("RADIANCEOCCLUSION",this.useRadianceOcclusion,!0),i.setValue("HORIZONOCCLUSION",this.useHorizonOcclusion,!0),i.setValue("UNLIT",this.unlit,!0),i.setValue("FORCENORMALFORWARD",this.forceNormalForward,!0),this._environmentBRDFTexture&&Ia.ReflectionTextureEnabled?(i.setValue("ENVIRONMENTBRDF",!0),i.setValue("ENVIRONMENTBRDF_RGBD",this._environmentBRDFTexture.isRGBD,!0)):(i.setValue("ENVIRONMENTBRDF",!1),i.setValue("ENVIRONMENTBRDF_RGBD",!1)),i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i),i._areLightsDirty)if(this.light){const t={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};Hs.PrepareDefinesForLight(r,e,this.light,this._lightId,i,!0,t),t.needRebuild&&i.rebuild()}else Hs.PrepareDefinesForLights(r,e,i,!0,t.maxSimultaneousLights),i._needNormals=!0,Hs.PrepareDefinesForMultiview(r,i)}updateUniformsAndSamples(e,t,i,s){for(let r=0;r<t.maxSimultaneousLights&&i["LIGHT"+r];r++){const t=e.uniforms.indexOf("vLightData"+r)>=0;Hs.PrepareUniformsAndSamplersForLight(r,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+r],s,t)}}isReady(e,t,i){return!(this._environmentBRDFTexture&&!this._environmentBRDFTexture.isReady()||i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}bind(e,t,i){var s,r;if(!i)return;const n=i.getScene();this.light?Hs.BindLight(this.light,this._lightId,n,e,!0):Hs.BindLights(n,i,e,!0,t.maxSimultaneousLights),e.setTexture(this._environmentBrdfSamplerName,this._environmentBRDFTexture),e.setFloat2("vDebugMode",this.debugLimit,this.debugFactor);const o=this._scene.ambientColor;o&&e.setColor3("ambientFromScene",o);const a=n.useRightHandedSystem===(null!=n._mirroredCameraPosition);e.setFloat(this._invertNormalName,a?-1:1),e.setFloat4("vLightingIntensity",this.directIntensity,1,this.environmentIntensity*this._scene.environmentIntensity,this.specularIntensity);const l=null!==(r=null===(s=this.indexOfRefraction.connectInputBlock)||void 0===s?void 0:s.value)&&void 0!==r?r:1.5,h=Math.pow((l-1)/(l+1),2);this._metallicReflectanceColor.scaleToRef(h*this._metallicF0Factor,w.Color3[0]);const c=this._metallicF0Factor;e.setColor4(this._vMetallicReflectanceFactorsName,w.Color3[0],c),t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_injectVertexCode(e){var t,i;const s=this.worldPosition,r=`//${this.name}`;this.light?(this._lightId=(void 0!==e.counters.lightCounter?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",r,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const n="v_"+s.associatedVariableName;e._emitVaryingFromString(n,"vec4")&&(e.compilationString+=`${n} = ${s.associatedVariableName};\n`);const o=this.reflection.isConnected?null===(t=this.reflection.connectedPoint)||void 0===t?void 0:t.ownerBlock:null;o&&(o.viewConnectionPoint=this.view),e.compilationString+=null!==(i=null==o?void 0:o.handleVertexSide(e))&&void 0!==i?i:"",e._emitVaryingFromString("vClipSpacePosition","vec4","defined(IGNORE) || DEBUGMODE > 0")&&(e._injectAtEnd+="#if DEBUGMODE > 0\n",e._injectAtEnd+="vClipSpacePosition = gl_Position;\n",e._injectAtEnd+="#endif\n"),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:s.associatedVariableName}]}):(e.compilationString+=`vec4 worldPos = ${s.associatedVariableName};\n`,this.view.isConnected&&(e.compilationString+=`mat4 view = ${this.view.associatedVariableName};\n`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{repeatKey:"maxSimultaneousLights"}))}_getAlbedoOpacityCode(){let e="albedoOpacityOutParams albedoOpacityOut;\n";return e+=`albedoOpacityBlock(\n                vec4(${this.baseColor.isConnected?this.baseColor.associatedVariableName:"vec3(1.)"}, 1.),\n            #ifdef ALBEDO\n                vec4(1.),\n                vec2(1., 1.),\n            #endif\n            #ifdef OPACITY\n                vec4(${this.opacity.isConnected?this.opacity.associatedVariableName:"1."}),\n                vec2(1., 1.),\n            #endif\n                albedoOpacityOut\n            );\n\n            vec3 surfaceAlbedo = albedoOpacityOut.surfaceAlbedo;\n            float alpha = albedoOpacityOut.alpha;\n`,e}_getAmbientOcclusionCode(){let e="ambientOcclusionOutParams aoOut;\n";return e+=`ambientOcclusionBlock(\n            #ifdef AMBIENT\n                vec3(${this.ambientOcc.isConnected?this.ambientOcc.associatedVariableName:"1."}),\n                vec4(0., 1.0, 1.0, 0.),\n            #endif\n                aoOut\n            );\n`,e}_getReflectivityCode(e){let t="reflectivityOutParams reflectivityOut;\n";return this._vMetallicReflectanceFactorsName=e._getFreeVariableName("vMetallicReflectanceFactors"),e._emitUniformFromString(this._vMetallicReflectanceFactorsName,"vec4"),t+=`vec3 baseColor = surfaceAlbedo;\n\n            reflectivityBlock(\n                vec4(${this.metallic.associatedVariableName}, ${this.roughness.associatedVariableName}, 0., 0.),\n            #ifdef METALLICWORKFLOW\n                surfaceAlbedo,\n                ${this._vMetallicReflectanceFactorsName},\n            #endif\n            #ifdef REFLECTIVITY\n                vec3(0., 0., 1.),\n                vec4(1.),\n            #endif\n            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY)  && defined(AOSTOREINMETALMAPRED)\n                aoOut.ambientOcclusionColor,\n            #endif\n            #ifdef MICROSURFACEMAP\n                microSurfaceTexel, <== not handled!\n            #endif\n                reflectivityOut\n            );\n\n            float microSurface = reflectivityOut.microSurface;\n            float roughness = reflectivityOut.roughness;\n\n            #ifdef METALLICWORKFLOW\n                surfaceAlbedo = reflectivityOut.surfaceAlbedo;\n            #endif\n            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\n                aoOut.ambientOcclusionColor = reflectivityOut.ambientOcclusionColor;\n            #endif\n`,t}_buildBlock(e){var t,i,s,r,n,o,a,l,h,c,u,d,p,_,f,m,g,v,x,T,E,S,b,C,y,A,R,I,P,M,O,D,N,F,w,L,B,U,V,k,G;super._buildBlock(e),this._scene=e.sharedData.scene,this._environmentBRDFTexture||(this._environmentBRDFTexture=vd(this._scene));const z=this.reflection.isConnected?null===(t=this.reflection.connectedPoint)||void 0===t?void 0:t.ownerBlock:null;if(z&&(z.worldPositionConnectionPoint=this.worldPosition,z.cameraPositionConnectionPoint=this.cameraPosition,z.worldNormalConnectionPoint=this.worldNormal,z.viewConnectionPoint=this.view),e.target!==qs.Fragment)return this._injectVertexCode(e),this;e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this);const W=`//${this.name}`,H=this.perturbedNormal;let X=this.worldPosition.associatedVariableName;this.generateOnlyFragmentCode?(X=e._getFreeVariableName("globalWorldPos"),e._emitFunction("pbr_globalworldpos",`vec3 ${X};\n`,W),e.compilationString+=`${X} = ${this.worldPosition.associatedVariableName}.xyz;\n`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",W,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${this.worldPosition.associatedVariableName}`:void 0}),e.compilationString+="#if DEBUGMODE > 0\n",e.compilationString+="vec4 vClipSpacePosition = vec4((vec2(gl_FragCoord.xy) / vec2(1.0)) * 2.0 - 1.0, 0.0, 1.0);\n",e.compilationString+="#endif\n"):X="v_"+X,this._environmentBrdfSamplerName=e._getFreeVariableName("environmentBrdfSampler"),e._emit2DSampler(this._environmentBrdfSamplerName),e.sharedData.hints.needAlphaBlending=e.sharedData.hints.needAlphaBlending||this.useAlphaBlending,e.sharedData.hints.needAlphaTesting=e.sharedData.hints.needAlphaTesting||this.useAlphaTest,e._emitExtension("lod","#extension GL_EXT_shader_texture_lod : enable","defined(LODBASEDMICROSFURACE)"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitUniformFromString("vDebugMode","vec2","defined(IGNORE) || DEBUGMODE > 0"),e._emitUniformFromString("ambientFromScene","vec3"),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity"),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",W,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",W,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0}),e._emitFunctionFromInclude("helperFunctions",W),e._emitFunctionFromInclude("importanceSampling",W),e._emitFunctionFromInclude("pbrHelperFunctions",W),e._emitFunctionFromInclude("imageProcessingDeclaration",W),e._emitFunctionFromInclude("imageProcessingFunctions",W),e._emitFunctionFromInclude("shadowsFragmentFunctions",W),e._emitFunctionFromInclude("pbrDirectLightingSetupFunctions",W,{replaceStrings:[{search:/vPositionW/g,replace:X+".xyz"}]}),e._emitFunctionFromInclude("pbrDirectLightingFalloffFunctions",W),e._emitFunctionFromInclude("pbrBRDFFunctions",W,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(i=null==z?void 0:z._defineSkyboxName)&&void 0!==i?i:"REFLECTIONMAP_SKYBOX"}]}),e._emitFunctionFromInclude("hdrFilteringFunctions",W),e._emitFunctionFromInclude("pbrDirectLightingFunctions",W,{replaceStrings:[{search:/vPositionW/g,replace:X+".xyz"}]}),e._emitFunctionFromInclude("pbrIBLFunctions",W),e._emitFunctionFromInclude("pbrBlockAlbedoOpacity",W),e._emitFunctionFromInclude("pbrBlockReflectivity",W),e._emitFunctionFromInclude("pbrBlockAmbientOcclusion",W),e._emitFunctionFromInclude("pbrBlockAlphaFresnel",W),e._emitFunctionFromInclude("pbrBlockAnisotropic",W),e._emitUniformFromString("vLightingIntensity","vec4"),(null==z?void 0:z.generateOnlyFragmentCode)&&(e.compilationString+=z.handleVertexSide(e)),this._vNormalWName=e._getFreeVariableName("vNormalW"),e.compilationString+=`vec4 ${this._vNormalWName} = normalize(${this.worldNormal.associatedVariableName});\n`,e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`vec3 viewDirectionW = normalize(${this.cameraPosition.associatedVariableName} - ${X}.xyz);\n`),e.compilationString+=`vec3 geometricNormalW = ${this._vNormalWName}.xyz;\n`,e.compilationString+=`vec3 normalW = ${H.isConnected?"normalize("+H.associatedVariableName+".xyz)":"geometricNormalW"};\n`,this._invertNormalName=e._getFreeVariableName("invertNormal"),e._emitUniformFromString(this._invertNormalName,"float"),e.compilationString+=e._emitCodeFromInclude("pbrBlockNormalFinal",W,{replaceStrings:[{search:/vPositionW/g,replace:X+".xyz"},{search:/vEyePosition.w/g,replace:this._invertNormalName}]}),e.compilationString+=this._getAlbedoOpacityCode(),e.compilationString+=e._emitCodeFromInclude("depthPrePass",W),e.compilationString+=this._getAmbientOcclusionCode(),e.compilationString+=e._emitCodeFromInclude("pbrBlockLightmapInit",W),e.compilationString+="#ifdef UNLIT\n                vec3 diffuseBase = vec3(1., 1., 1.);\n            #else\n",e.compilationString+=this._getReflectivityCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockGeometryInfo",W,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(s=null==z?void 0:z._defineSkyboxName)&&void 0!==s?s:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:null!==(r=null==z?void 0:z._define3DName)&&void 0!==r?r:"REFLECTIONMAP_3D"}]});const Y=this.anisotropy.isConnected?null===(n=this.anisotropy.connectedPoint)||void 0===n?void 0:n.ownerBlock:null;Y&&(Y.worldPositionConnectionPoint=this.worldPosition,Y.worldNormalConnectionPoint=this.worldNormal,e.compilationString+=Y.getCode(e,!this.perturbedNormal.isConnected)),z&&z.hasTexture&&(e.compilationString+=z.getCode(e,Y?"anisotropicOut.anisotropicNormal":"normalW")),e._emitFunctionFromInclude("pbrBlockReflection",W,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:null!==(o=null==z?void 0:z._define3DName)&&void 0!==o?o:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:null!==(a=null==z?void 0:z._defineOppositeZ)&&void 0!==a?a:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:null!==(l=null==z?void 0:z._defineProjectionName)&&void 0!==l?l:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(h=null==z?void 0:z._defineSkyboxName)&&void 0!==h?h:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:null!==(c=null==z?void 0:z._defineLODReflectionAlpha)&&void 0!==c?c:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:null!==(u=null==z?void 0:z._defineLinearSpecularReflection)&&void 0!==u?u:"LINEARSPECULARREFLECTION"},{search:/vReflectionFilteringInfo/g,replace:null!==(d=null==z?void 0:z._vReflectionFilteringInfoName)&&void 0!==d?d:"vReflectionFilteringInfo"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance0",W,{replaceStrings:[{search:/metallicReflectanceFactors/g,replace:this._vMetallicReflectanceFactorsName}]});const j=this.sheen.isConnected?null===(p=this.sheen.connectedPoint)||void 0===p?void 0:p.ownerBlock:null;j&&(e.compilationString+=j.getCode(z)),e._emitFunctionFromInclude("pbrBlockSheen",W,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:null!==(_=null==z?void 0:z._define3DName)&&void 0!==_?_:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(f=null==z?void 0:z._defineSkyboxName)&&void 0!==f?f:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:null!==(m=null==z?void 0:z._defineLODReflectionAlpha)&&void 0!==m?m:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:null!==(g=null==z?void 0:z._defineLinearSpecularReflection)&&void 0!==g?g:"LINEARSPECULARREFLECTION"}]});const K=this.iridescence.isConnected?null===(v=this.iridescence.connectedPoint)||void 0===v?void 0:v.ownerBlock:null;e.compilationString+=af.GetCode(K),e._emitFunctionFromInclude("pbrBlockIridescence",W,{replaceStrings:[]});const $=this.clearcoat.isConnected?null===(x=this.clearcoat.connectedPoint)||void 0===x?void 0:x.ownerBlock:null,q=!this.perturbedNormal.isConnected&&!this.anisotropy.isConnected,Q=this.perturbedNormal.isConnected&&(null===(E=(null===(T=this.perturbedNormal.connectedPoint)||void 0===T?void 0:T.ownerBlock).worldTangent)||void 0===E?void 0:E.isConnected),Z=this.anisotropy.isConnected&&(null===(S=this.anisotropy.connectedPoint)||void 0===S?void 0:S.ownerBlock).worldTangent.isConnected;let J=Q||!this.perturbedNormal.isConnected&&Z;e.compilationString+=of.GetCode(e,$,z,X,q,J,this.worldNormal.associatedVariableName),q&&(J=null!==(b=null==$?void 0:$.worldTangent.isConnected)&&void 0!==b&&b),e._emitFunctionFromInclude("pbrBlockClearcoat",W,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:null!==(C=null==z?void 0:z._define3DName)&&void 0!==C?C:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:null!==(y=null==z?void 0:z._defineOppositeZ)&&void 0!==y?y:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:null!==(A=null==z?void 0:z._defineProjectionName)&&void 0!==A?A:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(R=null==z?void 0:z._defineSkyboxName)&&void 0!==R?R:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:null!==(I=null==z?void 0:z._defineLODReflectionAlpha)&&void 0!==I?I:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:null!==(P=null==z?void 0:z._defineLinearSpecularReflection)&&void 0!==P?P:"LINEARSPECULARREFLECTION"},{search:/defined\(TANGENT\)/g,replace:J?"defined(TANGENT)":"defined(IGNORE)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance",W,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(M=null==z?void 0:z._defineSkyboxName)&&void 0!==M?M:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:null!==(O=null==z?void 0:z._define3DName)&&void 0!==O?O:"REFLECTIONMAP_3D"}]});const ee=this.subsurface.isConnected?null===(D=this.subsurface.connectedPoint)||void 0===D?void 0:D.ownerBlock:null,te=this.subsurface.isConnected?null===(F=(null===(N=this.subsurface.connectedPoint)||void 0===N?void 0:N.ownerBlock).refraction.connectedPoint)||void 0===F?void 0:F.ownerBlock:null;te&&(te.viewConnectionPoint=this.view,te.indexOfRefractionConnectionPoint=this.indexOfRefraction),e.compilationString+=hf.GetCode(e,ee,z,X),e._emitFunctionFromInclude("pbrBlockSubSurface",W,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:null!==(w=null==z?void 0:z._define3DName)&&void 0!==w?w:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:null!==(L=null==z?void 0:z._defineOppositeZ)&&void 0!==L?L:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:null!==(B=null==z?void 0:z._defineProjectionName)&&void 0!==B?B:"REFLECTIONMAP_PROJECTION"},{search:/SS_REFRACTIONMAP_3D/g,replace:null!==(U=null==te?void 0:te._define3DName)&&void 0!==U?U:"SS_REFRACTIONMAP_3D"},{search:/SS_LODINREFRACTIONALPHA/g,replace:null!==(V=null==te?void 0:te._defineLODRefractionAlpha)&&void 0!==V?V:"SS_LODINREFRACTIONALPHA"},{search:/SS_LINEARSPECULARREFRACTION/g,replace:null!==(k=null==te?void 0:te._defineLinearSpecularRefraction)&&void 0!==k?k:"SS_LINEARSPECULARREFRACTION"},{search:/SS_REFRACTIONMAP_OPPOSITEZ/g,replace:null!==(G=null==te?void 0:te._defineOppositeZ)&&void 0!==G?G:"SS_REFRACTIONMAP_OPPOSITEZ"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockDirectLighting",W),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",W,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/vPositionW/g,replace:X+".xyz"}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",W,{repeatKey:"maxSimultaneousLights",substitutionVars:`vPositionW,${X}.xyz`}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalLitComponents",W),e.compilationString+="#endif\n";const ie=this.ambientColor.isConnected?this.ambientColor.associatedVariableName:"vec3(0., 0., 0.)";let se=Nd.DEFAULT_AO_ON_ANALYTICAL_LIGHTS.toString();-1===se.indexOf(".")&&(se+="."),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalUnlitComponents",W,{replaceStrings:[{search:/vec3 finalEmissive[\s\S]*?finalEmissive\*=vLightingIntensity\.y;/g,replace:""},{search:/vAmbientColor/g,replace:ie+" * ambientFromScene"},{search:/vAmbientInfos\.w/g,replace:se}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalColorComposition",W,{replaceStrings:[{search:/finalEmissive/g,replace:"vec3(0.)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockImageProcessing",W,{replaceStrings:[{search:/visibility/g,replace:"1."}]}),e.compilationString+=e._emitCodeFromInclude("pbrDebug",W,{replaceStrings:[{search:/vNormalW/g,replace:this._vNormalWName},{search:/vPositionW/g,replace:X},{search:/albedoTexture\.rgb;/g,replace:"vec3(1.);\ngl_FragColor.rgb = toGammaSpace(gl_FragColor.rgb);\n"}]});for(const t of this._outputs)if(t.hasEndpoints){const i=cf[t.name];if(i){const[s,r]=i;r&&(e.compilationString+=`#if ${r}\n`),e.compilationString+=`${this._declareOutput(t,e)} = ${s};\n`,r&&(e.compilationString+="#else\n",e.compilationString+=`${this._declareOutput(t,e)} = vec3(0.);\n`,e.compilationString+="#endif\n")}else console.error(`There's no remapping for the ${t.name} end point! No code generated`)}return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.lightFalloff = ${this.lightFalloff};\n`,e+=`${this._codeVariableName}.useAlphaTest = ${this.useAlphaTest};\n`,e+=`${this._codeVariableName}.alphaTestCutoff = ${this.alphaTestCutoff};\n`,e+=`${this._codeVariableName}.useAlphaBlending = ${this.useAlphaBlending};\n`,e+=`${this._codeVariableName}.useRadianceOverAlpha = ${this.useRadianceOverAlpha};\n`,e+=`${this._codeVariableName}.useSpecularOverAlpha = ${this.useSpecularOverAlpha};\n`,e+=`${this._codeVariableName}.enableSpecularAntiAliasing = ${this.enableSpecularAntiAliasing};\n`,e+=`${this._codeVariableName}.realTimeFiltering = ${this.realTimeFiltering};\n`,e+=`${this._codeVariableName}.realTimeFilteringQuality = ${this.realTimeFilteringQuality};\n`,e+=`${this._codeVariableName}.useEnergyConservation = ${this.useEnergyConservation};\n`,e+=`${this._codeVariableName}.useRadianceOcclusion = ${this.useRadianceOcclusion};\n`,e+=`${this._codeVariableName}.useHorizonOcclusion = ${this.useHorizonOcclusion};\n`,e+=`${this._codeVariableName}.unlit = ${this.unlit};\n`,e+=`${this._codeVariableName}.forceNormalForward = ${this.forceNormalForward};\n`,e+=`${this._codeVariableName}.debugMode = ${this.debugMode};\n`,e+=`${this._codeVariableName}.debugLimit = ${this.debugLimit};\n`,e+=`${this._codeVariableName}.debugFactor = ${this.debugFactor};\n`,e}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e.lightFalloff=this.lightFalloff,e.useAlphaTest=this.useAlphaTest,e.alphaTestCutoff=this.alphaTestCutoff,e.useAlphaBlending=this.useAlphaBlending,e.useRadianceOverAlpha=this.useRadianceOverAlpha,e.useSpecularOverAlpha=this.useSpecularOverAlpha,e.enableSpecularAntiAliasing=this.enableSpecularAntiAliasing,e.realTimeFiltering=this.realTimeFiltering,e.realTimeFilteringQuality=this.realTimeFilteringQuality,e.useEnergyConservation=this.useEnergyConservation,e.useRadianceOcclusion=this.useRadianceOcclusion,e.useHorizonOcclusion=this.useHorizonOcclusion,e.unlit=this.unlit,e.forceNormalForward=this.forceNormalForward,e.debugMode=this.debugMode,e.debugLimit=this.debugLimit,e.debugFactor=this.debugFactor,e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){var s,r;super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.lightFalloff=null!==(s=e.lightFalloff)&&void 0!==s?s:0,this.useAlphaTest=e.useAlphaTest,this.alphaTestCutoff=e.alphaTestCutoff,this.useAlphaBlending=e.useAlphaBlending,this.useRadianceOverAlpha=e.useRadianceOverAlpha,this.useSpecularOverAlpha=e.useSpecularOverAlpha,this.enableSpecularAntiAliasing=e.enableSpecularAntiAliasing,this.realTimeFiltering=!!e.realTimeFiltering,this.realTimeFilteringQuality=null!==(r=e.realTimeFilteringQuality)&&void 0!==r?r:8,this.useEnergyConservation=e.useEnergyConservation,this.useRadianceOcclusion=e.useRadianceOcclusion,this.useHorizonOcclusion=e.useHorizonOcclusion,this.unlit=e.unlit,this.forceNormalForward=!!e.forceNormalForward,this.debugMode=e.debugMode,this.debugLimit=e.debugLimit,this.debugFactor=e.debugFactor,this.generateOnlyFragmentCode=!!e.generateOnlyFragmentCode,this._setTarget()}}var df,pf,_f,ff,mf,gf,vf;me([Zr("Direct lights",Js.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],uf.prototype,"directIntensity",void 0),me([Zr("Environment lights",Js.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],uf.prototype,"environmentIntensity",void 0),me([Zr("Specular highlights",Js.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],uf.prototype,"specularIntensity",void 0),me([Zr("Light falloff",Js.List,"LIGHTING & COLORS",{notifiers:{update:!0},options:[{label:"Physical",value:Nd.LIGHTFALLOFF_PHYSICAL},{label:"GLTF",value:Nd.LIGHTFALLOFF_GLTF},{label:"Standard",value:Nd.LIGHTFALLOFF_STANDARD}]})],uf.prototype,"lightFalloff",void 0),me([Zr("Alpha Testing",Js.Boolean,"OPACITY")],uf.prototype,"useAlphaTest",void 0),me([Zr("Alpha CutOff",Js.Float,"OPACITY",{min:0,max:1,notifiers:{update:!0}})],uf.prototype,"alphaTestCutoff",void 0),me([Zr("Alpha blending",Js.Boolean,"OPACITY")],uf.prototype,"useAlphaBlending",void 0),me([Zr("Radiance over alpha",Js.Boolean,"RENDERING",{notifiers:{update:!0}})],uf.prototype,"useRadianceOverAlpha",void 0),me([Zr("Specular over alpha",Js.Boolean,"RENDERING",{notifiers:{update:!0}})],uf.prototype,"useSpecularOverAlpha",void 0),me([Zr("Specular anti-aliasing",Js.Boolean,"RENDERING",{notifiers:{update:!0}})],uf.prototype,"enableSpecularAntiAliasing",void 0),me([Zr("Realtime filtering",Js.Boolean,"RENDERING",{notifiers:{update:!0}})],uf.prototype,"realTimeFiltering",void 0),me([Zr("Realtime filtering quality",Js.List,"RENDERING",{notifiers:{update:!0},options:[{label:"Low",value:8},{label:"Medium",value:16},{label:"High",value:64}]})],uf.prototype,"realTimeFilteringQuality",void 0),me([Zr("Energy Conservation",Js.Boolean,"ADVANCED",{notifiers:{update:!0}})],uf.prototype,"useEnergyConservation",void 0),me([Zr("Radiance occlusion",Js.Boolean,"ADVANCED",{notifiers:{update:!0}})],uf.prototype,"useRadianceOcclusion",void 0),me([Zr("Horizon occlusion",Js.Boolean,"ADVANCED",{notifiers:{update:!0}})],uf.prototype,"useHorizonOcclusion",void 0),me([Zr("Unlit",Js.Boolean,"ADVANCED",{notifiers:{update:!0}})],uf.prototype,"unlit",void 0),me([Zr("Force normal forward",Js.Boolean,"ADVANCED",{notifiers:{update:!0}})],uf.prototype,"forceNormalForward",void 0),me([Zr("Generate only fragment code",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:uf._OnGenerateOnlyFragmentCodeChanged}})],uf.prototype,"generateOnlyFragmentCode",void 0),me([Zr("Debug mode",Js.List,"DEBUG",{notifiers:{update:!0},options:[{label:"None",value:0},{label:"Normalized position",value:1},{label:"Normals",value:2},{label:"Tangents",value:3},{label:"Bitangents",value:4},{label:"Bump Normals",value:5},{label:"ClearCoat Normals",value:8},{label:"ClearCoat Tangents",value:9},{label:"ClearCoat Bitangents",value:10},{label:"Anisotropic Normals",value:11},{label:"Anisotropic Tangents",value:12},{label:"Anisotropic Bitangents",value:13},{label:"Env Refraction",value:40},{label:"Env Reflection",value:41},{label:"Env Clear Coat",value:42},{label:"Direct Diffuse",value:50},{label:"Direct Specular",value:51},{label:"Direct Clear Coat",value:52},{label:"Direct Sheen",value:53},{label:"Env Irradiance",value:54},{label:"Surface Albedo",value:60},{label:"Reflectance 0",value:61},{label:"Metallic",value:62},{label:"Metallic F0",value:71},{label:"Roughness",value:63},{label:"AlphaG",value:64},{label:"NdotV",value:65},{label:"ClearCoat Color",value:66},{label:"ClearCoat Roughness",value:67},{label:"ClearCoat NdotV",value:68},{label:"Transmittance",value:69},{label:"Refraction Transmittance",value:70},{label:"SEO",value:80},{label:"EHO",value:81},{label:"Energy Factor",value:82},{label:"Specular Reflectance",value:83},{label:"Clear Coat Reflectance",value:84},{label:"Sheen Reflectance",value:85},{label:"Luminance Over Alpha",value:86},{label:"Alpha",value:87}]})],uf.prototype,"debugMode",void 0),me([Zr("Split position",Js.Float,"DEBUG",{min:-1,max:1,notifiers:{update:!0}})],uf.prototype,"debugLimit",void 0),me([Zr("Output factor",Js.Float,"DEBUG",{min:0,max:5,notifiers:{update:!0}})],uf.prototype,"debugFactor",void 0),m("BABYLON.PBRMetallicRoughnessBlock",uf),m("BABYLON.ModBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("left",$s.AutoDetect),this.registerInput("right",$s.AutoDetect),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[1].acceptedConnectionPointTypes.push($s.Float)}getClassName(){return"ModBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = mod(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`,this}}),m("BABYLON.MatrixBuilder",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("row0",$s.Vector4),this.registerInput("row1",$s.Vector4),this.registerInput("row2",$s.Vector4),this.registerInput("row3",$s.Vector4),this.registerOutput("output",$s.Matrix)}getClassName(){return"MatrixBuilder"}get row0(){return this._inputs[0]}get row1(){return this._inputs[1]}get row2(){return this._inputs[2]}get row3(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(){if(!this.row0.isConnected){const e=new rn("row0");e.value=new b(1,0,0,0),e.output.connectTo(this.row0)}if(!this.row1.isConnected){const e=new rn("row1");e.value=new b(0,1,0,0),e.output.connectTo(this.row1)}if(!this.row2.isConnected){const e=new rn("row2");e.value=new b(0,0,1,0),e.output.connectTo(this.row2)}if(!this.row3.isConnected){const e=new rn("row3");e.value=new b(0,0,0,1),e.output.connectTo(this.row3)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.row0,s=this.row1,r=this.row2,n=this.row3;return e.compilationString+=this._declareOutput(t,e)+` = mat4(${i.associatedVariableName}, ${s.associatedVariableName}, ${r.associatedVariableName}, ${n.associatedVariableName});\n`,this}}),function(e){e[e.Equal=0]="Equal",e[e.NotEqual=1]="NotEqual",e[e.LessThan=2]="LessThan",e[e.GreaterThan=3]="GreaterThan",e[e.LessOrEqual=4]="LessOrEqual",e[e.GreaterOrEqual=5]="GreaterOrEqual",e[e.Xor=6]="Xor",e[e.Or=7]="Or",e[e.And=8]="And"}(df||(df={})),m("BABYLON.ConditionalBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.condition=df.LessThan,this.registerInput("a",$s.Float),this.registerInput("b",$s.Float),this.registerInput("true",$s.AutoDetect,!0),this.registerInput("false",$s.AutoDetect,!0),this.registerOutput("output",$s.BasedOnInput),this._linkConnectionTypes(2,3),this._outputs[0]._typeConnectionSource=this._inputs[2],this._outputs[0]._defaultConnectionPointType=$s.Float}getClassName(){return"ConditionalBlock"}get a(){return this._inputs[0]}get b(){return this._inputs[1]}get true(){return this._inputs[2]}get false(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.true.isConnected?this.true.associatedVariableName:"1.0",s=this.false.isConnected?this.false.associatedVariableName:"0.0";switch(this.condition){case df.Equal:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} == ${this.b.associatedVariableName} ? ${i} : ${s};\n`;break;case df.NotEqual:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} != ${this.b.associatedVariableName} ? ${i} : ${s};\n`;break;case df.LessThan:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} < ${this.b.associatedVariableName} ? ${i} : ${s};\n`;break;case df.LessOrEqual:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} <= ${this.b.associatedVariableName} ? ${i} : ${s};\n`;break;case df.GreaterThan:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} > ${this.b.associatedVariableName} ? ${i} : ${s};\n`;break;case df.GreaterOrEqual:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} >= ${this.b.associatedVariableName} ? ${i} : ${s};\n`;break;case df.Xor:e.compilationString+=this._declareOutput(t,e)+` = (mod(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 2.0) > 0.0) ? ${i} : ${s};\n`;break;case df.Or:e.compilationString+=this._declareOutput(t,e)+` = (min(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 1.0) > 0.0) ? ${i} : ${s};\n`;break;case df.And:e.compilationString+=this._declareOutput(t,e)+` = (${this.a.associatedVariableName} * ${this.b.associatedVariableName} > 0.0)  ? ${i} : ${s};\n`}return this}serialize(){const e=super.serialize();return e.condition=this.condition,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.condition=e.condition}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.condition = BABYLON.ConditionalBlockConditions.${df[this.condition]};\n`}});class xf extends $r{constructor(e){super(e,qs.Neutral),this.octaves=6,this.registerInput("seed",$s.AutoDetect),this.registerInput("chaos",$s.AutoDetect,!0),this.registerInput("offsetX",$s.Float,!0),this.registerInput("offsetY",$s.Float,!0),this.registerInput("offsetZ",$s.Float,!0),this.registerOutput("output",$s.Float),this._inputs[0].acceptedConnectionPointTypes.push($s.Vector2),this._inputs[0].acceptedConnectionPointTypes.push($s.Vector3),this._linkConnectionTypes(0,1)}getClassName(){return"CloudBlock"}get seed(){return this._inputs[0]}get chaos(){return this._inputs[1]}get offsetX(){return this._inputs[2]}get offsetY(){return this._inputs[3]}get offsetZ(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){var t,i;if(super._buildBlock(e),!this.seed.isConnected)return;if(!this._outputs[0].hasEndpoints)return;const s=`fbm${this.octaves}`;e._emitFunction("CloudBlockCode","\n\n        float cloudRandom(in float p) { p = fract(p * 0.011); p *= p + 7.5; p *= p + p; return fract(p); }\n\n        // Based on Morgan McGuire @morgan3d\n        // https://www.shadertoy.com/view/4dS3Wd\n        float cloudNoise(in vec2 x, in vec2 chaos) {\n            vec2 step = chaos * vec2(75., 120.) + vec2(75., 120.);\n\n            vec2 i = floor(x);\n            vec2 f = fract(x);\n\n            float n = dot(i, step);\n\n            vec2 u = f * f * (3.0 - 2.0 * f);\n            return mix(\n                    mix(cloudRandom(n + dot(step, vec2(0, 0))), cloudRandom(n + dot(step, vec2(1, 0))), u.x),\n                    mix(cloudRandom(n + dot(step, vec2(0, 1))), cloudRandom(n + dot(step, vec2(1, 1))), u.x),\n                    u.y\n                );\n        }\n\n        float cloudNoise(in vec3 x, in vec3 chaos) {\n            vec3 step = chaos * vec3(60., 120., 75.) + vec3(60., 120., 75.);\n\n            vec3 i = floor(x);\n            vec3 f = fract(x);\n\n            float n = dot(i, step);\n\n            vec3 u = f * f * (3.0 - 2.0 * f);\n            return mix(mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 0))), cloudRandom(n + dot(step, vec3(1, 0, 0))), u.x),\n                           mix( cloudRandom(n + dot(step, vec3(0, 1, 0))), cloudRandom(n + dot(step, vec3(1, 1, 0))), u.x), u.y),\n                       mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 1))), cloudRandom(n + dot(step, vec3(1, 0, 1))), u.x),\n                           mix( cloudRandom(n + dot(step, vec3(0, 1, 1))), cloudRandom(n + dot(step, vec3(1, 1, 1))), u.x), u.y), u.z);\n        }","// CloudBlockCode"),e._emitFunction("CloudBlockCodeFBM"+this.octaves,"\n        float fbm(in vec2 st, in vec2 chaos) {\n            // Initial values\n            float value = 0.0;\n            float amplitude = .5;\n            float frequency = 0.;\n\n            // Loop of octaves\n            for (int i = 0; i < OCTAVES; i++) {\n                value += amplitude * cloudNoise(st, chaos);\n                st *= 2.0;\n                amplitude *= 0.5;\n            }\n            return value;\n        }\n\n        float fbm(in vec3 x, in vec3 chaos) {\n            // Initial values\n            float value = 0.0;\n            float amplitude = 0.5;\n            for (int i = 0; i < OCTAVES; ++i) {\n                value += amplitude * cloudNoise(x, chaos);\n                x = x * 2.0;\n                amplitude *= 0.5;\n            }\n            return value;\n        }".replace(/fbm/gi,s).replace(/OCTAVES/gi,(0|this.octaves).toString()),"// CloudBlockCode FBM");const r=e._getFreeVariableName("st"),n=(null===(t=this.seed.connectedPoint)||void 0===t?void 0:t.type)===$s.Vector2?"vec2":"vec3";e.compilationString+=`${n} ${r} = ${this.seed.associatedVariableName};\n`,this.offsetX.isConnected&&(e.compilationString+=`${r}.x += 0.1 * ${this.offsetX.associatedVariableName};\n`),this.offsetY.isConnected&&(e.compilationString+=`${r}.y += 0.1 * ${this.offsetY.associatedVariableName};\n`),this.offsetZ.isConnected&&"vec3"===n&&(e.compilationString+=`${r}.z += 0.1 * ${this.offsetZ.associatedVariableName};\n`);let o="";return o=this.chaos.isConnected?this.chaos.associatedVariableName:(null===(i=this.seed.connectedPoint)||void 0===i?void 0:i.type)===$s.Vector2?"vec2(0., 0.)":"vec3(0., 0., 0.)",e.compilationString+=this._declareOutput(this._outputs[0],e)+` = ${s}(${r}, ${o});\n`,this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.octaves = ${this.octaves};\n`}serialize(){const e=super.serialize();return e.octaves=this.octaves,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.octaves=e.octaves}}me([Zr("Octaves",Js.Int)],xf.prototype,"octaves",void 0),m("BABYLON.CloudBlock",xf),m("BABYLON.VoronoiNoiseBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("seed",$s.Vector2),this.registerInput("offset",$s.Float),this.registerInput("density",$s.Float),this.registerOutput("output",$s.Float),this.registerOutput("cells",$s.Float)}getClassName(){return"VoronoiNoiseBlock"}get seed(){return this._inputs[0]}get offset(){return this._inputs[1]}get density(){return this._inputs[2]}get output(){return this._outputs[0]}get cells(){return this._outputs[1]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;let t="vec2 voronoiRandom(vec2 seed, float offset){\n            mat2 m = mat2(15.27, 47.63, 99.41, 89.98);\n            vec2 uv = fract(sin(m * seed) * 46839.32);\n            return vec2(sin(uv.y * offset) * 0.5 + 0.5, cos(uv.x * offset) * 0.5 + 0.5);\n        }\n        ";e._emitFunction("voronoiRandom",t,"// Voronoi random generator"),t="void voronoi(vec2 seed, float offset, float density, out float outValue, out float cells){\n            vec2 g = floor(seed * density);\n            vec2 f = fract(seed * density);\n            float t = 8.0;\n            vec3 res = vec3(8.0, 0.0, 0.0);\n\n            for(int y=-1; y<=1; y++)\n            {\n                for(int x=-1; x<=1; x++)\n                {\n                    vec2 lattice = vec2(x,y);\n                    vec2 randomOffset = voronoiRandom(lattice + g, offset);\n                    float d = distance(lattice + randomOffset, f);\n                    if(d < res.x)\n                    {\n                        res = vec3(d, randomOffset.x, randomOffset.y);\n                        outValue = res.x;\n                        cells = res.y;\n                    }\n                }\n            }\n        }\n        ",e._emitFunction("voronoi",t,"// Voronoi");const i=e._getFreeVariableName("tempOutput"),s=e._getFreeVariableName("tempCells");return e.compilationString+=`float ${i} = 0.0;\n`,e.compilationString+=`float ${s} = 0.0;\n`,e.compilationString+=`voronoi(${this.seed.associatedVariableName}, ${this.offset.associatedVariableName}, ${this.density.associatedVariableName}, ${i}, ${s});\n`,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${i};\n`),this.cells.hasEndpoints&&(e.compilationString+=this._declareOutput(this.cells,e)+` = ${s};\n`),this}}),m("BABYLON.ElbowBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("input",$s.AutoDetect),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}get target(){const e=this._inputs[0];if(e.isConnected){const t=e.connectedPoint.ownerBlock;if(t.target!==qs.VertexAndFragment)return t.target;if(e.connectedPoint.target!==qs.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){this._target&e||(this._target=e)}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${i.associatedVariableName};\n`,this}});class Tf extends $r{get texture(){var e;return this.source.isConnected?(null===(e=this.source.connectedPoint)||void 0===e?void 0:e.ownerBlock).texture:this._texture}set texture(e){var t;if(this._texture===e)return;const i=null!==(t=null==e?void 0:e.getScene())&&void 0!==t?t:x.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this._texture))),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,(t=>t.hasTexture(e)))}get textureY(){var e;return this.sourceY.isConnected?(null===(e=this.sourceY.connectedPoint)||void 0===e?void 0:e.ownerBlock).texture:null}get textureZ(){var e,t;return(null===(e=this.sourceZ)||void 0===e?void 0:e.isConnected)?(null===(t=this.sourceY.connectedPoint)||void 0===t?void 0:t.ownerBlock).texture:null}_getImageSourceBlock(e){return(null==e?void 0:e.isConnected)?e.connectedPoint.ownerBlock:null}get samplerName(){const e=this._getImageSourceBlock(this.source);return e?e.samplerName:this._samplerName}get samplerYName(){var e,t;return null!==(t=null===(e=this._getImageSourceBlock(this.sourceY))||void 0===e?void 0:e.samplerName)&&void 0!==t?t:null}get samplerZName(){var e,t;return null!==(t=null===(e=this._getImageSourceBlock(this.sourceZ))||void 0===e?void 0:e.samplerName)&&void 0!==t?t:null}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){var t;if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){const e=null!==(t=this.texture.getScene())&&void 0!==t?t:x.LastCreatedScene;null==e||e.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this.texture)))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){var t;if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){const e=null!==(t=this.texture.getScene())&&void 0!==t?t:x.LastCreatedScene;null==e||e.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this.texture)))}}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,qs.Neutral),this.projectAsCube=!1,this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this.registerInput("position",$s.AutoDetect,!1),this.registerInput("normal",$s.AutoDetect,!1),this.registerInput("sharpness",$s.Float,!0),this.registerInput("source",$s.Object,!0,qs.VertexAndFragment,new V_("source",this,Zs.Input,Y_,"ImageSourceBlock")),this.registerInput("sourceY",$s.Object,!0,qs.VertexAndFragment,new V_("sourceY",this,Zs.Input,Y_,"ImageSourceBlock")),t||this.registerInput("sourceZ",$s.Object,!0,qs.VertexAndFragment,new V_("sourceZ",this,Zs.Input,Y_,"ImageSourceBlock")),this.registerOutput("rgba",$s.Color4,qs.Neutral),this.registerOutput("rgb",$s.Color3,qs.Neutral),this.registerOutput("r",$s.Float,qs.Neutral),this.registerOutput("g",$s.Float,qs.Neutral),this.registerOutput("b",$s.Float,qs.Neutral),this.registerOutput("a",$s.Float,qs.Neutral),this.registerOutput("level",$s.Float,qs.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes($s.Color3|$s.Vector3|$s.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes($s.Color3|$s.Vector3|$s.Vector4)}getClassName(){return"TriPlanarBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get sharpness(){return this._inputs[2]}get source(){return this._inputs[3]}get sourceY(){return this._inputs[4]}get sourceZ(){return this._inputs[5]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;const s=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,r=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,s,!0),i.setValue(this._gammaDefineName,r,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){this.texture&&(e.setFloat(this._textureInfoName,this.texture.level),this._imageSource||e.setTexture(this._samplerName,this.texture))}_generateTextureLookup(e){var t,i;const s=this.samplerName,r=null!==(t=this.samplerYName)&&void 0!==t?t:s,n=null!==(i=this.samplerZName)&&void 0!==i?i:s,o=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",a=e._getFreeVariableName("x"),l=e._getFreeVariableName("y"),h=e._getFreeVariableName("z"),c=e._getFreeVariableName("w"),u=e._getFreeVariableName("n"),d=e._getFreeVariableName("uvx"),p=e._getFreeVariableName("uvy"),_=e._getFreeVariableName("uvz");e.compilationString+=`\n            vec3 ${u} = ${this.normal.associatedVariableName}.xyz;\n\n            vec2 ${d} = ${this.position.associatedVariableName}.yz;\n            vec2 ${p} = ${this.position.associatedVariableName}.zx;\n            vec2 ${_} = ${this.position.associatedVariableName}.xy;\n        `,this.projectAsCube&&(e.compilationString+=`\n                ${d}.xy = ${d}.yx;\n\n                if (${u}.x >= 0.0) {\n                    ${d}.x = -${d}.x;\n                }\n                if (${u}.y < 0.0) {\n                    ${p}.y = -${p}.y;\n                }\n                if (${u}.z < 0.0) {\n                    ${_}.x = -${_}.x;\n                }\n            `),e.compilationString+=`\n            vec4 ${a} = texture2D(${s}, ${d});\n            vec4 ${l} = texture2D(${r}, ${p});\n            vec4 ${h} = texture2D(${n}, ${_});\n           \n            // blend weights\n            vec3 ${c} = pow(abs(${u}), vec3(${o}));\n\n            // blend and return\n            vec4 ${this._tempTextureRead} = (${a}*${c}.x + ${l}*${c}.y + ${h}*${c}.z) / (${c}.x + ${c}.y + ${c}.z);        \n        `}_generateConversionCode(e,t,i){"a"!==i&&(this.texture&&this.texture.gammaSpace||(e.compilationString+=`#ifdef ${this._linearDefineName}\n                    ${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\n                    #endif\n                `),e.compilationString+=`#ifdef ${this._gammaDefineName}\n                ${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\n                #endif\n            `)}_writeOutput(e,t,i){let s="";this.disableLevelMultiplication||(s=` * ${this._textureInfoName}`),e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i}${s};\n`,this._generateConversionCode(e,t,i)}_buildBlock(e){super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=this._textureInfoName,this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA"),this._imageSource||(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),e._emit2DSampler(this._samplerName)),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e._emitUniformFromString(this._textureInfoName,"float"),this._generateTextureLookup(e);for(const t of this._outputs)t.hasEndpoints&&"level"!==t.name&&this._writeOutput(e,t,t.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\n`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\n`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};\n`,e+=`${this._codeVariableName}.projectAsCube = ${this.projectAsCube};\n`,this.texture?(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\n`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\n`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\n`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\n`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\n`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\n`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\n`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\n`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\n`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`,e):e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.disableLevelMultiplication=this.disableLevelMultiplication,e.projectAsCube=this.projectAsCube,this.hasImageSource||!this.texture||this.texture.isRenderTarget||"VideoTexture"===this.texture.getClassName()||(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.disableLevelMultiplication=!!e.disableLevelMultiplication,this.projectAsCube=!!e.projectAsCube,e.texture&&!Hn.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=Ar.Parse(e.texture,t,i))}}me([Zr("Project as cube",Js.Boolean,"ADVANCED",{notifiers:{update:!0}})],Tf.prototype,"projectAsCube",void 0),m("BABYLON.TriPlanarBlock",Tf),m("BABYLON.BiPlanarBlock",class extends Tf{constructor(e){super(e,!0)}getClassName(){return"BiPlanarBlock"}_generateTextureLookup(e){var t;const i=this.samplerName,s=null!==(t=this.samplerYName)&&void 0!==t?t:this.samplerName,r=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",n=e._getFreeVariableName("dpdx"),o=e._getFreeVariableName("dpdy"),a=e._getFreeVariableName("n"),l=e._getFreeVariableName("ma"),h=e._getFreeVariableName("mi"),c=e._getFreeVariableName("me"),u=e._getFreeVariableName("x"),d=e._getFreeVariableName("y"),p=e._getFreeVariableName("y");e.compilationString+=`\n            // grab coord derivatives for texturing\n            vec3 ${n} = dFdx(${this.position.associatedVariableName}.xyz);\n            vec3 ${o} = dFdy(${this.position.associatedVariableName}.xyz);\n            vec3 ${a} = abs(${this.normal.associatedVariableName}.xyz);\n        \n            // determine major axis (in x; yz are following axis)\n            ivec3 ${l} = (${a}.x>${a}.y && ${a}.x>${a}.z) ? ivec3(0,1,2) :\n                    (${a}.y>${a}.z)            ? ivec3(1,2,0) :\n                                            ivec3(2,0,1) ;\n            // determine minor axis (in x; yz are following axis)\n            ivec3 ${h} = (${a}.x<${a}.y && ${a}.x<${a}.z) ? ivec3(0,1,2) :\n                    (${a}.y<${a}.z)            ? ivec3(1,2,0) :\n                                            ivec3(2,0,1) ;\n            // determine median axis (in x;  yz are following axis)\n            ivec3 ${c} = ivec3(3) - ${h} - ${l};\n            \n            // project+fetch\n            vec4 ${u} = textureGrad( ${i}, vec2(   ${this.position.associatedVariableName}[${l}.y],   ${this.position.associatedVariableName}[${l}.z]), \n                                    vec2(${n}[${l}.y],${n}[${l}.z]), \n                                    vec2(${o}[${l}.y],${o}[${l}.z]) );\n            vec4 ${d} = textureGrad( ${s}, vec2(   ${this.position.associatedVariableName}[${c}.y],   ${this.position.associatedVariableName}[${c}.z]), \n                                    vec2(${n}[${c}.y],${n}[${c}.z]),\n                                    vec2(${o}[${c}.y],${o}[${c}.z]) );\n            \n            // blend factors\n            vec2 ${p} = vec2(${a}[${l}.x],${a}[${c}.x]);\n            // make local support\n            ${p} = clamp( (${p}-0.5773)/(1.0-0.5773), 0.0, 1.0 );\n            // shape transition\n            ${p} = pow( ${p}, vec2(${r}/8.0) );\n            // blend and return\n            vec4 ${this._tempTextureRead} = (${u}*${p}.x + ${d}*${p}.y) / (${p}.x + ${p}.y);\n        `}}),m("BABYLON.MatrixDeterminantBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("input",$s.Matrix),this.registerOutput("output",$s.Float)}getClassName(){return"MatrixDeterminantBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.output,i=this.input;return e.compilationString+=this._declareOutput(t,e)+`${t.associatedVariableName} = determinant(${i.associatedVariableName});\n`,this}}),m("BABYLON.MatrixTransposeBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.registerInput("input",$s.Matrix),this.registerOutput("output",$s.Matrix)}getClassName(){return"MatrixTransposeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.output,i=this.input;return e.compilationString+=this._declareOutput(t,e)+`${t.associatedVariableName} = transpose(${i.associatedVariableName});\n`,this}}),function(e){e[e.None=0]="None",e[e.Normal=1]="Normal",e[e.Tangent=2]="Tangent",e[e.VertexColor=3]="VertexColor",e[e.UV1=4]="UV1",e[e.UV2=5]="UV2",e[e.UV3=6]="UV3",e[e.UV4=7]="UV4",e[e.UV5=8]="UV5",e[e.UV6=9]="UV6"}(pf||(pf={}));class Ef extends $r{constructor(e){super(e,qs.Neutral),this.attributeType=pf.None,this.registerInput("input",$s.AutoDetect),this.registerInput("fallback",$s.AutoDetect),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].onConnectionObservable.add((e=>{var t;if(this.attributeType)return;const i=e.ownerBlock;if(i instanceof rn&&i.isAttribute)switch(i.name){case"color":this.attributeType=pf.VertexColor;break;case"normal":this.attributeType=pf.Normal;break;case"tangent":this.attributeType=pf.Tangent;break;case"uv":this.attributeType=pf.UV1;break;case"uv2":this.attributeType=pf.UV2;break;case"uv3":this.attributeType=pf.UV3;break;case"uv4":this.attributeType=pf.UV4;break;case"uv5":this.attributeType=pf.UV5;break;case"uv6":this.attributeType=pf.UV6}else if(i instanceof k_)switch(null===(t=this.input.connectedPoint)||void 0===t?void 0:t.name){case"normalOutput":this.attributeType=pf.Normal;break;case"tangentOutput":this.attributeType=pf.Tangent;break;case"uvOutput":this.attributeType=pf.UV1}}))}getClassName(){return"MeshAttributeExistsBlock"}get input(){return this._inputs[0]}get fallback(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=null;switch(this.attributeType){case pf.VertexColor:t="VERTEXCOLOR_NME";break;case pf.Normal:t="NORMAL";break;case pf.Tangent:t="TANGENT";break;case pf.UV1:t="UV1";break;case pf.UV2:t="UV2";break;case pf.UV3:t="UV3";break;case pf.UV4:t="UV4";break;case pf.UV5:t="UV5";break;case pf.UV6:t="UV6"}const i=this._declareOutput(this.output,e);return t&&(e.compilationString+=`#ifdef ${t}\n`),e.compilationString+=`${i} = ${this.input.associatedVariableName};\n`,t&&(e.compilationString+="#else\n",e.compilationString+=`${i} = ${this.fallback.associatedVariableName};\n`,e.compilationString+="#endif\n"),this}serialize(){const e=super.serialize();return e.attributeType=this.attributeType,e}_deserialize(e,t,i){var s;super._deserialize(e,t,i),this.attributeType=null!==(s=e.attributeType)&&void 0!==s?s:pf.None}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.attributeType = ${this.attributeType};\n`,e}}me([Zr("Attribute lookup",Js.List,void 0,{notifiers:{update:!0},options:[{label:"(None)",value:pf.None},{label:"Normal",value:pf.Normal},{label:"Tangent",value:pf.Tangent},{label:"Vertex Color",value:pf.VertexColor},{label:"UV1",value:pf.UV1},{label:"UV2",value:pf.UV2},{label:"UV3",value:pf.UV3},{label:"UV4",value:pf.UV4},{label:"UV5",value:pf.UV5},{label:"UV6",value:pf.UV6}]})],Ef.prototype,"attributeType",void 0),m("BABYLON.MeshAttributeExistsBlock",Ef),function(e){e[e.EaseInSine=0]="EaseInSine",e[e.EaseOutSine=1]="EaseOutSine",e[e.EaseInOutSine=2]="EaseInOutSine",e[e.EaseInQuad=3]="EaseInQuad",e[e.EaseOutQuad=4]="EaseOutQuad",e[e.EaseInOutQuad=5]="EaseInOutQuad",e[e.EaseInCubic=6]="EaseInCubic",e[e.EaseOutCubic=7]="EaseOutCubic",e[e.EaseInOutCubic=8]="EaseInOutCubic",e[e.EaseInQuart=9]="EaseInQuart",e[e.EaseOutQuart=10]="EaseOutQuart",e[e.EaseInOutQuart=11]="EaseInOutQuart",e[e.EaseInQuint=12]="EaseInQuint",e[e.EaseOutQuint=13]="EaseOutQuint",e[e.EaseInOutQuint=14]="EaseInOutQuint",e[e.EaseInExpo=15]="EaseInExpo",e[e.EaseOutExpo=16]="EaseOutExpo",e[e.EaseInOutExpo=17]="EaseInOutExpo",e[e.EaseInCirc=18]="EaseInCirc",e[e.EaseOutCirc=19]="EaseOutCirc",e[e.EaseInOutCirc=20]="EaseInOutCirc",e[e.EaseInBack=21]="EaseInBack",e[e.EaseOutBack=22]="EaseOutBack",e[e.EaseInOutBack=23]="EaseInOutBack",e[e.EaseInElastic=24]="EaseInElastic",e[e.EaseOutElastic=25]="EaseOutElastic",e[e.EaseInOutElastic=26]="EaseInOutElastic"}(_f||(_f={})),m("BABYLON.CurveBlock",class extends $r{constructor(e){super(e,qs.Neutral),this.type=_f.EaseInOutSine,this.registerInput("input",$s.AutoDetect),this.registerOutput("output",$s.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push($s.Matrix),this._inputs[0].excludedConnectionPointTypes.push($s.Object),this._inputs[0].excludedConnectionPointTypes.push($s.Int)}getClassName(){return"CurveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_duplicateEntry(e,t){return`ret.${t} = ${e.replace(/VAL/g,"v."+t)}`}_duplicateEntryDirect(e){return`return ${e.replace(/VAL/g,"v")}`}_duplicateVector(e,t){if("float"===t)return this._duplicateEntryDirect(e);const i=parseInt(t.replace("vec",""));let s=`\n            vec${i} ret = vec${i}(0.0);\n        `;for(let t=1;t<=i;t++)s+=this._duplicateEntry(e,1===t?"x":2===t?"y":3===t?"z":"w")+";\n";return s+="return ret;\n",s}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];let i="",s="",r="";switch(this.input.type){case $s.Float:r="float";break;case $s.Vector2:r="vec2";break;case $s.Vector3:case $s.Color3:r="vec3";break;case $s.Vector4:case $s.Color4:r="vec4"}switch(s=_f[this.type]+"_"+r,this.type){case _f.EaseInSine:i="return 1.0 - cos((v * 3.1415) / 2.0)";break;case _f.EaseOutSine:i="return sin((v * 3.1415) / 2.0)";break;case _f.EaseInOutSine:i="return -(cos(v * 3.1415) - 1.0) / 2.0";break;case _f.EaseInQuad:i="return v * v";break;case _f.EaseOutQuad:i="return (1.0 - v) * (1.0 - v)";break;case _f.EaseInOutQuad:{const e="VAL < 0.5 ? 2.0 * VAL * VAL : 1.0 - pow(-2.0 * VAL + 2.0, 2.0) / 2.0";i=this._duplicateVector(e,r);break}case _f.EaseInCubic:i="return v * v * v";break;case _f.EaseOutCubic:{const e="1.0 - pow(1.0 - VAL, 3.0)";i=this._duplicateVector(e,r);break}case _f.EaseInOutCubic:{const e="VAL < 0.5 ? 4.0 * VAL * VAL * VAL : 1.0 - pow(-2.0 * VAL + 2.0, 3.0) / 2.0";i=this._duplicateVector(e,r);break}case _f.EaseInQuart:i="return v * v * v * v";break;case _f.EaseOutQuart:{const e="1.0 - pow(1.0 - VAL, 4.0)";i=this._duplicateVector(e,r);break}case _f.EaseInOutQuart:{const e="VAL < 0.5 ? 8.0 * VAL * VAL * VAL * VAL : 1.0 - pow(-2.0 * VAL + 2.0, 4.0) / 2.0";i=this._duplicateVector(e,r);break}case _f.EaseInQuint:i="return v * v * v * v * v";break;case _f.EaseOutQuint:{const e="1.0 - pow(1.0 - VAL, 5.0)";i=this._duplicateVector(e,r);break}case _f.EaseInOutQuint:{const e="VAL < 0.5 ? 16.0 * VAL * VAL * VAL * VAL * VAL : 1.0 - pow(-2.0 * VAL + 2.0, 5.0) / 2.0";i=this._duplicateVector(e,r);break}case _f.EaseInExpo:{const e="VAL == 0.0 ? 0.0 : pow(2.0, 10.0 * VAL - 10.0)";i=this._duplicateVector(e,r);break}case _f.EaseOutExpo:{const e="VAL == 1.0 ? 1.0 : 1.0 - pow(2.0, -10.0 * VAL)";i=this._duplicateVector(e,r);break}case _f.EaseInOutExpo:{const e="VAL == 0.0 ? 0.0 : VAL == 1.0 ? 1.0 : VAL < 0.5 ? pow(2.0, 20.0 * VAL - 10.0) / 2.0 : (2.0 - pow(2.0, -20.0 * VAL + 10.0)) / 2.0";i=this._duplicateVector(e,r);break}case _f.EaseInCirc:{const e="1.0 - sqrt(1.0 - pow(VAL, 2.0))";i=this._duplicateVector(e,r);break}case _f.EaseOutCirc:{const e="sqrt(1.0 - pow(VAL - 1.0, 2.0))";i=this._duplicateVector(e,r);break}case _f.EaseInOutCirc:{const e="VAL < 0.5 ? (1.0 - sqrt(1.0 - pow(2.0 * VAL, 2.0))) / 2.0 : (sqrt(1.0 - pow(-2.0 * VAL + 2.0, 2.0)) + 1.0) / 2.0";i=this._duplicateVector(e,r);break}case _f.EaseInBack:i="return 2.70158 * v * v * v - 1.70158 * v * v";break;case _f.EaseOutBack:{const e="2.70158 * pow(VAL - 1.0, 3.0) + 1.70158 * pow(VAL - 1.0, 2.0)";i=this._duplicateVector(e,r);break}case _f.EaseInOutBack:{const e="VAL < 0.5 ? (pow(2.0 * VAL, 2.0) * ((3.5949095) * 2.0 * VAL - 2.5949095)) / 2.0 : (pow(2.0 * VAL - 2.0, 2.0) * (3.5949095 * (VAL * 2.0 - 2.0) + 3.5949095) + 2.0) / 2.0";i=this._duplicateVector(e,r);break}case _f.EaseInElastic:{const e="VAL == 0.0 ? 0.0 : VAL == 1.0 ? 1.0 : -pow(2.0, 10.0 * VAL - 10.0) * sin((VAL * 10.0 - 10.75) * ((2.0 * 3.1415) / 3.0))";i=this._duplicateVector(e,r);break}case _f.EaseOutElastic:{const e="VAL == 0.0 ? 0.0 : VAL == 1.0 ? 1.0 : pow(2.0, -10.0 * VAL) * sin((VAL * 10.0 - 0.75) * ((2.0 * 3.1415) / 3.0)) + 1.0";i=this._duplicateVector(e,r);break}case _f.EaseInOutElastic:{const e="VAL == 0.0 ? 0.0 : VAL == 1.0 ? 1.0 : VAL < 0.5 ? -(pow(2.0, 20.0 * VAL - 10.0) * sin((20.0 * VAL - 11.125) * ((2.0 * 3.1415) / 4.5))) / 2.0 : (pow(2.0, -20.0 * VAL + 10.0) * sin((20.0 * VAL - 11.125) * ((2.0 * 3.1415) / 4.5))) / 2.0 + 1.0";i=this._duplicateVector(e,r);break}}return e._emitFunction(s,`${r} ${s}(${r} v) {${i};}\n`,""),e.compilationString+=this._declareOutput(t,e)+` = ${s}(${this.input.associatedVariableName});\n`,this}serialize(){const e=super.serialize();return e.curveType=this.type,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.type=e.curveType}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.type = BABYLON.CurveBlockTypes.${_f[this.type]};\n`}});class Sf extends $t{constructor(){super(...arguments),this.DECAL=!1,this.DECALDIRECTUV=0,this.DECAL_SMOOTHALPHA=!1,this.GAMMADECAL=!1}}class bf extends Fa{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"DecalMap",150,new Sf,t),this._isEnabled=!1,this.isEnabled=!1,this._smoothAlpha=!1,this.smoothAlpha=!1,this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i,s){const r=s.getMesh().decalMap;return!(this._isEnabled&&(null==r?void 0:r.texture)&&Ia.DecalMapEnabled&&t.texturesEnabled)||r.isReady()}prepareDefines(e,t,i){const s=i.decalMap;this._isEnabled&&(null==s?void 0:s.texture)&&Ia.DecalMapEnabled&&t.texturesEnabled?((!e.DECAL||e.GAMMADECAL!==s.texture.gammaSpace)&&e.markAsTexturesDirty(),e.DECAL=!0,e.GAMMADECAL=s.texture.gammaSpace,e.DECAL_SMOOTHALPHA=this._smoothAlpha,Hs.PrepareDefinesForMergedUV(s.texture,e,"DECAL")):(e.DECAL&&e.markAsTexturesDirty(),e.DECAL=!1)}hardBindForSubMesh(e,t,i,s){const r=s.getMesh().decalMap;if(!(this._isEnabled&&(null==r?void 0:r.texture)&&Ia.DecalMapEnabled&&t.texturesEnabled))return;const n=this._material.isFrozen,o=r.texture;e.useUbo&&n&&e.isSync||(e.updateFloat4("vDecalInfos",o.coordinatesIndex,0,0,0),Hs.BindTextureMatrix(o,e,"decal")),e.setTexture("decalSampler",o)}getClassName(){return"DecalMapConfiguration"}getSamplers(e){e.push("decalSampler")}getUniforms(){return{ubo:[{name:"vDecalInfos",size:4,type:"vec4"},{name:"decalMatrix",size:16,type:"mat4"}]}}}me([ie(),te("_markAllSubMeshesAsTexturesDirty")],bf.prototype,"isEnabled",void 0),me([ie(),te("_markAllSubMeshesAsTexturesDirty")],bf.prototype,"smoothAlpha",void 0),m("BABYLON.DecalMapConfiguration",bf),(vf=ff||(ff={}))[vf.MATERIAL_TYPE_STANDARD=0]="MATERIAL_TYPE_STANDARD",vf[vf.MATERIAL_TYPE_PBR=1]="MATERIAL_TYPE_PBR",vf[vf.MATERIAL_TYPE_SIMPLE=2]="MATERIAL_TYPE_SIMPLE",function(e){e[e.COLOR_MODE_SET=0]="COLOR_MODE_SET",e[e.COLOR_MODE_ADD=1]="COLOR_MODE_ADD",e[e.COLOR_MODE_MULTIPLY=2]="COLOR_MODE_MULTIPLY"}(mf||(mf={})),function(e){e[e.COLOR_DISTRIBUTION_TYPE_SEGMENT=0]="COLOR_DISTRIBUTION_TYPE_SEGMENT",e[e.COLOR_DISTRIBUTION_TYPE_LINE=1]="COLOR_DISTRIBUTION_TYPE_LINE"}(gf||(gf={}));class Cf{}Cf.DEFAULT_COLOR=N.White(),Cf.DEFAULT_WIDTH_ATTENUATED=1,Cf.DEFAULT_WIDTH=.1;class yf{static ConvertPoints(e){if(e.length&&Array.isArray(e)&&"number"==typeof e[0])return[e];if(e.length&&Array.isArray(e[0])&&"number"==typeof e[0][0])return e;if(e.length&&!Array.isArray(e[0])&&e[0]instanceof S){const t=[];for(let i=0;i<e.length;i++){const s=e[i];t.push(s.x,s.y,s.z)}return[t]}if(e.length>0&&Array.isArray(e[0])&&e[0].length>0&&e[0][0]instanceof S){const t=[];return e.forEach((e=>{t.push(e.flatMap((e=>[e.x,e.y,e.z])))})),t}if(e instanceof Float32Array)return[Array.from(e)];if(e.length&&e[0]instanceof Float32Array){const t=[];return e.forEach((e=>{t.push(Array.from(e))})),t}return[]}static OmitZeroLengthPredicate(e,t,i){const s=[];return t.subtract(e).lengthSquared()>0&&s.push([e,t]),i.subtract(t).lengthSquared()>0&&s.push([t,i]),e.subtract(i).lengthSquared()>0&&s.push([i,e]),0===s.length?null:s}static OmitDuplicatesPredicate(e,t,i,s){const r=[];return yf._SearchInPoints(e,t,s)||r.push([e,t]),yf._SearchInPoints(t,i,s)||r.push([t,i]),yf._SearchInPoints(i,e,s)||r.push([i,e]),0===r.length?null:r}static _SearchInPoints(e,t,i){var s,r,n;for(const o of i)for(let i=0;i<o.length;i++)if((null===(s=o[i])||void 0===s?void 0:s.equals(e))&&((null===(r=o[i+1])||void 0===r?void 0:r.equals(t))||(null===(n=o[i-1])||void 0===n?void 0:n.equals(t))))return!0;return!1}static MeshesToLines(e,t){const i=[];return e.forEach(((e,s)=>{const r=e.getVerticesData(hi.PositionKind),n=e.getIndices();if(r&&n)for(let o=0,a=0;o<n.length;o++){const l=3*n[a++],h=3*n[a++],c=3*n[a++],u=new S(r[l],r[l+1],r[l+2]),d=new S(r[h],r[h+1],r[h+2]),p=new S(r[c],r[c+1],r[c+2]);if(t){const a=t(u,d,p,i,o,l,e,s,r,n);if(a)for(const e of a)i.push(e)}else i.push([u,d],[d,p],[p,u])}})),i}static ToVector3Array(e){if(Array.isArray(e[0])){const t=[],i=e;for(const e of i){const i=[];for(let t=0;t<e.length;t+=3)i.push(new S(e[t],e[t+1],e[t+2]));t.push(i)}return t}const t=e,i=[];for(let e=0;e<t.length;e+=3)i.push(new S(t[e],t[e+1],t[e+2]));return i}static ToNumberArray(e){return e.flatMap((e=>[e.x,e.y,e.z]))}static GetPointsCountInfo(e){const t=new Array(e.length);let i=0;for(let s=e.length;s--;)t[s]=e[s].length/3,i+=t[s];return{total:i,counts:t}}static GetLineLength(e){if(0===e.length)return 0;let t;t="number"==typeof e[0]?yf.ToVector3Array(e):e;const i=R.Vector3[0];let s=0;for(let e=0;e<t.length-1;e++){const r=t[e];s+=t[e+1].subtractToRef(r,i).length()}return s}static SegmentizeSegmentByCount(e,t,i){const s=[],r=t.subtract(e),n=R.Vector3[0];n.setAll(i);const o=R.Vector3[1];r.divideToRef(n,o);let a=e.clone();s.push(a);for(let e=0;e<i;e++)a=a.clone(),s.push(a.addInPlace(o));return s}static SegmentizeLineBySegmentLength(e,t){const i=e[0]instanceof S?yf.GetLineSegments(e):"number"==typeof e[0]?yf.GetLineSegments(yf.ToVector3Array(e)):e,s=[];return i.forEach((e=>{e.length>t?yf.SegmentizeSegmentByCount(e.point1,e.point2,Math.ceil(e.length/t)).forEach((e=>{s.push(e)})):(s.push(e.point1),s.push(e.point2))})),s}static SegmentizeLineBySegmentCount(e,t){const i="number"==typeof e[0]?yf.ToVector3Array(e):e,s=yf.GetLineLength(i)/t;return yf.SegmentizeLineBySegmentLength(i,s)}static GetLineSegments(e){const t=[];for(let i=0;i<e.length-1;i++){const s=e[i],r=e[i+1],n=r.subtract(s).length();t.push({point1:s,point2:r,length:n})}return t}static GetMinMaxSegmentLength(e){const t=yf.GetLineSegments(e).sort((e=>e.length));return{min:t[0].length,max:t[t.length-1].length}}static GetPositionOnLineByVisibility(e,t,i,s=!1){const r=t*i;let n=0,o=0;const a=e.length;for(let t=0;t<a;t++){if(r<=n+e[t].length){o=t;break}n+=e[t].length}const l=(r-n)/e[o].length;return e[o].point2.subtractToRef(e[o].point1,R.Vector3[0]),R.Vector3[1]=R.Vector3[0].multiplyByFloats(l,l,l),s||R.Vector3[1].addInPlace(e[o].point1),R.Vector3[1].clone()}static GetCircleLinePoints(e,t,i=0,s=e,r=2*Math.PI/t){const n=[];for(let o=0;o<=t;o++)n.push(new S(Math.cos(o*r)*e,Math.sin(o*r)*s,i));return n}static GetBezierLinePoints(e,t,i,s){return es.CreateQuadraticBezier(e,t,i,s).getPoints().flatMap((e=>[e.x,e.y,e.z]))}static GetArrowCap(e,t,i,s,r,n=0,o=0){return{points:[e.clone(),e.add(t.multiplyByFloats(i,i,i))],widths:[s,r,n,o]}}static GetPointsFromText(e,t,i,s,r=0,n=!0){const o=[],a=function(e,t,i,s){const r=Array.from(e),n=t/s.resolution,o=(s.boundingBox.yMax-s.boundingBox.yMin+s.underlineThickness)*n,a=[];let l=0,h=0;for(let e=0;e<r.length;e++){const t=r[e];if("\n"===t)l=0,h-=o;else{const e=uh(t,n,l,h,i,s);e&&(l+=e.offsetX,a.push(e.shapePath))}}return a}(e,t,i,s);for(const e of a){for(const t of e.paths){const e=[],i=t.getPoints();for(const t of i)e.push(t.x,t.y,r);o.push(e)}if(n)for(const t of e.holes){const e=[],i=t.getPoints();for(const t of i)e.push(t.x,t.y,r);o.push(e)}}return o}static Color3toRGBAUint8(e){const t=new Uint8Array(4*e.length);for(let i=0,s=0;i<e.length;i++)t[s++]=255*e[i].r,t[s++]=255*e[i].g,t[s++]=255*e[i].b,t[s++]=255;return t}static CreateColorsTexture(e,t,i,s){const r=yf.Color3toRGBAUint8(t),n=new Mr(r,t.length,1,Ns.TEXTUREFORMAT_RGBA,s,!1,!0,i);return n.name=e,n}static PrepareEmptyColorsTexture(e){if(!Cf.EmptyColorsTexture){const t=new Uint8Array(4);Cf.EmptyColorsTexture=new Mr(t,1,1,Ns.TEXTUREFORMAT_RGBA,e,!1,!1,Mr.NEAREST_NEAREST),Cf.EmptyColorsTexture.name="grlEmptyColorsTexture"}return Cf.EmptyColorsTexture}static DisposeEmptyColorsTexture(){var e;null===(e=Cf.EmptyColorsTexture)||void 0===e||e.dispose(),Cf.EmptyColorsTexture=null}static BooleanToNumber(e){return e?1:0}}class Af extends $t{constructor(){super(...arguments),this.GREASED_LINE_HAS_COLOR=!1,this.GREASED_LINE_SIZE_ATTENUATION=!1,this.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=!1,this.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=!1,this.GREASED_LINE_CAMERA_FACING=!0}}class Rf extends Fa{constructor(e,t,i){var s,r,n,o,a,l,h,c,u,d,p,_,f,m,g,v,x;i=i||{color:Cf.DEFAULT_COLOR};const T=new Af;T.GREASED_LINE_HAS_COLOR=!!i.color&&!i.useColors,T.GREASED_LINE_SIZE_ATTENUATION=null!==(s=i.sizeAttenuation)&&void 0!==s&&s,T.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=i.colorDistributionType===gf.COLOR_DISTRIBUTION_TYPE_LINE,T.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=(null!=t?t:e.getScene()).useRightHandedSystem,T.GREASED_LINE_CAMERA_FACING=null===(r=i.cameraFacing)||void 0===r||r,super(e,Rf.GREASED_LINE_MATERIAL_NAME,200,T),this.colorsTexture=null,this._scene=null!=t?t:e.getScene(),this._engine=this._scene.getEngine(),this._cameraFacing=null===(n=i.cameraFacing)||void 0===n||n,this.visibility=null!==(o=i.visibility)&&void 0!==o?o:1,this.useDash=null!==(a=i.useDash)&&void 0!==a&&a,this.dashRatio=null!==(l=i.dashRatio)&&void 0!==l?l:.5,this.dashOffset=null!==(h=i.dashOffset)&&void 0!==h?h:0,this.width=i.width?i.width:i.sizeAttenuation?Cf.DEFAULT_WIDTH_ATTENUATED:Cf.DEFAULT_WIDTH,this._sizeAttenuation=null!==(c=i.sizeAttenuation)&&void 0!==c&&c,this.colorMode=null!==(u=i.colorMode)&&void 0!==u?u:mf.COLOR_MODE_SET,this._color=null!==(d=i.color)&&void 0!==d?d:null,this.useColors=null!==(p=i.useColors)&&void 0!==p&&p,this._colorsDistributionType=null!==(_=i.colorDistributionType)&&void 0!==_?_:gf.COLOR_DISTRIBUTION_TYPE_SEGMENT,this.colorsSampling=null!==(f=i.colorsSampling)&&void 0!==f?f:Mr.NEAREST_NEAREST,this._colors=null!==(m=i.colors)&&void 0!==m?m:null,this.dashCount=null!==(g=i.dashCount)&&void 0!==g?g:1,this.resolution=null!==(v=i.resolution)&&void 0!==v?v:new E(this._engine.getRenderWidth(),this._engine.getRenderHeight()),i.colorsTexture?this.colorsTexture=i.colorsTexture:this._colors?this.colorsTexture=yf.CreateColorsTexture(`${e.name}-colors-texture`,this._colors,this.colorsSampling,this._scene):(this._color=null!==(x=this._color)&&void 0!==x?x:Cf.DEFAULT_COLOR,yf.PrepareEmptyColorsTexture(this._scene)),this._engine.onDisposeObservable.add((()=>{yf.DisposeEmptyColorsTexture()})),this._enable(!0)}getAttributes(e){e.push("grl_offsets"),e.push("grl_widths"),e.push("grl_colorPointers"),e.push("grl_counters"),this._cameraFacing?(e.push("grl_previousAndSide"),e.push("grl_nextAndCounters")):e.push("grl_slopes")}getSamplers(e){e.push("grl_colors")}getActiveTextures(e){this.colorsTexture&&e.push(this.colorsTexture)}getUniforms(){const e=[{name:"grl_singleColor",size:3,type:"vec3"},{name:"grl_dashOptions",size:4,type:"vec4"},{name:"grl_colorMode_visibility_colorsWidth_useColors",size:4,type:"vec4"}];return this._cameraFacing&&e.push({name:"grl_projection",size:16,type:"mat4"},{name:"grl_aspect_resolution_lineWidth",size:4,type:"vec4"}),{ubo:e,vertex:this._cameraFacing?"\n                uniform vec4 grl_aspect_resolution_lineWidth;\n                uniform mat4 grl_projection;\n                ":"",fragment:"\n                uniform vec4 grl_dashOptions;\n                uniform vec4 grl_colorMode_visibility_colorsWidth_useColors;\n                uniform vec3 grl_singleColor;\n                "}}get isEnabled(){return!0}bindForSubMesh(e){var t;if(this._cameraFacing){const t=this._scene.activeCamera;if(!t)throw Error("GreasedLinePluginMaterial requires an active camera.");{const i=t.getProjectionMatrix();e.updateMatrix("grl_projection",i)}const i=R.Vector4[0];i.x=this._aspect,i.y=this._resolution.x,i.z=this._resolution.y,i.w=this.width,e.updateVector4("grl_aspect_resolution_lineWidth",i)}const i=R.Vector4[0];i.x=yf.BooleanToNumber(this.useDash),i.y=this._dashArray,i.z=this.dashOffset,i.w=this.dashRatio,e.updateVector4("grl_dashOptions",i);const s=R.Vector4[1];s.x=this.colorMode,s.y=this.visibility,s.z=this.colorsTexture?this.colorsTexture.getSize().width:0,s.w=yf.BooleanToNumber(this.useColors),e.updateVector4("grl_colorMode_visibility_colorsWidth_useColors",s),this._color&&e.updateColor3("grl_singleColor",this._color),e.setTexture("grl_colors",null!==(t=this.colorsTexture)&&void 0!==t?t:Cf.EmptyColorsTexture)}prepareDefines(e,t,i){e.GREASED_LINE_HAS_COLOR=!!this.color&&!this.useColors,e.GREASED_LINE_SIZE_ATTENUATION=this._sizeAttenuation,e.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=this._colorsDistributionType===gf.COLOR_DISTRIBUTION_TYPE_LINE,e.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=t.useRightHandedSystem,e.GREASED_LINE_CAMERA_FACING=this._cameraFacing}getClassName(){return Rf.GREASED_LINE_MATERIAL_NAME}getCustomCode(e){if("vertex"===e){const e={CUSTOM_VERTEX_DEFINITIONS:"\n                attribute float grl_widths;\n                attribute vec3 grl_offsets;\n                attribute float grl_colorPointers;\n\n                varying float grlCounters;\n                varying float grlColorPointer;\n\n                #ifdef GREASED_LINE_CAMERA_FACING\n                    attribute vec4 grl_previousAndSide;\n                    attribute vec4 grl_nextAndCounters;\n\n                    vec2 grlFix( vec4 i, float aspect ) {\n                        vec2 res = i.xy / i.w;\n                        res.x *= aspect;\n                        return res;\n                    }\n                #else\n                    attribute vec3 grl_slopes;\n                    attribute float grl_counters;\n                #endif\n                ",CUSTOM_VERTEX_UPDATE_POSITION:"\n                #ifdef GREASED_LINE_CAMERA_FACING\n                    vec3 grlPositionOffset = grl_offsets;\n                    positionUpdated += grlPositionOffset;\n                #else\n                    positionUpdated = (positionUpdated + grl_offsets) + (grl_slopes * grl_widths);\n                #endif\n                ",CUSTOM_VERTEX_MAIN_END:"\n                grlColorPointer = grl_colorPointers;\n\n                #ifdef GREASED_LINE_CAMERA_FACING\n\n                    float grlAspect = grl_aspect_resolution_lineWidth.x;\n                    float grlBaseWidth = grl_aspect_resolution_lineWidth.w;\n\n\n                    vec3 grlPrevious = grl_previousAndSide.xyz;\n                    float grlSide = grl_previousAndSide.w;\n\n                    vec3 grlNext = grl_nextAndCounters.xyz;\n                    grlCounters = grl_nextAndCounters.w;\n\n                    mat4 grlMatrix = viewProjection * finalWorld;\n                    vec4 grlFinalPosition = grlMatrix * vec4( positionUpdated , 1.0 );\n                    vec4 grlPrevPos = grlMatrix * vec4( grlPrevious + grlPositionOffset, 1.0 );\n                    vec4 grlNextPos = grlMatrix * vec4( grlNext + grlPositionOffset, 1.0 );\n\n                    vec2 grlCurrentP = grlFix( grlFinalPosition, grlAspect );\n                    vec2 grlPrevP = grlFix( grlPrevPos, grlAspect );\n                    vec2 grlNextP = grlFix( grlNextPos, grlAspect );\n\n                    float grlWidth = grlBaseWidth * grl_widths;\n\n                    vec2 grlDir;\n                    if( grlNextP == grlCurrentP ) grlDir = normalize( grlCurrentP - grlPrevP );\n                    else if( grlPrevP == grlCurrentP ) grlDir = normalize( grlNextP - grlCurrentP );\n                    else {\n                        vec2 grlDir1 = normalize( grlCurrentP - grlPrevP );\n                        vec2 grlDir2 = normalize( grlNextP - grlCurrentP );\n                        grlDir = normalize( grlDir1 + grlDir2 );\n                    }\n                    vec4 grlNormal = vec4( -grlDir.y, grlDir.x, 0., 1. );\n                    #ifdef GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM\n                        grlNormal.xy *= -.5 * grlWidth;\n                    #else\n                        grlNormal.xy *= .5 * grlWidth;\n                    #endif\n\n                    grlNormal *= grl_projection;\n\n                    #ifdef GREASED_LINE_SIZE_ATTENUATION\n                        grlNormal.xy *= grlFinalPosition.w;\n                        grlNormal.xy /= ( vec4( grl_aspect_resolution_lineWidth.yz, 0., 1. ) * grl_projection ).xy;\n                    #endif\n\n                    grlFinalPosition.xy += grlNormal.xy * grlSide;\n                    gl_Position = grlFinalPosition;\n\n                    vPositionW = vec3(grlFinalPosition);\n                #else\n                    grlCounters = grl_counters;\n                #endif\n                "};return this._cameraFacing&&(e["!gl_Position\\=viewProjection\\*worldPos;"]="//"),e}return"fragment"===e?{CUSTOM_FRAGMENT_DEFINITIONS:"\n                    varying float grlCounters;\n                    varying float grlColorPointer;\n                    uniform sampler2D grl_colors;\n                ",CUSTOM_FRAGMENT_MAIN_END:`\n                    float grlColorMode = grl_colorMode_visibility_colorsWidth_useColors.x;\n                    float grlVisibility = grl_colorMode_visibility_colorsWidth_useColors.y;\n                    float grlColorsWidth = grl_colorMode_visibility_colorsWidth_useColors.z;\n                    float grlUseColors = grl_colorMode_visibility_colorsWidth_useColors.w;\n\n                    float grlUseDash = grl_dashOptions.x;\n                    float grlDashArray = grl_dashOptions.y;\n                    float grlDashOffset = grl_dashOptions.z;\n                    float grlDashRatio = grl_dashOptions.w;\n\n                    gl_FragColor.a *= step(grlCounters, grlVisibility);\n                    if( gl_FragColor.a == 0. ) discard;\n\n                    if(grlUseDash == 1.){\n                        gl_FragColor.a *= ceil(mod(grlCounters + grlDashOffset, grlDashArray) - (grlDashArray * grlDashRatio));\n                        if (gl_FragColor.a == 0.) discard;\n                    }\n\n                    #ifdef GREASED_LINE_HAS_COLOR\n                        if (grlColorMode == ${mf.COLOR_MODE_SET}.) {\n                            gl_FragColor.rgb = grl_singleColor;\n                        } else if (grlColorMode == ${mf.COLOR_MODE_ADD}.) {\n                            gl_FragColor.rgb += grl_singleColor;\n                        } else if (grlColorMode == ${mf.COLOR_MODE_MULTIPLY}.) {\n                            gl_FragColor.rgb *= grl_singleColor;\n                        }\n                    #else\n                        if (grlUseColors == 1.) {\n                            #ifdef GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE\n                                vec4 grlColor = texture2D(grl_colors, vec2(grlCounters, 0.), 0.);\n                            #else\n                                vec4 grlColor = texture2D(grl_colors, vec2(grlColorPointer/grlColorsWidth, 0.), 0.);\n                            #endif\n                            if (grlColorMode == ${mf.COLOR_MODE_SET}.) {\n                                gl_FragColor = grlColor;\n                            } else if (grlColorMode == ${mf.COLOR_MODE_ADD}.) {\n                                gl_FragColor += grlColor;\n                            } else if (grlColorMode == ${mf.COLOR_MODE_MULTIPLY}.) {\n                                gl_FragColor *= grlColor;\n                            }\n                        }\n                    #endif\n\n                `}:null}dispose(){var e;null===(e=this.colorsTexture)||void 0===e||e.dispose(),super.dispose()}get colors(){return this._colors}set colors(e){this.setColors(e)}setColors(e,t=!1,i=!1){var s,r,n,o;const a=null!==(r=null===(s=this._colors)||void 0===s?void 0:s.length)&&void 0!==r?r:0;if(this._colors=e,null!==e&&0!==e.length){if(!t||i)if(this.colorsTexture&&a===e.length&&!i){const t=yf.Color3toRGBAUint8(e);this.colorsTexture.update(t)}else null===(o=this.colorsTexture)||void 0===o||o.dispose(),this.colorsTexture=yf.CreateColorsTexture(`${this._material.name}-colors-texture`,e,this.colorsSampling,this._scene)}else null===(n=this.colorsTexture)||void 0===n||n.dispose()}updateLazy(){this._colors&&this.setColors(this._colors,!1,!0)}get dashCount(){return this._dashCount}set dashCount(e){this._dashCount=e,this._dashArray=1/e}get sizeAttenuation(){return this._sizeAttenuation}set sizeAttenuation(e){this._sizeAttenuation=e,this.markAllDefinesAsDirty()}get color(){return this._color}set color(e){this.setColor(e)}setColor(e,t=!1){null===this._color&&null!==e||null!==this._color&&null===e?(this._color=e,!t&&this.markAllDefinesAsDirty()):this._color=e}get colorsDistributionType(){return this._colorsDistributionType}set colorsDistributionType(e){this._colorsDistributionType=e,this.markAllDefinesAsDirty()}get resolution(){return this._resolution}set resolution(e){this._aspect=e.x/e.y,this._resolution=e}serialize(){const e=super.serialize(),t={colorDistributionType:this._colorsDistributionType,colorsSampling:this.colorsSampling,colorMode:this.colorMode,dashCount:this._dashCount,dashOffset:this.dashOffset,dashRatio:this.dashRatio,resolution:this._resolution,sizeAttenuation:this._sizeAttenuation,useColors:this.useColors,useDash:this.useDash,visibility:this.visibility,width:this.width};return this._colors&&(t.colors=this._colors),this._color&&(t.color=this._color),e.greasedLineMaterialOptions=t,e}parse(e,t,i){var s;super.parse(e,t,i);const r=e.greasedLineMaterialOptions;null===(s=this.colorsTexture)||void 0===s||s.dispose(),r.color&&this.setColor(r.color,!0),r.colorDistributionType&&(this.colorsDistributionType=r.colorDistributionType),r.colors&&(this.colors=r.colors),r.colorsSampling&&(this.colorsSampling=r.colorsSampling),r.colorMode&&(this.colorMode=r.colorMode),r.useColors&&(this.useColors=r.useColors),r.visibility&&(this.visibility=r.visibility),r.useDash&&(this.useDash=r.useDash),r.dashCount&&(this.dashCount=r.dashCount),r.dashRatio&&(this.dashRatio=r.dashRatio),r.dashOffset&&(this.dashOffset=r.dashOffset),r.width&&(this.width=r.width),r.sizeAttenuation&&(this.sizeAttenuation=r.sizeAttenuation),r.resolution&&(this.resolution=r.resolution),this.colors?this.colorsTexture=yf.CreateColorsTexture(`${this._material.name}-colors-texture`,this.colors,this.colorsSampling,t):yf.PrepareEmptyColorsTexture(t),this.markAllDefinesAsDirty()}copyTo(e){var t;const i=e;null===(t=i.colorsTexture)||void 0===t||t.dispose(),this._colors&&(i.colorsTexture=yf.CreateColorsTexture(`${i._material.name}-colors-texture`,this._colors,i.colorsSampling,this._scene)),i.setColor(this.color,!0),i.colorsDistributionType=this.colorsDistributionType,i.colorsSampling=this.colorsSampling,i.colorMode=this.colorMode,i.useColors=this.useColors,i.visibility=this.visibility,i.useDash=this.useDash,i.dashCount=this.dashCount,i.dashRatio=this.dashRatio,i.dashOffset=this.dashOffset,i.width=this.width,i.sizeAttenuation=this.sizeAttenuation,i.resolution=this.resolution,i.markAllDefinesAsDirty()}}Rf.GREASED_LINE_MATERIAL_NAME="GreasedLinePluginMaterial",m(`BABYLON.${Rf.GREASED_LINE_MATERIAL_NAME}`,Rf);nt.ShadersStore.greasedLinePixelShader="precision highp float;uniform sampler2D grlColors;uniform float grlUseColors;uniform float grlUseDash;uniform float grlDashArray;uniform float grlDashOffset;uniform float grlDashRatio;uniform float grlVisibility;uniform float grlColorsWidth;uniform vec2 grl_colorModeAndColorDistributionType;uniform vec3 grlColor;varying float grlCounters;varying float grlColorPointer;void main() {float grlColorMode=grl_colorModeAndColorDistributionType.x;float grlColorDistributionType=grl_colorModeAndColorDistributionType.y;gl_FragColor=vec4(grlColor,1.);gl_FragColor.a=step(grlCounters,grlVisibility);if (gl_FragColor.a==0.) discard;if( grlUseDash==1. ){gl_FragColor.a=ceil(mod(grlCounters+grlDashOffset,grlDashArray)-(grlDashArray*grlDashRatio));if (gl_FragColor.a==0.) discard;}\nif (grlUseColors==1.) {vec4 textureColor;if (grlColorDistributionType==COLOR_DISTRIBUTION_TYPE_LINE) { \ntextureColor=texture2D(grlColors,vec2(grlCounters,0.),0.);} else {textureColor=texture2D(grlColors,vec2(grlColorPointer/grlColorsWidth,0.),0.);}\nif (grlColorMode==COLOR_MODE_SET) {gl_FragColor=textureColor;} else if (grlColorMode==COLOR_MODE_ADD) {gl_FragColor+=textureColor;} else if (grlColorMode==COLOR_MODE_MULTIPLY) {gl_FragColor*=textureColor;}}}\n";nt.ShadersStore.greasedLineVertexShader="precision highp float;\n#include<instancesDeclaration>\nattribute float grl_widths;attribute vec3 grl_offsets;attribute float grl_colorPointers;attribute vec3 position;uniform mat4 viewProjection;uniform mat4 projection;varying float grlCounters;varying float grlColorPointer;\n#ifdef GREASED_LINE_CAMERA_FACING\nattribute vec4 grl_nextAndCounters;attribute vec4 grl_previousAndSide;uniform vec2 grlResolution;uniform float grlAspect;uniform float grlWidth;uniform float grlSizeAttenuation;vec2 grlFix( vec4 i,float aspect ) {vec2 res=i.xy/i.w;res.x*=aspect;return res;}\n#else\nattribute vec3 grl_slopes;attribute float grl_counters;\n#endif\nvoid main() {\n#include<instancesVertex>\ngrlColorPointer=grl_colorPointers;\n#ifdef GREASED_LINE_CAMERA_FACING\nfloat grlBaseWidth=grlWidth;vec3 grlPrevious=grl_previousAndSide.xyz;float grlSide=grl_previousAndSide.w;vec3 grlNext=grl_nextAndCounters.xyz;grlCounters=grl_nextAndCounters.w;mat4 grlMatrix=viewProjection*finalWorld ;vec3 grlPositionOffset=grl_offsets;vec4 grlFinalPosition=grlMatrix*vec4( position+grlPositionOffset ,1.0 );vec4 grlPrevPos=grlMatrix*vec4( grlPrevious+grlPositionOffset,1.0 );vec4 grlNextPos=grlMatrix*vec4( grlNext+grlPositionOffset,1.0 );vec2 grlCurrentP=grlFix( grlFinalPosition,grlAspect );vec2 grlPrevP=grlFix( grlPrevPos,grlAspect );vec2 grlNextP=grlFix( grlNextPos,grlAspect );float grlWidth=grlBaseWidth*grl_widths;vec2 grlDir;if( grlNextP==grlCurrentP ) grlDir=normalize( grlCurrentP-grlPrevP );else if( grlPrevP==grlCurrentP ) grlDir=normalize( grlNextP-grlCurrentP );else {vec2 grlDir1=normalize( grlCurrentP-grlPrevP );vec2 grlDir2=normalize( grlNextP-grlCurrentP );grlDir=normalize( grlDir1+grlDir2 );}\nvec4 grlNormal=vec4( -grlDir.y,grlDir.x,0.,1. );\n#ifdef GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM\ngrlNormal.xy*=-.5*grlWidth;\n#else\ngrlNormal.xy*=.5*grlWidth;\n#endif\ngrlNormal*=projection;if (grlSizeAttenuation==1.) {grlNormal.xy*=grlFinalPosition.w;grlNormal.xy/=( vec4( grlResolution,0.,1. )*projection ).xy;}\ngrlFinalPosition.xy+=grlNormal.xy*grlSide;gl_Position=grlFinalPosition;\n#else\ngrlCounters=grl_counters;vec4 grlFinalPosition=worldViewProjection*vec4( (position+grl_offsets)+grl_slopes*grl_widths ,1.0 ) ;gl_Position=grlFinalPosition;\n#endif\n}\n";class If extends kl{constructor(e,t,i){var s,r,n,o,a,l,h,c,u,d,p,_,f,m;const g=[`COLOR_DISTRIBUTION_TYPE_LINE ${gf.COLOR_DISTRIBUTION_TYPE_LINE}.`,`COLOR_DISTRIBUTION_TYPE_SEGMENT ${gf.COLOR_DISTRIBUTION_TYPE_SEGMENT}.`,`COLOR_MODE_SET ${mf.COLOR_MODE_SET}.`,`COLOR_MODE_ADD ${mf.COLOR_MODE_ADD}.`,`COLOR_MODE_MULTIPLY ${mf.COLOR_MODE_MULTIPLY}.`],v=["position","grl_widths","grl_offsets","grl_colorPointers"];t.useRightHandedSystem&&g.push("GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM"),i.cameraFacing?(g.push("GREASED_LINE_CAMERA_FACING"),v.push("grl_previousAndSide","grl_nextAndCounters")):(v.push("grl_slopes"),v.push("grl_counters")),super(e,t,{vertex:"greasedLine",fragment:"greasedLine"},{attributes:v,uniforms:["world","viewProjection","view","projection","grlColorsWidth","grlUseColors","grlWidth","grlColor","grl_colorModeAndColorDistributionType","grlResolution","grlAspect","grlAizeAttenuation","grlDashArray","grlDashOffset","grlDashRatio","grlUseDash","grlVisibility"],samplers:["grlColors"],defines:g}),this._color=N.White(),this._colorsDistributionType=gf.COLOR_DISTRIBUTION_TYPE_SEGMENT,this._colorsTexture=null,i=i||{color:Cf.DEFAULT_COLOR};const x=t.getEngine();this.visibility=null!==(s=i.visibility)&&void 0!==s?s:1,this.useDash=null!==(r=i.useDash)&&void 0!==r&&r,this.dashRatio=null!==(n=i.dashRatio)&&void 0!==n?n:.5,this.dashOffset=null!==(o=i.dashOffset)&&void 0!==o?o:0,this.dashCount=null!==(a=i.dashCount)&&void 0!==a?a:1,this.width=i.width?i.width:i.sizeAttenuation&&i.cameraFacing?Cf.DEFAULT_WIDTH_ATTENUATED:Cf.DEFAULT_WIDTH,this.sizeAttenuation=null!==(l=i.sizeAttenuation)&&void 0!==l&&l,this.color=null!==(h=i.color)&&void 0!==h?h:N.White(),this.useColors=null!==(c=i.useColors)&&void 0!==c&&c,this.colorsDistributionType=null!==(u=i.colorDistributionType)&&void 0!==u?u:gf.COLOR_DISTRIBUTION_TYPE_SEGMENT,this.colorsSampling=null!==(d=i.colorsSampling)&&void 0!==d?d:Mr.NEAREST_NEAREST,this.colorMode=null!==(p=i.colorMode)&&void 0!==p?p:mf.COLOR_MODE_SET,this._colors=null!==(_=i.colors)&&void 0!==_?_:null,this._cameraFacing=null===(f=i.cameraFacing)||void 0===f||f,this.resolution=null!==(m=i.resolution)&&void 0!==m?m:new E(x.getRenderWidth(),x.getRenderHeight()),i.colorsTexture?this.colorsTexture=i.colorsTexture:this.colorsTexture=yf.PrepareEmptyColorsTexture(t),this._colors&&this.setColors(this._colors),x.onDisposeObservable.add((()=>{yf.DisposeEmptyColorsTexture()}))}dispose(){var e;null===(e=this._colorsTexture)||void 0===e||e.dispose(),super.dispose()}_setColorModeAndColorDistributionType(){this.setVector2("grl_colorModeAndColorDistributionType",new E(this._colorMode,this._colorsDistributionType))}updateLazy(){this._colors&&this.setColors(this._colors,!1,!0)}get colors(){return this._colors}set colors(e){this.setColors(e)}setColors(e,t=!1,i=!1){var s,r,n,o;const a=null!==(r=null===(s=this._colors)||void 0===s?void 0:s.length)&&void 0!==r?r:0;if(this._colors=e,null!==e&&0!==e.length){if(!t||i)if(this._colorsTexture&&a===e.length&&!i){const t=yf.Color3toRGBAUint8(e);this._colorsTexture.update(t)}else null===(o=this._colorsTexture)||void 0===o||o.dispose(),this.colorsTexture=yf.CreateColorsTexture(`${this.name}-colors-texture`,e,this.colorsSampling,this.getScene())}else null===(n=this._colorsTexture)||void 0===n||n.dispose()}get colorsTexture(){var e;return null!==(e=this._colorsTexture)&&void 0!==e?e:null}set colorsTexture(e){this._colorsTexture=e,this.setFloat("grlColorsWidth",this._colorsTexture.getSize().width),this.setTexture("grlColors",this._colorsTexture)}get width(){return this._width}set width(e){this._width=e,this.setFloat("grlWidth",e)}get useColors(){return this._useColors}set useColors(e){this._useColors=e,this.setFloat("grlUseColors",yf.BooleanToNumber(e))}get colorsSampling(){return this._colorsSampling}set colorsSampling(e){this._colorsSampling=e}get visibility(){return this._visibility}set visibility(e){this._visibility=e,this.setFloat("grlVisibility",e)}get useDash(){return this._useDash}set useDash(e){this._useDash=e,this.setFloat("grlUseDash",yf.BooleanToNumber(e))}get dashOffset(){return this._dashOffset}set dashOffset(e){this._dashOffset=e,this.setFloat("grlDashOffset",e)}get dashRatio(){return this._dashRatio}set dashRatio(e){this._dashRatio=e,this.setFloat("grlDashRatio",e)}get dashCount(){return this._dashCount}set dashCount(e){this._dashCount=e,this._dashArray=1/e,this.setFloat("grlDashArray",this._dashArray)}get sizeAttenuation(){return this._sizeAttenuation}set sizeAttenuation(e){this._sizeAttenuation=e,this.setFloat("grlSizeAttenuation",yf.BooleanToNumber(e))}get color(){return this.color}set color(e){this.setColor(e)}setColor(e){e=null!=e?e:Cf.DEFAULT_COLOR,this._color=e,this.setColor3("grlColor",e)}get colorsDistributionType(){return this._colorsDistributionType}set colorsDistributionType(e){this._colorsDistributionType=e,this._setColorModeAndColorDistributionType()}get colorMode(){return this._colorMode}set colorMode(e){this._colorMode=e,this._setColorModeAndColorDistributionType()}get resolution(){return this._resolution}set resolution(e){this._resolution=e,this.setVector2("grlResolution",e),this.setFloat("grlAspect",e.x/e.y)}serialize(){const e=super.serialize(),t={colorDistributionType:this._colorsDistributionType,colorsSampling:this._colorsSampling,colorMode:this._colorMode,color:this._color,dashCount:this._dashCount,dashOffset:this._dashOffset,dashRatio:this._dashRatio,resolution:this._resolution,sizeAttenuation:this._sizeAttenuation,useColors:this._useColors,useDash:this._useDash,visibility:this._visibility,width:this._width,cameraFacing:this._cameraFacing};return this._colors&&(t.colors=this._colors),e.greasedLineMaterialOptions=t,e}parse(e,t,i){var s,r;const n=e.greasedLineMaterialOptions;null===(s=this._colorsTexture)||void 0===s||s.dispose(),n.color&&(this.color=n.color),n.colorDistributionType&&(this.colorsDistributionType=n.colorDistributionType),n.colorsSampling&&(this.colorsSampling=n.colorsSampling),n.colorMode&&(this.colorMode=n.colorMode),n.useColors&&(this.useColors=n.useColors),n.visibility&&(this.visibility=n.visibility),n.useDash&&(this.useDash=n.useDash),n.dashCount&&(this.dashCount=n.dashCount),n.dashRatio&&(this.dashRatio=n.dashRatio),n.dashOffset&&(this.dashOffset=n.dashOffset),n.width&&(this.width=n.width),n.sizeAttenuation&&(this.sizeAttenuation=n.sizeAttenuation),n.resolution&&(this.resolution=n.resolution),n.colors?this.colorsTexture=yf.CreateColorsTexture(`${this.name}-colors-texture`,n.colors,this.colorsSampling,this.getScene()):this.colorsTexture=yf.PrepareEmptyColorsTexture(t),this._cameraFacing=null===(r=n.cameraFacing)||void 0===r||r,this.setDefine("GREASED_LINE_CAMERA_FACING",this._cameraFacing)}}const Pf=[new N(.98,.26,.38),new N(.47,.75,.3),new N(0,.26,.77),new N(.97,.6,.76),new N(.19,.63,.78),new N(.98,.8,.6),new N(.65,.43,.15),new N(.15,.47,.22),new N(.67,.71,.86),new N(.09,.46,.56),new N(.8,.98,.02),new N(.39,.29,.13),new N(.53,.63,.06),new N(.95,.96,.41),new N(1,.72,.94),new N(.63,.08,.31),new N(.66,.96,.95),new N(.22,.14,.19),new N(.14,.65,.59),new N(.93,1,.68),new N(.93,.14,.44),new N(.47,.86,.67),new N(.85,.07,.78),new N(.53,.64,.98),new N(.43,.37,.56),new N(.71,.65,.25),new N(.66,.19,.01),new N(.94,.53,.12),new N(.41,.44,.44),new N(.24,.71,.96),new N(.57,.28,.56),new N(.44,.98,.42)];var Mf;!function(e){e[e.NONE=0]="NONE",e[e.TRIANGLES=1]="TRIANGLES",e[e.VERTICES=2]="VERTICES",e[e.TRIANGLES_VERTICES=3]="TRIANGLES_VERTICES",e[e.UV0=4]="UV0",e[e.UV1=5]="UV1",e[e.VERTEXCOLORS=6]="VERTEXCOLORS",e[e.MATERIALIDS=7]="MATERIALIDS"}(Mf||(Mf={}));class Of extends $t{constructor(){super(...arguments),this.DBG_MODE=Mf.NONE,this.DBG_MULTIPLY=!0,this.DBG_ENABLED=!0}}class Df extends Fa{_markAllDefinesAsDirty(){this._enable(this._isEnabled),this.markAllDefinesAsDirty()}constructor(e,t={}){var i,s,r,n,o,a,l,h,c,u,d,p,_;const f=new Of;f.DBG_MODE=null!==(i=t.mode)&&void 0!==i?i:f.DBG_MODE,f.DBG_MULTIPLY=null!==(s=t.multiply)&&void 0!==s?s:f.DBG_MULTIPLY,super(e,"MeshDebug",200,f,!0,!0),this._mode=f.DBG_MODE,this._multiply=f.DBG_MULTIPLY,this.shadedDiffuseColor=null!==(r=t.shadedDiffuseColor)&&void 0!==r?r:new N(1,1,1),this.shadedSpecularColor=null!==(n=t.shadedSpecularColor)&&void 0!==n?n:new N(.8,.8,.8),this.shadedSpecularPower=null!==(o=t.shadedSpecularPower)&&void 0!==o?o:10,this.wireframeThickness=null!==(a=t.wireframeThickness)&&void 0!==a?a:.7,this.wireframeTrianglesColor=null!==(l=t.wireframeTrianglesColor)&&void 0!==l?l:new N(0,0,0),this.wireframeVerticesColor=null!==(h=t.wireframeVerticesColor)&&void 0!==h?h:new N(.8,.8,.8),this.vertexColor=null!==(c=t.vertexColor)&&void 0!==c?c:new N(0,0,0),this.vertexRadius=null!==(u=t.vertexRadius)&&void 0!==u?u:1.2,this.uvScale=null!==(d=t.uvScale)&&void 0!==d?d:20,this.uvPrimaryColor=null!==(p=t.uvPrimaryColor)&&void 0!==p?p:new N(1,1,1),this.uvSecondaryColor=null!==(_=t.uvSecondaryColor)&&void 0!==_?_:new N(.5,.5,.5),this._materialColor=Df.MaterialColors[Df._PluginCount++%Df.MaterialColors.length],this.isEnabled=!0}getClassName(){return"MeshDebugPluginMaterial"}get isEnabled(){return this._isEnabled}set isEnabled(e){if(this._isEnabled!==e){if(!this._material.getScene().getEngine().isWebGPU&&1==this._material.getScene().getEngine().webGLVersion)return k.Error("MeshDebugPluginMaterial is not supported on WebGL 1.0."),void(this._isEnabled=!1);this._isEnabled=e,this._markAllDefinesAsDirty()}}prepareDefines(e,t,i){this._mode!=Mf.VERTICES&&this._mode!=Mf.TRIANGLES&&this._mode!=Mf.TRIANGLES_VERTICES||i.isVerticesDataPresent("dbg_initialPass")||k.Warn("For best results with TRIANGLES, TRIANGLES_VERTICES, or VERTICES modes, please use MeshDebugPluginMaterial.PrepareMeshForTrianglesAndVerticesMode() on mesh.",1),e.DBG_MODE=this._mode,e.DBG_MULTIPLY=this._multiply,e.DBG_ENABLED=this._isEnabled}getAttributes(e){e.push("dbg_initialPass")}getUniforms(){return{ubo:[{name:"dbg_shadedDiffuseColor",size:3,type:"vec3"},{name:"dbg_shadedSpecularColorPower",size:4,type:"vec4"},{name:"dbg_thicknessRadiusScale",size:3,type:"vec3"},{name:"dbg_wireframeTrianglesColor",size:3,type:"vec3"},{name:"dbg_wireframeVerticesColor",size:3,type:"vec3"},{name:"dbg_vertexColor",size:3,type:"vec3"},{name:"dbg_uvPrimaryColor",size:3,type:"vec3"},{name:"dbg_uvSecondaryColor",size:3,type:"vec3"},{name:"dbg_materialColor",size:3,type:"vec3"}],fragment:"#if defined(DBG_ENABLED)\nuniform vec3 dbg_shadedDiffuseColor;\nuniform vec4 dbg_shadedSpecularColorPower;\nuniform vec3 dbg_thicknessRadiusScale;\n\n#if DBG_MODE == 2 || DBG_MODE == 3\n    uniform vec3 dbg_vertexColor;\n#endif\n\n#if DBG_MODE == 1\n    uniform vec3 dbg_wireframeTrianglesColor;\n#elif DBG_MODE == 3\n    uniform vec3 dbg_wireframeVerticesColor;\n#elif DBG_MODE == 4 || DBG_MODE == 5\n    uniform vec3 dbg_uvPrimaryColor;\n    uniform vec3 dbg_uvSecondaryColor;\n#elif DBG_MODE == 7\n    uniform vec3 dbg_materialColor;\n#endif\n#endif"}}bindForSubMesh(e){this._isEnabled&&(e.updateFloat3("dbg_shadedDiffuseColor",this.shadedDiffuseColor.r,this.shadedDiffuseColor.g,this.shadedDiffuseColor.b),e.updateFloat4("dbg_shadedSpecularColorPower",this.shadedSpecularColor.r,this.shadedSpecularColor.g,this.shadedSpecularColor.b,this.shadedSpecularPower),e.updateFloat3("dbg_thicknessRadiusScale",this.wireframeThickness,this.vertexRadius,this.uvScale),e.updateColor3("dbg_wireframeTrianglesColor",this.wireframeTrianglesColor),e.updateColor3("dbg_wireframeVerticesColor",this.wireframeVerticesColor),e.updateColor3("dbg_vertexColor",this.vertexColor),e.updateColor3("dbg_uvPrimaryColor",this.uvPrimaryColor),e.updateColor3("dbg_uvSecondaryColor",this.uvSecondaryColor),e.updateColor3("dbg_materialColor",this._materialColor))}getCustomCode(e){return"vertex"===e?{CUSTOM_VERTEX_DEFINITIONS:"#if defined(DBG_ENABLED)\nattribute float dbg_initialPass;\nvarying vec3 dbg_vBarycentric;\nflat varying vec3 dbg_vVertexWorldPos;\nflat varying float dbg_vPass;\n#endif",CUSTOM_VERTEX_MAIN_END:"#if defined(DBG_ENABLED)\nfloat dbg_vertexIndex = mod(float(gl_VertexID), 3.);\nif (dbg_vertexIndex == 0.0) { \n    dbg_vBarycentric = vec3(1.,0.,0.); \n}\nelse if (dbg_vertexIndex == 1.0) { \n    dbg_vBarycentric = vec3(0.,1.,0.); \n}\nelse { \n    dbg_vBarycentric = vec3(0.,0.,1.); \n}\n\ndbg_vVertexWorldPos = vPositionW;\ndbg_vPass = dbg_initialPass;\n#endif"}:{CUSTOM_FRAGMENT_DEFINITIONS:"#if defined(DBG_ENABLED)\nvarying vec3 dbg_vBarycentric;\nflat varying vec3 dbg_vVertexWorldPos;\nflat varying float dbg_vPass;\n\n#if !defined(DBG_MULTIPLY)\n    vec3 dbg_applyShading(vec3 color) {\n        vec3 N = vNormalW.xyz;\n        vec3 L = normalize(vEyePosition.xyz - vPositionW.xyz);\n        vec3 H = normalize(L + L);\n        float LdotN = clamp(dot(L,N), 0., 1.);\n        float HdotN = clamp(dot(H,N), 0., 1.);\n        float specTerm = pow(HdotN, dbg_shadedSpecularColorPower.w);\n        color *= (LdotN / PI);\n        color += dbg_shadedSpecularColorPower.rgb * (specTerm / PI);\n        return color;\n    }\n#endif\n\n#if DBG_MODE == 1 || DBG_MODE == 3\n    float dbg_edgeFactor() {\n        vec3 d = fwidth(dbg_vBarycentric);\n        vec3 a3 = smoothstep(vec3(0.), d * dbg_thicknessRadiusScale.x, dbg_vBarycentric);\n        return min(min(a3.x, a3.y), a3.z);\n    }\n#endif\n\n#if DBG_MODE == 2 || DBG_MODE == 3\n    float dbg_cornerFactor() {\n        vec3 worldPos = vPositionW;\n        float dist = length(worldPos - dbg_vVertexWorldPos);\n        float camDist = length(worldPos - vEyePosition.xyz);\n        float d = sqrt(camDist) * .001;\n        return smoothstep((dbg_thicknessRadiusScale.y * d), ((dbg_thicknessRadiusScale.y * 1.01) * d), dist);\n    }\n#endif\n\n#if (DBG_MODE == 4 && defined(UV1)) || (DBG_MODE == 5 && defined(UV2))\n    float dbg_checkerboardFactor(vec2 uv) {\n        vec2 f = fract(uv * dbg_thicknessRadiusScale.z);\n        f -= .5;\n        return (f.x * f.y) > 0. ? 1. : 0.;\n    }\n#endif\n#endif",CUSTOM_FRAGMENT_MAIN_END:"#if defined(DBG_ENABLED)\nvec3 dbg_color = vec3(1.);\n#if DBG_MODE == 1\n    dbg_color = mix(dbg_wireframeTrianglesColor, vec3(1.), dbg_edgeFactor());\n#elif DBG_MODE == 2 || DBG_MODE == 3\n    float dbg_cornerFactor = dbg_cornerFactor();\n    if (dbg_vPass == 0. && dbg_cornerFactor == 1.) discard;\n    dbg_color = mix(dbg_vertexColor, vec3(1.), dbg_cornerFactor);\n    #if DBG_MODE == 3\n        dbg_color *= mix(dbg_wireframeVerticesColor, vec3(1.), dbg_edgeFactor());\n    #endif\n#elif DBG_MODE == 4 && defined(UV1)\n    dbg_color = mix(dbg_uvPrimaryColor, dbg_uvSecondaryColor, dbg_checkerboardFactor(vMainUV1));\n#elif DBG_MODE == 5 && defined(UV2)\n    dbg_color = mix(dbg_uvPrimaryColor, dbg_uvSecondaryColor, dbg_checkerboardFactor(vMainUV2));\n#elif DBG_MODE == 6 && defined(VERTEXCOLOR)\n    dbg_color = vColor.rgb;\n#elif DBG_MODE == 7\n    dbg_color = dbg_materialColor;\n#endif\n\n#if defined(DBG_MULTIPLY)\n    gl_FragColor *= vec4(dbg_color, 1.);\n#else\n    #if DBG_MODE != 6\n        gl_FragColor = vec4(dbg_applyShading(dbg_shadedDiffuseColor) * dbg_color, 1.);\n    #else\n        gl_FragColor = vec4(dbg_color, 1.);\n    #endif\n#endif\n#endif"}}static Reset(){this._PluginCount=0,this.MaterialColors=Pf}static PrepareMeshForTrianglesAndVerticesMode(e,t=!1){let i=()=>{};if(0==e.getTotalIndices())return i;if(t){const t=e.getVerticesDataKinds(),s=e.getIndices(),r={};for(const i of t)r[i]=e.getVerticesData(i);i=function(){e.setIndices(s);for(const i of t){const t=e.getVertexBuffer(i).getStrideSize();e.setVerticesData(i,r[i],void 0,t)}e.removeVerticesData("dbg_initialPass")}}let s=Array.from(e.getIndices());const r=[];for(let e=0;e<s.length;e+=3)r.push(s[e+1],s[e+2],s[e+0]);e.setIndices(s.concat(r)),e.convertToUnIndexedMesh(),e.isUnIndexed=!1,s=Array.from(e.getIndices());const n=[];for(let e=s.length/2;e<s.length;e+=3)n.push(s[e+1],s[e+2],s[e+0]);e.setIndices(s.concat(n));const o=e.getTotalVertices(),a=o/2,l=new Array(o).fill(1,0,a).fill(0,a,o);return e.setVerticesData("dbg_initialPass",l,!1,1),i}}function Nf(e,t,i,s,r){let n=null,o=null,a=null;try{let l;n=new e.Decoder,o=new e.DecoderBuffer,o.Init(t,t.byteLength);const h=n.GetEncodedGeometryType(o);switch(h){case e.TRIANGULAR_MESH:{const t=new e.Mesh;if(l=n.DecodeBufferToMesh(o,t),!l.ok()||0===t.ptr)throw new Error(l.error_msg());const i=3*t.num_faces(),r=4*i,h=e._malloc(r);try{n.GetTrianglesUInt32Array(t,r,h);const o=new Uint32Array(i);o.set(new Uint32Array(e.HEAPF32.buffer,h,i)),s(o)}finally{e._free(h)}a=t;break}case e.POINT_CLOUD:{const t=new e.PointCloud;if(l=n.DecodeBufferToPointCloud(o,t),!l.ok()||!t.ptr)throw new Error(l.error_msg());a=t;break}default:throw new Error(`Invalid geometry type ${h}`)}const c=a.num_points(),u=(t,i,s,n)=>{const o=n.data_type(),a=n.num_components(),l=n.normalized(),h=n.byte_stride(),u=n.byte_offset(),d={[e.DT_FLOAT32]:{typedArrayConstructor:Float32Array,heap:e.HEAPF32},[e.DT_INT8]:{typedArrayConstructor:Int8Array,heap:e.HEAP8},[e.DT_INT16]:{typedArrayConstructor:Int16Array,heap:e.HEAP16},[e.DT_INT32]:{typedArrayConstructor:Int32Array,heap:e.HEAP32},[e.DT_UINT8]:{typedArrayConstructor:Uint8Array,heap:e.HEAPU8},[e.DT_UINT16]:{typedArrayConstructor:Uint16Array,heap:e.HEAPU16},[e.DT_UINT32]:{typedArrayConstructor:Uint32Array,heap:e.HEAPU32}}[o];if(!d)throw new Error(`Invalid data type ${o}`);const p=c*a,_=p*d.typedArrayConstructor.BYTES_PER_ELEMENT,f=e._malloc(_);try{t.GetAttributeDataArrayForAllPoints(i,n,o,_,f);const e=new d.typedArrayConstructor(d.heap.buffer,f,p);r(s,e.slice(),a,u,h,l)}finally{e._free(f)}};if(i)for(const e in i){const t=i[e],s=n.GetAttributeByUniqueId(a,t);u(n,a,e,s)}else{const t={position:e.POSITION,normal:e.NORMAL,color:e.COLOR,uv:e.TEX_COORD};for(const e in t){const i=n.GetAttributeId(a,t[e]);if(-1!==i){const t=n.GetAttribute(a,i);u(n,a,e,t)}}}return c}finally{a&&e.destroy(a),o&&e.destroy(o),n&&e.destroy(n)}}function Ff(){let e;onmessage=t=>{const i=t.data;switch(i.id){case"init":{const t=i.decoder;t.url&&(importScripts(t.url),e=DracoDecoderModule({wasmBinary:t.wasmBinary})),postMessage({id:"initDone"});break}case"decodeMesh":if(!e)throw new Error("Draco decoder module is not available");e.then((e=>{const t=Nf(e,i.dataView,i.attributes,(e=>{postMessage({id:"indices",data:e},[e.buffer])}),((e,t,i,s,r,n)=>{postMessage({id:"attribute",kind:e,data:t,size:i,byteOffset:s,byteStride:r,normalized:n},[t.buffer])}));postMessage({id:"decodeMeshDone",totalVertices:t})}))}}}Df._PluginCount=0,Df.MaterialColors=Pf,me([re()],Df.prototype,"_materialColor",void 0),me([ie()],Df.prototype,"_isEnabled",void 0),me([ie(),te("_markAllDefinesAsDirty")],Df.prototype,"mode",void 0),me([ie(),te("_markAllDefinesAsDirty")],Df.prototype,"multiply",void 0),me([re()],Df.prototype,"shadedDiffuseColor",void 0),me([re()],Df.prototype,"shadedSpecularColor",void 0),me([ie()],Df.prototype,"shadedSpecularPower",void 0),me([ie()],Df.prototype,"wireframeThickness",void 0),me([re()],Df.prototype,"wireframeTrianglesColor",void 0),me([re()],Df.prototype,"wireframeVerticesColor",void 0),me([re()],Df.prototype,"vertexColor",void 0),me([ie()],Df.prototype,"vertexRadius",void 0),me([ie()],Df.prototype,"uvScale",void 0),me([re()],Df.prototype,"uvPrimaryColor",void 0),me([re()],Df.prototype,"uvSecondaryColor",void 0),m("BABYLON.MeshDebugPluginMaterial",Df),Object.defineProperty(Va.prototype,"decalMap",{get:function(){if(!this._decalMap){if(this._uniformBufferLayoutBuilt)return null;this._decalMap=new bf(this)}return this._decalMap},enumerable:!0,configurable:!0}),Object.defineProperty(Nd.prototype,"decalMap",{get:function(){if(!this._decalMap){if(this._uniformBufferLayoutBuilt)return null;this._decalMap=new bf(this)}return this._decalMap},enumerable:!0,configurable:!0}),Object.defineProperty(Vs.prototype,"decalMap",{get:function(){return this._decalMap},set:function(e){this._decalMap=e},enumerable:!0,configurable:!0});class wf{static get DecoderAvailable(){const e=wf.Configuration.decoder;return!!(e.wasmUrl&&e.wasmBinaryUrl&&"object"==typeof WebAssembly||e.fallbackUrl)}static GetDefaultNumWorkers(){return"object"==typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static get Default(){return wf._Default||(wf._Default=new wf),wf._Default}constructor(e=wf.DefaultNumWorkers){const t=wf.Configuration.decoder,i=t.wasmUrl&&t.wasmBinaryUrl&&"object"==typeof WebAssembly?{url:Ht.GetBabylonScriptURL(t.wasmUrl,!0),wasmBinaryPromise:Ht.LoadFileAsync(Ht.GetBabylonScriptURL(t.wasmBinaryUrl,!0))}:{url:Ht.GetBabylonScriptURL(t.fallbackUrl),wasmBinaryPromise:Promise.resolve(void 0)};e&&"function"==typeof Worker&&"function"==typeof URL?this._workerPoolPromise=i.wasmBinaryPromise.then((t=>{const s=`${Nf}(${Ff})()`,r=URL.createObjectURL(new Blob([s],{type:"application/javascript"}));return new Xd(e,(()=>new Promise(((e,s)=>{const n=new Worker(r),o=e=>{n.removeEventListener("error",o),n.removeEventListener("message",a),s(e)},a=t=>{"initDone"===t.data.id&&(n.removeEventListener("error",o),n.removeEventListener("message",a),e(n))};n.addEventListener("error",o),n.addEventListener("message",a),n.postMessage({id:"init",decoder:{url:i.url,wasmBinary:t}})}))))})):this._decoderModulePromise=i.wasmBinaryPromise.then((e=>{if(!i.url)throw new Error("Draco decoder module is not available");return Ht.LoadBabylonScriptAsync(i.url).then((()=>{return t=e,new Promise((e=>{DracoDecoderModule({wasmBinary:t}).then((t=>{e({module:t})}))}));var t}))}))}dispose(){this._workerPoolPromise&&this._workerPoolPromise.then((e=>{e.dispose()})),delete this._workerPoolPromise,delete this._decoderModulePromise}whenReadyAsync(){return this._workerPoolPromise?this._workerPoolPromise.then((()=>{})):this._decoderModulePromise?this._decoderModulePromise.then((()=>{})):Promise.resolve()}_decodeMeshAsync(e,t,i){const s=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e.buffer,e.byteOffset,e.byteLength);if(this._workerPoolPromise)return this._workerPoolPromise.then((e=>new Promise(((r,n)=>{e.push(((e,o)=>{let a=null;const l=[],h=t=>{e.removeEventListener("error",h),e.removeEventListener("message",c),n(t),o()},c=t=>{const s=t.data;switch(s.id){case"decodeMeshDone":e.removeEventListener("error",h),e.removeEventListener("message",c),r({indices:a,attributes:l,totalVertices:s.totalVertices}),o();break;case"indices":a=s.data;break;case"attribute":l.push({kind:s.kind,data:s.data,size:s.size,byteOffset:s.byteOffset,byteStride:s.byteStride,normalized:(n=s.kind,u=s.normalized,i&&void 0!==i[n]?(u!==i[n]&&k.Warn(`Normalized flag from Draco data (${u}) does not match normalized flag from glTF accessor (${i[n]}). Using flag from glTF accessor.`),i[n]):u)})}var n,u};e.addEventListener("error",h),e.addEventListener("message",c);const u=s.slice();e.postMessage({id:"decodeMesh",dataView:u,attributes:t},[u.buffer])}))}))));if(this._decoderModulePromise)return this._decoderModulePromise.then((e=>{let i=null;const r=[],n=Nf(e.module,s,t,(e=>{i=e}),((e,t,i,s,n,o)=>{r.push({kind:e,data:t,size:i,byteOffset:s,byteStride:n,normalized:o})}));return{indices:i,attributes:r,totalVertices:n}}));throw new Error("Draco decoder module is not available")}decodeMeshToGeometryAsync(e,t,i,s){return this._decodeMeshAsync(i,s).then((i=>{const s=new Ps(e,t);i.indices&&s.setIndices(i.indices);for(const e of i.attributes)s.setVerticesBuffer(new hi(t.getEngine(),e.data,e.kind,!1,void 0,e.byteStride,void 0,e.byteOffset,e.size,void 0,e.normalized,!0),i.totalVertices);return s}))}_decodeMeshToGeometryForGltfAsync(e,t,i,s,r){return this._decodeMeshAsync(i,s,r).then((i=>{const s=new Ps(e,t);i.indices&&s.setIndices(i.indices);for(const e of i.attributes)s.setVerticesBuffer(new hi(t.getEngine(),e.data,e.kind,!1,void 0,e.byteStride,void 0,e.byteOffset,e.size,void 0,e.normalized,!0),i.totalVertices);return s}))}decodeMeshAsync(e,t){return this._decodeMeshAsync(e,t).then((e=>{const t=new As;e.indices&&(t.indices=e.indices);for(const i of e.attributes){const s=hi.GetFloatData(i.data,i.size,hi.GetDataType(i.data),i.byteOffset,i.byteStride,i.normalized,e.totalVertices);t.set(s,i.kind)}return t}))}}wf.Configuration={decoder:{wasmUrl:`${Ht._DefaultCdnUrl}/draco_wasm_wrapper_gltf.js`,wasmBinaryUrl:`${Ht._DefaultCdnUrl}/draco_decoder_gltf.wasm`,fallbackUrl:`${Ht._DefaultCdnUrl}/draco_decoder_gltf.js`}},wf.DefaultNumWorkers=wf.GetDefaultNumWorkers(),wf._Default=null;class Lf{static get Default(){return Lf._Default||(Lf._Default=new Lf),Lf._Default}constructor(){const e=Lf.Configuration.decoder;this._decoderModulePromise=Ht.LoadBabylonScriptAsync(e.url).then((()=>MeshoptDecoder.ready))}dispose(){delete this._decoderModulePromise}decodeGltfBufferAsync(e,t,i,s,r){return this._decoderModulePromise.then((()=>{const n=new Uint8Array(t*i);return MeshoptDecoder.decodeGltfBuffer(n,t,i,e,s,r),n}))}}Lf.Configuration={decoder:{url:`${Ht._DefaultCdnUrl}/meshopt_decoder.js`}},Lf._Default=null;let Bf=0;class Uf{constructor(e,t,i,s){this.pos=e,this.normal=t,this.uv=i,this.vertColor=s}clone(){var e,t;return new Uf(this.pos.clone(),this.normal.clone(),null===(e=this.uv)||void 0===e?void 0:e.clone(),null===(t=this.vertColor)||void 0===t?void 0:t.clone())}flip(){this.normal=this.normal.scale(-1)}interpolate(e,t){return new Uf(S.Lerp(this.pos,e.pos,t),S.Lerp(this.normal,e.normal,t),this.uv&&e.uv?E.Lerp(this.uv,e.uv,t):void 0,this.vertColor&&e.vertColor?F.Lerp(this.vertColor,e.vertColor,t):void 0)}}class Vf{constructor(e,t){this.normal=e,this.w=t}static FromPoints(e,t,i){const s=i.subtract(e),r=t.subtract(e);if(0===s.lengthSquared()||0===r.lengthSquared())return null;const n=S.Normalize(S.Cross(s,r));return new Vf(n,S.Dot(n,e))}clone(){return new Vf(this.normal.clone(),this.w)}flip(){this.normal.scaleInPlace(-1),this.w=-this.w}splitPolygon(e,t,i,s,r){let n=0;const o=[];let a,l;for(a=0;a<e.vertices.length;a++){l=S.Dot(this.normal,e.vertices[a].pos)-this.w;const t=l<-Vf.EPSILON?2:l>Vf.EPSILON?1:0;n|=t,o.push(t)}switch(n){case 0:(S.Dot(this.normal,e.plane.normal)>0?t:i).push(e);break;case 1:s.push(e);break;case 2:r.push(e);break;case 3:{const t=[],i=[];for(a=0;a<e.vertices.length;a++){const s=(a+1)%e.vertices.length,r=o[a],n=o[s],h=e.vertices[a],c=e.vertices[s];if(2!==r&&t.push(h),1!==r&&i.push(2!==r?h.clone():h),3==(r|n)){l=(this.w-S.Dot(this.normal,h.pos))/S.Dot(this.normal,c.pos.subtract(h.pos));const e=h.interpolate(c,l);t.push(e),i.push(e.clone())}}let n;t.length>=3&&(n=new kf(t,e.shared),n.plane&&s.push(n)),i.length>=3&&(n=new kf(i,e.shared),n.plane&&r.push(n));break}}}}Vf.EPSILON=1e-5;class kf{constructor(e,t){this.vertices=e,this.shared=t,this.plane=Vf.FromPoints(e[0].pos,e[1].pos,e[2].pos)}clone(){const e=this.vertices.map((e=>e.clone()));return new kf(e,this.shared)}flip(){this.vertices.reverse().map((e=>{e.flip()})),this.plane.flip()}}class Gf{constructor(e){this._plane=null,this._front=null,this._back=null,this._polygons=new Array,e&&this.build(e)}clone(){const e=new Gf;return e._plane=this._plane&&this._plane.clone(),e._front=this._front&&this._front.clone(),e._back=this._back&&this._back.clone(),e._polygons=this._polygons.map((e=>e.clone())),e}invert(){for(let e=0;e<this._polygons.length;e++)this._polygons[e].flip();this._plane&&this._plane.flip(),this._front&&this._front.invert(),this._back&&this._back.invert();const e=this._front;this._front=this._back,this._back=e}clipPolygons(e){if(!this._plane)return e.slice();let t=[],i=[];for(let s=0;s<e.length;s++)this._plane.splitPolygon(e[s],t,i,t,i);return this._front&&(t=this._front.clipPolygons(t)),i=this._back?this._back.clipPolygons(i):[],t.concat(i)}clipTo(e){this._polygons=e.clipPolygons(this._polygons),this._front&&this._front.clipTo(e),this._back&&this._back.clipTo(e)}allPolygons(){let e=this._polygons.slice();return this._front&&(e=e.concat(this._front.allPolygons())),this._back&&(e=e.concat(this._back.allPolygons())),e}build(e){if(!e.length)return;this._plane||(this._plane=e[0].plane.clone());const t=[],i=[];for(let s=0;s<e.length;s++)this._plane.splitPolygon(e[s],this._polygons,this._polygons,t,i);t.length&&(this._front||(this._front=new Gf),this._front.build(t)),i.length&&(this._back||(this._back=new Gf),this._back.build(i))}}class zf{constructor(){this._polygons=new Array}static FromVertexData(e){let t,i,s;const r=[],n=e.indices,o=e.positions,a=e.normals,l=e.uvs,h=e.colors;if(!n||!o)throw"BABYLON.CSG: VertexData must at least contain positions and indices";for(let e=0;e<n.length;e+=3){s=[];for(let i=0;i<3;i++){const r=n[e+i],c=a?S.FromArray(a,3*r):S.Zero(),u=l?E.FromArray(l,2*r):void 0,d=h?F.FromArray(h,4*r):void 0,p=S.FromArray(o,3*r);t=new Uf(p,c,u,d),s.push(t)}i=new kf(s,{subMeshId:0,meshId:Bf,materialIndex:0}),i.plane&&r.push(i)}const c=zf._FromPolygons(r);return c.matrix=y.Identity(),c.position=S.Zero(),c.rotation=S.Zero(),c.scaling=S.One(),c.rotationQuaternion=C.Identity(),Bf++,c}static FromMesh(e,t=!1){let i,s,r,n,o,a,l;const h=[];let c,u,d,p,_=null,f=!1;if(!(e instanceof ur))throw"BABYLON.CSG: Wrong Mesh type, must be BABYLON.Mesh";e.computeWorldMatrix(!0),c=e.getWorldMatrix(),u=e.position.clone(),d=e.rotation.clone(),e.rotationQuaternion&&(_=e.rotationQuaternion.clone()),p=e.scaling.clone(),e.material&&t&&(f=0===e.material.sideOrientation);const m=e.getIndices(),g=e.getVerticesData(hi.PositionKind),v=e.getVerticesData(hi.NormalKind),x=e.getVerticesData(hi.UVKind),T=e.getVerticesData(hi.ColorKind),b=e.subMeshes;for(let e=0,t=b.length;e<t;e++)for(let t=b[e].indexStart,u=b[e].indexCount+b[e].indexStart;t<u;t+=3){l=[];for(let e=0;e<3;e++){const a=0===e?t+e:f?t+3-e:t+e,h=new S(v[3*m[a]],v[3*m[a]+1],v[3*m[a]+2]);x&&(r=new E(x[2*m[a]],x[2*m[a]+1])),T&&(o=new F(T[4*m[a]],T[4*m[a]+1],T[4*m[a]+2],T[4*m[a]+3]));const u=new S(g[3*m[a]],g[3*m[a]+1],g[3*m[a]+2]);n=S.TransformCoordinates(u,c),s=S.TransformNormal(h,c),i=new Uf(n,s,r,o),l.push(i)}a=new kf(l,{subMeshId:e,meshId:Bf,materialIndex:b[e].materialIndex}),a.plane&&h.push(a)}const A=zf._FromPolygons(h);return A.matrix=t?y.Identity():c,A.position=t?S.Zero():u,A.rotation=t?S.Zero():d,A.scaling=t?S.One():p,A.rotationQuaternion=t&&_?C.Identity():_,Bf++,A}static _FromPolygons(e){const t=new zf;return t._polygons=e,t}clone(){const e=new zf;return e._polygons=this._polygons.map((e=>e.clone())),e.copyTransformAttributes(this),e}union(e){const t=new Gf(this.clone()._polygons),i=new Gf(e.clone()._polygons);return t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),zf._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}unionInPlace(e){const t=new Gf(this._polygons),i=new Gf(e._polygons);t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),this._polygons=t.allPolygons()}subtract(e){const t=new Gf(this.clone()._polygons),i=new Gf(e.clone()._polygons);return t.invert(),t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),t.invert(),zf._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}subtractInPlace(e){const t=new Gf(this._polygons),i=new Gf(e._polygons);t.invert(),t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),t.invert(),this._polygons=t.allPolygons()}intersect(e){const t=new Gf(this.clone()._polygons),i=new Gf(e.clone()._polygons);return t.invert(),i.clipTo(t),i.invert(),t.clipTo(i),i.clipTo(t),t.build(i.allPolygons()),t.invert(),zf._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}intersectInPlace(e){const t=new Gf(this._polygons),i=new Gf(e._polygons);t.invert(),i.clipTo(t),i.invert(),t.clipTo(i),i.clipTo(t),t.build(i.allPolygons()),t.invert(),this._polygons=t.allPolygons()}inverse(){const e=this.clone();return e.inverseInPlace(),e}inverseInPlace(){this._polygons.map((e=>{e.flip()}))}copyTransformAttributes(e){return this.matrix=e.matrix,this.position=e.position,this.rotation=e.rotation,this.scaling=e.scaling,this.rotationQuaternion=e.rotationQuaternion,this}toVertexData(e=null,t=null){const i=this.matrix.clone();i.invert();const s=this._polygons,r=[],n=[],o=[];let a=null,l=null;const h=S.Zero(),c=S.Zero(),u=E.Zero(),d=new F(0,0,0,0),p=[0,0,0],_={};let f;for(let m=0,g=s.length;m<g;m++){const g=s[m];e&&e(g);for(let e=2,s=g.vertices.length;e<s;e++){p[0]=0,p[1]=e-1,p[2]=e;for(let e=0;e<3;e++){h.copyFrom(g.vertices[p[e]].pos),c.copyFrom(g.vertices[p[e]].normal),g.vertices[p[e]].uv&&(a||(a=[]),u.copyFrom(g.vertices[p[e]].uv)),g.vertices[p[e]].vertColor&&(l||(l=[]),d.copyFrom(g.vertices[p[e]].vertColor));const s=S.TransformCoordinates(h,i),m=S.TransformNormal(c,i);f=_[s.x+","+s.y+","+s.z];let v=!1;a&&a[2*f]!==u.x&&a[2*f+1]!==u.y&&(v=!0);let x=!1;l&&l[4*f]!==d.r&&l[4*f+1]!==d.g&&l[4*f+2]!==d.b&&l[4*f+3]!==d.a&&(x=!0),(void 0===f||o[3*f]!==m.x||o[3*f+1]!==m.y||o[3*f+2]!==m.z||v||x)&&(r.push(s.x,s.y,s.z),a&&a.push(u.x,u.y),o.push(c.x,c.y,c.z),l&&l.push(d.r,d.g,d.b,d.a),f=_[s.x+","+s.y+","+s.z]=r.length/3-1),n.push(f),t&&t()}}}const m=new As;return m.positions=r,m.normals=o,a&&(m.uvs=a),l&&(m.colors=l),m.indices=n,m}buildMeshGeometry(e,t,i){const s=new ur(e,t),r=this._polygons;let n=0;const o={};let a;if(i&&r.sort(((e,t)=>e.shared.meshId===t.shared.meshId?e.shared.subMeshId-t.shared.subMeshId:e.shared.meshId-t.shared.meshId)),this.toVertexData((e=>{o[e.shared.meshId]||(o[e.shared.meshId]={}),o[e.shared.meshId][e.shared.subMeshId]||(o[e.shared.meshId][e.shared.subMeshId]={indexStart:1/0,indexEnd:-1/0,materialIndex:e.shared.materialIndex}),a=o[e.shared.meshId][e.shared.subMeshId]}),(()=>{a.indexStart=Math.min(n,a.indexStart),a.indexEnd=Math.max(n,a.indexEnd),n++})).applyToMesh(s),i){let e,t=0;s.subMeshes=[];for(const i in o){e=-1;for(const r in o[i])a=o[i][r],Cs.CreateFromIndices(a.materialIndex+t,a.indexStart,a.indexEnd-a.indexStart+1,s),e=Math.max(a.materialIndex,e);t+=++e}}return s}toMesh(e,t=null,i,s){const r=this.buildMeshGeometry(e,i,s);return r.material=t,r.position.copyFrom(this.position),r.rotation.copyFrom(this.rotation),this.rotationQuaternion&&(r.rotationQuaternion=this.rotationQuaternion.clone()),r.scaling.copyFrom(this.scaling),r.computeWorldMatrix(!0),r}}nt.ShadersStore.meshUVSpaceRendererVertexShader="precision highp float;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;uniform mat4 projMatrix;varying vec2 vDecalTC;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\nvoid main(void) {vec3 positionUpdated=position;vec3 normalUpdated=normal;\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);mat3 normWorldSM=mat3(finalWorld);vec3 vNormalW;\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormWorldSM=transposeMat3(inverseMat3(normWorldSM));\n#endif\nvNormalW=normalize(normWorldSM*normalUpdated);\n#endif\nvec3 normalView=normalize((projMatrix*vec4(vNormalW,0.0)).xyz);vec3 decalTC=(projMatrix*worldPos).xyz;vDecalTC=decalTC.xy;gl_Position=vec4(uv*2.0-1.0,normalView.z>0.0 ? 2. : decalTC.z,1.0);}";nt.ShadersStore.meshUVSpaceRendererPixelShader="precision highp float;varying vec2 vDecalTC;uniform sampler2D textureSampler;void main(void) {if (vDecalTC.x<0. || vDecalTC.x>1. || vDecalTC.y<0. || vDecalTC.y>1.) {discard;}\ngl_FragColor=texture2D(textureSampler,vDecalTC);}\n";nt.ShadersStore.meshUVSpaceRendererMaskerVertexShader="attribute vec2 uv;varying vec2 vUV;void main(void) {gl_Position=vec4(vec2(uv.x,uv.y)*2.0-1.0,0.,1.0);vUV=uv;}";nt.ShadersStore.meshUVSpaceRendererMaskerPixelShader="varying vec2 vUV;void main(void) {gl_FragColor=vec4(1.0,1.0,1.0,1.0);}\n";nt.ShadersStore.meshUVSpaceRendererFinaliserPixelShader="precision highp float;varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D maskTextureSampler;uniform vec2 textureSize;void main() {vec4 mask=texture2D(maskTextureSampler,vUV).rgba;if (mask.r>0.5) {gl_FragColor=texture2D(textureSampler,vUV);} else {vec2 texelSize=4.0/textureSize;vec2 uv_p01=vUV+vec2(-1.0,0.0)*texelSize;vec2 uv_p21=vUV+vec2(1.0,0.0)*texelSize;vec2 uv_p10=vUV+vec2(0.0,-1.0)*texelSize;vec2 uv_p12=vUV+vec2(0.0,1.0)*texelSize;float mask_p01=texture2D(maskTextureSampler,uv_p01).r;float mask_p21=texture2D(maskTextureSampler,uv_p21).r;float mask_p10=texture2D(maskTextureSampler,uv_p10).r;float mask_p12=texture2D(maskTextureSampler,uv_p12).r;vec4 col=vec4(0.0,0.0,0.0,0.0);float total_weight=0.0;if (mask_p01>0.5) {col+=texture2D(textureSampler,uv_p01);total_weight+=1.0;}\nif (mask_p21>0.5) {col+=texture2D(textureSampler,uv_p21);total_weight+=1.0;}\nif (mask_p10>0.5) {col+=texture2D(textureSampler,uv_p10);total_weight+=1.0;}\nif (mask_p12>0.5) {col+=texture2D(textureSampler,uv_p12);total_weight+=1.0;}\nif (total_weight>0.0) {gl_FragColor=col/total_weight;} else {gl_FragColor=col;}}}\n";nt.ShadersStore.meshUVSpaceRendererFinaliserVertexShader="precision highp float;attribute vec3 position;attribute vec2 uv;uniform mat4 worldViewProjection;varying vec2 vUV;void main() {gl_Position=worldViewProjection*vec4(position,1.0);vUV=uv;}\n",ur._TrailMeshParser=(e,t)=>Wf.Parse(e,t);class Wf extends ur{constructor(e,t,i,s=1,r=60,n=!0){super(e,i),this._sectionPolygonPointsCount=4,this._running=!1,this._autoStart=n,this._generator=t,this.diameter=s,this._length=r,this._sectionVectors=[],this._sectionNormalVectors=[];for(let e=0;e<this._sectionPolygonPointsCount;e++)this._sectionVectors[e]=S.Zero(),this._sectionNormalVectors[e]=S.Zero();this._createMesh()}getClassName(){return"TrailMesh"}_createMesh(){const e=new As,t=[],i=[],s=[];let r=S.Zero();r=this._generator instanceof Vs&&this._generator.hasBoundingInfo?this._generator.getBoundingInfo().boundingBox.centerWorld:this._generator.position;const n=2*Math.PI/this._sectionPolygonPointsCount;for(let e=0;e<this._sectionPolygonPointsCount;e++)t.push(r.x+Math.cos(e*n)*this.diameter,r.y+Math.sin(e*n)*this.diameter,r.z);for(let e=1;e<=this._length;e++){for(let e=0;e<this._sectionPolygonPointsCount;e++)t.push(r.x+Math.cos(e*n)*this.diameter,r.y+Math.sin(e*n)*this.diameter,r.z);const e=t.length/3-2*this._sectionPolygonPointsCount;for(let t=0;t<this._sectionPolygonPointsCount-1;t++)s.push(e+t,e+t+this._sectionPolygonPointsCount,e+t+this._sectionPolygonPointsCount+1),s.push(e+t,e+t+this._sectionPolygonPointsCount+1,e+t+1);s.push(e+this._sectionPolygonPointsCount-1,e+this._sectionPolygonPointsCount-1+this._sectionPolygonPointsCount,e+this._sectionPolygonPointsCount),s.push(e+this._sectionPolygonPointsCount-1,e+this._sectionPolygonPointsCount,e)}As.ComputeNormals(t,s,i),e.positions=t,e.normals=i,e.indices=s,e.applyToMesh(this,!0),this._autoStart&&this.start()}start(){this._running||(this._running=!0,this._beforeRenderObserver=this.getScene().onBeforeRenderObservable.add((()=>{this.update()})))}stop(){this._beforeRenderObserver&&this._running&&(this._running=!1,this.getScene().onBeforeRenderObservable.remove(this._beforeRenderObserver))}update(){const e=this.getVerticesData(hi.PositionKind),t=this.getVerticesData(hi.NormalKind),i=this._generator.getWorldMatrix();if(e&&t){for(let i=3*this._sectionPolygonPointsCount;i<e.length;i++)e[i-3*this._sectionPolygonPointsCount]=e[i]-t[i]/this._length*this.diameter;for(let e=3*this._sectionPolygonPointsCount;e<t.length;e++)t[e-3*this._sectionPolygonPointsCount]=t[e];const s=e.length-3*this._sectionPolygonPointsCount,r=2*Math.PI/this._sectionPolygonPointsCount;for(let e=0;e<this._sectionPolygonPointsCount;e++)this._sectionVectors[e].copyFromFloats(Math.cos(e*r)*this.diameter,Math.sin(e*r)*this.diameter,0),this._sectionNormalVectors[e].copyFromFloats(Math.cos(e*r),Math.sin(e*r),0),S.TransformCoordinatesToRef(this._sectionVectors[e],i,this._sectionVectors[e]),S.TransformNormalToRef(this._sectionNormalVectors[e],i,this._sectionNormalVectors[e]);for(let i=0;i<this._sectionPolygonPointsCount;i++)e[s+3*i]=this._sectionVectors[i].x,e[s+3*i+1]=this._sectionVectors[i].y,e[s+3*i+2]=this._sectionVectors[i].z,t[s+3*i]=this._sectionNormalVectors[i].x,t[s+3*i+1]=this._sectionNormalVectors[i].y,t[s+3*i+2]=this._sectionNormalVectors[i].z;this.updateVerticesData(hi.PositionKind,e,!0,!1),this.updateVerticesData(hi.NormalKind,t,!0,!1)}}clone(e="",t){return new Wf(e,void 0===t?this._generator:t,this.getScene(),this.diameter,this._length,this._autoStart)}serialize(e){super.serialize(e),e.generatorId=this._generator.id}static Parse(e,t){var i,s;const r=null!==(i=t.getLastMeshById(e.generatorId))&&void 0!==i?i:t.getLastTransformNodeById(e.generatorId);if(!r)throw new Error("TrailMesh: generator not found with ID "+e.generatorId);return new Wf(e.name,r,t,null!==(s=e.diameter)&&void 0!==s?s:e._diameter,e._length,e._autoStart)}}class Hf{constructor(){this.running=!1,this._simplificationArray=[]}addTask(e){this._simplificationArray.push(e)}executeNext(){const e=this._simplificationArray.pop();e?(this.running=!0,this.runSimplification(e)):this.running=!1}runSimplification(e){if(e.parallelProcessing)e.settings.forEach((t=>{this._getSimplifier(e).simplify(t,(i=>{void 0!==t.distance&&e.mesh.addLODLevel(t.distance,i),i.isVisible=!0,t.quality===e.settings[e.settings.length-1].quality&&e.successCallback&&e.successCallback(),this.executeNext()}))}));else{const t=this._getSimplifier(e),i=(i,s)=>{t.simplify(i,(t=>{void 0!==i.distance&&e.mesh.addLODLevel(i.distance,t),t.isVisible=!0,s()}))};Xt.Run(e.settings.length,(t=>{i(e.settings[t.index],(()=>{t.executeNext()}))}),(()=>{e.successCallback&&e.successCallback(),this.executeNext()}))}}_getSimplifier(e){return e.simplificationType,Xf.QUADRATIC,new _m(e.mesh)}}var Xf,Yf,jf,Kf,$f,qf,Qf,Zf,Jf,em,tm,im,sm,rm,nm,om,am,lm,hm;!function(e){e[e.QUADRATIC=0]="QUADRATIC"}(Xf||(Xf={}));class cm{constructor(e){this._vertices=e,this.error=new Array(4),this.deleted=!1,this.isDirty=!1,this.deletePending=!1,this.borderFactor=0}}class um{constructor(e,t){this.position=e,this.id=t,this.isBorder=!0,this.q=new dm,this.triangleCount=0,this.triangleStart=0,this.originalOffsets=[]}updatePosition(e){this.position.copyFrom(e)}}class dm{constructor(e){this.data=new Array(10);for(let t=0;t<10;++t)e&&e[t]?this.data[t]=e[t]:this.data[t]=0}det(e,t,i,s,r,n,o,a,l){return this.data[e]*this.data[r]*this.data[l]+this.data[i]*this.data[s]*this.data[a]+this.data[t]*this.data[n]*this.data[o]-this.data[i]*this.data[r]*this.data[o]-this.data[e]*this.data[n]*this.data[a]-this.data[t]*this.data[s]*this.data[l]}addInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e.data[t]}addArrayInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e[t]}add(e){const t=new dm;for(let i=0;i<10;++i)t.data[i]=this.data[i]+e.data[i];return t}static FromData(e,t,i,s){return new dm(dm.DataFromNumbers(e,t,i,s))}static DataFromNumbers(e,t,i,s){return[e*e,e*t,e*i,e*s,t*t,t*i,t*s,i*i,i*s,s*s]}}class pm{constructor(e,t){this.vertexId=e,this.triangleId=t}}class _m{constructor(e){this._mesh=e,this.syncIterations=5e3,this.aggressiveness=7,this.decimationIterations=100,this.boundingBoxEpsilon=u}simplify(e,t){this._initDecimatedMesh(),Xt.Run(this._mesh.subMeshes.length,(t=>{this._initWithMesh(t.index,(()=>{this._runDecimation(e,t.index,(()=>{t.executeNext()}))}),e.optimizeMesh)}),(()=>{setTimeout((()=>{t(this._reconstructedMesh)}),0)}))}_runDecimation(e,t,i){const s=~~(this._triangles.length*e.quality);let r=0;const n=this._triangles.length,o=(e,t)=>{setTimeout((()=>{e%5==0&&this._updateMesh(0===e);for(let e=0;e<this._triangles.length;++e)this._triangles[e].isDirty=!1;const i=1e-9*Math.pow(e+3,this.aggressiveness);Xt.SyncAsyncForLoop(this._triangles.length,this.syncIterations,(e=>{const t=~~((this._triangles.length/2+e)%this._triangles.length),s=this._triangles[t];if(s&&!(s.error[3]>i||s.deleted||s.isDirty))for(let e=0;e<3;++e)if(s.error[e]<i){const t=[],i=[],n=s._vertices[e],o=s._vertices[(e+1)%3];if(n.isBorder||o.isBorder)continue;const a=S.Zero();this._calculateError(n,o,a);const l=[];if(this._isFlipped(n,o,a,t,l))continue;if(this._isFlipped(o,n,a,i,l))continue;if(t.indexOf(!0)<0||i.indexOf(!0)<0)continue;const h=[];if(l.forEach((e=>{-1===h.indexOf(e)&&(e.deletePending=!0,h.push(e))})),h.length%2!=0)continue;n.q=o.q.add(n.q),n.updatePosition(a);const c=this._references.length;r=this._updateTriangles(n,n,t,r),r=this._updateTriangles(n,o,i,r);const u=this._references.length-c;if(u<=n.triangleCount){if(u)for(let e=0;e<u;e++)this._references[n.triangleStart+e]=this._references[c+e]}else n.triangleStart=c;n.triangleCount=u;break}}),t,(()=>n-r<=s))}),0)};Xt.Run(this.decimationIterations,(e=>{n-r<=s?e.breakLoop():o(e.index,(()=>{e.executeNext()}))}),(()=>{setTimeout((()=>{this._reconstructMesh(t),i()}),0)}))}_initWithMesh(e,t,i){this._vertices=[],this._triangles=[];const s=this._mesh.getVerticesData(hi.PositionKind),r=this._mesh.getIndices(),n=this._mesh.subMeshes[e],o=e=>{if(i)for(let t=0;t<this._vertices.length;++t)if(this._vertices[t].position.equalsWithEpsilon(e,1e-4))return this._vertices[t];return null},a=[],l=n.verticesCount;Xt.SyncAsyncForLoop(l,this.syncIterations/4|0,(e=>{if(!s)return;const t=e+n.verticesStart,i=S.FromArray(s,3*t),r=o(i)||new um(i,this._vertices.length);r.originalOffsets.push(t),r.id===this._vertices.length&&this._vertices.push(r),a.push(r.id)}),(()=>{Xt.SyncAsyncForLoop(n.indexCount/3,this.syncIterations,(e=>{if(!r)return;const t=3*(n.indexStart/3+e),i=r[t+0],s=r[t+1],o=r[t+2],l=this._vertices[a[i-n.verticesStart]],h=this._vertices[a[s-n.verticesStart]],c=this._vertices[a[o-n.verticesStart]],u=new cm([l,h,c]);u.originalOffset=t,this._triangles.push(u)}),(()=>{this._init(t)}))}))}_init(e){Xt.SyncAsyncForLoop(this._triangles.length,this.syncIterations,(e=>{const t=this._triangles[e];t.normal=S.Cross(t._vertices[1].position.subtract(t._vertices[0].position),t._vertices[2].position.subtract(t._vertices[0].position)).normalize();for(let e=0;e<3;e++)t._vertices[e].q.addArrayInPlace(dm.DataFromNumbers(t.normal.x,t.normal.y,t.normal.z,-S.Dot(t.normal,t._vertices[0].position)))}),(()=>{Xt.SyncAsyncForLoop(this._triangles.length,this.syncIterations,(e=>{const t=this._triangles[e];for(let e=0;e<3;++e)t.error[e]=this._calculateError(t._vertices[e],t._vertices[(e+1)%3]);t.error[3]=Math.min(t.error[0],t.error[1],t.error[2])}),(()=>{e()}))}))}_reconstructMesh(e){const t=[];let i,s,r;for(i=0;i<this._vertices.length;++i)this._vertices[i].triangleCount=0;for(i=0;i<this._triangles.length;++i)if(!this._triangles[i].deleted){for(s=this._triangles[i],r=0;r<3;++r)s._vertices[r].triangleCount=1;t.push(s)}const n=this._reconstructedMesh.getVerticesData(hi.PositionKind)||[],o=this._reconstructedMesh.getVerticesData(hi.NormalKind)||[],a=this._reconstructedMesh.getVerticesData(hi.UVKind)||[],l=this._reconstructedMesh.getVerticesData(hi.ColorKind)||[],h=this._mesh.getVerticesData(hi.NormalKind),c=this._mesh.getVerticesData(hi.UVKind),u=this._mesh.getVerticesData(hi.ColorKind);let d=0;for(i=0;i<this._vertices.length;++i){const e=this._vertices[i];e.id=d,e.triangleCount&&e.originalOffsets.forEach((t=>{n.push(e.position.x),n.push(e.position.y),n.push(e.position.z),h&&h.length&&(o.push(h[3*t]),o.push(h[3*t+1]),o.push(h[3*t+2])),c&&c.length&&(a.push(c[2*t]),a.push(c[2*t+1])),u&&u.length&&(l.push(u[4*t]),l.push(u[4*t+1]),l.push(u[4*t+2]),l.push(u[4*t+3])),++d}))}const p=this._reconstructedMesh.getTotalIndices(),_=this._reconstructedMesh.getTotalVertices(),f=this._reconstructedMesh.subMeshes;this._reconstructedMesh.subMeshes=[];const m=this._reconstructedMesh.getIndices(),g=this._mesh.getIndices();for(i=0;i<t.length;++i)s=t[i],[0,1,2].forEach((e=>{const t=g[s.originalOffset+e];let i=s._vertices[e].originalOffsets.indexOf(t);i<0&&(i=0),m.push(s._vertices[e].id+i+_)}));this._reconstructedMesh.setIndices(m),this._reconstructedMesh.setVerticesData(hi.PositionKind,n),o.length>0&&this._reconstructedMesh.setVerticesData(hi.NormalKind,o),a.length>0&&this._reconstructedMesh.setVerticesData(hi.UVKind,a),l.length>0&&this._reconstructedMesh.setVerticesData(hi.ColorKind,l);const v=this._mesh.subMeshes[e];e>0&&(this._reconstructedMesh.subMeshes=[],f.forEach((e=>{Cs.AddToMesh(e.materialIndex,e.verticesStart,e.verticesCount,e.indexStart,e.indexCount,e.getMesh())})),Cs.AddToMesh(v.materialIndex,_,d,p,3*t.length,this._reconstructedMesh))}_initDecimatedMesh(){this._reconstructedMesh=new ur(this._mesh.name+"Decimated",this._mesh.getScene()),this._reconstructedMesh.material=this._mesh.material,this._reconstructedMesh.parent=this._mesh.parent,this._reconstructedMesh.isVisible=!1,this._reconstructedMesh.renderingGroupId=this._mesh.renderingGroupId}_isFlipped(e,t,i,s,r){for(let n=0;n<e.triangleCount;++n){const o=this._triangles[this._references[e.triangleStart+n].triangleId];if(o.deleted)continue;const a=this._references[e.triangleStart+n].vertexId,l=o._vertices[(a+1)%3],h=o._vertices[(a+2)%3];if(l===t||h===t){s[n]=!0,r.push(o);continue}let c=l.position.subtract(i);c=c.normalize();let u=h.position.subtract(i);if(u=u.normalize(),Math.abs(S.Dot(c,u))>.999)return!0;const d=S.Cross(c,u).normalize();if(s[n]=!1,S.Dot(d,o.normal)<.2)return!0}return!1}_updateTriangles(e,t,i,s){let r=s;for(let s=0;s<t.triangleCount;++s){const n=this._references[t.triangleStart+s],o=this._triangles[n.triangleId];o.deleted||(i[s]&&o.deletePending?(o.deleted=!0,r++):(o._vertices[n.vertexId]=e,o.isDirty=!0,o.error[0]=this._calculateError(o._vertices[0],o._vertices[1])+o.borderFactor/2,o.error[1]=this._calculateError(o._vertices[1],o._vertices[2])+o.borderFactor/2,o.error[2]=this._calculateError(o._vertices[2],o._vertices[0])+o.borderFactor/2,o.error[3]=Math.min(o.error[0],o.error[1],o.error[2]),this._references.push(n)))}return r}_identifyBorder(){for(let e=0;e<this._vertices.length;++e){const t=[],i=[],s=this._vertices[e];let r;for(r=0;r<s.triangleCount;++r){const e=this._triangles[this._references[s.triangleStart+r].triangleId];for(let s=0;s<3;s++){let r=0;const n=e._vertices[s];for(;r<t.length&&i[r]!==n.id;)++r;r===t.length?(t.push(1),i.push(n.id)):t[r]++}}for(r=0;r<t.length;++r)1===t[r]?this._vertices[i[r]].isBorder=!0:this._vertices[i[r]].isBorder=!1}}_updateMesh(e=!1){let t,i,s,r;if(!e){const e=[];for(t=0;t<this._triangles.length;++t)this._triangles[t].deleted||e.push(this._triangles[t]);this._triangles=e}for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleCount=0,this._vertices[t].triangleStart=0;for(t=0;t<this._triangles.length;++t)for(i=this._triangles[t],s=0;s<3;++s)r=i._vertices[s],r.triangleCount++;let n=0;for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleStart=n,n+=this._vertices[t].triangleCount,this._vertices[t].triangleCount=0;const o=new Array(3*this._triangles.length);for(t=0;t<this._triangles.length;++t)for(i=this._triangles[t],s=0;s<3;++s)r=i._vertices[s],o[r.triangleStart+r.triangleCount]=new pm(s,t),r.triangleCount++;this._references=o,e&&this._identifyBorder()}_vertexError(e,t){const i=t.x,s=t.y,r=t.z;return e.data[0]*i*i+2*e.data[1]*i*s+2*e.data[2]*i*r+2*e.data[3]*i+e.data[4]*s*s+2*e.data[5]*s*r+2*e.data[6]*s+e.data[7]*r*r+2*e.data[8]*r+e.data[9]}_calculateError(e,t,i){const s=e.q.add(t.q),r=e.isBorder&&t.isBorder;let n=0;const o=s.det(0,1,2,1,4,5,2,5,7);if(0===o||r){const r=e.position.add(t.position).divide(new S(2,2,2)),o=this._vertexError(s,e.position),a=this._vertexError(s,t.position),l=this._vertexError(s,r);n=Math.min(o,a,l),n===o?i&&i.copyFrom(e.position):n===a?i&&i.copyFrom(t.position):i&&i.copyFrom(r)}else i||(i=S.Zero()),i.x=-1/o*s.det(1,2,3,4,5,6,5,7,8),i.y=1/o*s.det(0,2,3,1,5,6,2,7,8),i.z=-1/o*s.det(0,1,3,1,4,6,2,5,8),n=this._vertexError(s,i);return n}}Object.defineProperty(Yi.prototype,"simplificationQueue",{get:function(){if(!this._simplificationQueue){this._simplificationQueue=new Hf;let e=this._getComponent(fi.NAME_SIMPLIFICATIONQUEUE);e||(e=new fm(this),this._addComponent(e))}return this._simplificationQueue},set:function(e){this._simplificationQueue=e},enumerable:!0,configurable:!0}),ur.prototype.simplify=function(e,t=!0,i=Xf.QUADRATIC,s){return this.getScene().simplificationQueue.addTask({settings:e,parallelProcessing:t,mesh:this,simplificationType:i,successCallback:s}),this};class fm{constructor(e){this.name=fi.NAME_SIMPLIFICATIONQUEUE,this.scene=e}register(){this.scene._beforeCameraUpdateStage.registerStep(fi.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE,this,this._beforeCameraUpdate)}rebuild(){}dispose(){}_beforeCameraUpdate(){this.scene._simplificationQueue&&!this.scene._simplificationQueue.running&&this.scene._simplificationQueue.executeNext()}}(hm=Yf||(Yf={}))[hm.POINTS_MODE_POINTS=0]="POINTS_MODE_POINTS",hm[hm.POINTS_MODE_PATHS=1]="POINTS_MODE_PATHS",(lm=jf||(jf={}))[lm.FACES_MODE_SINGLE_SIDED=0]="FACES_MODE_SINGLE_SIDED",lm[lm.FACES_MODE_SINGLE_SIDED_NO_BACKFACE_CULLING=1]="FACES_MODE_SINGLE_SIDED_NO_BACKFACE_CULLING",lm[lm.FACES_MODE_DOUBLE_SIDED=2]="FACES_MODE_DOUBLE_SIDED",(am=Kf||(Kf={}))[am.AUTO_DIRECTIONS_FROM_FIRST_SEGMENT=0]="AUTO_DIRECTIONS_FROM_FIRST_SEGMENT",am[am.AUTO_DIRECTIONS_FROM_ALL_SEGMENTS=1]="AUTO_DIRECTIONS_FROM_ALL_SEGMENTS",am[am.AUTO_DIRECTIONS_ENHANCED=2]="AUTO_DIRECTIONS_ENHANCED",am[am.AUTO_DIRECTIONS_NONE=99]="AUTO_DIRECTIONS_NONE";class mm extends ur{constructor(e,t,i){var s,r,n,o;super(e,t,null,null,!1,!1),this.name=e,this._options=i,this._lazy=!1,this._updatable=!1,this._engine=t.getEngine(),this._lazy=null!==(s=i.lazy)&&void 0!==s&&s,this._updatable=null!==(r=i.updatable)&&void 0!==r&&r,this._vertexPositions=[],this._indices=[],this._uvs=[],this._points=[],this._colorPointers=null!==(n=i.colorPointers)&&void 0!==n?n:[],this._widths=null!==(o=i.widths)&&void 0!==o?o:new Array(i.points.length).fill(1)}getClassName(){return"GreasedLineMesh"}_updateWidthsWithValue(e){let t=0;for(const e of this._points)t+=e.length;const i=t/3*2-this._widths.length;for(let t=0;t<i;t++)this._widths.push(e)}updateLazy(){var e,t;this._setPoints(this._points),this._options.colorPointers||this._updateColorPointers(),this._createVertexBuffers(null===(e=this._options.ribbonOptions)||void 0===e?void 0:e.smoothShading),this.refreshBoundingInfo(),null===(t=this.greasedLineMaterial)||void 0===t||t.updateLazy()}addPoints(e,t){for(const t of e)this._points.push(t);this._lazy||this.setPoints(this._points,t)}dispose(){super.dispose()}isLazy(){return this._lazy}get offsets(){return this._offsets}set offsets(e){this._offsets=e,this._offsetsBuffer?this._offsetsBuffer.update(e):this._createOffsetsBuffer(e)}get widths(){return this._widths}set widths(e){this._widths=e,this._lazy||this._widthsBuffer&&this._widthsBuffer.update(e)}get colorPointers(){return this._colorPointers}set colorPointers(e){this._colorPointers=e,this._lazy||this._colorPointersBuffer&&this._colorPointersBuffer.update(e)}get greasedLineMaterial(){var e,t;if(this.material&&this.material instanceof If)return this.material;return(null===(t=null===(e=this.material)||void 0===e?void 0:e.pluginManager)||void 0===t?void 0:t.getPlugin(Rf.GREASED_LINE_MATERIAL_NAME))||void 0}get points(){const e=[];return H.DeepCopy(this._points,e),e}setPoints(e,t){this._points=e,this._updateWidths(),(null==t?void 0:t.colorPointers)||this._updateColorPointers(),this._setPoints(e,t)}_initGreasedLine(){this._vertexPositions=[],this._indices=[],this._uvs=[]}_createLineOptions(){return{points:this._points,colorPointers:this._colorPointers,lazy:this._lazy,updatable:this._updatable,uvs:this._uvs,widths:this._widths,ribbonOptions:this._options.ribbonOptions}}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions()}_createVertexBuffers(e=!1){const t=new As;return t.positions=this._vertexPositions,t.indices=this._indices,t.uvs=this._uvs,e&&(t.normals=[],As.ComputeNormals(this._vertexPositions,this._indices,t.normals)),t.applyToMesh(this,this._options.updatable),t}_createOffsetsBuffer(e){const t=this._scene.getEngine(),i=new li(t,e,this._updatable,3);this.setVerticesBuffer(i.createVertexBuffer("grl_offsets",0,3)),this._offsetsBuffer=i}}ur._GreasedLineMeshParser=(e,t)=>gm.Parse(e,t);class gm extends mm{constructor(e,t,i){super(e,t,i),this.name=e,this.intersectionThreshold=.1,this._previousAndSide=[],this._nextAndCounters=[],i.points&&this.addPoints(yf.ConvertPoints(i.points))}getClassName(){return"GreasedLineMesh"}_updateColorPointers(){if(this._options.colorPointers)return;let e=0;this._colorPointers=[],this._points.forEach((t=>{for(let i=0;i<t.length;i+=3)this._colorPointers.push(e),this._colorPointers.push(e++)}))}_updateWidths(){super._updateWidthsWithValue(0)}_setPoints(e){this._points=e,this._options.points=e,this._initGreasedLine();let t=0;e.forEach((e=>{var i;const s=[],r=[],n=[],o=yf.GetLineLength(e);for(let i=0,a=0;a<e.length;i++,a+=3){const l=e.slice(0,a+3),h=yf.GetLineLength(l)/o;if(r.push(e[a],e[a+1],e[a+2]),r.push(e[a],e[a+1],e[a+2]),s.push(h),s.push(h),a<e.length-3){const e=2*i+t;n.push(e,e+1,e+2),n.push(e+2,e+1,e+3)}}t+=e.length/3*2;const a=[],l=[],h=[];let c=[];this._preprocess(r,a,l,h,c);for(const e of r)this._vertexPositions.push(e);for(const e of n)this._indices.push(e);for(let e=0;e<h.length;e++)this._previousAndSide.push(a[3*e],a[3*e+1],a[3*e+2],h[e]),this._nextAndCounters.push(l[3*e],l[3*e+1],l[3*e+2],s[e]);c=null!==(i=this._options.uvs)&&void 0!==i?i:c;for(const e of c)this._uvs.push(e)})),this._lazy||(this._options.colorPointers||this._updateColorPointers(),this._createVertexBuffers(),this.refreshBoundingInfo())}clone(e=`${this.name}-cloned`,t){const i=this._createLineOptions(),s={};H.DeepCopy(i,s,["instance"],void 0,!0);const r=new gm(e,this._scene,s);return t&&(r.parent=t),r.material=this.material,r}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions()}static Parse(e,t){const i=e.lineOptions,s=e.name;return new gm(s,t,i)}_initGreasedLine(){super._initGreasedLine(),this._previousAndSide=[],this._nextAndCounters=[]}intersects(e,t,i,s=!1,r,n=!1){const o=new ci,a=this.findAllIntersections(e,t,i,s,r,n,!0);if(1===(null==a?void 0:a.length)){const t=a[0];o.hit=!0,o.distance=t.distance,o.ray=e,o.pickedMesh=this,o.pickedPoint=t.point}return o}findAllIntersections(e,t,i,s=!1,r,n=!1,o=!1){var a,l;if(s&&!n&&!1===e.intersectsSphere(this._boundingSphere,this.intersectionThreshold))return;const h=this.getIndices(),c=this.getVerticesData(hi.PositionKind),u=this._widths,d=null!==(l=null===(a=this.greasedLineMaterial)||void 0===a?void 0:a.width)&&void 0!==l?l:1,p=[];if(h&&c&&u){let t=0,i=0;for(t=0,i=h.length-1;t<i;t+=3){const i=h[t],s=h[t+1];gm._V_START.fromArray(c,3*i),gm._V_END.fromArray(c,3*s),this._offsets&&(gm._V_OFFSET_START.fromArray(this._offsets,3*i),gm._V_OFFSET_END.fromArray(this._offsets,3*s),gm._V_START.addInPlace(gm._V_OFFSET_START),gm._V_END.addInPlace(gm._V_OFFSET_END));const r=Math.floor(t/3),n=void 0!==u[r]?u[r]:1,a=this.intersectionThreshold*(d*n)/2,l=e.intersectionSegment(gm._V_START,gm._V_END,a);if(-1!==l&&(p.push({distance:l,point:e.direction.normalize().multiplyByFloats(l,l,l).add(e.origin)}),o))return p}t=i}return p}get _boundingSphere(){return this.getBoundingInfo().boundingSphere}static _CompareV3(e,t,i){const s=6*e,r=6*t;return i[s]===i[r]&&i[s+1]===i[r+1]&&i[s+2]===i[r+2]}static _CopyV3(e,t){const i=6*e;return[t[i],t[i+1],t[i+2]]}_preprocess(e,t,i,s,r){const n=e.length/6;let o=[];o=gm._CompareV3(0,n-1,e)?gm._CopyV3(n-2,e):gm._CopyV3(0,e),t.push(o[0],o[1],o[2]),t.push(o[0],o[1],o[2]);for(let a=0;a<n;a++)s.push(1),s.push(-1),this._options.uvs||(r.push(a/(n-1),0),r.push(a/(n-1),1)),a<n-1&&(o=gm._CopyV3(a,e),t.push(o[0],o[1],o[2]),t.push(o[0],o[1],o[2])),a>0&&(o=gm._CopyV3(a,e),i.push(o[0],o[1],o[2]),i.push(o[0],o[1],o[2]));return o=gm._CompareV3(n-1,0,e)?gm._CopyV3(1,e):gm._CopyV3(n-1,e),i.push(o[0],o[1],o[2]),i.push(o[0],o[1],o[2]),{previous:t,next:i,uvs:r,side:s}}_createVertexBuffers(){const e=super._createVertexBuffers(),t=this._scene.getEngine(),i=new li(t,this._previousAndSide,!1,4);this.setVerticesBuffer(i.createVertexBuffer("grl_previousAndSide",0,4));const s=new li(t,this._nextAndCounters,!1,4);this.setVerticesBuffer(s.createVertexBuffer("grl_nextAndCounters",0,4));const r=new li(t,this._widths,this._updatable,1);this.setVerticesBuffer(r.createVertexBuffer("grl_widths",0,1)),this._widthsBuffer=r;const n=new li(t,this._colorPointers,this._updatable,1);return this.setVerticesBuffer(n.createVertexBuffer("grl_colorPointers",0,1)),this._colorPointersBuffer=n,e}}gm._V_START=new S,gm._V_END=new S,gm._V_OFFSET_START=new S,gm._V_OFFSET_END=new S,ur._GreasedLineRibbonMeshParser=(e,t)=>vm.Parse(e,t);class vm extends mm{constructor(e,t,i,s){var r;if(super(e,t,i),this.name=e,!i.ribbonOptions)throw"'GreasedLineMeshOptions.ribbonOptions' is not set.";this._paths=[],this._counters=[],this._slopes=[],this._widths=null!==(r=i.widths)&&void 0!==r?r:[],this._ribbonWidths=[],this._pathsOptions=null!=s?s:[],i.points&&this.addPoints(yf.ConvertPoints(i.points),i,!!s)}addPoints(e,t,i=!1){if(!t.ribbonOptions)throw"addPoints() on GreasedLineRibbonMesh instance requires 'GreasedLineMeshOptions.ribbonOptions'.";i||this._pathsOptions.push({options:t,pathCount:e.length}),super.addPoints(e,t)}getClassName(){return"GreasedLineRibbonMesh"}get isFlatLine(){return this._paths.length<3}get slopes(){return this._slopes}set slopes(e){this._slopes=e}_updateColorPointers(){if(this._options.colorPointers)return;let e=0;this._colorPointers=[];for(let t=0;t<this._pathsOptions.length;t++){const{options:i,pathCount:s}=this._pathsOptions[t],r=this._points[t];if(i.ribbonOptions.pointsMode===Yf.POINTS_MODE_POINTS)for(let t=0;t<s;t++)for(let t=0;t<r.length;t+=3)this._colorPointers.push(e),this._colorPointers.push(e++);else for(let t=0;t<r.length;t+=3){for(let t=0;t<s;t++)this._colorPointers.push(e);e++}}}_updateWidths(){super._updateWidthsWithValue(1)}_setPoints(e,t){var i,s;if(!this._options.ribbonOptions)throw"No 'GreasedLineMeshOptions.ribbonOptions' provided.";this._points=e,this._options.points=e,this._initGreasedLine();let r,n=0;for(let t=0,o=0;t<this._pathsOptions.length;t++){const{options:a,pathCount:l}=this._pathsOptions[t],h=e.slice(o,o+l);if(o+=l,(null===(i=a.ribbonOptions)||void 0===i?void 0:i.pointsMode)===Yf.POINTS_MODE_PATHS)n=this._preprocess(yf.ToVector3Array(h),n,a);else{if((null===(s=a.ribbonOptions)||void 0===s?void 0:s.directionsAutoMode)===Kf.AUTO_DIRECTIONS_NONE){if(!a.ribbonOptions.directions)throw"In GreasedLineRibbonAutoDirectionMode.AUTO_DIRECTIONS_NONE 'GreasedLineMeshOptions.ribbonOptions.directions' must be defined.";r=vm._GetDirectionPlanesFromDirectionsOption(h.length,a.ribbonOptions.directions)}h.forEach(((e,t)=>{const i=vm._ConvertToRibbonPath(e,a.ribbonOptions,this._scene.useRightHandedSystem,r?r[t]:r);n=this._preprocess(i,n,a)}))}}this._lazy||(this._createVertexBuffers(),this.refreshBoundingInfo())}static _GetDirectionPlanesFromDirectionsOption(e,t){return Array.isArray(t)?t:new Array(e).fill(t)}static _CreateRibbonVertexData(e,t){var i,s,r;const n=e.length;if(n<2)throw"Minimum of two paths are required to create a GreasedLineRibbonMesh.";const o=[],a=[],l=e[0];for(let t=0;t<l.length;t++)for(let i=0;i<e.length;i++){const s=e[i][t];o.push(s.x,s.y,s.z)}const h=[1,0,n],c=null!==(s=(null===(i=t.ribbonOptions)||void 0===i?void 0:i.facesMode)===jf.FACES_MODE_DOUBLE_SIDED)&&void 0!==s&&s,u=(null===(r=t.ribbonOptions)||void 0===r?void 0:r.pointsMode)===Yf.POINTS_MODE_PATHS&&t.ribbonOptions.closePath;if(n>2)for(let e=0;e<l.length-1;e++){h[0]=1+n*e,h[1]=n*e,h[2]=(e+1)*n;for(let e=0;e<2*(n-1);e++)e%2!=0&&(h[2]+=1),e%2==0&&e>0&&(h[0]+=1,h[1]+=1),a.push(h[1]+(e%2!=0?n:0),h[0],h[2]),c&&a.push(h[0],h[1]+(e%2!=0?n:0),h[2])}else for(let e=0;e<o.length/3-3;e+=2)a.push(e,e+1,e+2),a.push(e+2,e+1,e+3),c&&(a.push(e+1,e,e+2),a.push(e+1,e+2,e+3));if(u){let e=n*(l.length-1);for(let t=0;t<n-1;t++)a.push(e,t+1,t),a.push(e+1,t+1,e),c&&(a.push(t,t+1,e),a.push(e,t+1,e+1)),e++}return{positions:o,indices:a}}_preprocess(e,t,i){var s,r,n,o;this._paths=e;const a=vm._CreateRibbonVertexData(e,i),l=a.positions;if(!this._options.widths)throw"No 'GreasedLineMeshOptions.widths' table is specified.";for(const e of l)this._vertexPositions.push(e);let h=e;if((null===(s=i.ribbonOptions)||void 0===s?void 0:s.pointsMode)===Yf.POINTS_MODE_PATHS&&i.ribbonOptions.closePath){h=[];for(let t=0;t<e.length;t++){const i=e[t].slice();i.push(e[t][0].clone()),h.push(i)}}this._calculateSegmentLengths(h);const c=h.length,u=new Array(c).fill(0);for(let e=0;e<h[0].length;e++){let t=0;for(let i=0;i<c;i++){const s=u[i]+this._vSegmentLengths[i][e]/this._vTotalLengths[i];this._counters.push(s),this._uvs.push(s,t),u[i]=s,t+=this._uSegmentLengths[e][i]/this._uTotalLengths[e]}}for(let e=0,t=0;e<h[0].length;e++){const i=this._uSegmentLengths[e][0]/2,s=this._uSegmentLengths[e][c-1]/2;this._ribbonWidths.push(((null!==(r=this._widths[t++])&&void 0!==r?r:1)-1)*i);for(let e=0;e<c-2;e++)this._ribbonWidths.push(0);this._ribbonWidths.push(((null!==(n=this._widths[t++])&&void 0!==n?n:1)-1)*s)}const d=(null===(o=i.ribbonOptions)||void 0===o?void 0:o.pointsMode)===Yf.POINTS_MODE_PATHS?new Array(h[0].length*h.length*6).fill(0):vm._CalculateSlopes(h);for(const e of d)this._slopes.push(e);if(a.indices)for(let e=0;e<a.indices.length;e++)this._indices.push(a.indices[e]+t);return t+l.length/3}static _ConvertToRibbonPath(e,t,i,s){if(t.pointsMode===Yf.POINTS_MODE_POINTS&&!t.width)throw"'GreasedLineMeshOptions.ribbonOptiosn.width' must be specified in GreasedLineRibbonPointsMode.POINTS_MODE_POINTS.";const r=[],n=[];if(t.pointsMode===Yf.POINTS_MODE_POINTS){const o=t.width/2,a=yf.ToVector3Array(e);let l=null,h=null;t.directionsAutoMode===Kf.AUTO_DIRECTIONS_FROM_FIRST_SEGMENT&&(s=vm._GetDirectionFromPoints(a[0],a[1],null));for(let e=0;e<a.length-(s?0:1);e++){const c=a[e],u=a[e+1];if(s)l=s;else if(t.directionsAutoMode===Kf.AUTO_DIRECTIONS_FROM_ALL_SEGMENTS)l=vm._GetDirectionFromPoints(c,u,l);else{const e=u.subtract(c);e.applyRotationQuaternionInPlace(e.x>e.y&&e.x>e.z?i?vm._RightHandedForwardReadOnlyQuaternion:vm._LeftHandedForwardReadOnlyQuaternion:vm._LeftReadOnlyQuaternion),l=e.normalize()}h=l.multiplyByFloats(o,o,o),r.push(c.add(h)),n.push(c.subtract(h))}s||(r.push(a[a.length-1].add(h)),n.push(a[a.length-1].subtract(h)))}return[r,n]}static _GetDirectionFromPoints(e,t,i){return e.x!==t.x||i&&1!==(null==i?void 0:i.x)?e.y===t.y?vm.DIRECTION_XZ:e.z===t.z?vm.DIRECTION_XY:vm.DIRECTION_XZ:vm.DIRECTION_YZ}clone(e=`${this.name}-cloned`,t){const i=this._createLineOptions(),s={},r=[];H.DeepCopy(this._pathsOptions,r,void 0,void 0,!0),H.DeepCopy(i,s,["instance"],void 0,!0);const n=new vm(e,this._scene,s,r);return t&&(n.parent=t),n.material=this.material,n}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions(),e.pathsOptions=this._pathsOptions}static Parse(e,t){const i=e.lineOptions,s=e.name,r=e.pathOptions;return new vm(s,t,i,r)}_initGreasedLine(){super._initGreasedLine(),this._paths=[],this._counters=[],this._slopes=[],this._ribbonWidths=[]}_calculateSegmentLengths(e){const t=e.length;this._vSegmentLengths=new Array(t),this._vTotalLengths=new Array(t);let i=0;for(let s=0;s<t;s++){const t=e[s];this._vSegmentLengths[s]=[0],i=0;for(let e=0;e<t.length-1;e++){const r=Math.abs(t[e].subtract(t[e+1]).lengthSquared());i+=r,this._vSegmentLengths[s].push(r)}this._vTotalLengths[s]=i}const s=e[0].length;this._uSegmentLengths=new Array(s).fill([]),this._uTotalLengths=new Array(s).fill([]);const r=new S;for(let n=0;n<s;n++){i=0;for(let s=1;s<t;s++){e[s][n].subtractToRef(e[s-1][n],r);const t=r.length();i+=t,this._uSegmentLengths[n].push(t)}this._uTotalLengths[n]=i}}static _CalculateSlopes(e){const t=e[0],i=2===e.length?e[1]:e[e.length-1],s=[],r=new S;for(let n=0;n<t.length;n++)for(let o=0;o<e.length;o++)0===o||o===e.length-1?(t[n].subtract(i[n]).normalizeToRef(r),s.push(r.x,r.y,r.z),s.push(-r.x,-r.y,-r.z)):s.push(0,0,0,0,0,0);return s}_createVertexBuffers(){var e,t;this._uvs=null!==(e=this._options.uvs)&&void 0!==e?e:this._uvs;const i=super._createVertexBuffers(null===(t=this._options.ribbonOptions)||void 0===t?void 0:t.smoothShading),s=new li(this._engine,this._counters,this._updatable,1);this.setVerticesBuffer(s.createVertexBuffer("grl_counters",0,1));const r=new li(this._engine,this._colorPointers,this._updatable,1);this.setVerticesBuffer(r.createVertexBuffer("grl_colorPointers",0,1));const n=new li(this._engine,this._slopes,this._updatable,3);this.setVerticesBuffer(n.createVertexBuffer("grl_slopes",0,3));const o=new li(this._engine,this._ribbonWidths,this._updatable,1);return this.setVerticesBuffer(o.createVertexBuffer("grl_widths",0,1)),this._widthsBuffer=o,i}}vm.DEFAULT_WIDTH=.1,vm._RightHandedForwardReadOnlyQuaternion=C.RotationAxis(S.RightHandedForwardReadOnly,Math.PI/2),vm._LeftHandedForwardReadOnlyQuaternion=C.RotationAxis(S.LeftHandedForwardReadOnly,Math.PI/2),vm._LeftReadOnlyQuaternion=C.RotationAxis(S.LeftReadOnly,Math.PI/2),vm.DIRECTION_XY=S.LeftHandedForwardReadOnly,vm.DIRECTION_XZ=S.UpReadOnly,vm.DIRECTION_YZ=S.LeftReadOnly,function(e){e[e.COLOR_DISTRIBUTION_NONE=0]="COLOR_DISTRIBUTION_NONE",e[e.COLOR_DISTRIBUTION_REPEAT=1]="COLOR_DISTRIBUTION_REPEAT",e[e.COLOR_DISTRIBUTION_EVEN=2]="COLOR_DISTRIBUTION_EVEN",e[e.COLOR_DISTRIBUTION_START=3]="COLOR_DISTRIBUTION_START",e[e.COLOR_DISTRIBUTION_END=4]="COLOR_DISTRIBUTION_END",e[e.COLOR_DISTRIBUTION_START_END=5]="COLOR_DISTRIBUTION_START_END"}($f||($f={})),function(e){e[e.WIDTH_DISTRIBUTION_NONE=0]="WIDTH_DISTRIBUTION_NONE",e[e.WIDTH_DISTRIBUTION_REPEAT=1]="WIDTH_DISTRIBUTION_REPEAT",e[e.WIDTH_DISTRIBUTION_EVEN=2]="WIDTH_DISTRIBUTION_EVEN",e[e.WIDTH_DISTRIBUTION_START=3]="WIDTH_DISTRIBUTION_START",e[e.WIDTH_DISTRIBUTION_END=4]="WIDTH_DISTRIBUTION_END",e[e.WIDTH_DISTRIBUTION_START_END=5]="WIDTH_DISTRIBUTION_START_END"}(qf||(qf={})),ur.prototype.thinInstanceAdd=function(e,t=!0){if(!this.getScene().getEngine().getCaps().instancedArrays)return k.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(e)?e.length:1);const i=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(e))for(let i=0;i<e.length;++i)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,e[i],i===e.length-1&&t);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,e,t);return i},ur.prototype.thinInstanceAddSelf=function(e=!0){return this.thinInstanceAdd(y.IdentityReadOnly,e)},ur.prototype.thinInstanceRegisterAttribute=function(e,t){e===hi.ColorKind&&(e=hi.ColorInstanceKind),this.removeVerticesData(e),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[e]=t,this._userThinInstanceBuffersStorage.sizes[e]=t*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[e]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[e]),this._userThinInstanceBuffersStorage.vertexBuffers[e]=new hi(this.getEngine(),this._userThinInstanceBuffersStorage.data[e],e,!0,!1,t,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[e])},ur.prototype.thinInstanceSetMatrixAt=function(e,t,i=!0){if(!this._thinInstanceDataStorage.matrixData||e>=this._thinInstanceDataStorage.instancesCount)return!1;const s=this._thinInstanceDataStorage.matrixData;return t.copyToArray(s,16*e),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[e]=t),i&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0},ur.prototype.thinInstanceSetAttributeAt=function(e,t,i,s=!0){return e===hi.ColorKind&&(e=hi.ColorInstanceKind),!(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[e]||t>=this._thinInstanceDataStorage.instancesCount||(this._thinInstanceUpdateBufferSize(e,0),this._userThinInstanceBuffersStorage.data[e].set(i,t*this._userThinInstanceBuffersStorage.strides[e]),s&&this.thinInstanceBufferUpdated(e),0))},Object.defineProperty(ur.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(e){var t,i;const s=null!==(t=this._thinInstanceDataStorage.matrixData)&&void 0!==t?t:null===(i=this.source)||void 0===i?void 0:i._thinInstanceDataStorage.matrixData;e<=(s?s.length/16:0)&&(this._thinInstanceDataStorage.instancesCount=e)},enumerable:!0,configurable:!0}),ur.prototype._thinInstanceCreateMatrixBuffer=function(e,t,i=!1){e===hi.ColorKind&&(e=hi.ColorInstanceKind);const s=new li(this.getEngine(),t,!i,16,!1,!0);for(let t=0;t<4;t++)this.setVerticesBuffer(s.createVertexBuffer(e+t,4*t,4));return s},ur.prototype.thinInstanceSetBuffer=function(e,t,i=0,s=!1){var r,n,o;i=i||16,"matrix"===e?(null===(r=this._thinInstanceDataStorage.matrixBuffer)||void 0===r||r.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=t?t.length:32*i,this._thinInstanceDataStorage.matrixData=t,this._thinInstanceDataStorage.worldMatrices=null,null!==t?(this._thinInstanceDataStorage.instancesCount=t.length/i,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",t,s),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo())):"previousMatrix"===e?(null===(n=this._thinInstanceDataStorage.previousMatrixBuffer)||void 0===n||n.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=t,null!==t&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",t,s))):(e===hi.ColorKind&&(e=hi.ColorInstanceKind),null===t?(null===(o=this._userThinInstanceBuffersStorage)||void 0===o?void 0:o.data[e])&&(this.removeVerticesData(e),delete this._userThinInstanceBuffersStorage.data[e],delete this._userThinInstanceBuffersStorage.strides[e],delete this._userThinInstanceBuffersStorage.sizes[e],delete this._userThinInstanceBuffersStorage.vertexBuffers[e]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[e]=t,this._userThinInstanceBuffersStorage.strides[e]=i,this._userThinInstanceBuffersStorage.sizes[e]=t.length,this._userThinInstanceBuffersStorage.vertexBuffers[e]=new hi(this.getEngine(),t,e,!s,!1,i,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[e])))},ur.prototype.thinInstanceBufferUpdated=function(e){var t,i,s;"matrix"===e?null===(t=this._thinInstanceDataStorage.matrixBuffer)||void 0===t||t.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount):"previousMatrix"===e?null===(i=this._thinInstanceDataStorage.previousMatrixBuffer)||void 0===i||i.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount):(e===hi.ColorKind&&(e=hi.ColorInstanceKind),(null===(s=this._userThinInstanceBuffersStorage)||void 0===s?void 0:s.vertexBuffers[e])&&this._userThinInstanceBuffersStorage.vertexBuffers[e].updateDirectly(this._userThinInstanceBuffersStorage.data[e],0))},ur.prototype.thinInstancePartialBufferUpdate=function(e,t,i){var s;"matrix"===e?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(t,i):(e===hi.ColorKind&&(e=hi.ColorInstanceKind),(null===(s=this._userThinInstanceBuffersStorage)||void 0===s?void 0:s.vertexBuffers[e])&&this._userThinInstanceBuffersStorage.vertexBuffers[e].updateDirectly(t,i))},ur.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];const e=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=[];for(let t=0;t<this._thinInstanceDataStorage.instancesCount;++t)this._thinInstanceDataStorage.worldMatrices[t]=y.FromArray(e,16*t)}return this._thinInstanceDataStorage.worldMatrices},ur.prototype.thinInstanceRefreshBoundingInfo=function(e=!1,t=!1,i=!1){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return;const s=this._thinInstanceDataStorage.boundingVectors;if(e||!this.rawBoundingInfo){s.length=0,this.refreshBoundingInfo(t,i);const e=this.getBoundingInfo();this.rawBoundingInfo=new Es(e.minimum,e.maximum)}const r=this.getBoundingInfo(),n=this._thinInstanceDataStorage.matrixData;if(0===s.length)for(let e=0;e<r.boundingBox.vectors.length;++e)s.push(r.boundingBox.vectors[e].clone());R.Vector3[0].setAll(Number.POSITIVE_INFINITY),R.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(let e=0;e<this._thinInstanceDataStorage.instancesCount;++e){y.FromArrayToRef(n,16*e,R.Matrix[0]);for(let e=0;e<s.length;++e)S.TransformCoordinatesToRef(s[e],R.Matrix[0],R.Vector3[2]),R.Vector3[0].minimizeInPlace(R.Vector3[2]),R.Vector3[1].maximizeInPlace(R.Vector3[2])}r.reConstruct(R.Vector3[0],R.Vector3[1]),this._updateBoundingInfo()},ur.prototype._thinInstanceUpdateBufferSize=function(e,t=1){var i,s,r;e===hi.ColorKind&&(e=hi.ColorInstanceKind);const n="matrix"===e;if(!(n||this._userThinInstanceBuffersStorage&&this._userThinInstanceBuffersStorage.strides[e]))return;const o=n?16:this._userThinInstanceBuffersStorage.strides[e],a=n?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[e];let l=n?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[e];const h=(this._thinInstanceDataStorage.instancesCount+t)*o;let c=a;for(;c<h;)c*=2;if(!l||a!=c){if(l){const e=new Float32Array(c);e.set(l,0),l=e}else l=new Float32Array(c);n?(null===(i=this._thinInstanceDataStorage.matrixBuffer)||void 0===i||i.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",l,!1),this._thinInstanceDataStorage.matrixData=l,this._thinInstanceDataStorage.matrixBufferSize=c,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&(null===(s=this._thinInstanceDataStorage.previousMatrixBuffer)||void 0===s||s.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",l,!1))):(null===(r=this._userThinInstanceBuffersStorage.vertexBuffers[e])||void 0===r||r.dispose(),this._userThinInstanceBuffersStorage.data[e]=l,this._userThinInstanceBuffersStorage.sizes[e]=c,this._userThinInstanceBuffersStorage.vertexBuffers[e]=new hi(this.getEngine(),l,e,!0,!1,o,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[e]))}},ur.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})},ur.prototype._disposeThinInstanceSpecificData=function(){var e;(null===(e=this._thinInstanceDataStorage)||void 0===e?void 0:e.matrixBuffer)&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null)},function(e){e[e.Int=1]="Int",e[e.Float=2]="Float",e[e.Vector2=4]="Vector2",e[e.Vector3=8]="Vector3",e[e.Vector4=16]="Vector4",e[e.Matrix=32]="Matrix",e[e.Geometry=64]="Geometry",e[e.Texture=128]="Texture",e[e.AutoDetect=1024]="AutoDetect",e[e.BasedOnInput=2048]="BasedOnInput",e[e.Undefined=4096]="Undefined",e[e.All=4095]="All"}(Qf||(Qf={})),function(e){e[e.Compatible=0]="Compatible",e[e.TypeIncompatible=1]="TypeIncompatible",e[e.HierarchyIssue=2]="HierarchyIssue"}(Zf||(Zf={})),function(e){e[e.Input=0]="Input",e[e.Output=1]="Output"}(Jf||(Jf={}));class xm{get direction(){return this._direction}get type(){if(this._type===Qf.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource&&this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type}if(this._type===Qf.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._type=e}get isConnected(){return null!==this.connectedPoint||this.hasEndpoints}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return 0===this._endpoints.length?[]:this._endpoints.map((e=>e.ownerBlock))}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get innerType(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type}_resetCounters(){this._callCount=0,this._executionCount=0}get callCount(){return this._callCount}get executionCount(){return this._executionCount}getConnectedValue(e){var t;return this.isConnected?(null===(t=this._connectedPoint)||void 0===t?void 0:t._storedFunction)?(this._connectedPoint._callCount++,this._connectedPoint._executionCount++,this._connectedPoint._storedFunction(e)):(this._connectedPoint._callCount++,this._connectedPoint._executionCount=1,this._connectedPoint._storedValue):(this._callCount++,this._executionCount=1,this.value)}constructor(e,t,i){this._connectedPoint=null,this._storedValue=null,this._storedFunction=null,this._acceptedConnectionPointType=null,this._endpoints=new Array,this._type=Qf.Geometry,this._linkedConnectionSource=null,this._typeConnectionSource=null,this._defaultConnectionPointType=null,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new a,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this.defaultValue=null,this.value=null,this.valueMin=null,this.valueMax=null,this._callCount=0,this._executionCount=0,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeGeometryConnectionPoint"}canConnectTo(e){return this.checkCompatibilityState(e)===Zf.Compatible}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(this.type!==e.type&&e.innerType!==Qf.AutoDetect)return e.acceptedConnectionPointTypes&&-1!==e.acceptedConnectionPointTypes.indexOf(this.type)?Zf.Compatible:Zf.TypeIncompatible;if(e.excludedConnectionPointTypes&&-1!==e.excludedConnectionPointTypes.indexOf(this.type))return Zf.TypeIncompatible;let s=i,r=t;return this.direction===Jf.Input&&(s=t,r=i),s.isAnAncestorOf(r)?Zf.HierarchyIssue:Zf.Compatible}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return-1===t||(this._endpoints.splice(t,1),e._connectedPoint=null),this}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<Qf.All;)e&t||this.excludedConnectionPointTypes.push(t),t<<=1}serialize(e=!0){const t={};return t.name=this.name,t.displayName=this.displayName,void 0!==this.value&&null!==this.value&&(this.value.asArray?(t.valueType="BABYLON."+this.value.getClassName(),t.value=this.value.asArray()):(t.valueType="number",t.value=this.value)),e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name),t}dispose(){this.onConnectionObservable.clear()}}class Tm{get buildExecutionTime(){return this._buildExecutionTime}get inputs(){return this._inputs}get outputs(){return this._outputs}get name(){return this._name}set name(e){this._name=e}get isInput(){return this._isInput}get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get isDebug(){return this._isDebug}get isUnique(){return this._isUnique}getClassName(){return"NodeGeometryBlock"}_inputRename(e){return e}_outputRename(e){return e}isAnAncestorOf(e){for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints){if(i.ownerBlock===e)return!0;if(i.ownerBlock.isAnAncestorOf(e))return!0}return!1}isAnAncestorOfType(e){if(this.getClassName()===e)return!0;for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints)if(i.ownerBlock.isAnAncestorOfType(e))return!0;return!1}getDescendantOfPredicate(e){if(e(this))return this;for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints){const t=i.ownerBlock.getDescendantOfPredicate(e);if(t)return t}return null}constructor(e){this._name="",this._isInput=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._isDebug=!1,this._isUnique=!1,this._buildExecutionTime=0,this.onBuildObservable=new a,this._inputs=new Array,this._outputs=new Array,this._codeVariableName="",this.visibleOnFrame=!1,this._name=e,this.uniqueId=Bi.UniqueId}registerInput(e,t,i=!1,s,r,n){const o=new xm(e,this,Jf.Input);return o.type=t,o.isOptional=i,o.defaultValue=s,o.value=s,o.valueMin=r,o.valueMax=n,this._inputs.push(o),this}registerOutput(e,t,i){return(i=null!=i?i:new xm(e,this,Jf.Output)).type=t,this._outputs.push(i),this}_buildBlock(e){}_customBuildStep(e){}build(e){if(this._buildId===e.buildId)return!0;if(this._outputs.length>0){if(!this._outputs.some((e=>e.hasEndpoints))&&!this.isDebug)return!1;this.outputs.forEach((e=>e._resetCounters()))}this._buildId=e.buildId;for(const t of this._inputs){if(!t.connectedPoint){t.isOptional||e.notConnectedNonOptionalInputs.push(t);continue}const i=t.connectedPoint.ownerBlock;i&&i!==this&&i.build(e)}this._customBuildStep(e),e.verbose&&console.log(`Building ${this.name} [${this.getClassName()}]`);const t=Fe.Now;this._buildBlock(e),this._buildExecutionTime=Fe.Now-t;for(const t of this._outputs)for(const i of t.endpoints){const t=i.ownerBlock;t&&t.build(e)}return this.onBuildObservable.notifyObservers(this),!1}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[t]._linkedConnectionSource=this._inputs[e]}initialize(){}autoConfigure(){}getInputByName(e){const t=this._inputs.filter((t=>t.name===e));return t.length?t[0]:null}getOutputByName(e){const t=this._outputs.filter((t=>t.name===e));return t.length?t[0]:null}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.inputs=[],e.outputs=[];for(const t of this.inputs)e.inputs.push(t.serialize());for(const t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e){this._name=e.name,this.comments=e.comments,this.visibleOnFrame=!!e.visibleOnFrame,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const t=e.inputs,i=e.outputs;t&&t.forEach((e=>{const t=this.inputs.find((t=>t.name===e.name));if(t&&(e.displayName&&(t.displayName=e.displayName),e.isExposedOnFrame&&(t.isExposedOnFrame=e.isExposedOnFrame,t.exposedPortPosition=e.exposedPortPosition),void 0!==e.value&&null!==e.value))if("number"===e.valueType)t.value=e.value;else{const i=g(e.valueType);i&&(t.value=i.FromArray(e.value))}})),i&&i.forEach(((e,t)=>{e.displayName&&(this.outputs[t].displayName=e.displayName),e.isExposedOnFrame&&(this.outputs[t].isExposedOnFrame=e.isExposedOnFrame,this.outputs[t].exposedPortPosition=e.exposedPortPosition)}))}_dumpPropertiesCode(){return`${this._codeVariableName}.visibleOnFrame = ${this.visibleOnFrame};\n`}_dumpCodeForOutputConnections(e){let t="";if(-1!==e.indexOf(this))return t;e.push(this);for(const i of this.inputs){if(!i.isConnected)continue;const s=i.connectedPoint,r=s.ownerBlock;t+=r._dumpCodeForOutputConnections(e),t+=`${r._codeVariableName}.${r._outputRename(s.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});\n`}return t}_dumpCode(e,t){t.push(this);const i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||`${this.getClassName()}_${this.uniqueId}`,-1!==e.indexOf(this._codeVariableName)){let t=0;do{t++,this._codeVariableName=i+t}while(-1!==e.indexOf(this._codeVariableName))}e.push(this._codeVariableName);let s=`\n// ${this.getClassName()}\n`;this.comments&&(s+=`// ${this.comments}\n`),s+=`var ${this._codeVariableName} = new BABYLON.${this.getClassName()}("${this.name}");\n`,s+=this._dumpPropertiesCode();for(const i of this.inputs){if(!i.isConnected)continue;const r=i.connectedPoint.ownerBlock;-1===t.indexOf(r)&&(s+=r._dumpCode(e,t))}for(const i of this.outputs)if(i.hasEndpoints)for(const r of i.endpoints){const i=r.ownerBlock;i&&-1===t.indexOf(i)&&(s+=i._dumpCode(e,t))}return s}clone(){const e=this.serialize(),t=g(e.customType);if(t){const i=new t;return i._deserialize(e),i}return null}dispose(){for(const e of this.inputs)e.dispose();for(const e of this.outputs)e.dispose();this.onBuildObservable.clear()}}me([ie("comment")],Tm.prototype,"comments",void 0);class Em extends Tm{get currentVertexData(){return this._vertexData}constructor(e){super(e),this._vertexData=null,this._isUnique=!0,this.registerInput("geometry",Qf.Geometry)}getClassName(){return"GeometryOutputBlock"}get geometry(){return this._inputs[0]}_buildBlock(e){e.vertexData=this.geometry.getConnectedValue(e),this._vertexData=e.vertexData}}m("BABYLON.GeometryOutputBlock",Em),function(e){e[e.None=0]="None",e[e.Positions=1]="Positions",e[e.Normals=2]="Normals",e[e.Tangents=3]="Tangents",e[e.UV=4]="UV",e[e.UV2=5]="UV2",e[e.UV3=6]="UV3",e[e.UV4=7]="UV4",e[e.UV5=8]="UV5",e[e.UV6=9]="UV6",e[e.Colors=10]="Colors",e[e.VertexID=11]="VertexID",e[e.FaceID=12]="FaceID",e[e.GeometryID=13]="GeometryID",e[e.CollectionID=14]="CollectionID",e[e.LoopID=15]="LoopID",e[e.InstanceID=16]="InstanceID"}(em||(em={}));class Sm{constructor(){this._rotationMatrix=new y,this._scalingMatrix=new y,this._positionMatrix=new y,this._scalingRotationMatrix=new y,this._transformMatrix=new y,this._tempVector3=new S,this.notConnectedNonOptionalInputs=[],this.noContextualData=[],this.vertexData=null,this._geometryContext=null,this._executionContext=null,this._instancingContext=null,this._geometryContextStack=[],this._executionContextStack=[],this._instancingContextStack=[]}get geometryContext(){return this._geometryContext}get executionContext(){return this._executionContext}get instancingContext(){return this._instancingContext}pushGeometryContext(e){this._geometryContext=e,this._geometryContextStack.push(this._geometryContext)}pushExecutionContext(e){this._executionContext=e,this._executionContextStack.push(this._executionContext)}pushInstancingContext(e){this._instancingContext=e,this._instancingContextStack.push(this._instancingContext)}restoreGeometryContext(){this._geometryContextStack.pop(),this._geometryContext=this._geometryContextStack.length>0?this._geometryContextStack[this._geometryContextStack.length-1]:null}restoreExecutionContext(){this._executionContextStack.pop(),this._executionContext=this._executionContextStack.length>0?this._executionContextStack[this._executionContextStack.length-1]:null}restoreInstancingContext(){this._instancingContextStack.pop(),this._instancingContext=this._instancingContextStack.length>0?this._instancingContextStack[this._instancingContextStack.length-1]:null}getContextualValue(e,t=!1){if(!this.executionContext)return t||this.noContextualData.push(e),null;const i=this.executionContext.getExecutionIndex();switch(e){case em.Positions:return this.executionContext.getOverridePositionsContextualValue?this.executionContext.getOverridePositionsContextualValue():this.geometryContext&&this.geometryContext.positions?S.FromArray(this.geometryContext.positions,3*i):S.Zero();case em.Normals:return this.executionContext.getOverrideNormalsContextualValue?this.executionContext.getOverrideNormalsContextualValue():this.geometryContext&&this.geometryContext.normals?S.FromArray(this.geometryContext.normals,3*i):S.Zero();case em.Colors:return this.geometryContext&&this.geometryContext.colors?b.FromArray(this.geometryContext.colors,4*i):b.Zero();case em.Tangents:return this.geometryContext&&this.geometryContext.tangents?b.FromArray(this.geometryContext.tangents,4*i):b.Zero();case em.UV:return this.executionContext.getOverrideUVs1ContextualValue?this.executionContext.getOverrideUVs1ContextualValue():this.geometryContext&&this.geometryContext.uvs?E.FromArray(this.geometryContext.uvs,2*i):E.Zero();case em.UV2:return this.geometryContext&&this.geometryContext.uvs2?E.FromArray(this.geometryContext.uvs2,2*i):E.Zero();case em.UV3:return this.geometryContext&&this.geometryContext.uvs3?E.FromArray(this.geometryContext.uvs3,2*i):E.Zero();case em.UV4:return this.geometryContext&&this.geometryContext.uvs4?E.FromArray(this.geometryContext.uvs4,2*i):E.Zero();case em.UV5:return this.geometryContext&&this.geometryContext.uvs5?E.FromArray(this.geometryContext.uvs5,2*i):E.Zero();case em.UV6:return this.geometryContext&&this.geometryContext.uvs6?E.FromArray(this.geometryContext.uvs6,2*i):E.Zero();case em.VertexID:return i;case em.FaceID:return this.executionContext.getExecutionFaceIndex();case em.LoopID:return this.executionContext.getExecutionLoopIndex();case em.InstanceID:return this.instancingContext?this.instancingContext.getInstanceIndex():0;case em.GeometryID:return this.geometryContext?this.geometryContext.uniqueId:0;case em.CollectionID:return this.geometryContext&&this.geometryContext.metadata&&this.geometryContext.metadata.collectionId||0}return null}adapt(e,t){const i=e.getConnectedValue(this)||0;if(e.type===t)return i;switch(t){case Qf.Vector2:return new E(i,i);case Qf.Vector3:return new S(i,i,i);case Qf.Vector4:return new b(i,i,i,i)}return null}adaptInput(e,t,i){var s;if(!e.isConnected)return e.value||i;const r=e.getConnectedValue(this);if((null===(s=e._connectedPoint)||void 0===s?void 0:s.type)===t)return r;switch(t){case Qf.Vector2:return new E(r,r);case Qf.Vector3:return new S(r,r,r);case Qf.Vector4:return new b(r,r,r,r)}return null}emitErrors(){let e="";for(const t of this.notConnectedNonOptionalInputs)e+=`input ${t.name} from block ${t.ownerBlock.name}[${t.ownerBlock.getClassName()}] is not connected and is not optional.\n`;for(const t of this.noContextualData)e+=`Contextual input ${em[t]} has no context to pull data from (must be connected to a setXXX block or a instantiateXXX block).\n`;if(e)throw"Build of NodeGeometry failed:\n"+e}_instantiate(e,t,i,s,r){y.ScalingToRef(s.x,s.y,s.z,this._scalingMatrix),y.RotationYawPitchRollToRef(i.y,i.x,i.z,this._rotationMatrix),y.TranslationToRef(t.x,t.y,t.z,this._positionMatrix),this._scalingMatrix.multiplyToRef(this._rotationMatrix,this._scalingRotationMatrix),this._scalingRotationMatrix.multiplyToRef(this._positionMatrix,this._transformMatrix);for(let t=0;t<e.positions.length;t+=3)this._tempVector3.fromArray(e.positions,t),S.TransformCoordinatesToRef(this._tempVector3,this._transformMatrix,this._tempVector3),this._tempVector3.toArray(e.positions,t),e.normals&&(this._tempVector3.fromArray(e.normals,t),S.TransformNormalToRef(this._tempVector3,this._scalingRotationMatrix,this._tempVector3),this._tempVector3.toArray(e.normals,t));r.push(e)}_instantiateWithMatrix(e,t,i){for(let i=0;i<e.positions.length;i+=3)this._tempVector3.fromArray(e.positions,i),S.TransformCoordinatesToRef(this._tempVector3,t,this._tempVector3),this._tempVector3.toArray(e.positions,i),e.normals&&(this._tempVector3.fromArray(e.normals,i),S.TransformNormalToRef(this._tempVector3,t,this._tempVector3),this._tempVector3.toArray(e.normals,i));i.push(e)}_instantiateWithPositionAndMatrix(e,t,i,s){y.TranslationToRef(t.x,t.y,t.z,this._positionMatrix),i.multiplyToRef(this._positionMatrix,this._transformMatrix);for(let t=0;t<e.positions.length;t+=3)this._tempVector3.fromArray(e.positions,t),S.TransformCoordinatesToRef(this._tempVector3,this._transformMatrix,this._tempVector3),this._tempVector3.toArray(e.positions,t),e.normals&&(this._tempVector3.fromArray(e.normals,t),S.TransformNormalToRef(this._tempVector3,this._transformMatrix,this._tempVector3),this._tempVector3.toArray(e.normals,t));s.push(e)}}class bm extends Tm{get type(){if(this._type===Qf.AutoDetect&&null!=this.value){if(!isNaN(this.value))return this._type=Qf.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=Qf.Vector2,this._type;case"Vector3":return this._type=Qf.Vector3,this._type;case"Vector4":return this._type=Qf.Vector4,this._type;case"Matrix":return this._type=Qf.Matrix,this._type}}return this._type}get isContextual(){return this._contextualSource!==em.None}get contextualValue(){return this._contextualSource}set contextualValue(e){switch(this._contextualSource=e,e){case em.Positions:case em.Normals:this._type=Qf.Vector3;break;case em.Colors:case em.Tangents:this._type=Qf.Vector4;break;case em.UV:case em.UV2:case em.UV3:case em.UV4:case em.UV5:case em.UV6:this._type=Qf.Vector2;break;case em.VertexID:case em.GeometryID:case em.CollectionID:case em.FaceID:case em.LoopID:case em.InstanceID:this._type=Qf.Int}this.output&&(this.output.type=this._type)}constructor(e,t=Qf.AutoDetect){super(e),this._type=Qf.Undefined,this._contextualSource=em.None,this.min=0,this.max=0,this.groupInInspector="",this.onValueChangedObservable=new a,this._type=t,this._isInput=!0,this.setDefaultValue(),this.registerOutput("output",t)}get value(){return this._storedValue}set value(e){this.type===Qf.Float&&this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e)),this._storedValue=e,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e}getClassName(){return"GeometryInputBlock"}get output(){return this._outputs[0]}setDefaultValue(){switch(this.contextualValue=em.None,this.type){case Qf.Int:case Qf.Float:this.value=0;break;case Qf.Vector2:this.value=E.Zero();break;case Qf.Vector3:this.value=S.Zero();break;case Qf.Vector4:this.value=b.Zero();break;case Qf.Matrix:this.value=y.Identity()}}_buildBlock(e){super._buildBlock(e),this.isContextual?(this.output._storedValue=null,this.output._storedFunction=e=>e.getContextualValue(this._contextualSource)):(this.output._storedFunction=null,this.output._storedValue=this.value)}dispose(){this.onValueChangedObservable.clear(),super.dispose()}_dumpPropertiesCode(){const e=this._codeVariableName;if(this.isContextual)return super._dumpPropertiesCode()+`${e}.contextualValue = BABYLON.NodeGeometryContextualSources.${em[this._contextualSource]};\n`;const t=[];let i="";switch(this.type){case Qf.Float:case Qf.Int:i=`${this.value}`;break;case Qf.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case Qf.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case Qf.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`}return t.push(`${e}.value = ${i}`),this.type!==Qf.Float&&this.type!==Qf.Int||t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`),t.push(""),super._dumpPropertiesCode()+t.join(";\n")}serialize(){const e=super.serialize();return e.type=this.type,e.contextualValue=this.contextualValue,e.min=this.min,e.max=this.max,e.groupInInspector=this.groupInInspector,null===this._storedValue||this.isContextual||(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e){if(super._deserialize(e),this._type=e.type,this.contextualValue=e.contextualValue,this.min=e.min||0,this.max=e.max||0,this.groupInInspector=e.groupInInspector||"",e.valueType)if("number"===e.valueType)this._storedValue=e.value;else{const t=g(e.valueType);t&&(this._storedValue=t.FromArray(e.value))}}}m("BABYLON.GeometryInputBlock",bm);class Cm extends Tm{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("size",Qf.Float,!0,1),this.registerInput("width",Qf.Float,!0,0),this.registerInput("height",Qf.Float,!0,0),this.registerInput("depth",Qf.Float,!0,0),this.registerInput("subdivisions",Qf.Int,!0,1),this.registerInput("subdivisionsX",Qf.Int,!0,0),this.registerInput("subdivisionsY",Qf.Int,!0,0),this.registerInput("subdivisionsZ",Qf.Int,!0,0),this.registerOutput("geometry",Qf.Geometry)}getClassName(){return"BoxBlock"}get size(){return this._inputs[0]}get width(){return this._inputs[1]}get height(){return this._inputs[2]}get depth(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get subdivisionsX(){return this._inputs[5]}get subdivisionsY(){return this._inputs[6]}get subdivisionsZ(){return this._inputs[7]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.size.isConnected){if(!this.width.isConnected&&!this.height.isConnected&&!this.depth.isConnected){const e=new bm("Size");return e.value=1,void e.output.connectTo(this.size)}if(!this.width.isConnected){const e=new bm("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){const e=new bm("Height");e.value=1,e.output.connectTo(this.height)}if(!this.depth.isConnected){const e=new bm("Depth");e.value=1,e.output.connectTo(this.depth)}}}_buildBlock(e){const t={},i=e=>{t.size=this.size.getConnectedValue(e),t.width=this.width.getConnectedValue(e),t.height=this.height.getConnectedValue(e),t.depth=this.depth.getConnectedValue(e);const i=this.subdivisions.getConnectedValue(e),s=this.subdivisionsX.getConnectedValue(e),r=this.subdivisionsY.getConnectedValue(e),n=this.subdivisionsZ.getConnectedValue(e);return i&&(t.segments=i),s&&(t.widthSegments=s),r&&(t.heightSegments=r),n&&(t.depthSegments=n),function(e){const t=e.width||e.size||1,i=e.height||e.size||1,s=e.depth||e.size||1,r=0|(e.widthSegments||e.segments||1),n=0|(e.heightSegments||e.segments||1),o=0|(e.depthSegments||e.segments||1),a=new y,l=new y,h=new y,c=el({width:t,height:s,subdivisionsX:r,subdivisionsY:o});y.TranslationToRef(0,-i/2,0,l),y.RotationZToRef(Math.PI,a),a.multiplyToRef(l,h),c.transform(h);const u=el({width:t,height:s,subdivisionsX:r,subdivisionsY:o});y.TranslationToRef(0,i/2,0,h),u.transform(h);const d=el({width:i,height:s,subdivisionsX:n,subdivisionsY:o});y.TranslationToRef(-t/2,0,0,l),y.RotationZToRef(Math.PI/2,a),a.multiplyToRef(l,h),d.transform(h);const p=el({width:i,height:s,subdivisionsX:n,subdivisionsY:o});y.TranslationToRef(t/2,0,0,l),y.RotationZToRef(-Math.PI/2,a),a.multiplyToRef(l,h),p.transform(h);const _=el({width:t,height:i,subdivisionsX:r,subdivisionsY:n});y.TranslationToRef(0,0,-s/2,l),y.RotationXToRef(-Math.PI/2,a),a.multiplyToRef(l,h),_.transform(h);const f=el({width:t,height:i,subdivisionsX:r,subdivisionsY:n});return y.TranslationToRef(0,0,s/2,l),y.RotationXToRef(Math.PI/2,a),a.multiplyToRef(l,h),f.transform(h),c.merge([u,p,d,_,f],!0),c}(t)};if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Cm.prototype,"evaluateContext",void 0),m("BABYLON.BoxBlock",Cm);class ym{_getGlobalNodeGeometryEditor(){return"undefined"!=typeof NODEGEOMETRYEDITOR?NODEGEOMETRYEDITOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.NodeGeometryEditor?BABYLON:void 0}get buildExecutionTime(){return this._buildExecutionTime}constructor(e){this._buildId=ym._BuildIdGenerator++,this._buildWasSuccessful=!1,this._vertexData=null,this._buildExecutionTime=0,this.BJSNODEGEOMETRYEDITOR=this._getGlobalNodeGeometryEditor(),this.editorData=null,this.attachedBlocks=[],this.onBuildObservable=new a,this.outputBlock=null,this.name=e}getClassName(){return"NodeGeometry"}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e){if(t)return Ht.Warn("More than one block was found with the name `"+e+"`"),t;t=i}return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}edit(e){return new Promise((t=>{if(this.BJSNODEGEOMETRYEDITOR=this.BJSNODEGEOMETRYEDITOR||this._getGlobalNodeGeometryEditor(),void 0===this.BJSNODEGEOMETRYEDITOR){const i=e&&e.editorURL?e.editorURL:ym.EditorURL;Ht.LoadBabylonScript(i,(()=>{this.BJSNODEGEOMETRYEDITOR=this.BJSNODEGEOMETRYEDITOR||this._getGlobalNodeGeometryEditor(),this._createNodeEditor(null==e?void 0:e.nodeGeometryEditorConfig),t()}))}else this._createNodeEditor(null==e?void 0:e.nodeGeometryEditorConfig),t()}))}_createNodeEditor(e){const t=Object.assign({nodeGeometry:this},e);this.BJSNODEGEOMETRYEDITOR.NodeGeometryEditor.Show(t)}build(e=!1,t=!0,i=!1){if(this._buildWasSuccessful=!1,!this.outputBlock)throw"You must define the outputBlock property before building the geometry";const s=Fe.Now;this._initializeBlock(this.outputBlock,i);const r=new Sm;r.buildId=this._buildId,r.verbose=e,this.outputBlock.build(r),t&&(this._buildId=ym._BuildIdGenerator++),this._buildExecutionTime=Fe.Now-s,r.emitErrors(),this._buildWasSuccessful=!0,this._vertexData=r.vertexData,this.onBuildObservable.notifyObservers(this)}createMesh(e,t=null){if(this._buildWasSuccessful||this.build(),!this._vertexData)return null;const i=new ur(e,t);return this._vertexData.applyToMesh(i),i._internalMetadata=i._internalMetadata||{},i._internalMetadata.nodeGeometry=this,i}updateMesh(e){return this._buildWasSuccessful||this.build(),!!this._vertexData&&(this._vertexData.applyToMesh(e),e._internalMetadata=e._internalMetadata||{},e._internalMetadata.nodeGeometry=this,e)}_initializeBlock(e,t=!0){e.initialize(),t&&e.autoConfigure(),e._preparationId=this._buildId,-1===this.attachedBlocks.indexOf(e)&&this.attachedBlocks.push(e);for(const i of e.inputs){const s=i.connectedPoint;if(s){const i=s.ownerBlock;i!==e&&this._initializeBlock(i,t)}}}clear(){this.outputBlock=null,this.attachedBlocks.length=0}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e===this.outputBlock&&(this.outputBlock=null)}parseSerializedObject(e,t=!1){t||this.clear();const i={};for(const t of e.blocks){const e=g(t.customType);if(e){const s=new e;s._deserialize(t),i[t.id]=s,this.attachedBlocks.push(s)}}for(const e of this.attachedBlocks)if(e.isTeleportOut){const t=e,s=t._tempEntryPointUniqueId;if(s){const e=i[s];e&&e.attachToEndpoint(t)}}for(let s=0;s<e.blocks.length;s++){const r=e.blocks[s],n=i[r.id];n&&(n.inputs.length&&r.inputs.some((e=>e.targetConnectionName))&&!t||this._restoreConnections(n,e,i))}if(e.outputNodeId&&(this.outputBlock=i[e.outputNodeId]),e.locations||e.editorData&&e.editorData.locations){const s=e.locations||e.editorData.locations;for(const e of s)i[e.blockId]&&(e.blockId=i[e.blockId].uniqueId);t&&this.editorData&&this.editorData.locations&&s.concat(this.editorData.locations),e.locations?this.editorData={locations:s}:(this.editorData=e.editorData,this.editorData.locations=s);const r=[];for(const e in i)r[e]=i[e].uniqueId;this.editorData.map=r}this.comment=e.comment}_restoreConnections(e,t,i){for(const s of e.outputs)for(const r of t.blocks){const n=i[r.id];if(n)for(const o of r.inputs)if(i[o.targetBlockId]!==e||o.targetConnectionName!==s.name);else{const e=n.getInputByName(o.inputName);if(!e||e.isConnected)continue;s.connectTo(e,!0),this._restoreConnections(n,t,i)}}}generateCode(){let e=[];const t=[],i=["const","var","let"];this.outputBlock&&this._gatherBlocks(this.outputBlock,t);let s=`let nodeGeometry = new BABYLON.NodeGeometry("${this.name||"node geometry"}");\n`;for(const r of t)r.isInput&&-1===e.indexOf(r)&&(s+=r._dumpCode(i,e));return this.outputBlock&&(e=[],s+="// Connections\n",s+=this.outputBlock._dumpCodeForOutputConnections(e),s+="// Output nodes\n",s+=`nodeGeometry.outputBlock = ${this.outputBlock._codeVariableName};\n`,s+="nodeGeometry.build();\n"),s}_gatherBlocks(e,t){if(-1===t.indexOf(e)){t.push(e);for(const i of e.inputs){const s=i.connectedPoint;if(s){const i=s.ownerBlock;i!==e&&this._gatherBlocks(i,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._gatherBlocks(i.entryPoint,t)}}}setToDefault(){this.clear(),this.editorData=null;const e=new Cm("Box");e.autoConfigure();const t=new Em("Geometry Output");e.geometry.connectTo(t.geometry),this.outputBlock=t}clone(e){const t=this.serialize(),i=de.Clone((()=>new ym(e)),this);return i.name=e,i.parseSerializedObject(t),i._buildId=this._buildId,i.build(!1),i}serialize(e){const t=e?{}:de.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];e?i=e:(t.customType="BABYLON.NodeGeometry",this.outputBlock&&(t.outputNodeId=this.outputBlock.uniqueId)),t.blocks=[];for(const e of i)t.blocks.push(e.serialize());if(!e)for(const e of this.attachedBlocks)-1===i.indexOf(e)&&t.blocks.push(e.serialize());return t}dispose(){for(const e of this.attachedBlocks)e.dispose();this.attachedBlocks.length=0,this.onBuildObservable.clear()}static CreateDefault(e){const t=new ym(e);return t.setToDefault(),t.build(),t}static Parse(e){const t=de.Parse((()=>new ym(e.name)),e,null);return t.parseSerializedObject(e),t.build(),t}static ParseFromSnippetAsync(e,t,i=!1){return"_BLANK"===e?Promise.resolve(ym.CreateDefault("blank")):new Promise(((s,r)=>{const n=new Te;n.addEventListener("readystatechange",(()=>{if(4==n.readyState)if(200==n.status){const o=JSON.parse(JSON.parse(n.responseText).jsonPayload),a=JSON.parse(o.nodeGeometry);t||(t=de.Parse((()=>new ym(e)),a,null)),t.parseSerializedObject(a),t.snippetId=e;try{i||t.build(),s(t)}catch(e){r(e)}}else r("Unable to load the snippet "+e)})),n.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),n.send()}))}}ym._BuildIdGenerator=0,ym.EditorURL=`${Ht._DefaultCdnUrl}/v${Ns.Version}/nodeGeometryEditor/babylon.nodeGeometryEditor.js`,ym.SnippetUrl="https://snippet.babylonjs.com",me([ie()],ym.prototype,"name",void 0),me([ie("comment")],ym.prototype,"comment",void 0);class Am extends Tm{constructor(e){super(e),this.evaluateContext=!0,this.epsilon=u,this.registerInput("geometry",Qf.Geometry),this.registerOutput("output",Qf.Geometry)}getClassName(){return"GeometryOptimizeBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(!this.geometry.isConnected)return null;const t=this.geometry.getConnectedValue(e),i=[],s={};for(let e=0;e<t.positions.length;e+=3){const r=t.positions[e],n=t.positions[e+1],o=t.positions[e+2];let a=!1;for(let t=0;t<i.length;t+=3)l.WithinEpsilon(r,i[t],this.epsilon)&&l.WithinEpsilon(n,i[t+1],this.epsilon)&&l.WithinEpsilon(o,i[t+2],this.epsilon)&&(s[e/3]=t/3,a=!0);a||(s[e/3]=i.length/3,i.push(r,n,o))}const r=new As;return r.positions=i,r.indices=t.indices.map((e=>s[e])),r};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`;return e+=`${this._codeVariableName}.epsilon = ${this.epsilon};\n`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.epsilon=this.epsilon,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext,this.epsilon=e.epsilon}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Am.prototype,"evaluateContext",void 0),me([Zr("Epsilon",Js.Float,"ADVANCED",{notifiers:{rebuild:!0}})],Am.prototype,"epsilon",void 0),m("BABYLON.GeometryOptimizeBlock",Am);class Rm extends Tm{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("size",Qf.Float,!0,1),this.registerInput("width",Qf.Float,!0,0),this.registerInput("height",Qf.Float,!0,0),this.registerOutput("geometry",Qf.Geometry)}getClassName(){return"PlaneBlock"}get size(){return this._inputs[0]}get width(){return this._inputs[1]}get height(){return this._inputs[2]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.size.isConnected){if(!this.width.isConnected&&!this.height.isConnected){const e=new bm("Size");return e.value=1,void e.output.connectTo(this.size)}if(!this.width.isConnected){const e=new bm("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){const e=new bm("Height");e.value=1,e.output.connectTo(this.height)}}}_buildBlock(e){const t={},i=e=>(t.size=this.size.getConnectedValue(e),t.width=this.width.getConnectedValue(e),t.height=this.height.getConnectedValue(e),Lr(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Rm.prototype,"evaluateContext",void 0),m("BABYLON.PlaneBlock",Rm);class Im extends Tm{get mesh(){return this._mesh}set mesh(e){this._mesh=e}constructor(e){super(e),this._cachedVertexData=null,this.reverseWindingOrder=!1,this.serializedCachedData=!1,this.registerOutput("geometry",Qf.Geometry)}getClassName(){return"MeshBlock"}get isUsingCachedData(){return!this.mesh&&!!this._cachedVertexData}get geometry(){return this._outputs[0]}cleanData(){this._mesh=null,this._cachedVertexData=null}_buildBlock(){if(!this._mesh)return void(this._cachedVertexData?this.geometry._storedValue=this._cachedVertexData.clone():this.geometry._storedValue=null);const e=As.ExtractFromMesh(this._mesh,!1,!0);if(this._cachedVertexData=null,this.reverseWindingOrder&&e.indices)for(let t=0;t<e.indices.length;t+=3){const i=e.indices[t];e.indices[t]=e.indices[t+2],e.indices[t+2]=i}this.geometry._storedFunction=()=>e.clone()}serialize(){const e=super.serialize();return e.serializedCachedData=this.serializedCachedData,this.serializedCachedData&&(this._mesh?e.cachedVertexData=As.ExtractFromMesh(this._mesh,!1,!0).serialize():this._cachedVertexData&&(e.cachedVertexData=this._cachedVertexData.serialize())),e.reverseWindingOrder=this.reverseWindingOrder,e}_deserialize(e){super._deserialize(e),e.cachedVertexData&&(this._cachedVertexData=As.Parse(e.cachedVertexData)),this.serializedCachedData=!!e.serializedCachedData,this.reverseWindingOrder=e.reverseWindingOrder}}me([Zr("Serialize cached data",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Im.prototype,"serializedCachedData",void 0),m("BABYLON.MeshBlock",Im);class Pm extends Tm{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("radius",Qf.Float,!0,1),this.registerInput("radiusX",Qf.Float,!0,0),this.registerInput("radiusY",Qf.Float,!0,0),this.registerInput("radiusZ",Qf.Float,!0,0),this.registerInput("subdivisions",Qf.Int,!0,4),this.registerOutput("geometry",Qf.Geometry)}getClassName(){return"IcoSphereBlock"}get radius(){return this._inputs[0]}get radiusX(){return this._inputs[1]}get radiusY(){return this._inputs[2]}get radiusZ(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.radius.isConnected){const e=new bm("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){const t={},i=e=>(t.radius=this.radius.getConnectedValue(e),t.subdivisions=this.subdivisions.getConnectedValue(e),t.radiusX=this.radiusX.getConnectedValue(e),t.radiusY=this.radiusY.getConnectedValue(e),t.radiusZ=this.radiusZ.getConnectedValue(e),Xn(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Pm.prototype,"evaluateContext",void 0),m("BABYLON.IcoSphereBlock",Pm);class Mm extends Tm{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("segments",Qf.Int,!0,32),this.registerInput("diameter",Qf.Float,!0,1),this.registerInput("diameterX",Qf.Float,!0,0),this.registerInput("diameterY",Qf.Float,!0,0),this.registerInput("diameterZ",Qf.Float,!0,0),this.registerInput("arc",Qf.Float,!0,1),this.registerInput("slice",Qf.Float,!0,1),this.registerOutput("geometry",Qf.Geometry)}getClassName(){return"SphereBlock"}get segments(){return this._inputs[0]}get diameter(){return this._inputs[1]}get diameterX(){return this._inputs[2]}get diameterY(){return this._inputs[3]}get diameterZ(){return this._inputs[4]}get arc(){return this._inputs[5]}get slice(){return this._inputs[6]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){const e=new bm("Diameter");e.value=1,e.output.connectTo(this.diameter)}}_buildBlock(e){const t={},i=e=>(t.segments=this.segments.getConnectedValue(e),t.diameter=this.diameter.getConnectedValue(e),t.diameterX=this.diameterX.getConnectedValue(e),t.diameterY=this.diameterY.getConnectedValue(e),t.diameterZ=this.diameterZ.getConnectedValue(e),t.arc=this.arc.getConnectedValue(e),t.slice=this.slice.getConnectedValue(e),Ml(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Mm.prototype,"evaluateContext",void 0),m("BABYLON.SphereBlock",Mm);class Om extends Tm{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("width",Qf.Float,!0,1),this.registerInput("height",Qf.Float,!0,1),this.registerInput("subdivisions",Qf.Int,!0,1),this.registerInput("subdivisionsX",Qf.Int,!0,0),this.registerInput("subdivisionsY",Qf.Int,!0,0),this.registerOutput("geometry",Qf.Geometry)}getClassName(){return"GridBlock"}get width(){return this._inputs[0]}get height(){return this._inputs[1]}get subdivisions(){return this._inputs[2]}get subdivisionsX(){return this._inputs[3]}get subdivisionsY(){return this._inputs[4]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.width.isConnected){const e=new bm("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){const e=new bm("Height");e.value=1,e.output.connectTo(this.height)}}_buildBlock(e){const t={},i=e=>(t.width=this.width.getConnectedValue(e),t.height=this.height.getConnectedValue(e),t.subdivisions=this.subdivisions.getConnectedValue(e),t.subdivisionsX=this.subdivisionsX.getConnectedValue(e),t.subdivisionsY=this.subdivisionsY.getConnectedValue(e),el(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Om.prototype,"evaluateContext",void 0),m("BABYLON.GridBlock",Om);class Dm extends Tm{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("diameter",Qf.Float,!0,1),this.registerInput("thickness",Qf.Float,!0,.5),this.registerInput("tessellation",Qf.Int,!0,16),this.registerOutput("geometry",Qf.Geometry)}getClassName(){return"TorusBlock"}get diameter(){return this._inputs[0]}get thickness(){return this._inputs[1]}get tessellation(){return this._inputs[2]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){const e=new bm("Diameter");e.value=1,e.output.connectTo(this.diameter)}}_buildBlock(e){const t={},i=e=>(t.thickness=this.thickness.getConnectedValue(e),t.diameter=this.diameter.getConnectedValue(e),t.tessellation=this.tessellation.getConnectedValue(e),rl(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Dm.prototype,"evaluateContext",void 0),m("BABYLON.TorusBlock",Dm);class Nm extends Tm{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("height",Qf.Float,!0,25),this.registerInput("diameter",Qf.Float,!0,1),this.registerInput("diameterTop",Qf.Float,!0,-1),this.registerInput("diameterBottom",Qf.Float,!0,-1),this.registerInput("subdivisions",Qf.Int,!0,1),this.registerInput("tessellation",Qf.Int,!0,24),this.registerInput("arc",Qf.Float,!0,1),this.registerOutput("geometry",Qf.Geometry)}getClassName(){return"CylinderBlock"}get height(){return this._inputs[0]}get diameter(){return this._inputs[1]}get diameterTop(){return this._inputs[2]}get diameterBottom(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get tessellation(){return this._inputs[5]}get arc(){return this._inputs[6]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){const e=new bm("Diameter");e.value=1,e.output.connectTo(this.diameter)}if(!this.height.isConnected){const e=new bm("Height");e.value=1,e.output.connectTo(this.height)}}_buildBlock(e){const t={},i=e=>(t.height=this.height.getConnectedValue(e),t.diameter=this.diameter.getConnectedValue(e),t.diameterTop=this.diameterTop.getConnectedValue(e),t.diameterBottom=this.diameterBottom.getConnectedValue(e),-1===t.diameterTop&&(t.diameterTop=t.diameter),-1===t.diameterBottom&&(t.diameterBottom=t.diameter),t.tessellation=this.tessellation.getConnectedValue(e),t.subdivisions=this.subdivisions.getConnectedValue(e),t.arc=this.arc.getConnectedValue(e),Sl(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Nm.prototype,"evaluateContext",void 0),m("BABYLON.CylinderBlock",Nm);class Fm extends Tm{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("height",Qf.Float,!0,1),this.registerInput("radius",Qf.Float,!0,.25),this.registerInput("tessellation",Qf.Int,!0,16),this.registerInput("subdivisions",Qf.Int,!0,2),this.registerOutput("geometry",Qf.Geometry)}getClassName(){return"CapsuleBlock"}get height(){return this._inputs[0]}get radius(){return this._inputs[1]}get tessellation(){return this._inputs[2]}get subdivisions(){return this._inputs[3]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.height.isConnected){const e=new bm("Height");e.value=1,e.output.connectTo(this.height)}if(!this.radius.isConnected){const e=new bm("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){const t={},i=e=>(t.height=this.height.getConnectedValue(e),t.radius=this.radius.getConnectedValue(e),t.tessellation=this.tessellation.getConnectedValue(e),t.subdivisions=this.subdivisions.getConnectedValue(e),Dl(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Fm.prototype,"evaluateContext",void 0),m("BABYLON.CapsuleBlock",Fm);class wm extends Tm{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("radius",Qf.Float,!0,.5),this.registerInput("tessellation",Qf.Int,!0,64),this.registerInput("arc",Qf.Float,!0,1),this.registerOutput("geometry",Qf.Geometry)}getClassName(){return"DiscBlock"}get radius(){return this._inputs[0]}get tessellation(){return this._inputs[1]}get arc(){return this._inputs[2]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.radius.isConnected){const e=new bm("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){const t={},i=e=>(t.radius=this.radius.getConnectedValue(e),t.tessellation=this.tessellation.getConnectedValue(e),t.arc=this.arc.getConnectedValue(e),wl(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],wm.prototype,"evaluateContext",void 0),m("BABYLON.DiscBlock",wm),m("BABYLON.NullBlock",class extends Tm{constructor(e){super(e),this.registerOutput("geometry",Qf.Geometry)}getClassName(){return"NullBlock"}get geometry(){return this._outputs[0]}_buildBlock(){this.geometry._storedValue=null}});class Lm extends Tm{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",Qf.Geometry),this.registerInput("positions",Qf.Vector3),this.registerOutput("output",Qf.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetPositionsBlock"}get geometry(){return this._inputs[0]}get positions(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),this._vertexData&&(this._vertexData=this._vertexData.clone()),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this.positions.isConnected)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=null);const t=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.positions.getConnectedValue(e);t&&t.toArray(this._vertexData.positions,3*this._currentIndex)}return e.restoreGeometryContext(),e.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Lm.prototype,"evaluateContext",void 0),m("BABYLON.SetPositionsBlock",Lm);class Bm extends Tm{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",Qf.Geometry),this.registerInput("normals",Qf.Vector3),this.registerOutput("output",Qf.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetNormalsBlock"}get geometry(){return this._inputs[0]}get normals(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),this._vertexData&&(this._vertexData=this._vertexData.clone()),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=null);if(!this.normals.isConnected)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=this._vertexData);this._vertexData.normals||(this._vertexData.normals=[]);const t=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.normals.getConnectedValue(e);t&&t.toArray(this._vertexData.normals,3*this._currentIndex)}return e.restoreGeometryContext(),e.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Bm.prototype,"evaluateContext",void 0),m("BABYLON.SetNormalsBlock",Bm);class Um extends Tm{constructor(e){super(e),this.evaluateContext=!0,this.textureCoordinateIndex=0,this.registerInput("geometry",Qf.Geometry),this.registerInput("uvs",Qf.Vector2),this.registerOutput("output",Qf.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetUVsBlock"}get geometry(){return this._inputs[0]}get uvs(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),this._vertexData&&(this._vertexData=this._vertexData.clone()),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=null);if(!this.uvs.isConnected)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=this._vertexData);const t=[],i=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<i;this._currentIndex++){const i=this.uvs.getConnectedValue(e);i&&i.toArray(t,2*this._currentIndex)}switch(this.textureCoordinateIndex){case 0:this._vertexData.uvs=t;break;case 1:this._vertexData.uvs2=t;break;case 2:this._vertexData.uvs3=t;break;case 3:this._vertexData.uvs4=t;break;case 4:this._vertexData.uvs5=t;break;case 5:this._vertexData.uvs6=t}return e.restoreGeometryContext(),e.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.textureCoordinateIndex};\n`;return e+=`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.textureCoordinateIndex=this.textureCoordinateIndex,e}_deserialize(e){super._deserialize(e),this.textureCoordinateIndex=e.textureCoordinateIndex,void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Um.prototype,"evaluateContext",void 0),me([Zr("Texture coordinates index",Js.List,"ADVANCED",{notifiers:{update:!0},options:[{label:"UV1",value:0},{label:"UV2",value:1},{label:"UV3",value:2},{label:"UV4",value:3},{label:"UV5",value:4},{label:"UV6",value:5}]})],Um.prototype,"textureCoordinateIndex",void 0),m("BABYLON.SetUVsBlock",Um);class Vm extends Tm{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",Qf.Geometry),this.registerInput("colors",Qf.Vector4),this.registerOutput("output",Qf.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetColorsBlock"}get geometry(){return this._inputs[0]}get colors(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),this._vertexData&&(this._vertexData=this._vertexData.clone()),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=null);if(!this.colors.isConnected)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=this._vertexData);this._vertexData.colors||(this._vertexData.colors=[]);const t=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.colors.getConnectedValue(e);t&&t.toArray(this._vertexData.colors,4*this._currentIndex)}return e.restoreGeometryContext(),e.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Vm.prototype,"evaluateContext",void 0),m("BABYLON.SetColorsBlock",Vm);class km extends Tm{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",Qf.Geometry),this.registerInput("tangents",Qf.Vector4),this.registerOutput("output",Qf.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetTangentsBlock"}get geometry(){return this._inputs[0]}get tangents(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),this._vertexData&&(this._vertexData=this._vertexData.clone()),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=null);if(!this.tangents.isConnected)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=this._vertexData);this._vertexData.tangents||(this._vertexData.tangents=[]);const t=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.tangents.getConnectedValue(e);t&&t.toArray(this._vertexData.tangents,4*this._currentIndex)}return e.restoreGeometryContext(),e.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],km.prototype,"evaluateContext",void 0),m("BABYLON.SetTangentsBlock",km),function(e){e[e.Add=0]="Add",e[e.Subtract=1]="Subtract",e[e.Multiply=2]="Multiply",e[e.Divide=3]="Divide",e[e.Max=4]="Max",e[e.Min=5]="Min"}(tm||(tm={}));class Gm extends Tm{constructor(e){super(e),this.operation=tm.Add,this.registerInput("left",Qf.AutoDetect),this.registerInput("right",Qf.AutoDetect),this.registerOutput("output",Qf.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(Qf.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Qf.Geometry),this._inputs[0].excludedConnectionPointTypes.push(Qf.Texture),this._inputs[1].excludedConnectionPointTypes.push(Qf.Matrix),this._inputs[1].excludedConnectionPointTypes.push(Qf.Geometry),this._inputs[1].excludedConnectionPointTypes.push(Qf.Texture),this._inputs[1].acceptedConnectionPointTypes.push(Qf.Float),this._linkConnectionTypes(0,1)}getClassName(){return"MathBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){let e;const t=this.left,i=this.right;if(!t.isConnected||!i.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const s=t.type===Qf.Float||t.type===Qf.Int;switch(this.operation){case tm.Add:e=s?e=>t.getConnectedValue(e)+i.getConnectedValue(e):e=>t.getConnectedValue(e).add(e.adapt(i,t.type));break;case tm.Subtract:e=s?e=>t.getConnectedValue(e)-i.getConnectedValue(e):e=>t.getConnectedValue(e).subtract(e.adapt(i,t.type));break;case tm.Multiply:e=s?e=>t.getConnectedValue(e)*i.getConnectedValue(e):e=>t.getConnectedValue(e).multiply(e.adapt(i,t.type));break;case tm.Divide:e=s?e=>t.getConnectedValue(e)/i.getConnectedValue(e):e=>t.getConnectedValue(e).divide(e.adapt(i,t.type));break;case tm.Min:if(s)e=e=>Math.min(t.getConnectedValue(e),i.getConnectedValue(e));else switch(t.type){case Qf.Vector2:e=e=>E.Minimize(t.getConnectedValue(e),e.adapt(i,t.type));break;case Qf.Vector3:e=e=>S.Minimize(t.getConnectedValue(e),e.adapt(i,t.type));break;case Qf.Vector4:e=e=>b.Minimize(t.getConnectedValue(e),e.adapt(i,t.type))}break;case tm.Max:if(!s){switch(t.type){case Qf.Vector2:e=e=>E.Maximize(t.getConnectedValue(e),e.adapt(i,t.type));break;case Qf.Vector3:e=e=>S.Maximize(t.getConnectedValue(e),e.adapt(i,t.type));break;case Qf.Vector4:e=e=>b.Maximize(t.getConnectedValue(e),e.adapt(i,t.type))}break}e=e=>Math.max(t.getConnectedValue(e),i.getConnectedValue(e))}this.output._storedFunction=i=>t.type===Qf.Int?0|e(i):e(i)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.MathBlockOperations.${tm[this.operation]};\n`}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e){super._deserialize(e),this.operation=e.operation}}me([Zr("Operation",Js.List,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"Add",value:tm.Add},{label:"Subtract",value:tm.Subtract},{label:"Multiply",value:tm.Multiply},{label:"Divide",value:tm.Divide},{label:"Max",value:tm.Max},{label:"Min",value:tm.Min}]})],Gm.prototype,"operation",void 0),m("BABYLON.MathBlock",Gm),m("BABYLON.MapRangeBlock",class extends Tm{constructor(e){super(e),this.registerInput("value",Qf.AutoDetect),this.registerInput("fromMin",Qf.Float,!0,0),this.registerInput("fromMax",Qf.Float,!0,1),this.registerInput("toMin",Qf.Float,!0,0),this.registerInput("toMax",Qf.Float,!0,1),this.registerOutput("output",Qf.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(Qf.Vector2),this._inputs[0].excludedConnectionPointTypes.push(Qf.Vector3),this._inputs[0].excludedConnectionPointTypes.push(Qf.Vector4),this._inputs[0].excludedConnectionPointTypes.push(Qf.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Qf.Geometry),this._inputs[0].excludedConnectionPointTypes.push(Qf.Texture),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"MapRangeBlock"}get value(){return this._inputs[0]}get fromMin(){return this._inputs[1]}get fromMax(){return this._inputs[2]}get toMin(){return this._inputs[3]}get toMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);this.output._storedFunction=e=>{const t=this.value.getConnectedValue(e),i=this.fromMin.getConnectedValue(e),s=this.fromMax.getConnectedValue(e),r=this.toMin.getConnectedValue(e),n=(t-i)/(s-i)*(this.toMax.getConnectedValue(e)-r)+r;return this.output.type===Qf.Int?Math.floor(n):n}}}),function(e){e[e.Equal=0]="Equal",e[e.NotEqual=1]="NotEqual",e[e.LessThan=2]="LessThan",e[e.GreaterThan=3]="GreaterThan",e[e.LessOrEqual=4]="LessOrEqual",e[e.GreaterOrEqual=5]="GreaterOrEqual",e[e.Xor=6]="Xor",e[e.Or=7]="Or",e[e.And=8]="And"}(im||(im={}));class zm extends Tm{constructor(e){super(e),this.test=im.Equal,this.registerInput("left",Qf.Float),this.registerInput("right",Qf.Float,!0,0),this.registerInput("ifTrue",Qf.AutoDetect,!0,1),this.registerInput("ifFalse",Qf.AutoDetect,!0,0),this.registerOutput("output",Qf.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[2],this._outputs[0]._defaultConnectionPointType=Qf.Float,this._inputs[0].acceptedConnectionPointTypes.push(Qf.Int),this._inputs[1].acceptedConnectionPointTypes.push(Qf.Int),this._linkConnectionTypes(2,3)}getClassName(){return"ConditionBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get ifTrue(){return this._inputs[2]}get ifFalse(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const e=e=>{const t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e);let s=!1;switch(this.test){case im.Equal:s=l.WithinEpsilon(t,i,u);break;case im.NotEqual:s=t!==i;break;case im.LessThan:s=t<i;break;case im.GreaterThan:s=t>i;break;case im.LessOrEqual:s=t<=i;break;case im.GreaterOrEqual:s=t>=i;break;case im.Xor:s=!!t&&!i||!t&&!!i;break;case im.Or:s=!!t||!!i;break;case im.And:s=!!t&&!!i}return s};this.output._storedFunction=t=>e(t)?this.ifTrue.getConnectedValue(t):this.ifFalse.getConnectedValue(t)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.test = BABYLON.ConditionBlockTests.${im[this.test]};\n`}serialize(){const e=super.serialize();return e.test=this.test,e}_deserialize(e){super._deserialize(e),this.test=e.test}}me([Zr("Test",Js.List,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"Equal",value:im.Equal},{label:"NotEqual",value:im.NotEqual},{label:"LessThan",value:im.LessThan},{label:"GreaterThan",value:im.GreaterThan},{label:"LessOrEqual",value:im.LessOrEqual},{label:"GreaterOrEqual",value:im.GreaterOrEqual},{label:"Xor",value:im.Xor},{label:"Or",value:im.Or},{label:"And",value:im.And}]})],zm.prototype,"test",void 0),m("BABYLON.ConditionBlock",zm),function(e){e[e.None=0]="None",e[e.LoopID=1]="LoopID",e[e.InstanceID=2]="InstanceID"}(sm||(sm={}));class Wm extends Tm{constructor(e){super(e),this._currentLockId=-1,this.lockMode=sm.None,this.registerInput("min",Qf.AutoDetect),this.registerInput("max",Qf.AutoDetect),this.registerOutput("output",Qf.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(Qf.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Qf.Geometry),this._inputs[0].excludedConnectionPointTypes.push(Qf.Texture),this._inputs[1].excludedConnectionPointTypes.push(Qf.Matrix),this._inputs[1].excludedConnectionPointTypes.push(Qf.Geometry),this._inputs[1].excludedConnectionPointTypes.push(Qf.Texture),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"RandomBlock"}get min(){return this._inputs[0]}get max(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(){if(!this.min.isConnected){const e=new bm("Min");e.value=0,e.output.connectTo(this.min)}if(!this.max.isConnected){const e=new bm("Max");e.value=1,e.output.connectTo(this.max)}}_buildBlock(){let e=null;switch(this._currentLockId=-1,this.min.type){case Qf.Int:case Qf.Float:e=e=>{const t=this.min.getConnectedValue(e)||0,i=this.max.getConnectedValue(e)||0;return t+Math.random()*(i-t)};break;case Qf.Vector2:e=e=>{const t=this.min.getConnectedValue(e)||E.Zero(),i=this.max.getConnectedValue(e)||E.Zero();return new E(t.x+Math.random()*(i.x-t.x),t.y+Math.random()*(i.y-t.y))};break;case Qf.Vector3:e=e=>{const t=this.min.getConnectedValue(e)||S.Zero(),i=this.max.getConnectedValue(e)||S.Zero();return new S(t.x+Math.random()*(i.x-t.x),t.y+Math.random()*(i.y-t.y),t.z+Math.random()*(i.z-t.z))};break;case Qf.Vector4:e=e=>{const t=this.min.getConnectedValue(e)||b.Zero(),i=this.max.getConnectedValue(e)||b.Zero();return new b(t.x+Math.random()*(i.x-t.x),t.y+Math.random()*(i.y-t.y),t.z+Math.random()*(i.z-t.z),t.w+Math.random()*(i.w-t.w))}}this.lockMode!==sm.None&&e?this.output._storedFunction=t=>{let i=0;switch(this.lockMode){case sm.InstanceID:i=t.getContextualValue(em.InstanceID,!0)||0;break;case sm.LoopID:i=t.getContextualValue(em.LoopID,!0)||0}return this._currentLockId===i&&this.lockMode!==sm.None||(this._currentLockId=i,this.output._storedValue=e(t)),this.output._storedValue}:this.output._storedFunction=e}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.lockMode = BABYLON.RandomBlockLocks.${sm[this.lockMode]};\n`}serialize(){const e=super.serialize();return e.lockMode=this.lockMode,e}_deserialize(e){super._deserialize(e),this.lockMode=e.lockMode}}me([Zr("LockMode",Js.List,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"None",value:sm.None},{label:"LoopID",value:sm.LoopID},{label:"InstanceID",value:sm.InstanceID}]})],Wm.prototype,"lockMode",void 0),m("BABYLON.RandomBlock",Wm),m("BABYLON.NoiseBlock",class extends Tm{constructor(e){super(e),this.registerInput("offset",Qf.Vector3,!0,S.Zero()),this.registerInput("scale",Qf.Float,!0,1),this.registerInput("octaves",Qf.Float,!0,2,0,16),this.registerInput("roughness",Qf.Float,!0,.5,0,1),this.registerOutput("output",Qf.Float)}getClassName(){return"NoiseBlock"}get offset(){return this._inputs[0]}get scale(){return this._inputs[1]}get octaves(){return this._inputs[2]}get roughness(){return this._inputs[3]}get output(){return this._outputs[0]}_negateIf(e,t){return 0!==t?-e:e}_noiseGrad(e,t,i,s){const r=15&e,n=r<8?t:i,o=r<4?i:12===r||14==r?t:s;return this._negateIf(n,r&n)+this._negateIf(o,2&r)}_fade(e){return e*e*e*(e*(6*e-15)+10)}_hashBitRotate(e,t){return e<<t|e>>32-t}_hash(e,t,i){let s,r,n;return s=r=n=3735928584,n+=i,r+=t,s+=e,n^=r,n-=this._hashBitRotate(r,14),s^=n,s-=this._hashBitRotate(n,11),r^=s,r-=this._hashBitRotate(s,25),n^=r,n-=this._hashBitRotate(r,16),s^=n,s-=this._hashBitRotate(n,4),r^=s,r-=this._hashBitRotate(s,14),n^=r,n-=this._hashBitRotate(r,24),n}_mix(e,t,i,s,r,n,o,a,l,h,c){const u=1-l,d=1-h;return(1-c)*(d*(e*u+t*l)+h*(i*u+s*l))+c*(d*(r*u+n*l)+h*(o*u+a*l))}_perlinNoise(e){const t=(0|e.x)-(e.x<0?1:0),i=(0|e.y)-(e.y<0?1:0),s=(0|e.z)-(e.z<0?1:0),r=e.x-t,n=e.y-i,o=e.z-s,a=this._fade(r),l=this._fade(n),h=this._fade(o);return this._mix(this._noiseGrad(this._hash(t,i,s),r,n,o),this._noiseGrad(this._hash(t+1,i,s),r-1,n,o),this._noiseGrad(this._hash(t,i+1,s),r,n-1,o),this._noiseGrad(this._hash(t+1,i+1,s),r-1,n-1,o),this._noiseGrad(this._hash(t,i,s+1),r,n,o-1),this._noiseGrad(this._hash(t+1,i,s+1),r-1,n,o-1),this._noiseGrad(this._hash(t,i+1,s+1),r,n-1,o-1),this._noiseGrad(this._hash(t+1,i+1,s+1),r-1,n-1,o-1),a,l,h)}_perlinSigned(e){return.982*this._perlinNoise(e)}_perlin(e){return this._perlinSigned(e)/2+.5}noise(e,t,i,s,r){const n=new S(i.x*r+s.x,i.y*r+s.y,i.z*r+s.z);let o=1,a=1,h=0,c=0;const u=0|(e=l.Clamp(e,0,15));for(let e=0;e<=u;e++)c+=this._perlin(n.scale(o))*a,h+=a,a*=l.Clamp(t,0,1),o*=2;const d=e-Math.floor(e);if(0==d)return c/h;let p=c+this._perlin(n.scale(o))*a;return c/=h,p/=h+a,(1-d)*c+d*p}_buildBlock(){this.output._storedFunction=e=>{const t=e.getContextualValue(em.Positions),i=this.octaves.getConnectedValue(e),s=this.roughness.getConnectedValue(e),r=this.offset.getConnectedValue(e),n=this.scale.getConnectedValue(e);return this.noise(i,s,t,r,n)}}});class Hm extends Tm{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("geometry0",Qf.Geometry),this.registerInput("geometry1",Qf.Geometry,!0),this.registerInput("geometry2",Qf.Geometry,!0),this.registerInput("geometry3",Qf.Geometry,!0),this.registerInput("geometry4",Qf.Geometry,!0),this.registerOutput("output",Qf.Geometry)}getClassName(){return"MergeGeometryBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get geometry2(){return this._inputs[2]}get geometry3(){return this._inputs[3]}get geometry4(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{let t=this.geometry0.getConnectedValue(e);const i=[];if(!t)return null;if(t=t.clone(),this.geometry1.isConnected){const t=this.geometry1.getConnectedValue(e);t&&i.push(t)}if(this.geometry2.isConnected){const t=this.geometry2.getConnectedValue(e);t&&i.push(t)}if(this.geometry3.isConnected){const t=this.geometry3.getConnectedValue(e);t&&i.push(t)}if(this.geometry4.isConnected){const t=this.geometry4.getConnectedValue(e);t&&i.push(t)}return i.length&&t&&(t=t.merge(i,!0,!1,!0,!0)),t};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Hm.prototype,"evaluateContext",void 0),m("BABYLON.MergeGeometryBlock",Hm);class Xm extends Tm{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry0",Qf.Geometry,!0),this.registerInput("geometry1",Qf.Geometry,!0),this.registerInput("geometry2",Qf.Geometry,!0),this.registerInput("geometry3",Qf.Geometry,!0),this.registerInput("geometry4",Qf.Geometry,!0),this.registerInput("geometry5",Qf.Geometry,!0),this.registerInput("geometry6",Qf.Geometry,!0),this.registerInput("geometry7",Qf.Geometry,!0),this.registerInput("geometry8",Qf.Geometry,!0),this.registerInput("geometry9",Qf.Geometry,!0),this.registerOutput("output",Qf.Geometry),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"GeometryCollectionBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get geometry2(){return this._inputs[2]}get geometry3(){return this._inputs[3]}get geometry4(){return this._inputs[4]}get geometry5(){return this._inputs[5]}get geometry6(){return this._inputs[6]}get geometry7(){return this._inputs[7]}get geometry8(){return this._inputs[8]}get geometry9(){return this._inputs[9]}get output(){return this._outputs[0]}_storeGeometry(e,t,i,s){if(e.isConnected){const r=e.getConnectedValue(t);if(!r)return;r.metadata=r.metadata||{},r.metadata.collectionId=i,s.push(r)}}_buildBlock(e){const t=e=>{const t=[];return this._storeGeometry(this.geometry0,e,0,t),this._storeGeometry(this.geometry1,e,1,t),this._storeGeometry(this.geometry2,e,2,t),this._storeGeometry(this.geometry3,e,3,t),this._storeGeometry(this.geometry4,e,4,t),this._storeGeometry(this.geometry5,e,5,t),this._storeGeometry(this.geometry6,e,6,t),this._storeGeometry(this.geometry7,e,7,t),this._storeGeometry(this.geometry8,e,8,t),this._storeGeometry(this.geometry9,e,9,t),t.length?t[Math.round(Math.random()*(t.length-1))]:null};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Xm.prototype,"evaluateContext",void 0),m("BABYLON.GeometryCollectionBlock",Xm),m("BABYLON.GeometryElbowBlock",class extends Tm{constructor(e){super(e),this.registerInput("input",Qf.AutoDetect),this.registerOutput("output",Qf.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}get buildExecutionTime(){return 0}getClassName(){return"GeometryElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];t._storedFunction=e=>i.getConnectedValue(e)}}),m("BABYLON.ComputeNormalsBlock",class extends Tm{constructor(e){super(e),this.registerInput("geometry",Qf.Geometry),this.registerOutput("output",Qf.Geometry)}getClassName(){return"ComputeNormalsBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){this.output._storedFunction=e=>{if(!this.geometry.isConnected)return null;const t=this.geometry.getConnectedValue(e);return t.normals||(t.normals=[]),As.ComputeNormals(t.positions,t.indices,t.normals),t}}}),m("BABYLON.VectorConverterBlock",class extends Tm{constructor(e){super(e),this.registerInput("xyzw ",Qf.Vector4,!0),this.registerInput("xyz ",Qf.Vector3,!0),this.registerInput("xy ",Qf.Vector2,!0),this.registerInput("zw ",Qf.Vector2,!0),this.registerInput("x ",Qf.Float,!0),this.registerInput("y ",Qf.Float,!0),this.registerInput("z ",Qf.Float,!0),this.registerInput("w ",Qf.Float,!0),this.registerOutput("xyzw",Qf.Vector4),this.registerOutput("xyz",Qf.Vector3),this.registerOutput("xy",Qf.Vector2),this.registerOutput("zw",Qf.Vector2),this.registerOutput("x",Qf.Float),this.registerOutput("y",Qf.Float),this.registerOutput("z",Qf.Float),this.registerOutput("w",Qf.Float)}getClassName(){return"VectorConverterBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get xIn(){return this._inputs[4]}get yIn(){return this._inputs[5]}get zIn(){return this._inputs[6]}get wIn(){return this._inputs[7]}get xyzwOut(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xOut(){return this._outputs[4]}get yOut(){return this._outputs[5]}get zOut(){return this._outputs[6]}get wOut(){return this._outputs[7]}_inputRename(e){return"xyzw "===e?"xyzwIn":"xyz "===e?"xyzIn":"xy "===e?"xyIn":"zw "===e?"zwIn":"x "===e?"xIn":"y "===e?"yIn":"z "===e?"zIn":"w "===e?"wIn":e}_outputRename(e){switch(e){case"x":return"xOut";case"y":return"yOut";case"z":return"zOut";case"w":return"wOut";case"xy":return"xyOut";case"zw":return"zwOut";case"xyz":return"xyzOut";case"xyzw":return"xyzwOut";default:return e}}_buildBlock(e){super._buildBlock(e);const t=this.xIn,i=this.yIn,s=this.zIn,r=this.wIn,n=this.xyIn,o=this.zwIn,a=this.xyzIn,l=this.xyzwIn,h=this.xyzwOut,c=this.xyzOut,u=this.xyOut,d=this.zwOut,p=this.xOut,_=this.yOut,f=this.zOut,m=this.wOut,g=e=>{if(l.isConnected)return l.getConnectedValue(e);let h=0,c=0,u=0,d=0;if(t.isConnected&&(h=t.getConnectedValue(e)),i.isConnected&&(c=i.getConnectedValue(e)),s.isConnected&&(u=s.getConnectedValue(e)),r.isConnected&&(d=r.getConnectedValue(e)),n.isConnected){const t=n.getConnectedValue(e);t&&(h=t.x,c=t.y)}if(o.isConnected){const t=o.getConnectedValue(e);t&&(u=t.x,d=t.y)}if(a.isConnected){const t=a.getConnectedValue(e);t&&(h=t.x,c=t.y,u=t.z)}return new b(h,c,u,d)};h._storedFunction=e=>g(e),c._storedFunction=e=>{const t=g(e);return new S(t.x,t.y,t.z)},u._storedFunction=e=>{const t=g(e);return new E(t.x,t.y)},d._storedFunction=e=>{const t=g(e);return new E(t.z,t.w)},p._storedFunction=e=>g(e).x,_._storedFunction=e=>g(e).y,f._storedFunction=e=>g(e).z,m._storedFunction=e=>g(e).w}}),m("BABYLON.NormalizeVectorBlock",class extends Tm{constructor(e){super(e),this.registerInput("input",Qf.AutoDetect),this.registerOutput("output",Qf.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(Qf.Float),this._inputs[0].excludedConnectionPointTypes.push(Qf.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Qf.Geometry),this._inputs[0].excludedConnectionPointTypes.push(Qf.Texture),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NormalizeVectorBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.output._storedFunction=null,this.input.isConnected?this.output._storedFunction=e=>this.input.getConnectedValue(e).normalize():this.output._storedValue=null}});class Ym extends Tm{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",Qf.Geometry),this.registerInput("id",Qf.Int,!0,0),this.registerOutput("output",Qf.Geometry),this.id.acceptedConnectionPointTypes.push(Qf.Float)}getClassName(){return"SetMaterialIDBlock"}get geometry(){return this._inputs[0]}get id(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.geometry.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const t=e=>{const t=this.geometry.getConnectedValue(e);if(!t||!t.indices||!t.positions)return t;const i=new ys;return i.materialIndex=0|this.id.getConnectedValue(e),i.indexStart=0,i.indexCount=t.indices.length,i.verticesStart=0,i.verticesCount=t.positions.length/3,t.materialInfos=[i],t};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Ym.prototype,"evaluateContext",void 0),m("BABYLON.SetMaterialIDBlock",Ym),function(e){e[e.Cos=0]="Cos",e[e.Sin=1]="Sin",e[e.Abs=2]="Abs",e[e.Exp=3]="Exp",e[e.Round=4]="Round",e[e.Floor=5]="Floor",e[e.Ceiling=6]="Ceiling",e[e.Sqrt=7]="Sqrt",e[e.Log=8]="Log",e[e.Tan=9]="Tan",e[e.ArcTan=10]="ArcTan",e[e.ArcCos=11]="ArcCos",e[e.ArcSin=12]="ArcSin",e[e.Sign=13]="Sign",e[e.Negate=14]="Negate",e[e.OneMinus=15]="OneMinus",e[e.Reciprocal=16]="Reciprocal",e[e.ToDegrees=17]="ToDegrees",e[e.ToRadians=18]="ToRadians"}(rm||(rm={}));class jm extends Tm{constructor(e){super(e),this.operation=rm.Cos,this.registerInput("input",Qf.AutoDetect),this.registerOutput("output",Qf.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(Qf.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Qf.Geometry),this._inputs[0].excludedConnectionPointTypes.push(Qf.Texture)}getClassName(){return"GeometryTrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=null;switch(this.operation){case rm.Cos:t=e=>Math.cos(e);break;case rm.Sin:t=e=>Math.sin(e);break;case rm.Abs:t=e=>Math.abs(e);break;case rm.Exp:t=e=>Math.exp(e);break;case rm.Round:t=e=>Math.round(e);break;case rm.Floor:t=e=>Math.floor(e);break;case rm.Ceiling:t=e=>Math.ceil(e);break;case rm.Sqrt:t=e=>Math.sqrt(e);break;case rm.Log:t=e=>Math.log(e);break;case rm.Tan:t=e=>Math.tan(e);break;case rm.ArcTan:t=e=>Math.atan(e);break;case rm.ArcCos:t=e=>Math.acos(e);break;case rm.ArcSin:t=e=>Math.asin(e);break;case rm.Sign:t=e=>Math.sign(e);break;case rm.Negate:t=e=>-e;break;case rm.OneMinus:t=e=>1-e;break;case rm.Reciprocal:t=e=>1/e;break;case rm.ToRadians:t=e=>e*Math.PI/180;break;case rm.ToDegrees:t=e=>180*e/Math.PI}if(!t)return this.input._storedFunction=null,void(this.input._storedValue=null);switch(this.input.type){case Qf.Int:case Qf.Float:this.output._storedFunction=e=>{const i=this.input.getConnectedValue(e);return t(i)};break;case Qf.Vector2:this.output._storedFunction=e=>{const i=this.input.getConnectedValue(e);return new E(t(i.x),t(i.y))};break;case Qf.Vector3:this.output._storedFunction=e=>{const i=this.input.getConnectedValue(e);return new S(t(i.x),t(i.y),t(i.z))};break;case Qf.Vector4:this.output._storedFunction=e=>{const i=this.input.getConnectedValue(e);return new b(t(i.x),t(i.y),t(i.z),t(i.w))}}return this}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e){super._deserialize(e),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.GeometryTrigonometryBlockOperations.${rm[this.operation]};\n`}}me([Zr("Operation",Js.List,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"Cos",value:rm.Cos},{label:"Sin",value:rm.Sin},{label:"Abs",value:rm.Abs},{label:"Exp",value:rm.Exp},{label:"Round",value:rm.Round},{label:"Floor",value:rm.Floor},{label:"Ceiling",value:rm.Ceiling},{label:"Sqrt",value:rm.Sqrt},{label:"Log",value:rm.Log},{label:"Tan",value:rm.Tan},{label:"ArcTan",value:rm.ArcTan},{label:"ArcCos",value:rm.ArcCos},{label:"ArcSin",value:rm.ArcSin},{label:"Sign",value:rm.Sign},{label:"Negate",value:rm.Negate},{label:"OneMinus",value:rm.OneMinus},{label:"Reciprocal",value:rm.Reciprocal},{label:"ToDegrees",value:rm.ToDegrees},{label:"ToRadians",value:rm.ToRadians}]})],jm.prototype,"operation",void 0),m("BABYLON.GeometryTrigonometryBlock",jm);class Km extends Tm{constructor(e){super(e),this._rotationMatrix=new y,this._scalingMatrix=new y,this._translationMatrix=new y,this._scalingRotationMatrix=new y,this._transformMatrix=new y,this.evaluateContext=!0,this.registerInput("value",Qf.AutoDetect),this.registerInput("matrix",Qf.Matrix,!0),this.registerInput("translation",Qf.Vector3,!0,S.Zero()),this.registerInput("rotation",Qf.Vector3,!0,S.Zero()),this.registerInput("scaling",Qf.Vector3,!0,S.One()),this.registerOutput("output",Qf.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(Qf.Float),this._inputs[0].excludedConnectionPointTypes.push(Qf.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Qf.Texture)}getClassName(){return"GeometryTransformBlock"}get value(){return this._inputs[0]}get matrix(){return this._inputs[1]}get translation(){return this._inputs[2]}get rotation(){return this._inputs[3]}get scaling(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.value.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const t=e=>{const t=this.value.getConnectedValue(e);if(!t)return null;let i;if(this.matrix.isConnected)i=this.matrix.getConnectedValue(e);else{const t=this.scaling.getConnectedValue(e),s=this.rotation.getConnectedValue(e),r=this.translation.getConnectedValue(e);y.ScalingToRef(t.x,t.y,t.z,this._scalingMatrix),y.RotationYawPitchRollToRef(s.y,s.x,s.z,this._rotationMatrix),y.TranslationToRef(r.x,r.y,r.z,this._translationMatrix),this._scalingMatrix.multiplyToRef(this._rotationMatrix,this._scalingRotationMatrix),this._scalingRotationMatrix.multiplyToRef(this._translationMatrix,this._transformMatrix),i=this._transformMatrix}switch(this.value.type){case Qf.Geometry:{const e=t.clone();return e.transform(i),e}case Qf.Vector2:return E.Transform(t,i);case Qf.Vector3:return S.TransformCoordinates(t,i);case Qf.Vector4:return b.TransformCoordinates(t,i)}return null};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Km.prototype,"evaluateContext",void 0),m("BABYLON.GeometryTransformBlock",Km),m("BABYLON.RotationXBlock",class extends Tm{constructor(e){super(e),this.registerInput("angle",Qf.Float,!1,0),this.registerOutput("matrix",Qf.Matrix)}getClassName(){return"RotationXBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){const e=new bm("Angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>y.RotationX(this.angle.getConnectedValue(e))}}),m("BABYLON.RotationYBlock",class extends Tm{constructor(e){super(e),this.registerInput("angle",Qf.Float,!1,0),this.registerOutput("matrix",Qf.Matrix)}getClassName(){return"RotationYBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){const e=new bm("Angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>y.RotationY(this.angle.getConnectedValue(e))}}),m("BABYLON.RotationZBlock",class extends Tm{constructor(e){super(e),this.registerInput("angle",Qf.Float,!1,0),this.registerOutput("matrix",Qf.Matrix)}getClassName(){return"RotationZBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){const e=new bm("Angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>y.RotationZ(this.angle.getConnectedValue(e))}}),m("BABYLON.ScalingBlock",class extends Tm{constructor(e){super(e),this.registerInput("scale",Qf.Vector3,!1,S.One()),this.registerOutput("matrix",Qf.Matrix)}getClassName(){return"ScalingBlock"}get scale(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.scale.isConnected){const e=new bm("Scale");e.value=new S(1,1,1),e.output.connectTo(this.scale)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>{const t=this.scale.getConnectedValue(e);return y.Scaling(t.x,t.y,t.z)}}}),m("BABYLON.AlignBlock",class extends Tm{constructor(e){super(e),this.registerInput("source",Qf.Vector3,!0,S.Up()),this.registerInput("target",Qf.Vector3,!0,S.Left()),this.registerOutput("matrix",Qf.Matrix)}getClassName(){return"AlignBlock"}get source(){return this._inputs[0]}get target(){return this._inputs[1]}get matrix(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>{const t=this.source.getConnectedValue(e).clone(),i=this.target.getConnectedValue(e).clone(),s=new y;return t.normalize(),i.normalize(),y.RotationAlignToRef(t,i,s,!0),s}}}),m("BABYLON.TranslationBlock",class extends Tm{constructor(e){super(e),this.registerInput("translation",Qf.Vector3,!1,S.Zero()),this.registerOutput("matrix",Qf.Matrix)}getClassName(){return"TranslationBlock"}get translation(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.translation.isConnected){const e=new bm("Translation");e.value=new S(0,0,0),e.output.connectTo(this.translation)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>{const t=this.translation.getConnectedValue(e);return y.Translation(t.x,t.y,t.z)}}});class $m extends Tm{constructor(e){super(e),this._indexTranslation=null,this.evaluateContext=!0,this.removeDuplicatedPositions=!0,this.registerInput("geometry",Qf.Geometry),this.registerInput("instance",Qf.Geometry,!0),this.registerInput("density",Qf.Float,!0,1,0,1),this.registerInput("matrix",Qf.Matrix,!0),this.registerInput("rotation",Qf.Vector3,!0,S.Zero()),this.registerInput("scaling",Qf.Vector3,!0,S.One()),this.scaling.acceptedConnectionPointTypes.push(Qf.Float),this.registerOutput("output",Qf.Geometry)}getInstanceIndex(){return this._currentLoopIndex}getExecutionIndex(){return this._indexTranslation?this._indexTranslation[this._currentIndex]:this._currentIndex}getExecutionLoopIndex(){return this._currentLoopIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateOnVerticesBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get density(){return this._inputs[2]}get matrix(){return this._inputs[3]}get rotation(){return this._inputs[4]}get scaling(){return this._inputs[5]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),e.pushInstancingContext(this),this._vertexData=this.geometry.getConnectedValue(e),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this.instance.isConnected)return e.restoreExecutionContext(),e.restoreInstancingContext(),e.restoreGeometryContext(),void(this.output._storedValue=null);let t=this._vertexData.positions.length/3;const i=[],s=new S,r=[];let n=this._vertexData.positions;if(this._currentLoopIndex=0,this.removeDuplicatedPositions){for(this._indexTranslation={},this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const e=n[3*this._currentIndex],t=n[3*this._currentIndex+1],i=n[3*this._currentIndex+2];let s=!1;for(let n=0;n<r.length;n+=3)if(Math.abs(r[n]-e)<u&&Math.abs(r[n+1]-t)<u&&Math.abs(r[n+2]-i)<u){s=!0;break}s||(this._indexTranslation[r.length/3]=this._currentIndex,r.push(e,t,i))}n=r,t=n.length/3}else this._indexTranslation=null;for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.instance.getConnectedValue(e);if(!t||!t.positions||0===t.positions.length)continue;const r=this.density.getConnectedValue(e);if(r<1&&Math.random()>r)continue;s.fromArray(n,3*this._currentIndex);const o=t.clone();if(this.matrix.isConnected){const t=this.matrix.getConnectedValue(e);e._instantiateWithPositionAndMatrix(o,s,t,i)}else{const t=e.adaptInput(this.scaling,Qf.Vector3,S.OneReadOnly),r=this.rotation.getConnectedValue(e)||S.ZeroReadOnly;e._instantiate(o,s,r,t,i)}this._currentLoopIndex++}if(e.restoreGeometryContext(),e.restoreExecutionContext(),e.restoreInstancingContext(),!i.length)return null;if(1===i.length)this._vertexData=i[0];else{const e=i.splice(0,1)[0];this._vertexData=e.merge(i,!0,!1,!0,!0)}return this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.removeDuplicatedPositions = ${this.removeDuplicatedPositions?"true":"false"};\n`;return e+=`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`,e}serialize(){const e=super.serialize();return e.removeDuplicatedPositions=this.removeDuplicatedPositions,e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.removeDuplicatedPositions=e.removeDuplicatedPositions,void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],$m.prototype,"evaluateContext",void 0),me([Zr("Remove duplicated positions",Js.Boolean,"ADVANCED",{notifiers:{update:!0}})],$m.prototype,"removeDuplicatedPositions",void 0),m("BABYLON.InstantiateOnVerticesBlock",$m);class qm extends Tm{constructor(e){super(e),this._currentPosition=new S,this._currentUV=new E,this._vertex0=new S,this._vertex1=new S,this._vertex2=new S,this._tempVector0=new S,this._tempVector1=new S,this._uv0=new E,this._uv1=new E,this._uv2=new E,this.evaluateContext=!0,this.registerInput("geometry",Qf.Geometry),this.registerInput("instance",Qf.Geometry,!0),this.registerInput("count",Qf.Int,!0,256),this.registerInput("matrix",Qf.Matrix,!0),this.registerInput("rotation",Qf.Vector3,!0,S.Zero()),this.registerInput("scaling",Qf.Vector3,!0,S.One()),this.scaling.acceptedConnectionPointTypes.push(Qf.Float),this.registerOutput("output",Qf.Geometry)}getInstanceIndex(){return this._currentLoopIndex}getExecutionIndex(){return 0}getExecutionFaceIndex(){return this._currentFaceIndex}getExecutionLoopIndex(){return this._currentLoopIndex}getOverridePositionsContextualValue(){return this._currentPosition}getOverrideNormalsContextualValue(){return this._vertex1.subtractToRef(this._vertex0,this._tempVector0),this._vertex2.subtractToRef(this._vertex1,this._tempVector1),this._tempVector0.normalize(),this._tempVector1.normalize(),S.Cross(this._tempVector1,this._tempVector0)}getOverrideUVs1ContextualValue(){return this._currentUV}getClassName(){return"InstantiateOnFacesBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get count(){return this._inputs[2]}get matrix(){return this._inputs[3]}get rotation(){return this._inputs[4]}get scaling(){return this._inputs[5]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),e.pushInstancingContext(this),this._vertexData=this.geometry.getConnectedValue(e),e.pushGeometryContext(this._vertexData),!(this._vertexData&&this._vertexData.positions&&this._vertexData.indices&&this.instance.isConnected))return e.restoreExecutionContext(),e.restoreInstancingContext(),e.restoreGeometryContext(),void(this.output._storedValue=null);let t=null;const i=this.count.getConnectedValue(e),s=this._vertexData.indices.length/3,r=i/s;let n=0;const o=[];let a=0;for(this._currentLoopIndex=0,this._currentFaceIndex=0;this._currentFaceIndex<s;this._currentFaceIndex++){n+=r;const s=(0|n)-a;if(s<1)continue;const l=this._vertexData.indices[3*this._currentFaceIndex],h=this._vertexData.indices[3*this._currentFaceIndex+1],c=this._vertexData.indices[3*this._currentFaceIndex+2];this._vertex0.fromArray(this._vertexData.positions,3*l),this._vertex1.fromArray(this._vertexData.positions,3*h),this._vertex2.fromArray(this._vertexData.positions,3*c),this._vertexData.uvs&&(this._uv0.fromArray(this._vertexData.uvs,2*l),this._uv1.fromArray(this._vertexData.uvs,2*h),this._uv2.fromArray(this._vertexData.uvs,2*c));for(let l=0;l<s&&!(a>=i);l++){let i=Math.random(),s=Math.random();if(i>s){const e=i;i=s,s=e}const l=i,h=s-i,c=1-l-h;if(this._currentPosition.set(l*this._vertex0.x+h*this._vertex1.x+c*this._vertex2.x,l*this._vertex0.y+h*this._vertex1.y+c*this._vertex2.y,l*this._vertex0.z+h*this._vertex1.z+c*this._vertex2.z),this._vertexData.uvs&&this._currentUV.set(l*this._uv0.x+h*this._uv1.x+c*this._uv2.x,l*this._uv0.y+h*this._uv1.y+c*this._uv2.y),t=this.instance.getConnectedValue(e),!t||!t.positions||0===t.positions.length){n-=r;continue}const u=t.clone();if(this.matrix.isConnected){const t=this.matrix.getConnectedValue(e);e._instantiateWithPositionAndMatrix(u,this._currentPosition,t,o)}else{const t=e.adaptInput(this.scaling,Qf.Vector3,S.OneReadOnly),i=this.rotation.getConnectedValue(e)||S.ZeroReadOnly;e._instantiate(u,this._currentPosition,i,t,o)}a++,this._currentLoopIndex++}}if(o.length)if(1===o.length)this._vertexData=o[0];else{const e=o.splice(0,1)[0];this._vertexData=e.merge(o,!0,!1,!0,!0)}return e.restoreExecutionContext(),e.restoreInstancingContext(),e.restoreGeometryContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],qm.prototype,"evaluateContext",void 0),m("BABYLON.InstantiateOnFacesBlock",qm);class Qm extends Tm{constructor(e){super(e),this._currentPosition=new S,this._vertex0=new S,this._vertex1=new S,this._vertex2=new S,this.evaluateContext=!0,this.registerInput("geometry",Qf.Geometry),this.registerInput("instance",Qf.Geometry,!0),this.registerInput("count",Qf.Int,!0,256),this.registerInput("matrix",Qf.Matrix,!0),this.registerInput("rotation",Qf.Vector3,!0,S.Zero()),this.registerInput("scaling",Qf.Vector3,!0,S.One()),this.scaling.acceptedConnectionPointTypes.push(Qf.Float),this.registerOutput("output",Qf.Geometry)}getInstanceIndex(){return this._currentLoopIndex}getExecutionIndex(){return 0}getExecutionFaceIndex(){return 0}getExecutionLoopIndex(){return this._currentLoopIndex}getOverridePositionsContextualValue(){return this._currentPosition}getClassName(){return"InstantiateOnVolumeBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get count(){return this._inputs[2]}get matrix(){return this._inputs[3]}get rotation(){return this._inputs[4]}get scaling(){return this._inputs[5]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),e.pushInstancingContext(this),this._vertexData=this.geometry.getConnectedValue(e),e.pushGeometryContext(this._vertexData),!(this._vertexData&&this._vertexData.positions&&this._vertexData.indices&&this.instance.isConnected))return e.restoreExecutionContext(),e.restoreInstancingContext(),e.restoreGeometryContext(),void(this.output._storedValue=null);let t=null;const i=this.count.getConnectedValue(e),s=[],r=bs(this._vertexData.positions,0,this._vertexData.positions.length/3),n=r.minimum,o=r.maximum,a=new S(1,0,0),l=this._vertexData.indices.length/3;this._currentLoopIndex=0;for(let r=0;r<i;r++){this._currentPosition.set(Math.random()*(o.x-n.x)+n.x,Math.random()*(o.y-n.y)+n.y,Math.random()*(o.z-n.z)+n.z);const i=new Fr(this._currentPosition,a);let h=0;for(let e=0;e<l;e++){this._vertex0.fromArray(this._vertexData.positions,3*this._vertexData.indices[3*e]),this._vertex1.fromArray(this._vertexData.positions,3*this._vertexData.indices[3*e+1]),this._vertex2.fromArray(this._vertexData.positions,3*this._vertexData.indices[3*e+2]);const t=i.intersectsTriangle(this._vertex0,this._vertex1,this._vertex2);t&&t.distance>0&&h++}if(h%2==0){r--;continue}if(t=this.instance.getConnectedValue(e),!t||!t.positions||0===t.positions.length)continue;const c=t.clone();if(this.matrix.isConnected){const t=this.matrix.getConnectedValue(e);e._instantiateWithPositionAndMatrix(c,this._currentPosition,t,s)}else{const t=e.adaptInput(this.scaling,Qf.Vector3,S.OneReadOnly),i=this.rotation.getConnectedValue(e)||S.ZeroReadOnly;e._instantiate(c,this._currentPosition,i,t,s)}this._currentLoopIndex++}if(s.length)if(1===s.length)this._vertexData=s[0];else{const e=s.splice(0,1)[0];this._vertexData=e.merge(s,!0,!1,!0,!0)}return e.restoreGeometryContext(),e.restoreExecutionContext(),e.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Qm.prototype,"evaluateContext",void 0),m("BABYLON.InstantiateOnVolumeBlock",Qm);class Zm extends Tm{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("instance",Qf.Geometry,!0),this.registerInput("count",Qf.Int,!0,1),this.registerOutput("output",Qf.Geometry)}getInstanceIndex(){return this._currentIndex}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateBaseBlock"}get instance(){return this._inputs[0]}get count(){return this._inputs[1]}get output(){return this._outputs[0]}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Zm.prototype,"evaluateContext",void 0),m("BABYLON.InstantiateBlock",class extends Zm{constructor(e){super(e),this.registerInput("matrix",Qf.Matrix,!0),this.registerInput("position",Qf.Vector3,!0,S.Zero()),this.registerInput("rotation",Qf.Vector3,!0,S.Zero()),this.registerInput("scaling",Qf.Vector3,!0,S.One()),this.scaling.acceptedConnectionPointTypes.push(Qf.Float)}getInstanceIndex(){return this._currentIndex}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateBlock"}get matrix(){return this._inputs[2]}get position(){return this._inputs[3]}get rotation(){return this._inputs[4]}get scaling(){return this._inputs[5]}_buildBlock(e){const t=e=>{e.pushExecutionContext(this),e.pushInstancingContext(this);const t=this.count.getConnectedValue(e),i=[];for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.instance.getConnectedValue(e);if(!t||!t.positions||0===t.positions.length)continue;const s=t.clone();if(this.matrix.isConnected){const t=this.matrix.getConnectedValue(e);e._instantiateWithMatrix(s,t,i)}else{const t=this.position.getConnectedValue(e)||S.ZeroReadOnly,r=e.adaptInput(this.scaling,Qf.Vector3,S.OneReadOnly),n=this.rotation.getConnectedValue(e)||S.ZeroReadOnly;e._instantiate(s,t,n,r,i)}}if(i.length)if(1===i.length)this._vertexData=i[0];else{const e=i.splice(0,1)[0];this._vertexData=e.merge(i,!0,!1,!0,!0)}return e.restoreExecutionContext(),e.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}}),m("BABYLON.InstantiateLinearBlock",class extends Zm{constructor(e){super(e),this.registerInput("direction",Qf.Vector3,!0,new S(1,0,0)),this.registerInput("rotation",Qf.Vector3,!0,new S(0,0,0)),this.registerInput("scaling",Qf.Vector3,!0,new S(0,0,0)),this.scaling.acceptedConnectionPointTypes.push(Qf.Float)}getClassName(){return"InstantiateLinearBlock"}get direction(){return this._inputs[2]}get rotation(){return this._inputs[3]}get scaling(){return this._inputs[4]}_buildBlock(e){const t=e=>{e.pushExecutionContext(this),e.pushInstancingContext(this);const t=this.count.getConnectedValue(e),i=[],s=y.Identity(),r=S.Zero(),n=S.Zero(),o=S.Zero();for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.instance.getConnectedValue(e);if(!t||!t.positions||0===t.positions.length)continue;const a=t.clone(),l=this.direction.getConnectedValue(e),h=this.rotation.getConnectedValue(e),c=e.adaptInput(this.scaling,Qf.Vector3,S.OneReadOnly);r.copyFrom(l.clone().scale(this._currentIndex)),n.copyFrom(h.clone().scale(this._currentIndex)),o.copyFrom(c.clone().scale(this._currentIndex)),o.addInPlaceFromFloats(1,1,1),y.ComposeToRef(o,C.FromEulerAngles(n.x,n.y,n.z),r,s),e._instantiateWithMatrix(a,s,i)}if(i.length)if(1===i.length)this._vertexData=i[0];else{const e=i.splice(0,1)[0];this._vertexData=e.merge(i,!0,!1,!0,!0)}return e.restoreExecutionContext(),e.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}}),m("BABYLON.InstantiateRadialBlock",class extends Zm{constructor(e){super(e),this.registerInput("radius",Qf.Int,!0,0,0),this.registerInput("angleStart",Qf.Float,!0,0),this.registerInput("angleEnd",Qf.Float,!0,2*Math.PI),this.registerInput("transform",Qf.Vector3,!0,new S(0,0,0)),this.registerInput("rotation",Qf.Vector3,!0,new S(0,0,0)),this.registerInput("scaling",Qf.Vector3,!0,new S(0,0,0)),this.scaling.acceptedConnectionPointTypes.push(Qf.Float)}getClassName(){return"InstantiateRadialBlock"}get radius(){return this._inputs[2]}get angleStart(){return this._inputs[3]}get angleEnd(){return this._inputs[4]}get transform(){return this._inputs[5]}get rotation(){return this._inputs[6]}get scaling(){return this._inputs[7]}_buildBlock(e){const t=e=>{e.pushExecutionContext(this),e.pushInstancingContext(this);const t=this.count.getConnectedValue(e),i=[],s=y.Identity(),r=y.Identity(),n=y.Identity(),o=S.Zero(),a=S.Zero(),l=S.Zero();for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const h=this.instance.getConnectedValue(e);if(!h||!h.positions||0===h.positions.length)continue;const c=h.clone(),u=this.radius.getConnectedValue(e),d=this.angleStart.getConnectedValue(e),p=this.angleEnd.getConnectedValue(e),_=this.transform.getConnectedValue(e),f=this.rotation.getConnectedValue(e),m=e.adaptInput(this.scaling,Qf.Vector3,S.OneReadOnly),g=d+(p-d)/t*this._currentIndex,v=C.FromEulerAngles(0,g,0);o.copyFrom(_.clone().scale(this._currentIndex)),a.copyFrom(f.clone().scale(this._currentIndex)),l.copyFrom(m.clone().scale(this._currentIndex)),l.addInPlaceFromFloats(1,1,1),y.RotationYawPitchRollToRef(a.y,a.x,a.z,s),r.setTranslationFromFloats(0,0,u),y.ComposeToRef(l,v,o,n),s.multiplyToRef(r,r),r.multiplyToRef(n,n),e._instantiateWithMatrix(c,n,i)}if(i.length)if(1===i.length)this._vertexData=i[0];else{const e=i.splice(0,1)[0];this._vertexData=e.merge(i,!0,!1,!0,!0)}return e.restoreExecutionContext(),e.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}}),m("BABYLON.IntFloatConverterBlock",class extends Tm{constructor(e){super(e),this.registerInput("float ",Qf.Float,!0),this.registerInput("int ",Qf.Int,!0),this.registerOutput("float",Qf.Float),this.registerOutput("int",Qf.Int)}getClassName(){return"IntFloatConverterBlock"}get floatIn(){return this._inputs[0]}get intIn(){return this._inputs[1]}get floatOut(){return this._outputs[0]}get intOut(){return this._outputs[1]}_inputRename(e){return"float "===e?"floatIn":"int "===e?"intIn":e}_buildBlock(){this.floatOut._storedFunction=e=>this.floatIn.isConnected?this.floatIn.getConnectedValue(e):this.intIn.isConnected?this.intIn.getConnectedValue(e):0,this.intOut._storedFunction=e=>this.floatIn.isConnected?Math.floor(this.floatIn.getConnectedValue(e)):this.intIn.isConnected?Math.floor(this.intIn.getConnectedValue(e)):0}}),m("BABYLON.DebugBlock",class extends Tm{constructor(e){super(e),this.log=[],this._isDebug=!0,this.registerInput("input",Qf.AutoDetect),this.registerOutput("output",Qf.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(Qf.Geometry),this._inputs[0].excludedConnectionPointTypes.push(Qf.Texture)}get buildExecutionTime(){return 0}getClassName(){return"DebugBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.input.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);this.log=[];const t=e=>{const t=this.input.getConnectedValue(e);return null==t?(this.log.push("null"),t):(this.log.push(t.toString()),t)};this.output.isConnected?this.output._storedFunction=t:this.output._storedValue=t(e)}}),m("BABYLON.GeometryInfoBlock",class extends Tm{constructor(e){super(e),this.registerInput("geometry",Qf.Geometry),this.registerOutput("output",Qf.Geometry),this.registerOutput("id",Qf.Int),this.registerOutput("collectionId",Qf.Int),this.registerOutput("verticesCount",Qf.Int),this.registerOutput("facesCount",Qf.Int)}getClassName(){return"GeometryInfoBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}get id(){return this._outputs[1]}get collectionId(){return this._outputs[2]}get verticesCount(){return this._outputs[3]}get facesCount(){return this._outputs[4]}_buildBlock(){if(!this.geometry.isConnected)return this.id._storedValue=0,this.collectionId._storedValue=0,this.verticesCount._storedValue=0,this.facesCount._storedValue=0,this.output._storedValue=0,this.id._storedFunction=null,this.collectionId._storedFunction=null,this.verticesCount._storedFunction=null,this.facesCount._storedFunction=null,void(this.output._storedFunction=null);this.output._storedFunction=e=>(this._currentVertexData=this.geometry.getConnectedValue(e),this._currentVertexData),this.id._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.uniqueId),this.collectionId._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.metadata?this._currentVertexData.metadata.collectionId:0),this.verticesCount._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.positions?this._currentVertexData.positions.length/3:0),this.facesCount._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.indices?this._currentVertexData.indices.length/3:0)}}),function(e){e[e.Spherical=0]="Spherical",e[e.Cylindrical=1]="Cylindrical",e[e.Cubic=2]="Cubic"}(nm||(nm={}));class Jm extends Tm{constructor(e){super(e),this.mapping=nm.Spherical,this.registerInput("position",Qf.Vector3),this.registerInput("normal",Qf.Vector3),this.registerInput("center",Qf.Vector3,!0,S.Zero()),this.registerOutput("uv",Qf.Vector2)}getClassName(){return"MappingBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get center(){return this._inputs[2]}get uv(){return this._outputs[0]}_buildBlock(){if(!this.position.isConnected)return this.uv._storedFunction=null,void(this.uv._storedValue=null);const e=S.Zero(),t=t=>{const i=this.position.getConnectedValue(t)||S.Zero(),s=this.normal.getConnectedValue(t)||S.Zero(),r=this.center.getConnectedValue(t),n=E.Zero();switch(this.mapping){case nm.Spherical:{i.subtractToRef(r,e);const t=e.length();t>0&&(n.x=Math.acos(e.y/t)/Math.PI,0===e.x&&0===e.z||(n.y=Math.atan2(e.x,e.z)/(2*Math.PI)));break}case nm.Cylindrical:{i.subtractToRef(r,e);const t=e.length();t>0&&(n.x=Math.atan2(e.x/t,e.z/t)/(2*Math.PI),n.y=(e.y+1)/2);break}case nm.Cubic:{const e=Math.abs(s.x),t=Math.abs(s.y),o=Math.abs(s.z),a=Math.max(Math.abs(i.x),Math.abs(i.y),Math.abs(i.z));let l=0,h=0;e>=t&&e>=o?(l=i.y/a-r.y,h=i.z/a-r.z):t>=e&&t>=o?(l=i.x/a-r.x,h=i.z/a-r.z):(l=i.x/a-r.x,h=i.y/a-r.y),n.x=(l+1)/2,n.y=(h+1)/2}}return n};this.uv._storedFunction=e=>t(e)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.mapping = BABYLON.MappingTypes.${nm[this.mapping]};\n`}serialize(){const e=super.serialize();return e.mapping=this.mapping,e}_deserialize(e){super._deserialize(e),this.mapping=e.mapping}}me([Zr("Mapping",Js.List,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"Spherical",value:nm.Spherical},{label:"Cylindrical",value:nm.Cylindrical},{label:"Cubic",value:nm.Cubic}]})],Jm.prototype,"mapping",void 0),m("BABYLON.MappingBlock",Jm),m("BABYLON.MatrixComposeBlock",class extends Tm{constructor(e){super(e),this.registerInput("matrix0",Qf.Matrix),this.registerInput("matrix1",Qf.Matrix),this.registerOutput("output",Qf.Matrix)}getClassName(){return"MatrixComposeBlock"}get matrix0(){return this._inputs[0]}get matrix1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){this.output._storedFunction=e=>{if(!this.matrix0.isConnected||!this.matrix1.isConnected)return null;const t=this.matrix0.getConnectedValue(e),i=this.matrix1.getConnectedValue(e);return t&&i?t.multiply(i):null}}}),m("BABYLON.TeleportInBlock",class extends Tm{get endpoints(){return this._endpoints}constructor(e){super(e),this._endpoints=[],this._isTeleportIn=!0,this.registerInput("input",Qf.AutoDetect)}getClassName(){return"TeleportInBlock"}get input(){return this._inputs[0]}_dumpCode(e,t){let i=super._dumpCode(e,t);for(const s of this.endpoints)-1===t.indexOf(s)&&(i+=s._dumpCode(e,t));return i}isAnAncestorOfType(e){if(this.getClassName()===e)return!0;for(const t of this.endpoints)if(t.isAnAncestorOfType(e))return!0;return!1}isAnAncestorOf(e){for(const t of this.endpoints){if(t===e)return!0;if(t.isAnAncestorOf(e))return!0}return!1}getDescendantOfPredicate(e){if(e(this))return this;for(const t of this.endpoints){const i=t.getDescendantOfPredicate(e);if(i)return i}return null}attachToEndpoint(e){e.detach(),this._endpoints.push(e),e._entryPoint=this,e._outputs[0]._typeConnectionSource=this._inputs[0],e._tempEntryPointUniqueId=null,e.name="> "+this.name}detachFromEndpoint(e){const t=this._endpoints.indexOf(e);-1!==t&&(this._endpoints.splice(t,1),e._outputs[0]._typeConnectionSource=null,e._entryPoint=null)}_buildBlock(){for(const e of this._endpoints)e.output._storedFunction=e=>this.input.getConnectedValue(e)}}),m("BABYLON.TeleportOutBlock",class extends Tm{constructor(e){super(e),this._entryPoint=null,this._tempEntryPointUniqueId=null,this._isTeleportOut=!0,this.registerOutput("output",Qf.BasedOnInput)}get entryPoint(){return this._entryPoint}getClassName(){return"TeleportOutBlock"}get output(){return this._outputs[0]}detach(){this._entryPoint&&this._entryPoint.detachFromEndpoint(this)}_buildBlock(){}_customBuildStep(e){this.entryPoint&&this.entryPoint.build(e)}_dumpCode(e,t){let i="";return this.entryPoint&&-1===t.indexOf(this.entryPoint)&&(i+=this.entryPoint._dumpCode(e,t)),i+super._dumpCode(e,t)}_dumpCodeForOutputConnections(e){let t=super._dumpCodeForOutputConnections(e);return this.entryPoint&&(t+=this.entryPoint._dumpCodeForOutputConnections(e)),t}clone(){const e=super.clone();return this.entryPoint&&this.entryPoint.attachToEndpoint(e),e}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.entryPoint&&(e+=`${this.entryPoint._codeVariableName}.attachToEndpoint(${this._codeVariableName});\n`),e}serialize(){var e,t;const i=super.serialize();return i.entryPoint=null!==(t=null===(e=this.entryPoint)||void 0===e?void 0:e.uniqueId)&&void 0!==t?t:"",i}_deserialize(e){super._deserialize(e),this._tempEntryPointUniqueId=e.entryPoint}});class eg extends Tm{get textureData(){return this._data}get textureWidth(){return this._width}get textureHeight(){return this._height}constructor(e){super(e),this._data=null,this.serializedCachedData=!1,this.registerOutput("texture",Qf.Texture)}getClassName(){return"GeometryTextureBlock"}get texture(){return this._outputs[0]}_prepareImgToLoadAsync(e){return new Promise(((t,i)=>{const s=new Image,r=document.createElement("canvas"),n=r.getContext("2d");s.onload=()=>{r.width=s.width,r.height=s.height,n.drawImage(s,0,0);const e=n.getImageData(0,0,s.width,s.height).data,i=new Float32Array(e.length);for(let t=0;t<e.length;t++)i[t]=e[t]/255;this._data=i,this._width=s.width,this._height=s.height,t()},s.onerror=()=>{this._data=null,i()},s.src=e}))}cleanData(){this._data=null}loadTextureFromFileAsync(e){return this._prepareImgToLoadAsync(URL.createObjectURL(e))}loadTextureFromUrlAsync(e){return this._prepareImgToLoadAsync(e)}extractFromTextureAsync(e){return new Promise(((t,i)=>{if(!e.isReady())return void e.onLoadObservable.addOnce((()=>this.extractFromTextureAsync(e).then(t).catch(i)));const s=e.getSize();Oh(e,s.width,s.height).then((async e=>{const i=new Float32Array(e.length);for(let t=0;t<e.length;t++)i[t]=e[t]/255;this._data=i,this._width=s.width,this._height=s.height,t()})).catch(i)}))}_buildBlock(){if(!this._data)return void(this.texture._storedValue=null);const e={data:this._data,width:this._width,height:this._height};this.texture._storedValue=e}serialize(){const e=super.serialize();return e.width=this._width,e.height=this._height,e.serializedCachedData=this.serializedCachedData,this._data&&this.serializedCachedData&&(e.data=Array.from(this._data)),e}_deserialize(e){super._deserialize(e),this._width=e.width,this._height=e.height,e.data?(this._data=new Float32Array(e.data),this.serializedCachedData=!0):this.serializedCachedData=!!e.serializedCachedData}}me([Zr("Serialize cached data",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],eg.prototype,"serializedCachedData",void 0),m("BABYLON.GeometryTextureBlock",eg);class tg extends Tm{constructor(e){super(e),this.clampCoordinates=!0,this.registerInput("texture",Qf.Texture),this.registerInput("coordinates",Qf.Vector2),this.registerOutput("rgba",Qf.Vector4),this.registerOutput("rgb",Qf.Vector3),this.registerOutput("r",Qf.Float),this.registerOutput("g",Qf.Float),this.registerOutput("b",Qf.Float),this.registerOutput("a",Qf.Float)}getClassName(){return"GeometryTextureFetchBlock"}get texture(){return this.inputs[0]}get coordinates(){return this.inputs[1]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}_repeatClamp(e){return e>=0?e%1:1-Math.abs(e)%1}_buildBlock(){const e=e=>{const t=this.texture.getConnectedValue(e);if(!t||!t.data)return null;const i=this.coordinates.getConnectedValue(e);if(!i)return null;const s=this.clampCoordinates?Math.max(0,Math.min(i.x,1)):this._repeatClamp(i.x),r=this.clampCoordinates?Math.max(0,Math.min(i.y,1)):this._repeatClamp(i.y),n=Math.floor(s*(t.width-1)),o=Math.floor(r*(t.height-1)),a=n+t.width*o;return b.FromArray(t.data,4*a)};this.rgba._storedFunction=t=>e(t),this.rgb._storedFunction=t=>{const i=e(t);return i?i.toVector3():null},this.r._storedFunction=t=>{const i=e(t);return i?i.x:null},this.g._storedFunction=t=>{const i=e(t);return i?i.y:null},this.b._storedFunction=t=>{const i=e(t);return i?i.z:null},this.a._storedFunction=t=>{const i=e(t);return i?i.w:null}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.clampCoordinates = ${this.clampCoordinates};\n`}serialize(){const e=super.serialize();return e.clampCoordinates=this.clampCoordinates,e}_deserialize(e){super._deserialize(e),this.clampCoordinates=e.clampCoordinates}}me([Zr("Clamp Coordinates",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],tg.prototype,"clampCoordinates",void 0),m("BABYLON.GeometryTextureFetchBlock",tg),m("BABYLON.BoundingBlock",class extends Tm{constructor(e){super(e),this.registerInput("geometry",Qf.Geometry),this.registerOutput("min",Qf.Vector3),this.registerOutput("max",Qf.Vector3)}getClassName(){return"BoundingBlock"}get geometry(){return this._inputs[0]}get min(){return this._outputs[0]}get max(){return this._outputs[1]}_buildBlock(){this.min._storedFunction=e=>{const t=this.geometry.getConnectedValue(e);return t?bs(t.positions,0,t.positions.length/3).minimum:null},this.max._storedFunction=e=>{const t=this.geometry.getConnectedValue(e);return t?bs(t.positions,0,t.positions.length/3).maximum:null}}}),function(e){e[e.Intersect=0]="Intersect",e[e.Subtract=1]="Subtract",e[e.Union=2]="Union"}(om||(om={}));class ig extends Tm{constructor(e){super(e),this.evaluateContext=!1,this.operation=om.Intersect,this.registerInput("geometry0",Qf.Geometry),this.registerInput("geometry1",Qf.Geometry),this.registerOutput("output",Qf.Geometry)}getClassName(){return"BooleanGeometryBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{const t=this.geometry0.getConnectedValue(e),i=this.geometry1.getConnectedValue(e);if(!t||!i)return null;const s=t.positions.length/3;!t.normals&&i.normals&&(t.normals=new Array(t.positions.length)),!i.normals&&t.normals&&(i.normals=new Array(i.positions.length)),!t.uvs&&i.uvs&&(t.uvs=new Array(2*s)),!i.uvs&&t.uvs&&(i.uvs=new Array(2*s)),!t.colors&&i.colors&&(t.colors=new Array(4*s)),!i.colors&&t.colors&&(i.colors=new Array(4*s));const r=zf.FromVertexData(t),n=zf.FromVertexData(i);let o;switch(this.operation){case om.Intersect:o=r.intersect(n);break;case om.Subtract:o=r.subtract(n);break;case om.Union:o=r.union(n)}return o.toVertexData()};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`;return e+=`${this._codeVariableName}.operation = BABYLON.BooleanGeometryOperations.${om[this.operation]};\n`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.operation=this.operation,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext,e.operation&&(this.operation=e.operation)}}me([Zr("Evaluate context",Js.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],ig.prototype,"evaluateContext",void 0),me([Zr("Operation",Js.List,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"Intersect",value:om.Intersect},{label:"Subtract",value:om.Subtract},{label:"Union",value:om.Union}]})],ig.prototype,"operation",void 0),m("BABYLON.BooleanGeometryBlock",ig),Ns.OfflineProviderFactory=(e,t,i=!1)=>new sg(e,t,i);class sg{get enableSceneOffline(){return this._enableSceneOffline}get enableTexturesOffline(){return this._enableTexturesOffline}constructor(e,t,i=!1){this._idbFactory="undefined"!=typeof indexedDB?indexedDB:void 0,this._currentSceneUrl=sg._ReturnFullUrlLocation(e),this._db=null,this._enableSceneOffline=!1,this._enableTexturesOffline=!1,this._manifestVersionFound=0,this._mustUpdateRessources=!1,this._hasReachedQuota=!1,sg.IDBStorageEnabled?i?(this._enableSceneOffline=!0,this._enableTexturesOffline=!0,this._manifestVersionFound=1,Ht.SetImmediate((()=>{t(!0)}))):this._checkManifestFile(t):t(!0)}_checkManifestFile(e){const t=()=>{this._enableSceneOffline=!1,this._enableTexturesOffline=!1,e(!1)},i=()=>{try{if("function"==typeof URL&&0===this._currentSceneUrl.indexOf("http")){const e=new URL(this._currentSceneUrl);return e.pathname+=".manifest",e.toString()}}catch(e){}return`${this._currentSceneUrl}.manifest`};let s=!1,r=i();const n=new Te;navigator.onLine&&(s=!0,r=r+(null==r.match(/\?/)?"?":"&")+Date.now()),n.open("GET",r),n.addEventListener("load",(()=>{if(200===n.status||sg._ValidateXHRData(n,1))try{const t=JSON.parse(n.response);this._enableSceneOffline=t.enableSceneOffline,this._enableTexturesOffline=t.enableTexturesOffline&&sg._IsUASupportingBlobStorage,t.version&&!isNaN(parseInt(t.version))&&(this._manifestVersionFound=t.version),e(!0)}catch(e){t()}else t()}),!1),n.addEventListener("error",(()=>{if(s){s=!1;const e=i();n.open("GET",e),n.send()}else t()}),!1);try{n.send()}catch(t){k.Error("Error on XHR send request."),e(!1)}}open(e,t){const i=()=>{this._isSupported=!1,t&&t()};if(this._idbFactory&&(this._enableSceneOffline||this._enableTexturesOffline))if(this._db)e&&e();else{this._hasReachedQuota=!1,this._isSupported=!0;const t=this._idbFactory.open("babylonjs",1);t.onerror=()=>{i()},t.onblocked=()=>{k.Error("IDB request blocked. Please reload the page."),i()},t.onsuccess=()=>{this._db=t.result,e()},t.onupgradeneeded=e=>{if(this._db=e.target.result,this._db)try{this._db.createObjectStore("scenes",{keyPath:"sceneUrl"}),this._db.createObjectStore("versions",{keyPath:"sceneUrl"}),this._db.createObjectStore("textures",{keyPath:"textureUrl"})}catch(e){k.Error("Error while creating object stores. Exception: "+e.message),i()}}}else this._isSupported=!1,t&&t()}loadImage(e,t){const i=sg._ReturnFullUrlLocation(e),s=()=>{this._hasReachedQuota||null===this._db?t.src=e:this._saveImageIntoDBAsync(i,t)};this._mustUpdateRessources?s():this._loadImageFromDBAsync(i,t,s)}_loadImageFromDBAsync(e,t,i){if(this._isSupported&&null!==this._db){let s;const r=this._db.transaction(["textures"]);r.onabort=()=>{t.src=e},r.oncomplete=()=>{let r;s&&"function"==typeof URL?(r=URL.createObjectURL(s.data),t.onerror=()=>{k.Error("Error loading image from blob URL: "+r+" switching back to web url: "+e),t.src=e},t.src=r):i()};const n=r.objectStore("textures").get(e);n.onsuccess=e=>{s=e.target.result},n.onerror=()=>{k.Error("Error loading texture "+e+" from DB."),t.src=e}}else k.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t.src=e}_saveImageIntoDBAsync(e,t){let i;if(this._isSupported){const s=()=>{let e;if(i&&"function"==typeof URL)try{e=URL.createObjectURL(i)}catch(t){e=URL.createObjectURL(i)}e&&(t.src=e)};if(sg._IsUASupportingBlobStorage){const r=new Te;r.open("GET",e),r.responseType="blob",r.addEventListener("load",(()=>{if(200===r.status&&this._db){i=r.response;const n=this._db.transaction(["textures"],"readwrite");n.onabort=e=>{try{const t=e.target.error;t&&"QuotaExceededError"===t.name&&(this._hasReachedQuota=!0)}catch(e){}s()},n.oncomplete=()=>{s()};const o={textureUrl:e,data:i};try{const e=n.objectStore("textures").put(o);e.onsuccess=()=>{},e.onerror=()=>{s()}}catch(i){25===i.code&&(sg._IsUASupportingBlobStorage=!1,this._enableTexturesOffline=!1),t.src=e}}else t.src=e}),!1),r.addEventListener("error",(()=>{k.Error("Error in XHR request in BABYLON.Database."),t.src=e}),!1),r.send()}else t.src=e}else k.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),t.src=e}_checkVersionFromDB(e,t){this._loadVersionFromDBAsync(e,t,(()=>{this._saveVersionIntoDBAsync(e,t)}))}_loadVersionFromDBAsync(e,t,i){if(this._isSupported&&this._db){let s;try{const r=this._db.transaction(["versions"]);r.oncomplete=()=>{s?this._manifestVersionFound!==s.data?(this._mustUpdateRessources=!0,i()):t(s.data):(this._mustUpdateRessources=!0,i())},r.onabort=()=>{t(-1)};const n=r.objectStore("versions").get(e);n.onsuccess=e=>{s=e.target.result},n.onerror=()=>{k.Error("Error loading version for scene "+e+" from DB."),t(-1)}}catch(e){k.Error("Error while accessing 'versions' object store (READ OP). Exception: "+e.message),t(-1)}}else k.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),t(-1)}_saveVersionIntoDBAsync(e,t){if(this._isSupported&&!this._hasReachedQuota&&this._db)try{const i=this._db.transaction(["versions"],"readwrite");i.onabort=e=>{try{const t=e.target.error;t&&"QuotaExceededError"===t.name&&(this._hasReachedQuota=!0)}catch(e){}t(-1)},i.oncomplete=()=>{t(this._manifestVersionFound)};const s={sceneUrl:e,data:this._manifestVersionFound},r=i.objectStore("versions").put(s);r.onsuccess=()=>{},r.onerror=()=>{k.Error("Error in DB add version request in BABYLON.Database.")}}catch(e){k.Error("Error while accessing 'versions' object store (WRITE OP). Exception: "+e.message),t(-1)}else t(-1)}loadFile(e,t,i,s,r){const n=sg._ReturnFullUrlLocation(e),o=()=>{this._saveFileAsync(n,t,i,r,s)};this._checkVersionFromDB(n,(e=>{-1!==e?this._mustUpdateRessources?this._saveFileAsync(n,t,i,r,s):this._loadFileAsync(n,t,o):s&&s()}))}_loadFileAsync(e,t,i){if(this._isSupported&&this._db){let s,r;s=-1!==e.indexOf(".babylon")?"scenes":"textures";const n=this._db.transaction([s]);n.oncomplete=()=>{r?t(r.data):i()},n.onabort=()=>{i()};const o=n.objectStore(s).get(e);o.onsuccess=e=>{r=e.target.result},o.onerror=()=>{k.Error("Error loading file "+e+" from DB."),i()}}else k.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t()}_saveFileAsync(e,t,i,s,r){if(this._isSupported){let n;n=-1!==e.indexOf(".babylon")?"scenes":"textures";const o=new Te;let a;o.open("GET",e+(null==e.match(/\?/)?"?":"&")+Date.now()),s&&(o.responseType="arraybuffer"),i&&(o.onprogress=i),o.addEventListener("load",(()=>{if(200===o.status||o.status<400&&sg._ValidateXHRData(o,s?6:1))if(a=s?o.response:o.responseText,!this._hasReachedQuota&&this._db){const i=this._db.transaction([n],"readwrite");let s;i.onabort=e=>{try{const t=e.target.error;t&&"QuotaExceededError"===t.name&&(this._hasReachedQuota=!0)}catch(e){}t(a)},i.oncomplete=()=>{t(a)},s="scenes"===n?{sceneUrl:e,data:a,version:this._manifestVersionFound}:{textureUrl:e,data:a};try{const e=i.objectStore(n).put(s);e.onsuccess=()=>{},e.onerror=()=>{k.Error("Error in DB add file request in BABYLON.Database.")}}catch(e){t(a)}}else t(a);else o.status>=400&&r?r(o):t()}),!1),o.addEventListener("error",(()=>{k.Error("error on XHR request."),r&&r()}),!1),o.send()}else k.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),r&&r()}static _ValidateXHRData(e,t=7){try{if(1&t){if(e.responseText&&e.responseText.length>0)return!0;if(1===t)return!1}if(2&t){const i=E_(e.response);if(i.width&&i.height&&i.width>0&&i.height>0)return!0;if(2===t)return!1}if(4&t){const t=new Uint8Array(e.response,0,3);return 68===t[0]&&68===t[1]&&83===t[2]}}catch(e){}return!1}}sg._IsUASupportingBlobStorage=!0,sg.IDBStorageEnabled=!1,sg._ParseURL=e=>{document.createElement("a").href=e;const t=e.substring(0,e.lastIndexOf("#")),i=e.substring(t.lastIndexOf("/")+1,e.length);return e.substring(0,e.indexOf(i,0))},sg._ReturnFullUrlLocation=e=>-1===e.indexOf("http:/")&&-1===e.indexOf("https:/")&&"undefined"!=typeof window?sg._ParseURL(window.location.href)+e:e;class rg{_isUbo(e){return void 0!==e.addUniform}constructor(e){this._isUbo(e)?(this.setMatrix3x3=e.updateMatrix3x3.bind(e),this.setMatrix2x2=e.updateMatrix2x2.bind(e),this.setFloat=e.updateFloat.bind(e),this.setFloat2=e.updateFloat2.bind(e),this.setFloat3=e.updateFloat3.bind(e),this.setFloat4=e.updateFloat4.bind(e),this.setFloatArray=e.updateFloatArray.bind(e),this.setArray=e.updateArray.bind(e),this.setIntArray=e.updateIntArray.bind(e),this.setMatrix=e.updateMatrix.bind(e),this.setMatrices=e.updateMatrices.bind(e),this.setVector3=e.updateVector3.bind(e),this.setVector4=e.updateVector4.bind(e),this.setColor3=e.updateColor3.bind(e),this.setColor4=e.updateColor4.bind(e),this.setDirectColor4=e.updateDirectColor4.bind(e),this.setInt=e.updateInt.bind(e),this.setInt2=e.updateInt2.bind(e),this.setInt3=e.updateInt3.bind(e),this.setInt4=e.updateInt4.bind(e)):(this.setMatrix3x3=e.setMatrix3x3.bind(e),this.setMatrix2x2=e.setMatrix2x2.bind(e),this.setFloat=e.setFloat.bind(e),this.setFloat2=e.setFloat2.bind(e),this.setFloat3=e.setFloat3.bind(e),this.setFloat4=e.setFloat4.bind(e),this.setFloatArray=e.setFloatArray.bind(e),this.setArray=e.setArray.bind(e),this.setIntArray=e.setIntArray.bind(e),this.setMatrix=e.setMatrix.bind(e),this.setMatrices=e.setMatrices.bind(e),this.setVector3=e.setVector3.bind(e),this.setVector4=e.setVector4.bind(e),this.setColor3=e.setColor3.bind(e),this.setColor4=e.setColor4.bind(e),this.setDirectColor4=e.setDirectColor4.bind(e),this.setInt=e.setInt.bind(e),this.setInt2=e.setInt2.bind(e),this.setInt3=e.setInt3.bind(e),this.setInt4=e.setInt4.bind(e))}}nt.ShadersStore.gpuUpdateParticlesPixelShader="#version 300 es\nvoid main() {discard;}\n";nt.ShadersStore.gpuUpdateParticlesVertexShader="#version 300 es\n#define PI 3.14159\nuniform float currentCount;uniform float timeDelta;uniform float stopFactor;\n#ifndef LOCAL\nuniform mat4 emitterWM;\n#endif\nuniform vec2 lifeTime;uniform vec2 emitPower;uniform vec2 sizeRange;uniform vec4 scaleRange;\n#ifndef COLORGRADIENTS\nuniform vec4 color1;uniform vec4 color2;\n#endif\nuniform vec3 gravity;uniform sampler2D randomSampler;uniform sampler2D randomSampler2;uniform vec4 angleRange;\n#ifdef BOXEMITTER\nuniform vec3 direction1;uniform vec3 direction2;uniform vec3 minEmitBox;uniform vec3 maxEmitBox;\n#endif\n#ifdef POINTEMITTER\nuniform vec3 direction1;uniform vec3 direction2;\n#endif\n#ifdef HEMISPHERICEMITTER\nuniform float radius;uniform float radiusRange;uniform float directionRandomizer;\n#endif\n#ifdef SPHEREEMITTER\nuniform float radius;uniform float radiusRange;\n#ifdef DIRECTEDSPHEREEMITTER\nuniform vec3 direction1;uniform vec3 direction2;\n#else\nuniform float directionRandomizer;\n#endif\n#endif\n#ifdef CYLINDEREMITTER\nuniform float radius;uniform float height;uniform float radiusRange;\n#ifdef DIRECTEDCYLINDEREMITTER\nuniform vec3 direction1;uniform vec3 direction2;\n#else\nuniform float directionRandomizer;\n#endif\n#endif\n#ifdef CONEEMITTER\nuniform vec2 radius;uniform float coneAngle;uniform vec2 height;uniform float directionRandomizer;\n#endif\nin vec3 position;\n#ifdef CUSTOMEMITTER\nin vec3 initialPosition;\n#endif\nin float age;in float life;in vec4 seed;in vec3 size;\n#ifndef COLORGRADIENTS\nin vec4 color;\n#endif\nin vec3 direction;\n#ifndef BILLBOARD\nin vec3 initialDirection;\n#endif\n#ifdef ANGULARSPEEDGRADIENTS\nin float angle;\n#else\nin vec2 angle;\n#endif\n#ifdef ANIMATESHEET\nin float cellIndex;\n#ifdef ANIMATESHEETRANDOMSTART\nin float cellStartOffset;\n#endif\n#endif\n#ifdef NOISE\nin vec3 noiseCoordinates1;in vec3 noiseCoordinates2;\n#endif\nout vec3 outPosition;\n#ifdef CUSTOMEMITTER\nout vec3 outInitialPosition;\n#endif\nout float outAge;out float outLife;out vec4 outSeed;out vec3 outSize;\n#ifndef COLORGRADIENTS\nout vec4 outColor;\n#endif\nout vec3 outDirection;\n#ifndef BILLBOARD\nout vec3 outInitialDirection;\n#endif\n#ifdef ANGULARSPEEDGRADIENTS\nout float outAngle;\n#else\nout vec2 outAngle;\n#endif\n#ifdef ANIMATESHEET\nout float outCellIndex;\n#ifdef ANIMATESHEETRANDOMSTART\nout float outCellStartOffset;\n#endif\n#endif\n#ifdef NOISE\nout vec3 outNoiseCoordinates1;out vec3 outNoiseCoordinates2;\n#endif\n#ifdef SIZEGRADIENTS\nuniform sampler2D sizeGradientSampler;\n#endif \n#ifdef ANGULARSPEEDGRADIENTS\nuniform sampler2D angularSpeedGradientSampler;\n#endif \n#ifdef VELOCITYGRADIENTS\nuniform sampler2D velocityGradientSampler;\n#endif\n#ifdef LIMITVELOCITYGRADIENTS\nuniform sampler2D limitVelocityGradientSampler;uniform float limitVelocityDamping;\n#endif\n#ifdef DRAGGRADIENTS\nuniform sampler2D dragGradientSampler;\n#endif\n#ifdef NOISE\nuniform vec3 noiseStrength;uniform sampler2D noiseSampler;\n#endif\n#ifdef ANIMATESHEET\nuniform vec4 cellInfos;\n#endif\nvec3 getRandomVec3(float offset) {return texture(randomSampler2,vec2(float(gl_VertexID)*offset/currentCount,0)).rgb;}\nvec4 getRandomVec4(float offset) {return texture(randomSampler,vec2(float(gl_VertexID)*offset/currentCount,0));}\nvoid main() {float newAge=age+timeDelta; \nif (newAge>=life && stopFactor != 0.) {vec3 newPosition;vec3 newDirection;vec4 randoms=getRandomVec4(seed.x);outLife=lifeTime.x+(lifeTime.y-lifeTime.x)*randoms.r;outAge=newAge-life;outSeed=seed;\n#ifdef SIZEGRADIENTS \noutSize.x=texture(sizeGradientSampler,vec2(0,0)).r;\n#else\noutSize.x=sizeRange.x+(sizeRange.y-sizeRange.x)*randoms.g;\n#endif\noutSize.y=scaleRange.x+(scaleRange.y-scaleRange.x)*randoms.b;outSize.z=scaleRange.z+(scaleRange.w-scaleRange.z)*randoms.a; \n#ifndef COLORGRADIENTS\noutColor=color1+(color2-color1)*randoms.b;\n#endif\n#ifndef ANGULARSPEEDGRADIENTS \noutAngle.y=angleRange.x+(angleRange.y-angleRange.x)*randoms.a;outAngle.x=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;\n#else\noutAngle=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;\n#endif \n#ifdef POINTEMITTER\nvec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);newPosition=vec3(0,0,0);newDirection=direction1+(direction2-direction1)*randoms3;\n#elif defined(BOXEMITTER)\nvec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);newPosition=minEmitBox+(maxEmitBox-minEmitBox)*randoms2;newDirection=direction1+(direction2-direction1)*randoms3; \n#elif defined(HEMISPHERICEMITTER)\nvec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float phi=2.0*PI*randoms2.x;float theta=acos(2.0*randoms2.y-1.0);float randX=cos(phi)*sin(theta);float randY=cos(theta);float randZ=sin(phi)*sin(theta);newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,abs(randY),randZ);newDirection=newPosition+directionRandomizer*randoms3; \n#elif defined(SPHEREEMITTER)\nvec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float phi=2.0*PI*randoms2.x;float theta=acos(2.0*randoms2.y-1.0);float randX=cos(phi)*sin(theta);float randY=cos(theta);float randZ=sin(phi)*sin(theta);newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,randY,randZ);\n#ifdef DIRECTEDSPHEREEMITTER\nnewDirection=normalize(direction1+(direction2-direction1)*randoms3);\n#else\nnewDirection=normalize(newPosition+directionRandomizer*randoms3);\n#endif\n#elif defined(CYLINDEREMITTER)\nvec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float yPos=(randoms2.x-0.5)*height;float angle=randoms2.y*PI*2.;float inverseRadiusRangeSquared=((1.-radiusRange)*(1.-radiusRange));float positionRadius=radius*sqrt(inverseRadiusRangeSquared+(randoms2.z*(1.-inverseRadiusRangeSquared)));float xPos=positionRadius*cos(angle);float zPos=positionRadius*sin(angle);newPosition=vec3(xPos,yPos,zPos);\n#ifdef DIRECTEDCYLINDEREMITTER\nnewDirection=direction1+(direction2-direction1)*randoms3;\n#else\nangle=angle+((randoms3.x-0.5)*PI)*directionRandomizer;newDirection=vec3(cos(angle),(randoms3.y-0.5)*directionRandomizer,sin(angle));newDirection=normalize(newDirection);\n#endif\n#elif defined(CONEEMITTER)\nvec3 randoms2=getRandomVec3(seed.y);float s=2.0*PI*randoms2.x;\n#ifdef CONEEMITTERSPAWNPOINT\nfloat h=0.0001;\n#else\nfloat h=randoms2.y*height.y;h=1.-h*h; \n#endif\nfloat lRadius=radius.x-radius.x*randoms2.z*radius.y;lRadius=lRadius*h;float randX=lRadius*sin(s);float randZ=lRadius*cos(s);float randY=h *height.x;newPosition=vec3(randX,randY,randZ); \nif (abs(cos(coneAngle))==1.0) {newDirection=vec3(0.,1.0,0.);} else {vec3 randoms3=getRandomVec3(seed.z);newDirection=normalize(newPosition+directionRandomizer*randoms3); }\n#elif defined(CUSTOMEMITTER)\nnewPosition=initialPosition;outInitialPosition=initialPosition;\n#else \nnewPosition=vec3(0.,0.,0.);newDirection=2.0*(getRandomVec3(seed.w)-vec3(0.5,0.5,0.5));\n#endif\nfloat power=emitPower.x+(emitPower.y-emitPower.x)*randoms.a;\n#ifdef LOCAL\noutPosition=newPosition;\n#else\noutPosition=(emitterWM*vec4(newPosition,1.)).xyz;\n#endif\n#ifdef CUSTOMEMITTER\noutDirection=direction;\n#ifndef BILLBOARD \noutInitialDirection=direction;\n#endif\n#else\n#ifdef LOCAL\nvec3 initial=newDirection;\n#else \nvec3 initial=(emitterWM*vec4(newDirection,0.)).xyz;\n#endif\noutDirection=initial*power;\n#ifndef BILLBOARD \noutInitialDirection=initial;\n#endif\n#endif\n#ifdef ANIMATESHEET \noutCellIndex=cellInfos.x;\n#ifdef ANIMATESHEETRANDOMSTART\noutCellStartOffset=randoms.a*outLife;\n#endif \n#endif\n#ifdef NOISE\noutNoiseCoordinates1=noiseCoordinates1;outNoiseCoordinates2=noiseCoordinates2;\n#endif\n} else {float directionScale=timeDelta;outAge=newAge;float ageGradient=newAge/life;\n#ifdef VELOCITYGRADIENTS\ndirectionScale*=texture(velocityGradientSampler,vec2(ageGradient,0)).r;\n#endif\n#ifdef DRAGGRADIENTS\ndirectionScale*=1.0-texture(dragGradientSampler,vec2(ageGradient,0)).r;\n#endif\n#if defined(CUSTOMEMITTER)\noutPosition=position+(direction-position)*ageGradient; \noutInitialPosition=initialPosition;\n#else\noutPosition=position+direction*directionScale;\n#endif\noutLife=life;outSeed=seed;\n#ifndef COLORGRADIENTS \noutColor=color;\n#endif\n#ifdef SIZEGRADIENTS\noutSize.x=texture(sizeGradientSampler,vec2(ageGradient,0)).r;outSize.yz=size.yz;\n#else\noutSize=size;\n#endif \n#ifndef BILLBOARD \noutInitialDirection=initialDirection;\n#endif\n#ifdef CUSTOMEMITTER\noutDirection=direction;\n#else\nvec3 updatedDirection=direction+gravity*timeDelta;\n#ifdef LIMITVELOCITYGRADIENTS\nfloat limitVelocity=texture(limitVelocityGradientSampler,vec2(ageGradient,0)).r;float currentVelocity=length(updatedDirection);if (currentVelocity>limitVelocity) {updatedDirection=updatedDirection*limitVelocityDamping;}\n#endif\noutDirection=updatedDirection;\n#ifdef NOISE\nfloat fetchedR=texture(noiseSampler,vec2(noiseCoordinates1.x,noiseCoordinates1.y)*vec2(0.5)+vec2(0.5)).r;float fetchedG=texture(noiseSampler,vec2(noiseCoordinates1.z,noiseCoordinates2.x)*vec2(0.5)+vec2(0.5)).r;float fetchedB=texture(noiseSampler,vec2(noiseCoordinates2.y,noiseCoordinates2.z)*vec2(0.5)+vec2(0.5)).r;vec3 force=vec3(2.*fetchedR-1.,2.*fetchedG-1.,2.*fetchedB-1.)*noiseStrength;outDirection=outDirection+force*timeDelta;outNoiseCoordinates1=noiseCoordinates1;outNoiseCoordinates2=noiseCoordinates2;\n#endif \n#endif \n#ifdef ANGULARSPEEDGRADIENTS\nfloat angularSpeed=texture(angularSpeedGradientSampler,vec2(ageGradient,0)).r;outAngle=angle+angularSpeed*timeDelta;\n#else\noutAngle=vec2(angle.x+angle.y*timeDelta,angle.y);\n#endif\n#ifdef ANIMATESHEET \nfloat offsetAge=outAge;float dist=cellInfos.y-cellInfos.x;\n#ifdef ANIMATESHEETRANDOMSTART\noutCellStartOffset=cellStartOffset;offsetAge+=cellStartOffset;\n#else\nfloat cellStartOffset=0.;\n#endif \nfloat ratio=0.;if (cellInfos.w==1.0) {ratio=clamp(mod(cellStartOffset+cellInfos.z*offsetAge,life)/life,0.,1.0);}\nelse {ratio=clamp(cellStartOffset+cellInfos.z*offsetAge/life,0.,1.0);}\noutCellIndex=float(int(cellInfos.x+ratio*dist));\n#endif\n}}",m("BABYLON.WebGL2ParticleSystem",class{constructor(e,t){this._renderVAO=[],this._updateVAO=[],this.alignDataInBuffer=!1,this._parent=e,this._engine=t,this._updateEffectOptions={attributes:["position","initialPosition","age","life","seed","size","color","direction","initialDirection","angle","cellIndex","cellStartOffset","noiseCoordinates1","noiseCoordinates2"],uniformsNames:["currentCount","timeDelta","emitterWM","lifeTime","color1","color2","sizeRange","scaleRange","gravity","emitPower","direction1","direction2","minEmitBox","maxEmitBox","radius","directionRandomizer","height","coneAngle","stopFactor","angleRange","radiusRange","cellInfos","noiseStrength","limitVelocityDamping"],uniformBuffersNames:[],samplers:["randomSampler","randomSampler2","sizeGradientSampler","angularSpeedGradientSampler","velocityGradientSampler","limitVelocityGradientSampler","noiseSampler","dragGradientSampler"],defines:"",fallbacks:null,onCompiled:null,onError:null,indexParameters:null,maxSimultaneousLights:0,transformFeedbackVaryings:[]}}contextLost(){this._updateEffect=void 0,this._renderVAO.length=0,this._updateVAO.length=0}isUpdateBufferCreated(){return!!this._updateEffect}isUpdateBufferReady(){var e,t;return null!==(t=null===(e=this._updateEffect)||void 0===e?void 0:e.isReady())&&void 0!==t&&t}createUpdateBuffer(e){return this._updateEffectOptions.transformFeedbackVaryings=["outPosition"],this._updateEffectOptions.transformFeedbackVaryings.push("outAge"),this._updateEffectOptions.transformFeedbackVaryings.push("outSize"),this._updateEffectOptions.transformFeedbackVaryings.push("outLife"),this._updateEffectOptions.transformFeedbackVaryings.push("outSeed"),this._updateEffectOptions.transformFeedbackVaryings.push("outDirection"),this._parent.particleEmitterType instanceof yn&&this._updateEffectOptions.transformFeedbackVaryings.push("outInitialPosition"),this._parent._colorGradientsTexture||this._updateEffectOptions.transformFeedbackVaryings.push("outColor"),this._parent._isBillboardBased||this._updateEffectOptions.transformFeedbackVaryings.push("outInitialDirection"),this._parent.noiseTexture&&(this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates1"),this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates2")),this._updateEffectOptions.transformFeedbackVaryings.push("outAngle"),this._parent.isAnimationSheetEnabled&&(this._updateEffectOptions.transformFeedbackVaryings.push("outCellIndex"),this._parent.spriteRandomStartCell&&this._updateEffectOptions.transformFeedbackVaryings.push("outCellStartOffset")),this._updateEffectOptions.defines=e,this._updateEffect=new ot("gpuUpdateParticles",this._updateEffectOptions,this._engine),new rg(this._updateEffect)}createVertexBuffers(e,t){this._updateVAO.push(this._createUpdateVAO(e)),this._renderVAO.push(this._engine.recordVertexArrayObject(t,null,this._parent._getWrapper(this._parent.blendMode).effect)),this._engine.bindArrayBuffer(null),this._renderVertexBuffers=t}createParticleBuffer(e){return e}bindDrawBuffers(e,t,i){i?this._engine.bindBuffers(this._renderVertexBuffers,i,t):this._engine.bindVertexArrayObject(this._renderVAO[e],null)}preUpdateParticleBuffer(){const e=this._engine;if(this._engine.enableEffect(this._updateEffect),!e.setState)throw new Error("GPU particles cannot work without a full Engine. ThinEngine is not supported")}updateParticleBuffer(e,t,i){this._updateEffect.setTexture("randomSampler",this._parent._randomTexture),this._updateEffect.setTexture("randomSampler2",this._parent._randomTexture2),this._parent._sizeGradientsTexture&&this._updateEffect.setTexture("sizeGradientSampler",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateEffect.setTexture("angularSpeedGradientSampler",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateEffect.setTexture("velocityGradientSampler",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateEffect.setTexture("limitVelocityGradientSampler",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateEffect.setTexture("dragGradientSampler",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateEffect.setTexture("noiseSampler",this._parent.noiseTexture),this._engine.bindVertexArrayObject(this._updateVAO[e],null);const s=this._engine;s.bindTransformFeedbackBuffer(t.getBuffer()),s.setRasterizerState(!1),s.beginTransformFeedback(!0),s.drawArraysType(3,0,i),s.endTransformFeedback(),s.setRasterizerState(!0),s.bindTransformFeedbackBuffer(null)}releaseBuffers(){}releaseVertexBuffers(){for(let e=0;e<this._updateVAO.length;e++)this._engine.releaseVertexArrayObject(this._updateVAO[e]);this._updateVAO.length=0;for(let e=0;e<this._renderVAO.length;e++)this._engine.releaseVertexArrayObject(this._renderVAO[e]);this._renderVAO.length=0}_createUpdateVAO(e){const t={};t.position=e.createVertexBuffer("position",0,3);let i=3;t.age=e.createVertexBuffer("age",i,1),i+=1,t.size=e.createVertexBuffer("size",i,3),i+=3,t.life=e.createVertexBuffer("life",i,1),i+=1,t.seed=e.createVertexBuffer("seed",i,4),i+=4,t.direction=e.createVertexBuffer("direction",i,3),i+=3,this._parent.particleEmitterType instanceof yn&&(t.initialPosition=e.createVertexBuffer("initialPosition",i,3),i+=3),this._parent._colorGradientsTexture||(t.color=e.createVertexBuffer("color",i,4),i+=4),this._parent._isBillboardBased||(t.initialDirection=e.createVertexBuffer("initialDirection",i,3),i+=3),this._parent.noiseTexture&&(t.noiseCoordinates1=e.createVertexBuffer("noiseCoordinates1",i,3),i+=3,t.noiseCoordinates2=e.createVertexBuffer("noiseCoordinates2",i,3),i+=3),this._parent._angularSpeedGradientsTexture?(t.angle=e.createVertexBuffer("angle",i,1),i+=1):(t.angle=e.createVertexBuffer("angle",i,2),i+=2),this._parent._isAnimationSheetEnabled&&(t.cellIndex=e.createVertexBuffer("cellIndex",i,1),i+=1,this._parent.spriteRandomStartCell&&(t.cellStartOffset=e.createVertexBuffer("cellStartOffset",i,1),i+=1));const s=this._engine.recordVertexArrayObject(t,null,this._updateEffect);return this._engine.bindArrayBuffer(null),s}});nt.ShadersStoreWGSL.gpuUpdateParticlesComputeShader="struct Particle {position : vec3<f32>,\nage : f32,\nsize : vec3<f32>,\nlife : f32,\nseed : vec4<f32>,\ndirection : vec3<f32>,\ndummy0: f32,\n#ifdef CUSTOMEMITTER\ninitialPosition : vec3<f32>,\ndummy1: f32,\n#endif\n#ifndef COLORGRADIENTS\ncolor : vec4<f32>,\n#endif\n#ifndef BILLBOARD\ninitialDirection : vec3<f32>,\ndummy2: f32,\n#endif\n#ifdef NOISE\nnoiseCoordinates1 : vec3<f32>,\ndummy3: f32,\nnoiseCoordinates2 : vec3<f32>,\ndummy4: f32,\n#endif\n#ifdef ANGULARSPEEDGRADIENTS\nangle : f32,\n#else\nangle : vec2<f32>,\n#endif\n#ifdef ANIMATESHEET\ncellIndex : f32,\n#ifdef ANIMATESHEETRANDOMSTART\ncellStartOffset : f32,\n#endif\n#endif\n};struct Particles {particles : array<Particle>,};struct SimParams {currentCount : f32,\ntimeDelta : f32,\nstopFactor : f32,\nrandomTextureSize: i32,\nlifeTime : vec2<f32>,\nemitPower : vec2<f32>,\n#ifndef COLORGRADIENTS\ncolor1 : vec4<f32>,\ncolor2 : vec4<f32>,\n#endif\nsizeRange : vec2<f32>,\nscaleRange : vec4<f32>,\nangleRange : vec4<f32>,\ngravity : vec3<f32>,\n#ifdef LIMITVELOCITYGRADIENTS\nlimitVelocityDamping : f32,\n#endif\n#ifdef ANIMATESHEET\ncellInfos : vec4<f32>,\n#endif\n#ifdef NOISE\nnoiseStrength : vec3<f32>,\n#endif\n#ifndef LOCAL\nemitterWM : mat4x4<f32>,\n#endif\n#ifdef BOXEMITTER\ndirection1 : vec3<f32>,\ndirection2 : vec3<f32>,\nminEmitBox : vec3<f32>,\nmaxEmitBox : vec3<f32>,\n#endif\n#ifdef CONEEMITTER\nradius : vec2<f32>,\nconeAngle : f32,\nheight : vec2<f32>,\ndirectionRandomizer : f32,\n#endif\n#ifdef CYLINDEREMITTER\nradius : f32,\nheight : f32,\nradiusRange : f32,\n#ifdef DIRECTEDCYLINDEREMITTER\ndirection1 : vec3<f32>,\ndirection2 : vec3<f32>,\n#else\ndirectionRandomizer : f32,\n#endif\n#endif\n#ifdef HEMISPHERICEMITTER\nradius : f32,\nradiusRange : f32,\ndirectionRandomizer : f32,\n#endif\n#ifdef POINTEMITTER\ndirection1 : vec3<f32>,\ndirection2 : vec3<f32>,\n#endif\n#ifdef SPHEREEMITTER\nradius : f32,\nradiusRange : f32,\n#ifdef DIRECTEDSPHEREEMITTER\ndirection1 : vec3<f32>,\ndirection2 : vec3<f32>,\n#else\ndirectionRandomizer : f32,\n#endif\n#endif\n};@binding(0) @group(0) var<uniform> params : SimParams;@binding(1) @group(0) var<storage,read> particlesIn : Particles;@binding(2) @group(0) var<storage,read_write> particlesOut : Particles;@binding(3) @group(0) var randomTexture : texture_2d<f32>;@binding(4) @group(0) var randomTexture2 : texture_2d<f32>;\n#ifdef SIZEGRADIENTS\n@binding(0) @group(1) var sizeGradientSampler : sampler;@binding(1) @group(1) var sizeGradientTexture : texture_2d<f32>;\n#endif \n#ifdef ANGULARSPEEDGRADIENTS\n@binding(2) @group(1) var angularSpeedGradientSampler : sampler;@binding(3) @group(1) var angularSpeedGradientTexture : texture_2d<f32>;\n#endif \n#ifdef VELOCITYGRADIENTS\n@binding(4) @group(1) var velocityGradientSampler : sampler;@binding(5) @group(1) var velocityGradientTexture : texture_2d<f32>;\n#endif\n#ifdef LIMITVELOCITYGRADIENTS\n@binding(6) @group(1) var limitVelocityGradientSampler : sampler;@binding(7) @group(1) var limitVelocityGradientTexture : texture_2d<f32>;\n#endif\n#ifdef DRAGGRADIENTS\n@binding(8) @group(1) var dragGradientSampler : sampler;@binding(9) @group(1) var dragGradientTexture : texture_2d<f32>;\n#endif\n#ifdef NOISE\n@binding(10) @group(1) var noiseSampler : sampler;@binding(11) @group(1) var noiseTexture : texture_2d<f32>;\n#endif\nfn getRandomVec3(offset : f32,vertexID : f32)->vec3<f32> {return textureLoad(randomTexture2,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0).rgb;}\nfn getRandomVec4(offset : f32,vertexID : f32)->vec4<f32> {return textureLoad(randomTexture,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0);}\n@compute @workgroup_size(64)\nfn main(@builtin(global_invocation_id) GlobalInvocationID : vec3<u32>) {let index : u32=GlobalInvocationID.x;let vertexID : f32=f32(index);if (index>=u32(params.currentCount)) {return;}\nlet PI : f32=3.14159;let timeDelta : f32=params.timeDelta;let newAge : f32=particlesIn.particles[index].age+timeDelta;let life : f32=particlesIn.particles[index].life;let seed : vec4<f32>=particlesIn.particles[index].seed;let direction : vec3<f32>=particlesIn.particles[index].direction;if (newAge>=life && params.stopFactor != 0.) {var newPosition : vec3<f32>;var newDirection : vec3<f32>;let randoms : vec4<f32>=getRandomVec4(seed.x,vertexID);let outLife : f32=params.lifeTime.x+(params.lifeTime.y-params.lifeTime.x)*randoms.r;particlesOut.particles[index].life=outLife;particlesOut.particles[index].age=newAge-life;particlesOut.particles[index].seed=seed;var sizex : f32;\n#ifdef SIZEGRADIENTS \nsizex=textureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(0.,0.),0.).r;\n#else\nsizex=params.sizeRange.x+(params.sizeRange.y-params.sizeRange.x)*randoms.g;\n#endif\nparticlesOut.particles[index].size=vec3<f32>(\nsizex,\nparams.scaleRange.x+(params.scaleRange.y-params.scaleRange.x)*randoms.b,\nparams.scaleRange.z+(params.scaleRange.w-params.scaleRange.z)*randoms.a);\n#ifndef COLORGRADIENTS\nparticlesOut.particles[index].color=params.color1+(params.color2-params.color1)*randoms.b;\n#endif\n#ifndef ANGULARSPEEDGRADIENTS \nparticlesOut.particles[index].angle=vec2<f32>(\nparams.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r,\nparams.angleRange.x+(params.angleRange.y-params.angleRange.x)*randoms.a);\n#else\nparticlesOut.particles[index].angle=params.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r;\n#endif \n#if defined(POINTEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);newPosition=vec3<f32>(0.,0.,0.);newDirection=params.direction1+(params.direction2-params.direction1)*randoms3;\n#elif defined(BOXEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);newPosition=params.minEmitBox+(params.maxEmitBox-params.minEmitBox)*randoms2;newDirection=params.direction1+(params.direction2-params.direction1)*randoms3; \n#elif defined(HEMISPHERICEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let phi : f32=2.0*PI*randoms2.x;let theta : f32=acos(-1.0+2.0*randoms2.y);let randX : f32=cos(phi)*sin(theta);let randY : f32=cos(theta);let randZ : f32=sin(phi)*sin(theta);newPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,abs(randY),randZ);newDirection=normalize(newPosition+params.directionRandomizer*randoms3);\n#elif defined(SPHEREEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let phi : f32=2.0*PI*randoms2.x;let theta : f32=acos(-1.0+2.0*randoms2.y);let randX : f32=cos(phi)*sin(theta);let randY : f32=cos(theta);let randZ : f32=sin(phi)*sin(theta);newPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,randY,randZ);\n#ifdef DIRECTEDSPHEREEMITTER\nnewDirection=normalize(params.direction1+(params.direction2-params.direction1)*randoms3);\n#else\nnewDirection=normalize(newPosition+params.directionRandomizer*randoms3);\n#endif\n#elif defined(CYLINDEREMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let yPos : f32=(-0.5+randoms2.x)*params.height;var angle : f32=randoms2.y*PI*2.;let inverseRadiusRangeSquared : f32=(1.-params.radiusRange)*(1.-params.radiusRange);let positionRadius : f32=params.radius*sqrt(inverseRadiusRangeSquared+randoms2.z*(1.-inverseRadiusRangeSquared));let xPos : f32=positionRadius*cos(angle);let zPos : f32=positionRadius*sin(angle);newPosition=vec3<f32>(xPos,yPos,zPos);\n#ifdef DIRECTEDCYLINDEREMITTER\nnewDirection=params.direction1+(params.direction2-params.direction1)*randoms3;\n#else\nangle=angle+(-0.5+randoms3.x)*PI*params.directionRandomizer;newDirection=vec3<f32>(cos(angle),(-0.5+randoms3.y)*params.directionRandomizer,sin(angle));newDirection=normalize(newDirection);\n#endif\n#elif defined(CONEEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let s : f32=2.0*PI*randoms2.x;\n#ifdef CONEEMITTERSPAWNPOINT\nlet h : f32=0.0001;\n#else\nvar h : f32=randoms2.y*params.height.y;h=1.-h*h; \n#endif\nvar lRadius : f32=params.radius.x-params.radius.x*randoms2.z*params.radius.y;lRadius=lRadius*h;let randX : f32=lRadius*sin(s);let randZ : f32=lRadius*cos(s);let randY : f32=h *params.height.x;newPosition=vec3<f32>(randX,randY,randZ); \nif (abs(cos(params.coneAngle))==1.0) {newDirection=vec3<f32>(0.,1.0,0.);} else {let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);newDirection=normalize(newPosition+params.directionRandomizer*randoms3); }\n#elif defined(CUSTOMEMITTER)\nnewPosition=particlesIn.particles[index].initialPosition;particlesOut.particles[index].initialPosition=newPosition;\n#else \nnewPosition=vec3<f32>(0.,0.,0.);newDirection=2.0*(getRandomVec3(seed.w,vertexID)-vec3<f32>(0.5,0.5,0.5));\n#endif\nlet power : f32=params.emitPower.x+(params.emitPower.y-params.emitPower.x)*randoms.a;\n#ifdef LOCAL\nparticlesOut.particles[index].position=newPosition;\n#else\nparticlesOut.particles[index].position=(params.emitterWM*vec4<f32>(newPosition,1.)).xyz;\n#endif\n#ifdef CUSTOMEMITTER\nparticlesOut.particles[index].direction=direction;\n#ifndef BILLBOARD \nparticlesOut.particles[index].initialDirection=direction;\n#endif\n#else\n#ifdef LOCAL\nlet initial : vec3<f32>=newDirection;\n#else \nlet initial : vec3<f32>=(params.emitterWM*vec4<f32>(newDirection,0.)).xyz;\n#endif\nparticlesOut.particles[index].direction=initial*power;\n#ifndef BILLBOARD \nparticlesOut.particles[index].initialDirection=initial;\n#endif\n#endif\n#ifdef ANIMATESHEET \nparticlesOut.particles[index].cellIndex=params.cellInfos.x;\n#ifdef ANIMATESHEETRANDOMSTART\nparticlesOut.particles[index].cellStartOffset=randoms.a*outLife;\n#endif \n#endif\n#ifdef NOISE\nparticlesOut.particles[index].noiseCoordinates1=particlesIn.particles[index].noiseCoordinates1;particlesOut.particles[index].noiseCoordinates2=particlesIn.particles[index].noiseCoordinates2;\n#endif\n} else {var directionScale : f32=timeDelta;particlesOut.particles[index].age=newAge;let ageGradient : f32=newAge/life;\n#ifdef VELOCITYGRADIENTS\ndirectionScale=directionScale*textureSampleLevel(velocityGradientTexture,velocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;\n#endif\n#ifdef DRAGGRADIENTS\ndirectionScale=directionScale*(1.0-textureSampleLevel(dragGradientTexture,dragGradientSampler,vec2<f32>(ageGradient,0.),0.).r);\n#endif\nlet position : vec3<f32>=particlesIn.particles[index].position;\n#if defined(CUSTOMEMITTER)\nparticlesOut.particles[index].position=position+(direction-position)*ageGradient; \nparticlesOut.particles[index].initialPosition=particlesIn.particles[index].initialPosition;\n#else\nparticlesOut.particles[index].position=position+direction*directionScale;\n#endif\nparticlesOut.particles[index].life=life;particlesOut.particles[index].seed=seed;\n#ifndef COLORGRADIENTS \nparticlesOut.particles[index].color=particlesIn.particles[index].color;\n#endif\n#ifdef SIZEGRADIENTS\nparticlesOut.particles[index].size=vec3<f32>(\ntextureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(ageGradient,0.),0.).r,\nparticlesIn.particles[index].size.yz);\n#else\nparticlesOut.particles[index].size=particlesIn.particles[index].size;\n#endif \n#ifndef BILLBOARD \nparticlesOut.particles[index].initialDirection=particlesIn.particles[index].initialDirection;\n#endif\n#ifdef CUSTOMEMITTER\nparticlesOut.particles[index].direction=direction;\n#else\nvar updatedDirection : vec3<f32>=direction+params.gravity*timeDelta;\n#ifdef LIMITVELOCITYGRADIENTS\nlet limitVelocity : f32=textureSampleLevel(limitVelocityGradientTexture,limitVelocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;let currentVelocity : f32=length(updatedDirection);if (currentVelocity>limitVelocity) {updatedDirection=updatedDirection*params.limitVelocityDamping;}\n#endif\nparticlesOut.particles[index].direction=updatedDirection;\n#ifdef NOISE\nlet noiseCoordinates1 : vec3<f32>=particlesIn.particles[index].noiseCoordinates1;let noiseCoordinates2 : vec3<f32>=particlesIn.particles[index].noiseCoordinates2;let fetchedR : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.x,noiseCoordinates1.y)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let fetchedG : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.z,noiseCoordinates2.x)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let fetchedB : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates2.y,noiseCoordinates2.z)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let force : vec3<f32>=vec3<f32>(-1.+2.*fetchedR,-1.+2.*fetchedG,-1.+2.*fetchedB)*params.noiseStrength;particlesOut.particles[index].direction=particlesOut.particles[index].direction+force*timeDelta;particlesOut.particles[index].noiseCoordinates1=noiseCoordinates1;particlesOut.particles[index].noiseCoordinates2=noiseCoordinates2;\n#endif \n#endif \n#ifdef ANGULARSPEEDGRADIENTS\nlet angularSpeed : f32=textureSampleLevel(angularSpeedGradientTexture,angularSpeedGradientSampler,vec2<f32>(ageGradient,0.),0.).r;particlesOut.particles[index].angle=particlesIn.particles[index].angle+angularSpeed*timeDelta;\n#else\nlet angle : vec2<f32>=particlesIn.particles[index].angle;particlesOut.particles[index].angle=vec2<f32>(angle.x+angle.y*timeDelta,angle.y);\n#endif\n#ifdef ANIMATESHEET \nvar offsetAge : f32=particlesOut.particles[index].age;let dist : f32=params.cellInfos.y-params.cellInfos.x;\n#ifdef ANIMATESHEETRANDOMSTART\nlet cellStartOffset : f32=particlesIn.particles[index].cellStartOffset;particlesOut.particles[index].cellStartOffset=cellStartOffset;offsetAge=offsetAge+cellStartOffset;\n#else\nlet cellStartOffset : f32=0.;\n#endif \nvar ratio : f32;if (params.cellInfos.w==1.0) {ratio=clamp(((cellStartOffset+params.cellInfos.z*offsetAge) % life)/life,0.,1.0);}\nelse {ratio=clamp((cellStartOffset+params.cellInfos.z*offsetAge)/life,0.,1.0);}\nparticlesOut.particles[index].cellIndex=f32(i32(params.cellInfos.x+ratio*dist));\n#endif\n}}\n",m("BABYLON.ComputeShaderParticleSystem",class{constructor(e,t){this._bufferComputeShader=[],this._renderVertexBuffers=[],this.alignDataInBuffer=!0,this._parent=e,this._engine=t}contextLost(){this._updateComputeShader=void 0,this._bufferComputeShader.length=0,this._renderVertexBuffers.length=0}isUpdateBufferCreated(){return!!this._updateComputeShader}isUpdateBufferReady(){var e,t;return null!==(t=null===(e=this._updateComputeShader)||void 0===e?void 0:e.isReady())&&void 0!==t&&t}createUpdateBuffer(e){var t;const i={params:{group:0,binding:0},particlesIn:{group:0,binding:1},particlesOut:{group:0,binding:2},randomTexture:{group:0,binding:3},randomTexture2:{group:0,binding:4}};return this._parent._sizeGradientsTexture&&(i.sizeGradientTexture={group:1,binding:1}),this._parent._angularSpeedGradientsTexture&&(i.angularSpeedGradientTexture={group:1,binding:3}),this._parent._velocityGradientsTexture&&(i.velocityGradientTexture={group:1,binding:5}),this._parent._limitVelocityGradientsTexture&&(i.limitVelocityGradientTexture={group:1,binding:7}),this._parent._dragGradientsTexture&&(i.dragGradientTexture={group:1,binding:9}),this._parent.noiseTexture&&(i.noiseTexture={group:1,binding:11}),this._updateComputeShader=new vl("updateParticles",this._engine,"gpuUpdateParticles",{bindingsMapping:i,defines:e.split("\n")}),null===(t=this._simParamsComputeShader)||void 0===t||t.dispose(),this._simParamsComputeShader=new ai(this._engine),this._simParamsComputeShader.addUniform("currentCount",1),this._simParamsComputeShader.addUniform("timeDelta",1),this._simParamsComputeShader.addUniform("stopFactor",1),this._simParamsComputeShader.addUniform("randomTextureSize",1),this._simParamsComputeShader.addUniform("lifeTime",2),this._simParamsComputeShader.addUniform("emitPower",2),this._parent._colorGradientsTexture||(this._simParamsComputeShader.addUniform("color1",4),this._simParamsComputeShader.addUniform("color2",4)),this._simParamsComputeShader.addUniform("sizeRange",2),this._simParamsComputeShader.addUniform("scaleRange",4),this._simParamsComputeShader.addUniform("angleRange",4),this._simParamsComputeShader.addUniform("gravity",3),this._parent._limitVelocityGradientsTexture&&this._simParamsComputeShader.addUniform("limitVelocityDamping",1),this._parent.isAnimationSheetEnabled&&this._simParamsComputeShader.addUniform("cellInfos",4),this._parent.noiseTexture&&this._simParamsComputeShader.addUniform("noiseStrength",3),this._parent.isLocal||this._simParamsComputeShader.addUniform("emitterWM",16),this._parent.particleEmitterType&&this._parent.particleEmitterType.buildUniformLayout(this._simParamsComputeShader),this._updateComputeShader.setUniformBuffer("params",this._simParamsComputeShader),new rg(this._simParamsComputeShader)}createVertexBuffers(e,t){this._renderVertexBuffers.push(t)}createParticleBuffer(e){const t=new oo(this._engine,4*e.length,11);return t.update(e),this._bufferComputeShader.push(t),t.getBuffer()}bindDrawBuffers(e,t,i){this._engine.bindBuffers(this._renderVertexBuffers[e],i,t)}preUpdateParticleBuffer(){}updateParticleBuffer(e,t,i){this._simParamsComputeShader.update(),this._updateComputeShader.setTexture("randomTexture",this._parent._randomTexture,!1),this._updateComputeShader.setTexture("randomTexture2",this._parent._randomTexture2,!1),this._parent._sizeGradientsTexture&&this._updateComputeShader.setTexture("sizeGradientTexture",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateComputeShader.setTexture("angularSpeedGradientTexture",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateComputeShader.setTexture("velocityGradientTexture",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateComputeShader.setTexture("limitVelocityGradientTexture",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateComputeShader.setTexture("dragGradientTexture",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateComputeShader.setTexture("noiseTexture",this._parent.noiseTexture),this._updateComputeShader.setStorageBuffer("particlesIn",this._bufferComputeShader[e]),this._updateComputeShader.setStorageBuffer("particlesOut",this._bufferComputeShader[1^e]),this._updateComputeShader.dispatch(Math.ceil(i/64))}releaseBuffers(){var e;for(let e=0;e<this._bufferComputeShader.length;++e)this._bufferComputeShader[e].dispose();this._bufferComputeShader.length=0,null===(e=this._simParamsComputeShader)||void 0===e||e.dispose(),this._simParamsComputeShader=null,this._updateComputeShader=null}releaseVertexBuffers(){this._renderVertexBuffers.length=0}});class ng{constructor(e,t,i){this.gradient=e,this.color1=t,this.color2=i}getColorToRef(e){this.color2?F.LerpToRef(this.color1,this.color2,Math.random(),e):e.copyFrom(this.color1)}}class og{constructor(e,t){this.gradient=e,this.color=t}}class ag{constructor(e,t,i){this.gradient=e,this.factor1=t,this.factor2=i}getFactor(){return void 0===this.factor2||this.factor2===this.factor1?this.factor1:this.factor1+(this.factor2-this.factor1)*Math.random()}}class lg{static GetCurrentGradient(e,t,i){if(t[0].gradient>e)return void i(t[0],t[0],1);for(let s=0;s<t.length-1;s++){const r=t[s],n=t[s+1];if(e>=r.gradient&&e<=n.gradient)return void i(r,n,(e-r.gradient)/(n.gradient-r.gradient))}const s=t.length-1;i(t[s],t[s],1)}}class hg{constructor(e){this.particleSystem=e,this.position=S.Zero(),this.direction=S.Zero(),this.color=new F(0,0,0,0),this.colorStep=new F(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.scale=new E(1,1),this.angle=0,this.angularSpeed=0,this.cellIndex=0,this._attachedSubEmitters=null,this._currentColor1=new F(0,0,0,0),this._currentColor2=new F(0,0,0,0),this._currentSize1=0,this._currentSize2=0,this._currentAngularSpeed1=0,this._currentAngularSpeed2=0,this._currentVelocity1=0,this._currentVelocity2=0,this._currentLimitVelocity1=0,this._currentLimitVelocity2=0,this._currentDrag1=0,this._currentDrag2=0,this.id=hg._Count++,this.particleSystem.isAnimationSheetEnabled&&this._updateCellInfoFromSystem()}_updateCellInfoFromSystem(){this.cellIndex=this.particleSystem.startSpriteCellID}updateCellIndex(){let e=this.age,t=this.particleSystem.spriteCellChangeSpeed;this.particleSystem.spriteRandomStartCell&&(void 0===this._randomCellOffset&&(this._randomCellOffset=Math.random()*this.lifeTime),0===t?(t=1,e=this._randomCellOffset):e+=this._randomCellOffset);const i=this._initialEndSpriteCellID-this._initialStartSpriteCellID;let s;s=this._initialSpriteCellLoop?l.Clamp(e*t%this.lifeTime/this.lifeTime):l.Clamp(e*t/this.lifeTime),this.cellIndex=this._initialStartSpriteCellID+s*i|0}_inheritParticleInfoToSubEmitter(e){if(e.particleSystem.emitter.position){const t=e.particleSystem.emitter;if(t.position.copyFrom(this.position),e.inheritDirection){const e=R.Vector3[0];this.direction.normalizeToRef(e),t.setDirection(e,0,Math.PI/2)}}else e.particleSystem.emitter.copyFrom(this.position);this.direction.scaleToRef(e.inheritedVelocityAmount/2,R.Vector3[0]),e.particleSystem._inheritedVelocityOffset.copyFrom(R.Vector3[0])}_inheritParticleInfoToSubEmitters(){this._attachedSubEmitters&&this._attachedSubEmitters.length>0&&this._attachedSubEmitters.forEach((e=>{this._inheritParticleInfoToSubEmitter(e)}))}_reset(){this.age=0,this.id=hg._Count++,this._currentColorGradient=null,this._currentSizeGradient=null,this._currentAngularSpeedGradient=null,this._currentVelocityGradient=null,this._currentLimitVelocityGradient=null,this._currentDragGradient=null,this.cellIndex=this.particleSystem.startSpriteCellID,this._randomCellOffset=void 0}copyTo(e){e.position.copyFrom(this.position),this._initialDirection?e._initialDirection?e._initialDirection.copyFrom(this._initialDirection):e._initialDirection=this._initialDirection.clone():e._initialDirection=null,e.direction.copyFrom(this.direction),this._localPosition&&(e._localPosition?e._localPosition.copyFrom(this._localPosition):e._localPosition=this._localPosition.clone()),e.color.copyFrom(this.color),e.colorStep.copyFrom(this.colorStep),e.lifeTime=this.lifeTime,e.age=this.age,e._randomCellOffset=this._randomCellOffset,e.size=this.size,e.scale.copyFrom(this.scale),e.angle=this.angle,e.angularSpeed=this.angularSpeed,e.particleSystem=this.particleSystem,e.cellIndex=this.cellIndex,e.id=this.id,e._attachedSubEmitters=this._attachedSubEmitters,this._currentColorGradient&&(e._currentColorGradient=this._currentColorGradient,e._currentColor1.copyFrom(this._currentColor1),e._currentColor2.copyFrom(this._currentColor2)),this._currentSizeGradient&&(e._currentSizeGradient=this._currentSizeGradient,e._currentSize1=this._currentSize1,e._currentSize2=this._currentSize2),this._currentAngularSpeedGradient&&(e._currentAngularSpeedGradient=this._currentAngularSpeedGradient,e._currentAngularSpeed1=this._currentAngularSpeed1,e._currentAngularSpeed2=this._currentAngularSpeed2),this._currentVelocityGradient&&(e._currentVelocityGradient=this._currentVelocityGradient,e._currentVelocity1=this._currentVelocity1,e._currentVelocity2=this._currentVelocity2),this._currentLimitVelocityGradient&&(e._currentLimitVelocityGradient=this._currentLimitVelocityGradient,e._currentLimitVelocity1=this._currentLimitVelocity1,e._currentLimitVelocity2=this._currentLimitVelocity2),this._currentDragGradient&&(e._currentDragGradient=this._currentDragGradient,e._currentDrag1=this._currentDrag1,e._currentDrag2=this._currentDrag2),this.particleSystem.isAnimationSheetEnabled&&(e._initialStartSpriteCellID=this._initialStartSpriteCellID,e._initialEndSpriteCellID=this._initialEndSpriteCellID,e._initialSpriteCellLoop=this._initialSpriteCellLoop),this.particleSystem.useRampGradients&&(e.remapData&&this.remapData?e.remapData.copyFrom(this.remapData):e.remapData=new b(0,0,0,0)),this._randomNoiseCoordinates1&&(e._randomNoiseCoordinates1?(e._randomNoiseCoordinates1.copyFrom(this._randomNoiseCoordinates1),e._randomNoiseCoordinates2.copyFrom(this._randomNoiseCoordinates2)):(e._randomNoiseCoordinates1=this._randomNoiseCoordinates1.clone(),e._randomNoiseCoordinates2=this._randomNoiseCoordinates2.clone()))}}var cg;hg._Count=0,function(e){e[e.ATTACHED=0]="ATTACHED",e[e.END=1]="END"}(cg||(cg={}));class ug{constructor(e){if(this.particleSystem=e,this.type=cg.END,this.inheritDirection=!1,this.inheritedVelocityAmount=0,!e.emitter||!e.emitter.dispose){const t=g("BABYLON.AbstractMesh");e.emitter=new t("SubemitterSystemEmitter",e.getScene()),e._disposeEmitterOnDispose=!0}}clone(){let e=this.particleSystem.emitter;e?e instanceof S?e=e.clone():-1!==e.getClassName().indexOf("Mesh")&&(e=new(g("BABYLON.Mesh"))("",e.getScene()),e.isVisible=!1):e=new S;const t=new ug(this.particleSystem.clone(this.particleSystem.name,e));return t.particleSystem.name+="Clone",t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem._disposeEmitterOnDispose=!0,t.particleSystem.disposeOnStop=!0,t}serialize(e=!1){const t={};return t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem=this.particleSystem.serialize(e),t}static _ParseParticleSystem(e,t,i,s=!1){throw $("ParseParticle")}static Parse(e,t,i){const s=e.particleSystem,r=new ug(ug._ParseParticleSystem(s,t,i,!0));return r.type=e.type,r.inheritDirection=e.inheritDirection,r.inheritedVelocityAmount=e.inheritedVelocityAmount,r.particleSystem._isSubEmitter=!0,r}dispose(){this.particleSystem.dispose()}}nt.ShadersStore.particlesPixelShader="#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nvarying vec2 vUV;varying vec4 vColor;uniform vec4 textureMask;uniform sampler2D diffuseSampler;\n#include<clipPlaneFragmentDeclaration>\n#include<imageProcessingDeclaration>\n#include<logDepthDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n#ifdef RAMPGRADIENT\nvarying vec4 remapRanges;uniform sampler2D rampSampler;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec4 textureColor=texture2D(diffuseSampler,vUV);vec4 baseColor=(textureColor*textureMask+(vec4(1.,1.,1.,1.)-textureMask))*vColor;\n#ifdef RAMPGRADIENT\nfloat alpha=baseColor.a;float remappedColorIndex=clamp((alpha-remapRanges.x)/remapRanges.y,0.0,1.0);vec4 rampColor=texture2D(rampSampler,vec2(1.0-remappedColorIndex,0.));baseColor.rgb*=rampColor.rgb;float finalAlpha=baseColor.a;baseColor.a=clamp((alpha*rampColor.a-remapRanges.z)/remapRanges.w,0.0,1.0);\n#endif\n#ifdef BLENDMULTIPLYMODE\nfloat sourceAlpha=vColor.a*textureColor.a;baseColor.rgb=baseColor.rgb*sourceAlpha+vec3(1.0)*(1.0-sourceAlpha);\n#endif\n#include<logDepthFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\nbaseColor.rgb=toLinearSpace(baseColor.rgb);\n#else\n#ifdef IMAGEPROCESSING\nbaseColor.rgb=toLinearSpace(baseColor.rgb);baseColor=applyImageProcessing(baseColor);\n#endif\n#endif\ngl_FragColor=baseColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";nt.ShadersStore.particlesVertexShader="attribute vec3 position;attribute vec4 color;attribute float angle;attribute vec2 size;\n#ifdef ANIMATESHEET\nattribute float cellIndex;\n#endif\n#ifndef BILLBOARD\nattribute vec3 direction;\n#endif\n#ifdef BILLBOARDSTRETCHED\nattribute vec3 direction;\n#endif\n#ifdef RAMPGRADIENT\nattribute vec4 remapData;\n#endif\nattribute vec2 offset;uniform mat4 view;uniform mat4 projection;uniform vec2 translationPivot;\n#ifdef ANIMATESHEET\nuniform vec3 particlesInfos; \n#endif\nvarying vec2 vUV;varying vec4 vColor;varying vec3 vPositionW;\n#ifdef RAMPGRADIENT\nvarying vec4 remapRanges;\n#endif\n#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)\nuniform mat4 invView;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<logDepthDeclaration>\n#ifdef BILLBOARD\nuniform vec3 eyePosition;\n#endif\nvec3 rotate(vec3 yaxis,vec3 rotatedCorner) {vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));vec3 zaxis=normalize(cross(yaxis,xaxis));vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;return position+alignedCorner;}\n#ifdef BILLBOARDSTRETCHED\nvec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {vec3 normalizedToCamera=normalize(toCamera);vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);\n#ifdef BILLBOARDSTRETCHED_LOCAL\nvec3 row1=direction;\n#else\nvec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);\n#endif\nmat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;return position+alignedCorner;}\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec2 cornerPos;cornerPos=(vec2(offset.x-0.5,offset.y -0.5)-translationPivot)*size;\n#ifdef BILLBOARD\nvec3 rotatedCorner;\n#ifdef BILLBOARDY\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=position-eyePosition;yaxis.y=0.;vPositionW=rotate(normalize(yaxis),rotatedCorner);vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;\n#elif defined(BILLBOARDSTRETCHED)\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 toCamera=position-eyePosition;vPositionW=rotateAlign(toCamera,rotatedCorner);vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;\n#else\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 viewPos=(view*vec4(position,1.0)).xyz+rotatedCorner;vPositionW=(invView*vec4(viewPos,1)).xyz;\n#endif\n#ifdef RAMPGRADIENT\nremapRanges=remapData;\n#endif\ngl_Position=projection*vec4(viewPos,1.0);\n#else\nvec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=normalize(direction);vPositionW=rotate(yaxis,rotatedCorner);gl_Position=projection*view*vec4(vPositionW,1.0);\n#endif\nvColor=color;\n#ifdef ANIMATESHEET\nfloat rowOffset=floor(cellIndex*particlesInfos.z);float columnOffset=cellIndex-rowOffset/particlesInfos.z;vec2 uvScale=particlesInfos.xy;vec2 uvOffset=vec2(offset.x ,1.0-offset.y);vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;\n#else\nvUV=offset;\n#endif\n#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nvec4 worldPos=vec4(vPositionW,1.0);\n#endif\n#include<clipPlaneVertex>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";class dg extends Rn{set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get useRampGradients(){return this._useRampGradients}set useRampGradients(e){this._useRampGradients!==e&&(this._useRampGradients=e,this._resetEffect())}get particles(){return this._particles}getActiveCount(){return this._particles.length}getClassName(){return"ParticleSystem"}isStopping(){return this._stopped&&this.isAlive()}getCustomEffect(e=0){var t,i;return null!==(i=null===(t=this._customWrappers[e])||void 0===t?void 0:t.effect)&&void 0!==i?i:this._customWrappers[0].effect}_getCustomDrawWrapper(e=0){var t;return null!==(t=this._customWrappers[e])&&void 0!==t?t:this._customWrappers[0]}setCustomEffect(e,t=0){this._customWrappers[t]=new Tt(this._engine),this._customWrappers[t].effect=e,this._customWrappers[t].drawContext&&(this._customWrappers[t].drawContext.useInstancing=this._useInstancing)}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new a),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"particles"}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}constructor(e,t,i,s=null,r=!1,n=.01){super(e),this._emitterInverseWorldMatrix=y.Identity(),this._inheritedVelocityOffset=new S,this.onDisposeObservable=new a,this.onStoppedObservable=new a,this._particles=new Array,this._stockParticles=new Array,this._newPartsExcess=0,this._vertexBuffers={},this._scaledColorStep=new F(0,0,0,0),this._colorDiff=new F(0,0,0,0),this._scaledDirection=S.Zero(),this._scaledGravity=S.Zero(),this._currentRenderId=-1,this._useInstancing=!1,this._started=!1,this._stopped=!1,this._actualFrame=0,this._currentEmitRate1=0,this._currentEmitRate2=0,this._currentStartSize1=0,this._currentStartSize2=0,this.updateInAnimate=!0,this._rawTextureWidth=256,this._useRampGradients=!1,this._disposeEmitterOnDispose=!1,this.isLocal=!1,this.isGPU=!1,this._onBeforeDrawParticlesObservable=null,this.recycleParticle=e=>{const t=this._particles.pop();t!==e&&t.copyTo(e),this._stockParticles.push(t)},this._createParticle=()=>{let e;if(0!==this._stockParticles.length?(e=this._stockParticles.pop(),e._reset()):e=new hg(this),this._subEmitters&&this._subEmitters.length>0){const t=this._subEmitters[Math.floor(Math.random()*this._subEmitters.length)];e._attachedSubEmitters=[],t.forEach((t=>{if(t.type===cg.ATTACHED){const i=t.clone();e._attachedSubEmitters.push(i),i.particleSystem.start()}}))}return e},this._emitFromParticle=e=>{if(!this._subEmitters||0===this._subEmitters.length)return;const t=Math.floor(Math.random()*this._subEmitters.length);this._subEmitters[t].forEach((t=>{if(t.type===cg.END){const i=t.clone();e._inheritParticleInfoToSubEmitter(i),i.particleSystem._rootParticleSystem=this,this.activeSubSystems.push(i.particleSystem),i.particleSystem.start()}}))},this._capacity=t,this._epsilon=n,this._isAnimationSheetEnabled=r,i&&"Scene"!==i.getClassName()?(this._engine=i,this.defaultProjectionMatrix=y.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)):(this._scene=i||x.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)),this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._attachImageProcessingConfiguration(null),this._customWrappers={0:new Tt(this._engine)},this._customWrappers[0].effect=s,this._drawWrappers=[],this._useInstancing=this._engine.getCaps().instancedArrays,this._createIndexBuffer(),this._createVertexBuffers(),this.particleEmitterType=new gn;let o=null;this.updateFunction=e=>{var t;let i=null;this.noiseTexture&&(i=this.noiseTexture.getSize(),null===(t=this.noiseTexture.getContent())||void 0===t||t.then((e=>{o=e})));const s=e===this._particles;for(let t=0;t<e.length;t++){const r=e[t];let n=this._scaledUpdateSpeed;const a=r.age;if(r.age+=n,r.age>r.lifeTime){const e=r.age-a;n=(r.lifeTime-a)*n/e,r.age=r.lifeTime}const h=r.age/r.lifeTime;this._colorGradients&&this._colorGradients.length>0?lg.GetCurrentGradient(h,this._colorGradients,((e,t,i)=>{e!==r._currentColorGradient&&(r._currentColor1.copyFrom(r._currentColor2),t.getColorToRef(r._currentColor2),r._currentColorGradient=e),F.LerpToRef(r._currentColor1,r._currentColor2,i,r.color)})):(r.colorStep.scaleToRef(n,this._scaledColorStep),r.color.addInPlace(this._scaledColorStep),r.color.a<0&&(r.color.a=0)),this._angularSpeedGradients&&this._angularSpeedGradients.length>0&&lg.GetCurrentGradient(h,this._angularSpeedGradients,((e,t,i)=>{e!==r._currentAngularSpeedGradient&&(r._currentAngularSpeed1=r._currentAngularSpeed2,r._currentAngularSpeed2=t.getFactor(),r._currentAngularSpeedGradient=e),r.angularSpeed=l.Lerp(r._currentAngularSpeed1,r._currentAngularSpeed2,i)})),r.angle+=r.angularSpeed*n;let c=n;if(this._velocityGradients&&this._velocityGradients.length>0&&lg.GetCurrentGradient(h,this._velocityGradients,((e,t,i)=>{e!==r._currentVelocityGradient&&(r._currentVelocity1=r._currentVelocity2,r._currentVelocity2=t.getFactor(),r._currentVelocityGradient=e),c*=l.Lerp(r._currentVelocity1,r._currentVelocity2,i)})),r.direction.scaleToRef(c,this._scaledDirection),this._limitVelocityGradients&&this._limitVelocityGradients.length>0&&lg.GetCurrentGradient(h,this._limitVelocityGradients,((e,t,i)=>{e!==r._currentLimitVelocityGradient&&(r._currentLimitVelocity1=r._currentLimitVelocity2,r._currentLimitVelocity2=t.getFactor(),r._currentLimitVelocityGradient=e);const s=l.Lerp(r._currentLimitVelocity1,r._currentLimitVelocity2,i);r.direction.length()>s&&r.direction.scaleInPlace(this.limitVelocityDamping)})),this._dragGradients&&this._dragGradients.length>0&&lg.GetCurrentGradient(h,this._dragGradients,((e,t,i)=>{e!==r._currentDragGradient&&(r._currentDrag1=r._currentDrag2,r._currentDrag2=t.getFactor(),r._currentDragGradient=e);const s=l.Lerp(r._currentDrag1,r._currentDrag2,i);this._scaledDirection.scaleInPlace(1-s)})),this.isLocal&&r._localPosition?(r._localPosition.addInPlace(this._scaledDirection),S.TransformCoordinatesToRef(r._localPosition,this._emitterWorldMatrix,r.position)):r.position.addInPlace(this._scaledDirection),o&&i&&r._randomNoiseCoordinates1){const e=this._fetchR(r._randomNoiseCoordinates1.x,r._randomNoiseCoordinates1.y,i.width,i.height,o),t=this._fetchR(r._randomNoiseCoordinates1.z,r._randomNoiseCoordinates2.x,i.width,i.height,o),s=this._fetchR(r._randomNoiseCoordinates2.y,r._randomNoiseCoordinates2.z,i.width,i.height,o),a=R.Vector3[0],l=R.Vector3[1];a.copyFromFloats((2*e-1)*this.noiseStrength.x,(2*t-1)*this.noiseStrength.y,(2*s-1)*this.noiseStrength.z),a.scaleToRef(n,l),r.direction.addInPlace(l)}this.gravity.scaleToRef(n,this._scaledGravity),r.direction.addInPlace(this._scaledGravity),this._sizeGradients&&this._sizeGradients.length>0&&lg.GetCurrentGradient(h,this._sizeGradients,((e,t,i)=>{e!==r._currentSizeGradient&&(r._currentSize1=r._currentSize2,r._currentSize2=t.getFactor(),r._currentSizeGradient=e),r.size=l.Lerp(r._currentSize1,r._currentSize2,i)})),this._useRampGradients&&(this._colorRemapGradients&&this._colorRemapGradients.length>0&&lg.GetCurrentGradient(h,this._colorRemapGradients,((e,t,i)=>{const s=l.Lerp(e.factor1,t.factor1,i),n=l.Lerp(e.factor2,t.factor2,i);r.remapData.x=s,r.remapData.y=n-s})),this._alphaRemapGradients&&this._alphaRemapGradients.length>0&&lg.GetCurrentGradient(h,this._alphaRemapGradients,((e,t,i)=>{const s=l.Lerp(e.factor1,t.factor1,i),n=l.Lerp(e.factor2,t.factor2,i);r.remapData.z=s,r.remapData.w=n-s}))),this._isAnimationSheetEnabled&&r.updateCellIndex(),r._inheritParticleInfoToSubEmitters(),r.age>=r.lifeTime&&(this._emitFromParticle(r),r._attachedSubEmitters&&(r._attachedSubEmitters.forEach((e=>{e.particleSystem.disposeOnStop=!0,e.particleSystem.stop()})),r._attachedSubEmitters=null),this.recycleParticle(r),s&&t--)}}}_addFactorGradient(e,t,i,s){const r=new ag(t,i,s);e.push(r),e.sort(((e,t)=>e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0))}_removeFactorGradient(e,t){if(!e)return;let i=0;for(const s of e){if(s.gradient===t){e.splice(i,1);break}i++}}addLifeTimeGradient(e,t,i){return this._lifeTimeGradients||(this._lifeTimeGradients=[]),this._addFactorGradient(this._lifeTimeGradients,e,t,i),this}removeLifeTimeGradient(e){return this._removeFactorGradient(this._lifeTimeGradients,e),this}addSizeGradient(e,t,i){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,t,i),this}removeSizeGradient(e){return this._removeFactorGradient(this._sizeGradients,e),this}addColorRemapGradient(e,t,i){return this._colorRemapGradients||(this._colorRemapGradients=[]),this._addFactorGradient(this._colorRemapGradients,e,t,i),this}removeColorRemapGradient(e){return this._removeFactorGradient(this._colorRemapGradients,e),this}addAlphaRemapGradient(e,t,i){return this._alphaRemapGradients||(this._alphaRemapGradients=[]),this._addFactorGradient(this._alphaRemapGradients,e,t,i),this}removeAlphaRemapGradient(e){return this._removeFactorGradient(this._alphaRemapGradients,e),this}addAngularSpeedGradient(e,t,i){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,t,i),this}removeAngularSpeedGradient(e){return this._removeFactorGradient(this._angularSpeedGradients,e),this}addVelocityGradient(e,t,i){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,t,i),this}removeVelocityGradient(e){return this._removeFactorGradient(this._velocityGradients,e),this}addLimitVelocityGradient(e,t,i){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,t,i),this}removeLimitVelocityGradient(e){return this._removeFactorGradient(this._limitVelocityGradients,e),this}addDragGradient(e,t,i){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,t,i),this}removeDragGradient(e){return this._removeFactorGradient(this._dragGradients,e),this}addEmitRateGradient(e,t,i){return this._emitRateGradients||(this._emitRateGradients=[]),this._addFactorGradient(this._emitRateGradients,e,t,i),this}removeEmitRateGradient(e){return this._removeFactorGradient(this._emitRateGradients,e),this}addStartSizeGradient(e,t,i){return this._startSizeGradients||(this._startSizeGradients=[]),this._addFactorGradient(this._startSizeGradients,e,t,i),this}removeStartSizeGradient(e){return this._removeFactorGradient(this._startSizeGradients,e),this}_createRampGradientTexture(){if(!this._rampGradients||!this._rampGradients.length||this._rampGradientsTexture||!this._scene)return;const e=new Uint8Array(4*this._rawTextureWidth),t=w.Color3[0];for(let i=0;i<this._rawTextureWidth;i++){const s=i/this._rawTextureWidth;lg.GetCurrentGradient(s,this._rampGradients,((s,r,n)=>{N.LerpToRef(s.color,r.color,n,t),e[4*i]=255*t.r,e[4*i+1]=255*t.g,e[4*i+2]=255*t.b,e[4*i+3]=255}))}this._rampGradientsTexture=Mr.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1)}getRampGradients(){return this._rampGradients}forceRefreshGradients(){this._syncRampGradientTexture()}_syncRampGradientTexture(){this._rampGradients&&(this._rampGradients.sort(((e,t)=>e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0)),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._createRampGradientTexture())}addRampGradient(e,t){this._rampGradients||(this._rampGradients=[]);const i=new og(e,t);return this._rampGradients.push(i),this._syncRampGradientTexture(),this}removeRampGradient(e){return this._removeGradientAndTexture(e,this._rampGradients,this._rampGradientsTexture),this._rampGradientsTexture=null,this._rampGradients&&this._rampGradients.length>0&&this._createRampGradientTexture(),this}addColorGradient(e,t,i){this._colorGradients||(this._colorGradients=[]);const s=new ng(e,t,i);return this._colorGradients.push(s),this._colorGradients.sort(((e,t)=>e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0)),this}removeColorGradient(e){if(!this._colorGradients)return this;let t=0;for(const i of this._colorGradients){if(i.gradient===e){this._colorGradients.splice(t,1);break}t++}return this}resetDrawCache(){for(const e of this._drawWrappers)if(e)for(const t of e)null==t||t.dispose();this._drawWrappers=[]}_fetchR(e,t,i,s,r){return r[4*(((e=.5*Math.abs(e)+.5)*i%i|0)+((t=.5*Math.abs(t)+.5)*s%s|0)*i)]/255}_reset(){this._resetEffect()}_resetEffect(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this._createVertexBuffers()}_createVertexBuffers(){this._vertexBufferSize=this._useInstancing?10:12,this._isAnimationSheetEnabled&&(this._vertexBufferSize+=1),this._isBillboardBased&&this.billboardMode!==dg.BILLBOARDMODE_STRETCHED&&this.billboardMode!==dg.BILLBOARDMODE_STRETCHED_LOCAL||(this._vertexBufferSize+=3),this._useRampGradients&&(this._vertexBufferSize+=4);const e=this._engine,t=this._vertexBufferSize*(this._useInstancing?1:4);this._vertexData=new Float32Array(this._capacity*t),this._vertexBuffer=new li(e,this._vertexData,!0,t);let i=0;const s=this._vertexBuffer.createVertexBuffer(hi.PositionKind,i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[hi.PositionKind]=s,i+=3;const r=this._vertexBuffer.createVertexBuffer(hi.ColorKind,i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[hi.ColorKind]=r,i+=4;const n=this._vertexBuffer.createVertexBuffer("angle",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.angle=n,i+=1;const o=this._vertexBuffer.createVertexBuffer("size",i,2,this._vertexBufferSize,this._useInstancing);if(this._vertexBuffers.size=o,i+=2,this._isAnimationSheetEnabled){const e=this._vertexBuffer.createVertexBuffer("cellIndex",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.cellIndex=e,i+=1}if(!this._isBillboardBased||this.billboardMode===dg.BILLBOARDMODE_STRETCHED||this.billboardMode===dg.BILLBOARDMODE_STRETCHED_LOCAL){const e=this._vertexBuffer.createVertexBuffer("direction",i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.direction=e,i+=3}if(this._useRampGradients){const e=this._vertexBuffer.createVertexBuffer("remapData",i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.remapData=e,i+=4}let a;if(this._useInstancing){const t=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new li(e,t,!1,2),a=this._spriteBuffer.createVertexBuffer("offset",0,2)}else a=this._vertexBuffer.createVertexBuffer("offset",i,2,this._vertexBufferSize,this._useInstancing),i+=2;this._vertexBuffers.offset=a,this.resetDrawCache()}_createIndexBuffer(){if(this._useInstancing)return void(this._linesIndexBufferUseInstancing=this._engine.createIndexBuffer(new Uint32Array([0,1,1,3,3,2,2,0,0,3])));const e=[],t=[];let i=0;for(let s=0;s<this._capacity;s++)e.push(i),e.push(i+1),e.push(i+2),e.push(i),e.push(i+2),e.push(i+3),t.push(i,i+1,i+1,i+2,i+2,i+3,i+3,i,i,i+3),i+=4;this._indexBuffer=this._engine.createIndexBuffer(e),this._linesIndexBuffer=this._engine.createIndexBuffer(t)}getCapacity(){return this._capacity}isAlive(){return this._alive}isStarted(){return this._started}_prepareSubEmitterInternalArray(){this._subEmitters=new Array,this.subEmitters&&this.subEmitters.forEach((e=>{e instanceof dg?this._subEmitters.push([new ug(e)]):e instanceof ug?this._subEmitters.push([e]):e instanceof Array&&this._subEmitters.push(e)}))}start(e=this.startDelay){var t;if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e)setTimeout((()=>{this.start(0)}),e);else{if(this._prepareSubEmitterInternalArray(),this._started=!0,this._stopped=!1,this._actualFrame=0,this._subEmitters&&0!=this._subEmitters.length&&(this.activeSubSystems=[]),this._emitRateGradients&&(this._emitRateGradients.length>0&&(this._currentEmitRateGradient=this._emitRateGradients[0],this._currentEmitRate1=this._currentEmitRateGradient.getFactor(),this._currentEmitRate2=this._currentEmitRate1),this._emitRateGradients.length>1&&(this._currentEmitRate2=this._emitRateGradients[1].getFactor())),this._startSizeGradients&&(this._startSizeGradients.length>0&&(this._currentStartSizeGradient=this._startSizeGradients[0],this._currentStartSize1=this._currentStartSizeGradient.getFactor(),this._currentStartSize2=this._currentStartSize1),this._startSizeGradients.length>1&&(this._currentStartSize2=this._startSizeGradients[1].getFactor())),this.preWarmCycles){-1!==(null===(t=this.emitter)||void 0===t?void 0:t.getClassName().indexOf("Mesh"))&&this.emitter.computeWorldMatrix(!0);const e=this.noiseTexture;if(e&&e.onGeneratedObservable)e.onGeneratedObservable.addOnce((()=>{setTimeout((()=>{for(let t=0;t<this.preWarmCycles;t++)this.animate(!0),e.render()}))}));else for(let e=0;e<this.preWarmCycles;e++)this.animate(!0)}this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)}}stop(e=!0){this._stopped||(this.onStoppedObservable.notifyObservers(this),this._stopped=!0,e&&this._stopSubEmitters())}reset(){this._stockParticles.length=0,this._particles.length=0}_appendParticleVertex(e,t,i,s){let r=e*this._vertexBufferSize;if(this._vertexData[r++]=t.position.x+this.worldOffset.x,this._vertexData[r++]=t.position.y+this.worldOffset.y,this._vertexData[r++]=t.position.z+this.worldOffset.z,this._vertexData[r++]=t.color.r,this._vertexData[r++]=t.color.g,this._vertexData[r++]=t.color.b,this._vertexData[r++]=t.color.a,this._vertexData[r++]=t.angle,this._vertexData[r++]=t.scale.x*t.size,this._vertexData[r++]=t.scale.y*t.size,this._isAnimationSheetEnabled&&(this._vertexData[r++]=t.cellIndex),this._isBillboardBased)this.billboardMode!==dg.BILLBOARDMODE_STRETCHED&&this.billboardMode!==dg.BILLBOARDMODE_STRETCHED_LOCAL||(this._vertexData[r++]=t.direction.x,this._vertexData[r++]=t.direction.y,this._vertexData[r++]=t.direction.z);else if(t._initialDirection){let e=t._initialDirection;this.isLocal&&(S.TransformNormalToRef(e,this._emitterWorldMatrix,R.Vector3[0]),e=R.Vector3[0]),0===e.x&&0===e.z&&(e.x=.001),this._vertexData[r++]=e.x,this._vertexData[r++]=e.y,this._vertexData[r++]=e.z}else{let e=t.direction;this.isLocal&&(S.TransformNormalToRef(e,this._emitterWorldMatrix,R.Vector3[0]),e=R.Vector3[0]),0===e.x&&0===e.z&&(e.x=.001),this._vertexData[r++]=e.x,this._vertexData[r++]=e.y,this._vertexData[r++]=e.z}this._useRampGradients&&t.remapData&&(this._vertexData[r++]=t.remapData.x,this._vertexData[r++]=t.remapData.y,this._vertexData[r++]=t.remapData.z,this._vertexData[r++]=t.remapData.w),this._useInstancing||(this._isAnimationSheetEnabled&&(0===i?i=this._epsilon:1===i&&(i=1-this._epsilon),0===s?s=this._epsilon:1===s&&(s=1-this._epsilon)),this._vertexData[r++]=i,this._vertexData[r++]=s)}_stopSubEmitters(){this.activeSubSystems&&(this.activeSubSystems.forEach((e=>{e.stop(!0)})),this.activeSubSystems=[])}_removeFromRoot(){if(!this._rootParticleSystem)return;const e=this._rootParticleSystem.activeSubSystems.indexOf(this);-1!==e&&this._rootParticleSystem.activeSubSystems.splice(e,1),this._rootParticleSystem=null}_update(e){if(this._alive=this._particles.length>0,this.emitter.position){const e=this.emitter;this._emitterWorldMatrix=e.getWorldMatrix()}else{const e=this.emitter;this._emitterWorldMatrix=y.Translation(e.x,e.y,e.z)}let t;this._emitterWorldMatrix.invertToRef(this._emitterInverseWorldMatrix),this.updateFunction(this._particles);for(let i=0;i<e&&this._particles.length!==this._capacity;i++){if(t=this._createParticle(),this._particles.push(t),this.targetStopDuration&&this._lifeTimeGradients&&this._lifeTimeGradients.length>0){const e=l.Clamp(this._actualFrame/this.targetStopDuration);lg.GetCurrentGradient(e,this._lifeTimeGradients,((i,s)=>{const r=i,n=s,o=r.getFactor(),a=n.getFactor(),h=(e-r.gradient)/(n.gradient-r.gradient);t.lifeTime=l.Lerp(o,a,h)}))}else t.lifeTime=l.RandomRange(this.minLifeTime,this.maxLifeTime);const e=l.RandomRange(this.minEmitPower,this.maxEmitPower);if(this.startPositionFunction?this.startPositionFunction(this._emitterWorldMatrix,t.position,t,this.isLocal):this.particleEmitterType.startPositionFunction(this._emitterWorldMatrix,t.position,t,this.isLocal),this.isLocal&&(t._localPosition?t._localPosition.copyFrom(t.position):t._localPosition=t.position.clone(),S.TransformCoordinatesToRef(t._localPosition,this._emitterWorldMatrix,t.position)),this.startDirectionFunction?this.startDirectionFunction(this._emitterWorldMatrix,t.direction,t,this.isLocal):this.particleEmitterType.startDirectionFunction(this._emitterWorldMatrix,t.direction,t,this.isLocal,this._emitterInverseWorldMatrix),0===e?t._initialDirection?t._initialDirection.copyFrom(t.direction):t._initialDirection=t.direction.clone():t._initialDirection=null,t.direction.scaleInPlace(e),this._sizeGradients&&0!==this._sizeGradients.length?(t._currentSizeGradient=this._sizeGradients[0],t._currentSize1=t._currentSizeGradient.getFactor(),t.size=t._currentSize1,this._sizeGradients.length>1?t._currentSize2=this._sizeGradients[1].getFactor():t._currentSize2=t._currentSize1):t.size=l.RandomRange(this.minSize,this.maxSize),t.scale.copyFromFloats(l.RandomRange(this.minScaleX,this.maxScaleX),l.RandomRange(this.minScaleY,this.maxScaleY)),this._startSizeGradients&&this._startSizeGradients[0]&&this.targetStopDuration){const e=this._actualFrame/this.targetStopDuration;lg.GetCurrentGradient(e,this._startSizeGradients,((e,i,s)=>{e!==this._currentStartSizeGradient&&(this._currentStartSize1=this._currentStartSize2,this._currentStartSize2=i.getFactor(),this._currentStartSizeGradient=e);const r=l.Lerp(this._currentStartSize1,this._currentStartSize2,s);t.scale.scaleInPlace(r)}))}if(this._angularSpeedGradients&&0!==this._angularSpeedGradients.length?(t._currentAngularSpeedGradient=this._angularSpeedGradients[0],t.angularSpeed=t._currentAngularSpeedGradient.getFactor(),t._currentAngularSpeed1=t.angularSpeed,this._angularSpeedGradients.length>1?t._currentAngularSpeed2=this._angularSpeedGradients[1].getFactor():t._currentAngularSpeed2=t._currentAngularSpeed1):t.angularSpeed=l.RandomRange(this.minAngularSpeed,this.maxAngularSpeed),t.angle=l.RandomRange(this.minInitialRotation,this.maxInitialRotation),this._velocityGradients&&this._velocityGradients.length>0&&(t._currentVelocityGradient=this._velocityGradients[0],t._currentVelocity1=t._currentVelocityGradient.getFactor(),this._velocityGradients.length>1?t._currentVelocity2=this._velocityGradients[1].getFactor():t._currentVelocity2=t._currentVelocity1),this._limitVelocityGradients&&this._limitVelocityGradients.length>0&&(t._currentLimitVelocityGradient=this._limitVelocityGradients[0],t._currentLimitVelocity1=t._currentLimitVelocityGradient.getFactor(),this._limitVelocityGradients.length>1?t._currentLimitVelocity2=this._limitVelocityGradients[1].getFactor():t._currentLimitVelocity2=t._currentLimitVelocity1),this._dragGradients&&this._dragGradients.length>0&&(t._currentDragGradient=this._dragGradients[0],t._currentDrag1=t._currentDragGradient.getFactor(),this._dragGradients.length>1?t._currentDrag2=this._dragGradients[1].getFactor():t._currentDrag2=t._currentDrag1),this._colorGradients&&0!==this._colorGradients.length)t._currentColorGradient=this._colorGradients[0],t._currentColorGradient.getColorToRef(t.color),t._currentColor1.copyFrom(t.color),this._colorGradients.length>1?this._colorGradients[1].getColorToRef(t._currentColor2):t._currentColor2.copyFrom(t.color);else{const e=l.RandomRange(0,1);F.LerpToRef(this.color1,this.color2,e,t.color),this.colorDead.subtractToRef(t.color,this._colorDiff),this._colorDiff.scaleToRef(1/t.lifeTime,t.colorStep)}this._isAnimationSheetEnabled&&(t._initialStartSpriteCellID=this.startSpriteCellID,t._initialEndSpriteCellID=this.endSpriteCellID,t._initialSpriteCellLoop=this.spriteCellLoop),t.direction.addInPlace(this._inheritedVelocityOffset),this._useRampGradients&&(t.remapData=new b(0,1,0,1)),this.noiseTexture&&(t._randomNoiseCoordinates1?(t._randomNoiseCoordinates1.copyFromFloats(Math.random(),Math.random(),Math.random()),t._randomNoiseCoordinates2.copyFromFloats(Math.random(),Math.random(),Math.random())):(t._randomNoiseCoordinates1=new S(Math.random(),Math.random(),Math.random()),t._randomNoiseCoordinates2=new S(Math.random(),Math.random(),Math.random()))),t._inheritParticleInfoToSubEmitters()}}static _GetAttributeNamesOrOptions(e=!1,t=!1,i=!1){const s=[hi.PositionKind,hi.ColorKind,"angle","offset","size"];return e&&s.push("cellIndex"),t||s.push("direction"),i&&s.push("remapData"),s}static _GetEffectCreationOptions(e=!1,t=!1){const i=["invView","view","projection","textureMask","translationPivot","eyePosition"];return ks(i),e&&i.push("particlesInfos"),t&&i.push("logarithmicDepthConstant"),i}fillDefines(e,t){if(this._scene&&Gs(this,this._scene,e),this._isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),this.useLogarithmicDepth&&e.push("#define LOGARITHMICDEPTH"),t===dg.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this._useRampGradients&&e.push("#define RAMPGRADIENT"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case dg.BILLBOARDMODE_Y:e.push("#define BILLBOARDY");break;case dg.BILLBOARDMODE_STRETCHED:case dg.BILLBOARDMODE_STRETCHED_LOCAL:e.push("#define BILLBOARDSTRETCHED"),this.billboardMode===dg.BILLBOARDMODE_STRETCHED_LOCAL&&e.push("#define BILLBOARDSTRETCHED_LOCAL");break;case dg.BILLBOARDMODE_ALL:e.push("#define BILLBOARDMODE_ALL")}this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(e,t,i){t.push(...dg._GetAttributeNamesOrOptions(this._isAnimationSheetEnabled,this._isBillboardBased&&this.billboardMode!==dg.BILLBOARDMODE_STRETCHED&&this.billboardMode!==dg.BILLBOARDMODE_STRETCHED_LOCAL,this._useRampGradients)),e.push(...dg._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth)),i.push("diffuseSampler","rampSampler"),this._imageProcessingConfiguration&&(Zt.PrepareUniforms(e,this._imageProcessingConfigurationDefines),Zt.PrepareSamplers(i,this._imageProcessingConfigurationDefines))}_getWrapper(e){const t=this._getCustomDrawWrapper(e);if(null==t?void 0:t.effect)return t;const i=[];this.fillDefines(i,e);const s=this._engine._features.supportRenderPasses?this._engine.currentRenderPassId:0;let r=this._drawWrappers[s];r||(r=this._drawWrappers[s]=[]);let n=r[e];n||(n=new Tt(this._engine),n.drawContext&&(n.drawContext.useInstancing=this._useInstancing),r[e]=n);const o=i.join("\n");if(n.defines!==o){const e=[],t=[],i=[];this.fillUniformsAttributesAndSamplerNames(t,e,i),n.setEffect(this._engine.createEffect("particles",e,t,i,o),o)}return n}animate(e=!1){var t;if(!this._started)return;if(!e&&this._scene){if(!this.isReady())return;if(this._currentRenderId===this._scene.getFrameId())return;this._currentRenderId=this._scene.getFrameId()}let i;if(this._scaledUpdateSpeed=this.updateSpeed*(e?this.preWarmStepOffset:(null===(t=this._scene)||void 0===t?void 0:t.getAnimationRatio())||1),this.manualEmitCount>-1)i=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0;else{let e=this.emitRate;if(this._emitRateGradients&&this._emitRateGradients.length>0&&this.targetStopDuration){const t=this._actualFrame/this.targetStopDuration;lg.GetCurrentGradient(t,this._emitRateGradients,((t,i,s)=>{t!==this._currentEmitRateGradient&&(this._currentEmitRate1=this._currentEmitRate2,this._currentEmitRate2=i.getFactor(),this._currentEmitRateGradient=t),e=l.Lerp(this._currentEmitRate1,this._currentEmitRate2,s)}))}i=e*this._scaledUpdateSpeed|0,this._newPartsExcess+=e*this._scaledUpdateSpeed-i}if(this._newPartsExcess>1&&(i+=0|this._newPartsExcess,this._newPartsExcess-=0|this._newPartsExcess),this._alive=!1,this._stopped?i=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(i),this._stopped&&(this._alive||(this._started=!1,this.onAnimationEnd&&this.onAnimationEnd(),this.disposeOnStop&&this._scene&&this._scene._toBeDisposed.push(this))),!e){let e=0;for(let t=0;t<this._particles.length;t++){const i=this._particles[t];this._appendParticleVertices(e,i),e+=this._useInstancing?1:4}this._vertexBuffer&&this._vertexBuffer.updateDirectly(this._vertexData,0,this._particles.length)}0===this.manualEmitCount&&this.disposeOnStop&&this.stop()}_appendParticleVertices(e,t){this._appendParticleVertex(e++,t,0,0),this._useInstancing||(this._appendParticleVertex(e++,t,1,0),this._appendParticleVertex(e++,t,1,1),this._appendParticleVertex(e++,t,0,1))}rebuild(){var e,t;this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._createIndexBuffer(),null===(e=this._spriteBuffer)||void 0===e||e._rebuild(),null===(t=this._vertexBuffer)||void 0===t||t._rebuild();for(const e in this._vertexBuffers)this._vertexBuffers[e]._rebuild();this.resetDrawCache()}isReady(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==dg.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else{if(!this._getWrapper(dg.BLENDMODE_MULTIPLY).effect.isReady())return!1;if(!this._getWrapper(dg.BLENDMODE_ADD).effect.isReady())return!1}return!0}_render(e){var t,i,s,r,n,o,a,l;const h=this._getWrapper(e),c=h.effect,u=this._engine;u.enableEffect(h);const d=null!==(t=this.defaultViewMatrix)&&void 0!==t?t:this._scene.getViewMatrix();if(c.setTexture("diffuseSampler",this.particleTexture),c.setMatrix("view",d),c.setMatrix("projection",null!==(i=this.defaultProjectionMatrix)&&void 0!==i?i:this._scene.getProjectionMatrix()),this._isAnimationSheetEnabled&&this.particleTexture){const e=this.particleTexture.getBaseSize();c.setFloat3("particlesInfos",this.spriteCellWidth/e.width,this.spriteCellHeight/e.height,this.spriteCellWidth/e.width)}if(c.setVector2("translationPivot",this.translationPivot),c.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._isBillboardBased&&this._scene){const e=this._scene.activeCamera;c.setVector3("eyePosition",e.globalPosition)}this._rampGradientsTexture&&(this._rampGradients&&this._rampGradients.length||(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),c.setTexture("rampSampler",this._rampGradientsTexture));const p=c.defines;switch(this._scene&&zs(c,this,this._scene),p.indexOf("#define BILLBOARDMODE_ALL")>=0&&(d.invertToRef(R.Matrix[0]),c.setMatrix("invView",R.Matrix[0])),void 0!==this._vertexArrayObject?(null===(s=this._scene)||void 0===s?void 0:s.forceWireframe)?u.bindBuffers(this._vertexBuffers,this._linesIndexBufferUseInstancing,c):(this._vertexArrayObject||(this._vertexArrayObject=this._engine.recordVertexArrayObject(this._vertexBuffers,null,c)),this._engine.bindVertexArrayObject(this._vertexArrayObject,(null===(r=this._scene)||void 0===r?void 0:r.forceWireframe)?this._linesIndexBufferUseInstancing:this._indexBuffer)):this._indexBuffer?u.bindBuffers(this._vertexBuffers,(null===(o=this._scene)||void 0===o?void 0:o.forceWireframe)?this._linesIndexBuffer:this._indexBuffer,c):u.bindBuffers(this._vertexBuffers,(null===(n=this._scene)||void 0===n?void 0:n.forceWireframe)?this._linesIndexBufferUseInstancing:null,c),this.useLogarithmicDepth&&this._scene&&Hs.BindLogDepth(p,c,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(c),e){case dg.BLENDMODE_ADD:u.setAlphaMode(1);break;case dg.BLENDMODE_ONEONE:u.setAlphaMode(6);break;case dg.BLENDMODE_STANDARD:u.setAlphaMode(2);break;case dg.BLENDMODE_MULTIPLY:u.setAlphaMode(4)}return this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(c),this._useInstancing?(null===(a=this._scene)||void 0===a?void 0:a.forceWireframe)?u.drawElementsType(6,0,10,this._particles.length):u.drawArraysType(7,0,4,this._particles.length):(null===(l=this._scene)||void 0===l?void 0:l.forceWireframe)?u.drawElementsType(1,0,10*this._particles.length):u.drawElementsType(0,0,6*this._particles.length),this._particles.length}render(){if(!this.isReady()||!this._particles.length)return 0;const e=this._engine;e.setState&&(e.setState(!1),this.forceDepthWrite&&e.setDepthWrite(!0));let t=0;return t=this.blendMode===dg.BLENDMODE_MULTIPLYADD?this._render(dg.BLENDMODE_MULTIPLY)+this._render(dg.BLENDMODE_ADD):this._render(this.blendMode),this._engine.unbindInstanceAttributes(),this._engine.setAlphaMode(0),t}dispose(e=!0){if(this.resetDrawCache(),this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._linesIndexBuffer&&(this._engine._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null),this._linesIndexBufferUseInstancing&&(this._engine._releaseBuffer(this._linesIndexBufferUseInstancing),this._linesIndexBufferUseInstancing=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._removeFromRoot(),this.subEmitters&&!this._subEmitters&&this._prepareSubEmitterInternalArray(),this._subEmitters&&this._subEmitters.length){for(let e=0;e<this._subEmitters.length;e++)for(const t of this._subEmitters[e])t.dispose();this._subEmitters=[],this.subEmitters=[]}if(this._disposeEmitterOnDispose&&this.emitter&&this.emitter.dispose&&this.emitter.dispose(!0),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.clear(),this._scene){const e=this._scene.particleSystems.indexOf(this);e>-1&&this._scene.particleSystems.splice(e,1),this._scene._activeParticleSystems.dispose()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onStoppedObservable.clear(),this.reset()}clone(e,t,i=!1){const s=Object.assign({},this._customWrappers);let r=null;const n=this._engine;if(n.createEffectForParticles&&null!=this.customShader){r=this.customShader;const e=r.shaderOptions.defines.length>0?r.shaderOptions.defines.join("\n"):"",t=n.createEffectForParticles(r.shaderPath.fragmentElement,r.shaderOptions.uniforms,r.shaderOptions.samplers,e);s[0]?s[0].effect=t:this.setCustomEffect(t,0)}const o=this.serialize(i),a=dg.Parse(o,this._scene||this._engine,this._rootUrl);return a.name=e,a.customShader=r,a._customWrappers=s,void 0===t&&(t=this.emitter),this.noiseTexture&&(a.noiseTexture=this.noiseTexture.clone()),a.emitter=t,this.preventAutoStart||a.start(),a}serialize(e=!1){const t={};if(dg._Serialize(t,this,e),t.textureMask=this.textureMask.asArray(),t.customShader=this.customShader,t.preventAutoStart=this.preventAutoStart,this.subEmitters){t.subEmitters=[],this._subEmitters||this._prepareSubEmitterInternalArray();for(const i of this._subEmitters){const s=[];for(const t of i)s.push(t.serialize(e));t.subEmitters.push(s)}}return t}static _Serialize(e,t,i){if(e.name=t.name,e.id=t.id,e.capacity=t.getCapacity(),e.disposeOnStop=t.disposeOnStop,e.manualEmitCount=t.manualEmitCount,t.emitter.position){const i=t.emitter;e.emitterId=i.id}else{const i=t.emitter;e.emitter=i.asArray()}t.particleEmitterType&&(e.particleEmitterType=t.particleEmitterType.serialize()),t.particleTexture&&(i?e.texture=t.particleTexture.serialize():(e.textureName=t.particleTexture.name,e.invertY=!!t.particleTexture._invertY)),e.isLocal=t.isLocal,de.AppendSerializedAnimations(t,e),e.beginAnimationOnStart=t.beginAnimationOnStart,e.beginAnimationFrom=t.beginAnimationFrom,e.beginAnimationTo=t.beginAnimationTo,e.beginAnimationLoop=t.beginAnimationLoop,e.startDelay=t.startDelay,e.renderingGroupId=t.renderingGroupId,e.isBillboardBased=t.isBillboardBased,e.billboardMode=t.billboardMode,e.minAngularSpeed=t.minAngularSpeed,e.maxAngularSpeed=t.maxAngularSpeed,e.minSize=t.minSize,e.maxSize=t.maxSize,e.minScaleX=t.minScaleX,e.maxScaleX=t.maxScaleX,e.minScaleY=t.minScaleY,e.maxScaleY=t.maxScaleY,e.minEmitPower=t.minEmitPower,e.maxEmitPower=t.maxEmitPower,e.minLifeTime=t.minLifeTime,e.maxLifeTime=t.maxLifeTime,e.emitRate=t.emitRate,e.gravity=t.gravity.asArray(),e.noiseStrength=t.noiseStrength.asArray(),e.color1=t.color1.asArray(),e.color2=t.color2.asArray(),e.colorDead=t.colorDead.asArray(),e.updateSpeed=t.updateSpeed,e.targetStopDuration=t.targetStopDuration,e.blendMode=t.blendMode,e.preWarmCycles=t.preWarmCycles,e.preWarmStepOffset=t.preWarmStepOffset,e.minInitialRotation=t.minInitialRotation,e.maxInitialRotation=t.maxInitialRotation,e.startSpriteCellID=t.startSpriteCellID,e.spriteCellLoop=t.spriteCellLoop,e.endSpriteCellID=t.endSpriteCellID,e.spriteCellChangeSpeed=t.spriteCellChangeSpeed,e.spriteCellWidth=t.spriteCellWidth,e.spriteCellHeight=t.spriteCellHeight,e.spriteRandomStartCell=t.spriteRandomStartCell,e.isAnimationSheetEnabled=t.isAnimationSheetEnabled,e.useLogarithmicDepth=t.useLogarithmicDepth;const s=t.getColorGradients();if(s){e.colorGradients=[];for(const t of s){const i={gradient:t.gradient,color1:t.color1.asArray()};t.color2?i.color2=t.color2.asArray():i.color2=t.color1.asArray(),e.colorGradients.push(i)}}const r=t.getRampGradients();if(r){e.rampGradients=[];for(const t of r){const i={gradient:t.gradient,color:t.color.asArray()};e.rampGradients.push(i)}e.useRampGradients=t.useRampGradients}const n=t.getColorRemapGradients();if(n){e.colorRemapGradients=[];for(const t of n){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.colorRemapGradients.push(i)}}const o=t.getAlphaRemapGradients();if(o){e.alphaRemapGradients=[];for(const t of o){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.alphaRemapGradients.push(i)}}const a=t.getSizeGradients();if(a){e.sizeGradients=[];for(const t of a){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.sizeGradients.push(i)}}const l=t.getAngularSpeedGradients();if(l){e.angularSpeedGradients=[];for(const t of l){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.angularSpeedGradients.push(i)}}const h=t.getVelocityGradients();if(h){e.velocityGradients=[];for(const t of h){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.velocityGradients.push(i)}}const c=t.getDragGradients();if(c){e.dragGradients=[];for(const t of c){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.dragGradients.push(i)}}const u=t.getEmitRateGradients();if(u){e.emitRateGradients=[];for(const t of u){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.emitRateGradients.push(i)}}const d=t.getStartSizeGradients();if(d){e.startSizeGradients=[];for(const t of d){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.startSizeGradients.push(i)}}const p=t.getLifeTimeGradients();if(p){e.lifeTimeGradients=[];for(const t of p){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.lifeTimeGradients.push(i)}}const _=t.getLimitVelocityGradients();if(_){e.limitVelocityGradients=[];for(const t of _){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.limitVelocityGradients.push(i)}e.limitVelocityDamping=t.limitVelocityDamping}t.noiseTexture&&(e.noiseTexture=t.noiseTexture.serialize())}static _Parse(e,t,i,s){var r,n,o;let a;a=i instanceof bt?null:i;const l=g("BABYLON.Texture");if(l&&a&&(e.texture?t.particleTexture=l.Parse(e.texture,a,s):e.textureName&&(t.particleTexture=new l(s+e.textureName,a,!1,void 0===e.invertY||e.invertY),t.particleTexture.name=e.textureName)),e.emitterId||0===e.emitterId||void 0!==e.emitter?e.emitterId&&a?t.emitter=a.getLastMeshById(e.emitterId):t.emitter=S.FromArray(e.emitter):t.emitter=S.Zero(),t.isLocal=!!e.isLocal,void 0!==e.renderingGroupId&&(t.renderingGroupId=e.renderingGroupId),void 0!==e.isBillboardBased&&(t.isBillboardBased=e.isBillboardBased),void 0!==e.billboardMode&&(t.billboardMode=e.billboardMode),void 0!==e.useLogarithmicDepth&&(t.useLogarithmicDepth=e.useLogarithmicDepth),e.animations){for(let i=0;i<e.animations.length;i++){const s=e.animations[i],r=g("BABYLON.Animation");r&&t.animations.push(r.Parse(s))}t.beginAnimationOnStart=e.beginAnimationOnStart,t.beginAnimationFrom=e.beginAnimationFrom,t.beginAnimationTo=e.beginAnimationTo,t.beginAnimationLoop=e.beginAnimationLoop}if(e.autoAnimate&&a&&a.beginAnimation(t,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),t.startDelay=0|e.startDelay,t.minAngularSpeed=e.minAngularSpeed,t.maxAngularSpeed=e.maxAngularSpeed,t.minSize=e.minSize,t.maxSize=e.maxSize,e.minScaleX&&(t.minScaleX=e.minScaleX,t.maxScaleX=e.maxScaleX,t.minScaleY=e.minScaleY,t.maxScaleY=e.maxScaleY),void 0!==e.preWarmCycles&&(t.preWarmCycles=e.preWarmCycles,t.preWarmStepOffset=e.preWarmStepOffset),void 0!==e.minInitialRotation&&(t.minInitialRotation=e.minInitialRotation,t.maxInitialRotation=e.maxInitialRotation),t.minLifeTime=e.minLifeTime,t.maxLifeTime=e.maxLifeTime,t.minEmitPower=e.minEmitPower,t.maxEmitPower=e.maxEmitPower,t.emitRate=e.emitRate,t.gravity=S.FromArray(e.gravity),e.noiseStrength&&(t.noiseStrength=S.FromArray(e.noiseStrength)),t.color1=F.FromArray(e.color1),t.color2=F.FromArray(e.color2),t.colorDead=F.FromArray(e.colorDead),t.updateSpeed=e.updateSpeed,t.targetStopDuration=e.targetStopDuration,t.blendMode=e.blendMode,e.colorGradients)for(const i of e.colorGradients)t.addColorGradient(i.gradient,F.FromArray(i.color1),i.color2?F.FromArray(i.color2):void 0);if(e.rampGradients){for(const i of e.rampGradients)t.addRampGradient(i.gradient,N.FromArray(i.color));t.useRampGradients=e.useRampGradients}if(e.colorRemapGradients)for(const i of e.colorRemapGradients)t.addColorRemapGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.alphaRemapGradients)for(const i of e.alphaRemapGradients)t.addAlphaRemapGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.sizeGradients)for(const i of e.sizeGradients)t.addSizeGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.angularSpeedGradients)for(const i of e.angularSpeedGradients)t.addAngularSpeedGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.velocityGradients)for(const i of e.velocityGradients)t.addVelocityGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.dragGradients)for(const i of e.dragGradients)t.addDragGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.emitRateGradients)for(const i of e.emitRateGradients)t.addEmitRateGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.startSizeGradients)for(const i of e.startSizeGradients)t.addStartSizeGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.lifeTimeGradients)for(const i of e.lifeTimeGradients)t.addLifeTimeGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.limitVelocityGradients){for(const i of e.limitVelocityGradients)t.addLimitVelocityGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);t.limitVelocityDamping=e.limitVelocityDamping}if(e.noiseTexture&&a){const i=g("BABYLON.ProceduralTexture");t.noiseTexture=i.Parse(e.noiseTexture,a,s)}let h;if(e.particleEmitterType){switch(e.particleEmitterType.type){case"SphereParticleEmitter":h=new bn;break;case"SphereDirectedParticleEmitter":h=new Cn;break;case"ConeEmitter":case"ConeParticleEmitter":h=new vn;break;case"CylinderParticleEmitter":h=new xn;break;case"CylinderDirectedParticleEmitter":h=new Tn;break;case"HemisphericParticleEmitter":h=new En;break;case"PointParticleEmitter":h=new Sn;break;case"MeshParticleEmitter":h=new An;break;default:h=new gn}h.parse(e.particleEmitterType,a)}else h=new gn,h.parse(e,a);t.particleEmitterType=h,t.startSpriteCellID=e.startSpriteCellID,t.endSpriteCellID=e.endSpriteCellID,t.spriteCellLoop=null===(r=e.spriteCellLoop)||void 0===r||r,t.spriteCellWidth=e.spriteCellWidth,t.spriteCellHeight=e.spriteCellHeight,t.spriteCellChangeSpeed=e.spriteCellChangeSpeed,t.spriteRandomStartCell=e.spriteRandomStartCell,t.disposeOnStop=null!==(n=e.disposeOnStop)&&void 0!==n&&n,t.manualEmitCount=null!==(o=e.manualEmitCount)&&void 0!==o?o:-1}static Parse(e,t,i,s=!1,r){const n=e.name;let o,a,l=null,h=null;if(t instanceof bt?o=t:(a=t,o=a.getEngine()),e.customShader&&o.createEffectForParticles){h=e.customShader;const t=h.shaderOptions.defines.length>0?h.shaderOptions.defines.join("\n"):"";l=o.createEffectForParticles(h.shaderPath.fragmentElement,h.shaderOptions.uniforms,h.shaderOptions.samplers,t)}const c=new dg(n,r||e.capacity,t,l,e.isAnimationSheetEnabled);if(c.customShader=h,c._rootUrl=i,e.id&&(c.id=e.id),e.subEmitters){c.subEmitters=[];for(const s of e.subEmitters){const e=[];for(const r of s)e.push(ug.Parse(r,t,i));c.subEmitters.push(e)}}return dg._Parse(e,c,t,i),e.textureMask&&(c.textureMask=F.FromArray(e.textureMask)),e.preventAutoStart&&(c.preventAutoStart=e.preventAutoStart),s||c.preventAutoStart||c.start(),c}}dg.BILLBOARDMODE_Y=2,dg.BILLBOARDMODE_ALL=7,dg.BILLBOARDMODE_STRETCHED=8,dg.BILLBOARDMODE_STRETCHED_LOCAL=9,ug._ParseParticleSystem=dg.Parse;nt.IncludesShadersStore.clipPlaneFragmentDeclaration2="#ifdef CLIPPLANE\nin float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nin float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nin float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nin float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nin float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nin float fClipDistance6;\n#endif\n";nt.ShadersStore.gpuRenderParticlesPixelShader="precision highp float;\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nuniform sampler2D diffuseSampler;varying vec2 vUV;varying vec4 vColor;\n#include<clipPlaneFragmentDeclaration2> \n#include<imageProcessingDeclaration>\n#include<logDepthDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\nvoid main() {\n#include<clipPlaneFragment> \nvec4 textureColor=texture2D(diffuseSampler,vUV);gl_FragColor=textureColor*vColor;\n#ifdef BLENDMULTIPLYMODE\nfloat alpha=vColor.a*textureColor.a;gl_FragColor.rgb=gl_FragColor.rgb*alpha+vec3(1.0)*(1.0-alpha);\n#endif \n#include<logDepthFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\ngl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);\n#else\n#ifdef IMAGEPROCESSING\ngl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);gl_FragColor=applyImageProcessing(gl_FragColor);\n#endif\n#endif\n}\n";nt.IncludesShadersStore.clipPlaneVertexDeclaration2="#ifdef CLIPPLANE\nuniform vec4 vClipPlane;out float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nuniform vec4 vClipPlane2;out float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nuniform vec4 vClipPlane3;out float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nuniform vec4 vClipPlane4;out float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nuniform vec4 vClipPlane5;out float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nuniform vec4 vClipPlane6;out float fClipDistance6;\n#endif\n";nt.ShadersStore.gpuRenderParticlesVertexShader="precision highp float;uniform mat4 view;uniform mat4 projection;uniform vec2 translationPivot;uniform vec3 worldOffset;\n#ifdef LOCAL\nuniform mat4 emitterWM;\n#endif\nattribute vec3 position;attribute float age;attribute float life;attribute vec3 size;\n#ifndef BILLBOARD\nattribute vec3 initialDirection;\n#endif\n#ifdef BILLBOARDSTRETCHED\nattribute vec3 direction;\n#endif\nattribute float angle;\n#ifdef ANIMATESHEET\nattribute float cellIndex;\n#endif\nattribute vec2 offset;attribute vec2 uv;varying vec2 vUV;varying vec4 vColor;varying vec3 vPositionW;\n#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)\nuniform mat4 invView;\n#endif\n#include<clipPlaneVertexDeclaration2>\n#include<logDepthDeclaration>\n#ifdef COLORGRADIENTS\nuniform sampler2D colorGradientSampler;\n#else\nuniform vec4 colorDead;attribute vec4 color;\n#endif\n#ifdef ANIMATESHEET\nuniform vec3 sheetInfos;\n#endif\n#ifdef BILLBOARD\nuniform vec3 eyePosition;\n#endif\nvec3 rotate(vec3 yaxis,vec3 rotatedCorner) {vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));vec3 zaxis=normalize(cross(yaxis,xaxis));vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;\n#ifdef LOCAL\nreturn ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;\n#else\nreturn (position+worldOffset)+alignedCorner;\n#endif\n}\n#ifdef BILLBOARDSTRETCHED\nvec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {vec3 normalizedToCamera=normalize(toCamera);vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;\n#ifdef LOCAL\nreturn ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;\n#else\nreturn (position+worldOffset)+alignedCorner;\n#endif\n}\n#endif\nvoid main() {\n#ifdef ANIMATESHEET\nfloat rowOffset=floor(cellIndex/sheetInfos.z);float columnOffset=cellIndex-rowOffset*sheetInfos.z;vec2 uvScale=sheetInfos.xy;vec2 uvOffset=vec2(uv.x ,1.0-uv.y);vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;\n#else\nvUV=uv;\n#endif\nfloat ratio=age/life;\n#ifdef COLORGRADIENTS\nvColor=texture2D(colorGradientSampler,vec2(ratio,0));\n#else\nvColor=color*vec4(1.0-ratio)+colorDead*vec4(ratio);\n#endif\nvec2 cornerPos=(offset-translationPivot)*size.yz*size.x;\n#ifdef BILLBOARD\nvec4 rotatedCorner;rotatedCorner.w=0.;\n#ifdef BILLBOARDY\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=(position+worldOffset)-eyePosition;yaxis.y=0.;vPositionW=rotate(normalize(yaxis),rotatedCorner.xyz);vec4 viewPosition=(view*vec4(vPositionW,1.0));\n#elif defined(BILLBOARDSTRETCHED)\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 toCamera=(position+worldOffset)-eyePosition;vPositionW=rotateAlign(toCamera,rotatedCorner.xyz);vec4 viewPosition=(view*vec4(vPositionW,1.0));\n#else\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;\n#ifdef LOCAL\nvec4 viewPosition=view*vec4(((emitterWM*vec4(position,1.0)).xyz+worldOffset),1.0)+rotatedCorner;\n#else\nvec4 viewPosition=view*vec4((position+worldOffset),1.0)+rotatedCorner;\n#endif\nvPositionW=(invView*viewPosition).xyz;\n#endif\n#else\nvec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=0.;rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.xz+=translationPivot;vec3 yaxis=normalize(initialDirection);vPositionW=rotate(yaxis,rotatedCorner);vec4 viewPosition=view*vec4(vPositionW,1.0);\n#endif\ngl_Position=projection*viewPosition;\n#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nvec4 worldPos=vec4(vPositionW,1.0);\n#endif\n#include<clipPlaneVertex>\n#include<logDepthVertex>\n}";class pg extends Rn{static get IsSupported(){if(!x.LastCreatedEngine)return!1;const e=x.LastCreatedEngine.getCaps();return e.supportTransformFeedbacks||e.supportComputeShaders}_createIndexBuffer(){this._linesIndexBufferUseInstancing=this._engine.createIndexBuffer(new Uint32Array([0,1,1,3,3,2,2,0,0,3]))}getCapacity(){return this._capacity}get maxActiveParticleCount(){return this._maxActiveParticleCount}set maxActiveParticleCount(e){this._maxActiveParticleCount=Math.min(e,this._capacity)}get activeParticleCount(){return this.maxActiveParticleCount}set activeParticleCount(e){this.maxActiveParticleCount=e}isReady(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==dg.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else{if(!this._getWrapper(dg.BLENDMODE_MULTIPLY).effect.isReady())return!1;if(!this._getWrapper(dg.BLENDMODE_ADD).effect.isReady())return!1}return this._platform.isUpdateBufferCreated()?this._platform.isUpdateBufferReady():(this._recreateUpdateEffect(),!1)}isStarted(){return this._started}isStopped(){return this._stopped}isStopping(){return!1}getActiveCount(){return this._currentActiveCount}start(e=this.startDelay){if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";e?setTimeout((()=>{this.start(0)}),e):(this._started=!0,this._stopped=!1,this._preWarmDone=!1,this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop))}stop(){this._stopped||(this._stopped=!0)}reset(){this._releaseBuffers(),this._platform.releaseVertexBuffers(),this._currentActiveCount=0,this._targetIndex=0}getClassName(){return"GPUParticleSystem"}getCustomEffect(e=0){var t,i;return null!==(i=null===(t=this._customWrappers[e])||void 0===t?void 0:t.effect)&&void 0!==i?i:this._customWrappers[0].effect}_getCustomDrawWrapper(e=0){var t;return null!==(t=this._customWrappers[e])&&void 0!==t?t:this._customWrappers[0]}setCustomEffect(e,t=0){this._customWrappers[t]=new Tt(this._engine),this._customWrappers[t].effect=e}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new a),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"gpuRenderParticles"}get vertexBuffers(){return this._renderVertexBuffers[1^this._targetIndex]}get indexBuffer(){return null}_removeGradientAndTexture(e,t,i){return super._removeGradientAndTexture(e,t,i),this._releaseBuffers(),this}addColorGradient(e,t){this._colorGradients||(this._colorGradients=[]);const i=new ng(e,t);return this._colorGradients.push(i),this._refreshColorGradient(!0),this._releaseBuffers(),this}_refreshColorGradient(e=!1){this._colorGradients&&(e&&this._colorGradients.sort(((e,t)=>e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0)),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null))}forceRefreshGradients(){this._refreshColorGradient(),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture"),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture"),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture"),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture"),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture"),this.reset()}removeColorGradient(e){return this._removeGradientAndTexture(e,this._colorGradients,this._colorGradientsTexture),this._colorGradientsTexture=null,this}resetDrawCache(){var e;for(const t in this._drawWrappers)null===(e=this._drawWrappers[t].drawContext)||void 0===e||e.reset()}_addFactorGradient(e,t,i){const s=new ag(t,i);e.push(s),this._releaseBuffers()}addSizeGradient(e,t){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,t),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture",!0),this._releaseBuffers(),this}removeSizeGradient(e){return this._removeGradientAndTexture(e,this._sizeGradients,this._sizeGradientsTexture),this._sizeGradientsTexture=null,this}_refreshFactorGradient(e,t,i=!1){if(!e)return;i&&e.sort(((e,t)=>e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0));const s=this;s[t]&&(s[t].dispose(),s[t]=null)}addAngularSpeedGradient(e,t){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,t),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture",!0),this._releaseBuffers(),this}removeAngularSpeedGradient(e){return this._removeGradientAndTexture(e,this._angularSpeedGradients,this._angularSpeedGradientsTexture),this._angularSpeedGradientsTexture=null,this}addVelocityGradient(e,t){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,t),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture",!0),this._releaseBuffers(),this}removeVelocityGradient(e){return this._removeGradientAndTexture(e,this._velocityGradients,this._velocityGradientsTexture),this._velocityGradientsTexture=null,this}addLimitVelocityGradient(e,t){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,t),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture",!0),this._releaseBuffers(),this}removeLimitVelocityGradient(e){return this._removeGradientAndTexture(e,this._limitVelocityGradients,this._limitVelocityGradientsTexture),this._limitVelocityGradientsTexture=null,this}addDragGradient(e,t){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,t),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture",!0),this._releaseBuffers(),this}removeDragGradient(e){return this._removeGradientAndTexture(e,this._dragGradients,this._dragGradientsTexture),this._dragGradientsTexture=null,this}addEmitRateGradient(){return this}removeEmitRateGradient(){return this}addStartSizeGradient(){return this}removeStartSizeGradient(){return this}addColorRemapGradient(){return this}removeColorRemapGradient(){return this}addAlphaRemapGradient(){return this}removeAlphaRemapGradient(){return this}addRampGradient(){return this}removeRampGradient(){return this}getRampGradients(){return null}get useRampGradients(){return!1}set useRampGradients(e){}addLifeTimeGradient(){return this}removeLifeTimeGradient(){return this}constructor(e,t,i,s=null,r=!1){if(super(e),this.layerMask=268435455,this._accumulatedCount=0,this._renderVertexBuffers=[],this._targetIndex=0,this._currentRenderId=-1,this._currentRenderingCameraUniqueId=-1,this._started=!1,this._stopped=!1,this._timeDelta=0,this.updateInAnimate=!1,this._actualFrame=0,this._rawTextureWidth=256,this.onDisposeObservable=new a,this.onStoppedObservable=new a,this.forceDepthWrite=!1,this._preWarmDone=!1,this.isLocal=!1,this.isGPU=!0,this._onBeforeDrawParticlesObservable=null,i&&"Scene"!==i.getClassName()?(this._engine=i,this.defaultProjectionMatrix=y.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)):(this._scene=i||x.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)),this._engine.getCaps().supportComputeShaders){if(!g("BABYLON.ComputeShaderParticleSystem"))throw new Error("The ComputeShaderParticleSystem class is not available! Make sure you have imported it.");this._platform=new(g("BABYLON.ComputeShaderParticleSystem"))(this,this._engine)}else{if(!g("BABYLON.WebGL2ParticleSystem"))throw new Error("The WebGL2ParticleSystem class is not available! Make sure you have imported it.");this._platform=new(g("BABYLON.WebGL2ParticleSystem"))(this,this._engine)}this._customWrappers={0:new Tt(this._engine)},this._customWrappers[0].effect=s,this._drawWrappers={0:new Tt(this._engine)},this._drawWrappers[0].drawContext&&(this._drawWrappers[0].drawContext.useInstancing=!0),this._createIndexBuffer(),this._attachImageProcessingConfiguration(null),(t=null!=t?t:{}).randomTextureSize||delete t.randomTextureSize;const n=Object.assign({capacity:5e4,randomTextureSize:this._engine.getCaps().maxTextureSize},t),o=t;isFinite(o)&&(n.capacity=o),this._capacity=n.capacity,this._maxActiveParticleCount=n.capacity,this._currentActiveCount=0,this._isAnimationSheetEnabled=r,this.particleEmitterType=new gn;const l=Math.min(this._engine.getCaps().maxTextureSize,n.randomTextureSize);let h=[];for(let e=0;e<l;++e)h.push(Math.random()),h.push(Math.random()),h.push(Math.random()),h.push(Math.random());this._randomTexture=new Mr(new Float32Array(h),l,1,5,i,!1,!1,1,1),this._randomTexture.name="GPUParticleSystem_random1",this._randomTexture.wrapU=1,this._randomTexture.wrapV=1,h=[];for(let e=0;e<l;++e)h.push(Math.random()),h.push(Math.random()),h.push(Math.random()),h.push(Math.random());this._randomTexture2=new Mr(new Float32Array(h),l,1,5,i,!1,!1,1,1),this._randomTexture2.name="GPUParticleSystem_random2",this._randomTexture2.wrapU=1,this._randomTexture2.wrapV=1,this._randomTextureSize=l}_reset(){this._releaseBuffers()}_createVertexBuffers(e,t,i){const s={};s.position=t.createVertexBuffer("position",0,3,this._attributesStrideSize,!0);let r=3;s.age=t.createVertexBuffer("age",r,1,this._attributesStrideSize,!0),r+=1,s.size=t.createVertexBuffer("size",r,3,this._attributesStrideSize,!0),r+=3,s.life=t.createVertexBuffer("life",r,1,this._attributesStrideSize,!0),r+=1,r+=4,this.billboardMode===dg.BILLBOARDMODE_STRETCHED&&(s.direction=t.createVertexBuffer("direction",r,3,this._attributesStrideSize,!0)),r+=3,this._platform.alignDataInBuffer&&(r+=1),this.particleEmitterType instanceof yn&&(r+=3,this._platform.alignDataInBuffer&&(r+=1)),this._colorGradientsTexture||(s.color=t.createVertexBuffer("color",r,4,this._attributesStrideSize,!0),r+=4),this._isBillboardBased||(s.initialDirection=t.createVertexBuffer("initialDirection",r,3,this._attributesStrideSize,!0),r+=3,this._platform.alignDataInBuffer&&(r+=1)),this.noiseTexture&&(s.noiseCoordinates1=t.createVertexBuffer("noiseCoordinates1",r,3,this._attributesStrideSize,!0),r+=3,this._platform.alignDataInBuffer&&(r+=1),s.noiseCoordinates2=t.createVertexBuffer("noiseCoordinates2",r,3,this._attributesStrideSize,!0),r+=3,this._platform.alignDataInBuffer&&(r+=1)),s.angle=t.createVertexBuffer("angle",r,1,this._attributesStrideSize,!0),this._angularSpeedGradientsTexture?r++:r+=2,this._isAnimationSheetEnabled&&(s.cellIndex=t.createVertexBuffer("cellIndex",r,1,this._attributesStrideSize,!0),r+=1,this.spriteRandomStartCell&&(s.cellStartOffset=t.createVertexBuffer("cellStartOffset",r,1,this._attributesStrideSize,!0),r+=1)),s.offset=i.createVertexBuffer("offset",0,2),s.uv=i.createVertexBuffer("uv",2,2),this._renderVertexBuffers.push(s),this._platform.createVertexBuffers(e,s),this.resetDrawCache()}_initialize(e=!1){if(this._buffer0&&!e)return;const t=this._engine,i=[];this._attributesStrideSize=21,this._targetIndex=0,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1),this.particleEmitterType instanceof yn&&(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this.isBillboardBased||(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this._colorGradientsTexture&&(this._attributesStrideSize-=4),this._angularSpeedGradientsTexture&&(this._attributesStrideSize-=1),this._isAnimationSheetEnabled&&(this._attributesStrideSize+=1,this.spriteRandomStartCell&&(this._attributesStrideSize+=1)),this.noiseTexture&&(this._attributesStrideSize+=6,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=2)),this._platform.alignDataInBuffer&&(this._attributesStrideSize+=3-(this._attributesStrideSize+3&3));const s=this.particleEmitterType instanceof yn,r=R.Vector3[0];let n=0;for(let e=0;e<this._capacity;e++)if(i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),s?(this.particleEmitterType.particleDestinationGenerator(e,null,r),i.push(r.x),i.push(r.y),i.push(r.z)):(i.push(0),i.push(0),i.push(0)),this._platform.alignDataInBuffer&&i.push(0),n+=16,s&&(this.particleEmitterType.particlePositionGenerator(e,null,r),i.push(r.x),i.push(r.y),i.push(r.z),this._platform.alignDataInBuffer&&i.push(0),n+=4),this._colorGradientsTexture||(i.push(0),i.push(0),i.push(0),i.push(0),n+=4),this.isBillboardBased||(i.push(0),i.push(0),i.push(0),this._platform.alignDataInBuffer&&i.push(0),n+=4),this.noiseTexture&&(i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),n+=8),i.push(0),n+=1,this._angularSpeedGradientsTexture||(i.push(0),n+=1),this._isAnimationSheetEnabled&&(i.push(0),n+=1,this.spriteRandomStartCell&&(i.push(0),n+=1)),this._platform.alignDataInBuffer){let e=3-(n+3&3);for(n+=e;e-- >0;)i.push(0)}const o=new Float32Array([.5,.5,1,1,-.5,.5,0,1,.5,-.5,1,0,-.5,-.5,0,0]),a=this._platform.createParticleBuffer(i),l=this._platform.createParticleBuffer(i);this._buffer0=new li(t,a,!1,this._attributesStrideSize),this._buffer1=new li(t,l,!1,this._attributesStrideSize),this._spriteBuffer=new li(t,o,!1,4),this._renderVertexBuffers=[],this._createVertexBuffers(this._buffer0,this._buffer1,this._spriteBuffer),this._createVertexBuffers(this._buffer1,this._buffer0,this._spriteBuffer),this._sourceBuffer=this._buffer0,this._targetBuffer=this._buffer1}_recreateUpdateEffect(){this._createColorGradientTexture(),this._createSizeGradientTexture(),this._createAngularSpeedGradientTexture(),this._createVelocityGradientTexture(),this._createLimitVelocityGradientTexture(),this._createDragGradientTexture();let e=this.particleEmitterType?this.particleEmitterType.getEffectDefines():"";return this._isBillboardBased&&(e+="\n#define BILLBOARD"),this._colorGradientsTexture&&(e+="\n#define COLORGRADIENTS"),this._sizeGradientsTexture&&(e+="\n#define SIZEGRADIENTS"),this._angularSpeedGradientsTexture&&(e+="\n#define ANGULARSPEEDGRADIENTS"),this._velocityGradientsTexture&&(e+="\n#define VELOCITYGRADIENTS"),this._limitVelocityGradientsTexture&&(e+="\n#define LIMITVELOCITYGRADIENTS"),this._dragGradientsTexture&&(e+="\n#define DRAGGRADIENTS"),this.isAnimationSheetEnabled&&(e+="\n#define ANIMATESHEET",this.spriteRandomStartCell&&(e+="\n#define ANIMATESHEETRANDOMSTART")),this.noiseTexture&&(e+="\n#define NOISE"),this.isLocal&&(e+="\n#define LOCAL"),!(!this._platform.isUpdateBufferCreated()||this._cachedUpdateDefines!==e)||(this._cachedUpdateDefines=e,this._updateBuffer=this._platform.createUpdateBuffer(e),this._platform.isUpdateBufferReady())}_getWrapper(e){const t=this._getCustomDrawWrapper(e);if(null==t?void 0:t.effect)return t;const i=[];this.fillDefines(i,e);let s=this._drawWrappers[e];s||(s=new Tt(this._engine),s.drawContext&&(s.drawContext.useInstancing=!0),this._drawWrappers[e]=s);const r=i.join("\n");if(s.defines!==r){const e=[],t=[],i=[];this.fillUniformsAttributesAndSamplerNames(t,e,i),s.setEffect(this._engine.createEffect("gpuRenderParticles",e,t,i,r),r)}return s}static _GetAttributeNamesOrOptions(e=!1,t=!1,i=!1,s=!1){const r=[hi.PositionKind,"age","life","size","angle"];return e||r.push(hi.ColorKind),t&&r.push("cellIndex"),i||r.push("initialDirection"),s&&r.push("direction"),r.push("offset",hi.UVKind),r}static _GetEffectCreationOptions(e=!1,t=!1){const i=["emitterWM","worldOffset","view","projection","colorDead","invView","translationPivot","eyePosition"];return ks(i),e&&i.push("sheetInfos"),t&&i.push("logarithmicDepthConstant"),i}fillDefines(e,t=0){if(this._scene&&Gs(this,this._scene,e),t===dg.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this.isLocal&&e.push("#define LOCAL"),this.useLogarithmicDepth&&e.push("#define LOGARITHMICDEPTH"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case dg.BILLBOARDMODE_Y:e.push("#define BILLBOARDY");break;case dg.BILLBOARDMODE_STRETCHED:e.push("#define BILLBOARDSTRETCHED");break;case dg.BILLBOARDMODE_ALL:e.push("#define BILLBOARDMODE_ALL")}this._colorGradientsTexture&&e.push("#define COLORGRADIENTS"),this.isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(""+this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(e,t,i){t.push(...pg._GetAttributeNamesOrOptions(!!this._colorGradientsTexture,this._isAnimationSheetEnabled,this._isBillboardBased,this._isBillboardBased&&this.billboardMode===dg.BILLBOARDMODE_STRETCHED)),e.push(...pg._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth)),i.push("diffuseSampler","colorGradientSampler"),this._imageProcessingConfiguration&&(Zt.PrepareUniforms(e,this._imageProcessingConfigurationDefines),Zt.PrepareSamplers(i,this._imageProcessingConfigurationDefines))}animate(e=!1){var t;this._timeDelta=this.updateSpeed*(e?this.preWarmStepOffset:(null===(t=this._scene)||void 0===t?void 0:t.getAnimationRatio())||1),this._actualFrame+=this._timeDelta,this._stopped||this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop(),this.updateInAnimate&&this._update()}_createFactorGradientTexture(e,t){const i=this[t];if(!e||!e.length||i)return;const s=new Float32Array(this._rawTextureWidth);for(let t=0;t<this._rawTextureWidth;t++){const i=t/this._rawTextureWidth;lg.GetCurrentGradient(i,e,((e,i,r)=>{s[t]=l.Lerp(e.factor1,i.factor1,r)}))}this[t]=Mr.CreateRTexture(s,this._rawTextureWidth,1,this._scene||this._engine,!1,!1,1),this[t].name=t.substring(1)}_createSizeGradientTexture(){this._createFactorGradientTexture(this._sizeGradients,"_sizeGradientsTexture")}_createAngularSpeedGradientTexture(){this._createFactorGradientTexture(this._angularSpeedGradients,"_angularSpeedGradientsTexture")}_createVelocityGradientTexture(){this._createFactorGradientTexture(this._velocityGradients,"_velocityGradientsTexture")}_createLimitVelocityGradientTexture(){this._createFactorGradientTexture(this._limitVelocityGradients,"_limitVelocityGradientsTexture")}_createDragGradientTexture(){this._createFactorGradientTexture(this._dragGradients,"_dragGradientsTexture")}_createColorGradientTexture(){if(!this._colorGradients||!this._colorGradients.length||this._colorGradientsTexture)return;const e=new Uint8Array(4*this._rawTextureWidth),t=w.Color4[0];for(let i=0;i<this._rawTextureWidth;i++){const s=i/this._rawTextureWidth;lg.GetCurrentGradient(s,this._colorGradients,((s,r,n)=>{F.LerpToRef(s.color1,r.color1,n,t),e[4*i]=255*t.r,e[4*i+1]=255*t.g,e[4*i+2]=255*t.b,e[4*i+3]=255*t.a}))}this._colorGradientsTexture=Mr.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1),this._colorGradientsTexture.name="colorGradients"}_render(e,t){var i,s,r,n,o;const a=this._getWrapper(e),l=a.effect;this._engine.enableEffect(a);const h=(null===(i=this._scene)||void 0===i?void 0:i.getViewMatrix())||y.IdentityReadOnly;if(l.setMatrix("view",h),l.setMatrix("projection",null!==(s=this.defaultProjectionMatrix)&&void 0!==s?s:this._scene.getProjectionMatrix()),l.setTexture("diffuseSampler",this.particleTexture),l.setVector2("translationPivot",this.translationPivot),l.setVector3("worldOffset",this.worldOffset),this.isLocal&&l.setMatrix("emitterWM",t),this._colorGradientsTexture?l.setTexture("colorGradientSampler",this._colorGradientsTexture):l.setDirectColor4("colorDead",this.colorDead),this._isAnimationSheetEnabled&&this.particleTexture){const e=this.particleTexture.getBaseSize();l.setFloat3("sheetInfos",this.spriteCellWidth/e.width,this.spriteCellHeight/e.height,e.width/this.spriteCellWidth)}if(this._isBillboardBased&&this._scene){const e=this._scene.activeCamera;l.setVector3("eyePosition",e.globalPosition)}const c=l.defines;if(this._scene&&zs(l,this,this._scene),c.indexOf("#define BILLBOARDMODE_ALL")>=0){const e=h.clone();e.invert(),l.setMatrix("invView",e)}switch(this.useLogarithmicDepth&&this._scene&&Hs.BindLogDepth(c,l,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(l),e){case dg.BLENDMODE_ADD:this._engine.setAlphaMode(1);break;case dg.BLENDMODE_ONEONE:this._engine.setAlphaMode(6);break;case dg.BLENDMODE_STANDARD:this._engine.setAlphaMode(2);break;case dg.BLENDMODE_MULTIPLY:this._engine.setAlphaMode(4)}return this._platform.bindDrawBuffers(this._targetIndex,l,(null===(r=this._scene)||void 0===r?void 0:r.forceWireframe)?this._linesIndexBufferUseInstancing:null),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(l),(null===(n=this._scene)||void 0===n?void 0:n.forceWireframe)?this._engine.drawElementsType(6,0,10,this._currentActiveCount):this._engine.drawArraysType(7,0,4,this._currentActiveCount),this._engine.setAlphaMode(0),(null===(o=this._scene)||void 0===o?void 0:o.forceWireframe)&&this._engine.unbindInstanceAttributes(),this._currentActiveCount}_update(e){if(!this.emitter||!this._targetBuffer)return;if(!this._recreateUpdateEffect())return;if(!e)if(this.emitter.position)e=this.emitter.getWorldMatrix();else{const t=this.emitter;e=R.Matrix[0],y.TranslationToRef(t.x,t.y,t.z,e)}this._platform.preUpdateParticleBuffer(),this._updateBuffer.setFloat("currentCount",this._currentActiveCount),this._updateBuffer.setFloat("timeDelta",this._timeDelta),this._updateBuffer.setFloat("stopFactor",this._stopped?0:1),this._updateBuffer.setInt("randomTextureSize",this._randomTextureSize),this._updateBuffer.setFloat2("lifeTime",this.minLifeTime,this.maxLifeTime),this._updateBuffer.setFloat2("emitPower",this.minEmitPower,this.maxEmitPower),this._colorGradientsTexture||(this._updateBuffer.setDirectColor4("color1",this.color1),this._updateBuffer.setDirectColor4("color2",this.color2)),this._updateBuffer.setFloat2("sizeRange",this.minSize,this.maxSize),this._updateBuffer.setFloat4("scaleRange",this.minScaleX,this.maxScaleX,this.minScaleY,this.maxScaleY),this._updateBuffer.setFloat4("angleRange",this.minAngularSpeed,this.maxAngularSpeed,this.minInitialRotation,this.maxInitialRotation),this._updateBuffer.setVector3("gravity",this.gravity),this._limitVelocityGradientsTexture&&this._updateBuffer.setFloat("limitVelocityDamping",this.limitVelocityDamping),this.particleEmitterType&&this.particleEmitterType.applyToShader(this._updateBuffer),this._isAnimationSheetEnabled&&this._updateBuffer.setFloat4("cellInfos",this.startSpriteCellID,this.endSpriteCellID,this.spriteCellChangeSpeed,this.spriteCellLoop?1:0),this.noiseTexture&&this._updateBuffer.setVector3("noiseStrength",this.noiseStrength),this.isLocal||this._updateBuffer.setMatrix("emitterWM",e),this._platform.updateParticleBuffer(this._targetIndex,this._targetBuffer,this._currentActiveCount),this._targetIndex++,2===this._targetIndex&&(this._targetIndex=0);const t=this._sourceBuffer;this._sourceBuffer=this._targetBuffer,this._targetBuffer=t}render(e=!1,t=!1){if(!this._started)return 0;if(!this.isReady())return 0;if(!e&&this._scene){if(!this._preWarmDone&&this.preWarmCycles){for(let e=0;e<this.preWarmCycles;e++)this.animate(!0),this.render(!0,!0);this._preWarmDone=!0}if(this._currentRenderId===this._scene.getRenderId()&&(!this._scene.activeCamera||this._scene.activeCamera&&this._currentRenderingCameraUniqueId===this._scene.activeCamera.uniqueId))return 0;this._currentRenderId=this._scene.getRenderId(),this._scene.activeCamera&&(this._currentRenderingCameraUniqueId=this._scene.activeCamera.uniqueId)}if(this._initialize(),this._accumulatedCount+=this.emitRate*this._timeDelta,this._accumulatedCount>1){const e=0|this._accumulatedCount;this._accumulatedCount-=e,this._currentActiveCount+=e}if(this._currentActiveCount=Math.min(this._maxActiveParticleCount,this._currentActiveCount),!this._currentActiveCount)return 0;let i;if(this.emitter.position)i=this.emitter.getWorldMatrix();else{const e=this.emitter;i=R.Matrix[0],y.TranslationToRef(e.x,e.y,e.z,i)}const s=this._engine;this.updateInAnimate||this._update(i);let r=0;return e||t||(s.setState(!1),this.forceDepthWrite&&s.setDepthWrite(!0),r=this.blendMode===dg.BLENDMODE_MULTIPLYADD?this._render(dg.BLENDMODE_MULTIPLY,i)+this._render(dg.BLENDMODE_ADD,i):this._render(this.blendMode,i),this._engine.setAlphaMode(0)),r}rebuild(){const e=()=>{this._recreateUpdateEffect()&&this._platform.isUpdateBufferReady()?this._initialize(!0):setTimeout(e,10)};this._createIndexBuffer(),this._cachedUpdateDefines="",this._platform.contextLost(),e()}_releaseBuffers(){this._buffer0&&(this._buffer0.dispose(),this._buffer0=null),this._buffer1&&(this._buffer1.dispose(),this._buffer1=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._platform.releaseBuffers()}dispose(e=!0){for(const e in this._drawWrappers)this._drawWrappers[e].dispose();if(this._drawWrappers={},this._scene){const e=this._scene.particleSystems.indexOf(this);e>-1&&this._scene.particleSystems.splice(e,1)}this._releaseBuffers(),this._platform.releaseVertexBuffers();for(let e=0;e<this._renderVertexBuffers.length;++e){const t=this._renderVertexBuffers[e];for(const e in t)t[e].dispose()}this._renderVertexBuffers=[],this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null),this._sizeGradientsTexture&&(this._sizeGradientsTexture.dispose(),this._sizeGradientsTexture=null),this._angularSpeedGradientsTexture&&(this._angularSpeedGradientsTexture.dispose(),this._angularSpeedGradientsTexture=null),this._velocityGradientsTexture&&(this._velocityGradientsTexture.dispose(),this._velocityGradientsTexture=null),this._limitVelocityGradientsTexture&&(this._limitVelocityGradientsTexture.dispose(),this._limitVelocityGradientsTexture=null),this._dragGradientsTexture&&(this._dragGradientsTexture.dispose(),this._dragGradientsTexture=null),this._randomTexture&&(this._randomTexture.dispose(),this._randomTexture=null),this._randomTexture2&&(this._randomTexture2.dispose(),this._randomTexture2=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this.onStoppedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}clone(e,t,i=!1){const s=Object.assign({},this._customWrappers);let r=null;const n=this._engine;if(n.createEffectForParticles&&null!=this.customShader){r=this.customShader;const e=r.shaderOptions.defines.length>0?r.shaderOptions.defines.join("\n"):"";s[0]=n.createEffectForParticles(r.shaderPath.fragmentElement,r.shaderOptions.uniforms,r.shaderOptions.samplers,e,void 0,void 0,void 0,this)}const o=this.serialize(i),a=pg.Parse(o,this._scene||this._engine,this._rootUrl);return a.name=e,a.customShader=r,a._customWrappers=s,void 0===t&&(t=this.emitter),this.noiseTexture&&(a.noiseTexture=this.noiseTexture.clone()),a.emitter=t,a}serialize(e=!1){const t={};return dg._Serialize(t,this,e),t.activeParticleCount=this.activeParticleCount,t.randomTextureSize=this._randomTextureSize,t.customShader=this.customShader,t}static Parse(e,t,i,s=!1,r){const n=e.name;let o,a;t instanceof bt?o=t:(a=t,o=a.getEngine());const l=new pg(n,{capacity:r||e.capacity,randomTextureSize:e.randomTextureSize},t,null,e.isAnimationSheetEnabled);if(l._rootUrl=i,e.customShader&&o.createEffectForParticles){const t=e.customShader,i=t.shaderOptions.defines.length>0?t.shaderOptions.defines.join("\n"):"",s=o.createEffectForParticles(t.shaderPath.fragmentElement,t.shaderOptions.uniforms,t.shaderOptions.samplers,i,void 0,void 0,void 0,l);l.setCustomEffect(s,0),l.customShader=t}return e.id&&(l.id=e.id),e.activeParticleCount&&(l.activeParticleCount=e.activeParticleCount),dg._Parse(e,l,t,i),e.preventAutoStart&&(l.preventAutoStart=e.preventAutoStart),s||l.preventAutoStart||l.start(),l}}class _g{constructor(){this._emitterNodeIsOwned=!0,this.systems=[]}get emitterNode(){return this._emitterNode}set emitterNode(e){this._emitterNodeIsOwned&&this._emitterNode&&(this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNodeIsOwned=!1);for(const t of this.systems)t.emitter=e;this._emitterNode=e}setEmitterAsSphere(e,t,i){this._emitterNodeIsOwned&&this._emitterNode&&this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNodeIsOwned=!0,this._emitterCreationOptions={kind:"Sphere",options:e,renderingGroupId:t};const s=Ol("emitterSphere",{diameter:e.diameter,segments:e.segments},i);s.renderingGroupId=t;const r=new Va("emitterSphereMaterial",i);r.emissiveColor=e.color,s.material=r;for(const e of this.systems)e.emitter=s;this._emitterNode=s}start(e){for(const t of this.systems)e&&(t.emitter=e),t.start()}dispose(){for(const e of this.systems)e.dispose();this.systems.length=0,this._emitterNode&&(this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNode=null)}serialize(e=!1){const t={systems:[]};for(const i of this.systems)t.systems.push(i.serialize(e));return this._emitterNode&&(t.emitter=this._emitterCreationOptions),t}static Parse(e,t,i=!1,s){const r=new _g,n=this.BaseAssetsUrl+"/textures/";t=t||x.LastCreatedScene;for(const o of e.systems)r.systems.push(i?pg.Parse(o,t,n,!0,s):dg.Parse(o,t,n,!0,s));if(e.emitter){const i=e.emitter.options;"Sphere"===e.emitter.kind&&r.setEmitterAsSphere({diameter:i.diameter,segments:i.segments,color:N.FromArray(i.color)},e.emitter.renderingGroupId,t)}return r}}_g.BaseAssetsUrl="https://assets.babylonjs.com/particles";class fg{static CreateDefault(e,t=500,i,s=!1){let r;return r=s?new pg("default system",{capacity:t},i):new dg("default system",t,i),r.emitter=e,r.particleTexture=new Ar("https://assets.babylonjs.com/textures/flare.png",r.getScene()),r.createConeEmitter(.1,Math.PI/4),r.color1=new F(1,1,1,1),r.color2=new F(1,1,1,1),r.colorDead=new F(1,1,1,0),r.minSize=.1,r.maxSize=.1,r.minEmitPower=2,r.maxEmitPower=2,r.updateSpeed=1/60,r.emitRate=30,r}static CreateAsync(e,t,i=!1,s){t||(t=x.LastCreatedScene);const r={};return t.addPendingData(r),new Promise(((n,o)=>{if(i&&!pg.IsSupported)return t.removePendingData(r),o("Particle system with GPU is not supported.");Ht.LoadFile(`${fg.BaseAssetsUrl}/systems/${e}.json`,(e=>{t.removePendingData(r);const o=JSON.parse(e.toString());return n(_g.Parse(o,t,i,s))}),void 0,void 0,void 0,(()=>(t.removePendingData(r),o(`An error occurred with the creation of your particle system. Check if your type '${e}' exists.`))))}))}static ExportSet(e){const t=new _g;for(const i of e)t.systems.push(i);return t}static ParseFromFileAsync(e,t,i,s=!1,r="",n){return new Promise(((o,a)=>{const l=new Te;l.addEventListener("readystatechange",(()=>{if(4==l.readyState)if(200==l.status){const t=JSON.parse(l.responseText);let a;a=s?pg.Parse(t,i,r,!1,n):dg.Parse(t,i,r,!1,n),e&&(a.name=e),o(a)}else a("Unable to load the particle system")})),l.open("GET",t),l.send()}))}static ParseFromSnippetAsync(e,t,i=!1,s="",r){if("_BLANK"===e){const e=this.CreateDefault(null);return e.start(),Promise.resolve(e)}return new Promise(((n,o)=>{const a=new Te;a.addEventListener("readystatechange",(()=>{if(4==a.readyState)if(200==a.status){const o=JSON.parse(JSON.parse(a.responseText).jsonPayload),l=JSON.parse(o.particleSystem);let h;h=i?pg.Parse(l,t,s,!1,r):dg.Parse(l,t,s,!1,r),h.snippetId=e,n(h)}else o("Unable to load the snippet "+e)})),a.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),a.send()}))}}var mg,gg,vg,xg,Tg,Eg,Sg,bg,Cg,yg,Ag,Rg,Ig,Pg,Mg,Og,Dg,Ng,Fg;fg.BaseAssetsUrl=_g.BaseAssetsUrl,fg.SnippetUrl="https://snippet.babylonjs.com",fg.CreateFromSnippetAsync=fg.ParseFromSnippetAsync,s.AddParser(fi.NAME_PARTICLESYSTEM,((e,t,i,r)=>{const n=s.GetIndividualParser(fi.NAME_PARTICLESYSTEM);if(n&&void 0!==e.particleSystems&&null!==e.particleSystems)for(let s=0,o=e.particleSystems.length;s<o;s++){const o=e.particleSystems[s];i.particleSystems.push(n(o,t,r))}})),s.AddIndividualParser(fi.NAME_PARTICLESYSTEM,((e,t,i)=>e.activeParticleCount?pg.Parse(e,t,i):dg.Parse(e,t,i))),Ns.prototype.createEffectForParticles=function(e,t=[],i=[],s="",r,n,o,a){var l;let h=[],c=[];const u=[];return a?a.fillUniformsAttributesAndSamplerNames(c,h,u):(h=dg._GetAttributeNamesOrOptions(),c=dg._GetEffectCreationOptions()),-1===s.indexOf(" BILLBOARD")&&(s+="\n#define BILLBOARD\n"),(null==a?void 0:a.isAnimationSheetEnabled)&&-1===s.indexOf(" ANIMATESHEET")&&(s+="\n#define ANIMATESHEET\n"),-1===i.indexOf("diffuseSampler")&&i.push("diffuseSampler"),this.createEffect({vertex:null!==(l=null==a?void 0:a.vertexShaderName)&&void 0!==l?l:"particles",fragmentElement:e},h,c.concat(t),u.concat(i),s,r,n,o)},ur.prototype.getEmittedParticleSystems=function(){const e=[];for(let t=0;t<this.getScene().particleSystems.length;t++){const i=this.getScene().particleSystems[t];i.emitter===this&&e.push(i)}return e},ur.prototype.getHierarchyEmittedParticleSystems=function(){const e=[],t=this.getDescendants();t.push(this);for(let i=0;i<this.getScene().particleSystems.length;i++){const s=this.getScene().particleSystems[i],r=s.emitter;r.position&&-1!==t.indexOf(r)&&e.push(s)}return e},function(e){e[e.Color=2]="Color",e[e.UV=1]="UV",e[e.Random=0]="Random",e[e.Stated=3]="Stated"}(mg||(mg={})),Object.defineProperty(Vs.prototype,"physicsImpostor",{get:function(){return this._physicsImpostor},set:function(e){this._physicsImpostor!==e&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsImpostor=e,e&&(this._disposePhysicsObserver=this.onDisposeObservable.add((()=>{this.physicsImpostor&&(this.physicsImpostor.dispose(),this.physicsImpostor=null)}))))},enumerable:!0,configurable:!0}),Vs.prototype.getPhysicsImpostor=function(){return this.physicsImpostor},Vs.prototype.applyImpulse=function(e,t){return this.physicsImpostor?(this.physicsImpostor.applyImpulse(e,t),this):this},Vs.prototype.setPhysicsLinkWith=function(e,t,i,s){return this.physicsImpostor&&e.physicsImpostor?(this.physicsImpostor.createJoint(e.physicsImpostor,zr.HingeJoint,{mainPivot:t,connectedPivot:i,nativeParams:s}),this):this};class wg{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw $("")}constructor(e,t=wg.DefaultPluginFactory()){this._physicsPlugin=t,this._physicsBodies=[],this._subTimeStep=0,e=e||new S(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}_step(e){e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._physicsBodies)}addBody(e){this._physicsBodies.push(e)}removeBody(e){const t=this._physicsBodies.indexOf(e);t>-1&&this._physicsBodies.splice(t,1)}getBodies(){return this._physicsBodies}getPhysicsPlugin(){return this._physicsPlugin}raycastToRef(e,t,i,s){this._physicsPlugin.raycast(e,t,i,s)}raycast(e,t,i){const s=new Zp;return this._physicsPlugin.raycast(e,t,s,i),s}}(Ng=gg||(gg={}))[Ng.FREE=0]="FREE",Ng[Ng.LIMITED=1]="LIMITED",Ng[Ng.LOCKED=2]="LOCKED",(Dg=vg||(vg={}))[Dg.LINEAR_X=0]="LINEAR_X",Dg[Dg.LINEAR_Y=1]="LINEAR_Y",Dg[Dg.LINEAR_Z=2]="LINEAR_Z",Dg[Dg.ANGULAR_X=3]="ANGULAR_X",Dg[Dg.ANGULAR_Y=4]="ANGULAR_Y",Dg[Dg.ANGULAR_Z=5]="ANGULAR_Z",Dg[Dg.LINEAR_DISTANCE=6]="LINEAR_DISTANCE",(Og=xg||(xg={}))[Og.BALL_AND_SOCKET=1]="BALL_AND_SOCKET",Og[Og.DISTANCE=2]="DISTANCE",Og[Og.HINGE=3]="HINGE",Og[Og.SLIDER=4]="SLIDER",Og[Og.LOCK=5]="LOCK",Og[Og.PRISMATIC=6]="PRISMATIC",Og[Og.SIX_DOF=7]="SIX_DOF",(Mg=Tg||(Tg={}))[Mg.SPHERE=0]="SPHERE",Mg[Mg.CAPSULE=1]="CAPSULE",Mg[Mg.CYLINDER=2]="CYLINDER",Mg[Mg.BOX=3]="BOX",Mg[Mg.CONVEX_HULL=4]="CONVEX_HULL",Mg[Mg.CONTAINER=5]="CONTAINER",Mg[Mg.MESH=6]="MESH",Mg[Mg.HEIGHTFIELD=7]="HEIGHTFIELD",(Pg=Eg||(Eg={}))[Pg.NONE=0]="NONE",Pg[Pg.VELOCITY=1]="VELOCITY",Pg[Pg.POSITION=2]="POSITION",(Ig=Sg||(Sg={})).COLLISION_STARTED="COLLISION_STARTED",Ig.COLLISION_CONTINUED="COLLISION_CONTINUED",Ig.COLLISION_FINISHED="COLLISION_FINISHED",Ig.TRIGGER_ENTERED="TRIGGER_ENTERED",Ig.TRIGGER_EXITED="TRIGGER_EXITED",(Rg=bg||(bg={}))[Rg.STATIC=0]="STATIC",Rg[Rg.ANIMATED=1]="ANIMATED",Rg[Rg.DYNAMIC=2]="DYNAMIC",(Fg=Cg||(Cg={}))[Fg.GEOMETRIC_MEAN=0]="GEOMETRIC_MEAN",Fg[Fg.MINIMUM=1]="MINIMUM",Fg[Fg.MAXIMUM=2]="MAXIMUM",Fg[Fg.ARITHMETIC_MEAN=3]="ARITHMETIC_MEAN",Fg[Fg.MULTIPLY=4]="MULTIPLY",Yi.prototype.getPhysicsEngine=function(){return this._physicsEngine},Yi.prototype.enablePhysics=function(e=null,t){if(this._physicsEngine)return!0;let i=this._getComponent(fi.NAME_PHYSICSENGINE);i||(i=new Lg(this),this._addComponent(i));try{if(t&&1!==(null==t?void 0:t.getPluginVersion())){if(2!==(null==t?void 0:t.getPluginVersion()))throw new Error("Unsupported Physics plugin version.");this._physicsEngine=new wg(e,t)}else this._physicsEngine=new Jp(e,t);return this._physicsTimeAccumulator=0,!0}catch(e){return k.Error(e.message),!1}},Yi.prototype.disablePhysicsEngine=function(){this._physicsEngine&&(this._physicsEngine.dispose(),this._physicsEngine=null)},Yi.prototype.isPhysicsEnabled=function(){return void 0!==this._physicsEngine},Yi.prototype.deleteCompoundImpostor=function(e){const t=e.parts[0].mesh;t.physicsImpostor&&(t.physicsImpostor.dispose(),t.physicsImpostor=null)},Yi.prototype._advancePhysicsEngineStep=function(e){if(this._physicsEngine){const t=this._physicsEngine.getSubTimeStep();if(t>0)for(this._physicsTimeAccumulator+=e;this._physicsTimeAccumulator>t;)this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(t/1e3),this.onAfterPhysicsObservable.notifyObservers(this),this._physicsTimeAccumulator-=t;else this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(e/1e3),this.onAfterPhysicsObservable.notifyObservers(this)}};class Lg{constructor(e){this.name=fi.NAME_PHYSICSENGINE,this.scene=e,this.scene.onBeforePhysicsObservable=new a,this.scene.onAfterPhysicsObservable=new a,this.scene.getDeterministicFrameTime=()=>this.scene._physicsEngine?1e3*this.scene._physicsEngine.getTimeStep():1e3/60}register(){}rebuild(){}dispose(){this.scene.onBeforePhysicsObservable.clear(),this.scene.onAfterPhysicsObservable.clear(),this.scene._physicsEngine&&this.scene.disablePhysicsEngine()}}Object.defineProperty(ws.prototype,"physicsBody",{get:function(){return this._physicsBody},set:function(e){this._physicsBody!==e&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsBody=e,e&&(this._disposePhysicsObserver=this.onDisposeObservable.add((()=>{this.physicsBody&&(this.physicsBody.dispose(),this.physicsBody=null)}))))},enumerable:!0,configurable:!0}),ws.prototype.getPhysicsBody=function(){return this.physicsBody},ws.prototype.applyImpulse=function(e,t){if(!this.physicsBody)throw new Error("No Physics Body for TransformNode");return this.physicsBody.applyImpulse(e,t),this};class Bg{static GetContactPointToRef(e,t,i,s,r){const n=e.getScene().getPhysicsEngine(),o=null==n?void 0:n.getPluginVersion();if(1===o){const r=new Fr(t,i).intersectsMesh(e);if(r.hit&&r.pickedPoint)return s.copyFrom(r.pickedPoint),!0}else if(2===o)return e.physicsBody.getObjectCenterWorldToRef(s,r),!0;return!1}static HasAppliedForces(e,t){var i,s,r;return e.getMotionType(t)===bg.STATIC||0===(null!==(s=null===(i=e.getMassProperties(t))||void 0===i?void 0:i.mass)&&void 0!==s?s:0)||0===(null===(r=e.transformNode)||void 0===r?void 0:r.getTotalVertices())}static IsInsideCylinder(e,t,i,s){const r=R.Vector3[0];return e.subtractToRef(t,r),Math.abs(r.x)<=i&&Math.abs(r.z)<=i&&r.y>=0&&r.y<=s}}class Ug{constructor(e,t,i){this._scene=e,this._origin=t,this._options=i,this._originTop=S.Zero(),this._originDirection=S.Zero(),this._cylinderPosition=S.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._options=Object.assign(Object.assign({},new kg),this._options),this._origin.addToRef(new S(0,this._options.height/2,0),this._cylinderPosition),this._origin.addToRef(new S(0,this._options.height,0),this._originTop),this._options.updraftMode===Ag.Perpendicular&&(this._originDirection=this._origin.subtract(this._originTop).normalize()),this._tickCallback=()=>this._tick(),1===this._physicsEngine.getPluginVersion()&&this._prepareCylinder()}getData(){return this._dataFetched=!0,{cylinder:this._cylinder}}enable(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)}disable(){this._scene.unregisterBeforeRender(this._tickCallback)}dispose(e=!0){this._cylinder&&(e?(this._cylinder.dispose(),this._cylinder=void 0):setTimeout((()=>{!this._dataFetched&&this._cylinder&&(this._cylinder.dispose(),this._cylinder=void 0)}),0))}_getHitData(e,t){let i;i=this._options.updraftMode===Ag.Perpendicular?this._originDirection:e.subtract(this._originTop);const s=S.Distance(this._origin,e),r=-1*this._options.strength,n=i.multiplyByFloats(r,r,r);t.force.copyFrom(n),t.contactPoint.copyFrom(e),t.distanceFromOrigin=s}_getBodyHitData(e,t,i){if(Bg.HasAppliedForces(e))return!1;const s=e.getObjectCenterWorld(i);return!!Bg.IsInsideCylinder(s,this._origin,this._options.radius,this._options.height)&&(t.instanceIndex=i,this._getHitData(s,t),!0)}_getImpostorHitData(e,t){if(0===e.mass)return!1;const i=e.object;if(!this._intersectsWithCylinder(i))return!1;const s=e.getObjectCenter();return this._getHitData(s,t),!0}_tick(){const e=Ug._HitData;1===this._physicsEngine.getPluginVersion()?this._physicsEngine.getImpostors().forEach((t=>{this._getImpostorHitData(t,e)&&t.applyForce(e.force,e.contactPoint)})):this._physicsEngine.getBodies().forEach((t=>{t.iterateOverAllInstances(((t,i)=>{this._getBodyHitData(t,e,i)&&t.applyForce(e.force,e.contactPoint,e.instanceIndex)}))}))}_prepareCylinder(){this._cylinder||(this._cylinder=bl("updraftEventCylinder",{height:this._options.height,diameter:2*this._options.radius},this._scene),this._cylinder.isVisible=!1)}_intersectsWithCylinder(e){return!!this._cylinder&&(this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(e,!0))}}Ug._HitData={force:new S,contactPoint:new S,distanceFromOrigin:0};class Vg{constructor(e,t,i){this._scene=e,this._origin=t,this._options=i,this._originTop=S.Zero(),this._cylinderPosition=S.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._options=Object.assign(Object.assign({},new Gg),this._options),this._origin.addToRef(new S(0,this._options.height/2,0),this._cylinderPosition),this._origin.addToRef(new S(0,this._options.height,0),this._originTop),this._tickCallback=()=>this._tick(),1===this._physicsEngine.getPluginVersion()&&this._prepareCylinder()}getData(){return this._dataFetched=!0,{cylinder:this._cylinder}}enable(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)}disable(){this._scene.unregisterBeforeRender(this._tickCallback)}dispose(e=!0){this._cylinder&&(e?this._cylinder.dispose():setTimeout((()=>{this._dataFetched||this._cylinder.dispose()}),0))}_getHitData(e,t,i){const s=Vg.originOnPlane;s.set(this._origin.x,t.y,this._origin.z);const r=R.Vector3[0];t.subtractToRef(s,r);const n=R.Vector3[1];if(!Bg.GetContactPointToRef(e,s,r,n,i.instanceIndex))return!1;const o=S.Distance(n,s)/this._options.radius,a=R.Vector3[2];let l,h,c;if(n.normalizeToRef(a),o>this._options.centripetalForceThreshold&&a.negateInPlace(),o>this._options.centripetalForceThreshold)l=a.x*this._options.centripetalForceMultiplier,h=a.y*this._options.updraftForceMultiplier,c=a.z*this._options.centripetalForceMultiplier;else{const e=S.Cross(s,t).normalize();l=(e.x+a.x)*this._options.centrifugalForceMultiplier,h=this._originTop.y*this._options.updraftForceMultiplier,c=(e.z+a.z)*this._options.centrifugalForceMultiplier}const u=R.Vector3[3];return u.set(l,h,c),u.scaleInPlace(this._options.strength),i.force.copyFrom(u),i.contactPoint.copyFrom(t),i.distanceFromOrigin=o,!0}_getBodyHitData(e,t,i){if(Bg.HasAppliedForces(e,i))return!1;const s=e.transformNode,r=e.getObjectCenterWorld(i);return!!Bg.IsInsideCylinder(r,this._origin,this._options.radius,this._options.height)&&(t.instanceIndex=i,this._getHitData(s,r,t))}_getImpostorHitData(e,t){if(0===e.mass)return!1;if("Mesh"!==e.object.getClassName()&&"InstancedMesh"!==e.object.getClassName())return!1;const i=e.object;if(!this._intersectsWithCylinder(i))return!1;const s=e.getObjectCenter();return this._getHitData(i,s,t),!0}_tick(){const e=Vg.hitData;1===this._physicsEngine.getPluginVersion()?this._physicsEngine.getImpostors().forEach((t=>{this._getImpostorHitData(t,e)&&t.applyForce(e.force,e.contactPoint)})):this._physicsEngine.getBodies().forEach((t=>{t.iterateOverAllInstances(((t,i)=>{this._getBodyHitData(t,e,i)&&t.applyForce(e.force,e.contactPoint,e.instanceIndex)}))}))}_prepareCylinder(){this._cylinder||(this._cylinder=bl("vortexEventCylinder",{height:this._options.height,diameter:2*this._options.radius},this._scene),this._cylinder.isVisible=!1)}_intersectsWithCylinder(e){return this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(e,!0)}}Vg.originOnPlane=S.Zero(),Vg.hitData={force:new S,contactPoint:new S,distanceFromOrigin:0};class kg{constructor(){this.radius=5,this.strength=10,this.height=10,this.updraftMode=Ag.Center}}class Gg{constructor(){this.radius=5,this.strength=10,this.height=10,this.centripetalForceThreshold=.7,this.centripetalForceMultiplier=5,this.centrifugalForceMultiplier=.5,this.updraftForceMultiplier=.02}}!function(e){e[e.Constant=0]="Constant",e[e.Linear=1]="Linear"}(yg||(yg={})),function(e){e[e.Center=0]="Center",e[e.Perpendicular=1]="Perpendicular"}(Ag||(Ag={}));nt.ShadersStore.blackAndWhitePixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform float degree;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec3 color=texture2D(textureSampler,vUV).rgb;float luminance=dot(color,vec3(0.3,0.59,0.11)); \nvec3 blackAndWhite=vec3(luminance,luminance,luminance);gl_FragColor=vec4(color-((color-blackAndWhite)*degree),1.0);}";class zg extends dn{getClassName(){return"BlackAndWhitePostProcess"}constructor(e,t,i,s,r,n){super(e,"blackAndWhite",["degree"],null,t,i,s,r,n),this.degree=1,this.onApplyObservable.add((e=>{e.setFloat("degree",this.degree)}))}static _Parse(e,t,i,s){return de.Parse((()=>new zg(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}me([ie()],zg.prototype,"degree",void 0),m("BABYLON.BlackAndWhitePostProcess",zg);class Wg{constructor(e,t,i,s){this._name=t,this._singleInstance=s||!0,this._getPostProcesses=i,this._cameras={},this._indicesForCamera={},this._postProcesses={}}get isSupported(){for(const e in this._postProcesses)if(Object.prototype.hasOwnProperty.call(this._postProcesses,e)){const t=this._postProcesses[e];for(let e=0;e<t.length;e++)if(!t[e].isSupported)return!1}return!0}_update(){}_attachCameras(e){let t;const i=Ht.MakeArray(e||this._cameras);if(i)for(let e=0;e<i.length;e++){const s=i[e];if(!s)continue;const r=s.name;if(t=this._singleInstance?0:r,!this._postProcesses[t]){const e=this._getPostProcesses();e&&(this._postProcesses[t]=Array.isArray(e)?e:[e])}this._indicesForCamera[r]||(this._indicesForCamera[r]=[]),this._postProcesses[t].forEach((e=>{const t=s.attachPostProcess(e);this._indicesForCamera[r].push(t)})),this._cameras[r]||(this._cameras[r]=s)}}_detachCameras(e){const t=Ht.MakeArray(e||this._cameras);if(t)for(let e=0;e<t.length;e++){const i=t[e],s=i.name,r=this._postProcesses[this._singleInstance?0:s];r&&r.forEach((e=>{i.detachPostProcess(e)})),this._cameras[s]&&(this._cameras[s]=null),delete this._indicesForCamera[s]}}_enable(e){const t=Ht.MakeArray(e||this._cameras);if(t)for(let e=0;e<t.length;e++){const i=t[e],s=i.name,r=this._singleInstance?0:s;for(let n=0;n<this._indicesForCamera[s].length;n++){const o=this._indicesForCamera[s][n];null==i._postProcesses[o]&&t[e].attachPostProcess(this._postProcesses[r][n],o)}}}_disable(e){const t=Ht.MakeArray(e||this._cameras);if(t)for(let e=0;e<t.length;e++){const i=t[e],s=i.name;this._postProcesses[this._singleInstance?0:s].forEach((e=>{i.detachPostProcess(e)}))}}getPostProcesses(e){return this._singleInstance?this._postProcesses[0]:e?this._postProcesses[e.name]:null}}nt.ShadersStore.extractHighlightsPixelShader="#include<helperFunctions>\nvarying vec2 vUV;uniform sampler2D textureSampler;uniform float threshold;uniform float exposure;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=texture2D(textureSampler,vUV);float luma=dot(LuminanceEncodeApprox,gl_FragColor.rgb*exposure);gl_FragColor.rgb=step(threshold,luma)*gl_FragColor.rgb;}";class Hg extends dn{getClassName(){return"ExtractHighlightsPostProcess"}constructor(e,t,i,s,r,n,o=0,a=!1){super(e,"extractHighlights",["threshold","exposure"],null,t,i,s,r,n,null,o,void 0,null,a),this.threshold=.9,this._exposure=1,this._inputPostProcess=null,this.onApplyObservable.add((e=>{this.externalTextureSamplerBinding=!!this._inputPostProcess,this._inputPostProcess&&e.setTextureFromPostProcess("textureSampler",this._inputPostProcess),e.setFloat("threshold",Math.pow(this.threshold,h)),e.setFloat("exposure",this._exposure)}))}}me([ie()],Hg.prototype,"threshold",void 0),m("BABYLON.ExtractHighlightsPostProcess",Hg);nt.ShadersStore.bloomMergePixelShader="uniform sampler2D textureSampler;uniform sampler2D bloomBlur;varying vec2 vUV;uniform float bloomWeight;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{gl_FragColor=texture2D(textureSampler,vUV);vec3 blurred=texture2D(bloomBlur,vUV).rgb;gl_FragColor.rgb=gl_FragColor.rgb+(blurred.rgb*bloomWeight); }\n";class Xg extends dn{getClassName(){return"BloomMergePostProcess"}constructor(e,t,i,s,r,n,o,a,l,h=0,c=!1){super(e,"bloomMerge",["bloomWeight"],["bloomBlur"],r,n,o,a,l,null,h,void 0,null,!0),this.weight=1,this.weight=s,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("textureSampler",t),e.setTextureFromPostProcessOutput("bloomBlur",i),e.setFloat("bloomWeight",this.weight)})),c||this.updateEffect()}}me([ie()],Xg.prototype,"weight",void 0),m("BABYLON.BloomMergePostProcess",Xg);class Yg extends Wg{get threshold(){return this._downscale.threshold}set threshold(e){this._downscale.threshold=e}get weight(){return this._merge.weight}set weight(e){this._merge.weight=e}get kernel(){return this._blurX.kernel/this._bloomScale}set kernel(e){this._blurX.kernel=e*this._bloomScale,this._blurY.kernel=e*this._bloomScale}constructor(e,t,i,s,r=0,n=!1){super(e.getEngine(),"bloom",(()=>this._effects),!0),this._bloomScale=t,this._effects=[],this._downscale=new Hg("highlights",1,null,Ar.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,r,n),this._blurX=new hd("horizontal blur",new E(1,0),10,t,null,Ar.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,r,void 0,n),this._blurX.alwaysForcePOT=!0,this._blurX.autoClear=!1,this._blurY=new hd("vertical blur",new E(0,1),10,t,null,Ar.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,r,void 0,n),this._blurY.alwaysForcePOT=!0,this._blurY.autoClear=!1,this.kernel=s,this._effects=[this._downscale,this._blurX,this._blurY],this._merge=new Xg("bloomMerge",this._downscale,this._blurY,i,t,null,Ar.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,r,n),this._merge.autoClear=!1,this._effects.push(this._merge)}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){for(let e=0;e<this._effects.length;e++)if(!this._effects[e].isReady())return!1;return!0}}nt.ShadersStore.chromaticAberrationPixelShader="uniform sampler2D textureSampler; \nuniform float chromatic_aberration;uniform float radialIntensity;uniform vec2 direction;uniform vec2 centerPosition;uniform float screen_width;uniform float screen_height;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec2 centered_screen_pos=vec2(vUV.x-centerPosition.x,vUV.y-centerPosition.y);vec2 directionOfEffect=direction;if(directionOfEffect.x==0. && directionOfEffect.y==0.){directionOfEffect=normalize(centered_screen_pos);}\nfloat radius2=centered_screen_pos.x*centered_screen_pos.x\n+ centered_screen_pos.y*centered_screen_pos.y;float radius=sqrt(radius2);vec4 original=texture2D(textureSampler,vUV);vec3 ref_indices=vec3(-0.3,0.0,0.3);float ref_shiftX=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.x/screen_width;float ref_shiftY=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.y/screen_height;vec2 ref_coords_r=vec2(vUV.x+ref_indices.r*ref_shiftX,vUV.y+ref_indices.r*ref_shiftY*0.5);vec2 ref_coords_g=vec2(vUV.x+ref_indices.g*ref_shiftX,vUV.y+ref_indices.g*ref_shiftY*0.5);vec2 ref_coords_b=vec2(vUV.x+ref_indices.b*ref_shiftX,vUV.y+ref_indices.b*ref_shiftY*0.5);original.r=texture2D(textureSampler,ref_coords_r).r;original.g=texture2D(textureSampler,ref_coords_g).g;original.b=texture2D(textureSampler,ref_coords_b).b;original.a=clamp(texture2D(textureSampler,ref_coords_r).a+texture2D(textureSampler,ref_coords_g).a+texture2D(textureSampler,ref_coords_b).a,0.,1.);gl_FragColor=original;}";class jg extends dn{getClassName(){return"ChromaticAberrationPostProcess"}constructor(e,t,i,s,r,n,o,a,l=0,h=!1){super(e,"chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],s,r,n,o,a,null,l,void 0,null,h),this.aberrationAmount=30,this.radialIntensity=0,this.direction=new E(.707,.707),this.centerPosition=new E(.5,.5),this.screenWidth=t,this.screenHeight=i,this.onApplyObservable.add((e=>{e.setFloat("chromatic_aberration",this.aberrationAmount),e.setFloat("screen_width",t),e.setFloat("screen_height",i),e.setFloat("radialIntensity",this.radialIntensity),e.setFloat2("direction",this.direction.x,this.direction.y),e.setFloat2("centerPosition",this.centerPosition.x,this.centerPosition.y)}))}static _Parse(e,t,i,s){return de.Parse((()=>new jg(e.name,e.screenWidth,e.screenHeight,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,!1)),e,i,s)}}me([ie()],jg.prototype,"aberrationAmount",void 0),me([ie()],jg.prototype,"radialIntensity",void 0),me([ie()],jg.prototype,"direction",void 0),me([ie()],jg.prototype,"centerPosition",void 0),me([ie()],jg.prototype,"screenWidth",void 0),me([ie()],jg.prototype,"screenHeight",void 0),m("BABYLON.ChromaticAberrationPostProcess",jg);nt.ShadersStore.circleOfConfusionPixelShader="uniform sampler2D depthSampler;varying vec2 vUV;uniform vec2 cameraMinMaxZ;uniform float focusDistance;uniform float cocPrecalculation;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float depth=texture2D(depthSampler,vUV).r;\n#define CUSTOM_COC_DEPTH\nfloat pixelDistance=(cameraMinMaxZ.x+cameraMinMaxZ.y*depth)*1000.0; \n#define CUSTOM_COC_PIXELDISTANCE\nfloat coc=abs(cocPrecalculation*((focusDistance-pixelDistance)/pixelDistance));coc=clamp(coc,0.0,1.0);gl_FragColor=vec4(coc,coc,coc,1.0);}\n";class Kg extends dn{getClassName(){return"CircleOfConfusionPostProcess"}constructor(e,t,i,s,r,n,o,a=0,l=!1){super(e,"circleOfConfusion",["cameraMinMaxZ","focusDistance","cocPrecalculation"],["depthSampler"],i,s,r,n,o,null,a,void 0,null,l),this.lensSize=50,this.fStop=1.4,this.focusDistance=2e3,this.focalLength=50,this._depthTexture=null,this._depthTexture=t,this.onApplyObservable.add((e=>{if(!this._depthTexture)return void k.Warn("No depth texture set on CircleOfConfusionPostProcess");e.setTexture("depthSampler",this._depthTexture);const t=this.lensSize/this.fStop*this.focalLength/(this.focusDistance-this.focalLength);e.setFloat("focusDistance",this.focusDistance),e.setFloat("cocPrecalculation",t);const i=this._depthTexture.activeCamera;e.setFloat2("cameraMinMaxZ",i.minZ,i.maxZ-i.minZ)}))}set depthTexture(e){this._depthTexture=e}}me([ie()],Kg.prototype,"lensSize",void 0),me([ie()],Kg.prototype,"fStop",void 0),me([ie()],Kg.prototype,"focusDistance",void 0),me([ie()],Kg.prototype,"focalLength",void 0),m("BABYLON.CircleOfConfusionPostProcess",Kg);nt.ShadersStore.colorCorrectionPixelShader="uniform sampler2D textureSampler; \nuniform sampler2D colorTable; \nvarying vec2 vUV;const float SLICE_COUNT=16.0; \nvec4 sampleAs3DTexture(sampler2D textureSampler,vec3 uv,float width) {float sliceSize=1.0/width; \nfloat slicePixelSize=sliceSize/width; \nfloat sliceInnerSize=slicePixelSize*(width-1.0); \nfloat zSlice0=min(floor(uv.z*width),width-1.0);float zSlice1=min(zSlice0+1.0,width-1.0);float xOffset=slicePixelSize*0.5+uv.x*sliceInnerSize;float s0=xOffset+(zSlice0*sliceSize);float s1=xOffset+(zSlice1*sliceSize);vec4 slice0Color=texture2D(textureSampler,vec2(s0,uv.y));vec4 slice1Color=texture2D(textureSampler,vec2(s1,uv.y));float zOffset=mod(uv.z*width,1.0);vec4 result=mix(slice0Color,slice1Color,zOffset);return result;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 screen_color=texture2D(textureSampler,vUV);gl_FragColor=sampleAs3DTexture(colorTable,screen_color.rgb,SLICE_COUNT);}";class $g extends dn{getClassName(){return"ColorCorrectionPostProcess"}constructor(e,t,i,s,r,n,o){super(e,"colorCorrection",null,["colorTable"],i,s,r,n,o);const a=(null==s?void 0:s.getScene())||null;this._colorTableTexture=new Ar(t,a,!0,!1,Ar.TRILINEAR_SAMPLINGMODE),this._colorTableTexture.anisotropicFilteringLevel=1,this._colorTableTexture.wrapU=Ar.CLAMP_ADDRESSMODE,this._colorTableTexture.wrapV=Ar.CLAMP_ADDRESSMODE,this.colorTableUrl=t,this.onApply=e=>{e.setTexture("colorTable",this._colorTableTexture)}}static _Parse(e,t,i,s){return de.Parse((()=>new $g(e.name,e.colorTableUrl,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}me([ie()],$g.prototype,"colorTableUrl",void 0),m("BABYLON.ColorCorrectionPostProcess",$g);nt.ShadersStore.convolutionPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform float kernel[9];\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec2 onePixel=vec2(1.0,1.0)/screenSize;vec4 colorSum =\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,-1))*kernel[0] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,-1))*kernel[1] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,-1))*kernel[2] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,0))*kernel[3] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,0))*kernel[4] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,0))*kernel[5] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,1))*kernel[6] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,1))*kernel[7] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,1))*kernel[8];float kernelWeight =\nkernel[0] +\nkernel[1] +\nkernel[2] +\nkernel[3] +\nkernel[4] +\nkernel[5] +\nkernel[6] +\nkernel[7] +\nkernel[8];if (kernelWeight<=0.0) {kernelWeight=1.0;}\ngl_FragColor=vec4((colorSum/kernelWeight).rgb,1);}";class qg extends dn{getClassName(){return"ConvolutionPostProcess"}constructor(e,t,i,s,r,n,o,a=0){super(e,"convolution",["kernel","screenSize"],null,i,s,r,n,o,null,a),this.kernel=t,this.onApply=e=>{e.setFloat2("screenSize",this.width,this.height),e.setArray("kernel",this.kernel)}}static _Parse(e,t,i,s){return de.Parse((()=>new qg(e.name,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType)),e,i,s)}}qg.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1],qg.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0],qg.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1],qg.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0],qg.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2],qg.GaussianKernel=[0,1,0,1,1,1,0,1,0],me([ie()],qg.prototype,"kernel",void 0),m("BABYLON.ConvolutionPostProcess",qg);class Qg extends hd{getClassName(){return"DepthOfFieldBlurPostProcess"}constructor(e,t,i,s,r,n,o,a=null,l=Ar.BILINEAR_SAMPLINGMODE,h,c,u=0,d=!1,p=5){super(e,i,s,r,n,2,h,c,u,"#define DOF 1\n",d,p),this.direction=i,this.externalTextureSamplerBinding=!!a,this.onApplyObservable.add((e=>{null!=a&&e.setTextureFromPostProcess("textureSampler",a),e.setTextureFromPostProcessOutput("circleOfConfusionSampler",o)}))}}me([ie()],Qg.prototype,"direction",void 0),m("BABYLON.DepthOfFieldBlurPostProcess",Qg);nt.ShadersStore.depthOfFieldMergePixelShader="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)\n#else\n#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)\n#endif\nuniform sampler2D textureSampler;varying vec2 vUV;uniform sampler2D circleOfConfusionSampler;uniform sampler2D blurStep0;\n#if BLUR_LEVEL>0\nuniform sampler2D blurStep1;\n#endif\n#if BLUR_LEVEL>1\nuniform sampler2D blurStep2;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float coc=TEXTUREFUNC(circleOfConfusionSampler,vUV,0.0).r;\n#if BLUR_LEVEL==0\nvec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);gl_FragColor=mix(original,blurred0,coc);\n#endif\n#if BLUR_LEVEL==1\nif(coc<0.5){vec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(original,blurred1,coc/0.5);}else{vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(blurred1,blurred0,(coc-0.5)/0.5);}\n#endif\n#if BLUR_LEVEL==2\nif(coc<0.33){vec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred2=TEXTUREFUNC(blurStep2,vUV,0.0);gl_FragColor=mix(original,blurred2,coc/0.33);}else if(coc<0.66){vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);vec4 blurred2=TEXTUREFUNC(blurStep2,vUV,0.0);gl_FragColor=mix(blurred2,blurred1,(coc-0.33)/0.33);}else{vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(blurred1,blurred0,(coc-0.66)/0.34);}\n#endif\n}\n";class Zg extends dn{getClassName(){return"DepthOfFieldMergePostProcess"}constructor(e,t,i,s,r,n,o,a,l,h=0,c=!1){super(e,"depthOfFieldMerge",[],["circleOfConfusionSampler","blurStep0","blurStep1","blurStep2"],r,n,o,a,l,null,h,void 0,null,!0),this._blurSteps=s,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("textureSampler",t),e.setTextureFromPostProcessOutput("circleOfConfusionSampler",i),s.forEach(((t,i)=>{e.setTextureFromPostProcessOutput("blurStep"+(s.length-i-1),t)}))})),c||this.updateEffect()}updateEffect(e=null,t=null,i=null,s,r,n){e||(e="",e+="#define BLUR_LEVEL "+(this._blurSteps.length-1)+"\n"),super.updateEffect(e,t,i,s,r,n)}}var Jg;!function(e){e[e.Low=0]="Low",e[e.Medium=1]="Medium",e[e.High=2]="High"}(Jg||(Jg={}));class ev extends Wg{set focalLength(e){this._circleOfConfusion.focalLength=e}get focalLength(){return this._circleOfConfusion.focalLength}set fStop(e){this._circleOfConfusion.fStop=e}get fStop(){return this._circleOfConfusion.fStop}set focusDistance(e){this._circleOfConfusion.focusDistance=e}get focusDistance(){return this._circleOfConfusion.focusDistance}set lensSize(e){this._circleOfConfusion.lensSize=e}get lensSize(){return this._circleOfConfusion.lensSize}constructor(e,t,i=Jg.Low,s=0,r=!1){super(e.getEngine(),"depth of field",(()=>this._effects),!0),this._effects=[];const n=e.getEngine(),o=n.isWebGPU||n.webGLVersion>1?6:5;this._circleOfConfusion=new Kg("circleOfConfusion",t,1,null,Ar.BILINEAR_SAMPLINGMODE,n,!1,s,r),this._depthOfFieldBlurY=[],this._depthOfFieldBlurX=[];let a=1,l=15;switch(i){case Jg.High:a=3,l=51;break;case Jg.Medium:a=2,l=31;break;default:l=15,a=1}const h=l/Math.pow(2,a-1);let c=1;for(let t=0;t<a;t++){const i=new Qg("vertical blur",e,new E(0,1),h,c,null,this._circleOfConfusion,0==t?this._circleOfConfusion:null,Ar.BILINEAR_SAMPLINGMODE,n,!1,s,r,0==t?o:5);i.autoClear=!1,c=.75/Math.pow(2,t);const a=new Qg("horizontal blur",e,new E(1,0),h,c,null,this._circleOfConfusion,null,Ar.BILINEAR_SAMPLINGMODE,n,!1,s,r);a.autoClear=!1,this._depthOfFieldBlurY.push(i),this._depthOfFieldBlurX.push(a)}this._effects=[this._circleOfConfusion];for(let e=0;e<this._depthOfFieldBlurX.length;e++)this._effects.push(this._depthOfFieldBlurY[e]),this._effects.push(this._depthOfFieldBlurX[e]);this._dofMerge=new Zg("dofMerge",this._circleOfConfusion,this._circleOfConfusion,this._depthOfFieldBlurX,c,null,Ar.BILINEAR_SAMPLINGMODE,n,!1,s,r),this._dofMerge.autoClear=!1,this._effects.push(this._dofMerge)}getClassName(){return"DepthOfFieldEffect"}set depthTexture(e){this._circleOfConfusion.depthTexture=e}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){for(let e=0;e<this._effects.length;e++)if(!this._effects[e].isReady())return!1;return!0}}nt.ShadersStore.displayPassPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D passSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{gl_FragColor=texture2D(passSampler,vUV);}";class tv extends dn{getClassName(){return"DisplayPassPostProcess"}constructor(e,t,i,s,r,n){super(e,"displayPass",["passSampler"],["passSampler"],t,i,s,r,n)}static _Parse(e,t,i,s){return de.Parse((()=>new tv(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}m("BABYLON.DisplayPassPostProcess",tv);nt.ShadersStore.filterPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform mat4 kernelMatrix;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec3 baseColor=texture2D(textureSampler,vUV).rgb;vec3 updatedColor=(kernelMatrix*vec4(baseColor,1.0)).rgb;gl_FragColor=vec4(updatedColor,1.0);}";class iv extends dn{getClassName(){return"FilterPostProcess"}constructor(e,t,i,s,r,n,o){super(e,"filter",["kernelMatrix"],null,i,s,r,n,o),this.kernelMatrix=t,this.onApply=e=>{e.setMatrix("kernelMatrix",this.kernelMatrix)}}static _Parse(e,t,i,s){return de.Parse((()=>new iv(e.name,e.kernelMatrix,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}me([ue()],iv.prototype,"kernelMatrix",void 0),m("BABYLON.FilterPostProcess",iv);nt.ShadersStore.fxaaPixelShader="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)\n#else\n#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)\n#endif\nuniform sampler2D textureSampler;uniform vec2 texelSize;varying vec2 vUV;varying vec2 sampleCoordS;varying vec2 sampleCoordE;varying vec2 sampleCoordN;varying vec2 sampleCoordW;varying vec2 sampleCoordNW;varying vec2 sampleCoordSE;varying vec2 sampleCoordNE;varying vec2 sampleCoordSW;const float fxaaQualitySubpix=1.0;const float fxaaQualityEdgeThreshold=0.166;const float fxaaQualityEdgeThresholdMin=0.0833;const vec3 kLumaCoefficients=vec3(0.2126,0.7152,0.0722);\n#define FxaaLuma(rgba) dot(rgba.rgb,kLumaCoefficients)\nvoid main(){vec2 posM;posM.x=vUV.x;posM.y=vUV.y;vec4 rgbyM=TEXTUREFUNC(textureSampler,vUV,0.0);float lumaM=FxaaLuma(rgbyM);float lumaS=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordS,0.0));float lumaE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordE,0.0));float lumaN=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordN,0.0));float lumaW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordW,0.0));float maxSM=max(lumaS,lumaM);float minSM=min(lumaS,lumaM);float maxESM=max(lumaE,maxSM);float minESM=min(lumaE,minSM);float maxWN=max(lumaN,lumaW);float minWN=min(lumaN,lumaW);float rangeMax=max(maxWN,maxESM);float rangeMin=min(minWN,minESM);float rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;float range=rangeMax-rangeMin;float rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);\n#ifndef MALI\nif(range<rangeMaxClamped) \n{gl_FragColor=rgbyM;return;}\n#endif\nfloat lumaNW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordNW,0.0));float lumaSE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordSE,0.0));float lumaNE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordNE,0.0));float lumaSW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordSW,0.0));float lumaNS=lumaN+lumaS;float lumaWE=lumaW+lumaE;float subpixRcpRange=1.0/range;float subpixNSWE=lumaNS+lumaWE;float edgeHorz1=(-2.0*lumaM)+lumaNS;float edgeVert1=(-2.0*lumaM)+lumaWE;float lumaNESE=lumaNE+lumaSE;float lumaNWNE=lumaNW+lumaNE;float edgeHorz2=(-2.0*lumaE)+lumaNESE;float edgeVert2=(-2.0*lumaN)+lumaNWNE;float lumaNWSW=lumaNW+lumaSW;float lumaSWSE=lumaSW+lumaSE;float edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);float edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);float edgeHorz3=(-2.0*lumaW)+lumaNWSW;float edgeVert3=(-2.0*lumaS)+lumaSWSE;float edgeHorz=abs(edgeHorz3)+edgeHorz4;float edgeVert=abs(edgeVert3)+edgeVert4;float subpixNWSWNESE=lumaNWSW+lumaNESE;float lengthSign=texelSize.x;bool horzSpan=edgeHorz>=edgeVert;float subpixA=subpixNSWE*2.0+subpixNWSWNESE;if (!horzSpan)\n{lumaN=lumaW;}\nif (!horzSpan) \n{lumaS=lumaE;}\nif (horzSpan) \n{lengthSign=texelSize.y;}\nfloat subpixB=(subpixA*(1.0/12.0))-lumaM;float gradientN=lumaN-lumaM;float gradientS=lumaS-lumaM;float lumaNN=lumaN+lumaM;float lumaSS=lumaS+lumaM;bool pairN=abs(gradientN)>=abs(gradientS);float gradient=max(abs(gradientN),abs(gradientS));if (pairN)\n{lengthSign=-lengthSign;}\nfloat subpixC=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);vec2 posB;posB.x=posM.x;posB.y=posM.y;vec2 offNP;offNP.x=(!horzSpan) ? 0.0 : texelSize.x;offNP.y=(horzSpan) ? 0.0 : texelSize.y;if (!horzSpan) \n{posB.x+=lengthSign*0.5;}\nif (horzSpan)\n{posB.y+=lengthSign*0.5;}\nvec2 posN;posN.x=posB.x-offNP.x*1.5;posN.y=posB.y-offNP.y*1.5;vec2 posP;posP.x=posB.x+offNP.x*1.5;posP.y=posB.y+offNP.y*1.5;float subpixD=((-2.0)*subpixC)+3.0;float lumaEndN=FxaaLuma(TEXTUREFUNC(textureSampler,posN,0.0));float subpixE=subpixC*subpixC;float lumaEndP=FxaaLuma(TEXTUREFUNC(textureSampler,posP,0.0));if (!pairN) \n{lumaNN=lumaSS;}\nfloat gradientScaled=gradient*1.0/4.0;float lumaMM=lumaM-lumaNN*0.5;float subpixF=subpixD*subpixE;bool lumaMLTZero=lumaMM<0.0;lumaEndN-=lumaNN*0.5;lumaEndP-=lumaNN*0.5;bool doneN=abs(lumaEndN)>=gradientScaled;bool doneP=abs(lumaEndP)>=gradientScaled;if (!doneN) \n{posN.x-=offNP.x*3.0;}\nif (!doneN) \n{posN.y-=offNP.y*3.0;}\nbool doneNP=(!doneN) || (!doneP);if (!doneP) \n{posP.x+=offNP.x*3.0;}\nif (!doneP)\n{posP.y+=offNP.y*3.0;}\nif (doneNP)\n{if (!doneN) lumaEndN=FxaaLuma(TEXTUREFUNC(textureSampler,posN.xy,0.0));if (!doneP) lumaEndP=FxaaLuma(TEXTUREFUNC(textureSampler,posP.xy,0.0));if (!doneN) lumaEndN=lumaEndN-lumaNN*0.5;if (!doneP) lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if (!doneN) posN.x-=offNP.x*12.0;if (!doneN) posN.y-=offNP.y*12.0;doneNP=(!doneN) || (!doneP);if (!doneP) posP.x+=offNP.x*12.0;if (!doneP) posP.y+=offNP.y*12.0;}\nfloat dstN=posM.x-posN.x;float dstP=posP.x-posM.x;if (!horzSpan)\n{dstN=posM.y-posN.y;}\nif (!horzSpan) \n{dstP=posP.y-posM.y;}\nbool goodSpanN=(lumaEndN<0.0) != lumaMLTZero;float spanLength=(dstP+dstN);bool goodSpanP=(lumaEndP<0.0) != lumaMLTZero;float spanLengthRcp=1.0/spanLength;bool directionN=dstN<dstP;float dst=min(dstN,dstP);bool goodSpan=directionN ? goodSpanN : goodSpanP;float subpixG=subpixF*subpixF;float pixelOffset=(dst*(-spanLengthRcp))+0.5;float subpixH=subpixG*fxaaQualitySubpix;float pixelOffsetGood=goodSpan ? pixelOffset : 0.0;float pixelOffsetSubpix=max(pixelOffsetGood,subpixH);if (!horzSpan)\n{posM.x+=pixelOffsetSubpix*lengthSign;}\nif (horzSpan)\n{posM.y+=pixelOffsetSubpix*lengthSign;}\n#ifdef MALI\nif(range<rangeMaxClamped) \n{gl_FragColor=rgbyM;}\nelse\n{gl_FragColor=TEXTUREFUNC(textureSampler,posM,0.0);}\n#else\ngl_FragColor=TEXTUREFUNC(textureSampler,posM,0.0);\n#endif\n}";nt.ShadersStore.fxaaVertexShader="attribute vec2 position;uniform vec2 texelSize;varying vec2 vUV;varying vec2 sampleCoordS;varying vec2 sampleCoordE;varying vec2 sampleCoordN;varying vec2 sampleCoordW;varying vec2 sampleCoordNW;varying vec2 sampleCoordSE;varying vec2 sampleCoordNE;varying vec2 sampleCoordSW;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd);sampleCoordS=vUV+vec2( 0.0,1.0)*texelSize;sampleCoordE=vUV+vec2( 1.0,0.0)*texelSize;sampleCoordN=vUV+vec2( 0.0,-1.0)*texelSize;sampleCoordW=vUV+vec2(-1.0,0.0)*texelSize;sampleCoordNW=vUV+vec2(-1.0,-1.0)*texelSize;sampleCoordSE=vUV+vec2( 1.0,1.0)*texelSize;sampleCoordNE=vUV+vec2( 1.0,-1.0)*texelSize;sampleCoordSW=vUV+vec2(-1.0,1.0)*texelSize;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";class sv extends dn{getClassName(){return"FxaaPostProcess"}constructor(e,t,i=null,s,r,n,o=0){super(e,"fxaa",["texelSize"],null,t,i,s||Ar.BILINEAR_SAMPLINGMODE,r,n,null,o,"fxaa",void 0,!0);const a=this._getDefines();this.updateEffect(a),this.onApplyObservable.add((e=>{const t=this.texelSize;e.setFloat2("texelSize",t.x,t.y)}))}_getDefines(){const e=this.getEngine();if(!e)return null;const t=e.getGlInfo();return t&&t.renderer&&t.renderer.toLowerCase().indexOf("mali")>-1?"#define MALI 1\n":null}static _Parse(e,t,i,s){return de.Parse((()=>new sv(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}m("BABYLON.FxaaPostProcess",sv);nt.ShadersStore.grainPixelShader="#include<helperFunctions>\nuniform sampler2D textureSampler; \nuniform float intensity;uniform float animatedSeed;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{gl_FragColor=texture2D(textureSampler,vUV);vec2 seed=vUV*(animatedSeed);float grain=dither(seed,intensity);float lum=getLuminance(gl_FragColor.rgb);float grainAmount=(cos(-PI+(lum*PI*2.))+1.)/2.;gl_FragColor.rgb+=grain*grainAmount;gl_FragColor.rgb=max(gl_FragColor.rgb,0.0);}";class rv extends dn{getClassName(){return"GrainPostProcess"}constructor(e,t,i,s,r,n,o=0,a=!1){super(e,"grain",["intensity","animatedSeed"],[],t,i,s,r,n,null,o,void 0,null,a),this.intensity=30,this.animated=!1,this.onApplyObservable.add((e=>{e.setFloat("intensity",this.intensity),e.setFloat("animatedSeed",this.animated?Math.random()+1:1)}))}static _Parse(e,t,i,s){return de.Parse((()=>new rv(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}me([ie()],rv.prototype,"intensity",void 0),me([ie()],rv.prototype,"animated",void 0),m("BABYLON.GrainPostProcess",rv);nt.ShadersStore.highlightsPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;const vec3 RGBLuminanceCoefficients=vec3(0.2126,0.7152,0.0722);\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec4 tex=texture2D(textureSampler,vUV);vec3 c=tex.rgb;float luma=dot(c.rgb,RGBLuminanceCoefficients);gl_FragColor=vec4(pow(c,vec3(25.0-luma*15.0)),tex.a); }";nt.ShadersStore.imageProcessingPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;\n#include<imageProcessingDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 result=texture2D(textureSampler,vUV);\n#ifdef IMAGEPROCESSING\n#ifndef FROMLINEARSPACE\nresult.rgb=toLinearSpace(result.rgb);\n#endif\nresult=applyImageProcessing(result);\n#else\n#ifdef FROMLINEARSPACE\nresult=applyImageProcessing(result);\n#endif\n#endif\ngl_FragColor=result;}";class nv extends dn{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){e.applyByPostProcess=!0,this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e,t=!1){if(e!==this._imageProcessingConfiguration){if(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e)this._imageProcessingConfiguration=e;else{let e=null;const t=this.getEngine(),i=this.getCamera();if(i)e=i.getScene();else if(t&&t.scenes){const i=t.scenes;e=i[i.length-1]}else e=x.LastCreatedScene;this._imageProcessingConfiguration=e?e.imageProcessingConfiguration:new Zt}this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._updateParameters()}))),t||this._updateParameters()}}get isSupported(){const e=this.getEffect();return!e||e.isSupported}get colorCurves(){return this.imageProcessingConfiguration.colorCurves}set colorCurves(e){this.imageProcessingConfiguration.colorCurves=e}get colorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set colorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get colorGradingTexture(){return this.imageProcessingConfiguration.colorGradingTexture}set colorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get colorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set colorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get exposure(){return this.imageProcessingConfiguration.exposure}set exposure(e){this.imageProcessingConfiguration.exposure=e}get toneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set toneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get toneMappingType(){return this._imageProcessingConfiguration.toneMappingType}set toneMappingType(e){this._imageProcessingConfiguration.toneMappingType=e}get contrast(){return this.imageProcessingConfiguration.contrast}set contrast(e){this.imageProcessingConfiguration.contrast=e}get vignetteStretch(){return this.imageProcessingConfiguration.vignetteStretch}set vignetteStretch(e){this.imageProcessingConfiguration.vignetteStretch=e}get vignetteCentreX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCentreX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteCentreY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCentreY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCenterY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCenterX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteWeight(){return this.imageProcessingConfiguration.vignetteWeight}set vignetteWeight(e){this.imageProcessingConfiguration.vignetteWeight=e}get vignetteColor(){return this.imageProcessingConfiguration.vignetteColor}set vignetteColor(e){this.imageProcessingConfiguration.vignetteColor=e}get vignetteCameraFov(){return this.imageProcessingConfiguration.vignetteCameraFov}set vignetteCameraFov(e){this.imageProcessingConfiguration.vignetteCameraFov=e}get vignetteBlendMode(){return this.imageProcessingConfiguration.vignetteBlendMode}set vignetteBlendMode(e){this.imageProcessingConfiguration.vignetteBlendMode=e}get vignetteEnabled(){return this.imageProcessingConfiguration.vignetteEnabled}set vignetteEnabled(e){this.imageProcessingConfiguration.vignetteEnabled=e}get ditheringIntensity(){return this.imageProcessingConfiguration.ditheringIntensity}set ditheringIntensity(e){this.imageProcessingConfiguration.ditheringIntensity=e}get ditheringEnabled(){return this.imageProcessingConfiguration.ditheringEnabled}set ditheringEnabled(e){this.imageProcessingConfiguration.ditheringEnabled=e}get fromLinearSpace(){return this._fromLinearSpace}set fromLinearSpace(e){this._fromLinearSpace!==e&&(this._fromLinearSpace=e,this._updateParameters())}constructor(e,t,i=null,s,r,n,o=0,a){super(e,"imageProcessing",[],[],t,i,s,r,n,null,o,"postprocess",null,!0),this._fromLinearSpace=!0,this._defines={IMAGEPROCESSING:!1,VIGNETTE:!1,VIGNETTEBLENDMODEMULTIPLY:!1,VIGNETTEBLENDMODEOPAQUE:!1,TONEMAPPING:!1,TONEMAPPING_ACES:!1,CONTRAST:!1,COLORCURVES:!1,COLORGRADING:!1,COLORGRADING3D:!1,FROMLINEARSPACE:!1,SAMPLER3DGREENDEPTH:!1,SAMPLER3DBGRMAP:!1,DITHER:!1,IMAGEPROCESSINGPOSTPROCESS:!1,EXPOSURE:!1,SKIPFINALCOLORCLAMP:!1},a?(a.applyByPostProcess=!0,this._attachImageProcessingConfiguration(a,!0),this._updateParameters()):(this._attachImageProcessingConfiguration(null,!0),this.imageProcessingConfiguration.applyByPostProcess=!0),this.onApply=e=>{this.imageProcessingConfiguration.bind(e,this.aspectRatio)}}getClassName(){return"ImageProcessingPostProcess"}_updateParameters(){this._defines.FROMLINEARSPACE=this._fromLinearSpace,this.imageProcessingConfiguration.prepareDefines(this._defines,!0);let e="";for(const t in this._defines)this._defines[t]&&(e+=`#define ${t};\n`);const t=["textureSampler"],i=["scale"];Zt&&(Zt.PrepareSamplers(t,this._defines),Zt.PrepareUniforms(i,this._defines)),this.updateEffect(e,i,t)}dispose(e){super.dispose(e),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration&&(this.imageProcessingConfiguration.applyByPostProcess=!1)}}me([ie()],nv.prototype,"_fromLinearSpace",void 0);nt.IncludesShadersStore.mrtFragmentDeclaration="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nlayout(location=0) out vec4 glFragData[{X}];\n#endif\n";nt.ShadersStore.geometryPixelShader="#extension GL_EXT_draw_buffers : require\n#if defined(BUMP) || !defined(NORMAL)\n#extension GL_OES_standard_derivatives : enable\n#endif\nprecision highp float;\n#ifdef BUMP\nvarying mat4 vWorldView;varying vec3 vNormalW;\n#else\nvarying vec3 vNormalV;\n#endif\nvarying vec4 vViewPos;\n#if defined(POSITION) || defined(BUMP)\nvarying vec3 vPositionW;\n#endif\n#ifdef VELOCITY\nvarying vec4 vCurrentPosition;varying vec4 vPreviousPosition;\n#endif\n#ifdef NEED_UV\nvarying vec2 vUV;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;\n#endif\n#if defined(REFLECTIVITY)\n#if defined(ORMTEXTURE) || defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nuniform sampler2D reflectivitySampler;varying vec2 vReflectivityUV;\n#endif\n#ifdef ALBEDOTEXTURE\nvarying vec2 vAlbedoUV;uniform sampler2D albedoSampler;\n#endif\n#ifdef REFLECTIVITYCOLOR\nuniform vec3 reflectivityColor;\n#endif\n#ifdef ALBEDOCOLOR\nuniform vec3 albedoColor;\n#endif\n#ifdef METALLIC\nuniform float metallic;\n#endif\n#if defined(ROUGHNESS) || defined(GLOSSINESS)\nuniform float glossiness;\n#endif\n#endif\n#if defined(ALPHATEST) && defined(NEED_UV)\nuniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<mrtFragmentDeclaration>[RENDER_TARGET_COUNT]\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<helperFunctions>\nvoid main() {\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\nvec3 normalOutput;\n#ifdef BUMP\nvec3 normalW=normalize(vNormalW);\n#include<bumpFragment>\n#ifdef NORMAL_WORLDSPACE\nnormalOutput=normalW;\n#else\nnormalOutput=normalize(vec3(vWorldView*vec4(normalW,0.0)));\n#endif\n#else\nnormalOutput=normalize(vNormalV);\n#endif\n#ifdef PREPASS\n#ifdef PREPASS_DEPTH\ngl_FragData[DEPTH_INDEX]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);\n#endif\n#ifdef PREPASS_NORMAL\ngl_FragData[NORMAL_INDEX]=vec4(normalOutput,1.0);\n#endif\n#else\ngl_FragData[0]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);gl_FragData[1]=vec4(normalOutput,1.0);\n#endif\n#ifdef POSITION\ngl_FragData[POSITION_INDEX]=vec4(vPositionW,1.0);\n#endif\n#ifdef VELOCITY\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[VELOCITY_INDEX]=vec4(velocity,0.0,1.0);\n#endif\n#ifdef REFLECTIVITY\nvec4 reflectivity=vec4(0.0,0.0,0.0,1.0);\n#ifdef METALLICWORKFLOW\nfloat metal=1.0;float roughness=1.0;\n#ifdef ORMTEXTURE\nmetal*=texture2D(reflectivitySampler,vReflectivityUV).b;roughness*=texture2D(reflectivitySampler,vReflectivityUV).g;\n#endif\n#ifdef METALLIC\nmetal*=metallic;\n#endif\n#ifdef ROUGHNESS\nroughness*=(1.0-glossiness); \n#endif\nreflectivity.a-=roughness;vec3 color=vec3(1.0);\n#ifdef ALBEDOTEXTURE\ncolor=texture2D(albedoSampler,vAlbedoUV).rgb;\n#ifdef GAMMAALBEDO\ncolor=toLinearSpace(color);\n#endif\n#endif\n#ifdef ALBEDOCOLOR\ncolor*=albedoColor.xyz;\n#endif\nreflectivity.rgb=mix(vec3(0.04),color,metal);\n#else\n#if defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nreflectivity=texture2D(reflectivitySampler,vReflectivityUV);\n#ifdef GAMMAREFLECTIVITYTEXTURE\nreflectivity.rgb=toLinearSpace(reflectivity.rgb);\n#endif\n#else \n#ifdef REFLECTIVITYCOLOR\nreflectivity.rgb=toLinearSpace(reflectivityColor.xyz);reflectivity.a=1.0;\n#endif\n#endif\n#ifdef GLOSSINESSS\nreflectivity.a*=glossiness; \n#endif\n#endif\ngl_FragData[REFLECTIVITY_INDEX]=reflectivity;\n#endif\n}\n";nt.IncludesShadersStore.geometryVertexDeclaration="uniform mat4 viewProjection;uniform mat4 view;";nt.IncludesShadersStore.geometryUboDeclaration="#include<sceneUboDeclaration>\n";nt.ShadersStore.geometryVertexShader="precision highp float;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\n#include<__decl__geometryVertex>\n#include<clipPlaneVertexDeclaration>\nattribute vec3 position;attribute vec3 normal;\n#ifdef NEED_UV\nvarying vec2 vUV;\n#ifdef ALPHATEST\nuniform mat4 diffuseMatrix;\n#endif\n#ifdef BUMP\nuniform mat4 bumpMatrix;varying vec2 vBumpUV;\n#endif\n#ifdef REFLECTIVITY\nuniform mat4 reflectivityMatrix;uniform mat4 albedoMatrix;varying vec2 vReflectivityUV;varying vec2 vAlbedoUV;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#ifdef BUMP\nvarying mat4 vWorldView;\n#endif\n#ifdef BUMP\nvarying vec3 vNormalW;\n#else\nvarying vec3 vNormalV;\n#endif\nvarying vec4 vViewPos;\n#if defined(POSITION) || defined(BUMP)\nvarying vec3 vPositionW;\n#endif\n#ifdef VELOCITY\nuniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;vec3 normalUpdated=normal;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#if defined(VELOCITY) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=vec4(finalWorld*vec4(positionUpdated,1.0));\n#ifdef BUMP\nvWorldView=view*finalWorld;vNormalW=normalUpdated;\n#else\n#ifdef NORMAL_WORLDSPACE\nvNormalV=normalize(vec3(finalWorld*vec4(normalUpdated,0.0)));\n#else\nvNormalV=normalize(vec3((view*finalWorld)*vec4(normalUpdated,0.0)));\n#endif\n#endif\nvViewPos=view*worldPos;\n#if defined(VELOCITY) && defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#if NUM_BONE_INFLUENCERS>0\nmat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\npreviousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\npreviousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\npreviousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\nvPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);\n#else\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#endif\n#if defined(POSITION) || defined(BUMP)\nvPositionW=worldPos.xyz/worldPos.w;\n#endif\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#include<clipPlaneVertex>\n#ifdef NEED_UV\n#ifdef UV1\n#if defined(ALPHATEST) && defined(ALPHATEST_UV1)\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#else\nvUV=uv;\n#endif\n#ifdef BUMP_UV1\nvBumpUV=vec2(bumpMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef REFLECTIVITY_UV1\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef ALBEDO_UV1\nvAlbedoUV=vec2(albedoMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#endif\n#ifdef UV2\n#if defined(ALPHATEST) && defined(ALPHATEST_UV2)\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#else\nvUV=uv2;\n#endif\n#ifdef BUMP_UV2\nvBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));\n#endif\n#ifdef REFLECTIVITY_UV2\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uv2,1.0,0.0));\n#endif\n#ifdef ALBEDO_UV2\nvAlbedoUV=vec2(albedoMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#endif\n#include<bumpVertex>\n}\n";const ov=["world","mBones","viewProjection","diffuseMatrix","view","previousWorld","previousViewProjection","mPreviousBones","bumpMatrix","reflectivityMatrix","albedoMatrix","reflectivityColor","albedoColor","metallic","glossiness","vTangentSpaceParams","vBumpInfos","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices","boneTextureWidth"];ks(ov);class av{_linkPrePassRenderer(e){this._linkedWithPrePass=!0,this._prePassRenderer=e,this._multiRenderTarget&&(this._multiRenderTarget.onClearObservable.clear(),this._multiRenderTarget.onClearObservable.add((()=>{})))}_unlinkPrePassRenderer(){this._linkedWithPrePass=!1,this._createRenderTargets()}_resetLayout(){this._enablePosition=!1,this._enableReflectivity=!1,this._enableVelocity=!1,this._attachmentsFromPrePass=[]}_forceTextureType(e,t){e===av.POSITION_TEXTURE_TYPE?(this._positionIndex=t,this._enablePosition=!0):e===av.VELOCITY_TEXTURE_TYPE?(this._velocityIndex=t,this._enableVelocity=!0):e===av.REFLECTIVITY_TEXTURE_TYPE?(this._reflectivityIndex=t,this._enableReflectivity=!0):e===av.DEPTH_TEXTURE_TYPE?this._depthIndex=t:e===av.NORMAL_TEXTURE_TYPE&&(this._normalIndex=t)}_setAttachments(e){this._attachmentsFromPrePass=e}_linkInternalTexture(e){this._multiRenderTarget.setInternalTexture(e,0,!1)}get renderList(){return this._multiRenderTarget.renderList}set renderList(e){this._multiRenderTarget.renderList=e}get isSupported(){return this._multiRenderTarget.isSupported}getTextureIndex(e){switch(e){case av.POSITION_TEXTURE_TYPE:return this._positionIndex;case av.VELOCITY_TEXTURE_TYPE:return this._velocityIndex;case av.REFLECTIVITY_TEXTURE_TYPE:return this._reflectivityIndex;case av.DEPTH_TEXTURE_TYPE:return this._linkedWithPrePass?this._depthIndex:0;case av.NORMAL_TEXTURE_TYPE:return this._linkedWithPrePass?this._normalIndex:1;default:return-1}}get enablePosition(){return this._enablePosition}set enablePosition(e){this._enablePosition=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableVelocity(){return this._enableVelocity}set enableVelocity(e){this._enableVelocity=e,e||(this._previousTransformationMatrices={}),this._linkedWithPrePass||(this.dispose(),this._createRenderTargets()),this._scene.needsPreviousWorldMatrices=e}get enableReflectivity(){return this._enableReflectivity}set enableReflectivity(e){this._enableReflectivity=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get scene(){return this._scene}get ratio(){return"object"==typeof this._ratioOrDimensions?1:this._ratioOrDimensions}constructor(e,t=1,i=15){this._previousTransformationMatrices={},this._previousBonesTransformationMatrices={},this.excludedSkinnedMeshesFromVelocity=[],this.renderTransparentMeshes=!0,this.generateNormalsInWorldSpace=!1,this._resizeObserver=null,this._enablePosition=!1,this._enableVelocity=!1,this._enableReflectivity=!1,this._clearColor=new F(0,0,0,0),this._clearDepthColor=new F(1e8,0,0,1),this._positionIndex=-1,this._velocityIndex=-1,this._reflectivityIndex=-1,this._depthIndex=-1,this._normalIndex=-1,this._linkedWithPrePass=!1,this.useSpecificClearForDepthTexture=!1,this._scene=e,this._ratioOrDimensions=t,this._useUbo=e.getEngine().supportsUniformBuffers,this._depthFormat=i,av._SceneComponentInitialization(this._scene),this._createRenderTargets()}isReady(e,t){const i=e.getMaterial();if(i&&i.disableDepthWrite)return!1;const s=[],r=[hi.PositionKind,hi.NormalKind],n=e.getMesh();if(i){let e=!1;if(i.needAlphaTesting()&&i.getAlphaTestTexture()&&(s.push("#define ALPHATEST"),s.push(`#define ALPHATEST_UV${i.getAlphaTestTexture().coordinatesIndex+1}`),e=!0),i.bumpTexture&&Ia.BumpTextureEnabled&&(s.push("#define BUMP"),s.push(`#define BUMP_UV${i.bumpTexture.coordinatesIndex+1}`),e=!0),this._enableReflectivity){let t=!1;"PBRMetallicRoughnessMaterial"===i.getClassName()?(null!==i.metallicRoughnessTexture&&(s.push("#define ORMTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.metallicRoughnessTexture.coordinatesIndex+1}`),s.push("#define METALLICWORKFLOW"),e=!0,t=!0),null!==i.metallic&&(s.push("#define METALLIC"),s.push("#define METALLICWORKFLOW"),t=!0),null!==i.roughness&&(s.push("#define ROUGHNESS"),s.push("#define METALLICWORKFLOW"),t=!0),t&&(null!==i.baseTexture&&(s.push("#define ALBEDOTEXTURE"),s.push(`#define ALBEDO_UV${i.baseTexture.coordinatesIndex+1}`),i.baseTexture.gammaSpace&&s.push("#define GAMMAALBEDO"),e=!0),null!==i.baseColor&&s.push("#define ALBEDOCOLOR"))):"PBRSpecularGlossinessMaterial"===i.getClassName()?(null!==i.specularGlossinessTexture?(s.push("#define SPECULARGLOSSINESSTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.specularGlossinessTexture.coordinatesIndex+1}`),e=!0,i.specularGlossinessTexture.gammaSpace&&s.push("#define GAMMAREFLECTIVITYTEXTURE")):null!==i.specularColor&&s.push("#define REFLECTIVITYCOLOR"),null!==i.glossiness&&s.push("#define GLOSSINESS")):"PBRMaterial"===i.getClassName()?(null!==i.metallicTexture&&(s.push("#define ORMTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.metallicTexture.coordinatesIndex+1}`),s.push("#define METALLICWORKFLOW"),e=!0,t=!0),null!==i.metallic&&(s.push("#define METALLIC"),s.push("#define METALLICWORKFLOW"),t=!0),null!==i.roughness&&(s.push("#define ROUGHNESS"),s.push("#define METALLICWORKFLOW"),t=!0),t?(null!==i.albedoTexture&&(s.push("#define ALBEDOTEXTURE"),s.push(`#define ALBEDO_UV${i.albedoTexture.coordinatesIndex+1}`),i.albedoTexture.gammaSpace&&s.push("#define GAMMAALBEDO"),e=!0),null!==i.albedoColor&&s.push("#define ALBEDOCOLOR")):(null!==i.reflectivityTexture?(s.push("#define SPECULARGLOSSINESSTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.reflectivityTexture.coordinatesIndex+1}`),i.reflectivityTexture.gammaSpace&&s.push("#define GAMMAREFLECTIVITYTEXTURE"),e=!0):null!==i.reflectivityColor&&s.push("#define REFLECTIVITYCOLOR"),null!==i.microSurface&&s.push("#define GLOSSINESS"))):"StandardMaterial"===i.getClassName()&&(null!==i.specularTexture&&(s.push("#define REFLECTIVITYTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.specularTexture.coordinatesIndex+1}`),i.specularTexture.gammaSpace&&s.push("#define GAMMAREFLECTIVITYTEXTURE"),e=!0),null!==i.specularColor&&s.push("#define REFLECTIVITYCOLOR"))}e&&(s.push("#define NEED_UV"),n.isVerticesDataPresent(hi.UVKind)&&(r.push(hi.UVKind),s.push("#define UV1")),n.isVerticesDataPresent(hi.UV2Kind)&&(r.push(hi.UV2Kind),s.push("#define UV2")))}this._linkedWithPrePass&&(s.push("#define PREPASS"),-1!==this._depthIndex&&(s.push("#define DEPTH_INDEX "+this._depthIndex),s.push("#define PREPASS_DEPTH")),-1!==this._normalIndex&&(s.push("#define NORMAL_INDEX "+this._normalIndex),s.push("#define PREPASS_NORMAL"))),this._enablePosition&&(s.push("#define POSITION"),s.push("#define POSITION_INDEX "+this._positionIndex)),this._enableVelocity&&(s.push("#define VELOCITY"),s.push("#define VELOCITY_INDEX "+this._velocityIndex),-1===this.excludedSkinnedMeshesFromVelocity.indexOf(n)&&s.push("#define BONES_VELOCITY_ENABLED")),this._enableReflectivity&&(s.push("#define REFLECTIVITY"),s.push("#define REFLECTIVITY_INDEX "+this._reflectivityIndex)),this.generateNormalsInWorldSpace&&s.push("#define NORMAL_WORLDSPACE"),n.useBones&&n.computeBonesUsingShaders&&n.skeleton?(r.push(hi.MatricesIndicesKind),r.push(hi.MatricesWeightsKind),n.numBoneInfluencers>4&&(r.push(hi.MatricesIndicesExtraKind),r.push(hi.MatricesWeightsExtraKind)),s.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers),s.push("#define BONETEXTURE "+n.skeleton.isUsingTextureForMatrices),s.push("#define BonesPerMesh "+(n.skeleton.bones.length+1))):(s.push("#define NUM_BONE_INFLUENCERS 0"),s.push("#define BONETEXTURE false"),s.push("#define BonesPerMesh 0"));const o=n.morphTargetManager;let a=0;o&&o.numInfluencers>0&&(a=o.numInfluencers,s.push("#define MORPHTARGETS"),s.push("#define NUM_MORPH_INFLUENCERS "+a),o.isUsingTextureForTargets&&s.push("#define MORPHTARGETS_TEXTURE"),Hs.PrepareAttributesForMorphTargetsInfluencers(r,n,a)),t&&(s.push("#define INSTANCES"),Hs.PushAttributesForInstances(r,this._enableVelocity),e.getRenderingMesh().hasThinInstances&&s.push("#define THIN_INSTANCES")),this._linkedWithPrePass?s.push("#define RENDER_TARGET_COUNT "+this._attachmentsFromPrePass.length):s.push("#define RENDER_TARGET_COUNT "+this._multiRenderTarget.textures.length),Gs(i,this._scene,s);const l=this._scene.getEngine(),h=e._getDrawWrapper(void 0,!0),c=h.defines,u=s.join("\n");return c!==u&&h.setEffect(l.createEffect("geometry",{attributes:r,uniformsNames:ov,samplers:["diffuseSampler","bumpSampler","reflectivitySampler","albedoSampler","morphTargets","boneSampler"],defines:u,onCompiled:null,fallbacks:null,onError:null,uniformBuffersNames:["Scene"],indexParameters:{buffersCount:this._multiRenderTarget.textures.length-1,maxSimultaneousMorphTargets:a}},l),u),h.effect.isReady()}getGBuffer(){return this._multiRenderTarget}get samples(){return this._multiRenderTarget.samples}set samples(e){this._multiRenderTarget.samples=e}dispose(){this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.getGBuffer().dispose()}_assignRenderTargetIndices(){const e=[];let t=2;return e.push("gBuffer_Depth","gBuffer_Normal"),this._enablePosition&&(this._positionIndex=t,t++,e.push("gBuffer_Position")),this._enableVelocity&&(this._velocityIndex=t,t++,e.push("gBuffer_Velocity")),this._enableReflectivity&&(this._reflectivityIndex=t,t++,e.push("gBuffer_Reflectivity")),[t,e]}_createRenderTargets(){const e=this._scene.getEngine(),[t,i]=this._assignRenderTargetIndices();let s=0;e._caps.textureFloat&&e._caps.textureFloatLinearFiltering?s=1:e._caps.textureHalfFloat&&e._caps.textureHalfFloatLinearFiltering&&(s=2);const r=void 0!==this._ratioOrDimensions.width?this._ratioOrDimensions:{width:e.getRenderWidth()*this._ratioOrDimensions,height:e.getRenderHeight()*this._ratioOrDimensions};if(this._multiRenderTarget=new F_("gBuffer",r,t,this._scene,{generateMipMaps:!1,generateDepthTexture:!0,defaultType:s,depthTextureFormat:this._depthFormat},i.concat("gBuffer_DepthBuffer")),!this.isSupported)return;this._multiRenderTarget.wrapU=Ar.CLAMP_ADDRESSMODE,this._multiRenderTarget.wrapV=Ar.CLAMP_ADDRESSMODE,this._multiRenderTarget.refreshRate=1,this._multiRenderTarget.renderParticles=!1,this._multiRenderTarget.renderList=null;const n=[!0],o=[!1],a=[!0];for(let e=1;e<t;++e)n.push(!0),a.push(!1),o.push(!0);const l=e.buildTextureLayout(n),h=e.buildTextureLayout(o),c=e.buildTextureLayout(a);this._multiRenderTarget.onClearObservable.add((e=>{e.bindAttachments(this.useSpecificClearForDepthTexture?h:l),e.clear(this._clearColor,!0,!0,!0),this.useSpecificClearForDepthTexture&&(e.bindAttachments(c),e.clear(this._clearDepthColor,!0,!0,!0)),e.bindAttachments(l)})),this._resizeObserver=e.onResizeObservable.add((()=>{if(this._multiRenderTarget){const t=void 0!==this._ratioOrDimensions.width?this._ratioOrDimensions:{width:e.getRenderWidth()*this._ratioOrDimensions,height:e.getRenderHeight()*this._ratioOrDimensions};this._multiRenderTarget.resize(t)}}));const u=e=>{const t=e.getRenderingMesh(),i=e.getEffectiveMesh(),s=this._scene,r=s.getEngine(),n=e.getMaterial();if(!n)return;if(i._internalAbstractMeshDataInfo._isActiveIntermediate=!1,this._enableVelocity&&!this._previousTransformationMatrices[i.uniqueId]&&(this._previousTransformationMatrices[i.uniqueId]={world:y.Identity(),viewProjection:s.getTransformMatrix()},t.skeleton)){const e=t.skeleton.getTransformMatrices(t);this._previousBonesTransformationMatrices[t.uniqueId]=this._copyBonesTransformationMatrices(e,new Float32Array(e.length))}const o=t._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(o.mustReturn)return;const a=r.getCaps().instancedArrays&&(null!==o.visibleInstances[e._id]||t.hasThinInstances),l=i.getWorldMatrix();if(this.isReady(e,a)){const h=e._getDrawWrapper();if(!h)return;const c=h.effect;let u;r.enableEffect(h),a||t._bind(e,c,n.fillMode),this._useUbo?(Hs.BindSceneUniformBuffer(c,this._scene.getSceneUniformBuffer()),this._scene.finalizeSceneUbo()):(c.setMatrix("viewProjection",s.getTransformMatrix()),c.setMatrix("view",s.getViewMatrix()));const d=t._instanceDataStorage;if(d.isFrozen||!n.backFaceCulling&&null===t.overrideMaterialSideOrientation)u=d.sideOrientation;else{const e=i._getWorldMatrixDeterminant();u=t.overrideMaterialSideOrientation,null===u&&(u=n.sideOrientation),e<0&&(u=u===sr.ClockWiseSideOrientation?sr.CounterClockWiseSideOrientation:sr.ClockWiseSideOrientation)}if(n._preBind(h,u),n.needAlphaTesting()){const e=n.getAlphaTestTexture();e&&(c.setTexture("diffuseSampler",e),c.setMatrix("diffuseMatrix",e.getTextureMatrix()))}if(n.bumpTexture&&s.getEngine().getCaps().standardDerivatives&&Ia.BumpTextureEnabled&&(c.setFloat3("vBumpInfos",n.bumpTexture.coordinatesIndex,1/n.bumpTexture.level,n.parallaxScaleBias),c.setMatrix("bumpMatrix",n.bumpTexture.getTextureMatrix()),c.setTexture("bumpSampler",n.bumpTexture),c.setFloat2("vTangentSpaceParams",n.invertNormalMapX?-1:1,n.invertNormalMapY?-1:1)),this._enableReflectivity&&("PBRMetallicRoughnessMaterial"===n.getClassName()?(null!==n.metallicRoughnessTexture&&(c.setTexture("reflectivitySampler",n.metallicRoughnessTexture),c.setMatrix("reflectivityMatrix",n.metallicRoughnessTexture.getTextureMatrix())),null!==n.metallic&&c.setFloat("metallic",n.metallic),null!==n.roughness&&c.setFloat("glossiness",1-n.roughness),null!==n.baseTexture&&(c.setTexture("albedoSampler",n.baseTexture),c.setMatrix("albedoMatrix",n.baseTexture.getTextureMatrix())),null!==n.baseColor&&c.setColor3("albedoColor",n.baseColor)):"PBRSpecularGlossinessMaterial"===n.getClassName()?(null!==n.specularGlossinessTexture?(c.setTexture("reflectivitySampler",n.specularGlossinessTexture),c.setMatrix("reflectivityMatrix",n.specularGlossinessTexture.getTextureMatrix())):null!==n.specularColor&&c.setColor3("reflectivityColor",n.specularColor),null!==n.glossiness&&c.setFloat("glossiness",n.glossiness)):"PBRMaterial"===n.getClassName()?(null!==n.metallicTexture&&(c.setTexture("reflectivitySampler",n.metallicTexture),c.setMatrix("reflectivityMatrix",n.metallicTexture.getTextureMatrix())),null!==n.metallic&&c.setFloat("metallic",n.metallic),null!==n.roughness&&c.setFloat("glossiness",1-n.roughness),null!==n.roughness||null!==n.metallic||null!==n.metallicTexture?(null!==n.albedoTexture&&(c.setTexture("albedoSampler",n.albedoTexture),c.setMatrix("albedoMatrix",n.albedoTexture.getTextureMatrix())),null!==n.albedoColor&&c.setColor3("albedoColor",n.albedoColor)):(null!==n.reflectivityTexture?(c.setTexture("reflectivitySampler",n.reflectivityTexture),c.setMatrix("reflectivityMatrix",n.reflectivityTexture.getTextureMatrix())):null!==n.reflectivityColor&&c.setColor3("reflectivityColor",n.reflectivityColor),null!==n.microSurface&&c.setFloat("glossiness",n.microSurface))):"StandardMaterial"===n.getClassName()&&(null!==n.specularTexture&&(c.setTexture("reflectivitySampler",n.specularTexture),c.setMatrix("reflectivityMatrix",n.specularTexture.getTextureMatrix())),null!==n.specularColor&&c.setColor3("reflectivityColor",n.specularColor))),zs(c,n,this._scene),t.useBones&&t.computeBonesUsingShaders&&t.skeleton){const e=t.skeleton;if(e.isUsingTextureForMatrices&&c.getUniformIndex("boneTextureWidth")>-1){const i=e.getTransformMatrixTexture(t);c.setTexture("boneSampler",i),c.setFloat("boneTextureWidth",4*(e.bones.length+1))}else c.setMatrices("mBones",t.skeleton.getTransformMatrices(t));this._enableVelocity&&c.setMatrices("mPreviousBones",this._previousBonesTransformationMatrices[t.uniqueId])}Hs.BindMorphTargetParameters(t,c),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(c),this._enableVelocity&&(c.setMatrix("previousWorld",this._previousTransformationMatrices[i.uniqueId].world),c.setMatrix("previousViewProjection",this._previousTransformationMatrices[i.uniqueId].viewProjection)),a&&t.hasThinInstances&&c.setMatrix("world",l),t._processRendering(i,e,c,n.fillMode,o,a,((e,t)=>{e||c.setMatrix("world",t)}))}this._enableVelocity&&(this._previousTransformationMatrices[i.uniqueId].world=l.clone(),this._previousTransformationMatrices[i.uniqueId].viewProjection=this._scene.getTransformMatrix().clone(),t.skeleton&&this._copyBonesTransformationMatrices(t.skeleton.getTransformMatrices(t),this._previousBonesTransformationMatrices[i.uniqueId]))};this._multiRenderTarget.customIsReadyFunction=(t,i,s)=>{if((s||0===i)&&t.subMeshes)for(let i=0;i<t.subMeshes.length;++i){const s=t.subMeshes[i],r=s.getMaterial(),n=s.getRenderingMesh();if(!r)continue;const o=n._getInstancesRenderList(s._id,!!s.getReplacementMesh()),a=e.getCaps().instancedArrays&&(null!==o.visibleInstances[s._id]||n.hasThinInstances);if(!this.isReady(s,a))return!1}return!0},this._multiRenderTarget.customRenderFunction=(t,i,s,r)=>{let n;if(this._linkedWithPrePass){if(!this._prePassRenderer.enabled)return;this._scene.getEngine().bindAttachments(this._attachmentsFromPrePass)}if(r.length){for(e.setColorWrite(!1),n=0;n<r.length;n++)u(r.data[n]);e.setColorWrite(!0)}for(n=0;n<t.length;n++)u(t.data[n]);for(e.setDepthWrite(!1),n=0;n<i.length;n++)u(i.data[n]);if(this.renderTransparentMeshes)for(n=0;n<s.length;n++)u(s.data[n]);e.setDepthWrite(!0)}}_copyBonesTransformationMatrices(e,t){for(let i=0;i<e.length;i++)t[i]=e[i];return t}}av.DEPTH_TEXTURE_TYPE=0,av.NORMAL_TEXTURE_TYPE=1,av.POSITION_TEXTURE_TYPE=2,av.VELOCITY_TEXTURE_TYPE=3,av.REFLECTIVITY_TEXTURE_TYPE=4,av._SceneComponentInitialization=e=>{throw $("GeometryBufferRendererSceneComponent")};class lv{constructor(){this.enabled=!1,this.name="motionBlur",this.texturesRequired=[2]}}Object.defineProperty(Yi.prototype,"geometryBufferRenderer",{get:function(){return this._geometryBufferRenderer},set:function(e){e&&e.isSupported&&(this._geometryBufferRenderer=e)},enumerable:!0,configurable:!0}),Yi.prototype.enableGeometryBufferRenderer=function(e=1,t=15){return this._geometryBufferRenderer||(this._geometryBufferRenderer=new av(this,e,t),this._geometryBufferRenderer.isSupported||(this._geometryBufferRenderer=null)),this._geometryBufferRenderer},Yi.prototype.disableGeometryBufferRenderer=function(){this._geometryBufferRenderer&&(this._geometryBufferRenderer.dispose(),this._geometryBufferRenderer=null)};class hv{constructor(e){this.name=fi.NAME_GEOMETRYBUFFERRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(fi.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER,this,this._gatherRenderTargets)}rebuild(){}dispose(){}_gatherRenderTargets(e){this.scene._geometryBufferRenderer&&e.push(this.scene._geometryBufferRenderer.getGBuffer())}}av._SceneComponentInitialization=e=>{let t=e._getComponent(fi.NAME_GEOMETRYBUFFERRENDERER);t||(t=new hv(e),e._addComponent(t))};nt.ShadersStore.motionBlurPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform float motionStrength;uniform float motionScale;uniform vec2 screenSize;\n#ifdef OBJECT_BASED\nuniform sampler2D velocitySampler;\n#else\nuniform sampler2D depthSampler;uniform mat4 inverseViewProjection;uniform mat4 prevViewProjection;uniform mat4 projection;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#ifdef GEOMETRY_SUPPORTED\n#ifdef OBJECT_BASED\nvec2 texelSize=1.0/screenSize;vec4 velocityColor=texture2D(velocitySampler,vUV);velocityColor.rg=velocityColor.rg*2.0-vec2(1.0);vec2 velocity=vec2(pow(velocityColor.r,3.0),pow(velocityColor.g,3.0))*velocityColor.a;velocity*=motionScale*motionStrength;float speed=length(velocity/texelSize);int samplesCount=int(clamp(speed,1.0,SAMPLES));velocity=normalize(velocity)*texelSize;float hlim=float(-samplesCount)*0.5+0.5;vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(SAMPLES); ++i)\n{if (i>=samplesCount)\nbreak;vec2 offset=vUV+velocity*(hlim+float(i));\n#if defined(WEBGPU)\nresult+=texture2DLodEXT(textureSampler,offset,0.0);\n#else\nresult+=texture2D(textureSampler,offset);\n#endif\n}\ngl_FragColor=result/float(samplesCount);gl_FragColor.a=1.0;\n#else\nvec2 texelSize=1.0/screenSize;float depth=texture2D(depthSampler,vUV).r;depth=projection[2].z+projection[3].z/depth; \nvec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);cpos=inverseViewProjection*cpos;cpos/=cpos.w;vec4 ppos=prevViewProjection*cpos;ppos/=ppos.w;ppos.xy=ppos.xy*0.5+0.5;vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;float speed=length(velocity/texelSize);int nSamples=int(clamp(speed,1.0,SAMPLES));vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(SAMPLES); ++i) {if (i>=nSamples)\nbreak;vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);\n#if defined(WEBGPU)\nresult+=texture2DLodEXT(textureSampler,offset1,0.0);\n#else\nresult+=texture2D(textureSampler,offset1);\n#endif\n}\ngl_FragColor=result/float(nSamples);\n#endif\n#else\ngl_FragColor=texture2D(textureSampler,vUV);\n#endif\n}\n";class cv extends dn{get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this._motionBlurSamples=e,this._updateEffect()}get isObjectBased(){return this._isObjectBased}set isObjectBased(e){this._isObjectBased!==e&&(this._isObjectBased=e,this._applyMode())}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"MotionBlurPostProcess"}constructor(e,t,i,s,r,n,o,a=0,l=!1,h=!1){super(e,"motionBlur",["motionStrength","motionScale","screenSize","inverseViewProjection","prevViewProjection","projection"],["velocitySampler","depthSampler"],i,s,r,n,o,"#define GEOMETRY_SUPPORTED\n#define SAMPLES 64.0\n#define OBJECT_BASED",a,void 0,null,l),this.motionStrength=1,this._motionBlurSamples=32,this._isObjectBased=!0,this._forceGeometryBuffer=!1,this._invViewProjection=null,this._previousViewProjection=null,this._forceGeometryBuffer=h,this._forceGeometryBuffer?(t.enableGeometryBufferRenderer(),this._geometryBufferRenderer&&(this._geometryBufferRenderer.enableVelocity=this._isObjectBased)):(t.enablePrePassRenderer(),this._prePassRenderer&&(this._prePassRenderer.markAsDirty(),this._prePassEffectConfiguration=new lv)),this._applyMode()}excludeSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else{if(!this._prePassRenderer)return;t=this._prePassRenderer.excludedSkinnedMesh}t.push(e)}}removeExcludedSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else{if(!this._prePassRenderer)return;t=this._prePassRenderer.excludedSkinnedMesh}const i=t.indexOf(e);-1!==i&&t.splice(i,1)}}dispose(e){this._geometryBufferRenderer&&(this._geometryBufferRenderer._previousTransformationMatrices={},this._geometryBufferRenderer._previousBonesTransformationMatrices={},this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity=[]),super.dispose(e)}_applyMode(){if(!this._geometryBufferRenderer&&!this._prePassRenderer)return k.Warn("Multiple Render Target support needed to compute object based motion blur"),this.updateEffect();this._geometryBufferRenderer&&(this._geometryBufferRenderer.enableVelocity=this._isObjectBased),this._updateEffect(),this._invViewProjection=null,this._previousViewProjection=null,this.isObjectBased?(this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=2),this.onApply=e=>this._onApplyObjectBased(e)):(this._invViewProjection=y.Identity(),this._previousViewProjection=this._scene.getTransformMatrix().clone(),this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=5),this.onApply=e=>this._onApplyScreenBased(e))}_onApplyObjectBased(e){if(e.setVector2("screenSize",new E(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){const t=this._geometryBufferRenderer.getTextureIndex(av.VELOCITY_TEXTURE_TYPE);e.setTexture("velocitySampler",this._geometryBufferRenderer.getGBuffer().textures[t])}else if(this._prePassRenderer){const t=this._prePassRenderer.getIndex(2);e.setTexture("velocitySampler",this._prePassRenderer.getRenderTarget().textures[t])}}_onApplyScreenBased(e){const t=R.Matrix[0];if(t.copyFrom(this._scene.getTransformMatrix()),t.invertToRef(this._invViewProjection),e.setMatrix("inverseViewProjection",this._invViewProjection),e.setMatrix("prevViewProjection",this._previousViewProjection),this._previousViewProjection.copyFrom(t),e.setMatrix("projection",this._scene.getProjectionMatrix()),e.setVector2("screenSize",new E(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){const t=this._geometryBufferRenderer.getTextureIndex(av.DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[t])}else if(this._prePassRenderer){const t=this._prePassRenderer.getIndex(5);e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[t])}}_updateEffect(){if(this._geometryBufferRenderer||this._prePassRenderer){const e=["#define GEOMETRY_SUPPORTED","#define SAMPLES "+this._motionBlurSamples.toFixed(1),this._isObjectBased?"#define OBJECT_BASED":"#define SCREEN_BASED"];this.updateEffect(e.join("\n"))}}static _Parse(e,t,i,s){return de.Parse((()=>new cv(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,!1)),e,i,s)}}me([ie()],cv.prototype,"motionStrength",void 0),me([ie()],cv.prototype,"motionBlurSamples",null),me([ie()],cv.prototype,"isObjectBased",null),m("BABYLON.MotionBlurPostProcess",cv);nt.ShadersStore.refractionPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D refractionSampler;uniform vec3 baseColor;uniform float depth;uniform float colorLevel;void main() {float ref=1.0-texture2D(refractionSampler,vUV).r;vec2 uv=vUV-vec2(0.5);vec2 offset=uv*depth*ref;vec3 sourceColor=texture2D(textureSampler,vUV-offset).rgb;gl_FragColor=vec4(sourceColor+sourceColor*ref*colorLevel,1.0);}";class uv extends dn{get refractionTexture(){return this._refTexture}set refractionTexture(e){this._refTexture&&this._ownRefractionTexture&&this._refTexture.dispose(),this._refTexture=e,this._ownRefractionTexture=!1}getClassName(){return"RefractionPostProcess"}constructor(e,t,i,s,r,n,o,a,l,h){super(e,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],n,o,a,l,h),this._ownRefractionTexture=!0,this.color=i,this.depth=s,this.colorLevel=r,this.refractionTextureUrl=t,this.onActivateObservable.add((e=>{this._refTexture=this._refTexture||new Ar(t,e.getScene())})),this.onApplyObservable.add((e=>{e.setColor3("baseColor",this.color),e.setFloat("depth",this.depth),e.setFloat("colorLevel",this.colorLevel),e.setTexture("refractionSampler",this._refTexture)}))}dispose(e){this._refTexture&&this._ownRefractionTexture&&(this._refTexture.dispose(),this._refTexture=null),super.dispose(e)}static _Parse(e,t,i,s){return de.Parse((()=>new uv(e.name,e.refractionTextureUrl,e.color,e.depth,e.colorLevel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}me([ie()],uv.prototype,"color",void 0),me([ie()],uv.prototype,"depth",void 0),me([ie()],uv.prototype,"colorLevel",void 0),me([ie()],uv.prototype,"refractionTextureUrl",void 0),m("BABYLON.RefractionPostProcess",uv);nt.ShadersStore.sharpenPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform vec2 sharpnessAmounts;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec2 onePixel=vec2(1.0,1.0)/screenSize;vec4 color=texture2D(textureSampler,vUV);vec4 edgeDetection=texture2D(textureSampler,vUV+onePixel*vec2(0,-1)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,0)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,0)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,1)) -\ncolor*4.0;gl_FragColor=max(vec4(color.rgb*sharpnessAmounts.y,color.a)-(sharpnessAmounts.x*vec4(edgeDetection.rgb,0)),0.);}";class dv extends dn{getClassName(){return"SharpenPostProcess"}constructor(e,t,i,s,r,n,o=0,a=!1){super(e,"sharpen",["sharpnessAmounts","screenSize"],null,t,i,s,r,n,null,o,void 0,null,a),this.colorAmount=1,this.edgeAmount=.3,this.onApply=e=>{e.setFloat2("screenSize",this.width,this.height),e.setFloat2("sharpnessAmounts",this.edgeAmount,this.colorAmount)}}static _Parse(e,t,i,s){return de.Parse((()=>new dv(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable)),e,i,s)}}me([ie()],dv.prototype,"colorAmount",void 0),me([ie()],dv.prototype,"edgeAmount",void 0),m("BABYLON.SharpenPostProcess",dv);class pv{get name(){return this._name}get cameras(){return this._cameras}constructor(e,t){this._engine=e,this._name=t,this._renderEffects={},this._renderEffectsForIsolatedPass=new Array,this._cameras=[]}getClassName(){return"PostProcessRenderPipeline"}get isSupported(){for(const e in this._renderEffects)if(Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&!this._renderEffects[e].isSupported)return!1;return!0}addEffect(e){this._renderEffects[e._name]=e}_rebuild(){}_enableEffect(e,t){const i=this._renderEffects[e];i&&i._enable(Ht.MakeArray(t||this._cameras))}_disableEffect(e,t){const i=this._renderEffects[e];i&&i._disable(Ht.MakeArray(t||this._cameras))}_attachCameras(e,t){const i=Ht.MakeArray(e||this._cameras);if(!i)return;const s=[];let r;for(r=0;r<i.length;r++){const e=i[r];e&&(-1===this._cameras.indexOf(e)?this._cameras.push(e):t&&s.push(r))}for(r=0;r<s.length;r++)i.splice(s[r],1);for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._attachCameras(i)}_detachCameras(e){const t=Ht.MakeArray(e||this._cameras);if(t){for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._detachCameras(t);for(let e=0;e<t.length;e++)this._cameras.splice(this._cameras.indexOf(t[e]),1)}}_update(){for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._update();for(let e=0;e<this._cameras.length;e++){if(!this._cameras[e])continue;const t=this._cameras[e].name;this._renderEffectsForIsolatedPass[t]&&this._renderEffectsForIsolatedPass[t]._update()}}_reset(){this._renderEffects={},this._renderEffectsForIsolatedPass=new Array}_enableMSAAOnFirstPostProcess(e){if(!this._engine._features.supportMSAA)return!1;const t=Object.keys(this._renderEffects);if(t.length>0){const i=this._renderEffects[t[0]].getPostProcesses();i&&(i[0].samples=e)}return!0}_adaptPostProcessesToViewPort(){const e=Object.keys(this._renderEffects);for(const t of e){const e=this._renderEffects[t].getPostProcesses();if(e)for(const t of e)t.adaptScaleToCurrentViewport=!0}}setPrePassRenderer(e){return!1}dispose(){}}me([ie()],pv.prototype,"_name",void 0);class _v{constructor(){this._renderPipelines={}}get supportedPipelines(){const e=[];for(const t in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,t)){const i=this._renderPipelines[t];i.isSupported&&e.push(i)}return e}addPipeline(e){this._renderPipelines[e._name]=e}removePipeline(e){delete this._renderPipelines[e]}attachCamerasToRenderPipeline(e,t,i=!1){const s=this._renderPipelines[e];s&&s._attachCameras(t,i)}detachCamerasFromRenderPipeline(e,t){const i=this._renderPipelines[e];i&&i._detachCameras(t)}enableEffectInPipeline(e,t,i){const s=this._renderPipelines[e];s&&s._enableEffect(t,i)}disableEffectInPipeline(e,t,i){const s=this._renderPipelines[e];s&&s._disableEffect(t,i)}update(){for(const e in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,e)){const t=this._renderPipelines[e];t.isSupported?t._update():(t.dispose(),delete this._renderPipelines[e])}}_rebuild(){for(const e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e]._rebuild()}dispose(){for(const e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e].dispose()}}Object.defineProperty(Yi.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){let e=this._getComponent(fi.NAME_POSTPROCESSRENDERPIPELINEMANAGER);e||(e=new fv(this),this._addComponent(e)),this._postProcessRenderPipelineManager=new _v}return this._postProcessRenderPipelineManager},enumerable:!0,configurable:!0});class fv{constructor(e){this.name=fi.NAME_POSTPROCESSRENDERPIPELINEMANAGER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(fi.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER,this,this._gatherRenderTargets)}rebuild(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager._rebuild()}dispose(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.dispose()}_gatherRenderTargets(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.update()}}class mv extends pv{get automaticBuild(){return this._buildAllowed}set automaticBuild(e){this._buildAllowed=e}get scene(){return this._scene}set sharpenEnabled(e){this._sharpenEnabled!==e&&(this._sharpenEnabled=e,this._buildPipeline())}get sharpenEnabled(){return this._sharpenEnabled}get bloomKernel(){return this._bloomKernel}set bloomKernel(e){this._bloomKernel=e,this.bloom.kernel=e/this._hardwareScaleLevel}set bloomWeight(e){this._bloomWeight!==e&&(this.bloom.weight=e,this._bloomWeight=e)}get bloomWeight(){return this._bloomWeight}set bloomThreshold(e){this._bloomThreshold!==e&&(this.bloom.threshold=e,this._bloomThreshold=e)}get bloomThreshold(){return this._bloomThreshold}set bloomScale(e){this._bloomScale!==e&&(this._bloomScale=e,this._rebuildBloom(),this._buildPipeline())}get bloomScale(){return this._bloomScale}set bloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get bloomEnabled(){return this._bloomEnabled}_rebuildBloom(){const e=this.bloom;this.bloom=new Yg(this._scene,this.bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!1),this.bloom.threshold=e.threshold;for(let t=0;t<this._cameras.length;t++)e.disposeEffects(this._cameras[t])}get depthOfFieldEnabled(){return this._depthOfFieldEnabled}set depthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get depthOfFieldBlurLevel(){return this._depthOfFieldBlurLevel}set depthOfFieldBlurLevel(e){if(this._depthOfFieldBlurLevel===e)return;this._depthOfFieldBlurLevel=e;const t=this.depthOfField;this.depthOfField=new ev(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!1),this.depthOfField.focalLength=t.focalLength,this.depthOfField.focusDistance=t.focusDistance,this.depthOfField.fStop=t.fStop,this.depthOfField.lensSize=t.lensSize;for(let e=0;e<this._cameras.length;e++)t.disposeEffects(this._cameras[e]);this._buildPipeline()}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}set imageProcessingEnabled(e){this._imageProcessingEnabled!==e&&(this._scene.imageProcessingConfiguration.isEnabled=e)}get imageProcessingEnabled(){return this._imageProcessingEnabled}set glowLayerEnabled(e){e&&!this._glowLayer?this._glowLayer=new Ap("",this._scene):!e&&this._glowLayer&&(this._glowLayer.dispose(),this._glowLayer=null)}get glowLayerEnabled(){return null!=this._glowLayer}get glowLayer(){return this._glowLayer}set chromaticAberrationEnabled(e){this._chromaticAberrationEnabled!==e&&(this._chromaticAberrationEnabled=e,this._buildPipeline())}get chromaticAberrationEnabled(){return this._chromaticAberrationEnabled}set grainEnabled(e){this._grainEnabled!==e&&(this._grainEnabled=e,this._buildPipeline())}get grainEnabled(){return this._grainEnabled}constructor(e="",t=!0,i=x.LastCreatedScene,s,r=!0){super(i.getEngine(),e),this._camerasToBeAttached=[],this.SharpenPostProcessId="SharpenPostProcessEffect",this.ImageProcessingPostProcessId="ImageProcessingPostProcessEffect",this.FxaaPostProcessId="FxaaPostProcessEffect",this.ChromaticAberrationPostProcessId="ChromaticAberrationPostProcessEffect",this.GrainPostProcessId="GrainPostProcessEffect",this._glowLayer=null,this.animations=[],this._imageProcessingConfigurationObserver=null,this._sharpenEnabled=!1,this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._depthOfFieldBlurLevel=Jg.Low,this._fxaaEnabled=!1,this._imageProcessingEnabled=!0,this._bloomScale=.5,this._chromaticAberrationEnabled=!1,this._grainEnabled=!1,this._buildAllowed=!0,this.onBuildObservable=new a,this._resizeObserver=null,this._hardwareScaleLevel=1,this._bloomKernel=64,this._bloomWeight=.15,this._bloomThreshold=.9,this._samples=1,this._hasCleared=!1,this._prevPostProcess=null,this._prevPrevPostProcess=null,this._depthOfFieldSceneObserver=null,this._activeCameraChangedObserver=null,this._activeCamerasChangedObserver=null,this._cameras=s||i.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._buildAllowed=r,this._scene=i;const n=this._scene.getEngine().getCaps();this._hdr=t&&(n.textureHalfFloatRender||n.textureFloatRender),this._hdr?n.textureHalfFloatRender?this._defaultPipelineTextureType=2:n.textureFloatRender&&(this._defaultPipelineTextureType=1):this._defaultPipelineTextureType=0,i.postProcessRenderPipelineManager.addPipeline(this);const o=this._scene.getEngine();this.sharpen=new dv("sharpen",1,null,Ar.BILINEAR_SAMPLINGMODE,o,!1,this._defaultPipelineTextureType,!0),this._sharpenEffect=new Wg(o,this.SharpenPostProcessId,(()=>this.sharpen),!0),this.depthOfField=new ev(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!0),this._hardwareScaleLevel=o.getHardwareScalingLevel(),this._resizeObserver=o.onResizeObservable.add((()=>{this._hardwareScaleLevel=o.getHardwareScalingLevel(),this.bloomKernel=this._bloomKernel})),this.bloom=new Yg(this._scene,this._bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!0),this.chromaticAberration=new jg("ChromaticAberration",o.getRenderWidth(),o.getRenderHeight(),1,null,Ar.BILINEAR_SAMPLINGMODE,o,!1,this._defaultPipelineTextureType,!0),this._chromaticAberrationEffect=new Wg(o,this.ChromaticAberrationPostProcessId,(()=>this.chromaticAberration),!0),this.grain=new rv("Grain",1,null,Ar.BILINEAR_SAMPLINGMODE,o,!1,this._defaultPipelineTextureType,!0),this._grainEffect=new Wg(o,this.GrainPostProcessId,(()=>this.grain),!0);let l=!0;this._imageProcessingConfigurationObserver=this._scene.imageProcessingConfiguration.onUpdateParameters.add((()=>{this.bloom._downscale._exposure=this._scene.imageProcessingConfiguration.exposure,this.imageProcessingEnabled!==this._scene.imageProcessingConfiguration.isEnabled&&(this._imageProcessingEnabled=this._scene.imageProcessingConfiguration.isEnabled,l?Ht.SetImmediate((()=>{this._buildPipeline()})):this._buildPipeline())})),this._buildPipeline(),l=!1}getClassName(){return"DefaultRenderingPipeline"}prepare(){const e=this._buildAllowed;this._buildAllowed=!0,this._buildPipeline(),this._buildAllowed=e}_setAutoClearAndTextureSharing(e,t=!1){this._hasCleared?e.autoClear=!1:(e.autoClear=!0,this._scene.autoClear=!1,this._hasCleared=!0),t||(this._prevPrevPostProcess?e.shareOutputWith(this._prevPrevPostProcess):e.useOwnOutput(),this._prevPostProcess&&(this._prevPrevPostProcess=this._prevPostProcess),this._prevPostProcess=e)}_buildPipeline(){if(!this._buildAllowed)return;this._scene.autoClear=!0;const e=this._scene.getEngine();if(this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._prevPostProcess=null,this._prevPrevPostProcess=null,this._hasCleared=!1,this.depthOfFieldEnabled){if(this._cameras.length>1){for(const e of this._cameras)this._scene.enableDepthRenderer(e).useOnlyInActiveCamera=!0;this._depthOfFieldSceneObserver=this._scene.onAfterRenderTargetsRenderObservable.add((e=>{this._cameras.indexOf(e.activeCamera)>-1&&(this.depthOfField.depthTexture=e.enableDepthRenderer(e.activeCamera).getDepthMap())}))}else{this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);const e=this._scene.enableDepthRenderer(this._cameras[0]);this.depthOfField.depthTexture=e.getDepthMap()}this.depthOfField._isReady()||this.depthOfField._updateEffects(),this.addEffect(this.depthOfField),this._setAutoClearAndTextureSharing(this.depthOfField._effects[0],!0)}else this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);this.bloomEnabled&&(this.bloom._isReady()||this.bloom._updateEffects(),this.addEffect(this.bloom),this._setAutoClearAndTextureSharing(this.bloom._effects[0],!0)),this._imageProcessingEnabled&&(this.imageProcessing=new nv("imageProcessing",1,null,Ar.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType,this.scene.imageProcessingConfiguration),this._hdr?(this.addEffect(new Wg(e,this.ImageProcessingPostProcessId,(()=>this.imageProcessing),!0)),this._setAutoClearAndTextureSharing(this.imageProcessing)):this._scene.imageProcessingConfiguration.applyByPostProcess=!1,this._cameras&&0!==this._cameras.length||(this._scene.imageProcessingConfiguration.applyByPostProcess=!1),this.imageProcessing.getEffect()||this.imageProcessing._updateParameters()),this.sharpenEnabled&&(this.sharpen.isReady()||this.sharpen.updateEffect(),this.addEffect(this._sharpenEffect),this._setAutoClearAndTextureSharing(this.sharpen)),this.grainEnabled&&(this.grain.isReady()||this.grain.updateEffect(),this.addEffect(this._grainEffect),this._setAutoClearAndTextureSharing(this.grain)),this.chromaticAberrationEnabled&&(this.chromaticAberration.isReady()||this.chromaticAberration.updateEffect(),this.addEffect(this._chromaticAberrationEffect),this._setAutoClearAndTextureSharing(this.chromaticAberration)),this.fxaaEnabled&&(this.fxaa=new sv("fxaa",1,null,Ar.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType),this.addEffect(new Wg(e,this.FxaaPostProcessId,(()=>this.fxaa),!0)),this._setAutoClearAndTextureSharing(this.fxaa,!0)),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),(this._scene.activeCameras&&this._scene.activeCameras.length>1||this._scene.activeCamera&&-1===this._cameras.indexOf(this._scene.activeCamera))&&(this._scene.autoClear=!0),this._activeCameraChangedObserver||(this._activeCameraChangedObserver=this._scene.onActiveCameraChanged.add((()=>{this._scene.activeCamera&&-1===this._cameras.indexOf(this._scene.activeCamera)&&(this._scene.autoClear=!0)}))),this._activeCamerasChangedObserver||(this._activeCamerasChangedObserver=this._scene.onActiveCamerasChanged.add((()=>{this._scene.activeCameras&&this._scene.activeCameras.length>1&&(this._scene.autoClear=!0)}))),this._adaptPostProcessesToViewPort(),!this._enableMSAAOnFirstPostProcess(this.samples)&&this.samples>1&&k.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0"),this.onBuildObservable.notifyObservers(this)}_disposePostProcesses(e=!1){for(let t=0;t<this._cameras.length;t++){const i=this._cameras[t];this.imageProcessing&&this.imageProcessing.dispose(i),this.fxaa&&this.fxaa.dispose(i),e&&(this.sharpen&&this.sharpen.dispose(i),this.depthOfField&&(this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver),this.depthOfField.disposeEffects(i)),this.bloom&&this.bloom.disposeEffects(i),this.chromaticAberration&&this.chromaticAberration.dispose(i),this.grain&&this.grain.dispose(i),this._glowLayer&&this._glowLayer.dispose())}this.imageProcessing=null,this.fxaa=null,e&&(this.sharpen=null,this._sharpenEffect=null,this.depthOfField=null,this.bloom=null,this.chromaticAberration=null,this._chromaticAberrationEffect=null,this.grain=null,this._grainEffect=null,this._glowLayer=null)}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(){this._buildAllowed=!1,this.onBuildObservable.clear(),this._disposePostProcesses(!0),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._scene._postProcessRenderPipelineManager.removePipeline(this.name),this._scene.autoClear=!0,this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this._scene.onActiveCameraChanged.remove(this._activeCameraChangedObserver),this._scene.onActiveCamerasChanged.remove(this._activeCamerasChangedObserver),this._scene.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigurationObserver),super.dispose()}serialize(){const e=de.Serialize(this);return e.customType="DefaultRenderingPipeline",e}static Parse(e,t,i){return de.Parse((()=>new mv(e._name,e._name._hdr,t)),e,t,i)}}me([ie()],mv.prototype,"sharpenEnabled",null),me([ie()],mv.prototype,"bloomKernel",null),me([ie()],mv.prototype,"_bloomWeight",void 0),me([ie()],mv.prototype,"_bloomThreshold",void 0),me([ie()],mv.prototype,"_hdr",void 0),me([ie()],mv.prototype,"bloomWeight",null),me([ie()],mv.prototype,"bloomThreshold",null),me([ie()],mv.prototype,"bloomScale",null),me([ie()],mv.prototype,"bloomEnabled",null),me([ie()],mv.prototype,"depthOfFieldEnabled",null),me([ie()],mv.prototype,"depthOfFieldBlurLevel",null),me([ie()],mv.prototype,"fxaaEnabled",null),me([ie()],mv.prototype,"samples",null),me([ie()],mv.prototype,"imageProcessingEnabled",null),me([ie()],mv.prototype,"glowLayerEnabled",null),me([ie()],mv.prototype,"chromaticAberrationEnabled",null),me([ie()],mv.prototype,"grainEnabled",null),m("BABYLON.DefaultRenderingPipeline",mv);nt.ShadersStore.lensHighlightsPixelShader="uniform sampler2D textureSampler; \nuniform float gain;uniform float threshold;uniform float screen_width;uniform float screen_height;varying vec2 vUV;vec4 highlightColor(vec4 color) {vec4 highlight=color;float luminance=dot(highlight.rgb,vec3(0.2125,0.7154,0.0721));float lum_threshold;if (threshold>1.0) { lum_threshold=0.94+0.01*threshold; }\nelse { lum_threshold=0.5+0.44*threshold; }\nluminance=clamp((luminance-lum_threshold)*(1.0/(1.0-lum_threshold)),0.0,1.0);highlight*=luminance*gain;highlight.a=1.0;return highlight;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 original=texture2D(textureSampler,vUV);if (gain==-1.0) {gl_FragColor=vec4(0.0,0.0,0.0,1.0);return;}\nfloat w=2.0/screen_width;float h=2.0/screen_height;float weight=1.0;vec4 blurred=vec4(0.0,0.0,0.0,0.0);\n#ifdef PENTAGON\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.84*w,0.43*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.48*w,-1.29*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.61*w,1.51*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.55*w,-0.74*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.71*w,-0.52*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.94*w,1.59*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.40*w,-1.87*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.62*w,1.16*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.09*w,0.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.46*w,-1.71*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.08*w,2.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.85*w,-1.89*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.89*w,0.16*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.29*w,1.88*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.40*w,-2.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.54*w,2.26*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.60*w,-0.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.31*w,-1.30*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.83*w,2.53*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.12*w,-2.48*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.60*w,1.11*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.99*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.50*w,-2.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.85*w,3.33*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.94*w,-1.92*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.27*w,-0.53*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.95*w,2.48*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.23*w,-3.04*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.17*w,2.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.97*w,-0.04*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.25*w,-2.00*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.31*w,3.08*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.94*w,-2.59*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.37*w,0.64*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.13*w,1.93*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.03*w,-3.65*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.60*w,3.17*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.14*w,-1.19*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.00*w,-1.19*h)));\n#else\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.85*w,0.36*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.52*w,-1.14*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.46*w,1.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.46*w,-0.83*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.79*w,-0.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.11*w,1.62*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.29*w,-2.07*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.69*w,1.39*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.28*w,0.12*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.65*w,-1.69*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.08*w,2.44*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.63*w,-1.90*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.55*w,0.31*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.13*w,1.52*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.56*w,-2.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.38*w,2.34*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.64*w,-0.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.53*w,-1.21*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.06*w,2.63*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.00*w,-2.69*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.59*w,1.32*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.78*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.57*w,-2.50*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.54*w,2.93*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.39*w,-1.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,-0.28*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.04*w,2.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.02*w,-3.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.09*w,2.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.07*w,-0.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.44*w,-1.90*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.52*w,3.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.68*w,-2.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,0.79*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.76*w,1.46*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.05*w,-2.94*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.21*w,2.88*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.84*w,-1.30*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.98*w,-0.96*h)));\n#endif\nblurred/=39.0;gl_FragColor=blurred;}";nt.ShadersStore.depthOfFieldPixelShader="uniform sampler2D textureSampler;uniform sampler2D highlightsSampler;uniform sampler2D depthSampler;uniform sampler2D grainSampler;uniform float grain_amount;uniform bool blur_noise;uniform float screen_width;uniform float screen_height;uniform float distortion;uniform bool dof_enabled;uniform float screen_distance; \nuniform float aperture;uniform float darken;uniform float edge_blur;uniform bool highlights;uniform float near;uniform float far;varying vec2 vUV;\n#define PI 3.14159265\n#define TWOPI 6.28318530\n#define inverse_focal_length 0.1 \nvec2 centered_screen_pos;vec2 distorted_coords;float radius2;float radius;vec2 rand(vec2 co)\n{float noise1=(fract(sin(dot(co,vec2(12.9898,78.233)))*43758.5453));float noise2=(fract(sin(dot(co,vec2(12.9898,78.233)*2.0))*43758.5453));return clamp(vec2(noise1,noise2),0.0,1.0);}\nvec2 getDistortedCoords(vec2 coords) {if (distortion==0.0) { return coords; }\nvec2 direction=1.0*normalize(centered_screen_pos);vec2 dist_coords=vec2(0.5,0.5);dist_coords.x=0.5+direction.x*radius2*1.0;dist_coords.y=0.5+direction.y*radius2*1.0;float dist_amount=clamp(distortion*0.23,0.0,1.0);dist_coords=mix(coords,dist_coords,dist_amount);return dist_coords;}\nfloat sampleScreen(inout vec4 color,in vec2 offset,in float weight) {vec2 coords=distorted_coords;float angle=rand(coords*100.0).x*TWOPI;coords+=vec2(offset.x*cos(angle)-offset.y*sin(angle),offset.x*sin(angle)+offset.y*cos(angle));color+=texture2D(textureSampler,coords)*weight;return weight;}\nfloat getBlurLevel(float size) {return min(3.0,ceil(size/1.0));}\nvec4 getBlurColor(float size) {vec4 col=texture2D(textureSampler,distorted_coords);float blur_level=getBlurLevel(size);float w=(size/screen_width);float h=(size/screen_height);float total_weight=1.0;vec2 sample_coords;total_weight+=sampleScreen(col,vec2(-0.50*w,0.24*h),0.93);total_weight+=sampleScreen(col,vec2(0.30*w,-0.75*h),0.90);total_weight+=sampleScreen(col,vec2(0.36*w,0.96*h),0.87);total_weight+=sampleScreen(col,vec2(-1.08*w,-0.55*h),0.85);total_weight+=sampleScreen(col,vec2(1.33*w,-0.37*h),0.83);total_weight+=sampleScreen(col,vec2(-0.82*w,1.31*h),0.80);total_weight+=sampleScreen(col,vec2(-0.31*w,-1.67*h),0.78);total_weight+=sampleScreen(col,vec2(1.47*w,1.11*h),0.76);total_weight+=sampleScreen(col,vec2(-1.97*w,0.19*h),0.74);total_weight+=sampleScreen(col,vec2(1.42*w,-1.57*h),0.72);if (blur_level>1.0) {total_weight+=sampleScreen(col,vec2(0.01*w,2.25*h),0.70);total_weight+=sampleScreen(col,vec2(-1.62*w,-1.74*h),0.67);total_weight+=sampleScreen(col,vec2(2.49*w,0.20*h),0.65);total_weight+=sampleScreen(col,vec2(-2.07*w,1.61*h),0.63);total_weight+=sampleScreen(col,vec2(0.46*w,-2.70*h),0.61);total_weight+=sampleScreen(col,vec2(1.55*w,2.40*h),0.59);total_weight+=sampleScreen(col,vec2(-2.88*w,-0.75*h),0.56);total_weight+=sampleScreen(col,vec2(2.73*w,-1.44*h),0.54);total_weight+=sampleScreen(col,vec2(-1.08*w,3.02*h),0.52);total_weight+=sampleScreen(col,vec2(-1.28*w,-3.05*h),0.49);}\nif (blur_level>2.0) {total_weight+=sampleScreen(col,vec2(3.11*w,1.43*h),0.46);total_weight+=sampleScreen(col,vec2(-3.36*w,1.08*h),0.44);total_weight+=sampleScreen(col,vec2(1.80*w,-3.16*h),0.41);total_weight+=sampleScreen(col,vec2(0.83*w,3.65*h),0.38);total_weight+=sampleScreen(col,vec2(-3.16*w,-2.19*h),0.34);total_weight+=sampleScreen(col,vec2(3.92*w,-0.53*h),0.31);total_weight+=sampleScreen(col,vec2(-2.59*w,3.12*h),0.26);total_weight+=sampleScreen(col,vec2(-0.20*w,-4.15*h),0.22);total_weight+=sampleScreen(col,vec2(3.02*w,3.00*h),0.15);}\ncol/=total_weight; \nif (darken>0.0) {col.rgb*=clamp(0.3,1.0,1.05-size*0.5*darken);}\nreturn col;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{centered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);radius2=centered_screen_pos.x*centered_screen_pos.x+centered_screen_pos.y*centered_screen_pos.y;radius=sqrt(radius2);distorted_coords=getDistortedCoords(vUV); \nvec2 texels_coords=vec2(vUV.x*screen_width,vUV.y*screen_height); \nfloat depth=texture2D(depthSampler,distorted_coords).r; \nfloat distance=near+(far-near)*depth; \nvec4 color=texture2D(textureSampler,vUV); \nfloat coc=abs(aperture*(screen_distance*(inverse_focal_length-1.0/distance)-1.0));if (dof_enabled==false || coc<0.07) { coc=0.0; }\nfloat edge_blur_amount=0.0;if (edge_blur>0.0) {edge_blur_amount=clamp((radius*2.0-1.0+0.15*edge_blur)*1.5,0.0,1.0)*1.3;}\nfloat blur_amount=max(edge_blur_amount,coc);if (blur_amount==0.0) {gl_FragColor=texture2D(textureSampler,distorted_coords);}\nelse {gl_FragColor=getBlurColor(blur_amount*1.7);if (highlights) {gl_FragColor.rgb+=clamp(coc,0.0,1.0)*texture2D(highlightsSampler,distorted_coords).rgb;}\nif (blur_noise) {vec2 noise=rand(distorted_coords)*0.01*blur_amount;vec2 blurred_coord=vec2(distorted_coords.x+noise.x,distorted_coords.y+noise.y);gl_FragColor=0.04*texture2D(textureSampler,blurred_coord)+0.96*gl_FragColor;}}\nif (grain_amount>0.0) {vec4 grain_color=texture2D(grainSampler,texels_coords*0.003);gl_FragColor.rgb+=(-0.5+grain_color.rgb)*0.30*grain_amount;}}\n";class gv{constructor(){this.enabled=!1,this.name="ssao2",this.texturesRequired=[6,5]}}nt.ShadersStore.ssao2PixelShader="precision highp float;uniform sampler2D textureSampler;varying vec2 vUV;\n#ifdef SSAO\nfloat scales[16]=float[16](\n0.1,\n0.11406250000000001,\n0.131640625,\n0.15625,\n0.187890625,\n0.2265625,\n0.272265625,\n0.325,\n0.384765625,\n0.4515625,\n0.525390625,\n0.60625,\n0.694140625,\n0.7890625,\n0.891015625,\n1.0\n);uniform float near;uniform float radius;uniform sampler2D depthSampler;uniform sampler2D randomSampler;uniform sampler2D normalSampler;uniform float randTextureTiles;uniform float samplesFactor;uniform vec3 sampleSphere[SAMPLES];uniform float totalStrength;uniform float base;uniform float xViewport;uniform float yViewport;uniform mat3 depthProjection;uniform float maxZ;uniform float minZAspect;uniform vec2 texelSize;uniform mat4 projection;void main()\n{vec3 random=textureLod(randomSampler,vUV*randTextureTiles,0.0).rgb;float depth=textureLod(depthSampler,vUV,0.0).r;float depthSign=depth/abs(depth);depth=depth*depthSign;vec3 normal=textureLod(normalSampler,vUV,0.0).rgb;float occlusion=0.0;float correctedRadius=min(radius,minZAspect*depth/near);vec3 vViewRay=vec3((vUV.x*2.0-1.0)*xViewport,(vUV.y*2.0-1.0)*yViewport,depthSign);vec3 vDepthFactor=depthProjection*vec3(1.0,1.0,depth);vec3 origin=vViewRay*vDepthFactor;vec3 rvec=random*2.0-1.0;rvec.z=0.0;float dotProduct=dot(rvec,normal);rvec=1.0-abs(dotProduct)>1e-2 ? rvec : vec3(-rvec.y,0.0,rvec.x);vec3 tangent=normalize(rvec-normal*dot(rvec,normal));vec3 bitangent=cross(normal,tangent);mat3 tbn=mat3(tangent,bitangent,normal);float difference;for (int i=0; i<SAMPLES; ++i) {vec3 samplePosition=scales[(i+int(random.x*16.0)) % 16]*tbn*sampleSphere[(i+int(random.y*16.0)) % 16];samplePosition=samplePosition*correctedRadius+origin;vec4 offset=vec4(samplePosition,1.0);offset=projection*offset;offset.xyz/=offset.w;offset.xy=offset.xy*0.5+0.5;if (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {continue;}\nfloat sampleDepth=abs(textureLod(depthSampler,offset.xy,0.0).r);difference=depthSign*samplePosition.z-sampleDepth;float rangeCheck=1.0-smoothstep(correctedRadius*0.5,correctedRadius,difference);occlusion+=step(EPSILON,difference)*rangeCheck;}\nocclusion=occlusion*(1.0-smoothstep(maxZ*0.75,maxZ,depth));float ao=1.0-totalStrength*occlusion*samplesFactor;float result=clamp(ao+base,0.0,1.0);gl_FragColor=vec4(vec3(result),1.0);}\n#endif\n#ifdef BLUR\nuniform float outSize;uniform float soften;uniform float tolerance;uniform int samples;\n#ifndef BLUR_BYPASS\nuniform sampler2D depthSampler;\n#ifdef BLUR_LEGACY\n#define inline\nfloat blur13Bilateral(sampler2D image,vec2 uv,vec2 step) {float result=0.0;vec2 off1=vec2(1.411764705882353)*step;vec2 off2=vec2(3.2941176470588234)*step;vec2 off3=vec2(5.176470588235294)*step;float compareDepth=abs(textureLod(depthSampler,uv,0.0).r);float sampleDepth;float weight;float weightSum=30.0;result+=textureLod(image,uv,0.0).r*30.0;sampleDepth=abs(textureLod(depthSampler,uv+off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureLod(image,uv+off1,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureLod(image,uv-off1,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv+off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv+off2,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv-off2,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv+off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv+off3,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv-off3,0.0).r*weight;return result/weightSum;}\n#endif\n#endif\nvoid main()\n{float result=0.0;\n#ifdef BLUR_BYPASS\nresult=textureLod(textureSampler,vUV,0.0).r;\n#else\n#ifdef BLUR_H\nvec2 step=vec2(1.0/outSize,0.0);\n#else\nvec2 step=vec2(0.0,1.0/outSize);\n#endif\n#ifdef BLUR_LEGACY\nresult=blur13Bilateral(textureSampler,vUV,step);\n#else\nfloat compareDepth=abs(textureLod(depthSampler,vUV,0.0).r);float weightSum=0.0;for (int i=-samples; i<samples; i+=2)\n{vec2 samplePos=vUV+step*(float(i)+0.5);float sampleDepth=abs(textureLod(depthSampler,samplePos,0.0).r);float falloff=smoothstep(0.0,\nfloat(samples),\nfloat(samples)-abs(float(i))*soften);float minDivider=tolerance*0.5+0.003;float weight=falloff/( minDivider+abs(compareDepth-sampleDepth));result+=textureLod(textureSampler,samplePos,0.0).r*weight;weightSum+=weight;}\nresult/=weightSum;\n#endif\n#endif\ngl_FragColor.rgb=vec3(result);gl_FragColor.a=1.0;}\n#endif\n";nt.ShadersStore.ssaoCombinePixelShader="uniform sampler2D textureSampler;uniform sampler2D originalColor;uniform vec4 viewport;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 ssaoColor=texture2D(textureSampler,viewport.xy+vUV*viewport.zw);vec4 sceneColor=texture2D(originalColor,vUV);gl_FragColor=sceneColor*ssaoColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";class vv extends pv{set epsilon(e){this._epsilon=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO())}get epsilon(){return this._epsilon}set samples(e){this._samples=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO()),this._sampleSphere=this._generateHemisphere()}get samples(){return this._samples}set textureSamples(e){this._textureSamples=e,this._prePassRenderer?this._prePassRenderer.samples=e:this._originalColorPostProcess.samples=e}get textureSamples(){return this._textureSamples}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}set bypassBlur(e){const t=this._getDefinesForBlur(this.expensiveBlur,e),i=this._getSamplersForBlur(e);this._blurHPostProcess.updateEffect(t.h,null,i),this._blurVPostProcess.updateEffect(t.v,null,i),this._bypassBlur=e}get bypassBlur(){return this._bypassBlur}set expensiveBlur(e){const t=this._getDefinesForBlur(e,this._bypassBlur);this._blurHPostProcess.updateEffect(t.h),this._blurVPostProcess.updateEffect(t.v),this._expensiveBlur=e}get expensiveBlur(){return this._expensiveBlur}static get IsSupported(){const e=x.LastCreatedEngine;return!!e&&e._features.supportSSAO2}get scene(){return this._scene}constructor(e,t,i,s,r=!1,n=0){var o,a;if(super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.maxZ=100,this.minZAspect=.2,this._epsilon=.02,this._samples=8,this._textureSamples=1,this._forceGeometryBuffer=!1,this.radius=2,this.base=0,this._bypassBlur=!1,this._expensiveBlur=!0,this.bilateralSamples=16,this.bilateralSoften=0,this.bilateralTolerance=0,this._bits=new Uint32Array(1),this._scene=t,this._ratio=i,this._textureType=n,this._forceGeometryBuffer=r,!this.isSupported)return void k.Error("The current engine does not support SSAO 2.");const l=this._ratio.ssaoRatio||i,h=this._ratio.blurRatio||i;this._forceGeometryBuffer?(t.enableGeometryBufferRenderer(),(null===(o=t.geometryBufferRenderer)||void 0===o?void 0:o.generateNormalsInWorldSpace)&&console.error("SSAO2RenderingPipeline does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!")):(t.enablePrePassRenderer(),(null===(a=t.prePassRenderer)||void 0===a?void 0:a.generateNormalsInWorldSpace)&&console.error("SSAO2RenderingPipeline does not support generateNormalsInWorldSpace=true for the prepass renderer!")),this._createRandomTexture(),this._originalColorPostProcess=new sa("SSAOOriginalSceneColor",1,null,Ar.BILINEAR_SAMPLINGMODE,t.getEngine(),void 0,this._textureType),this._originalColorPostProcess.samples=this.textureSamples,this._createSSAOPostProcess(1,n),this._createBlurPostProcess(l,h,this._textureType),this._createSSAOCombinePostProcess(h,this._textureType),this.addEffect(new Wg(t.getEngine(),this.SSAOOriginalSceneColorEffect,(()=>this._originalColorPostProcess),!0)),this.addEffect(new Wg(t.getEngine(),this.SSAORenderEffect,(()=>this._ssaoPostProcess),!0)),this.addEffect(new Wg(t.getEngine(),this.SSAOBlurHRenderEffect,(()=>this._blurHPostProcess),!0)),this.addEffect(new Wg(t.getEngine(),this.SSAOBlurVRenderEffect,(()=>this._blurVPostProcess),!0)),this.addEffect(new Wg(t.getEngine(),this.SSAOCombineRenderEffect,(()=>this._ssaoCombinePostProcess),!0)),t.postProcessRenderPipelineManager.addPipeline(this),s&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,s)}getClassName(){return"SSAO2RenderingPipeline"}dispose(e=!1){for(let e=0;e<this._scene.cameras.length;e++){const t=this._scene.cameras[e];this._originalColorPostProcess.dispose(t),this._ssaoPostProcess.dispose(t),this._blurHPostProcess.dispose(t),this._blurVPostProcess.dispose(t),this._ssaoCombinePostProcess.dispose(t)}this._randomTexture.dispose(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_rebuild(){super._rebuild()}_getSamplersForBlur(e){return e?["textureSampler"]:["textureSampler","depthSampler"]}_getDefinesForBlur(e,t){let i="#define BLUR\n";return t&&(i+="#define BLUR_BYPASS\n"),e||(i+="#define BLUR_LEGACY\n"),{h:i+"#define BLUR_H\n",v:i}}_createBlurPostProcess(e,t,i){const s=this._getDefinesForBlur(this.expensiveBlur,this.bypassBlur),r=this._getSamplersForBlur(this.bypassBlur);this._blurHPostProcess=this._createBlurFilter("BlurH",r,e,s.h,i,!0),this._blurVPostProcess=this._createBlurFilter("BlurV",r,t,s.v,i,!1)}_createBlurFilter(e,t,i,s,r,n){const o=new dn(e,"ssao2",["outSize","samples","soften","tolerance"],t,i,null,Ar.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,s,r);return o.onApply=e=>{if(!this._scene.activeCamera)return;const t=n?this._ssaoCombinePostProcess.width:this._ssaoCombinePostProcess.height,i=n?this._originalColorPostProcess.width:this._originalColorPostProcess.height;e.setFloat("outSize",t>0?t:i),e.setInt("samples",this.bilateralSamples),e.setFloat("soften",this.bilateralSoften),e.setFloat("tolerance",this.bilateralTolerance),this._geometryBufferRenderer?e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]):this._prePassRenderer&&e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)])},o.samples=this.textureSamples,o}_radicalInverse_VdC(e){return this._bits[0]=e,this._bits[0]=(this._bits[0]<<16|this._bits[0]>>16)>>>0,this._bits[0]=(1431655765&this._bits[0])<<1|(2863311530&this._bits[0])>>>1>>>0,this._bits[0]=(858993459&this._bits[0])<<2|(3435973836&this._bits[0])>>>2>>>0,this._bits[0]=(252645135&this._bits[0])<<4|(4042322160&this._bits[0])>>>4>>>0,this._bits[0]=(16711935&this._bits[0])<<8|(4278255360&this._bits[0])>>>8>>>0,2.3283064365386963e-10*this._bits[0]}_hammersley(e,t){return[e/t,this._radicalInverse_VdC(e)]}_hemisphereSample_uniform(e,t){const i=2*t*Math.PI,s=1-.85*e,r=Math.sqrt(1-s*s);return new S(Math.cos(i)*r,Math.sin(i)*r,s)}_generateHemisphere(){const e=this.samples,t=[];let i,s=0;for(;s<e;){if(e<16)i=this._hemisphereSample_uniform(Math.random(),Math.random());else{const t=this._hammersley(s,e);i=this._hemisphereSample_uniform(t[0],t[1])}t.push(i.x,i.y,i.z),s++}return t}_getDefinesForSSAO(){return`#define SSAO\n#define SAMPLES ${this.samples}\n#define EPSILON ${this.epsilon.toFixed(4)}`}_createSSAOPostProcess(e,t){this._sampleSphere=this._generateHemisphere();const i=this._getDefinesForSSAO();this._ssaoPostProcess=new dn("ssao2","ssao2",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","texelSize","xViewport","yViewport","maxZ","minZAspect","depthProjection"],["randomSampler","depthSampler","normalSampler"],e,null,Ar.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i,t),this._ssaoPostProcess.onApply=e=>{var t,i,s,r;if(this._scene.activeCamera){if(e.setArray3("sampleSphere",this._sampleSphere),e.setFloat("randTextureTiles",32),e.setFloat("samplesFactor",1/this.samples),e.setFloat("totalStrength",this.totalStrength),e.setFloat2("texelSize",1/this._ssaoPostProcess.width,1/this._ssaoPostProcess.height),e.setFloat("radius",this.radius),e.setFloat("maxZ",this.maxZ),e.setFloat("minZAspect",this.minZAspect),e.setFloat("base",this.base),e.setFloat("near",this._scene.activeCamera.minZ),this._scene.activeCamera.mode===ps.PERSPECTIVE_CAMERA)e.setMatrix3x3("depthProjection",vv.PERSPECTIVE_DEPTH_PROJECTION),e.setFloat("xViewport",Math.tan(this._scene.activeCamera.fov/2)*this._scene.getEngine().getAspectRatio(this._scene.activeCamera,!0)),e.setFloat("yViewport",Math.tan(this._scene.activeCamera.fov/2));else{const n=this._scene.getEngine().getRenderWidth()/2,o=this._scene.getEngine().getRenderHeight()/2,a=null!==(t=this._scene.activeCamera.orthoLeft)&&void 0!==t?t:-n,l=null!==(i=this._scene.activeCamera.orthoRight)&&void 0!==i?i:n,h=null!==(s=this._scene.activeCamera.orthoBottom)&&void 0!==s?s:-o,c=null!==(r=this._scene.activeCamera.orthoTop)&&void 0!==r?r:o;e.setMatrix3x3("depthProjection",vv.ORTHO_DEPTH_PROJECTION),e.setFloat("xViewport",.5*(l-a)),e.setFloat("yViewport",.5*(c-h))}e.setMatrix("projection",this._scene.getProjectionMatrix()),this._geometryBufferRenderer?(e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]),e.setTexture("normalSampler",this._geometryBufferRenderer.getGBuffer().textures[1])):this._prePassRenderer&&(e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)]),e.setTexture("normalSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(6)])),e.setTexture("randomSampler",this._randomTexture)}},this._ssaoPostProcess.samples=this.textureSamples,this._forceGeometryBuffer||(this._ssaoPostProcess._prePassEffectConfiguration=new gv)}_createSSAOCombinePostProcess(e,t){this._ssaoCombinePostProcess=new dn("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,Ar.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,void 0,t),this._ssaoCombinePostProcess.onApply=e=>{const t=this._scene.activeCamera.viewport;e.setVector4("viewport",R.Vector4[0].copyFromFloats(t.x,t.y,t.width,t.height)),e.setTextureFromPostProcessOutput("originalColor",this._originalColorPostProcess)},this._ssaoCombinePostProcess.samples=this.textureSamples}_createRandomTexture(){const e=new Uint8Array(65536),t=E.Zero();for(let i=0;i<e.length;)t.set(l.RandomRange(0,1),l.RandomRange(0,1)).normalize().scaleInPlace(255),e[i++]=Math.floor(t.x),e[i++]=Math.floor(t.y),e[i++]=0,e[i++]=255;const i=Mr.CreateRGBATexture(e,128,128,this._scene,!1,!1,2);i.name="SSAORandomTexture",i.wrapU=Ar.WRAP_ADDRESSMODE,i.wrapV=Ar.WRAP_ADDRESSMODE,this._randomTexture=i}serialize(){const e=de.Serialize(this);return e.customType="SSAO2RenderingPipeline",e}static Parse(e,t,i){return de.Parse((()=>new vv(e._name,t,e._ratio,void 0,e._forceGeometryBuffer,e._textureType)),e,t,i)}}vv.ORTHO_DEPTH_PROJECTION=[1,0,0,0,1,0,0,0,1],vv.PERSPECTIVE_DEPTH_PROJECTION=[0,0,0,0,0,0,1,1,1],me([ie()],vv.prototype,"totalStrength",void 0),me([ie()],vv.prototype,"maxZ",void 0),me([ie()],vv.prototype,"minZAspect",void 0),me([ie("epsilon")],vv.prototype,"_epsilon",void 0),me([ie("samples")],vv.prototype,"_samples",void 0),me([ie("textureSamples")],vv.prototype,"_textureSamples",void 0),me([ie()],vv.prototype,"_forceGeometryBuffer",void 0),me([ie()],vv.prototype,"_ratio",void 0),me([ie()],vv.prototype,"_textureType",void 0),me([ie()],vv.prototype,"radius",void 0),me([ie()],vv.prototype,"base",void 0),me([ie("bypassBlur")],vv.prototype,"_bypassBlur",void 0),me([ie("expensiveBlur")],vv.prototype,"_expensiveBlur",void 0),me([ie()],vv.prototype,"bilateralSamples",void 0),me([ie()],vv.prototype,"bilateralSoften",void 0),me([ie()],vv.prototype,"bilateralTolerance",void 0),m("BABYLON.SSAO2RenderingPipeline",vv);nt.ShadersStore.ssaoPixelShader="uniform sampler2D textureSampler;varying vec2 vUV;\n#ifdef SSAO\nuniform sampler2D randomSampler;uniform float randTextureTiles;uniform float samplesFactor;uniform vec3 sampleSphere[SAMPLES];uniform float totalStrength;uniform float radius;uniform float area;uniform float fallOff;uniform float base;vec3 normalFromDepth(float depth,vec2 coords)\n{vec2 offset1=vec2(0.0,radius);vec2 offset2=vec2(radius,0.0);float depth1=texture2D(textureSampler,coords+offset1).r;float depth2=texture2D(textureSampler,coords+offset2).r;vec3 p1=vec3(offset1,depth1-depth);vec3 p2=vec3(offset2,depth2-depth);vec3 normal=cross(p1,p2);normal.z=-normal.z;return normalize(normal);}\nvoid main()\n{vec3 random=normalize(texture2D(randomSampler,vUV*randTextureTiles).rgb);float depth=texture2D(textureSampler,vUV).r;vec3 position=vec3(vUV,depth);vec3 normal=normalFromDepth(depth,vUV);float radiusDepth=radius/depth;float occlusion=0.0;vec3 ray;vec3 hemiRay;float occlusionDepth;float difference;for (int i=0; i<SAMPLES; i++)\n{ray=radiusDepth*reflect(sampleSphere[i],random);hemiRay=position+sign(dot(ray,normal))*ray;occlusionDepth=texture2D(textureSampler,clamp(hemiRay.xy,vec2(0.001,0.001),vec2(0.999,0.999))).r;difference=depth-occlusionDepth;occlusion+=step(fallOff,difference)*(1.0-smoothstep(fallOff,area,difference));}\nfloat ao=1.0-totalStrength*occlusion*samplesFactor;float result=clamp(ao+base,0.0,1.0);gl_FragColor.r=result;gl_FragColor.g=result;gl_FragColor.b=result;gl_FragColor.a=1.0;}\n#endif\n";class xv extends pv{get scene(){return this._scene}constructor(e,t,i,s){super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.radius=1e-4,this.area=.0075,this.fallOff=1e-6,this.base=.5,this._firstUpdate=!0,this._scene=t,this._createRandomTexture();const r=i.ssaoRatio||i,n=i.combineRatio||i;this._originalColorPostProcess=new sa("SSAOOriginalSceneColor",n,null,Ar.BILINEAR_SAMPLINGMODE,t.getEngine(),!1),this._createSSAOPostProcess(r),this._createBlurPostProcess(r),this._createSSAOCombinePostProcess(n),this.addEffect(new Wg(t.getEngine(),this.SSAOOriginalSceneColorEffect,(()=>this._originalColorPostProcess),!0)),this.addEffect(new Wg(t.getEngine(),this.SSAORenderEffect,(()=>this._ssaoPostProcess),!0)),this.addEffect(new Wg(t.getEngine(),this.SSAOBlurHRenderEffect,(()=>this._blurHPostProcess),!0)),this.addEffect(new Wg(t.getEngine(),this.SSAOBlurVRenderEffect,(()=>this._blurVPostProcess),!0)),this.addEffect(new Wg(t.getEngine(),this.SSAOCombineRenderEffect,(()=>this._ssaoCombinePostProcess),!0)),t.postProcessRenderPipelineManager.addPipeline(this),s&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,s)}_attachCameras(e,t){super._attachCameras(e,t);for(const e of this._cameras)this._scene.enableDepthRenderer(e).getDepthMap()}getClassName(){return"SSAORenderingPipeline"}dispose(e=!1){for(let e=0;e<this._scene.cameras.length;e++){const t=this._scene.cameras[e];this._originalColorPostProcess.dispose(t),this._ssaoPostProcess.dispose(t),this._blurHPostProcess.dispose(t),this._blurVPostProcess.dispose(t),this._ssaoCombinePostProcess.dispose(t)}this._randomTexture.dispose(),e&&this._scene.disableDepthRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_createBlurPostProcess(e){this._blurHPostProcess=new hd("BlurH",new E(1,0),16,e,null,Ar.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurVPostProcess=new hd("BlurV",new E(0,1),16,e,null,Ar.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurHPostProcess.onActivateObservable.add((()=>{const e=this._blurHPostProcess.width/this._scene.getEngine().getRenderWidth();this._blurHPostProcess.kernel=16*e})),this._blurVPostProcess.onActivateObservable.add((()=>{const e=this._blurVPostProcess.height/this._scene.getEngine().getRenderHeight();this._blurVPostProcess.kernel=16*e}))}_rebuild(){this._firstUpdate=!0,super._rebuild()}_createSSAOPostProcess(e){const t=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271];this._ssaoPostProcess=new dn("ssao","ssao",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","area","fallOff","base","range","viewport"],["randomSampler"],e,null,Ar.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define SAMPLES 16\n#define SSAO"),this._ssaoPostProcess.externalTextureSamplerBinding=!0,this._ssaoPostProcess.onApply=e=>{this._firstUpdate&&(e.setArray3("sampleSphere",t),e.setFloat("samplesFactor",.0625),e.setFloat("randTextureTiles",4)),e.setFloat("totalStrength",this.totalStrength),e.setFloat("radius",this.radius),e.setFloat("area",this.area),e.setFloat("fallOff",this.fallOff),e.setFloat("base",this.base),e.setTexture("textureSampler",this._scene.enableDepthRenderer(this._scene.activeCamera).getDepthMap()),e.setTexture("randomSampler",this._randomTexture)}}_createSSAOCombinePostProcess(e){this._ssaoCombinePostProcess=new dn("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,Ar.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=e=>{e.setVector4("viewport",R.Vector4[0].copyFromFloats(0,0,1,1)),e.setTextureFromPostProcess("originalColor",this._originalColorPostProcess)}}_createRandomTexture(){const e=new Uint8Array(1048576);for(let t=0;t<e.length;)e[t++]=Math.floor(255*Math.max(0,l.RandomRange(-1,1))),e[t++]=Math.floor(255*Math.max(0,l.RandomRange(-1,1))),e[t++]=Math.floor(255*Math.max(0,l.RandomRange(-1,1))),e[t++]=255;const t=Mr.CreateRGBATexture(e,512,512,this._scene,!1,!1,2);t.name="SSAORandomTexture",t.wrapU=Ar.WRAP_ADDRESSMODE,t.wrapV=Ar.WRAP_ADDRESSMODE,this._randomTexture=t}}me([ie()],xv.prototype,"totalStrength",void 0),me([ie()],xv.prototype,"radius",void 0),me([ie()],xv.prototype,"area",void 0),me([ie()],xv.prototype,"fallOff",void 0),me([ie()],xv.prototype,"base",void 0);class Tv{constructor(){this.enabled=!1,this.name="screenSpaceReflections",this.texturesRequired=[6,3,1]}}nt.ShadersStore.screenSpaceReflectionPixelShader="uniform sampler2D textureSampler;\n#ifdef SSR_SUPPORTED\nuniform sampler2D reflectivitySampler;uniform sampler2D normalSampler;uniform sampler2D positionSampler;\n#endif\nuniform mat4 view;uniform mat4 projection;uniform float stepSize;uniform float strength;uniform float threshold;uniform float roughnessFactor;uniform float reflectionSpecularFalloffExponent;varying vec2 vUV;\n#ifdef SSR_SUPPORTED\nstruct ReflectionInfo {vec3 color;vec4 coords;};/**\n* According to specular,see https:\n*/\nvec3 fresnelSchlick(float cosTheta,vec3 F0)\n{return F0+(1.0-F0)*pow(1.0-cosTheta,5.0);}\n/**\n* Once the pixel's coordinates has been found,let's adjust (smooth) a little bit\n* by sampling multiple reflection pixels.\n*/\nReflectionInfo smoothReflectionInfo(vec3 dir,vec3 hitCoord)\n{ReflectionInfo info;info.color=vec3(0.0);vec4 projectedCoord;float sampledDepth;for(int i=0; i<SMOOTH_STEPS; i++)\n{projectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;float depth=sampledDepth-hitCoord.z;dir*=0.5;if(depth>0.0)\nhitCoord-=dir;else\nhitCoord+=dir;info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;}\nprojectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);info.coords=vec4(projectedCoord.xy,sampledDepth,1.0);info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;info.color/=float(SMOOTH_STEPS+1);return info;}\n/**\n* Tests the given world position (hitCoord) according to the given reflection vector (dir)\n* until it finds a collision (means that depth is enough close to say \"it's the pixel to sample!\").\n*/\nReflectionInfo getReflectionInfo(vec3 dir,vec3 hitCoord)\n{ReflectionInfo info;vec4 projectedCoord;float sampledDepth;dir*=stepSize;for(int i=0; i<REFLECTION_SAMPLES; i++)\n{hitCoord+=dir;projectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;float depth=sampledDepth-hitCoord.z;\n#ifdef RIGHT_HANDED_SCENE\ndepth*=-1.0;\n#endif\nif(((depth-dir.z)<threshold) && depth<=0.0)\n{\n#ifdef ENABLE_SMOOTH_REFLECTIONS\nreturn smoothReflectionInfo(dir,hitCoord);\n#else\ninfo.color=texture2D(textureSampler,projectedCoord.xy).rgb;info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);return info;\n#endif\n}}\ninfo.color=texture2D(textureSampler,projectedCoord.xy).rgb;info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);return info;}\nvec3 hash(vec3 a)\n{a=fract(a*0.8);a+=dot(a,a.yxz+19.19);return fract((a.xxy+a.yxx)*a.zyx);}\n#endif\nvoid main()\n{\n#ifdef SSR_SUPPORTED\nvec4 albedoFull=texture2D(textureSampler,vUV);vec3 albedo=albedoFull.rgb;float spec=texture2D(reflectivitySampler,vUV).r;if (spec==0.0) {gl_FragColor=albedoFull;return;}\nvec3 normal=(texture2D(normalSampler,vUV)).xyz;vec3 position=(view*texture2D(positionSampler,vUV)).xyz;vec3 reflected=normalize(reflect(normalize(position),normalize(normal)));float roughness=1.0-texture2D(reflectivitySampler,vUV).a;vec3 jitt=mix(vec3(0.0),hash(position),roughness)*roughnessFactor;ReflectionInfo info=getReflectionInfo(jitt+reflected,position);vec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-info.coords.xy));float screenEdgefactor=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);vec3 F0=vec3(0.04);F0 =mix(F0,albedo,spec);vec3 fresnel=fresnelSchlick(max(dot(normalize(normal),normalize(position)),0.0),F0);\n#ifdef RIGHT_HANDED_SCENE\nreflected.z*=-1.0;\n#endif\nfloat reflectionMultiplier=clamp(pow(spec*strength,reflectionSpecularFalloffExponent)*screenEdgefactor*reflected.z,0.0,0.9);float albedoMultiplier=1.0-reflectionMultiplier;vec3 SSR=info.color*fresnel;gl_FragColor=vec4((albedo*albedoMultiplier)+(SSR*reflectionMultiplier),albedoFull.a);\n#else\ngl_FragColor=texture2D(textureSampler,vUV);\n#endif\n}\n";class Ev extends dn{get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"ScreenSpaceReflectionPostProcess"}constructor(e,t,i,s,r,n,o,a=0,l=!1,h=!1){if(super(e,"screenSpaceReflection",["projection","view","threshold","reflectionSpecularFalloffExponent","strength","stepSize","roughnessFactor"],["textureSampler","normalSampler","positionSampler","reflectivitySampler"],i,s,r,n,o,"#define SSR_SUPPORTED\n#define REFLECTION_SAMPLES 64\n#define SMOOTH_STEPS 5\n",a,void 0,null,l),this.threshold=1.2,this.strength=1,this.reflectionSpecularFalloffExponent=3,this.step=1,this.roughnessFactor=.2,this._forceGeometryBuffer=!1,this._enableSmoothReflections=!1,this._reflectionSamples=64,this._smoothSteps=5,this._forceGeometryBuffer=h,this._forceGeometryBuffer){const e=t.enableGeometryBufferRenderer();e&&e.isSupported&&(e.enablePosition=!0,e.enableReflectivity=!0,e.generateNormalsInWorldSpace&&console.error("ScreenSpaceReflectionPostProcess does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!"))}else{const e=t.enablePrePassRenderer();null==e||e.markAsDirty(),(null==e?void 0:e.generateNormalsInWorldSpace)&&console.error("ScreenSpaceReflectionPostProcess does not support generateNormalsInWorldSpace=true for the prepass renderer!"),this._prePassEffectConfiguration=new Tv}this._updateEffectDefines(),this.onApply=e=>{const i=this._geometryBufferRenderer,s=this._prePassRenderer;if(!s&&!i)return;if(i){const t=i.getTextureIndex(av.POSITION_TEXTURE_TYPE),s=i.getTextureIndex(av.REFLECTIVITY_TEXTURE_TYPE);e.setTexture("normalSampler",i.getGBuffer().textures[1]),e.setTexture("positionSampler",i.getGBuffer().textures[t]),e.setTexture("reflectivitySampler",i.getGBuffer().textures[s])}else if(s){const t=s.getIndex(1),i=s.getIndex(3),r=s.getIndex(6);e.setTexture("normalSampler",s.getRenderTarget().textures[r]),e.setTexture("positionSampler",s.getRenderTarget().textures[t]),e.setTexture("reflectivitySampler",s.getRenderTarget().textures[i])}const r=t.activeCamera;if(!r)return;const n=r.getViewMatrix(!0),o=r.getProjectionMatrix(!0);e.setMatrix("projection",o),e.setMatrix("view",n),e.setFloat("threshold",this.threshold),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("strength",this.strength),e.setFloat("stepSize",this.step),e.setFloat("roughnessFactor",this.roughnessFactor)},this._isSceneRightHanded=t.useRightHandedSystem}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get reflectionSamples(){return this._reflectionSamples}set reflectionSamples(e){e!==this._reflectionSamples&&(this._reflectionSamples=e,this._updateEffectDefines())}get smoothSteps(){return this._smoothSteps}set smoothSteps(e){e!==this._smoothSteps&&(this._smoothSteps=e,this._updateEffectDefines())}_updateEffectDefines(){const e=[];(this._geometryBufferRenderer||this._prePassRenderer)&&e.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&e.push("#define ENABLE_SMOOTH_REFLECTIONS"),this._isSceneRightHanded&&e.push("#define RIGHT_HANDED_SCENE"),e.push("#define REFLECTION_SAMPLES "+(0|this._reflectionSamples)),e.push("#define SMOOTH_STEPS "+(0|this._smoothSteps)),this.updateEffect(e.join("\n"))}static _Parse(e,t,i,s){return de.Parse((()=>new Ev(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable)),e,i,s)}}me([ie()],Ev.prototype,"threshold",void 0),me([ie()],Ev.prototype,"strength",void 0),me([ie()],Ev.prototype,"reflectionSpecularFalloffExponent",void 0),me([ie()],Ev.prototype,"step",void 0),me([ie()],Ev.prototype,"roughnessFactor",void 0),me([ie()],Ev.prototype,"enableSmoothReflections",null),me([ie()],Ev.prototype,"reflectionSamples",null),me([ie()],Ev.prototype,"smoothSteps",null),m("BABYLON.ScreenSpaceReflectionPostProcess",Ev);nt.ShadersStore.standardPixelShader="uniform sampler2D textureSampler;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#if defined(PASS_POST_PROCESS)\nvoid main(void)\n{vec4 color=texture2D(textureSampler,vUV);gl_FragColor=color;}\n#endif\n#if defined(DOWN_SAMPLE_X4)\nuniform vec2 dsOffsets[16];void main(void)\n{vec4 average=vec4(0.0,0.0,0.0,0.0);average=texture2D(textureSampler,vUV+dsOffsets[0]);average+=texture2D(textureSampler,vUV+dsOffsets[1]);average+=texture2D(textureSampler,vUV+dsOffsets[2]);average+=texture2D(textureSampler,vUV+dsOffsets[3]);average+=texture2D(textureSampler,vUV+dsOffsets[4]);average+=texture2D(textureSampler,vUV+dsOffsets[5]);average+=texture2D(textureSampler,vUV+dsOffsets[6]);average+=texture2D(textureSampler,vUV+dsOffsets[7]);average+=texture2D(textureSampler,vUV+dsOffsets[8]);average+=texture2D(textureSampler,vUV+dsOffsets[9]);average+=texture2D(textureSampler,vUV+dsOffsets[10]);average+=texture2D(textureSampler,vUV+dsOffsets[11]);average+=texture2D(textureSampler,vUV+dsOffsets[12]);average+=texture2D(textureSampler,vUV+dsOffsets[13]);average+=texture2D(textureSampler,vUV+dsOffsets[14]);average+=texture2D(textureSampler,vUV+dsOffsets[15]);average/=16.0;gl_FragColor=average;}\n#endif\n#if defined(BRIGHT_PASS)\nuniform vec2 dsOffsets[4];uniform float brightThreshold;void main(void)\n{vec4 average=vec4(0.0,0.0,0.0,0.0);average=texture2D(textureSampler,vUV+vec2(dsOffsets[0].x,dsOffsets[0].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[1].x,dsOffsets[1].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[2].x,dsOffsets[2].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[3].x,dsOffsets[3].y));average*=0.25;float luminance=length(average.rgb);if (luminance<brightThreshold) {average=vec4(0.0,0.0,0.0,1.0);}\ngl_FragColor=average;}\n#endif\n#if defined(TEXTURE_ADDER)\nuniform sampler2D otherSampler;uniform sampler2D lensSampler;uniform float exposure;void main(void)\n{vec3 colour=texture2D(textureSampler,vUV).rgb;colour*=exposure;vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);colour=retColor*retColor;colour+=colour*texture2D(lensSampler,vUV).rgb;vec4 finalColor=vec4(colour.rgb,1.0)+texture2D(otherSampler,vUV);gl_FragColor=finalColor;}\n#endif\n#if defined(VLS)\n#define PI 3.1415926535897932384626433832795\nuniform mat4 shadowViewProjection;uniform mat4 lightWorld;uniform vec3 cameraPosition;uniform vec3 sunDirection;uniform vec3 sunColor;uniform vec2 depthValues;uniform float scatteringCoefficient;uniform float scatteringPower;uniform sampler2D shadowMapSampler;uniform sampler2D positionSampler;float computeScattering(float lightDotView)\n{float result=1.0-scatteringCoefficient*scatteringCoefficient;result/=(4.0*PI*pow(1.0+scatteringCoefficient*scatteringCoefficient-(2.0*scatteringCoefficient)*lightDotView,1.5));return result;}\nvoid main(void)\n{vec3 worldPos=texture2D(positionSampler,vUV).rgb;vec3 startPosition=cameraPosition;vec3 rayVector=worldPos-startPosition;float rayLength=length(rayVector);vec3 rayDirection=rayVector/rayLength;float stepLength=rayLength/NB_STEPS;vec3 stepL=rayDirection*stepLength;vec3 currentPosition=startPosition;vec3 accumFog=vec3(0.0);for (int i=0; i<int(NB_STEPS); i++)\n{vec4 worldInShadowCameraSpace=shadowViewProjection*vec4(currentPosition,1.0);float depthMetric= (worldInShadowCameraSpace.z+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depthMetric,0.0,1.0);worldInShadowCameraSpace.xyz/=worldInShadowCameraSpace.w;worldInShadowCameraSpace.xyz=0.5*worldInShadowCameraSpace.xyz+vec3(0.5);float shadowMapValue=texture2D(shadowMapSampler,worldInShadowCameraSpace.xy).r;if (shadowMapValue>shadowPixelDepth)\naccumFog+=sunColor*computeScattering(dot(rayDirection,sunDirection));currentPosition+=stepL;}\naccumFog/=NB_STEPS;vec3 color=accumFog*scatteringPower;gl_FragColor=vec4(color*exp(color) ,1.0);}\n#endif\n#if defined(VLSMERGE)\nuniform sampler2D originalSampler;void main(void)\n{gl_FragColor=texture2D(originalSampler,vUV)+texture2D(textureSampler,vUV);}\n#endif\n#if defined(LUMINANCE)\nuniform vec2 lumOffsets[4];void main()\n{float average=0.0;vec4 color=vec4(0.0);float maximum=-1e20;vec3 weight=vec3(0.299,0.587,0.114);for (int i=0; i<4; i++)\n{color=texture2D(textureSampler,vUV+ lumOffsets[i]);float GreyValue=dot(color.rgb,vec3(0.33,0.33,0.33));\n#ifdef WEIGHTED_AVERAGE\nfloat GreyValue=dot(color.rgb,weight);\n#endif\n#ifdef BRIGHTNESS\nfloat GreyValue=max(color.r,max(color.g,color.b));\n#endif\n#ifdef HSL_COMPONENT\nfloat GreyValue=0.5*(max(color.r,max(color.g,color.b))+min(color.r,min(color.g,color.b)));\n#endif\n#ifdef MAGNITUDE\nfloat GreyValue=length(color.rgb);\n#endif\nmaximum=max(maximum,GreyValue);average+=(0.25*log(1e-5+GreyValue));}\naverage=exp(average);gl_FragColor=vec4(average,maximum,0.0,1.0);}\n#endif\n#if defined(LUMINANCE_DOWN_SAMPLE)\nuniform vec2 dsOffsets[9];uniform float halfDestPixelSize;\n#ifdef FINAL_DOWN_SAMPLER\n#include<packingFunctions>\n#endif\nvoid main()\n{vec4 color=vec4(0.0);float average=0.0;for (int i=0; i<9; i++)\n{color=texture2D(textureSampler,vUV+vec2(halfDestPixelSize,halfDestPixelSize)+dsOffsets[i]);average+=color.r;}\naverage/=9.0;\n#ifdef FINAL_DOWN_SAMPLER\ngl_FragColor=pack(average);\n#else\ngl_FragColor=vec4(average,average,0.0,1.0);\n#endif\n}\n#endif\n#if defined(HDR)\nuniform sampler2D textureAdderSampler;uniform float averageLuminance;void main()\n{vec4 color=texture2D(textureAdderSampler,vUV);\n#ifndef AUTO_EXPOSURE\nvec4 adjustedColor=color/averageLuminance;color=adjustedColor;color.a=1.0;\n#endif\ngl_FragColor=color;}\n#endif\n#if defined(LENS_FLARE)\n#define GHOSTS 3\nuniform sampler2D lensColorSampler;uniform float strength;uniform float ghostDispersal;uniform float haloWidth;uniform vec2 resolution;uniform float distortionStrength;float hash(vec2 p)\n{float h=dot(p,vec2(127.1,311.7));return -1.0+2.0*fract(sin(h)*43758.5453123);}\nfloat noise(in vec2 p)\n{vec2 i=floor(p);vec2 f=fract(p);vec2 u=f*f*(3.0-2.0*f);return mix(mix(hash(i+vec2(0.0,0.0)),\nhash(i+vec2(1.0,0.0)),u.x),\nmix(hash(i+vec2(0.0,1.0)),\nhash(i+vec2(1.0,1.0)),u.x),u.y);}\nfloat fbm(vec2 p)\n{float f=0.0;f+=0.5000*noise(p); p*=2.02;f+=0.2500*noise(p); p*=2.03;f+=0.1250*noise(p); p*=2.01;f+=0.0625*noise(p); p*=2.04;f/=0.9375;return f;}\nvec3 pattern(vec2 uv)\n{vec2 p=-1.0+2.0*uv;float p2=dot(p,p);float f=fbm(vec2(15.0*p2))/2.0;float r=0.2+0.6*sin(12.5*length(uv-vec2(0.5)));float g=0.2+0.6*sin(20.5*length(uv-vec2(0.5)));float b=0.2+0.6*sin(17.2*length(uv-vec2(0.5)));return (1.0-f)*vec3(r,g,b);}\nfloat luminance(vec3 color)\n{return dot(color.rgb,vec3(0.2126,0.7152,0.0722));}\nvec4 textureDistorted(sampler2D tex,vec2 texcoord,vec2 direction,vec3 distortion)\n{return vec4(\ntexture2D(tex,texcoord+direction*distortion.r).r,\ntexture2D(tex,texcoord+direction*distortion.g).g,\ntexture2D(tex,texcoord+direction*distortion.b).b,\n1.0\n);}\nvoid main(void)\n{vec2 uv=-vUV+vec2(1.0);vec2 ghostDir=(vec2(0.5)-uv)*ghostDispersal;vec2 texelSize=1.0/resolution;vec3 distortion=vec3(-texelSize.x*distortionStrength,0.0,texelSize.x*distortionStrength);vec4 result=vec4(0.0);float ghostIndice=1.0;for (int i=0; i<GHOSTS; ++i)\n{vec2 offset=fract(uv+ghostDir*ghostIndice);float weight=length(vec2(0.5)-offset)/length(vec2(0.5));weight=pow(1.0-weight,10.0);result+=textureDistorted(textureSampler,offset,normalize(ghostDir),distortion)*weight*strength;ghostIndice+=1.0;}\nvec2 haloVec=normalize(ghostDir)*haloWidth;float weight=length(vec2(0.5)-fract(uv+haloVec))/length(vec2(0.5));weight=pow(1.0-weight,10.0);result+=textureDistorted(textureSampler,fract(uv+haloVec),normalize(ghostDir),distortion)*weight*strength;result*=texture2D(lensColorSampler,vec2(length(vec2(0.5)-uv)/length(vec2(0.5))));gl_FragColor=result;}\n#endif\n#if defined(LENS_FLARE_COMPOSE)\nuniform sampler2D otherSampler;uniform sampler2D lensDirtSampler;uniform sampler2D lensStarSampler;uniform mat4 lensStarMatrix;void main(void)\n{vec2 lensFlareCoords=(lensStarMatrix*vec4(vUV,1.0,1.0)).xy;vec4 lensMod=texture2D(lensDirtSampler,vUV);lensMod+=texture2D(lensStarSampler,vUV/*lensFlareCoords*/);vec4 result=texture2D(textureSampler,vUV)*lensMod;gl_FragColor=texture2D(otherSampler,vUV)+result;}\n#endif\n#if defined(DEPTH_OF_FIELD)\nuniform sampler2D otherSampler;uniform sampler2D depthSampler;uniform float distance;void main(void)\n{vec4 sharp=texture2D(otherSampler,vUV);vec4 blur=texture2D(textureSampler,vUV);float dist=clamp(texture2D(depthSampler,vUV).r*distance,0.0,1.0);float factor=0.0;if (dist<0.05)\nfactor=1.0;else if (dist<0.1)\nfactor=20.0*(0.1-dist);else if (dist<0.5)\nfactor=0.0;else\nfactor=2.0*(dist-0.5);factor=clamp(factor,0.0,0.90);gl_FragColor=mix(sharp,blur,factor);}\n#endif\n#if defined(MOTION_BLUR)\nuniform mat4 inverseViewProjection;uniform mat4 prevViewProjection;uniform vec2 screenSize;uniform float motionScale;uniform float motionStrength;uniform sampler2D depthSampler;void main(void)\n{vec2 texelSize=1.0/screenSize;float depth=texture2D(depthSampler,vUV).r;vec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);cpos=cpos*inverseViewProjection;vec4 ppos=cpos*prevViewProjection;ppos.xyz/=ppos.w;ppos.xy=ppos.xy*0.5+0.5;vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;float speed=length(velocity/texelSize);int nSamples=int(clamp(speed,1.0,MAX_MOTION_SAMPLES));vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(MAX_MOTION_SAMPLES); ++i) {if (i>=nSamples)\nbreak;vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);result+=texture2D(textureSampler,offset1);}\ngl_FragColor=result/float(nSamples);}\n#endif\n";class Sv extends pv{get exposure(){return this._fixedExposure}set exposure(e){this._fixedExposure=e,this._currentExposure=e}get hdrAutoExposure(){return this._hdrAutoExposure}set hdrAutoExposure(e){if(this._hdrAutoExposure=e,this.hdrPostProcess){const t=["#define HDR"];e&&t.push("#define AUTO_EXPOSURE"),this.hdrPostProcess.updateEffect(t.join("\n"))}}get motionStrength(){return this._motionStrength}set motionStrength(e){this._motionStrength=e,this._isObjectBasedMotionBlur&&this.motionBlurPostProcess&&(this.motionBlurPostProcess.motionStrength=e)}get objectBasedMotionBlur(){return this._isObjectBasedMotionBlur}set objectBasedMotionBlur(e){const t=this._isObjectBasedMotionBlur!==e;this._isObjectBasedMotionBlur=e,t&&this._buildPipeline()}get BloomEnabled(){return this._bloomEnabled}set BloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get DepthOfFieldEnabled(){return this._depthOfFieldEnabled}set DepthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get LensFlareEnabled(){return this._lensFlareEnabled}set LensFlareEnabled(e){this._lensFlareEnabled!==e&&(this._lensFlareEnabled=e,this._buildPipeline())}get HDREnabled(){return this._hdrEnabled}set HDREnabled(e){this._hdrEnabled!==e&&(this._hdrEnabled=e,this._buildPipeline())}get VLSEnabled(){return this._vlsEnabled}set VLSEnabled(e){if(this._vlsEnabled!==e){if(e&&!this._scene.enableGeometryBufferRenderer())return void k.Warn("Geometry renderer is not supported, cannot create volumetric lights in Standard Rendering Pipeline");this._vlsEnabled=e,this._buildPipeline()}}get MotionBlurEnabled(){return this._motionBlurEnabled}set MotionBlurEnabled(e){this._motionBlurEnabled!==e&&(this._motionBlurEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get screenSpaceReflectionsEnabled(){return this._screenSpaceReflectionsEnabled}set screenSpaceReflectionsEnabled(e){this._screenSpaceReflectionsEnabled!==e&&(this._screenSpaceReflectionsEnabled=e,this._buildPipeline())}get volumetricLightStepsCount(){return this._volumetricLightStepsCount}set volumetricLightStepsCount(e){this.volumetricLightPostProcess&&this.volumetricLightPostProcess.updateEffect("#define VLS\n#define NB_STEPS "+e.toFixed(1)),this._volumetricLightStepsCount=e}get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this.motionBlurPostProcess&&(this._isObjectBasedMotionBlur?this.motionBlurPostProcess.motionBlurSamples=e:this.motionBlurPostProcess.updateEffect("#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+e.toFixed(1))),this._motionBlurSamples=e}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}constructor(e,t,i,s=null,r){super(t.getEngine(),e),this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.blurHPostProcesses=[],this.blurVPostProcesses=[],this.textureAdderPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.luminancePostProcess=null,this.luminanceDownSamplePostProcesses=[],this.hdrPostProcess=null,this.textureAdderFinalPostProcess=null,this.lensFlareFinalPostProcess=null,this.hdrFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.motionBlurPostProcess=null,this.depthOfFieldPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.brightThreshold=1,this.blurWidth=512,this.horizontalBlur=!1,this.lensTexture=null,this.volumetricLightCoefficient=.2,this.volumetricLightPower=4,this.volumetricLightBlurScale=64,this.sourceLight=null,this.hdrMinimumLuminance=1,this.hdrDecreaseRate=.5,this.hdrIncreaseRate=.5,this.lensColorTexture=null,this.lensFlareStrength=20,this.lensFlareGhostDispersal=1.4,this.lensFlareHaloWidth=.7,this.lensFlareDistortionStrength=16,this.lensFlareBlurWidth=512,this.lensStarTexture=null,this.lensFlareDirtTexture=null,this.depthOfFieldDistance=10,this.depthOfFieldBlurWidth=64,this.animations=[],this._currentDepthOfFieldSource=null,this._fixedExposure=1,this._currentExposure=1,this._hdrAutoExposure=!1,this._hdrCurrentLuminance=1,this._motionStrength=1,this._isObjectBasedMotionBlur=!1,this._camerasToBeAttached=[],this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._vlsEnabled=!1,this._lensFlareEnabled=!1,this._hdrEnabled=!1,this._motionBlurEnabled=!1,this._fxaaEnabled=!1,this._screenSpaceReflectionsEnabled=!1,this._motionBlurSamples=64,this._volumetricLightStepsCount=50,this._samples=1,this._cameras=r||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._basePostProcess=s,this._ratio=i,this._floatTextureType=t.getEngine().getCaps().textureFloatRender?1:2,t.postProcessRenderPipelineManager.addPipeline(this),this._buildPipeline()}_buildPipeline(){const e=this._ratio,t=this._scene;this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._screenSpaceReflectionsEnabled&&(this.screenSpaceReflectionPostProcess=new Ev("HDRPass",t,e,null,Ar.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,this._floatTextureType),this.screenSpaceReflectionPostProcess.onApplyObservable.add((()=>{this._currentDepthOfFieldSource=this.screenSpaceReflectionPostProcess})),this.addEffect(new Wg(t.getEngine(),"HDRScreenSpaceReflections",(()=>this.screenSpaceReflectionPostProcess),!0))),this._basePostProcess?this.originalPostProcess=this._basePostProcess:this.originalPostProcess=new dn("HDRPass","standard",[],[],e,null,Ar.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",this._floatTextureType),this.originalPostProcess.autoClear=!this.screenSpaceReflectionPostProcess,this.originalPostProcess.onApplyObservable.add((()=>{this._currentDepthOfFieldSource=this.originalPostProcess})),this.addEffect(new Wg(t.getEngine(),"HDRPassPostProcess",(()=>this.originalPostProcess),!0)),this._bloomEnabled&&(this._createDownSampleX4PostProcess(t,e/4),this._createBrightPassPostProcess(t,e/4),this._createBlurPostProcesses(t,e/4,1),this._createTextureAdderPostProcess(t,e),this.textureAdderFinalPostProcess=new dn("HDRDepthOfFieldSource","standard",[],[],e,null,Ar.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new Wg(t.getEngine(),"HDRBaseDepthOfFieldSource",(()=>this.textureAdderFinalPostProcess),!0))),this._vlsEnabled&&(this._createVolumetricLightPostProcess(t,e),this.volumetricLightFinalPostProcess=new dn("HDRVLSFinal","standard",[],[],e,null,Ar.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new Wg(t.getEngine(),"HDRVLSFinal",(()=>this.volumetricLightFinalPostProcess),!0))),this._lensFlareEnabled&&(this._createLensFlarePostProcess(t,e),this.lensFlareFinalPostProcess=new dn("HDRPostLensFlareDepthOfFieldSource","standard",[],[],e,null,Ar.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new Wg(t.getEngine(),"HDRPostLensFlareDepthOfFieldSource",(()=>this.lensFlareFinalPostProcess),!0))),this._hdrEnabled&&(this._createLuminancePostProcesses(t,this._floatTextureType),this._createHdrPostProcess(t,e),this.hdrFinalPostProcess=new dn("HDRPostHDReDepthOfFieldSource","standard",[],[],e,null,Ar.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new Wg(t.getEngine(),"HDRPostHDReDepthOfFieldSource",(()=>this.hdrFinalPostProcess),!0))),this._depthOfFieldEnabled&&(this._createBlurPostProcesses(t,e/2,3,"depthOfFieldBlurWidth"),this._createDepthOfFieldPostProcess(t,e)),this._motionBlurEnabled&&this._createMotionBlurPostProcess(t,e),this._fxaaEnabled&&(this.fxaaPostProcess=new sv("fxaa",1,null,Ar.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,0),this.addEffect(new Wg(t.getEngine(),"HDRFxaa",(()=>this.fxaaPostProcess),!0))),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),!this._enableMSAAOnFirstPostProcess(this._samples)&&this._samples>1&&k.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0")}_createDownSampleX4PostProcess(e,t){const i=new Array(32);this.downSampleX4PostProcess=new dn("HDRDownSampleX4","standard",["dsOffsets"],[],t,null,Ar.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DOWN_SAMPLE_X4",this._floatTextureType),this.downSampleX4PostProcess.onApply=e=>{let t=0;const s=this.downSampleX4PostProcess.width,r=this.downSampleX4PostProcess.height;for(let e=-2;e<2;e++)for(let n=-2;n<2;n++)i[t]=(e+.5)*(1/s),i[t+1]=(n+.5)*(1/r),t+=2;e.setArray2("dsOffsets",i)},this.addEffect(new Wg(e.getEngine(),"HDRDownSampleX4",(()=>this.downSampleX4PostProcess),!0))}_createBrightPassPostProcess(e,t){const i=new Array(8);this.brightPassPostProcess=new dn("HDRBrightPass","standard",["dsOffsets","brightThreshold"],[],t,null,Ar.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define BRIGHT_PASS",this._floatTextureType),this.brightPassPostProcess.onApply=e=>{const t=1/this.brightPassPostProcess.width,s=1/this.brightPassPostProcess.height;i[0]=-.5*t,i[1]=.5*s,i[2]=.5*t,i[3]=.5*s,i[4]=-.5*t,i[5]=-.5*s,i[6]=.5*t,i[7]=-.5*s,e.setArray2("dsOffsets",i),e.setFloat("brightThreshold",this.brightThreshold)},this.addEffect(new Wg(e.getEngine(),"HDRBrightPass",(()=>this.brightPassPostProcess),!0))}_createBlurPostProcesses(e,t,i,s="blurWidth"){const r=e.getEngine(),n=new hd("HDRBlurH_"+i,new E(1,0),this[s],t,null,Ar.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType),o=new hd("HDRBlurV_"+i,new E(0,1),this[s],t,null,Ar.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType);n.onActivateObservable.add((()=>{const e=n.width/r.getRenderWidth();n.kernel=this[s]*e})),o.onActivateObservable.add((()=>{const e=o.height/r.getRenderHeight();o.kernel=this.horizontalBlur?64*e:this[s]*e})),this.addEffect(new Wg(e.getEngine(),"HDRBlurH"+i,(()=>n),!0)),this.addEffect(new Wg(e.getEngine(),"HDRBlurV"+i,(()=>o),!0)),this.blurHPostProcesses.push(n),this.blurVPostProcesses.push(o)}_createTextureAdderPostProcess(e,t){this.textureAdderPostProcess=new dn("HDRTextureAdder","standard",["exposure"],["otherSampler","lensSampler"],t,null,Ar.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define TEXTURE_ADDER",this._floatTextureType),this.textureAdderPostProcess.onApply=e=>{e.setTextureFromPostProcess("otherSampler",this._vlsEnabled?this._currentDepthOfFieldSource:this.originalPostProcess),e.setTexture("lensSampler",this.lensTexture),e.setFloat("exposure",this._currentExposure),this._currentDepthOfFieldSource=this.textureAdderFinalPostProcess},this.addEffect(new Wg(e.getEngine(),"HDRTextureAdder",(()=>this.textureAdderPostProcess),!0))}_createVolumetricLightPostProcess(e,t){const i=e.enableGeometryBufferRenderer();i.enablePosition=!0;const s=i.getGBuffer();this.volumetricLightPostProcess=new dn("HDRVLS","standard",["shadowViewProjection","cameraPosition","sunDirection","sunColor","scatteringCoefficient","scatteringPower","depthValues"],["shadowMapSampler","positionSampler"],t/8,null,Ar.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLS\n#define NB_STEPS "+this._volumetricLightStepsCount.toFixed(1));const r=E.Zero();this.volumetricLightPostProcess.onApply=e=>{if(this.sourceLight&&this.sourceLight.getShadowGenerator()&&this._scene.activeCamera){const t=this.sourceLight.getShadowGenerator();e.setTexture("shadowMapSampler",t.getShadowMap()),e.setTexture("positionSampler",s.textures[2]),e.setColor3("sunColor",this.sourceLight.diffuse),e.setVector3("sunDirection",this.sourceLight.getShadowDirection()),e.setVector3("cameraPosition",this._scene.activeCamera.globalPosition),e.setMatrix("shadowViewProjection",t.getTransformMatrix()),e.setFloat("scatteringCoefficient",this.volumetricLightCoefficient),e.setFloat("scatteringPower",this.volumetricLightPower),r.x=this.sourceLight.getDepthMinZ(this._scene.activeCamera),r.y=this.sourceLight.getDepthMaxZ(this._scene.activeCamera),e.setVector2("depthValues",r)}},this.addEffect(new Wg(e.getEngine(),"HDRVLS",(()=>this.volumetricLightPostProcess),!0)),this._createBlurPostProcesses(e,t/4,0,"volumetricLightBlurScale"),this.volumetricLightMergePostProces=new dn("HDRVLSMerge","standard",[],["originalSampler"],t,null,Ar.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLSMERGE"),this.volumetricLightMergePostProces.onApply=e=>{e.setTextureFromPostProcess("originalSampler",this._bloomEnabled?this.textureAdderFinalPostProcess:this.originalPostProcess),this._currentDepthOfFieldSource=this.volumetricLightFinalPostProcess},this.addEffect(new Wg(e.getEngine(),"HDRVLSMerge",(()=>this.volumetricLightMergePostProces),!0))}_createLuminancePostProcesses(e,t){let i=Math.pow(3,Sv.LuminanceSteps);this.luminancePostProcess=new dn("HDRLuminance","standard",["lumOffsets"],[],{width:i,height:i},null,Ar.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LUMINANCE",t);const s=[];this.luminancePostProcess.onApply=e=>{const t=1/this.luminancePostProcess.width,i=1/this.luminancePostProcess.height;s[0]=-.5*t,s[1]=.5*i,s[2]=.5*t,s[3]=.5*i,s[4]=-.5*t,s[5]=-.5*i,s[6]=.5*t,s[7]=-.5*i,e.setArray2("lumOffsets",s)},this.addEffect(new Wg(e.getEngine(),"HDRLuminance",(()=>this.luminancePostProcess),!0));for(let s=Sv.LuminanceSteps-1;s>=0;s--){i=Math.pow(3,s);let r="#define LUMINANCE_DOWN_SAMPLE\n";0===s&&(r+="#define FINAL_DOWN_SAMPLER");const n=new dn("HDRLuminanceDownSample"+s,"standard",["dsOffsets","halfDestPixelSize"],[],{width:i,height:i},null,Ar.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,r,t);this.luminanceDownSamplePostProcesses.push(n)}let r=this.luminancePostProcess;this.luminanceDownSamplePostProcesses.forEach(((t,i)=>{const s=new Array(18);t.onApply=e=>{if(!r)return;let n=0;for(let e=-1;e<2;e++)for(let t=-1;t<2;t++)s[n]=e/r.width,s[n+1]=t/r.height,n+=2;e.setArray2("dsOffsets",s),e.setFloat("halfDestPixelSize",.5/r.width),r=i===this.luminanceDownSamplePostProcesses.length-1?this.luminancePostProcess:t},i===this.luminanceDownSamplePostProcesses.length-1&&(t.onAfterRender=()=>{const t=e.getEngine().readPixels(0,0,1,1),i=new b(1/16581375,1/65025,1/255,1);t.then((e=>{const t=new Uint8Array(e.buffer);this._hdrCurrentLuminance=(t[0]*i.x+t[1]*i.y+t[2]*i.z+t[3]*i.w)/100}))}),this.addEffect(new Wg(e.getEngine(),"HDRLuminanceDownSample"+i,(()=>t),!0))}))}_createHdrPostProcess(e,t){const i=["#define HDR"];this._hdrAutoExposure&&i.push("#define AUTO_EXPOSURE"),this.hdrPostProcess=new dn("HDR","standard",["averageLuminance"],["textureAdderSampler"],t,null,Ar.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,i.join("\n"),0);let s=1,r=0,n=0;this.hdrPostProcess.onApply=t=>{if(t.setTextureFromPostProcess("textureAdderSampler",this._currentDepthOfFieldSource),r+=e.getEngine().getDeltaTime(),s<0)s=this._hdrCurrentLuminance;else{const e=(n-r)/1e3;this._hdrCurrentLuminance<s+this.hdrDecreaseRate*e?s+=this.hdrDecreaseRate*e:this._hdrCurrentLuminance>s-this.hdrIncreaseRate*e?s-=this.hdrIncreaseRate*e:s=this._hdrCurrentLuminance}this.hdrAutoExposure?this._currentExposure=this._fixedExposure/s:(s=l.Clamp(s,this.hdrMinimumLuminance,1e20),t.setFloat("averageLuminance",s)),n=r,this._currentDepthOfFieldSource=this.hdrFinalPostProcess},this.addEffect(new Wg(e.getEngine(),"HDR",(()=>this.hdrPostProcess),!0))}_createLensFlarePostProcess(e,t){this.lensFlarePostProcess=new dn("HDRLensFlare","standard",["strength","ghostDispersal","haloWidth","resolution","distortionStrength"],["lensColorSampler"],t/2,null,Ar.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE",0),this.addEffect(new Wg(e.getEngine(),"HDRLensFlare",(()=>this.lensFlarePostProcess),!0)),this._createBlurPostProcesses(e,t/4,2,"lensFlareBlurWidth"),this.lensFlareComposePostProcess=new dn("HDRLensFlareCompose","standard",["lensStarMatrix"],["otherSampler","lensDirtSampler","lensStarSampler"],t,null,Ar.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE_COMPOSE",0),this.addEffect(new Wg(e.getEngine(),"HDRLensFlareCompose",(()=>this.lensFlareComposePostProcess),!0));const i=new E(0,0);this.lensFlarePostProcess.externalTextureSamplerBinding=!0,this.lensFlarePostProcess.onApply=e=>{e.setTextureFromPostProcess("textureSampler",this._bloomEnabled?this.blurHPostProcesses[0]:this.originalPostProcess),e.setTexture("lensColorSampler",this.lensColorTexture),e.setFloat("strength",this.lensFlareStrength),e.setFloat("ghostDispersal",this.lensFlareGhostDispersal),e.setFloat("haloWidth",this.lensFlareHaloWidth),i.x=this.lensFlarePostProcess.width,i.y=this.lensFlarePostProcess.height,e.setVector2("resolution",i),e.setFloat("distortionStrength",this.lensFlareDistortionStrength)};const s=y.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1),r=y.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=e=>{if(!this._scene.activeCamera)return;e.setTextureFromPostProcess("otherSampler",this.lensFlarePostProcess),e.setTexture("lensDirtSampler",this.lensFlareDirtTexture),e.setTexture("lensStarSampler",this.lensStarTexture);const t=this._scene.activeCamera.getViewMatrix().getRow(0),i=this._scene.activeCamera.getViewMatrix().getRow(2);let n=S.Dot(t.toVector3(),new S(1,0,0))+S.Dot(i.toVector3(),new S(0,0,1));n*=4;const o=y.FromValues(.5*Math.cos(n),-Math.sin(n),0,0,Math.sin(n),.5*Math.cos(n),0,0,0,0,1,0,0,0,0,1),a=r.multiply(o).multiply(s);e.setMatrix("lensStarMatrix",a),this._currentDepthOfFieldSource=this.lensFlareFinalPostProcess}}_createDepthOfFieldPostProcess(e,t){this.depthOfFieldPostProcess=new dn("HDRDepthOfField","standard",["distance"],["otherSampler","depthSampler"],t,null,Ar.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DEPTH_OF_FIELD",0),this.depthOfFieldPostProcess.onApply=e=>{e.setTextureFromPostProcess("otherSampler",this._currentDepthOfFieldSource),e.setTexture("depthSampler",this._getDepthTexture()),e.setFloat("distance",this.depthOfFieldDistance)},this.addEffect(new Wg(e.getEngine(),"HDRDepthOfField",(()=>this.depthOfFieldPostProcess),!0))}_createMotionBlurPostProcess(e,t){if(this._isObjectBasedMotionBlur){const i=new cv("HDRMotionBlur",e,t,null,Ar.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,0);i.motionStrength=this.motionStrength,i.motionBlurSamples=this.motionBlurSamples,this.motionBlurPostProcess=i}else{this.motionBlurPostProcess=new dn("HDRMotionBlur","standard",["inverseViewProjection","prevViewProjection","screenSize","motionScale","motionStrength"],["depthSampler"],t,null,Ar.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+this.motionBlurSamples.toFixed(1),0);let i=0,s=y.Identity();const r=y.Identity();let n=y.Identity();const o=E.Zero();this.motionBlurPostProcess.onApply=t=>{n=e.getProjectionMatrix().multiply(e.getViewMatrix()),n.invertToRef(r),t.setMatrix("inverseViewProjection",r),t.setMatrix("prevViewProjection",s),s=n,o.x=this.motionBlurPostProcess.width,o.y=this.motionBlurPostProcess.height,t.setVector2("screenSize",o),i=e.getEngine().getFps()/60,t.setFloat("motionScale",i),t.setFloat("motionStrength",this.motionStrength),t.setTexture("depthSampler",this._getDepthTexture())}}this.addEffect(new Wg(e.getEngine(),"HDRMotionBlur",(()=>this.motionBlurPostProcess),!0))}_getDepthTexture(){return this._scene.getEngine().getCaps().drawBuffersExtension?this._scene.enableGeometryBufferRenderer().getGBuffer().textures[0]:this._scene.enableDepthRenderer().getDepthMap()}_disposePostProcesses(){for(let e=0;e<this._cameras.length;e++){const t=this._cameras[e];this.originalPostProcess&&this.originalPostProcess.dispose(t),this.screenSpaceReflectionPostProcess&&this.screenSpaceReflectionPostProcess.dispose(t),this.downSampleX4PostProcess&&this.downSampleX4PostProcess.dispose(t),this.brightPassPostProcess&&this.brightPassPostProcess.dispose(t),this.textureAdderPostProcess&&this.textureAdderPostProcess.dispose(t),this.volumetricLightPostProcess&&this.volumetricLightPostProcess.dispose(t),this.volumetricLightSmoothXPostProcess&&this.volumetricLightSmoothXPostProcess.dispose(t),this.volumetricLightSmoothYPostProcess&&this.volumetricLightSmoothYPostProcess.dispose(t),this.volumetricLightMergePostProces&&this.volumetricLightMergePostProces.dispose(t),this.volumetricLightFinalPostProcess&&this.volumetricLightFinalPostProcess.dispose(t),this.lensFlarePostProcess&&this.lensFlarePostProcess.dispose(t),this.lensFlareComposePostProcess&&this.lensFlareComposePostProcess.dispose(t);for(let e=0;e<this.luminanceDownSamplePostProcesses.length;e++)this.luminanceDownSamplePostProcesses[e].dispose(t);this.luminancePostProcess&&this.luminancePostProcess.dispose(t),this.hdrPostProcess&&this.hdrPostProcess.dispose(t),this.hdrFinalPostProcess&&this.hdrFinalPostProcess.dispose(t),this.depthOfFieldPostProcess&&this.depthOfFieldPostProcess.dispose(t),this.motionBlurPostProcess&&this.motionBlurPostProcess.dispose(t),this.fxaaPostProcess&&this.fxaaPostProcess.dispose(t);for(let e=0;e<this.blurHPostProcesses.length;e++)this.blurHPostProcesses[e].dispose(t);for(let e=0;e<this.blurVPostProcesses.length;e++)this.blurVPostProcesses[e].dispose(t)}this.originalPostProcess=null,this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.textureAdderPostProcess=null,this.textureAdderFinalPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.luminancePostProcess=null,this.hdrPostProcess=null,this.hdrFinalPostProcess=null,this.depthOfFieldPostProcess=null,this.motionBlurPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.luminanceDownSamplePostProcesses.length=0,this.blurHPostProcesses.length=0,this.blurVPostProcesses.length=0}dispose(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),super.dispose()}serialize(){const e=de.Serialize(this);return this.sourceLight&&(e.sourceLightId=this.sourceLight.id),this.screenSpaceReflectionPostProcess&&(e.screenSpaceReflectionPostProcess=de.Serialize(this.screenSpaceReflectionPostProcess)),e.customType="StandardRenderingPipeline",e}static Parse(e,t,i){const s=de.Parse((()=>new Sv(e._name,t,e._ratio)),e,t,i);return e.sourceLightId&&(s.sourceLight=t.getLightById(e.sourceLightId)),e.screenSpaceReflectionPostProcess&&de.Parse((()=>s.screenSpaceReflectionPostProcess),e.screenSpaceReflectionPostProcess,t,i),s}}Sv.LuminanceSteps=6,me([ie()],Sv.prototype,"brightThreshold",void 0),me([ie()],Sv.prototype,"blurWidth",void 0),me([ie()],Sv.prototype,"horizontalBlur",void 0),me([ie()],Sv.prototype,"exposure",null),me([se("lensTexture")],Sv.prototype,"lensTexture",void 0),me([ie()],Sv.prototype,"volumetricLightCoefficient",void 0),me([ie()],Sv.prototype,"volumetricLightPower",void 0),me([ie()],Sv.prototype,"volumetricLightBlurScale",void 0),me([ie()],Sv.prototype,"hdrMinimumLuminance",void 0),me([ie()],Sv.prototype,"hdrDecreaseRate",void 0),me([ie()],Sv.prototype,"hdrIncreaseRate",void 0),me([ie()],Sv.prototype,"hdrAutoExposure",null),me([se("lensColorTexture")],Sv.prototype,"lensColorTexture",void 0),me([ie()],Sv.prototype,"lensFlareStrength",void 0),me([ie()],Sv.prototype,"lensFlareGhostDispersal",void 0),me([ie()],Sv.prototype,"lensFlareHaloWidth",void 0),me([ie()],Sv.prototype,"lensFlareDistortionStrength",void 0),me([ie()],Sv.prototype,"lensFlareBlurWidth",void 0),me([se("lensStarTexture")],Sv.prototype,"lensStarTexture",void 0),me([se("lensFlareDirtTexture")],Sv.prototype,"lensFlareDirtTexture",void 0),me([ie()],Sv.prototype,"depthOfFieldDistance",void 0),me([ie()],Sv.prototype,"depthOfFieldBlurWidth",void 0),me([ie()],Sv.prototype,"motionStrength",null),me([ie()],Sv.prototype,"objectBasedMotionBlur",null),me([ie()],Sv.prototype,"_ratio",void 0),me([ie()],Sv.prototype,"BloomEnabled",null),me([ie()],Sv.prototype,"DepthOfFieldEnabled",null),me([ie()],Sv.prototype,"LensFlareEnabled",null),me([ie()],Sv.prototype,"HDREnabled",null),me([ie()],Sv.prototype,"VLSEnabled",null),me([ie()],Sv.prototype,"MotionBlurEnabled",null),me([ie()],Sv.prototype,"fxaaEnabled",null),me([ie()],Sv.prototype,"screenSpaceReflectionsEnabled",null),me([ie()],Sv.prototype,"volumetricLightStepsCount",null),me([ie()],Sv.prototype,"motionBlurSamples",null),me([ie()],Sv.prototype,"samples",null),m("BABYLON.StandardRenderingPipeline",Sv);class bv{constructor(){this.enabled=!1,this.name="screenSpaceReflections2",this.texturesRequired=[6,3,5]}}nt.IncludesShadersStore.screenSpaceRayTrace="float distanceSquared(vec2 a,vec2 b) { a-=b; return dot(a,a); }\n/**\nparam csOrigin Camera-space ray origin,which must be \nwithin the view volume and must have z>0.01 and project within the valid screen rectangle\nparam csDirection Unit length camera-space ray direction\nparam projectToPixelMatrix A projection matrix that maps to **pixel** coordinates \n(**not** [-1,+1] normalized device coordinates).\nparam csZBuffer The camera-space Z buffer\nparam csZBufferSize Dimensions of csZBuffer\nparam csZThickness Camera space csZThickness to ascribe to each pixel in the depth buffer\nparam nearPlaneZ Positive number. Doesn't have to be THE actual near plane,just a reasonable value\nfor clipping rays headed towards the camera\nparam stride Step in horizontal or vertical pixels between samples. This is a float\nbecause integer math is slow on GPUs,but should be set to an integer>=1\nparam jitterFraction Number between 0 and 1 for how far to bump the ray in stride units\nto conceal banding artifacts,plus the stride ray offset.\nparam maxSteps Maximum number of iterations. Higher gives better images but may be slow\nparam maxRayTraceDistance Maximum camera-space distance to trace before returning a miss\nparam selfCollisionNumSkip Number of steps to skip at start when raytracing to avoid self collisions.\n1 is a reasonable value,depending on the scene you may need to set this value to 2\nparam hitPixel Pixel coordinates of the first intersection with the scene\nparam numIterations number of iterations performed\nparam csHitPoint Camera space location of the ray hit\n*/\n#define inline\nbool traceScreenSpaceRay1(\nvec3 csOrigin,\nvec3 csDirection,\nmat4 projectToPixelMatrix,\nsampler2D csZBuffer,\nvec2 csZBufferSize,\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nsampler2D csZBackBuffer,\nfloat csZBackSizeFactor,\n#endif\nfloat csZThickness,\nfloat nearPlaneZ,\nfloat stride,\nfloat jitterFraction,\nfloat maxSteps,\nfloat maxRayTraceDistance,\nfloat selfCollisionNumSkip,\nout vec2 startPixel,\nout vec2 hitPixel,\nout vec3 csHitPoint,\nout float numIterations\n#ifdef SSRAYTRACE_DEBUG\n,out vec3 debugColor\n#endif\n)\n{\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nfloat rayLength=(csOrigin.z+csDirection.z*maxRayTraceDistance)>-nearPlaneZ ? (-nearPlaneZ-csOrigin.z)/csDirection.z : maxRayTraceDistance;\n#else\nfloat rayLength=(csOrigin.z+csDirection.z*maxRayTraceDistance)<nearPlaneZ ? (nearPlaneZ-csOrigin.z)/csDirection.z : maxRayTraceDistance;\n#endif\nvec3 csEndPoint=csOrigin+csDirection*rayLength;hitPixel=vec2(-1.0,-1.0);vec4 H0=projectToPixelMatrix*vec4(csOrigin,1.0);vec4 H1=projectToPixelMatrix*vec4(csEndPoint,1.0);float k0=1.0/H0.w;float k1=1.0/H1.w;vec3 Q0=csOrigin*k0;vec3 Q1=csEndPoint*k1;vec2 P0=H0.xy*k0;vec2 P1=H1.xy*k1;\n#ifdef SSRAYTRACE_CLIP_TO_FRUSTUM\nfloat xMax=csZBufferSize.x-0.5,xMin=0.5,yMax=csZBufferSize.y-0.5,yMin=0.5;float alpha=0.0;if ((P1.y>yMax) || (P1.y<yMin)) {alpha=(P1.y-((P1.y>yMax) ? yMax : yMin))/(P1.y-P0.y);}\nif ((P1.x>xMax) || (P1.x<xMin)) {alpha=max(alpha,(P1.x-((P1.x>xMax) ? xMax : xMin))/(P1.x-P0.x));}\nP1=mix(P1,P0,alpha); k1=mix(k1,k0,alpha); Q1=mix(Q1,Q0,alpha);\n#endif\nP1+=vec2((distanceSquared(P0,P1)<0.0001) ? 0.01 : 0.0);vec2 delta=P1-P0;bool permute=false;if (abs(delta.x)<abs(delta.y)) { \npermute=true;delta=delta.yx;P0=P0.yx;P1=P1.yx; }\nfloat stepDirection=sign(delta.x);float invdx=stepDirection/delta.x;vec2 dP=vec2(stepDirection,delta.y*invdx);vec3 dQ=(Q1-Q0)*invdx;float dk=(k1-k0)*invdx;float zMin=min(csEndPoint.z,csOrigin.z);float zMax=max(csEndPoint.z,csOrigin.z);dP*=stride; dQ*=stride; dk*=stride;P0+=dP*jitterFraction; Q0+=dQ*jitterFraction; k0+=dk*jitterFraction;vec4 pqk=vec4(P0,Q0.z,k0);vec4 dPQK=vec4(dP,dQ.z,dk);startPixel=permute ? P0.yx : P0.xy;float prevZMaxEstimate=csOrigin.z;float rayZMin=prevZMaxEstimate,rayZMax=prevZMaxEstimate;float sceneZMax=rayZMax+1e4;float end=P1.x*stepDirection;bool hit=false;float stepCount;for (stepCount=0.0;stepCount<=selfCollisionNumSkip ||\n(pqk.x*stepDirection)<=end &&\nstepCount<maxSteps &&\n!hit &&\nsceneZMax != 0.0; \npqk+=dPQK,++stepCount)\n{hitPixel=permute ? pqk.yx : pqk.xy;rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;if (rayZMin>rayZMax) { \nfloat t=rayZMin; rayZMin=rayZMax; rayZMax=t;}\nsceneZMax=texelFetch(csZBuffer,ivec2(hitPixel),0).r;\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nfloat sceneBackZ=texelFetch(csZBackBuffer,ivec2(hitPixel/csZBackSizeFactor),0).r;hit=(rayZMax>=sceneBackZ-csZThickness) && (rayZMin<=sceneZMax);\n#else\nhit=(rayZMax>=sceneZMax-csZThickness) && (rayZMin<=sceneZMax);\n#endif\n#else\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nfloat sceneBackZ=texelFetch(csZBackBuffer,ivec2(hitPixel/csZBackSizeFactor),0).r;hit=(rayZMin<=sceneBackZ+csZThickness) && (rayZMax>=sceneZMax) && (sceneZMax != 0.0);\n#else\nhit=(rayZMin<=sceneZMax+csZThickness) && (rayZMax>=sceneZMax);\n#endif\n#endif\n}\npqk-=dPQK;stepCount-=1.0;if (((pqk.x+dPQK.x)*stepDirection)>end || (stepCount+1.0)>=maxSteps || sceneZMax==0.0) {hit=false;}\n#ifdef SSRAYTRACE_ENABLE_REFINEMENT\nif (stride>1.0 && hit) {pqk-=dPQK;stepCount-=1.0;float invStride=1.0/stride;dPQK*=invStride;float refinementStepCount=0.0;prevZMaxEstimate=pqk.z/pqk.w;rayZMax=prevZMaxEstimate;sceneZMax=rayZMax+1e7;for (;refinementStepCount<=1.0 ||\n(refinementStepCount<=stride*1.4) &&\n(rayZMax<sceneZMax) && (sceneZMax != 0.0);pqk+=dPQK,refinementStepCount+=1.0)\n{rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;rayZMax=max(rayZMax,rayZMin);hitPixel=permute ? pqk.yx : pqk.xy;sceneZMax=texelFetch(csZBuffer,ivec2(hitPixel),0).r;}\npqk-=dPQK;refinementStepCount-=1.0;stepCount+=refinementStepCount/stride;}\n#endif\nQ0.xy+=dQ.xy*stepCount;Q0.z=pqk.z;csHitPoint=Q0/pqk.w;numIterations=stepCount+1.0;\n#ifdef SSRAYTRACE_DEBUG\nif (((pqk.x+dPQK.x)*stepDirection)>end) {debugColor=vec3(0,0,1);} else if ((stepCount+1.0)>=maxSteps) {debugColor=vec3(1,0,0);} else if (sceneZMax==0.0) {debugColor=vec3(1,1,0);} else {debugColor=vec3(0,stepCount/maxSteps,0);}\n#endif\nreturn hit;}\n/**\ntexCoord: in the [0,1] range\ndepth: depth in view space (range [znear,zfar]])\n*/\nvec3 computeViewPosFromUVDepth(vec2 texCoord,float depth,mat4 projection,mat4 invProjectionMatrix) {vec4 ndc;ndc.xy=texCoord*2.0-1.0;\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nndc.z=-projection[2].z-projection[3].z/depth;\n#else\nndc.z=projection[2].z+projection[3].z/depth;\n#endif\nndc.w=1.0;vec4 eyePos=invProjectionMatrix*ndc;eyePos.xyz/=eyePos.w;return eyePos.xyz;}\n";nt.ShadersStore.screenSpaceReflection2PixelShader="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)\n#define TEXTURECUBEFUNC(s,c,lod) textureLod(s,c,lod)\n#else\n#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)\n#define TEXTURECUBEFUNC(s,c,bias) textureCube(s,c,bias)\n#endif\nuniform sampler2D textureSampler;varying vec2 vUV;\n#ifdef SSR_SUPPORTED\nuniform sampler2D reflectivitySampler;uniform sampler2D normalSampler;uniform sampler2D depthSampler;\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nuniform sampler2D backDepthSampler;uniform float backSizeFactor;\n#endif\n#ifdef SSR_USE_ENVIRONMENT_CUBE\nuniform samplerCube envCubeSampler;\n#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC\nuniform vec3 vReflectionPosition;uniform vec3 vReflectionSize;\n#endif\n#endif\nuniform mat4 view;uniform mat4 invView;uniform mat4 projection;uniform mat4 invProjectionMatrix;uniform mat4 projectionPixel;uniform float nearPlaneZ;uniform float stepSize;uniform float maxSteps;uniform float strength;uniform float thickness;uniform float roughnessFactor;uniform float reflectionSpecularFalloffExponent;uniform float maxDistance;uniform float selfCollisionNumSkip;uniform float reflectivityThreshold;\n#include<helperFunctions>\n#include<pbrBRDFFunctions>\n#include<screenSpaceRayTrace>\nvec3 hash(vec3 a)\n{a=fract(a*0.8);a+=dot(a,a.yxz+19.19);return fract((a.xxy+a.yxx)*a.zyx);}\nfloat computeAttenuationForIntersection(ivec2 hitPixel,vec2 hitUV,vec3 vsRayOrigin,vec3 vsHitPoint,vec3 reflectionVector,float maxRayDistance,float numIterations) {float attenuation=1.0;\n#ifdef SSR_ATTENUATE_SCREEN_BORDERS\nvec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-hitUV.xy));attenuation*=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);\n#endif\n#ifdef SSR_ATTENUATE_INTERSECTION_DISTANCE\nattenuation*=1.0-clamp(distance(vsRayOrigin,vsHitPoint)/maxRayDistance,0.0,1.0);\n#endif\n#ifdef SSR_ATTENUATE_INTERSECTION_NUMITERATIONS\nattenuation*=1.0-(numIterations/maxSteps);\n#endif\n#ifdef SSR_ATTENUATE_BACKFACE_REFLECTION\nvec3 reflectionNormal=texelFetch(normalSampler,hitPixel,0).xyz;float directionBasedAttenuation=smoothstep(-0.17,0.0,dot(reflectionNormal,-reflectionVector));attenuation*=directionBasedAttenuation;\n#endif\nreturn attenuation;}\n#endif\nvoid main()\n{\n#ifdef SSR_SUPPORTED\nvec4 colorFull=TEXTUREFUNC(textureSampler,vUV,0.0);vec3 color=colorFull.rgb;vec4 reflectivity=TEXTUREFUNC(reflectivitySampler,vUV,0.0);\n#ifndef SSR_DISABLE_REFLECTIVITY_TEST\nif (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=reflectivityThreshold) {\n#ifdef SSR_USE_BLUR\ngl_FragColor=vec4(0.);\n#else\ngl_FragColor=colorFull;\n#endif\nreturn;}\n#endif\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\ncolor=toLinearSpace(color);\n#endif\nvec2 texSize=vec2(textureSize(depthSampler,0));vec3 csNormal=texelFetch(normalSampler,ivec2(vUV*texSize),0).xyz; \nfloat depth=texelFetch(depthSampler,ivec2(vUV*texSize),0).r;vec3 csPosition=computeViewPosFromUVDepth(vUV,depth,projection,invProjectionMatrix);vec3 csViewDirection=normalize(csPosition);vec3 csReflectedVector=reflect(csViewDirection,csNormal);\n#ifdef SSR_USE_ENVIRONMENT_CUBE\nvec3 wReflectedVector=vec3(invView*vec4(csReflectedVector,0.0));\n#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC\nvec4 worldPos=invView*vec4(csPosition,1.0);wReflectedVector=parallaxCorrectNormal(worldPos.xyz,normalize(wReflectedVector),vReflectionSize,vReflectionPosition);\n#endif\n#ifdef SSR_INVERTCUBICMAP\nwReflectedVector.y*=-1.0;\n#endif\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nwReflectedVector.z*=-1.0;\n#endif\nvec3 envColor=TEXTURECUBEFUNC(envCubeSampler,wReflectedVector,0.0).xyz;\n#ifdef SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE\nenvColor=toLinearSpace(envColor);\n#endif\n#else\nvec3 envColor=color;\n#endif\nfloat reflectionAttenuation=1.0;bool rayHasHit=false;vec2 startPixel;vec2 hitPixel;vec3 hitPoint;float numIterations;\n#ifdef SSRAYTRACE_DEBUG\nvec3 debugColor;\n#endif\n#ifdef SSR_ATTENUATE_FACING_CAMERA\nreflectionAttenuation*=1.0-smoothstep(0.25,0.5,dot(-csViewDirection,csReflectedVector));\n#endif\nif (reflectionAttenuation>0.0) {\n#ifdef SSR_USE_BLUR\nvec3 jitt=vec3(0.);\n#else\nfloat roughness=1.0-reflectivity.a;vec3 jitt=mix(vec3(0.0),hash(csPosition)-vec3(0.5),roughness)*roughnessFactor; \n#endif\nvec2 uv2=vUV*texSize;float c=(uv2.x+uv2.y)*0.25;float jitter=mod(c,1.0); \nrayHasHit=traceScreenSpaceRay1(\ncsPosition,\nnormalize(csReflectedVector+jitt),\nprojectionPixel,\ndepthSampler,\ntexSize,\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nbackDepthSampler,\nbackSizeFactor,\n#endif\nthickness,\nnearPlaneZ,\nstepSize,\njitter,\nmaxSteps,\nmaxDistance,\nselfCollisionNumSkip,\nstartPixel,\nhitPixel,\nhitPoint,\nnumIterations\n#ifdef SSRAYTRACE_DEBUG\n,debugColor\n#endif\n);}\n#ifdef SSRAYTRACE_DEBUG\ngl_FragColor=vec4(debugColor,1.);return;\n#endif\nvec3 F0=reflectivity.rgb;vec3 fresnel=fresnelSchlickGGX(max(dot(csNormal,-csViewDirection),0.0),F0,vec3(1.));vec3 SSR=envColor;if (rayHasHit) {vec3 reflectedColor=texelFetch(textureSampler,ivec2(hitPixel),0).rgb;\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\nreflectedColor=toLinearSpace(reflectedColor);\n#endif\nreflectionAttenuation*=computeAttenuationForIntersection(ivec2(hitPixel),hitPixel/texSize,csPosition,hitPoint,csReflectedVector,maxDistance,numIterations);SSR=reflectedColor*reflectionAttenuation+(1.0-reflectionAttenuation)*envColor;}\n#ifndef SSR_BLEND_WITH_FRESNEL\nSSR*=fresnel;\n#endif\n#ifdef SSR_USE_BLUR\nfloat blur_radius=0.0;float roughness=1.0-reflectivity.a*(1.0-roughnessFactor);if (roughness>0.001) {float cone_angle=min(roughness,0.999)*3.14159265*0.5;float cone_len=distance(startPixel,hitPixel);float op_len=2.0*tan(cone_angle)*cone_len; \nfloat a=op_len;float h=cone_len;float a2=a*a;float fh2=4.0f*h*h;blur_radius=(a*(sqrt(a2+fh2)-a))/(4.0f*h);}\ngl_FragColor=vec4(SSR,blur_radius/255.0); \n#else\n#ifdef SSR_BLEND_WITH_FRESNEL\nvec3 reflectionMultiplier=clamp(pow(fresnel*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);\n#else\nvec3 reflectionMultiplier=clamp(pow(reflectivity.rgb*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);\n#endif\nvec3 colorMultiplier=1.0-reflectionMultiplier;vec3 finalColor=(color*colorMultiplier)+(SSR*reflectionMultiplier);\n#ifdef SSR_OUTPUT_IS_GAMMA_SPACE\nfinalColor=toGammaSpace(finalColor);\n#endif\ngl_FragColor=vec4(finalColor,colorFull.a);\n#endif\n#else\ngl_FragColor=TEXTUREFUNC(textureSampler,vUV,0.0);\n#endif\n}\n";nt.ShadersStore.screenSpaceReflection2BlurPixelShader="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)\n#else\n#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)\n#endif\nuniform sampler2D textureSampler;varying vec2 vUV;uniform vec2 texelOffsetScale;const float weights[8]=float[8] (0.071303,0.131514,0.189879,0.321392,0.452906, 0.584419,0.715932,0.847445);void processSample(vec2 uv,float i,vec2 stepSize,inout vec4 accumulator,inout float denominator)\n{vec2 offsetUV=stepSize*i+uv;float coefficient=weights[int(2.0-abs(i))];accumulator+=TEXTUREFUNC(textureSampler,offsetUV,0.0)*coefficient;denominator+=coefficient;}\nvoid main()\n{vec4 colorFull=TEXTUREFUNC(textureSampler,vUV,0.0);if (dot(colorFull,vec4(1.0))==0.0) {gl_FragColor=colorFull;return;}\nfloat blurRadius=colorFull.a*255.0; \nvec2 stepSize=texelOffsetScale.xy*blurRadius;vec4 accumulator=TEXTUREFUNC(textureSampler,vUV,0.0)*0.214607;float denominator=0.214607;processSample(vUV,1.0,stepSize,accumulator,denominator);processSample(vUV,1.0*0.2,stepSize,accumulator,denominator);processSample(vUV,1.0*0.4,stepSize,accumulator,denominator);processSample(vUV,1.0*0.6,stepSize,accumulator,denominator);processSample(vUV,1.0*0.8,stepSize,accumulator,denominator);processSample(vUV,1.0*1.2,stepSize,accumulator,denominator);processSample(vUV,1.0*1.4,stepSize,accumulator,denominator);processSample(vUV,1.0*1.6,stepSize,accumulator,denominator);processSample(vUV,1.0*1.8,stepSize,accumulator,denominator);processSample(vUV,1.0*2.0,stepSize,accumulator,denominator);processSample(vUV,-1.0,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.2,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.4,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.6,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.8,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.2,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.4,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.6,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.8,stepSize,accumulator,denominator);processSample(vUV,-1.0*2.0,stepSize,accumulator,denominator);gl_FragColor=vec4(accumulator.rgb/denominator,colorFull.a);}\n";nt.ShadersStore.screenSpaceReflection2BlurCombinerPixelShader="uniform sampler2D textureSampler; \nuniform sampler2D mainSampler;uniform sampler2D reflectivitySampler;uniform float strength;uniform float reflectionSpecularFalloffExponent;uniform float reflectivityThreshold;varying vec2 vUV;\n#include<helperFunctions>\n#ifdef SSR_BLEND_WITH_FRESNEL\n#include<pbrBRDFFunctions>\n#include<screenSpaceRayTrace>\nuniform mat4 projection;uniform mat4 invProjectionMatrix;uniform sampler2D normalSampler;uniform sampler2D depthSampler;\n#endif\nvoid main()\n{\n#ifdef SSRAYTRACE_DEBUG\ngl_FragColor=texture2D(textureSampler,vUV);\n#else\nvec3 SSR=texture2D(textureSampler,vUV).rgb;vec4 color=texture2D(mainSampler,vUV);vec4 reflectivity=texture2D(reflectivitySampler,vUV);\n#ifndef SSR_DISABLE_REFLECTIVITY_TEST\nif (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=reflectivityThreshold) {gl_FragColor=color;return;}\n#endif\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\ncolor=toLinearSpace(color);\n#endif\n#ifdef SSR_BLEND_WITH_FRESNEL\nvec2 texSize=vec2(textureSize(depthSampler,0));vec3 csNormal=texelFetch(normalSampler,ivec2(vUV*texSize),0).xyz;float depth=texelFetch(depthSampler,ivec2(vUV*texSize),0).r;vec3 csPosition=computeViewPosFromUVDepth(vUV,depth,projection,invProjectionMatrix);vec3 csViewDirection=normalize(csPosition);vec3 F0=reflectivity.rgb;vec3 fresnel=fresnelSchlickGGX(max(dot(csNormal,-csViewDirection),0.0),F0,vec3(1.));vec3 reflectionMultiplier=clamp(pow(fresnel*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);\n#else\nvec3 reflectionMultiplier=clamp(pow(reflectivity.rgb*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);\n#endif\nvec3 colorMultiplier=1.0-reflectionMultiplier;vec3 finalColor=(color.rgb*colorMultiplier)+(SSR*reflectionMultiplier);\n#ifdef SSR_OUTPUT_IS_GAMMA_SPACE\nfinalColor=toGammaSpace(finalColor);\n#endif\ngl_FragColor=vec4(finalColor,color.a);\n#endif\n}\n";const Cv=y.Compose(new S(.5,.5,.5),C.Identity(),new S(.5,.5,.5)),yv=y.Compose(new S(.5,.5,1),C.Identity(),new S(.5,.5,0));class Av extends pv{set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}get reflectivityThreshold(){return this._reflectivityThreshold}set reflectivityThreshold(e){e!==this._reflectivityThreshold&&(0===e&&0!==this._reflectivityThreshold||0!==e&&0===this._reflectivityThreshold?(this._reflectivityThreshold=e,this._buildPipeline()):this._reflectivityThreshold=e)}get ssrDownsample(){return this._ssrDownsample}set ssrDownsample(e){e!==this._ssrDownsample&&(this._ssrDownsample=e,this._buildPipeline())}get blurDispersionStrength(){return this._blurDispersionStrength}set blurDispersionStrength(e){if(e===this._blurDispersionStrength)return;const t=0===e&&0!==this._blurDispersionStrength||0!==e&&0===this._blurDispersionStrength;this._blurDispersionStrength=e,t&&this._buildPipeline()}_useBlur(){return this._blurDispersionStrength>0}get blurDownsample(){return this._blurDownsample}set blurDownsample(e){e!==this._blurDownsample&&(this._blurDownsample=e,this._buildPipeline())}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e,this._updateEffectDefines()}get environmentTextureIsProbe(){return this._environmentTextureIsProbe}set environmentTextureIsProbe(e){this._environmentTextureIsProbe=e,this._updateEffectDefines()}get attenuateScreenBorders(){return this._attenuateScreenBorders}set attenuateScreenBorders(e){this._attenuateScreenBorders!==e&&(this._attenuateScreenBorders=e,this._updateEffectDefines())}get attenuateIntersectionDistance(){return this._attenuateIntersectionDistance}set attenuateIntersectionDistance(e){this._attenuateIntersectionDistance!==e&&(this._attenuateIntersectionDistance=e,this._updateEffectDefines())}get attenuateIntersectionIterations(){return this._attenuateIntersectionIterations}set attenuateIntersectionIterations(e){this._attenuateIntersectionIterations!==e&&(this._attenuateIntersectionIterations=e,this._updateEffectDefines())}get attenuateFacingCamera(){return this._attenuateFacingCamera}set attenuateFacingCamera(e){this._attenuateFacingCamera!==e&&(this._attenuateFacingCamera=e,this._updateEffectDefines())}get attenuateBackfaceReflection(){return this._attenuateBackfaceReflection}set attenuateBackfaceReflection(e){this._attenuateBackfaceReflection!==e&&(this._attenuateBackfaceReflection=e,this._updateEffectDefines())}get clipToFrustum(){return this._clipToFrustum}set clipToFrustum(e){this._clipToFrustum!==e&&(this._clipToFrustum=e,this._updateEffectDefines())}get useFresnel(){return this._useFresnel}set useFresnel(e){this._useFresnel!==e&&(this._useFresnel=e,this._buildPipeline())}get enableAutomaticThicknessComputation(){return this._enableAutomaticThicknessComputation}set enableAutomaticThicknessComputation(e){this._enableAutomaticThicknessComputation!==e&&(this._enableAutomaticThicknessComputation=e,this._buildPipeline())}get backfaceDepthRenderer(){return this._depthRenderer}get backfaceDepthTextureDownsample(){return this._backfaceDepthTextureDownsample}set backfaceDepthTextureDownsample(e){this._backfaceDepthTextureDownsample!==e&&(this._backfaceDepthTextureDownsample=e,this._resizeDepthRenderer())}get backfaceForceDepthWriteTransparentMeshes(){return this._backfaceForceDepthWriteTransparentMeshes}set backfaceForceDepthWriteTransparentMeshes(e){this._backfaceForceDepthWriteTransparentMeshes!==e&&(this._backfaceForceDepthWriteTransparentMeshes=e,this._depthRenderer&&(this._depthRenderer.forceDepthWriteTransparentMeshes=e))}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,e?e&&(this._isDirty?this._buildPipeline():null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)):null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()))}get inputTextureColorIsInGammaSpace(){return this._inputTextureColorIsInGammaSpace}set inputTextureColorIsInGammaSpace(e){this._inputTextureColorIsInGammaSpace!==e&&(this._inputTextureColorIsInGammaSpace=e,this._buildPipeline())}get generateOutputInGammaSpace(){return this._generateOutputInGammaSpace}set generateOutputInGammaSpace(e){this._generateOutputInGammaSpace!==e&&(this._generateOutputInGammaSpace=e,this._buildPipeline())}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._buildPipeline())}getScene(){return this._scene}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}get scene(){return this._scene}get isSupported(){const e=this._scene.getEngine().getCaps();return e.drawBuffersExtension&&e.texelFetch}constructor(e,t,i,s=!1,r=0){if(super(t.getEngine(),e),this.SSRRenderEffect="SSRRenderEffect",this.SSRBlurRenderEffect="SSRBlurRenderEffect",this.SSRCombineRenderEffect="SSRCombineRenderEffect",this._samples=1,this.maxDistance=1e3,this.step=1,this.thickness=.5,this.strength=1,this.reflectionSpecularFalloffExponent=1,this.maxSteps=1e3,this.roughnessFactor=.2,this.selfCollisionNumSkip=1,this._reflectivityThreshold=.04,this._ssrDownsample=0,this._blurDispersionStrength=.03,this._blurDownsample=0,this._enableSmoothReflections=!1,this._environmentTextureIsProbe=!1,this._attenuateScreenBorders=!0,this._attenuateIntersectionDistance=!0,this._attenuateIntersectionIterations=!0,this._attenuateFacingCamera=!1,this._attenuateBackfaceReflection=!1,this._clipToFrustum=!0,this._useFresnel=!1,this._enableAutomaticThicknessComputation=!1,this._backfaceDepthTextureDownsample=0,this._backfaceForceDepthWriteTransparentMeshes=!0,this._isEnabled=!0,this._inputTextureColorIsInGammaSpace=!0,this._generateOutputInGammaSpace=!0,this._debug=!1,this._forceGeometryBuffer=!1,this._isDirty=!1,this._camerasToBeAttached=[],this._cameras=i||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._textureType=r,this._forceGeometryBuffer=s,this.isSupported){if(t.postProcessRenderPipelineManager.addPipeline(this),this._forceGeometryBuffer){const e=t.enableGeometryBufferRenderer();e&&(e.enableReflectivity=!0,e.useSpecificClearForDepthTexture=!0,e.generateNormalsInWorldSpace&&console.error("SSRRenderingPipeline does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!"))}else{const e=t.enablePrePassRenderer();e&&(e.useSpecificClearForDepthTexture=!0,e.markAsDirty(),e.generateNormalsInWorldSpace&&console.error("SSRRenderingPipeline does not support generateNormalsInWorldSpace=true for the prepass renderer!"))}this._buildPipeline()}}getClassName(){return"SSRRenderingPipeline"}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(e=!1){this._disposeDepthRenderer(),this._disposePostProcesses(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),super.dispose()}_getTextureSize(){var e,t;const i=this._scene.getEngine(),s=this._prePassRenderer;let r={width:i.getRenderWidth(),height:i.getRenderHeight()};if(s&&(null===(e=this._scene.activeCamera)||void 0===e?void 0:e._getFirstPostProcess())===this._ssrPostProcess){const e=s.getRenderTarget();e&&e.textures&&(r=e.textures[s.getIndex(4)].getSize())}else(null===(t=this._ssrPostProcess)||void 0===t?void 0:t.inputTexture)&&(r.width=this._ssrPostProcess.inputTexture.width,r.height=this._ssrPostProcess.inputTexture.height);return r}_updateEffectDefines(){var e;const t=[];(this._geometryBufferRenderer||this._prePassRenderer)&&t.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&t.push("#define SSRAYTRACE_ENABLE_REFINEMENT"),this._scene.useRightHandedSystem&&t.push("#define SSRAYTRACE_RIGHT_HANDED_SCENE"),this._environmentTexture&&(t.push("#define SSR_USE_ENVIRONMENT_CUBE"),this._environmentTexture.boundingBoxSize&&t.push("#define SSR_USE_LOCAL_REFLECTIONMAP_CUBIC"),this._environmentTexture.gammaSpace&&t.push("#define SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE")),this._environmentTextureIsProbe&&t.push("#define SSR_INVERTCUBICMAP"),this._enableAutomaticThicknessComputation&&t.push("#define SSRAYTRACE_USE_BACK_DEPTHBUFFER"),this._attenuateScreenBorders&&t.push("#define SSR_ATTENUATE_SCREEN_BORDERS"),this._attenuateIntersectionDistance&&t.push("#define SSR_ATTENUATE_INTERSECTION_DISTANCE"),this._attenuateIntersectionIterations&&t.push("#define SSR_ATTENUATE_INTERSECTION_NUMITERATIONS"),this._attenuateFacingCamera&&t.push("#define SSR_ATTENUATE_FACING_CAMERA"),this._attenuateBackfaceReflection&&t.push("#define SSR_ATTENUATE_BACKFACE_REFLECTION"),this._clipToFrustum&&t.push("#define SSRAYTRACE_CLIP_TO_FRUSTUM"),this._useBlur()&&t.push("#define SSR_USE_BLUR"),this._debug&&t.push("#define SSRAYTRACE_DEBUG"),this._inputTextureColorIsInGammaSpace&&t.push("#define SSR_INPUT_IS_GAMMA_SPACE"),this._generateOutputInGammaSpace&&t.push("#define SSR_OUTPUT_IS_GAMMA_SPACE"),this._useFresnel&&t.push("#define SSR_BLEND_WITH_FRESNEL"),0===this._reflectivityThreshold&&t.push("#define SSR_DISABLE_REFLECTIVITY_TEST"),null===(e=this._ssrPostProcess)||void 0===e||e.updateEffect(t.join("\n"))}_buildPipeline(){var e;if(!this.isSupported)return;if(!this._isEnabled)return void(this._isDirty=!0);this._isDirty=!1;const t=this._scene.getEngine();if(this._disposeDepthRenderer(),this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._enableAutomaticThicknessComputation){const t=null===(e=this._cameras)||void 0===e?void 0:e[0];t&&(this._depthRendererCamera=t,this._depthRenderer=new Np(this._scene,void 0,void 0,void 0,1,!0,"SSRBackDepth"),this._depthRenderer.clearColor.r=1e8,this._depthRenderer.reverseCulling=!0,this._depthRenderer.forceDepthWriteTransparentMeshes=this._backfaceForceDepthWriteTransparentMeshes,this._resizeDepthRenderer(),t.customRenderTargets.push(this._depthRenderer.getDepthMap()))}this._createSSRPostProcess(),this.addEffect(new Wg(t,this.SSRRenderEffect,(()=>this._ssrPostProcess),!0)),this._useBlur()&&(this._createBlurAndCombinerPostProcesses(),this.addEffect(new Wg(t,this.SSRBlurRenderEffect,(()=>[this._blurPostProcessX,this._blurPostProcessY]),!0)),this.addEffect(new Wg(t,this.SSRCombineRenderEffect,(()=>this._blurCombinerPostProcess),!0))),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)}_resizeDepthRenderer(){if(!this._depthRenderer)return;const e=this._getTextureSize(),t=this._depthRenderer.getDepthMap().getSize(),i=Math.floor(e.width/(this._backfaceDepthTextureDownsample+1)),s=Math.floor(e.height/(this._backfaceDepthTextureDownsample+1));t.width===i&&t.height===s||this._depthRenderer.getDepthMap().resize({width:i,height:s})}_disposeDepthRenderer(){var e;if(this._depthRenderer){if(this._depthRendererCamera){const t=null!==(e=this._depthRendererCamera.customRenderTargets.indexOf(this._depthRenderer.getDepthMap()))&&void 0!==e?e:-1;-1!==t&&this._depthRendererCamera.customRenderTargets.splice(t,1)}this._depthRendererCamera=null,this._depthRenderer.getDepthMap().dispose()}this._depthRenderer=null}_disposePostProcesses(){var e,t,i,s;for(let r=0;r<this._cameras.length;r++){const n=this._cameras[r];null===(e=this._ssrPostProcess)||void 0===e||e.dispose(n),null===(t=this._blurPostProcessX)||void 0===t||t.dispose(n),null===(i=this._blurPostProcessY)||void 0===i||i.dispose(n),null===(s=this._blurCombinerPostProcess)||void 0===s||s.dispose(n)}this._ssrPostProcess=null,this._blurPostProcessX=null,this._blurPostProcessY=null,this._blurCombinerPostProcess=null}_createSSRPostProcess(){this._ssrPostProcess=new dn("ssr","screenSpaceReflection2",["projection","invProjectionMatrix","view","invView","thickness","reflectionSpecularFalloffExponent","strength","stepSize","maxSteps","roughnessFactor","projectionPixel","nearPlaneZ","maxDistance","selfCollisionNumSkip","vReflectionPosition","vReflectionSize","backSizeFactor","reflectivityThreshold"],["textureSampler","normalSampler","reflectivitySampler","depthSampler","envCubeSampler","backDepthSampler"],1,null,this._textureType,this._scene.getEngine(),!1,"",this._textureType),this._updateEffectDefines(),this._ssrPostProcess.onApply=e=>{this._resizeDepthRenderer();const t=this._geometryBufferRenderer,i=this._prePassRenderer;if(!i&&!t)return;if(t){const i=t.getTextureIndex(av.REFLECTIVITY_TEXTURE_TYPE);e.setTexture("normalSampler",t.getGBuffer().textures[1]),e.setTexture("reflectivitySampler",t.getGBuffer().textures[i]),e.setTexture("depthSampler",t.getGBuffer().textures[0])}else if(i){const t=i.getIndex(5),s=i.getIndex(3),r=i.getIndex(6);e.setTexture("normalSampler",i.getRenderTarget().textures[r]),e.setTexture("depthSampler",i.getRenderTarget().textures[t]),e.setTexture("reflectivitySampler",i.getRenderTarget().textures[s])}this._enableAutomaticThicknessComputation&&this._depthRenderer&&(e.setTexture("backDepthSampler",this._depthRenderer.getDepthMap()),e.setFloat("backSizeFactor",this._backfaceDepthTextureDownsample+1));const s=this._scene.activeCamera;if(!s)return;const r=s.getViewMatrix(!0),n=s.getProjectionMatrix(!0);n.invertToRef(R.Matrix[0]),r.invertToRef(R.Matrix[1]),e.setMatrix("projection",n),e.setMatrix("view",r),e.setMatrix("invView",R.Matrix[1]),e.setMatrix("invProjectionMatrix",R.Matrix[0]),e.setFloat("thickness",this.thickness),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("strength",this.strength),e.setFloat("stepSize",this.step),e.setFloat("maxSteps",this.maxSteps),e.setFloat("roughnessFactor",this.roughnessFactor),e.setFloat("nearPlaneZ",s.minZ),e.setFloat("maxDistance",this.maxDistance),e.setFloat("selfCollisionNumSkip",this.selfCollisionNumSkip),e.setFloat("reflectivityThreshold",this._reflectivityThreshold);const o=this._getTextureSize();y.ScalingToRef(o.width,o.height,1,R.Matrix[2]),n.multiplyToRef(this._scene.getEngine().isWebGPU?yv:Cv,R.Matrix[3]),R.Matrix[3].multiplyToRef(R.Matrix[2],R.Matrix[4]),e.setMatrix("projectionPixel",R.Matrix[4]),this._environmentTexture&&(e.setTexture("envCubeSampler",this._environmentTexture),this._environmentTexture.boundingBoxSize&&(e.setVector3("vReflectionPosition",this._environmentTexture.boundingBoxPosition),e.setVector3("vReflectionSize",this._environmentTexture.boundingBoxSize)))},this._ssrPostProcess.samples=this.samples,this._forceGeometryBuffer||(this._ssrPostProcess._prePassEffectConfiguration=new bv)}_createBlurAndCombinerPostProcesses(){const e=this._scene.getEngine();this._blurPostProcessX=new dn("SSRblurX","screenSpaceReflection2Blur",["texelOffsetScale"],["textureSampler"],this._useBlur()?1/(this._ssrDownsample+1):1,null,2,e,!1,"",this._textureType),this._blurPostProcessX.autoClear=!1,this._blurPostProcessX.onApplyObservable.add((e=>{var t,i;const s=null!==(i=null===(t=this._blurPostProcessX)||void 0===t?void 0:t.inputTexture.width)&&void 0!==i?i:this._scene.getEngine().getRenderWidth();e.setFloat2("texelOffsetScale",this._blurDispersionStrength/s,0)})),this._blurPostProcessY=new dn("SSRblurY","screenSpaceReflection2Blur",["texelOffsetScale"],["textureSampler"],this._useBlur()?1/(this._blurDownsample+1):1,null,2,e,!1,"",this._textureType),this._blurPostProcessY.autoClear=!1,this._blurPostProcessY.onApplyObservable.add((e=>{var t,i;const s=null!==(i=null===(t=this._blurPostProcessY)||void 0===t?void 0:t.inputTexture.height)&&void 0!==i?i:this._scene.getEngine().getRenderHeight();e.setFloat2("texelOffsetScale",0,this._blurDispersionStrength/s)}));const t=["strength","reflectionSpecularFalloffExponent","reflectivityThreshold"],i=["textureSampler","mainSampler","reflectivitySampler"];let s="";this._debug&&(s+="#define SSRAYTRACE_DEBUG\n"),this._inputTextureColorIsInGammaSpace&&(s+="#define SSR_INPUT_IS_GAMMA_SPACE\n"),this._generateOutputInGammaSpace&&(s+="#define SSR_OUTPUT_IS_GAMMA_SPACE\n"),this.useFresnel&&(s+="#define SSR_BLEND_WITH_FRESNEL\n",t.push("projection","invProjectionMatrix"),i.push("depthSampler","normalSampler")),0===this._reflectivityThreshold&&(s+="#define SSR_DISABLE_REFLECTIVITY_TEST"),this._blurCombinerPostProcess=new dn("SSRblurCombiner","screenSpaceReflection2BlurCombiner",t,i,this._useBlur()?1/(this._blurDownsample+1):1,null,1,e,!1,s,this._textureType),this._blurCombinerPostProcess.autoClear=!1,this._blurCombinerPostProcess.onApplyObservable.add((e=>{var t;const i=this._geometryBufferRenderer,s=this._prePassRenderer;if(s||i){if(s&&(null===(t=this._scene.activeCamera)||void 0===t?void 0:t._getFirstPostProcess())===this._ssrPostProcess){const t=s.getRenderTarget();t&&t.textures&&e.setTexture("mainSampler",t.textures[s.getIndex(4)])}else e.setTextureFromPostProcess("mainSampler",this._ssrPostProcess);if(i){const t=i.getTextureIndex(av.REFLECTIVITY_TEXTURE_TYPE);e.setTexture("reflectivitySampler",i.getGBuffer().textures[t]),this.useFresnel&&(e.setTexture("normalSampler",i.getGBuffer().textures[1]),e.setTexture("depthSampler",i.getGBuffer().textures[0]))}else if(s){const t=s.getIndex(3);if(e.setTexture("reflectivitySampler",s.getRenderTarget().textures[t]),this.useFresnel){const t=s.getIndex(5),i=s.getIndex(6);e.setTexture("normalSampler",s.getRenderTarget().textures[i]),e.setTexture("depthSampler",s.getRenderTarget().textures[t])}}if(e.setFloat("strength",this.strength),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("reflectivityThreshold",this._reflectivityThreshold),this.useFresnel){const t=this._scene.activeCamera;if(t){const i=t.getProjectionMatrix();i.invertToRef(R.Matrix[0]),e.setMatrix("projection",i),e.setMatrix("invProjectionMatrix",R.Matrix[0])}}}}))}serialize(){const e=de.Serialize(this);return e.customType="SSRRenderingPipeline",e}static Parse(e,t,i){return de.Parse((()=>new Av(e._name,t,e._ratio)),e,t,i)}}me([ie()],Av.prototype,"samples",null),me([ie()],Av.prototype,"maxDistance",void 0),me([ie()],Av.prototype,"step",void 0),me([ie()],Av.prototype,"thickness",void 0),me([ie()],Av.prototype,"strength",void 0),me([ie()],Av.prototype,"reflectionSpecularFalloffExponent",void 0),me([ie()],Av.prototype,"maxSteps",void 0),me([ie()],Av.prototype,"roughnessFactor",void 0),me([ie()],Av.prototype,"selfCollisionNumSkip",void 0),me([ie()],Av.prototype,"_reflectivityThreshold",void 0),me([ie("_ssrDownsample")],Av.prototype,"_ssrDownsample",void 0),me([ie()],Av.prototype,"ssrDownsample",null),me([ie("blurDispersionStrength")],Av.prototype,"_blurDispersionStrength",void 0),me([ie("blurDownsample")],Av.prototype,"_blurDownsample",void 0),me([ie("enableSmoothReflections")],Av.prototype,"_enableSmoothReflections",void 0),me([ie("environmentTexture")],Av.prototype,"_environmentTexture",void 0),me([ie("environmentTextureIsProbe")],Av.prototype,"_environmentTextureIsProbe",void 0),me([ie("attenuateScreenBorders")],Av.prototype,"_attenuateScreenBorders",void 0),me([ie("attenuateIntersectionDistance")],Av.prototype,"_attenuateIntersectionDistance",void 0),me([ie("attenuateIntersectionIterations")],Av.prototype,"_attenuateIntersectionIterations",void 0),me([ie("attenuateFacingCamera")],Av.prototype,"_attenuateFacingCamera",void 0),me([ie("attenuateBackfaceReflection")],Av.prototype,"_attenuateBackfaceReflection",void 0),me([ie("clipToFrustum")],Av.prototype,"_clipToFrustum",void 0),me([ie("useFresnel")],Av.prototype,"_useFresnel",void 0),me([ie("enableAutomaticThicknessComputation")],Av.prototype,"_enableAutomaticThicknessComputation",void 0),me([ie("backfaceDepthTextureDownsample")],Av.prototype,"_backfaceDepthTextureDownsample",void 0),me([ie("backfaceForceDepthWriteTransparentMeshes")],Av.prototype,"_backfaceForceDepthWriteTransparentMeshes",void 0),me([ie("isEnabled")],Av.prototype,"_isEnabled",void 0),me([ie("inputTextureColorIsInGammaSpace")],Av.prototype,"_inputTextureColorIsInGammaSpace",void 0),me([ie("generateOutputInGammaSpace")],Av.prototype,"_generateOutputInGammaSpace",void 0),me([ie("debug")],Av.prototype,"_debug",void 0),m("BABYLON.SSRRenderingPipeline",Av);var Rv;nt.ShadersStore.tonemapPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform float _ExposureAdjustment;\n#if defined(HABLE_TONEMAPPING)\nconst float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;const float W=11.2;\n#endif\nfloat Luminance(vec3 c)\n{return dot(c,vec3(0.22,0.707,0.071));}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec3 colour=texture2D(textureSampler,vUV).rgb;\n#if defined(REINHARD_TONEMAPPING)\nfloat lum=Luminance(colour.rgb); \nfloat lumTm=lum*_ExposureAdjustment;float scale=lumTm/(1.0+lumTm); \ncolour*=scale/lum;\n#elif defined(HABLE_TONEMAPPING)\ncolour*=_ExposureAdjustment;const float ExposureBias=2.0;vec3 x=ExposureBias*colour;vec3 curr=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;x=vec3(W,W,W);vec3 whiteScale=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);colour=curr*whiteScale;\n#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)\ncolour*=_ExposureAdjustment;vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);colour=retColor*retColor;\n#elif defined(PHOTOGRAPHIC_TONEMAPPING)\ncolour= vec3(1.0,1.0,1.0)-exp2(-_ExposureAdjustment*colour);\n#endif\ngl_FragColor=vec4(colour.rgb,1.0);}",function(e){e[e.Hable=0]="Hable",e[e.Reinhard=1]="Reinhard",e[e.HejiDawson=2]="HejiDawson",e[e.Photographic=3]="Photographic"}(Rv||(Rv={}));nt.ShadersStore.volumetricLightScatteringPixelShader="uniform sampler2D textureSampler;uniform sampler2D lightScatteringSampler;uniform float decay;uniform float exposure;uniform float weight;uniform float density;uniform vec2 meshPositionOnScreen;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec2 tc=vUV;vec2 deltaTexCoord=(tc-meshPositionOnScreen.xy);deltaTexCoord*=1.0/float(NUM_SAMPLES)*density;float illuminationDecay=1.0;vec4 color=texture2D(lightScatteringSampler,tc)*0.4;for(int i=0; i<NUM_SAMPLES; i++) {tc-=deltaTexCoord;vec4 dataSample=texture2D(lightScatteringSampler,tc)*0.4;dataSample*=illuminationDecay*weight;color+=dataSample;illuminationDecay*=decay;}\nvec4 realColor=texture2D(textureSampler,vUV);gl_FragColor=((vec4((vec3(color.r,color.g,color.b)*exposure),1))+(realColor*(1.5-0.4)));\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";nt.ShadersStore.volumetricLightScatteringPassVertexShader="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\nuniform mat4 viewProjection;uniform vec2 depthValues;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#if (defined(ALPHATEST) || defined(NEED_UV)) && defined(UV1)\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}\n";nt.ShadersStore.volumetricLightScatteringPassPixelShader="#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\n#endif\n#if defined(ALPHATEST)\nuniform sampler2D diffuseSampler;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#if defined(ALPHATEST)\nvec4 diffuseColor=texture2D(diffuseSampler,vUV);if (diffuseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=vec4(0.0,0.0,0.0,1.0);}\n";class Iv extends dn{get useDiffuseColor(){return k.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead"),!1}set useDiffuseColor(e){k.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")}constructor(e,t,i,s,r=100,n=Ar.BILINEAR_SAMPLINGMODE,o,a,l){var h,c;super(e,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],t.postProcessRatio||t,i,n,o,a,"#define NUM_SAMPLES "+r),this._screenCoordinates=E.Zero(),this.customMeshPosition=S.Zero(),this.useCustomMeshPosition=!1,this.invert=!0,this.excludedMeshes=[],this.includedMeshes=[],this.exposure=.3,this.decay=.96815,this.weight=.58767,this.density=.926,o=(l=null!==(c=null!==(h=null==i?void 0:i.getScene())&&void 0!==h?h:l)&&void 0!==c?c:this._scene).getEngine(),this._viewPort=new ds(0,0,1,1).toGlobal(o.getRenderWidth(),o.getRenderHeight()),this.mesh=null!=s?s:Iv.CreateDefaultMesh("VolumetricLightScatteringMesh",l),this._createPass(l,t.passRatio||t),this.onActivate=e=>{this.isSupported||this.dispose(e),this.onActivate=null},this.onApplyObservable.add((e=>{this._updateMeshScreenCoordinates(l),e.setTexture("lightScatteringSampler",this._volumetricLightScatteringRTT),e.setFloat("exposure",this.exposure),e.setFloat("decay",this.decay),e.setFloat("weight",this.weight),e.setFloat("density",this.density),e.setVector2("meshPositionOnScreen",this._screenCoordinates)}))}getClassName(){return"VolumetricLightScatteringPostProcess"}_isReady(e,t){var i;const s=e.getMesh();if(s===this.mesh&&s.material)return s.material.isReady(s);const r=null===(i=s._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===i?void 0:i[this._scene.getEngine().currentRenderPassId];if(r)return r.isReadyForSubMesh(s,e,t);const n=[],o=[hi.PositionKind],a=e.getMaterial();a&&(a.needAlphaTesting()&&n.push("#define ALPHATEST"),s.isVerticesDataPresent(hi.UVKind)&&(o.push(hi.UVKind),n.push("#define UV1")),s.isVerticesDataPresent(hi.UV2Kind)&&(o.push(hi.UV2Kind),n.push("#define UV2"))),s.useBones&&s.computeBonesUsingShaders?(o.push(hi.MatricesIndicesKind),o.push(hi.MatricesWeightsKind),n.push("#define NUM_BONE_INFLUENCERS "+s.numBoneInfluencers),n.push("#define BonesPerMesh "+(s.skeleton?s.skeleton.bones.length+1:0))):n.push("#define NUM_BONE_INFLUENCERS 0"),t&&(n.push("#define INSTANCES"),Hs.PushAttributesForInstances(o),e.getRenderingMesh().hasThinInstances&&n.push("#define THIN_INSTANCES"));const l=e._getDrawWrapper(void 0,!0),h=l.defines,c=n.join("\n");return h!==c&&l.setEffect(s.getScene().getEngine().createEffect("volumetricLightScatteringPass",o,["world","mBones","viewProjection","diffuseMatrix"],["diffuseSampler"],c,void 0,void 0,void 0,{maxSimultaneousMorphTargets:s.numBoneInfluencers}),c),l.effect.isReady()}setCustomMeshPosition(e){this.customMeshPosition=e}getCustomMeshPosition(){return this.customMeshPosition}dispose(e){const t=e.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);-1!==t&&e.getScene().customRenderTargets.splice(t,1),this._volumetricLightScatteringRTT.dispose(),super.dispose(e)}getPass(){return this._volumetricLightScatteringRTT}_meshExcluded(e){return this.includedMeshes.length>0&&-1===this.includedMeshes.indexOf(e)||this.excludedMeshes.length>0&&-1!==this.excludedMeshes.indexOf(e)}_createPass(e,t){const i=e.getEngine();this._volumetricLightScatteringRTT=new Bn("volumetricLightScatteringMap",{width:i.getRenderWidth()*t,height:i.getRenderHeight()*t},e,!1,!0,0),this._volumetricLightScatteringRTT.wrapU=Ar.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.wrapV=Ar.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.renderList=null,this._volumetricLightScatteringRTT.renderParticles=!1,this._volumetricLightScatteringRTT.ignoreCameraViewport=!0;const s=this.getCamera();s?s.customRenderTargets.push(this._volumetricLightScatteringRTT):e.customRenderTargets.push(this._volumetricLightScatteringRTT);const r=e=>{var t;const i=e.getRenderingMesh(),s=e.getEffectiveMesh();if(this._meshExcluded(i))return;s._internalAbstractMeshDataInfo._isActiveIntermediate=!1;const r=e.getMaterial();if(!r)return;const n=i.getScene(),o=n.getEngine();o.setState(r.backFaceCulling,void 0,void 0,void 0,r.cullBackFaces);const a=i._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(a.mustReturn)return;const l=o.getCaps().instancedArrays&&(null!==a.visibleInstances[e._id]||i.hasThinInstances);if(this._isReady(e,l)){const h=null===(t=s._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===t?void 0:t[o.currentRenderPassId];let c=e._getDrawWrapper();if(i!==this.mesh||c||(c=r._getDrawWrapper()),!c)return;const u=c.effect;if(o.enableEffect(c),l||i._bind(e,u,r.fillMode),i===this.mesh)r.bind(s.getWorldMatrix(),i);else if(h)h.bindForSubMesh(s.getWorldMatrix(),s,e);else{if(u.setMatrix("viewProjection",n.getTransformMatrix()),r&&r.needAlphaTesting()){const e=r.getAlphaTestTexture();u.setTexture("diffuseSampler",e),e&&u.setMatrix("diffuseMatrix",e.getTextureMatrix())}i.useBones&&i.computeBonesUsingShaders&&i.skeleton&&u.setMatrices("mBones",i.skeleton.getTransformMatrices(i))}l&&i.hasThinInstances&&u.setMatrix("world",s.getWorldMatrix()),i._processRendering(s,e,u,sr.TriangleFillMode,a,l,((e,t)=>{e||u.setMatrix("world",t)}))}};let n;const o=new F(0,0,0,1);this._volumetricLightScatteringRTT.onBeforeRenderObservable.add((()=>{n=e.clearColor,e.clearColor=o})),this._volumetricLightScatteringRTT.onAfterRenderObservable.add((()=>{e.clearColor=n})),this._volumetricLightScatteringRTT.customIsReadyFunction=(e,t,s)=>{if((s||0===t)&&e.subMeshes)for(let t=0;t<e.subMeshes.length;++t){const s=e.subMeshes[t],r=s.getMaterial(),n=s.getRenderingMesh();if(!r)continue;const o=n._getInstancesRenderList(s._id,!!s.getReplacementMesh()),a=i.getCaps().instancedArrays&&(null!==o.visibleInstances[s._id]||n.hasThinInstances);if(!this._isReady(s,a))return!1}return!0},this._volumetricLightScatteringRTT.customRenderFunction=(t,i,s,n)=>{const o=e.getEngine();let a;if(n.length){for(o.setColorWrite(!1),a=0;a<n.length;a++)r(n.data[a]);o.setColorWrite(!0)}for(a=0;a<t.length;a++)r(t.data[a]);for(a=0;a<i.length;a++)r(i.data[a]);if(s.length){for(a=0;a<s.length;a++){const t=s.data[a],i=t.getBoundingInfo();i&&e.activeCamera&&(t._alphaIndex=t.getMesh().alphaIndex,t._distanceToCamera=i.boundingSphere.centerWorld.subtract(e.activeCamera.position).length())}const t=s.data.slice(0,s.length);for(t.sort(((e,t)=>e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0)),o.setAlphaMode(2),a=0;a<t.length;a++)r(t[a]);o.setAlphaMode(0)}}}_updateMeshScreenCoordinates(e){const t=e.getTransformMatrix();let i;i=this.useCustomMeshPosition?this.customMeshPosition:this.attachedNode?this.attachedNode.position:this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position;const s=S.Project(i,y.Identity(),t,this._viewPort);this._screenCoordinates.x=s.x/this._viewPort.width,this._screenCoordinates.y=s.y/this._viewPort.height,this.invert&&(this._screenCoordinates.y=1-this._screenCoordinates.y)}static CreateDefaultMesh(e,t){const i=Br(e,{size:1},t);i.billboardMode=Vs.BILLBOARDMODE_ALL;const s=new Va(e+"Material",t);return s.emissiveColor=new N(1,1,1),i.material=s,i}}me([ae()],Iv.prototype,"customMeshPosition",void 0),me([ie()],Iv.prototype,"useCustomMeshPosition",void 0),me([ie()],Iv.prototype,"invert",void 0),me([le()],Iv.prototype,"mesh",void 0),me([ie()],Iv.prototype,"excludedMeshes",void 0),me([ie()],Iv.prototype,"includedMeshes",void 0),me([ie()],Iv.prototype,"exposure",void 0),me([ie()],Iv.prototype,"decay",void 0),me([ie()],Iv.prototype,"weight",void 0),me([ie()],Iv.prototype,"density",void 0),m("BABYLON.VolumetricLightScatteringPostProcess",Iv);nt.ShadersStore.screenSpaceCurvaturePixelShader="precision highp float;varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D normalSampler;uniform float curvature_ridge;uniform float curvature_valley;\n#ifndef CURVATURE_OFFSET\n#define CURVATURE_OFFSET 1\n#endif\nfloat curvature_soft_clamp(float curvature,float control)\n{if (curvature<0.5/control)\nreturn curvature*(1.0-curvature*control);return 0.25/control;}\nfloat calculate_curvature(ivec2 texel,float ridge,float valley)\n{vec2 normal_up =texelFetch(normalSampler,texel+ivec2(0, CURVATURE_OFFSET),0).rb;vec2 normal_down =texelFetch(normalSampler,texel+ivec2(0,-CURVATURE_OFFSET),0).rb;vec2 normal_left =texelFetch(normalSampler,texel+ivec2(-CURVATURE_OFFSET,0),0).rb;vec2 normal_right=texelFetch(normalSampler,texel+ivec2( CURVATURE_OFFSET,0),0).rb;float normal_diff=((normal_up.g-normal_down.g)+(normal_right.r-normal_left.r));if (normal_diff<0.0)\nreturn -2.0*curvature_soft_clamp(-normal_diff,valley);return 2.0*curvature_soft_clamp(normal_diff,ridge);}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{ivec2 texel=ivec2(gl_FragCoord.xy);vec4 baseColor=texture2D(textureSampler,vUV);float curvature=calculate_curvature(texel,curvature_ridge,curvature_valley);baseColor.rgb*=curvature+1.0;gl_FragColor=baseColor;}";class Pv extends dn{getClassName(){return"ScreenSpaceCurvaturePostProcess"}constructor(e,t,i,s,r,n,o,a=0,l=!1){super(e,"screenSpaceCurvature",["curvature_ridge","curvature_valley"],["textureSampler","normalSampler"],i,s,r,n,o,void 0,a,void 0,null,l),this.ridge=1,this.valley=1,this._geometryBufferRenderer=t.enableGeometryBufferRenderer(),this._geometryBufferRenderer?(this._geometryBufferRenderer.generateNormalsInWorldSpace&&console.error("ScreenSpaceCurvaturePostProcess does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!"),this.onApply=e=>{e.setFloat("curvature_ridge",.5/Math.max(this.ridge*this.ridge,1e-4)),e.setFloat("curvature_valley",.7/Math.max(this.valley*this.valley,1e-4));const t=this._geometryBufferRenderer.getGBuffer().textures[1];e.setTexture("normalSampler",t)}):k.Error("Multiple Render Target support needed for screen space curvature post process. Please use IsSupported test first.")}static get IsSupported(){const e=x.LastCreatedEngine;return!!e&&e.getCaps().drawBuffersExtension}static _Parse(e,t,i,s){return de.Parse((()=>new Pv(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable)),e,i,s)}}me([ie()],Pv.prototype,"ridge",void 0),me([ie()],Pv.prototype,"valley",void 0),m("BABYLON.ScreenSpaceCurvaturePostProcess",Pv);nt.IncludesShadersStore.boundingBoxRendererFragmentDeclaration="uniform vec4 color;\n";nt.IncludesShadersStore.boundingBoxRendererUboDeclaration="#ifdef WEBGL2\nuniform vec4 color;uniform mat4 world;uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\n#else\nlayout(std140,column_major) uniform;uniform BoundingBoxRenderer {vec4 color;mat4 world;mat4 viewProjection;mat4 viewProjectionR;};\n#endif\n";nt.ShadersStore.boundingBoxRendererPixelShader="#include<__decl__boundingBoxRendererFragment>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";nt.IncludesShadersStore.boundingBoxRendererVertexDeclaration="uniform mat4 world;uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\n";nt.ShadersStore.boundingBoxRendererVertexShader="attribute vec3 position;\n#include<__decl__boundingBoxRendererVertex>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec4 worldPos=world*vec4(position,1.0);\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#define CUSTOM_VERTEX_MAIN_END\n}\n",Object.defineProperty(Yi.prototype,"forceShowBoundingBoxes",{get:function(){return this._forceShowBoundingBoxes||!1},set:function(e){this._forceShowBoundingBoxes=e,e&&this.getBoundingBoxRenderer()},enumerable:!0,configurable:!0}),Yi.prototype.getBoundingBoxRenderer=function(){return this._boundingBoxRenderer||(this._boundingBoxRenderer=new Mv(this)),this._boundingBoxRenderer},Object.defineProperty(Vs.prototype,"showBoundingBox",{get:function(){return this._showBoundingBox||!1},set:function(e){this._showBoundingBox=e,e&&this.getScene().getBoundingBoxRenderer()},enumerable:!0,configurable:!0});class Mv{constructor(e){this.name=fi.NAME_BOUNDINGBOXRENDERER,this.frontColor=new N(1,1,1),this.backColor=new N(.1,.1,.1),this.showBackLines=!0,this.onBeforeBoxRenderingObservable=new a,this.onAfterBoxRenderingObservable=new a,this.onResourcesReadyObservable=new a,this.enabled=!0,this.renderList=new Yt(32),this._vertexBuffers={},this._fillIndexBuffer=null,this._fillIndexData=null,this.scene=e,e._addComponent(this),this._uniformBufferFront=new ai(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererFront",!this.scene.getEngine().isWebGPU),this._buildUniformLayout(this._uniformBufferFront),this._uniformBufferBack=new ai(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererBack",!this.scene.getEngine().isWebGPU),this._buildUniformLayout(this._uniformBufferBack)}_buildUniformLayout(e){e.addUniform("color",4),e.addUniform("world",16),e.addUniform("viewProjection",16),e.addUniform("viewProjectionR",16),e.create()}register(){this.scene._beforeEvaluateActiveMeshStage.registerStep(fi.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER,this,this.reset),this.scene._preActiveMeshStage.registerStep(fi.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER,this,this._preActiveMesh),this.scene._evaluateSubMeshStage.registerStep(fi.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER,this,this._evaluateSubMesh),this.scene._afterRenderingGroupDrawStage.registerStep(fi.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER,this,this.render)}_evaluateSubMesh(e,t){if(e.showSubMeshesBoundingBox){const i=t.getBoundingInfo();null!=i&&(i.boundingBox._tag=e.renderingGroupId,this.renderList.push(i.boundingBox))}}_preActiveMesh(e){if(e.showBoundingBox||this.scene.forceShowBoundingBoxes){const t=e.getBoundingInfo();t.boundingBox._tag=e.renderingGroupId,this.renderList.push(t.boundingBox)}}_prepareResources(){if(this._colorShader)return;this._colorShader=new kl("colorShader",this.scene,"boundingBoxRenderer",{attributes:[hi.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"]},!1),this._colorShader.doNotSerialize=!0,this._colorShader.reservedDataStore={hidden:!0},this._colorShaderForOcclusionQuery=new kl("colorShaderOccQuery",this.scene,"boundingBoxRenderer",{attributes:[hi.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"]},!0),this._colorShaderForOcclusionQuery.doNotSerialize=!0,this._colorShaderForOcclusionQuery.reservedDataStore={hidden:!0};const e=this.scene.getEngine(),t=Il({size:1});this._vertexBuffers[hi.PositionKind]=new hi(e,t.positions,hi.PositionKind,!1),this._createIndexBuffer(),this._fillIndexData=t.indices,this.onResourcesReadyObservable.notifyObservers(this)}_createIndexBuffer(){const e=this.scene.getEngine();this._indexBuffer=e.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])}rebuild(){const e=this._vertexBuffers[hi.PositionKind];e&&e._rebuild(),this._createIndexBuffer()}reset(){this.renderList.reset()}render(e){var t,i;if(0===this.renderList.length||!this.enabled)return;if(this._prepareResources(),!this._colorShader.isReady())return;const s=this.scene.getEngine();s.setDepthWrite(!1);const r=this.scene.getTransformMatrix();for(let n=0;n<this.renderList.length;n++){const o=this.renderList.data[n];if(o._tag!==e)continue;this._createWrappersForBoundingBox(o),this.onBeforeBoxRenderingObservable.notifyObservers(o);const a=o.minimum,l=o.maximum.subtract(a),h=a.add(l.scale(.5)),c=y.Scaling(l.x,l.y,l.z).multiply(y.Translation(h.x,h.y,h.z)).multiply(o.getWorldMatrix()),u=s.useReverseDepthBuffer;if(this.showBackLines){const e=null!==(t=o._drawWrapperBack)&&void 0!==t?t:this._colorShader._getDrawWrapper();this._colorShader._preBind(e),s.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),u?s.setDepthFunctionToLessOrEqual():s.setDepthFunctionToGreaterOrEqual(),this._uniformBufferBack.bindToEffect(e.effect,"BoundingBoxRenderer"),this._uniformBufferBack.updateColor4("color",this.backColor,1),this._uniformBufferBack.updateMatrix("world",c),this._uniformBufferBack.updateMatrix("viewProjection",r),this._uniformBufferBack.update(),s.drawElementsType(sr.LineListDrawMode,0,24)}const d=null!==(i=o._drawWrapperFront)&&void 0!==i?i:this._colorShader._getDrawWrapper();this._colorShader._preBind(d),s.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),u?s.setDepthFunctionToGreater():s.setDepthFunctionToLess(),this._uniformBufferFront.bindToEffect(d.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateColor4("color",this.frontColor,1),this._uniformBufferFront.updateMatrix("world",c),this._uniformBufferFront.updateMatrix("viewProjection",r),this._uniformBufferFront.update(),s.drawElementsType(sr.LineListDrawMode,0,24),this.onAfterBoxRenderingObservable.notifyObservers(o)}this._colorShader.unbind(),s.setDepthFunctionToLessOrEqual(),s.setDepthWrite(!0)}_createWrappersForBoundingBox(e){if(!e._drawWrapperFront){const t=this.scene.getEngine();e._drawWrapperFront=new Tt(t),e._drawWrapperBack=new Tt(t),e._drawWrapperFront.setEffect(this._colorShader.getEffect()),e._drawWrapperBack.setEffect(this._colorShader.getEffect())}}renderOcclusionBoundingBox(e){const t=this.scene.getEngine();void 0===this._renderPassIdForOcclusionQuery&&(this._renderPassIdForOcclusionQuery=t.createRenderPassId("Render pass for occlusion query"));const i=t.currentRenderPassId;t.currentRenderPassId=this._renderPassIdForOcclusionQuery,this._prepareResources();const s=e.subMeshes[0];if(!this._colorShaderForOcclusionQuery.isReady(e,void 0,s)||!e.hasBoundingInfo)return void(t.currentRenderPassId=i);this._fillIndexBuffer||(this._fillIndexBuffer=t.createIndexBuffer(this._fillIndexData));const r=t.useReverseDepthBuffer;t.setDepthWrite(!1),t.setColorWrite(!1);const n=e.getBoundingInfo().boundingBox,o=n.minimum,a=n.maximum.subtract(o),l=o.add(a.scale(.5)),h=y.Scaling(a.x,a.y,a.z).multiply(y.Translation(l.x,l.y,l.z)).multiply(n.getWorldMatrix()),c=s._drawWrapper;this._colorShaderForOcclusionQuery._preBind(c),t.bindBuffers(this._vertexBuffers,this._fillIndexBuffer,c.effect),r?t.setDepthFunctionToGreater():t.setDepthFunctionToLess(),this.scene.resetCachedMaterial(),this._uniformBufferFront.bindToEffect(c.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateMatrix("world",h),this._uniformBufferFront.updateMatrix("viewProjection",this.scene.getTransformMatrix()),this._uniformBufferFront.update(),t.drawElementsType(sr.TriangleFillMode,0,36),this._colorShaderForOcclusionQuery.unbind(),t.setDepthFunctionToLessOrEqual(),t.setDepthWrite(!0),t.setColorWrite(!0),t.currentRenderPassId=i}dispose(){if(void 0!==this._renderPassIdForOcclusionQuery&&(this.scene.getEngine().releaseRenderPassId(this._renderPassIdForOcclusionQuery),this._renderPassIdForOcclusionQuery=void 0),!this._colorShader)return;this.onBeforeBoxRenderingObservable.clear(),this.onAfterBoxRenderingObservable.clear(),this.onResourcesReadyObservable.clear(),this.renderList.dispose(),this._colorShader.dispose(),this._colorShaderForOcclusionQuery.dispose(),this._uniformBufferFront.dispose(),this._uniformBufferBack.dispose();const e=this._vertexBuffers[hi.PositionKind];e&&(e.dispose(),this._vertexBuffers[hi.PositionKind]=null),this.scene.getEngine()._releaseBuffer(this._indexBuffer),this._fillIndexBuffer&&(this.scene.getEngine()._releaseBuffer(this._fillIndexBuffer),this._fillIndexBuffer=null)}}Yi.prototype.enableDepthRenderer=function(e,t=!1,i=!1,s=3,r=!1){if(!(e=e||this.activeCamera))throw"No camera available to enable depth renderer";if(this._depthRenderer||(this._depthRenderer={}),!this._depthRenderer[e.id]){const n=!!this.getEngine().getCaps().textureFloatRender;let o=0;o=!this.getEngine().getCaps().textureHalfFloatRender||i&&n?n?1:0:2,this._depthRenderer[e.id]=new Np(this,o,e,t,s,r)}return this._depthRenderer[e.id]},Yi.prototype.disableDepthRenderer=function(e){(e=e||this.activeCamera)&&this._depthRenderer&&this._depthRenderer[e.id]&&this._depthRenderer[e.id].dispose()};class Ov{constructor(e){this.name=fi.NAME_DEPTHRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(fi.STEP_GATHERRENDERTARGETS_DEPTHRENDERER,this,this._gatherRenderTargets),this.scene._gatherActiveCameraRenderTargetsStage.registerStep(fi.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER,this,this._gatherActiveCameraRenderTargets)}rebuild(){}dispose(){for(const e in this.scene._depthRenderer)this.scene._depthRenderer[e].dispose()}_gatherRenderTargets(e){if(this.scene._depthRenderer)for(const t in this.scene._depthRenderer){const i=this.scene._depthRenderer[t];i.enabled&&!i.useOnlyInActiveCamera&&e.push(i.getDepthMap())}}_gatherActiveCameraRenderTargets(e){if(this.scene._depthRenderer)for(const t in this.scene._depthRenderer){const i=this.scene._depthRenderer[t];i.enabled&&i.useOnlyInActiveCamera&&this.scene.activeCamera.id===t&&e.push(i.getDepthMap())}}}Np._SceneComponentInitialization=e=>{let t=e._getComponent(fi.NAME_DEPTHRENDERER);t||(t=new Ov(e),e._addComponent(t))};nt.ShadersStore.oitFinalPixelShader="precision highp float;uniform sampler2D uFrontColor;uniform sampler2D uBackColor;void main() {ivec2 fragCoord=ivec2(gl_FragCoord.xy);vec4 frontColor=texelFetch(uFrontColor,fragCoord,0);vec4 backColor=texelFetch(uBackColor,fragCoord,0);float alphaMultiplier=1.0-frontColor.a;glFragColor=vec4(\nfrontColor.rgb+alphaMultiplier*backColor.rgb,\nfrontColor.a+backColor.a\n);}";nt.ShadersStore.oitBackBlendPixelShader="precision highp float;uniform sampler2D uBackColor;void main() {glFragColor=texelFetch(uBackColor,ivec2(gl_FragCoord.xy),0);if (glFragColor.a==0.0) { \ndiscard;}}";class Dv{constructor(){this.enabled=!0,this.name="depthPeeling",this.texturesRequired=[4]}}class Nv{get passCount(){return this._passCount}set passCount(e){this._passCount!==e&&(this._passCount=e,this._createRenderPassIds())}get useRenderPasses(){return this._useRenderPasses}set useRenderPasses(e){this._useRenderPasses!==e&&(this._useRenderPasses=e,this._createRenderPassIds())}addExcludedMesh(e){-1===this._excludedMeshes.indexOf(e.uniqueId)&&this._excludedMeshes.push(e.uniqueId)}removeExcludedMesh(e){const t=this._excludedMeshes.indexOf(e.uniqueId);-1!==t&&this._excludedMeshes.splice(t,1)}constructor(e,t=5){if(this._thinTextures=[],this._currentPingPongState=0,this._layoutCacheFormat=[[!0],[!0,!0],[!0,!0,!0]],this._layoutCache=[],this._candidateSubMeshes=new Yt(10),this._excludedSubMeshes=new Yt(10),this._excludedMeshes=[],this._colorCache=[new F(Nv._DEPTH_CLEAR_VALUE,Nv._DEPTH_CLEAR_VALUE,0,0),new F(-Nv._MIN_DEPTH,Nv._MAX_DEPTH,0,0),new F(0,0,0,0)],this._scene=e,this._engine=e.getEngine(),this._passCount=t,e.enablePrePassRenderer()){for(let e=0;e<this._layoutCacheFormat.length;++e)this._layoutCache[e]=this._engine.buildTextureLayout(this._layoutCacheFormat[e]);this._renderPassIds=[],this.useRenderPasses=!1,this._prePassEffectConfiguration=new Dv,this._createTextures(),this._createEffects()}else k.Warn("Depth peeling for order independant transparency could not enable PrePass, aborting.")}_createRenderPassIds(){if(this._releaseRenderPassIds(),this._useRenderPasses)for(let e=0;e<this._passCount+1;++e)this._renderPassIds[e]||(this._renderPassIds[e]=this._engine.createRenderPassId(`DepthPeelingRenderer - pass #${e}`))}_releaseRenderPassIds(){for(let e=0;e<this._renderPassIds.length;++e)this._engine.releaseRenderPassId(this._renderPassIds[e]);this._renderPassIds=[]}_createTextures(){const e={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()};this._depthMrts=[new F_("depthPeelingDepth0MRT",e,3,this._scene,void 0,["depthPeelingDepth0MRT_depth","depthPeelingDepth0MRT_frontColor","depthPeelingDepth0MRT_backColor"]),new F_("depthPeelingDepth1MRT",e,3,this._scene,void 0,["depthPeelingDepth1MRT_depth","depthPeelingDepth1MRT_frontColor","depthPeelingDepth1MRT_backColor"])],this._colorMrts=[new F_("depthPeelingColor0MRT",e,2,this._scene,{generateDepthBuffer:!1},["depthPeelingColor0MRT_frontColor","depthPeelingColor0MRT_backColor"]),new F_("depthPeelingColor1MRT",e,2,this._scene,{generateDepthBuffer:!1},["depthPeelingColor1MRT_frontColor","depthPeelingColor1MRT_backColor"])],this._blendBackMrt=new F_("depthPeelingBackMRT",e,1,this._scene,{generateDepthBuffer:!1},["depthPeelingBackMRT_blendBack"]),this._outputRT=new Bn("depthPeelingOutputRTT",e,this._scene,!1);const t=[{format:7,samplingMode:1,type:this._engine.getCaps().textureFloatLinearFiltering?1:2,label:"DepthPeelingRenderer-DepthTexture"},{format:5,samplingMode:1,type:2,label:"DepthPeelingRenderer-ColorTexture"}];for(let i=0;i<2;i++){const s=this._engine._createInternalTexture(e,t[0],!1),r=this._engine._createInternalTexture(e,t[1],!1),n=this._engine._createInternalTexture(e,t[1],!1);this._depthMrts[i].setInternalTexture(s,0),this._depthMrts[i].setInternalTexture(r,1),this._depthMrts[i].setInternalTexture(n,2),this._colorMrts[i].setInternalTexture(r,0),this._colorMrts[i].setInternalTexture(n,1),this._thinTextures.push(new br(s),new br(r),new br(n))}}_disposeTextures(){for(let e=0;e<this._thinTextures.length;e++)6!==e&&this._thinTextures[e].dispose();for(let e=0;e<2;e++)this._depthMrts[e].dispose(!0),this._colorMrts[e].dispose(!0),this._blendBackMrt.dispose(!0);this._outputRT.dispose(),this._thinTextures=[],this._colorMrts=[],this._depthMrts=[]}_updateTextures(){return this._depthMrts[0].getSize().width===this._engine.getRenderWidth()&&this._depthMrts[0].getSize().height===this._engine.getRenderHeight()||(this._disposeTextures(),this._createTextures()),this._updateTextureReferences()}_updateTextureReferences(){var e;const t=this._scene.prePassRenderer;if(!t)return!1;const i=t.getIndex(4),s=(null===(e=t.defaultRT.textures)||void 0===e?void 0:e.length)?t.defaultRT.textures[i].getInternalTexture():null;return!!s&&(this._blendBackTexture!==s&&(this._blendBackTexture=s,this._blendBackMrt.setInternalTexture(this._blendBackTexture,0),this._thinTextures[6]&&this._thinTextures[6].dispose(),this._thinTextures[6]=new br(this._blendBackTexture),t.defaultRT.renderTarget._shareDepth(this._depthMrts[0].renderTarget)),!0)}_createEffects(){this._blendBackEffectWrapper=new On({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this._engine,samplerNames:["uBackColor"],uniformNames:[]}),this._blendBackEffectWrapperPingPong=new On({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this._engine,samplerNames:["uBackColor"],uniformNames:[]}),this._finalEffectWrapper=new On({fragmentShader:"oitFinal",useShaderStore:!0,engine:this._engine,samplerNames:["uFrontColor","uBackColor"],uniformNames:[]}),this._effectRenderer=new Mn(this._engine)}setPrePassRenderer(e){e.addEffectConfiguration(this._prePassEffectConfiguration)}bind(e){e.setTexture("oitDepthSampler",this._thinTextures[3*this._currentPingPongState]),e.setTexture("oitFrontColorSampler",this._thinTextures[3*this._currentPingPongState+1])}_renderSubMeshes(e){let t;this._useRenderPasses&&(t={});for(let i=0;i<e.length;i++){const s=e.data[i].getMaterial();let r=!0,n=!1;const o=e.data[i];let a,l=!1;if(this._useRenderPasses&&(a=o._getDrawWrapper(),l=!a),s&&(r=s.allowShaderHotSwapping,n=s.backFaceCulling,s.allowShaderHotSwapping=!1,s.backFaceCulling=!1),o.render(!1),l&&(a=o._getDrawWrapper(),a.materialContext)){let e=t[a.materialContext.uniqueId];e||(e=t[a.materialContext.uniqueId]=this._engine.createMaterialContext()),o._getDrawWrapper().materialContext=e}s&&(s.allowShaderHotSwapping=r,s.backFaceCulling=n)}}_finalCompose(e){var t;(null===(t=this._scene.prePassRenderer)||void 0===t?void 0:t.setCustomOutput(this._outputRT))?this._engine.bindFramebuffer(this._outputRT.renderTarget):this._engine.restoreDefaultFramebuffer(),this._engine.setAlphaMode(0),this._engine.applyStates(),this._engine.enableEffect(this._finalEffectWrapper._drawWrapper),this._finalEffectWrapper.effect.setTexture("uFrontColor",this._thinTextures[3*e+1]),this._finalEffectWrapper.effect.setTexture("uBackColor",this._thinTextures[6]),this._effectRenderer.render(this._finalEffectWrapper)}isReady(){return this._blendBackEffectWrapper.effect.isReady()&&this._blendBackEffectWrapperPingPong.effect.isReady()&&this._finalEffectWrapper.effect.isReady()&&this._updateTextures()}render(e){if(this._candidateSubMeshes.length=0,this._excludedSubMeshes.length=0,!this.isReady())return this._excludedSubMeshes;this._scene.activeCamera&&this._engine.setViewport(this._scene.activeCamera.viewport);for(let t=0;t<e.length;t++){const i=e.data[t],s=i.getMaterial(),r=s&&i.getRenderingMesh()._getRenderingFillMode(s.fillMode);!s||r!==sr.TriangleFanDrawMode&&r!==sr.TriangleFillMode&&r!==sr.TriangleStripDrawMode||-1!==this._excludedMeshes.indexOf(i.getMesh().uniqueId)?this._excludedSubMeshes.push(i):this._candidateSubMeshes.push(i)}if(!this._candidateSubMeshes.length)return this._engine.bindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[1].renderTarget),this._finalCompose(1),this._excludedSubMeshes;const t=this._engine.currentRenderPassId;this._scene.prePassRenderer._enabled=!1,this._useRenderPasses&&(this._engine.currentRenderPassId=this._renderPassIds[0]),this._engine.bindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[0],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindFramebuffer(this._depthMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[1],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[1].renderTarget),this._engine.bindFramebuffer(this._colorMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[0].renderTarget),this._engine.bindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.setAlphaMode(11),this._engine.setAlphaEquation(3),this._engine.depthCullingState.depthMask=!1,this._engine.depthCullingState.depthTest=!0,this._engine.applyStates(),this._currentPingPongState=1,this._renderSubMeshes(this._candidateSubMeshes),this._engine.unBindFramebuffer(this._depthMrts[0].renderTarget),this._scene.resetCachedMaterial();let i=0,s=0;for(let e=0;e<this._passCount;e++){i=e%2,s=1-i,this._currentPingPongState=i,this._useRenderPasses&&(this._engine.currentRenderPassId=this._renderPassIds[e+1]),this._scene.activeCamera&&this._engine.setViewport(this._scene.activeCamera.viewport),this._engine.bindFramebuffer(this._depthMrts[s].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[0],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[s].renderTarget),this._engine.bindFramebuffer(this._colorMrts[s].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[s].renderTarget),this._engine.bindFramebuffer(this._depthMrts[s].renderTarget),this._engine.bindAttachments(this._layoutCache[2]),this._engine.setAlphaMode(11),this._engine.setAlphaEquation(3),this._engine.depthCullingState.depthTest=!1,this._engine.applyStates(),this._renderSubMeshes(this._candidateSubMeshes),this._engine.unBindFramebuffer(this._depthMrts[s].renderTarget),this._scene.resetCachedMaterial(),this._engine.bindFramebuffer(this._blendBackMrt.renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.setAlphaEquation(0),this._engine.setAlphaMode(17),this._engine.applyStates();const t=0!==s&&this._useRenderPasses?this._blendBackEffectWrapperPingPong:this._blendBackEffectWrapper;this._engine.enableEffect(t._drawWrapper),t.effect.setTexture("uBackColor",this._thinTextures[3*s+2]),this._effectRenderer.render(t),this._engine.unBindFramebuffer(this._blendBackMrt.renderTarget)}return this._engine.currentRenderPassId=t,this._finalCompose(s),this._scene.prePassRenderer._enabled=!0,this._engine.depthCullingState.depthMask=!0,this._engine.depthCullingState.depthTest=!0,this._excludedSubMeshes}dispose(){this._disposeTextures(),this._blendBackEffectWrapper.dispose(),this._finalEffectWrapper.dispose(),this._effectRenderer.dispose(),this._releaseRenderPassIds()}}Nv._DEPTH_CLEAR_VALUE=-99999,Nv._MIN_DEPTH=0,Nv._MAX_DEPTH=1,Object.defineProperty(Yi.prototype,"depthPeelingRenderer",{get:function(){if(!this._depthPeelingRenderer){let e=this._getComponent(fi.NAME_DEPTHPEELINGRENDERER);e||(e=new Fv(this),this._addComponent(e))}return this._depthPeelingRenderer},set:function(e){this._depthPeelingRenderer=e},enumerable:!0,configurable:!0}),Object.defineProperty(Yi.prototype,"useOrderIndependentTransparency",{get:function(){return this._useOrderIndependentTransparency},set:function(e){var t;this._useOrderIndependentTransparency!==e&&(this._useOrderIndependentTransparency=e,this.markAllMaterialsAsDirty(63),null===(t=this.prePassRenderer)||void 0===t||t.markAsDirty())},enumerable:!0,configurable:!0});class Fv{constructor(e){this.name=fi.NAME_DEPTHPEELINGRENDERER,this.scene=e,e.depthPeelingRenderer=new Nv(e)}register(){}rebuild(){}dispose(){var e;null===(e=this.scene.depthPeelingRenderer)||void 0===e||e.dispose(),this.scene.depthPeelingRenderer=null}}nt.ShadersStore.linePixelShader="#include<clipPlaneFragmentDeclaration>\nuniform vec4 color;\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<logDepthFragment>\n#include<clipPlaneFragment>\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";nt.ShadersStore.lineVertexShader="#include<instancesDeclaration>\n#include<clipPlaneVertexDeclaration>\nattribute vec3 position;attribute vec4 normal;uniform mat4 viewProjection;uniform float width;uniform float aspectRatio;\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#include<instancesVertex>\nmat4 worldViewProjection=viewProjection*finalWorld;vec4 viewPosition=worldViewProjection*vec4(position,1.0);vec4 viewPositionNext=worldViewProjection*vec4(normal.xyz,1.0);vec2 currentScreen=viewPosition.xy/viewPosition.w;vec2 nextScreen=viewPositionNext.xy/viewPositionNext.w;currentScreen.x*=aspectRatio;nextScreen.x*=aspectRatio;vec2 dir=normalize(nextScreen-currentScreen);vec2 normalDir=vec2(-dir.y,dir.x);normalDir*=width/2.0;normalDir.x/=aspectRatio;vec4 offset=vec4(normalDir*normal.w,0.0,0.0);gl_Position=viewPosition+offset;\n#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nvec4 worldPos=finalWorld*vec4(position,1.0);\n#include<clipPlaneVertex>\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}",Vs.prototype.disableEdgesRendering=function(){return this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=null),this},Vs.prototype.enableEdgesRendering=function(e=.95,t=!1,i){return this.disableEdgesRendering(),this._edgesRenderer=new Lv(this,e,t,!0,i),this},Object.defineProperty(Vs.prototype,"edgesRenderer",{get:function(){return this._edgesRenderer},enumerable:!0,configurable:!0}),Gl.prototype.enableEdgesRendering=function(e=.95,t=!1){return this.disableEdgesRendering(),this._edgesRenderer=new Bv(this,e,t),this},zl.prototype.enableEdgesRendering=function(e=.95,t=!1){return Gl.prototype.enableEdgesRendering.apply(this,arguments),this};class wv{constructor(){this.edges=[],this.edgesConnectedCount=0}}class Lv{get linesPositions(){return this._linesPositions}get linesNormals(){return this._linesNormals}get linesIndices(){return this._linesIndices}get lineShader(){return this._lineShader}set lineShader(e){this._lineShader=e}static _GetShader(e){if(!e._edgeRenderLineShader){const t=new kl("lineShader",e,"line",{attributes:["position","normal"],uniforms:["world","viewProjection","color","width","aspectRatio"]},!1);t.disableDepthWrite=!0,t.backFaceCulling=!1,t.checkReadyOnEveryCall=e.getEngine().isWebGPU,e._edgeRenderLineShader=t}return e._edgeRenderLineShader}constructor(e,t=.95,i=!1,s=!0,r){var n;this.edgesWidthScalerForOrthographic=1e3,this.edgesWidthScalerForPerspective=50,this._linesPositions=new Array,this._linesNormals=new Array,this._linesIndices=new Array,this._buffers={},this._buffersForInstances={},this._checkVerticesInsteadOfIndices=!1,this.isEnabled=!0,this.customInstances=new Yt(32),this._source=e,this._checkVerticesInsteadOfIndices=i,this._options=null!=r?r:null,this._epsilon=t,this._source.getScene().getEngine().isWebGPU&&(this._drawWrapper=new Tt(e.getEngine())),this._prepareRessources(),s&&(null===(n=null==r?void 0:r.useAlternateEdgeFinder)||void 0===n||n?this._generateEdgesLinesAlternate():this._generateEdgesLines()),this._meshRebuildObserver=this._source.onRebuildObservable.add((()=>{this._rebuild()})),this._meshDisposeObserver=this._source.onDisposeObservable.add((()=>{this.dispose()}))}_prepareRessources(){this._lineShader||(this._lineShader=Lv._GetShader(this._source.getScene()))}_rebuild(){let e=this._buffers[hi.PositionKind];e&&e._rebuild(),e=this._buffers[hi.NormalKind],e&&e._rebuild();const t=this._source.getScene().getEngine();this._ib=t.createIndexBuffer(this._linesIndices)}dispose(){var e;this._source.onRebuildObservable.remove(this._meshRebuildObserver),this._source.onDisposeObservable.remove(this._meshDisposeObserver);let t=this._buffers[hi.PositionKind];t&&(t.dispose(),this._buffers[hi.PositionKind]=null),t=this._buffers[hi.NormalKind],t&&(t.dispose(),this._buffers[hi.NormalKind]=null),this._ib&&this._source.getScene().getEngine()._releaseBuffer(this._ib),this._lineShader.dispose(),null===(e=this._drawWrapper)||void 0===e||e.dispose()}_processEdgeForAdjacencies(e,t,i,s,r){return e===i&&t===s||e===s&&t===i?0:e===s&&t===r||e===r&&t===s?1:e===r&&t===i||e===i&&t===r?2:-1}_processEdgeForAdjacenciesWithVertices(e,t,i,s,r){const n=1e-10;return e.equalsWithEpsilon(i,n)&&t.equalsWithEpsilon(s,n)||e.equalsWithEpsilon(s,n)&&t.equalsWithEpsilon(i,n)?0:e.equalsWithEpsilon(s,n)&&t.equalsWithEpsilon(r,n)||e.equalsWithEpsilon(r,n)&&t.equalsWithEpsilon(s,n)?1:e.equalsWithEpsilon(r,n)&&t.equalsWithEpsilon(i,n)||e.equalsWithEpsilon(i,n)&&t.equalsWithEpsilon(r,n)?2:-1}_checkEdge(e,t,i,s,r){let n;n=void 0===t||S.Dot(i[e],i[t])<this._epsilon,n&&this.createLine(s,r,this._linesPositions.length/3)}createLine(e,t,i){this._linesPositions.push(e.x,e.y,e.z,e.x,e.y,e.z,t.x,t.y,t.z,t.x,t.y,t.z),this._linesNormals.push(t.x,t.y,t.z,-1,t.x,t.y,t.z,1,e.x,e.y,e.z,-1,e.x,e.y,e.z,1),this._linesIndices.push(i,i+1,i+2,i,i+2,i+3)}_tessellateTriangle(e,t,i,s){const r=(e,t,i)=>{i>=0&&t.push(i);for(let i=0;i<e.length;++i)t.push(e[i][0])};let n=0;e[1].length>=e[0].length&&e[1].length>=e[2].length?n=1:e[2].length>=e[0].length&&e[2].length>=e[1].length&&(n=2);for(let t=0;t<3;++t)t===n?e[t].sort(((e,t)=>e[1]<t[1]?-1:e[1]>t[1]?1:0)):e[t].sort(((e,t)=>e[1]>t[1]?-1:e[1]<t[1]?1:0));const o=[],a=[];r(e[n],o,-1);const l=o.length;for(let o=n+2;o>=n+1;--o)r(e[o%3],a,o!==n+2?s[i[t+(o+1)%3]]:-1);const h=a.length;i.push(s[i[t+n]],o[0],a[0]),i.push(s[i[t+(n+1)%3]],a[h-1],o[l-1]);const c=l<=h,u=c?l:h,d=c?h:l,p=c?l-1:h-1,_=c?0:1;let f=l+h-2,m=0,g=0;const v=c?o:a,x=c?a:o;let T=0;for(;f-- >0;){let e;_?i.push(v[m],x[g]):i.push(x[g],v[m]),T+=u,T>=d&&m<p?(e=v[++m],T-=d):e=x[++g],i.push(e)}i[t+0]=i[i.length-3],i[t+1]=i[i.length-2],i[t+2]=i[i.length-1],i.length=i.length-3}_generateEdgesLinesAlternate(){var e,t,i,s,r,n,o,a,l,h;const c=this._source.getVerticesData(hi.PositionKind);let u=this._source.getIndices();if(!u||!c)return;Array.isArray(u)||(u=Array.from(u));const d=null===(t=null===(e=this._options)||void 0===e?void 0:e.useFastVertexMerger)||void 0===t||t,p=d?Math.round(-Math.log(null!==(s=null===(i=this._options)||void 0===i?void 0:i.epsilonVertexMerge)&&void 0!==s?s:1e-6)/Math.log(10)):null!==(n=null===(r=this._options)||void 0===r?void 0:r.epsilonVertexMerge)&&void 0!==n?n:1e-6,_=[],f=[];if(d){const e={};for(let t=0;t<c.length;t+=3){const i=c[t+0],s=c[t+1],r=c[t+2],n=i.toFixed(p)+"|"+s.toFixed(p)+"|"+r.toFixed(p);if(void 0!==e[n])_.push(e[n]);else{const i=t/3;e[n]=i,_.push(i),f.push(i)}}}else for(let e=0;e<c.length;e+=3){const t=c[e+0],i=c[e+1],s=c[e+2];let r=!1;for(let n=0;n<e&&!r;n+=3){const e=c[n+0],o=c[n+1],a=c[n+2];if(Math.abs(t-e)<p&&Math.abs(i-o)<p&&Math.abs(s-a)<p){_.push(n/3),r=!0;break}}r||(_.push(e/3),f.push(e/3))}if(null===(o=this._options)||void 0===o?void 0:o.applyTessellation){const e=null!==(l=null===(a=this._options)||void 0===a?void 0:a.epsilonVertexAligned)&&void 0!==l?l:1e-6,t=[];for(let i=0;i<u.length;i+=3){let s;for(let r=0;r<3;++r){const n=_[u[i+r]],o=_[u[i+(r+1)%3]],a=_[u[i+(r+2)%3]];if(n===o)continue;const l=c[3*n+0],h=c[3*n+1],d=c[3*n+2],p=c[3*o+0],m=c[3*o+1],g=c[3*o+2],v=Math.sqrt((p-l)*(p-l)+(m-h)*(m-h)+(g-d)*(g-d));for(let u=0;u<f.length-1;u++){const _=f[u];if(_===n||_===o||_===a)continue;const x=c[3*_+0],T=c[3*_+1],E=c[3*_+2],S=Math.sqrt((x-l)*(x-l)+(T-h)*(T-h)+(E-d)*(E-d)),b=Math.sqrt((x-p)*(x-p)+(T-m)*(T-m)+(E-g)*(E-g));Math.abs(S+b-v)<e&&(s||(s={index:i,edgesPoints:[[],[],[]]},t.push(s)),s.edgesPoints[r].push([_,S]))}}}for(let e=0;e<t.length;++e){const i=t[e];this._tessellateTriangle(i.edgesPoints,i.index,u,_)}t.length=0}const m={};for(let e=0;e<u.length;e+=3){let t;for(let i=0;i<3;++i){let s=_[u[e+i]],r=_[u[e+(i+1)%3]];const n=_[u[e+(i+2)%3]];if(s===r||(s===n||r===n)&&(null===(h=this._options)||void 0===h?void 0:h.removeDegeneratedTriangles))continue;if(R.Vector3[0].copyFromFloats(c[3*s+0],c[3*s+1],c[3*s+2]),R.Vector3[1].copyFromFloats(c[3*r+0],c[3*r+1],c[3*r+2]),R.Vector3[2].copyFromFloats(c[3*n+0],c[3*n+1],c[3*n+2]),t||(R.Vector3[1].subtractToRef(R.Vector3[0],R.Vector3[3]),R.Vector3[2].subtractToRef(R.Vector3[1],R.Vector3[4]),t=S.Cross(R.Vector3[3],R.Vector3[4]),t.normalize()),s>r){const e=s;s=r,r=e}const o=s+"_"+r,a=m[o];a?a.done||(S.Dot(t,a.normal)<this._epsilon&&this.createLine(R.Vector3[0],R.Vector3[1],this._linesPositions.length/3),a.done=!0):m[o]={normal:t,done:!1,index:e,i}}}for(const e in m){const t=m[e];if(!t.done){const e=_[u[t.index+t.i]],i=_[u[t.index+(t.i+1)%3]];R.Vector3[0].copyFromFloats(c[3*e+0],c[3*e+1],c[3*e+2]),R.Vector3[1].copyFromFloats(c[3*i+0],c[3*i+1],c[3*i+2]),this.createLine(R.Vector3[0],R.Vector3[1],this._linesPositions.length/3)}}const g=this._source.getScene().getEngine();this._buffers[hi.PositionKind]=new hi(g,this._linesPositions,hi.PositionKind,!1),this._buffers[hi.NormalKind]=new hi(g,this._linesNormals,hi.NormalKind,!1,!1,4),this._buffersForInstances[hi.PositionKind]=this._buffers[hi.PositionKind],this._buffersForInstances[hi.NormalKind]=this._buffers[hi.NormalKind],this._ib=g.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}_generateEdgesLines(){const e=this._source.getVerticesData(hi.PositionKind),t=this._source.getIndices();if(!t||!e)return;const i=[],s=[];let r,n;for(r=0;r<t.length;r+=3){n=new wv;const o=t[r],a=t[r+1],l=t[r+2];n.p0=new S(e[3*o],e[3*o+1],e[3*o+2]),n.p1=new S(e[3*a],e[3*a+1],e[3*a+2]),n.p2=new S(e[3*l],e[3*l+1],e[3*l+2]);const h=S.Cross(n.p1.subtract(n.p0),n.p2.subtract(n.p1));h.normalize(),s.push(h),i.push(n)}for(r=0;r<i.length;r++){n=i[r];for(let e=r+1;e<i.length;e++){const s=i[e];if(3===n.edgesConnectedCount)break;if(3===s.edgesConnectedCount)continue;const o=t[3*e],a=t[3*e+1],l=t[3*e+2];for(let i=0;i<3;i++){let h=0;if(void 0===n.edges[i]){switch(i){case 0:h=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(n.p0,n.p1,s.p0,s.p1,s.p2):this._processEdgeForAdjacencies(t[3*r],t[3*r+1],o,a,l);break;case 1:h=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(n.p1,n.p2,s.p0,s.p1,s.p2):this._processEdgeForAdjacencies(t[3*r+1],t[3*r+2],o,a,l);break;case 2:h=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(n.p2,n.p0,s.p0,s.p1,s.p2):this._processEdgeForAdjacencies(t[3*r+2],t[3*r],o,a,l)}if(-1!==h&&(n.edges[i]=e,s.edges[h]=r,n.edgesConnectedCount++,s.edgesConnectedCount++,3===n.edgesConnectedCount))break}}}}for(r=0;r<i.length;r++){const e=i[r];this._checkEdge(r,e.edges[0],s,e.p0,e.p1),this._checkEdge(r,e.edges[1],s,e.p1,e.p2),this._checkEdge(r,e.edges[2],s,e.p2,e.p0)}const o=this._source.getScene().getEngine();this._buffers[hi.PositionKind]=new hi(o,this._linesPositions,hi.PositionKind,!1),this._buffers[hi.NormalKind]=new hi(o,this._linesNormals,hi.NormalKind,!1,!1,4),this._buffersForInstances[hi.PositionKind]=this._buffers[hi.PositionKind],this._buffersForInstances[hi.NormalKind]=this._buffers[hi.NormalKind],this._ib=o.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}isReady(){return this._lineShader.isReady(this._source,this._source.hasInstances&&this.customInstances.length>0||this._source.hasThinInstances)}render(){const e=this._source.getScene(),t=this._lineShader._getDrawWrapper();if(this._drawWrapper&&this._lineShader._setDrawWrapper(this._drawWrapper),!this.isReady()||!e.activeCamera)return void this._lineShader._setDrawWrapper(t);const i=this._source.hasInstances&&this.customInstances.length>0,s=i||this._source.hasThinInstances;let r=0;if(s)if(this._buffersForInstances.world0=this._source.getVertexBuffer("world0"),this._buffersForInstances.world1=this._source.getVertexBuffer("world1"),this._buffersForInstances.world2=this._source.getVertexBuffer("world2"),this._buffersForInstances.world3=this._source.getVertexBuffer("world3"),i){const e=this._source._instanceDataStorage;if(r=this.customInstances.length,!e.instancesData)return void(this._source.getScene()._activeMeshesFrozen||this.customInstances.reset());if(!e.isFrozen){let t=0;for(let i=0;i<r;++i)this.customInstances.data[i].copyToArray(e.instancesData,t),t+=16;e.instancesBuffer.updateDirectly(e.instancesData,0,r)}}else r=this._source.thinInstanceCount;const n=e.getEngine();this._lineShader._preBind(),1!==this._source.edgesColor.a?n.setAlphaMode(2):n.setAlphaMode(0),n.bindBuffers(s?this._buffersForInstances:this._buffers,this._ib,this._lineShader.getEffect()),e.resetCachedMaterial(),this._lineShader.setColor4("color",this._source.edgesColor),e.activeCamera.mode===ps.ORTHOGRAPHIC_CAMERA?this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForOrthographic):this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForPerspective),this._lineShader.setFloat("aspectRatio",n.getAspectRatio(e.activeCamera)),this._lineShader.bind(this._source.getWorldMatrix()),n.drawElementsType(sr.TriangleFillMode,0,this._indicesCount,r),this._lineShader.unbind(),s&&n.unbindInstanceAttributes(),this._source.getScene()._activeMeshesFrozen||this.customInstances.reset(),this._lineShader._setDrawWrapper(t)}}class Bv extends Lv{constructor(e,t=.95,i=!1){super(e,t,i,!1),this._generateEdgesLines()}_generateEdgesLines(){const e=this._source.getVerticesData(hi.PositionKind),t=this._source.getIndices();if(!t||!e)return;const i=R.Vector3[0],s=R.Vector3[1],r=t.length-1;for(let n=0,o=0;n<r;n+=2,o+=4)S.FromArrayToRef(e,3*t[n],i),S.FromArrayToRef(e,3*t[n+1],s),this.createLine(i,s,o);const n=this._source.getScene().getEngine();this._buffers[hi.PositionKind]=new hi(n,this._linesPositions,hi.PositionKind,!1),this._buffers[hi.NormalKind]=new hi(n,this._linesNormals,hi.NormalKind,!1,!1,4),this._ib=n.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}}class Uv extends F_{constructor(e,t,i,s,r,n){super(e,i,s,r,n),this._beforeCompositionPostProcesses=[],this._internalTextureDirty=!1,this.enabled=!1,this.renderTargetTexture=null,this.renderTargetTexture=t}_createCompositionEffect(){this.imageProcessingPostProcess=new nv("prePassComposition",1,null,void 0,this._engine),this.imageProcessingPostProcess._updateParameters()}_checkSize(){const e=this._engine.getRenderWidth(!0),t=this._engine.getRenderHeight(!0),i=this.getRenderWidth(),s=this.getRenderHeight();i===e&&s===t||(this.resize({width:e,height:t}),this._internalTextureDirty=!0)}updateCount(e,t,i){super.updateCount(e,t,i),this._internalTextureDirty=!0}_resetPostProcessChain(){this._beforeCompositionPostProcesses.length=0}dispose(){const e=this._scene;if(super.dispose(),e&&e.prePassRenderer){const t=e.prePassRenderer.renderTargets.indexOf(this);-1!==t&&e.prePassRenderer.renderTargets.splice(t,1)}this.imageProcessingPostProcess&&this.imageProcessingPostProcess.dispose(),this.renderTargetTexture&&(this.renderTargetTexture._prePassRenderTarget=null),this._outputPostProcess&&(this._outputPostProcess.autoClear=!0,this._outputPostProcess.restoreDefaultInputTexture())}}class Vv{get generateNormalsInWorldSpace(){return this._generateNormalsInWorldSpace}set generateNormalsInWorldSpace(e){this._generateNormalsInWorldSpace!==e&&(this._generateNormalsInWorldSpace=e,this._markAllMaterialsAsPrePassDirty())}getIndex(e){return this._textureIndices[e]}get samples(){return this.defaultRT.samples}set samples(e){this.defaultRT.samples=e}get useSpecificClearForDepthTexture(){return this._useSpecificClearForDepthTexture}set useSpecificClearForDepthTexture(e){this._useSpecificClearForDepthTexture!==e&&(this._useSpecificClearForDepthTexture=e,this._isDirty=!0)}getRenderTarget(){return this._currentTarget}_setRenderTarget(e){var t,i;e?this._currentTarget=e:(this._currentTarget=this.defaultRT,this._engine.currentRenderPassId=null!==(i=null===(t=this._scene.activeCamera)||void 0===t?void 0:t.renderPassId)&&void 0!==i?i:this._currentTarget.renderPassId)}get currentRTisSceneRT(){return this._currentTarget===this.defaultRT}_refreshGeometryBufferRendererLink(){if(this.doNotUseGeometryRendererFallback)this._geometryBuffer&&this._geometryBuffer._unlinkPrePassRenderer(),this._geometryBuffer=null,this._scene.disableGeometryBufferRenderer();else{if(this._geometryBuffer=this._scene.enableGeometryBufferRenderer(),!this._geometryBuffer)return void(this.doNotUseGeometryRendererFallback=!0);this._geometryBuffer._linkPrePassRenderer(this)}}get enabled(){return this._enabled}constructor(e){this.excludedSkinnedMesh=[],this.excludedMaterials=[],this.mrtCount=0,this._mrtTypes=[],this._mrtFormats=[],this._mrtLayout=[],this._mrtNames=[],this._textureIndices=[],this._generateNormalsInWorldSpace=!1,this._useSpecificClearForDepthTexture=!1,this._isDirty=!0,this._effectConfigurations=[],this.doNotUseGeometryRendererFallback=!0,this.renderTargets=[],this._clearColor=new F(0,0,0,0),this._clearDepthColor=new F(1e8,0,0,1),this._enabled=!1,this._needsCompositionForThisPass=!1,this.disableGammaTransform=!1,this._scene=e,this._engine=e.getEngine();let t=0;this._engine._caps.textureFloat&&this._engine._caps.textureFloatLinearFiltering?t=1:this._engine._caps.textureHalfFloat&&this._engine._caps.textureHalfFloatLinearFiltering&&(t=2);for(let e=0;e<Vv.TextureFormats.length;++e){const i=Vv.TextureFormats[e].format;1===Vv.TextureFormats[e].type&&(Vv.TextureFormats[5].type=t,6!==i&&7!==i&&5!==i||this._engine._caps.supportFloatTexturesResolve||(Vv.TextureFormats[5].type=2))}Vv._SceneComponentInitialization(this._scene),this.defaultRT=this._createRenderTarget("sceneprePassRT",null),this._currentTarget=this.defaultRT}_createRenderTarget(e,t){const i=new Uv(e,t,{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},0,this._scene,{generateMipMaps:!1,generateStencilBuffer:this._engine.isStencilEnable,defaultType:0,types:[],drawOnlyOnFirstAttachmentByDefault:!0});return this.renderTargets.push(i),this._enabled&&this._update(),i}get isSupported(){return this._scene.getEngine().getCaps().drawBuffersExtension}bindAttachmentsForEffect(e,t){const i=t.getMaterial(),s=i&&i.isPrePassCapable,r=i&&-1!==this.excludedMaterials.indexOf(i);this.enabled&&this._currentTarget.enabled&&(e._multiTarget&&s&&!r?this._engine.bindAttachments(this._multiRenderAttachments):(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment(),this._geometryBuffer&&this.currentRTisSceneRT&&!r&&this._geometryBuffer.renderList.push(t.getRenderingMesh())))}_reinitializeAttachments(){const e=[],t=[!1],i=[!1],s=[!0];for(let r=0;r<this.mrtCount;r++)e.push(!0),r>0&&(this._useSpecificClearForDepthTexture&&5===this._mrtLayout[r]?(t.push(!1),i.push(!0)):(t.push(!0),i.push(!1)),s.push(!1));this._multiRenderAttachments=this._engine.buildTextureLayout(e),this._clearAttachments=this._engine.buildTextureLayout(t),this._clearDepthAttachments=this._engine.buildTextureLayout(i),this._defaultAttachments=this._engine.buildTextureLayout(s)}_resetLayout(){for(let e=0;e<Vv.TextureFormats.length;e++)this._textureIndices[Vv.TextureFormats[e].purpose]=-1;this._textureIndices[4]=0,this._mrtLayout=[4],this._mrtTypes=[Vv.TextureFormats[4].type],this._mrtFormats=[Vv.TextureFormats[4].format],this._mrtNames=[Vv.TextureFormats[4].name],this.mrtCount=1}_updateGeometryBufferLayout(){if(this._refreshGeometryBufferRendererLink(),this._geometryBuffer){this._geometryBuffer._resetLayout();const e=[];for(let t=0;t<this._mrtLayout.length;t++)e.push(!1);this._geometryBuffer._linkInternalTexture(this.defaultRT.getInternalTexture());const t=[{prePassConstant:5,geometryBufferConstant:av.DEPTH_TEXTURE_TYPE},{prePassConstant:6,geometryBufferConstant:av.NORMAL_TEXTURE_TYPE},{prePassConstant:1,geometryBufferConstant:av.POSITION_TEXTURE_TYPE},{prePassConstant:3,geometryBufferConstant:av.REFLECTIVITY_TEXTURE_TYPE},{prePassConstant:2,geometryBufferConstant:av.VELOCITY_TEXTURE_TYPE}];for(let i=0;i<t.length;i++){const s=this._mrtLayout.indexOf(t[i].prePassConstant);-1!==s&&(this._geometryBuffer._forceTextureType(t[i].geometryBufferConstant,s),e[s]=!0)}this._geometryBuffer._setAttachments(this._engine.buildTextureLayout(e))}}restoreAttachments(){this.enabled&&this._currentTarget.enabled&&this._defaultAttachments&&(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment())}_beforeDraw(e,t,i){this._isDirty&&this._update(),this._enabled&&this._currentTarget.enabled&&(this._geometryBuffer&&(this._geometryBuffer.renderList=[]),this._setupOutputForThisPass(this._currentTarget,e))}_prepareFrame(e,t,i){e.renderTargetTexture?e.renderTargetTexture._prepareFrame(this._scene,t,i,e.renderTargetTexture.useCameraPostProcesses):this._postProcessesSourceForThisPass.length?this._scene.postProcessManager._prepareFrame():this._engine.restoreDefaultFramebuffer()}setCustomOutput(e){const t=this._postProcessesSourceForThisPass[0];return!!t&&(t.inputTexture=e.renderTarget,!0)}_renderPostProcesses(e,t){var i;const s=this._postProcessesSourceForThisPass[0],r=s?s.inputTexture:e.renderTargetTexture?e.renderTargetTexture.renderTarget:null;let n=this._currentTarget._beforeCompositionPostProcesses;this._needsCompositionForThisPass&&(n=n.concat([this._currentTarget.imageProcessingPostProcess])),n.length&&(this._scene.postProcessManager._prepareFrame(null===(i=this._currentTarget.renderTarget)||void 0===i?void 0:i.texture,n),this._scene.postProcessManager.directRender(n,r,!1,t))}_afterDraw(e,t){this._enabled&&this._currentTarget.enabled&&(this._prepareFrame(this._currentTarget,e,t),this._renderPostProcesses(this._currentTarget,e))}_clear(){this._enabled&&this._currentTarget.enabled&&(this._bindFrameBuffer(),this._engine.bindAttachments(this._clearAttachments),this._engine.clear(this._clearColor,!0,!1,!1),this._useSpecificClearForDepthTexture&&(this._engine.bindAttachments(this._clearDepthAttachments),this._engine.clear(this._clearDepthColor,!0,!1,!1)),this._engine.bindAttachments(this._defaultAttachments))}_bindFrameBuffer(){if(this._enabled&&this._currentTarget.enabled){this._currentTarget._checkSize();const e=this._currentTarget.renderTarget;e&&this._engine.bindFramebuffer(e)}}_setEnabled(e){this._enabled=e}_setRenderTargetEnabled(e,t){e.enabled=t,t||this._unlinkInternalTexture(e)}addEffectConfiguration(e){for(let t=0;t<this._effectConfigurations.length;t++)if(this._effectConfigurations[t].name===e.name)return this._effectConfigurations[t];return this._effectConfigurations.push(e),e}getEffectConfiguration(e){for(let t=0;t<this._effectConfigurations.length;t++)if(this._effectConfigurations[t].name===e)return this._effectConfigurations[t];return null}_enable(){const e=this.mrtCount;for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].enabled&&this._enableTextures(this._effectConfigurations[e].texturesRequired);for(let t=0;t<this.renderTargets.length;t++){this.mrtCount===e&&this.renderTargets[t].count===this.mrtCount||this.renderTargets[t].updateCount(this.mrtCount,{types:this._mrtTypes,formats:this._mrtFormats},this._mrtNames.concat("prePass_DepthBuffer")),this.renderTargets[t]._resetPostProcessChain();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].enabled&&(!this._effectConfigurations[e].postProcess&&this._effectConfigurations[e].createPostProcess&&this._effectConfigurations[e].createPostProcess(),this._effectConfigurations[e].postProcess&&this.renderTargets[t]._beforeCompositionPostProcesses.push(this._effectConfigurations[e].postProcess))}this._reinitializeAttachments(),this._setEnabled(!0),this._updateGeometryBufferLayout()}_disable(){this._setEnabled(!1);for(let e=0;e<this.renderTargets.length;e++)this._setRenderTargetEnabled(this.renderTargets[e],!1);this._resetLayout();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].enabled=!1}_getPostProcessesSource(e,t){if(t)return t._postProcesses;if(e.renderTargetTexture){if(e.renderTargetTexture.useCameraPostProcesses){const t=e.renderTargetTexture.activeCamera?e.renderTargetTexture.activeCamera:this._scene.activeCamera;return t?t._postProcesses:[]}return e.renderTargetTexture.postProcesses?e.renderTargetTexture.postProcesses:[]}return this._scene.activeCamera?this._scene.activeCamera._postProcesses:[]}_setupOutputForThisPass(e,t){const i=t&&this._scene.activeCameras&&!!this._scene.activeCameras.length&&0!==this._scene.activeCameras.indexOf(t);this._postProcessesSourceForThisPass=this._getPostProcessesSource(e,t),this._postProcessesSourceForThisPass=this._postProcessesSourceForThisPass.filter((e=>null!=e)),this._scene.autoClear=!0;const s=this._hasImageProcessing(this._postProcessesSourceForThisPass);this._needsCompositionForThisPass=!s&&!this.disableGammaTransform&&this._needsImageProcessing()&&!i;const r=this._getFirstPostProcess(this._postProcessesSourceForThisPass),n=e._beforeCompositionPostProcesses&&e._beforeCompositionPostProcesses[0];let o=null;this._scene.imageProcessingConfiguration.applyByPostProcess=this._needsCompositionForThisPass||s,this._needsCompositionForThisPass&&!e.imageProcessingPostProcess&&e._createCompositionEffect(),n?o=n:this._needsCompositionForThisPass?o=e.imageProcessingPostProcess:r&&(o=r),this._bindFrameBuffer(),this._linkInternalTexture(e,o)}_linkInternalTexture(e,t){t&&(t.autoClear=!1,t.inputTexture=e.renderTarget),e._outputPostProcess!==t&&(e._outputPostProcess&&this._unlinkInternalTexture(e),e._outputPostProcess=t),e._internalTextureDirty&&(this._updateGeometryBufferLayout(),e._internalTextureDirty=!1)}_unlinkInternalTexture(e){e._outputPostProcess&&(e._outputPostProcess.autoClear=!0,e._outputPostProcess.restoreDefaultInputTexture(),e._outputPostProcess=null)}_needsImageProcessing(){for(let e=0;e<this._effectConfigurations.length;e++)if(this._effectConfigurations[e].enabled&&this._effectConfigurations[e].needsImageProcessing)return!0;return!1}_hasImageProcessing(e){var t;let i=!1;if(e)for(let s=0;s<e.length;s++)if("ImageProcessingPostProcess"===(null===(t=e[s])||void 0===t?void 0:t.getClassName())){i=!0;break}return i}_getFirstPostProcess(e){for(let t=0;t<e.length;t++)if(null!==e[t])return e[t];return null}markAsDirty(){this._isDirty=!0}_enableTextures(e){this._scene.needsPreviousWorldMatrices=!1;for(let t=0;t<e.length;t++){const i=e[t];-1===this._textureIndices[i]&&(this._textureIndices[i]=this._mrtLayout.length,this._mrtLayout.push(i),this._mrtTypes.push(Vv.TextureFormats[i].type),this._mrtFormats.push(Vv.TextureFormats[i].format),this._mrtNames.push(Vv.TextureFormats[i].name),this.mrtCount++),2===i&&(this._scene.needsPreviousWorldMatrices=!0)}}update(){this._isDirty&&this._update()}_update(){this._disable();let e,t=!1;this._scene.imageProcessingConfiguration.applyByPostProcess=!1,this._scene._depthPeelingRenderer&&this._scene.useOrderIndependentTransparency&&(this._scene._depthPeelingRenderer.setPrePassRenderer(this),t=!0);for(let e=0;e<this._scene.materials.length;e++)this._scene.materials[e].setPrePassRenderer(this)&&(t=!0);t&&this._setRenderTargetEnabled(this.defaultRT,!0);for(let i=0;i<this.renderTargets.length;i++){if(this.renderTargets[i].renderTargetTexture)e=this._getPostProcessesSource(this.renderTargets[i]);else{const t=this._scene.activeCamera;if(!t)continue;e=t._postProcesses}if(e&&(e=e.filter((e=>null!=e)),e)){for(let s=0;s<e.length;s++)e[s].setPrePassRenderer(this)&&(this._setRenderTargetEnabled(this.renderTargets[i],!0),t=!0);this._hasImageProcessing(e)&&(this._scene.imageProcessingConfiguration.applyByPostProcess=!0)}}this._markAllMaterialsAsPrePassDirty(),this._isDirty=!1,t&&this._enable()}_markAllMaterialsAsPrePassDirty(){const e=this._scene.materials;for(let t=0;t<e.length;t++)e[t].markAsDirty(sr.PrePassDirtyFlag)}dispose(){for(let e=this.renderTargets.length-1;e>=0;e--)this.renderTargets[e].dispose();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].dispose&&this._effectConfigurations[e].dispose()}}Vv._SceneComponentInitialization=e=>{throw $("PrePassRendererSceneComponent")},Vv.TextureFormats=[{purpose:0,type:2,format:5,name:"prePass_Irradiance"},{purpose:1,type:2,format:5,name:"prePass_Position"},{purpose:2,type:0,format:5,name:"prePass_Velocity"},{purpose:3,type:0,format:5,name:"prePass_Reflectivity"},{purpose:4,type:2,format:5,name:"prePass_Color"},{purpose:5,type:1,format:6,name:"prePass_Depth"},{purpose:6,type:2,format:5,name:"prePass_Normal"},{purpose:7,type:0,format:5,name:"prePass_Albedo"}],Object.defineProperty(Yi.prototype,"prePassRenderer",{get:function(){return this._prePassRenderer},set:function(e){e&&e.isSupported&&(this._prePassRenderer=e)},enumerable:!0,configurable:!0}),Yi.prototype.enablePrePassRenderer=function(){return this._prePassRenderer||(this._prePassRenderer=new Vv(this),this._prePassRenderer.isSupported||(this._prePassRenderer=null,k.Error("PrePassRenderer needs WebGL 2 support.\nMaybe you tried to use the following features that need the PrePassRenderer :\n + Subsurface Scattering"))),this._prePassRenderer},Yi.prototype.disablePrePassRenderer=function(){this._prePassRenderer&&(this._prePassRenderer.dispose(),this._prePassRenderer=null)};class kv{constructor(e){this.name=fi.NAME_PREPASSRENDERER,this.scene=e}register(){this.scene._beforeCameraDrawStage.registerStep(fi.STEP_BEFORECAMERADRAW_PREPASS,this,this._beforeCameraDraw),this.scene._afterCameraDrawStage.registerStep(fi.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterCameraDraw),this.scene._beforeRenderTargetDrawStage.registerStep(fi.STEP_BEFORERENDERTARGETDRAW_PREPASS,this,this._beforeRenderTargetDraw),this.scene._afterRenderTargetDrawStage.registerStep(fi.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterRenderTargetDraw),this.scene._beforeClearStage.registerStep(fi.STEP_BEFORECLEAR_PREPASS,this,this._beforeClearStage),this.scene._beforeRenderTargetClearStage.registerStep(fi.STEP_BEFORERENDERTARGETCLEAR_PREPASS,this,this._beforeRenderTargetClearStage),this.scene._beforeRenderingMeshStage.registerStep(fi.STEP_BEFORERENDERINGMESH_PREPASS,this,this._beforeRenderingMeshStage),this.scene._afterRenderingMeshStage.registerStep(fi.STEP_AFTERRENDERINGMESH_PREPASS,this,this._afterRenderingMeshStage)}_beforeRenderTargetDraw(e,t,i){this.scene.prePassRenderer&&!e.noPrePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._beforeDraw(void 0,t,i))}_afterRenderTargetDraw(e,t,i){this.scene.prePassRenderer&&!e.noPrePassRenderer&&this.scene.prePassRenderer._afterDraw(t,i)}_beforeRenderTargetClearStage(e){this.scene.prePassRenderer&&!e.noPrePassRenderer&&(e._prePassRenderTarget||(e._prePassRenderTarget=this.scene.prePassRenderer._createRenderTarget(e.name+"_prePassRTT",e)),this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._clear())}_beforeCameraDraw(e){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._beforeDraw(e))}_afterCameraDraw(){this.scene.prePassRenderer&&this.scene.prePassRenderer._afterDraw()}_beforeClearStage(){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._clear())}_beforeRenderingMeshStage(e,t,i,s){if(!s)return;const r=e.getScene();r.prePassRenderer&&r.prePassRenderer.bindAttachmentsForEffect(s,t)}_afterRenderingMeshStage(e){const t=e.getScene();t.prePassRenderer&&t.prePassRenderer.restoreAttachments()}rebuild(){this.scene.disablePrePassRenderer(),this.scene.enablePrePassRenderer()}dispose(){this.scene.disablePrePassRenderer()}}Vv._SceneComponentInitialization=e=>{let t=e._getComponent(fi.NAME_PREPASSRENDERER);t||(t=new kv(e),e._addComponent(t))};nt.IncludesShadersStore.fibonacci="#define rcp(x) 1./x\n#define GOLDEN_RATIO 1.618033988749895\n#define TWO_PI 6.2831855\nvec2 Golden2dSeq(int i,float n)\n{return vec2(float(i)/n+(0.5/n),fract(float(i)*rcp(GOLDEN_RATIO)));}\nvec2 SampleDiskGolden(int i,int sampleCount)\n{vec2 f=Golden2dSeq(i,float(sampleCount));return vec2(sqrt(f.x),TWO_PI*f.y);}";nt.IncludesShadersStore.diffusionProfile="uniform vec3 diffusionS[5];uniform float diffusionD[5];uniform float filterRadii[5];";nt.ShadersStore.subSurfaceScatteringPixelShader="#include<fibonacci>\n#include<helperFunctions>\n#include<subSurfaceScatteringFunctions>\n#include<diffusionProfile>\nvarying vec2 vUV;uniform vec2 texelSize;uniform sampler2D textureSampler;uniform sampler2D irradianceSampler;uniform sampler2D depthSampler;uniform sampler2D albedoSampler;uniform vec2 viewportSize;uniform float metersPerUnit;const float LOG2_E=1.4426950408889634;const float SSS_PIXELS_PER_SAMPLE=4.;const int _SssSampleBudget=40;\n#define rcp(x) 1./x\n#define Sq(x) x*x\n#define SSS_BILATERAL_FILTER true\nvec3 EvalBurleyDiffusionProfile(float r,vec3 S)\n{vec3 exp_13=exp2(((LOG2_E*(-1.0/3.0))*r)*S); \nvec3 expSum=exp_13*(1.+exp_13*exp_13); \nreturn (S*rcp(8.*PI))*expSum; }\nvec2 SampleBurleyDiffusionProfile(float u,float rcpS)\n{u=1.-u; \nfloat g=1.+(4.*u)*(2.*u+sqrt(1.+(4.*u)*u));float n=exp2(log2(g)*(-1.0/3.0)); \nfloat p=(g*n)*n; \nfloat c=1.+p+n; \nfloat d=(3./LOG2_E*2.)+(3./LOG2_E)*log2(u); \nfloat x=(3./LOG2_E)*log2(c)-d; \nfloat rcpExp=((c*c)*c)*rcp((4.*u)*((c*c)+(4.*u)*(4.*u)));float r=x*rcpS;float rcpPdf=(8.*PI*rcpS)*rcpExp; \nreturn vec2(r,rcpPdf);}\nvec3 ComputeBilateralWeight(float xy2,float z,float mmPerUnit,vec3 S,float rcpPdf)\n{\n#ifndef SSS_BILATERAL_FILTER\nz=0.;\n#endif\nfloat r=sqrt(xy2+(z*mmPerUnit)*(z*mmPerUnit));float area=rcpPdf;\n#if SSS_CLAMP_ARTIFACT\nreturn clamp(EvalBurleyDiffusionProfile(r,S)*area,0.0,1.0);\n#else\nreturn EvalBurleyDiffusionProfile(r,S)*area;\n#endif\n}\nvoid EvaluateSample(int i,int n,vec3 S,float d,vec3 centerPosVS,float mmPerUnit,float pixelsPerMm,\nfloat phase,inout vec3 totalIrradiance,inout vec3 totalWeight)\n{float scale =rcp(float(n));float offset=rcp(float(n))*0.5;float sinPhase,cosPhase;sinPhase=sin(phase);cosPhase=cos(phase);vec2 bdp=SampleBurleyDiffusionProfile(float(i)*scale+offset,d);float r=bdp.x;float rcpPdf=bdp.y;float phi=SampleDiskGolden(i,n).y;float sinPhi,cosPhi;sinPhi=sin(phi);cosPhi=cos(phi);float sinPsi=cosPhase*sinPhi+sinPhase*cosPhi; \nfloat cosPsi=cosPhase*cosPhi-sinPhase*sinPhi; \nvec2 vec=r*vec2(cosPsi,sinPsi);vec2 position; \nfloat xy2;position=vUV+round((pixelsPerMm*r)*vec2(cosPsi,sinPsi))*texelSize;xy2 =r*r;vec4 textureSample=texture2D(irradianceSampler,position);float viewZ=texture2D(depthSampler,position).r;vec3 irradiance =textureSample.rgb;if (testLightingForSSS(textureSample.a))\n{float relZ=viewZ-centerPosVS.z;vec3 weight=ComputeBilateralWeight(xy2,relZ,mmPerUnit,S,rcpPdf);totalIrradiance+=weight*irradiance;totalWeight +=weight;}\nelse\n{}}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec4 irradianceAndDiffusionProfile =texture2D(irradianceSampler,vUV);vec3 centerIrradiance=irradianceAndDiffusionProfile.rgb;int diffusionProfileIndex=int(round(irradianceAndDiffusionProfile.a*255.));float centerDepth =0.;vec4 inputColor=texture2D(textureSampler,vUV);bool passedStencilTest=testLightingForSSS(irradianceAndDiffusionProfile.a);if (passedStencilTest)\n{centerDepth=texture2D(depthSampler,vUV).r;}\nif (!passedStencilTest) { \ngl_FragColor=inputColor;return;}\nfloat distScale =1.;vec3 S =diffusionS[diffusionProfileIndex];float d =diffusionD[diffusionProfileIndex];float filterRadius=filterRadii[diffusionProfileIndex];vec2 centerPosNDC=vUV;vec2 cornerPosNDC=vUV+0.5*texelSize;vec3 centerPosVS =vec3(centerPosNDC*viewportSize,1.0)*centerDepth; \nvec3 cornerPosVS =vec3(cornerPosNDC*viewportSize,1.0)*centerDepth; \nfloat mmPerUnit =1000.*(metersPerUnit*rcp(distScale));float unitsPerMm=rcp(mmPerUnit);float unitsPerPixel=2.*abs(cornerPosVS.x-centerPosVS.x);float pixelsPerMm =rcp(unitsPerPixel)*unitsPerMm;float filterArea =PI*Sq(filterRadius*pixelsPerMm);int sampleCount =int(filterArea*rcp(SSS_PIXELS_PER_SAMPLE));int sampleBudget=_SssSampleBudget;int texturingMode=0;vec3 albedo =texture2D(albedoSampler,vUV).rgb;if (distScale==0. || sampleCount<1)\n{\n#ifdef DEBUG_SSS_SAMPLES\nvec3 green=vec3(0.,1.,0.);gl_FragColor=vec4(green,1.0);return;\n#endif\ngl_FragColor=vec4(inputColor.rgb+albedo*centerIrradiance,1.0);return;}\n#ifdef DEBUG_SSS_SAMPLES\nvec3 red =vec3(1.,0.,0.);vec3 blue=vec3(0.,0.,1.);gl_FragColor=vec4(mix(blue,red,clamp(float(sampleCount)/float(sampleBudget),0.0,1.0)),1.0);return;\n#endif\nfloat phase=0.;int n=min(sampleCount,sampleBudget);vec3 centerWeight =vec3(0.); \nvec3 totalIrradiance=vec3(0.);vec3 totalWeight =vec3(0.);for (int i=0; i<n; i++)\n{EvaluateSample(i,n,S,d,centerPosVS,mmPerUnit,pixelsPerMm,\nphase,totalIrradiance,totalWeight);}\ntotalWeight=max(totalWeight,HALF_MIN);gl_FragColor=vec4(inputColor.rgb+albedo*max(totalIrradiance/totalWeight,vec3(0.0)),1.);}";class Gv extends dn{getClassName(){return"SubSurfaceScatteringPostProcess"}constructor(e,t,i,s=null,r,n,o,a=0){super(e,"subSurfaceScattering",["texelSize","viewportSize","metersPerUnit"],["diffusionS","diffusionD","filterRadii","irradianceSampler","depthSampler","albedoSampler"],i,s,r||Ar.BILINEAR_SAMPLINGMODE,n,o,null,a,"postprocess",void 0,!0),this._scene=t,this.updateEffect(),this.onApplyObservable.add((e=>{if(!t.prePassRenderer||!t.subSurfaceConfiguration)return void k.Error("PrePass and subsurface configuration needs to be enabled for subsurface scattering.");const i=this.texelSize;e.setFloat("metersPerUnit",t.subSurfaceConfiguration.metersPerUnit),e.setFloat2("texelSize",i.x,i.y),e.setTexture("irradianceSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(0)]),e.setTexture("depthSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(5)]),e.setTexture("albedoSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(7)]),e.setFloat2("viewportSize",Math.tan(t.activeCamera.fov/2)*t.getEngine().getAspectRatio(t.activeCamera,!0),Math.tan(t.activeCamera.fov/2)),e.setArray3("diffusionS",t.subSurfaceConfiguration.ssDiffusionS),e.setArray("diffusionD",t.subSurfaceConfiguration.ssDiffusionD),e.setArray("filterRadii",t.subSurfaceConfiguration.ssFilterRadii)}))}}class zv{get ssDiffusionS(){return this._ssDiffusionS}get ssDiffusionD(){return this._ssDiffusionD}get ssFilterRadii(){return this._ssFilterRadii}constructor(e){this._ssDiffusionS=[],this._ssFilterRadii=[],this._ssDiffusionD=[],this.enabled=!1,this.needsImageProcessing=!0,this.name=fi.NAME_SUBSURFACE,this.ssDiffusionProfileColors=[],this.metersPerUnit=1,this.texturesRequired=[5,7,4,0],this.addDiffusionProfile(new N(1,1,1)),this._scene=e,zv._SceneComponentInitialization(this._scene)}addDiffusionProfile(e){if(this.ssDiffusionD.length>=5)return k.Error("You already reached the maximum number of diffusion profiles."),0;for(let t=0;t<this._ssDiffusionS.length/3;t++)if(this._ssDiffusionS[3*t]===e.r&&this._ssDiffusionS[3*t+1]===e.g&&this._ssDiffusionS[3*t+2]===e.b)return t;return this._ssDiffusionS.push(e.r,e.b,e.g),this._ssDiffusionD.push(Math.max(Math.max(e.r,e.b),e.g)),this._ssFilterRadii.push(this.getDiffusionProfileParameters(e)),this.ssDiffusionProfileColors.push(e),this._ssDiffusionD.length-1}createPostProcess(){return this.postProcess=new Gv("subSurfaceScattering",this._scene,1,null,void 0,this._scene.getEngine()),this.postProcess.autoClear=!1,this.postProcess}clearAllDiffusionProfiles(){this._ssDiffusionD=[],this._ssDiffusionS=[],this._ssFilterRadii=[],this.ssDiffusionProfileColors=[]}dispose(){this.clearAllDiffusionProfiles(),this.postProcess&&this.postProcess.dispose()}getDiffusionProfileParameters(e){const t=Math.max(e.r,e.g,e.b);return this._sampleBurleyDiffusionProfile(.997,t)}_sampleBurleyDiffusionProfile(e,t){const i=1+4*(e=1-e)*(2*e+Math.sqrt(1+4*e*e)),s=Math.pow(i,-1/3),r=1+i*s*s+s;return 3*Math.log(r/(4*e))*t}}zv._SceneComponentInitialization=e=>{throw $("SubSurfaceSceneComponent")},s.AddParser(fi.NAME_SUBSURFACE,((e,t)=>{if(void 0!==e.ssDiffusionProfileColors&&null!==e.ssDiffusionProfileColors&&(t.enableSubSurfaceForPrePass(),t.subSurfaceConfiguration))for(let i=0,s=e.ssDiffusionProfileColors.length;i<s;i++){const s=e.ssDiffusionProfileColors[i];t.subSurfaceConfiguration.addDiffusionProfile(new N(s.r,s.g,s.b))}})),Object.defineProperty(Yi.prototype,"subSurfaceConfiguration",{get:function(){return this._subSurfaceConfiguration},set:function(e){e&&this.enablePrePassRenderer()&&(this._subSurfaceConfiguration=e)},enumerable:!0,configurable:!0}),Yi.prototype.enableSubSurfaceForPrePass=function(){if(this._subSurfaceConfiguration)return this._subSurfaceConfiguration;const e=this.enablePrePassRenderer();return e?(this._subSurfaceConfiguration=new zv(this),e.addEffectConfiguration(this._subSurfaceConfiguration),this._subSurfaceConfiguration):null},Yi.prototype.disableSubSurfaceForPrePass=function(){this._subSurfaceConfiguration&&(this._subSurfaceConfiguration.dispose(),this._subSurfaceConfiguration=null)};class Wv{constructor(e){this.name=fi.NAME_PREPASSRENDERER,this.scene=e}register(){}serialize(e){if(!this.scene.subSurfaceConfiguration)return;const t=this.scene.subSurfaceConfiguration.ssDiffusionProfileColors;e.ssDiffusionProfileColors=[];for(let i=0;i<t.length;i++)e.ssDiffusionProfileColors.push({r:t[i].r,g:t[i].g,b:t[i].b})}addFromContainer(){}removeFromContainer(){this.scene.prePassRenderer&&this.scene.subSurfaceConfiguration&&this.scene.subSurfaceConfiguration.clearAllDiffusionProfiles()}rebuild(){}dispose(){}}zv._SceneComponentInitialization=e=>{let t=e._getComponent(fi.NAME_SUBSURFACE);t||(t=new Wv(e),e._addComponent(t))};nt.ShadersStore.outlinePixelShader="#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nuniform vec4 color;\n#ifdef ALPHATEST\nvarying vec2 vUV;uniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#include<logDepthFragment>\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";nt.ShadersStore.outlineVertexShader="attribute vec3 position;attribute vec3 normal;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\nuniform float offset;\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\n#ifdef ALPHATEST\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;vec3 normalUpdated=normal;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\nvec3 offsetPosition=positionUpdated+(normalUpdated*offset);\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(offsetPosition,1.0);gl_Position=viewProjection*worldPos;\n#ifdef ALPHATEST\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#include<clipPlaneVertex>\n#include<logDepthVertex>\n}\n",Yi.prototype.getOutlineRenderer=function(){return this._outlineRenderer||(this._outlineRenderer=new Hv(this)),this._outlineRenderer},Object.defineProperty(ur.prototype,"renderOutline",{get:function(){return this._renderOutline},set:function(e){e&&this.getScene().getOutlineRenderer(),this._renderOutline=e},enumerable:!0,configurable:!0}),Object.defineProperty(ur.prototype,"renderOverlay",{get:function(){return this._renderOverlay},set:function(e){e&&this.getScene().getOutlineRenderer(),this._renderOverlay=e},enumerable:!0,configurable:!0});class Hv{constructor(e){this.name=fi.NAME_OUTLINERENDERER,this.zOffset=1,this.zOffsetUnits=4,this.scene=e,this._engine=e.getEngine(),this.scene._addComponent(this),this._passIdForDrawWrapper=[];for(let e=0;e<4;++e)this._passIdForDrawWrapper[e]=this._engine.createRenderPassId(`Outline Renderer (${e})`)}register(){this.scene._beforeRenderingMeshStage.registerStep(fi.STEP_BEFORERENDERINGMESH_OUTLINE,this,this._beforeRenderingMesh),this.scene._afterRenderingMeshStage.registerStep(fi.STEP_AFTERRENDERINGMESH_OUTLINE,this,this._afterRenderingMesh)}rebuild(){}dispose(){for(let e=0;e<this._passIdForDrawWrapper.length;++e)this._engine.releaseRenderPassId(this._passIdForDrawWrapper[e])}render(e,t,i=!1,s){s=null!=s?s:this._passIdForDrawWrapper[0];const r=this.scene,n=r.getEngine(),o=n.getCaps().instancedArrays&&(null!==t.visibleInstances[e._id]&&void 0!==t.visibleInstances[e._id]||e.getRenderingMesh().hasThinInstances);if(!this.isReady(e,o,s))return;const a=e.getMesh(),l=a._internalAbstractMeshDataInfo._actAsRegularMesh?a:null,h=e.getRenderingMesh(),c=l||h,u=e.getMaterial();if(!u||!r.activeCamera)return;const d=e._getDrawWrapper(s),p=Tt.GetEffect(d);if(n.enableEffect(d),u.useLogarithmicDepth&&p.setFloat("logarithmicDepthConstant",2/(Math.log(r.activeCamera.maxZ+1)/Math.LN2)),p.setFloat("offset",i?0:h.outlineWidth),p.setColor4("color",i?h.overlayColor:h.outlineColor,i?h.overlayAlpha:u.alpha),p.setMatrix("viewProjection",r.getTransformMatrix()),p.setMatrix("world",c.getWorldMatrix()),h.useBones&&h.computeBonesUsingShaders&&h.skeleton&&p.setMatrices("mBones",h.skeleton.getTransformMatrices(h)),h.morphTargetManager&&h.morphTargetManager.isUsingTextureForTargets&&h.morphTargetManager._bind(p),Hs.BindMorphTargetParameters(h,p),o||h._bind(e,p,u.fillMode),u&&u.needAlphaTesting()){const e=u.getAlphaTestTexture();e&&(p.setTexture("diffuseSampler",e),p.setMatrix("diffuseMatrix",e.getTextureMatrix()))}zs(p,u,r),n.setZOffset(-this.zOffset),n.setZOffsetUnits(-this.zOffsetUnits),h._processRendering(c,e,p,u.fillMode,t,o,((e,t)=>{p.setMatrix("world",t)})),n.setZOffset(0),n.setZOffsetUnits(0)}isReady(e,t,i){i=null!=i?i:this._passIdForDrawWrapper[0];const s=[],r=[hi.PositionKind,hi.NormalKind],n=e.getMesh(),o=e.getMaterial();if(!o)return!1;const a=n.getScene();o.needAlphaTesting()&&(s.push("#define ALPHATEST"),n.isVerticesDataPresent(hi.UVKind)&&(r.push(hi.UVKind),s.push("#define UV1")),n.isVerticesDataPresent(hi.UV2Kind)&&(r.push(hi.UV2Kind),s.push("#define UV2"))),o.useLogarithmicDepth&&s.push("#define LOGARITHMICDEPTH"),Gs(o,a,s),n.useBones&&n.computeBonesUsingShaders?(r.push(hi.MatricesIndicesKind),r.push(hi.MatricesWeightsKind),n.numBoneInfluencers>4&&(r.push(hi.MatricesIndicesExtraKind),r.push(hi.MatricesWeightsExtraKind)),s.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers),s.push("#define BonesPerMesh "+(n.skeleton?n.skeleton.bones.length+1:0))):s.push("#define NUM_BONE_INFLUENCERS 0");const l=n.morphTargetManager;let h=0;l&&l.numInfluencers>0&&(h=l.numInfluencers,s.push("#define MORPHTARGETS"),s.push("#define NUM_MORPH_INFLUENCERS "+h),l.isUsingTextureForTargets&&s.push("#define MORPHTARGETS_TEXTURE"),Hs.PrepareAttributesForMorphTargetsInfluencers(r,n,h)),t&&(s.push("#define INSTANCES"),Hs.PushAttributesForInstances(r),e.getRenderingMesh().hasThinInstances&&s.push("#define THIN_INSTANCES"));const c=e._getDrawWrapper(i,!0),u=c.defines,d=s.join("\n");if(u!==d){const e=["world","mBones","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"];ks(e),c.setEffect(this.scene.getEngine().createEffect("outline",r,e,["diffuseSampler","morphTargets"],d,void 0,void 0,void 0,{maxSimultaneousMorphTargets:h}),d)}return c.effect.isReady()}_beforeRenderingMesh(e,t,i){if(this._savedDepthWrite=this._engine.getDepthWrite(),e.renderOutline){const s=t.getMaterial();s&&s.needAlphaBlendingForMesh(e)&&(this._engine.cacheStencilState(),this._engine.setDepthWrite(!1),this._engine.setColorWrite(!1),this._engine.setStencilBuffer(!0),this._engine.setStencilOperationPass(7681),this._engine.setStencilFunction(519),this._engine.setStencilMask(Hv._StencilReference),this._engine.setStencilFunctionReference(Hv._StencilReference),this._engine.stencilStateComposer.useStencilGlobalOnly=!0,this.render(t,i,!0,this._passIdForDrawWrapper[1]),this._engine.setColorWrite(!0),this._engine.setStencilFunction(517)),this._engine.setDepthWrite(!1),this.render(t,i,!1,this._passIdForDrawWrapper[0]),this._engine.setDepthWrite(this._savedDepthWrite),s&&s.needAlphaBlendingForMesh(e)&&(this._engine.stencilStateComposer.useStencilGlobalOnly=!1,this._engine.restoreStencilState())}}_afterRenderingMesh(e,t,i){if(e.renderOverlay){const e=this._engine.getAlphaMode(),s=this._engine.alphaState.alphaBlend;this._engine.setAlphaMode(2),this.render(t,i,!0,this._passIdForDrawWrapper[3]),this._engine.setAlphaMode(e),this._engine.setDepthWrite(this._savedDepthWrite),this._engine.alphaState.alphaBlend=s}e.renderOutline&&this._savedDepthWrite&&(this._engine.setDepthWrite(!0),this._engine.setColorWrite(!1),this.render(t,i,!1,this._passIdForDrawWrapper[2]),this._engine.setColorWrite(!0))}}Hv._StencilReference=4;class Xv{get particleSize(){return this._particleSize}set particleSize(e){e!==this._particleSize&&(this._particleSize=e,this.onParticleSizeChanged.notifyObservers(this))}get useInstancing(){return!this.indexBuffer}get useVelocity(){return this._useVelocity}set useVelocity(e){this._useVelocity!==e&&this._hasVelocity()&&(this._useVelocity=e,this._effectsAreDirty=!0)}_hasVelocity(){var e;return!!(null===(e=this.vertexBuffers)||void 0===e?void 0:e.velocity)}get indexBuffer(){return null}getClassName(){return"FluidRenderingObject"}constructor(e){this.priority=0,this._particleSize=.1,this.onParticleSizeChanged=new a,this.particleThicknessAlpha=.05,this._useVelocity=!1,this._scene=e,this._engine=e.getEngine(),this._effectsAreDirty=!0,this._depthEffectWrapper=null,this._thicknessEffectWrapper=null}_createEffects(){const e=["view","projection","particleRadius","size"],t=["position","offset"],i=[];this._effectsAreDirty=!1,this.useVelocity&&(t.push("velocity"),i.push("#define FLUIDRENDERING_VELOCITY")),this._scene.useRightHandedSystem&&i.push("#define FLUIDRENDERING_RHS"),this._depthEffectWrapper=new On({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleDepth",fragmentShader:"fluidRenderingParticleDepth",attributeNames:t,uniformNames:e,samplerNames:[],defines:i}),e.push("particleAlpha"),this._thicknessEffectWrapper=new On({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleThickness",fragmentShader:"fluidRenderingParticleThickness",attributeNames:["position","offset"],uniformNames:e,samplerNames:[]})}isReady(){if(this._effectsAreDirty&&this._createEffects(),!this._depthEffectWrapper||!this._thicknessEffectWrapper)return!1;const e=this._depthEffectWrapper._drawWrapper.effect,t=this._thicknessEffectWrapper._drawWrapper.effect;return e.isReady()&&t.isReady()}renderDepthTexture(){const e=this.numParticles;if(!this._depthEffectWrapper||0===e)return;const t=this._depthEffectWrapper._drawWrapper,i=t.effect;this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),i.setFloat2("size",this._particleSize,this._particleSize),i.setFloat("particleRadius",this._particleSize/2),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e)}renderThicknessTexture(){const e=this.numParticles;if(!this._thicknessEffectWrapper||0===e)return;const t=this._thicknessEffectWrapper._drawWrapper,i=t.effect;this._engine.setAlphaMode(6),this._engine.setDepthWrite(!1),this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),i.setFloat("particleAlpha",this.particleThicknessAlpha),i.setFloat2("size",this._particleSize,this._particleSize),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e),this._engine.setDepthWrite(!0),this._engine.setAlphaMode(0)}renderDiffuseTexture(){}dispose(){var e,t;null===(e=this._depthEffectWrapper)||void 0===e||e.dispose(),null===(t=this._thicknessEffectWrapper)||void 0===t||t.dispose()}}class Yv extends Xv{get particleSystem(){return this._particleSystem}getClassName(){return"FluidRenderingObjectParticleSystem"}get useTrueRenderingForDiffuseTexture(){return this._useTrueRenderingForDiffuseTexture}set useTrueRenderingForDiffuseTexture(e){this._useTrueRenderingForDiffuseTexture!==e&&(this._useTrueRenderingForDiffuseTexture=e,e?(this._particleSystem.blendMode=this._blendMode,this._particleSystem.onBeforeDrawParticlesObservable.remove(this._onBeforeDrawParticleObserver),this._onBeforeDrawParticleObserver=null):(this._particleSystem.blendMode=-1,this._onBeforeDrawParticleObserver=this._particleSystem.onBeforeDrawParticlesObservable.add((()=>{this._engine.setAlphaMode(2)}))))}get vertexBuffers(){return this._particleSystem.vertexBuffers}get indexBuffer(){return this._particleSystem.indexBuffer}constructor(e,t){super(e),this._useTrueRenderingForDiffuseTexture=!0,this._particleSystem=t,this._originalRender=t.render.bind(t),this._blendMode=t.blendMode,this._onBeforeDrawParticleObserver=null,this._updateInAnimate=this._particleSystem.updateInAnimate,this._particleSystem.updateInAnimate=!0,this._particleSystem.render=()=>0,this.particleSize=(t.minSize+t.maxSize)/2,this.useTrueRenderingForDiffuseTexture=!1}isReady(){return super.isReady()&&this._particleSystem.isReady()}get numParticles(){return this._particleSystem.getActiveCount()}renderDiffuseTexture(){this._originalRender()}dispose(){super.dispose(),this._particleSystem.onBeforeDrawParticlesObservable.remove(this._onBeforeDrawParticleObserver),this._onBeforeDrawParticleObserver=null,this._particleSystem.render=this._originalRender,this._particleSystem.blendMode=this._blendMode,this._particleSystem.updateInAnimate=this._updateInAnimate}}class jv{get blurNumIterations(){return this._blurNumIterations}set blurNumIterations(e){if(this._blurNumIterations!==e&&(this._blurNumIterations=e,null!==this._blurPostProcesses)){const e=this._blurPostProcesses[0],t=this._blurPostProcesses[1];this._blurPostProcesses=[];for(let i=0;i<2*this._blurNumIterations;++i)this._blurPostProcesses[i]=1&i?t:e}}get renderTarget(){return this._rt}get renderTargetBlur(){return this._rtBlur}get texture(){return this._texture}get textureBlur(){return this._textureBlurred}constructor(e,t,i,s,r,n,o=1,l=6,h=1,c=6,u=!1,d=null,p=!0,_=1){this.enableBlur=!0,this.blurSizeDivisor=1,this.blurFilterSize=7,this._blurNumIterations=3,this.blurMaxFilterSize=100,this.blurDepthScale=10,this.particleSize=.02,this.onDisposeObservable=new a,this._name=e,this._scene=t,this._camera=d,this._engine=t.getEngine(),this._width=i,this._height=s,this._blurTextureSizeX=r,this._blurTextureSizeY=n,this._textureType=o,this._textureFormat=l,this._blurTextureType=h,this._blurTextureFormat=c,this._useStandardBlur=u,this._generateDepthBuffer=p,this._samples=_,this._postProcessRunningIndex=0,this.enableBlur=0!==r&&0!==n,this._rt=null,this._texture=null,this._rtBlur=null,this._textureBlurred=null,this._blurPostProcesses=null}initialize(){if(this.dispose(),this._createRenderTarget(),this.enableBlur&&this._texture){const[e,t,i]=this._createBlurPostProcesses(this._texture,this._blurTextureType,this._blurTextureFormat,this.blurSizeDivisor,this._name,this._useStandardBlur);this._rtBlur=e,this._textureBlurred=t,this._blurPostProcesses=i}}applyBlurPostProcesses(){this.enableBlur&&this._blurPostProcesses&&(this._postProcessRunningIndex=0,this._scene.postProcessManager.directRender(this._blurPostProcesses,this._rtBlur,!0),this._engine.unBindFramebuffer(this._rtBlur))}_createRenderTarget(){this._rt=this._engine.createRenderTargetTexture({width:this._width,height:this._height},{generateMipMaps:!1,type:this._textureType,format:this._textureFormat,samplingMode:1,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:!1,samples:this._samples,label:`FluidRenderingRTT-${this._name}`});const e=this._rt.texture;e.incrementReferences(),this._texture=new Ar(null,this._scene),this._texture.name="rtt"+this._name,this._texture._texture=e,this._texture.wrapU=Ar.CLAMP_ADDRESSMODE,this._texture.wrapV=Ar.CLAMP_ADDRESSMODE,this._texture.anisotropicFilteringLevel=1}_createBlurPostProcesses(e,t,i,s,r,n=!1){const o=this._scene.getEngine(),a=new E(Math.floor(this._blurTextureSizeX/s),Math.floor(this._blurTextureSizeY/s)),l=1===t&&o.getCaps().textureFloatLinearFiltering||2===t&&o.getCaps().textureHalfFloatLinearFiltering,h=this._engine.createRenderTargetTexture({width:a.x,height:a.y},{generateMipMaps:!1,type:t,format:i,samplingMode:l?2:1,generateDepthBuffer:!1,generateStencilBuffer:!1,samples:this._samples,label:`FluidRenderingRTTBlur-${r}`}),c=h.texture;c.incrementReferences();const u=new Ar(null,this._scene);if(u.name="rttBlurred"+r,u._texture=c,u.wrapU=Ar.CLAMP_ADDRESSMODE,u.wrapV=Ar.CLAMP_ADDRESSMODE,u.anisotropicFilteringLevel=1,n){const s=new dn("BilateralBlurX","fluidRenderingStandardBlur",["filterSize","blurDir"],null,1,null,1,o,!0,null,t,void 0,void 0,void 0,i);s.samples=this._samples,s.externalTextureSamplerBinding=!0,s.onApplyObservable.add((t=>{0===this._postProcessRunningIndex?t.setTexture("textureSampler",e):t._bindTexture("textureSampler",s.inputTexture.texture),t.setInt("filterSize",this.blurFilterSize),t.setFloat2("blurDir",1/this._blurTextureSizeX,0),this._postProcessRunningIndex++})),s.onSizeChangedObservable.add((()=>{s._textures.forEach((e=>{e.texture.wrapU=Ar.CLAMP_ADDRESSMODE,e.texture.wrapV=Ar.CLAMP_ADDRESSMODE}))})),this._fixReusablePostProcess(s);const r=new dn("BilateralBlurY","fluidRenderingStandardBlur",["filterSize","blurDir"],null,1,null,1,o,!0,null,t,void 0,void 0,void 0,i);r.samples=this._samples,r.onApplyObservable.add((e=>{e.setInt("filterSize",this.blurFilterSize),e.setFloat2("blurDir",0,1/this._blurTextureSizeY),this._postProcessRunningIndex++})),r.onSizeChangedObservable.add((()=>{r._textures.forEach((e=>{e.texture.wrapU=Ar.CLAMP_ADDRESSMODE,e.texture.wrapV=Ar.CLAMP_ADDRESSMODE}))})),this._fixReusablePostProcess(r),s.autoClear=!1,r.autoClear=!1;const n=[];for(let e=0;e<2*this._blurNumIterations;++e)n[e]=1&e?r:s;return[h,u,n]}{const s=["maxFilterSize","blurDir","projectedParticleConstant","depthThreshold"],r=new dn("BilateralBlurX","fluidRenderingBilateralBlur",s,null,1,null,1,o,!0,null,t,void 0,void 0,void 0,i);r.samples=this._samples,r.externalTextureSamplerBinding=!0,r.onApplyObservable.add((t=>{0===this._postProcessRunningIndex?t.setTexture("textureSampler",e):t._bindTexture("textureSampler",r.inputTexture.texture),t.setInt("maxFilterSize",this.blurMaxFilterSize),t.setFloat2("blurDir",1/this._blurTextureSizeX,0),t.setFloat("projectedParticleConstant",this._getProjectedParticleConstant()),t.setFloat("depthThreshold",this._getDepthThreshold()),this._postProcessRunningIndex++})),r.onSizeChangedObservable.add((()=>{r._textures.forEach((e=>{e.texture.wrapU=Ar.CLAMP_ADDRESSMODE,e.texture.wrapV=Ar.CLAMP_ADDRESSMODE}))})),this._fixReusablePostProcess(r);const n=new dn("BilateralBlurY","fluidRenderingBilateralBlur",s,null,1,null,1,o,!0,null,t,void 0,void 0,void 0,i);n.samples=this._samples,n.onApplyObservable.add((e=>{e.setInt("maxFilterSize",this.blurMaxFilterSize),e.setFloat2("blurDir",0,1/this._blurTextureSizeY),e.setFloat("projectedParticleConstant",this._getProjectedParticleConstant()),e.setFloat("depthThreshold",this._getDepthThreshold()),this._postProcessRunningIndex++})),n.onSizeChangedObservable.add((()=>{n._textures.forEach((e=>{e.texture.wrapU=Ar.CLAMP_ADDRESSMODE,e.texture.wrapV=Ar.CLAMP_ADDRESSMODE}))})),this._fixReusablePostProcess(n),r.autoClear=!1,n.autoClear=!1;const a=[];for(let e=0;e<2*this._blurNumIterations;++e)a[e]=1&e?n:r;return[h,u,a]}}_fixReusablePostProcess(e){e.isReusable()&&(e.onActivateObservable.add((()=>{e._currentRenderTextureInd=(e._currentRenderTextureInd+1)%2})),e.onApplyObservable.add((()=>{e._currentRenderTextureInd=(e._currentRenderTextureInd+1)%2})))}_getProjectedParticleConstant(){var e,t;return this.blurFilterSize*this.particleSize*.05*(this._height/2)/Math.tan((null!==(t=null===(e=this._camera)||void 0===e?void 0:e.fov)&&void 0!==t?t:45*Math.PI/180)/2)}_getDepthThreshold(){return this.particleSize/2*this.blurDepthScale}dispose(){var e,t,i,s;this.onDisposeObservable.hasObservers()&&this.onDisposeObservable.notifyObservers(this),null===(e=this._rt)||void 0===e||e.dispose(),this._rt=null,null===(t=this._texture)||void 0===t||t.dispose(),this._texture=null,null===(i=this._rtBlur)||void 0===i||i.dispose(),this._rtBlur=null,null===(s=this._textureBlurred)||void 0===s||s.dispose(),this._textureBlurred=null,this._blurPostProcesses&&(this._blurPostProcesses[0].dispose(),this._blurPostProcesses[1].dispose()),this._blurPostProcesses=null}}var Kv;!function(e){e[e.DepthTexture=0]="DepthTexture",e[e.DepthBlurredTexture=1]="DepthBlurredTexture",e[e.ThicknessTexture=2]="ThicknessTexture",e[e.ThicknessBlurredTexture=3]="ThicknessBlurredTexture",e[e.DiffuseTexture=4]="DiffuseTexture",e[e.Normals=5]="Normals",e[e.DiffuseRendering=6]="DiffuseRendering"}(Kv||(Kv={}));class $v{get needInitialization(){return this._needInitialization}get generateDiffuseTexture(){return this._generateDiffuseTexture}set generateDiffuseTexture(e){this._generateDiffuseTexture!==e&&(this._generateDiffuseTexture=e,this._needInitialization=!0)}get debugFeature(){return this._debugFeature}set debugFeature(e){this._debugFeature!==e&&(this._needInitialization=!0,this._debugFeature=e)}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._needInitialization=!0)}get environmentMap(){return this._environmentMap}set environmentMap(e){this._environmentMap!==e&&(this._needInitialization=!0,this._environmentMap=e)}get enableBlurDepth(){return this._enableBlurDepth}set enableBlurDepth(e){this._enableBlurDepth!==e&&(this._enableBlurDepth=e,this._needInitialization=!0)}get blurDepthSizeDivisor(){return this._blurDepthSizeDivisor}set blurDepthSizeDivisor(e){this._blurDepthSizeDivisor!==e&&(this._blurDepthSizeDivisor=e,this._needInitialization=!0)}get blurDepthFilterSize(){return this._blurDepthFilterSize}set blurDepthFilterSize(e){this._blurDepthFilterSize!==e&&(this._blurDepthFilterSize=e,this._setBlurParameters())}get blurDepthNumIterations(){return this._blurDepthNumIterations}set blurDepthNumIterations(e){this._blurDepthNumIterations!==e&&(this._blurDepthNumIterations=e,this._setBlurParameters())}get blurDepthMaxFilterSize(){return this._blurDepthMaxFilterSize}set blurDepthMaxFilterSize(e){this._blurDepthMaxFilterSize!==e&&(this._blurDepthMaxFilterSize=e,this._setBlurParameters())}get blurDepthDepthScale(){return this._blurDepthDepthScale}set blurDepthDepthScale(e){this._blurDepthDepthScale!==e&&(this._blurDepthDepthScale=e,this._setBlurParameters())}get enableBlurThickness(){return this._enableBlurThickness}set enableBlurThickness(e){this._enableBlurThickness!==e&&(this._enableBlurThickness=e,this._needInitialization=!0)}get blurThicknessSizeDivisor(){return this._blurThicknessSizeDivisor}set blurThicknessSizeDivisor(e){this._blurThicknessSizeDivisor!==e&&(this._blurThicknessSizeDivisor=e,this._needInitialization=!0)}get blurThicknessFilterSize(){return this._blurThicknessFilterSize}set blurThicknessFilterSize(e){this._blurThicknessFilterSize!==e&&(this._blurThicknessFilterSize=e,this._setBlurParameters())}get blurThicknessNumIterations(){return this._blurThicknessNumIterations}set blurThicknessNumIterations(e){this._blurThicknessNumIterations!==e&&(this._blurThicknessNumIterations=e,this._setBlurParameters())}get useFixedThickness(){return this._useFixedThickness}set useFixedThickness(e){this._useFixedThickness!==e&&(this._useFixedThickness=e,this._needInitialization=!0)}get useVelocity(){return this._useVelocity}set useVelocity(e){this._useVelocity!==e&&(this._useVelocity=e,this._needInitialization=!0,this._onUseVelocityChanged.notifyObservers(this))}get depthMapSize(){return this._depthMapSize}set depthMapSize(e){this._depthMapSize!==e&&(this._depthMapSize=e,this._needInitialization=!0)}get thicknessMapSize(){return this._thicknessMapSize}set thicknessMapSize(e){this._thicknessMapSize!==e&&(this._thicknessMapSize=e,this._needInitialization=!0)}get diffuseMapSize(){return this._diffuseMapSize}set diffuseMapSize(e){this._diffuseMapSize!==e&&(this._diffuseMapSize=e,this._needInitialization=!0)}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._needInitialization=!0)}get camera(){return this._camera}constructor(e,t){this._generateDiffuseTexture=!1,this.fluidColor=new N(.085,.6375,.765),this.density=2,this.refractionStrength=.1,this.fresnelClamp=1,this.specularPower=250,this.minimumThickness=0,this.dirLight=new S(-2,-1,1).normalize(),this._debugFeature=Kv.DepthBlurredTexture,this._debug=!1,this._enableBlurDepth=!0,this._blurDepthSizeDivisor=1,this._blurDepthFilterSize=7,this._blurDepthNumIterations=3,this._blurDepthMaxFilterSize=100,this._blurDepthDepthScale=10,this._enableBlurThickness=!0,this._blurThicknessSizeDivisor=1,this._blurThicknessFilterSize=5,this._blurThicknessNumIterations=1,this._useFixedThickness=!1,this._onUseVelocityChanged=new a,this._useVelocity=!1,this._depthMapSize=null,this._thicknessMapSize=null,this._diffuseMapSize=null,this._samples=1,this._scene=e,this._engine=e.getEngine(),this._camera=null!=t?t:e.activeCamera,this._needInitialization=!0,this._bgDepthTexture=null,this._invProjectionMatrix=new y,this._depthClearColor=new F(1e6,1e6,1e6,1),this._thicknessClearColor=new F(0,0,0,1),this._depthRenderTarget=null,this._diffuseRenderTarget=null,this._thicknessRenderTarget=null,this._renderPostProcess=null}_initialize(){var e,t,i;this.dispose(),this._needInitialization=!1;const s=null!==(e=this._depthMapSize)&&void 0!==e?e:this._engine.getRenderWidth(),r=null!==this._depthMapSize?Math.round(this._depthMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();if(this._depthRenderTarget=new jv("Depth",this._scene,s,r,s,r,1,7,1,7,!1,this._camera,!0,this._samples),this._initializeRenderTarget(this._depthRenderTarget),this.generateDiffuseTexture){const e=null!==(t=this._diffuseMapSize)&&void 0!==t?t:this._engine.getRenderWidth(),i=null!==this._diffuseMapSize?Math.round(this._diffuseMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();this._diffuseRenderTarget=new jv("Diffuse",this._scene,e,i,0,0,0,5,0,5,!0,this._camera,!0,this._samples),this._initializeRenderTarget(this._diffuseRenderTarget)}const n=null!==(i=this._thicknessMapSize)&&void 0!==i?i:this._engine.getRenderWidth(),o=null!==this._thicknessMapSize?Math.round(this._thicknessMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();this._useFixedThickness||(this._thicknessRenderTarget=new jv("Thickness",this._scene,n,o,n,o,2,6,2,6,!0,this._camera,!1,this._samples),this._initializeRenderTarget(this._thicknessRenderTarget)),this._createLiquidRenderingPostProcess()}_setBlurParameters(e=null){null!==e&&e!==this._depthRenderTarget||this._setBlurDepthParameters(),null!==e&&e!==this._thicknessRenderTarget||this._setBlurThicknessParameters()}_setBlurDepthParameters(){this._depthRenderTarget&&(this._depthRenderTarget.blurFilterSize=this.blurDepthFilterSize,this._depthRenderTarget.blurMaxFilterSize=this.blurDepthMaxFilterSize,this._depthRenderTarget.blurNumIterations=this.blurDepthNumIterations,this._depthRenderTarget.blurDepthScale=this.blurDepthDepthScale)}_setBlurThicknessParameters(){this._thicknessRenderTarget&&(this._thicknessRenderTarget.blurFilterSize=this.blurThicknessFilterSize,this._thicknessRenderTarget.blurNumIterations=this.blurThicknessNumIterations)}_initializeRenderTarget(e){e!==this._diffuseRenderTarget&&(e.enableBlur=e===this._depthRenderTarget?this.enableBlurDepth:this.enableBlurThickness,e.blurSizeDivisor=e===this._depthRenderTarget?this.blurDepthSizeDivisor:this.blurThicknessSizeDivisor),this._setBlurParameters(e),e.initialize()}_createLiquidRenderingPostProcess(){var e;const t=this._scene.getEngine(),i=["viewMatrix","projectionMatrix","invProjectionMatrix","texelSize","dirLight","cameraFar","density","refractionStrength","fresnelClamp","specularPower"],s=["depthSampler"],r=[];if(this.dispose(!0),!this._camera)return;const n=this._depthRenderTarget.enableBlur?this._depthRenderTarget.textureBlur:this._depthRenderTarget.texture,o=new E(1/n.getSize().width,1/n.getSize().height);this._scene.useRightHandedSystem&&r.push("#define FLUIDRENDERING_RHS"),null!==this._environmentMap&&(null!==(e=this._environmentMap)&&void 0!==e?e:this._scene.environmentTexture)&&(s.push("reflectionSampler"),r.push("#define FLUIDRENDERING_ENVIRONMENT")),this._diffuseRenderTarget?(s.push("diffuseSampler"),r.push("#define FLUIDRENDERING_DIFFUSETEXTURE")):i.push("diffuseColor"),this._useVelocity&&(s.push("velocitySampler"),r.push("#define FLUIDRENDERING_VELOCITY")),this._useFixedThickness?(i.push("thickness"),s.push("bgDepthSampler"),r.push("#define FLUIDRENDERING_FIXED_THICKNESS")):(i.push("minimumThickness"),s.push("thicknessSampler")),this._debug&&(r.push("#define FLUIDRENDERING_DEBUG"),this._debugFeature===Kv.Normals?r.push("#define FLUIDRENDERING_DEBUG_SHOWNORMAL"):this._debugFeature===Kv.DiffuseRendering?r.push("#define FLUIDRENDERING_DEBUG_DIFFUSERENDERING"):(r.push("#define FLUIDRENDERING_DEBUG_TEXTURE"),s.push("debugSampler"),this._debugFeature!==Kv.DepthTexture&&this._debugFeature!==Kv.DepthBlurredTexture||r.push("#define FLUIDRENDERING_DEBUG_DEPTH"))),this._renderPostProcess=new dn("FluidRendering","fluidRenderingRender",i,s,1,null,2,t,!1,null,0,void 0,void 0,!0,void 0),this._renderPostProcess.updateEffect(r.join("\n")),this._renderPostProcess.samples=this._samples,this._renderPostProcess.onApplyObservable.add((e=>{var i,s,r,n,a,l,h,c,u,d,p,_,f,m,g,v,x,T,E,S,b,C,y;if(this._invProjectionMatrix.copyFrom(this._scene.getProjectionMatrix()),this._invProjectionMatrix.invert(),t.isWebGPU&&e.setTextureSampler("textureSamplerSampler",this._renderPostProcess.inputTexture.texture),this._depthRenderTarget.enableBlur?(e.setTexture("depthSampler",this._depthRenderTarget.textureBlur),t.isWebGPU&&e.setTextureSampler("depthSamplerSampler",null!==(n=null===(r=this._depthRenderTarget.textureBlur)||void 0===r?void 0:r.getInternalTexture())&&void 0!==n?n:null)):(e.setTexture("depthSampler",this._depthRenderTarget.texture),t.isWebGPU&&e.setTextureSampler("depthSamplerSampler",null!==(s=null===(i=this._depthRenderTarget.texture)||void 0===i?void 0:i.getInternalTexture())&&void 0!==s?s:null)),this._diffuseRenderTarget?this._diffuseRenderTarget.enableBlur?(e.setTexture("diffuseSampler",this._diffuseRenderTarget.textureBlur),t.isWebGPU&&e.setTextureSampler("diffuseSamplerSampler",null!==(c=null===(h=this._diffuseRenderTarget.textureBlur)||void 0===h?void 0:h.getInternalTexture())&&void 0!==c?c:null)):(e.setTexture("diffuseSampler",this._diffuseRenderTarget.texture),t.isWebGPU&&e.setTextureSampler("diffuseSamplerSampler",null!==(l=null===(a=this._diffuseRenderTarget.texture)||void 0===a?void 0:a.getInternalTexture())&&void 0!==l?l:null)):e.setColor3("diffuseColor",this.fluidColor),this._useFixedThickness?(e.setFloat("thickness",this.minimumThickness),e._bindTexture("bgDepthSampler",this._bgDepthTexture),t.isWebGPU&&e.setTextureSampler("bgDepthSamplerSampler",null!==(u=this._bgDepthTexture)&&void 0!==u?u:null)):(this._thicknessRenderTarget.enableBlur?(e.setTexture("thicknessSampler",this._thicknessRenderTarget.textureBlur),t.isWebGPU&&e.setTextureSampler("thicknessSamplerSampler",null!==(f=null===(_=this._thicknessRenderTarget.textureBlur)||void 0===_?void 0:_.getInternalTexture())&&void 0!==f?f:null)):(e.setTexture("thicknessSampler",this._thicknessRenderTarget.texture),t.isWebGPU&&e.setTextureSampler("thicknessSamplerSampler",null!==(p=null===(d=this._thicknessRenderTarget.texture)||void 0===d?void 0:d.getInternalTexture())&&void 0!==p?p:null)),e.setFloat("minimumThickness",this.minimumThickness)),null!==this._environmentMap){const i=null!==(m=this._environmentMap)&&void 0!==m?m:this._scene.environmentTexture;i&&(e.setTexture("reflectionSampler",i),t.isWebGPU&&e.setTextureSampler("reflectionSamplerSampler",null!==(g=null==i?void 0:i.getInternalTexture())&&void 0!==g?g:null))}if(e.setMatrix("viewMatrix",this._scene.getViewMatrix()),e.setMatrix("invProjectionMatrix",this._invProjectionMatrix),e.setMatrix("projectionMatrix",this._scene.getProjectionMatrix()),e.setVector2("texelSize",o),e.setFloat("density",this.density),e.setFloat("refractionStrength",this.refractionStrength),e.setFloat("fresnelClamp",this.fresnelClamp),e.setFloat("specularPower",this.specularPower),e.setVector3("dirLight",this.dirLight),e.setFloat("cameraFar",this._camera.maxZ),this._debug){let i=null;switch(this._debugFeature){case Kv.DepthTexture:i=this._depthRenderTarget.texture;break;case Kv.DepthBlurredTexture:i=this._depthRenderTarget.enableBlur?this._depthRenderTarget.textureBlur:this._depthRenderTarget.texture;break;case Kv.ThicknessTexture:i=null!==(x=null===(v=this._thicknessRenderTarget)||void 0===v?void 0:v.texture)&&void 0!==x?x:null;break;case Kv.ThicknessBlurredTexture:i=(null===(T=this._thicknessRenderTarget)||void 0===T?void 0:T.enableBlur)?null!==(S=null===(E=this._thicknessRenderTarget)||void 0===E?void 0:E.textureBlur)&&void 0!==S?S:null:null!==(C=null===(b=this._thicknessRenderTarget)||void 0===b?void 0:b.texture)&&void 0!==C?C:null;break;case Kv.DiffuseTexture:this._diffuseRenderTarget&&(i=this._diffuseRenderTarget.texture)}this._debugFeature!==Kv.Normals&&(e.setTexture("debugSampler",i),t.isWebGPU&&e.setTextureSampler("debugSamplerSampler",null!==(y=null==i?void 0:i.getInternalTexture())&&void 0!==y?y:null))}}))}_clearTargets(){var e,t,i;(null===(e=this._depthRenderTarget)||void 0===e?void 0:e.renderTarget)&&(this._engine.bindFramebuffer(this._depthRenderTarget.renderTarget),this._engine.clear(this._depthClearColor,!0,!0,!1),this._engine.unBindFramebuffer(this._depthRenderTarget.renderTarget)),(null===(t=this._diffuseRenderTarget)||void 0===t?void 0:t.renderTarget)&&(this._engine.bindFramebuffer(this._diffuseRenderTarget.renderTarget),this._engine.clear(this._thicknessClearColor,!0,!0,!1),this._engine.unBindFramebuffer(this._diffuseRenderTarget.renderTarget)),(null===(i=this._thicknessRenderTarget)||void 0===i?void 0:i.renderTarget)&&(this._engine.bindFramebuffer(this._thicknessRenderTarget.renderTarget),this._engine.clear(this._thicknessClearColor,!0,!1,!1),this._engine.unBindFramebuffer(this._thicknessRenderTarget.renderTarget))}_render(e){var t,i,s,r,n,o;if(this._needInitialization||!e.isReady())return;const a=this._engine._currentRenderTarget;this._engine.setState(!1,void 0,void 0,void 0,!0),this._engine.setDepthBuffer(!0),this._engine.setDepthWrite(!0),this._engine.setAlphaMode(0),(null===(t=this._depthRenderTarget)||void 0===t?void 0:t.renderTarget)&&(this._engine.bindFramebuffer(this._depthRenderTarget.renderTarget),e.renderDepthTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._depthRenderTarget.renderTarget)),(null===(i=this._diffuseRenderTarget)||void 0===i?void 0:i.renderTarget)&&(this._engine.bindFramebuffer(this._diffuseRenderTarget.renderTarget),e.renderDiffuseTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._diffuseRenderTarget.renderTarget)),(null===(s=this._thicknessRenderTarget)||void 0===s?void 0:s.renderTarget)&&(this._engine.bindFramebuffer(this._thicknessRenderTarget.renderTarget),e.renderThicknessTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._thicknessRenderTarget.renderTarget)),null===(r=this._depthRenderTarget)||void 0===r||r.applyBlurPostProcesses(),null===(n=this._diffuseRenderTarget)||void 0===n||n.applyBlurPostProcesses(),null===(o=this._thicknessRenderTarget)||void 0===o||o.applyBlurPostProcesses(),a&&this._engine.bindFramebuffer(a)}dispose(e=!1){var t,i,s,r;e||(null===(t=this._depthRenderTarget)||void 0===t||t.dispose(),this._depthRenderTarget=null,null===(i=this._diffuseRenderTarget)||void 0===i||i.dispose(),this._diffuseRenderTarget=null,null===(s=this._thicknessRenderTarget)||void 0===s||s.dispose(),this._thicknessRenderTarget=null),this._renderPostProcess&&this._camera&&this._camera.detachPostProcess(this._renderPostProcess),null===(r=this._renderPostProcess)||void 0===r||r.dispose(),this._renderPostProcess=null,this._needInitialization=!1}}class qv extends Xv{getClassName(){return"FluidRenderingObjectCustomParticles"}get vertexBuffers(){return this._vertexBuffers}constructor(e,t,i){super(e),this._numParticles=i,this._diffuseEffectWrapper=null,this._vertexBuffers={},this.addBuffers(t)}addBuffers(e){for(const t in e){let i,s=!0;switch(t){case"velocity":i=3;break;case"offset":s=!1}this._vertexBuffers[t]=new hi(this._engine,e[t],t,!0,!1,i,s)}}_createEffects(){super._createEffects(),this._diffuseEffectWrapper=new On({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleDiffuse",fragmentShader:"fluidRenderingParticleDiffuse",attributeNames:["position","offset","color"],uniformNames:["view","projection","size"],samplerNames:[]})}isReady(){var e,t;return this._vertexBuffers.offset||(this._vertexBuffers.offset=new hi(this._engine,[0,0,1,0,0,1,1,1],"offset",!1,!1,2)),super.isReady()&&null!==(t=null===(e=this._diffuseEffectWrapper)||void 0===e?void 0:e.effect.isReady())&&void 0!==t&&t}get numParticles(){return this._numParticles}setNumParticles(e){this._numParticles=e}renderDiffuseTexture(){const e=this.numParticles;if(!this._diffuseEffectWrapper||0===e)return;const t=this._diffuseEffectWrapper._drawWrapper,i=t.effect;this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),null!==this._particleSize&&i.setFloat2("size",this._particleSize,this._particleSize),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e)}dispose(){var e;super.dispose(),null===(e=this._diffuseEffectWrapper)||void 0===e||e.dispose();for(const e in this._vertexBuffers)this._vertexBuffers[e].dispose();this._vertexBuffers={}}}var Qv;nt.ShadersStore.copyTextureToTexturePixelShader="uniform float conversion;uniform sampler2D textureSampler;varying vec2 vUV;\n#include<helperFunctions>\nvoid main(void) \n{vec4 color=texture2D(textureSampler,vUV);\n#ifdef DEPTH_TEXTURE\ngl_FragDepth=color.r;\n#else\nif (conversion==1.) {color=toLinearSpace(color);} else if (conversion==2.) {color=toGammaSpace(color);}\ngl_FragColor=color;\n#endif\n}\n",function(e){e[e.None=0]="None",e[e.ToLinearSpace=1]="ToLinearSpace",e[e.ToGammaSpace=2]="ToGammaSpace"}(Qv||(Qv={}));class Zv{_textureIsInternal(e){return void 0===e.getInternalTexture}constructor(e,t=!1){this._engine=e,this._isDepthTexture=t,this._renderer=new Mn(e),this._effectWrapper=new On({engine:e,name:"CopyTextureToTexture",fragmentShader:"copyTextureToTexture",useShaderStore:!0,uniformNames:["conversion"],samplerNames:["textureSampler"],defines:t?["#define DEPTH_TEXTURE"]:[]}),this._effectWrapper.onApplyObservable.add((()=>{t&&(e.setState(!1),e.setDepthBuffer(!0),e.depthCullingState.depthMask=!0,e.depthCullingState.depthFunc=519),this._textureIsInternal(this._source)?this._effectWrapper.effect._bindTexture("textureSampler",this._source):this._effectWrapper.effect.setTexture("textureSampler",this._source),this._effectWrapper.effect.setFloat("conversion",this._conversion)}))}isReady(){return this._effectWrapper.effect.isReady()}copy(e,t,i=Qv.None){if(!this.isReady())return!1;this._source=e,this._conversion=i;const s=this._engine.depthCullingState.depthFunc;return this._renderer.render(this._effectWrapper,t),this._isDepthTexture&&s&&(this._engine.depthCullingState.depthFunc=s),!0}dispose(){this._effectWrapper.dispose(),this._renderer.dispose()}}class Jv{get depthRTWrapper(){return this._depthRTWrapper}constructor(e,t,i,s=1){this._engine=e,this._copyTextureToTexture=new Zv(e,!0),this._depthRTWrapper=this._engine.createRenderTargetTexture({width:t,height:i},{generateMipMaps:!1,type:0,format:6,samplingMode:1,generateDepthBuffer:!0,generateStencilBuffer:!1,samples:s,noColorAttachment:!0,label:"FluidRenderingDepthTextureCopyRTT"}),this._depthRTWrapper.createDepthStencilTexture(0,!1,!1,1,void 0,"FluidRenderingDepthTextureCopyRTTDepthStencil").label=`FluidDepthTextureCopy${t}x${i}x${s}`}copy(e){return this._copyTextureToTexture.copy(e,this._depthRTWrapper)}dispose(){this._depthRTWrapper.dispose(),this._copyTextureToTexture.dispose()}}nt.ShadersStore.fluidRenderingParticleDepthVertexShader="attribute vec3 position;attribute vec2 offset;uniform mat4 view;uniform mat4 projection;uniform vec2 size;varying vec2 uv;varying vec3 viewPos;varying float sphereRadius;\n#ifdef FLUIDRENDERING_VELOCITY\nattribute vec3 velocity;varying float velocityNorm;\n#endif\nvoid main(void) {vec3 cornerPos;cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;cornerPos.z=0.0;viewPos=(view*vec4(position,1.0)).xyz;gl_Position=projection*vec4(viewPos+cornerPos,1.0);uv=offset;sphereRadius=size.x/2.0;\n#ifdef FLUIDRENDERING_VELOCITY\nvelocityNorm=length(velocity);\n#endif\n}\n";nt.ShadersStore.fluidRenderingParticleDepthPixelShader="uniform mat4 projection;varying vec2 uv;varying vec3 viewPos;varying float sphereRadius;\n#ifdef FLUIDRENDERING_VELOCITY\nvarying float velocityNorm;\n#endif\nvoid main(void) {vec3 normal;normal.xy=uv*2.0-1.0;float r2=dot(normal.xy,normal.xy);if (r2>1.0) discard;normal.z=sqrt(1.0-r2);\n#ifndef FLUIDRENDERING_RHS\nnormal.z=-normal.z;\n#endif\nvec4 realViewPos=vec4(viewPos+normal*sphereRadius,1.0);vec4 clipSpacePos=projection*realViewPos;\n#ifdef WEBGPU\ngl_FragDepth=clipSpacePos.z/clipSpacePos.w;\n#else\ngl_FragDepth=(clipSpacePos.z/clipSpacePos.w)*0.5+0.5;\n#endif\n#ifdef FLUIDRENDERING_RHS\nrealViewPos.z=-realViewPos.z;\n#endif\n#ifdef FLUIDRENDERING_VELOCITY\nglFragColor=vec4(realViewPos.z,velocityNorm,0.,1.);\n#else\nglFragColor=vec4(realViewPos.z,0.,0.,1.);\n#endif\n}\n";nt.ShadersStore.fluidRenderingParticleThicknessVertexShader="attribute vec3 position;attribute vec2 offset;uniform mat4 view;uniform mat4 projection;uniform vec2 size;varying vec2 uv;void main(void) {vec3 cornerPos;cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;cornerPos.z=0.0;vec3 viewPos=(view*vec4(position,1.0)).xyz+cornerPos;gl_Position=projection*vec4(viewPos,1.0);uv=offset;}\n";nt.ShadersStore.fluidRenderingParticleThicknessPixelShader="uniform float particleAlpha;varying vec2 uv;void main(void) {vec3 normal;normal.xy=uv*2.0-1.0;float r2=dot(normal.xy,normal.xy);if (r2>1.0) discard;float thickness=sqrt(1.0-r2);glFragColor=vec4(vec3(particleAlpha*thickness),1.0);}\n";nt.ShadersStore.fluidRenderingParticleDiffuseVertexShader="attribute vec3 position;attribute vec2 offset;attribute vec4 color;uniform mat4 view;uniform mat4 projection;uniform vec2 size;varying vec2 uv;varying vec3 diffuseColor;void main(void) {vec3 cornerPos;cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;cornerPos.z=0.0;vec3 viewPos=(view*vec4(position,1.0)).xyz+cornerPos;gl_Position=projection*vec4(viewPos,1.0);uv=offset;diffuseColor=color.rgb;}\n";nt.ShadersStore.fluidRenderingParticleDiffusePixelShader="uniform float particleAlpha;varying vec2 uv;varying vec3 diffuseColor;void main(void) {vec3 normal;normal.xy=uv*2.0-1.0;float r2=dot(normal.xy,normal.xy);if (r2>1.0) discard;glFragColor=vec4(diffuseColor,1.0);}\n";nt.ShadersStore.fluidRenderingBilateralBlurPixelShader="uniform sampler2D textureSampler;uniform int maxFilterSize;uniform vec2 blurDir;uniform float projectedParticleConstant;uniform float depthThreshold;varying vec2 vUV;void main(void) {float depth=textureLod(textureSampler,vUV,0.).x;if (depth>=1e6 || depth<=0.) {glFragColor=vec4(vec3(depth),1.);return;}\nint filterSize=min(maxFilterSize,int(ceil(projectedParticleConstant/depth)));float sigma=float(filterSize)/3.0;float two_sigma2=2.0*sigma*sigma;float sigmaDepth=depthThreshold/3.0;float two_sigmaDepth2=2.0*sigmaDepth*sigmaDepth;float sum=0.;float wsum=0.;float sumVel=0.;for (int x=-filterSize; x<=filterSize; ++x) {vec2 coords=vec2(x);vec2 sampleDepthVel=textureLod(textureSampler,vUV+coords*blurDir,0.).rg;float r=dot(coords,coords);float w=exp(-r/two_sigma2);float rDepth=sampleDepthVel.r-depth;float wd=exp(-rDepth*rDepth/two_sigmaDepth2);sum+=sampleDepthVel.r*w*wd;sumVel+=sampleDepthVel.g*w*wd;wsum+=w*wd;}\nglFragColor=vec4(sum/wsum,sumVel/wsum,0.,1.);}\n";nt.ShadersStore.fluidRenderingStandardBlurPixelShader="uniform sampler2D textureSampler;uniform int filterSize;uniform vec2 blurDir;varying vec2 vUV;void main(void) {vec4 s=textureLod(textureSampler,vUV,0.);if (s.r==0.) {glFragColor=vec4(0.,0.,0.,1.);return;}\nfloat sigma=float(filterSize)/3.0;float twoSigma2=2.0*sigma*sigma;vec4 sum=vec4(0.);float wsum=0.;for (int x=-filterSize; x<=filterSize; ++x) {vec2 coords=vec2(x);vec4 sampl=textureLod(textureSampler,vUV+coords*blurDir,0.);float w=exp(-coords.x*coords.x/twoSigma2);sum+=sampl*w;wsum+=w;}\nsum/=wsum;glFragColor=vec4(sum.rgb,1.);}\n";function ex(e){return!!e.particleSystem}nt.ShadersStore.fluidRenderingRenderPixelShader="/* disable_uniformity_analysis */\n#define IOR 1.333\n#define ETA 1.0/IOR\n#define F0 0.02\nuniform sampler2D textureSampler;uniform sampler2D depthSampler;\n#ifdef FLUIDRENDERING_DIFFUSETEXTURE\nuniform sampler2D diffuseSampler;\n#else\nuniform vec3 diffuseColor;\n#endif\n#ifdef FLUIDRENDERING_FIXED_THICKNESS\nuniform float thickness;uniform sampler2D bgDepthSampler;\n#else\nuniform float minimumThickness;uniform sampler2D thicknessSampler;\n#endif\n#ifdef FLUIDRENDERING_ENVIRONMENT\nuniform samplerCube reflectionSampler;\n#endif\n#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)\nuniform sampler2D debugSampler;\n#endif\nuniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform mat4 invProjectionMatrix;uniform vec2 texelSize;uniform vec3 dirLight;uniform float cameraFar;uniform float density;uniform float refractionStrength;uniform float fresnelClamp;uniform float specularPower;varying vec2 vUV;vec3 computeViewPosFromUVDepth(vec2 texCoord,float depth) {vec4 ndc;ndc.xy=texCoord*2.0-1.0;\n#ifdef FLUIDRENDERING_RHS\nndc.z=-projectionMatrix[2].z+projectionMatrix[3].z/depth;\n#else\nndc.z=projectionMatrix[2].z+projectionMatrix[3].z/depth;\n#endif\nndc.w=1.0;vec4 eyePos=invProjectionMatrix*ndc;eyePos.xyz/=eyePos.w;return eyePos.xyz;}\nvec3 getViewPosFromTexCoord(vec2 texCoord) {float depth=textureLod(depthSampler,texCoord,0.).x;return computeViewPosFromUVDepth(texCoord,depth);}\nvoid main(void) {vec2 texCoord=vUV;\n#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)\nvec4 color=texture2D(debugSampler,texCoord);\n#ifdef FLUIDRENDERING_DEBUG_DEPTH\nglFragColor=vec4(color.rgb/vec3(2.0),1.);if (color.r>0.999 && color.g>0.999) {glFragColor=texture2D(textureSampler,texCoord);}\n#else\nglFragColor=vec4(color.rgb,1.);if (color.r<0.001 && color.g<0.001 && color.b<0.001) {glFragColor=texture2D(textureSampler,texCoord);}\n#endif\nreturn;\n#endif\nvec2 depthVel=textureLod(depthSampler,texCoord,0.).rg;float depth=depthVel.r;\n#ifndef FLUIDRENDERING_FIXED_THICKNESS\nfloat thickness=texture2D(thicknessSampler,texCoord).x;\n#else\nfloat bgDepth=texture2D(bgDepthSampler,texCoord).x;float depthNonLinear=projectionMatrix[2].z+projectionMatrix[3].z/depth;depthNonLinear=depthNonLinear*0.5+0.5;\n#endif\nvec4 backColor=texture2D(textureSampler,texCoord);\n#ifndef FLUIDRENDERING_FIXED_THICKNESS\nif (depth>=cameraFar || depth<=0. || thickness<=minimumThickness) {\n#else\nif (depth>=cameraFar || depth<=0. || bgDepth<=depthNonLinear) {\n#endif\nglFragColor=backColor;return;}\nvec3 viewPos=computeViewPosFromUVDepth(texCoord,depth);vec3 ddx=getViewPosFromTexCoord(texCoord+vec2(texelSize.x,0.))-viewPos;vec3 ddy=getViewPosFromTexCoord(texCoord+vec2(0.,texelSize.y))-viewPos;vec3 ddx2=viewPos-getViewPosFromTexCoord(texCoord+vec2(-texelSize.x,0.));if (abs(ddx.z)>abs(ddx2.z)) {ddx=ddx2;}\nvec3 ddy2=viewPos-getViewPosFromTexCoord(texCoord+vec2(0.,-texelSize.y));if (abs(ddy.z)>abs(ddy2.z)) {ddy=ddy2;}\nvec3 normal=normalize(cross(ddy,ddx));\n#ifdef FLUIDRENDERING_RHS\nnormal=-normal;\n#endif\n#ifndef WEBGPU\nif(isnan(normal.x) || isnan(normal.y) || isnan(normal.z) || isinf(normal.x) || isinf(normal.y) || isinf(normal.z)) {normal=vec3(0.,0.,-1.);}\n#endif\n#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_SHOWNORMAL)\nglFragColor=vec4(normal*0.5+0.5,1.0);return;\n#endif\nvec3 rayDir=normalize(viewPos); \n#ifdef FLUIDRENDERING_DIFFUSETEXTURE\nvec3 diffuseColor=textureLod(diffuseSampler,texCoord,0.0).rgb;\n#endif\nvec3 lightDir=normalize(vec3(viewMatrix*vec4(-dirLight,0.)));vec3 H =normalize(lightDir-rayDir);float specular=pow(max(0.0,dot(H,normal)),specularPower);\n#ifdef FLUIDRENDERING_DEBUG_DIFFUSERENDERING\nfloat diffuse =max(0.0,dot(lightDir,normal))*1.0;glFragColor=vec4(vec3(0.1) /*ambient*/+vec3(0.42,0.50,1.00)*diffuse+vec3(0,0,0.2)+specular,1.);return;\n#endif\nvec3 refractionDir=refract(rayDir,normal,ETA);vec4 transmitted=textureLod(textureSampler,vec2(texCoord+refractionDir.xy*thickness*refractionStrength),0.0);vec3 transmittance=exp(-density*thickness*(1.0-diffuseColor)); \nvec3 refractionColor=transmitted.rgb*transmittance;\n#ifdef FLUIDRENDERING_ENVIRONMENT\nvec3 reflectionDir=reflect(rayDir,normal);vec3 reflectionColor=(textureCube(reflectionSampler,reflectionDir).rgb);float fresnel=clamp(F0+(1.0-F0)*pow(1.0-dot(normal,-rayDir),5.0),0.,fresnelClamp);vec3 finalColor=mix(refractionColor,reflectionColor,fresnel)+specular;\n#else\nvec3 finalColor=refractionColor+specular;\n#endif\n#ifdef FLUIDRENDERING_VELOCITY\nfloat velocity=depthVel.g;finalColor=mix(finalColor,vec3(1.0),smoothstep(0.3,1.0,velocity/6.0));\n#endif\nglFragColor=vec4(finalColor,transmitted.a);}\n",Object.defineProperty(Yi.prototype,"fluidRenderer",{get:function(){return this._fluidRenderer},set:function(e){this._fluidRenderer=e},enumerable:!0,configurable:!0}),Yi.prototype.enableFluidRenderer=function(){return this._fluidRenderer||(this._fluidRenderer=new ix(this)),this._fluidRenderer},Yi.prototype.disableFluidRenderer=function(){var e;null===(e=this._fluidRenderer)||void 0===e||e.dispose(),this._fluidRenderer=null};class tx{constructor(e){this.name=fi.NAME_FLUIDRENDERER,this.scene=e}register(){this.scene._gatherActiveCameraRenderTargetsStage.registerStep(fi.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER,this,this._gatherActiveCameraRenderTargets),this.scene._afterCameraDrawStage.registerStep(fi.STEP_AFTERCAMERADRAW_FLUIDRENDERER,this,this._afterCameraDraw)}_gatherActiveCameraRenderTargets(e){var t;null===(t=this.scene.fluidRenderer)||void 0===t||t._prepareRendering()}_afterCameraDraw(e){var t;null===(t=this.scene.fluidRenderer)||void 0===t||t._render(e)}rebuild(){this.scene._fluidRenderer&&(this.scene.disableFluidRenderer(),this.scene.enableFluidRenderer())}dispose(){this.scene.disableFluidRenderer()}}class ix{static _SceneComponentInitialization(e){let t=e._getComponent(fi.NAME_FLUIDRENDERER);t||(t=new tx(e),e._addComponent(t))}constructor(e){this._scene=e,this._engine=e.getEngine(),this._onEngineResizeObserver=null,this.renderObjects=[],this.targetRenderers=[],this._cameras=new Map,ix._SceneComponentInitialization(this._scene),this._onEngineResizeObserver=this._engine.onResizeObservable.add((()=>{this._initialize()}))}recreate(){this._sortRenderingObjects(),this._initialize()}getRenderObjectFromParticleSystem(e){const t=this._getParticleSystemIndex(e);return-1!==t?this.renderObjects[t]:null}addParticleSystem(e,t,i,s){const r=new Yv(this._scene,e);r.onParticleSizeChanged.add((()=>this._setParticleSizeForRenderTargets())),i||(i=new $v(this._scene,s),this.targetRenderers.push(i)),i._onUseVelocityChanged.hasObservers()||i._onUseVelocityChanged.add((()=>this._setUseVelocityForRenderObject())),void 0!==t&&(i.generateDiffuseTexture=t);const n={object:r,targetRenderer:i};return this.renderObjects.push(n),this._sortRenderingObjects(),this._setParticleSizeForRenderTargets(),n}addCustomParticles(e,t,i,s,r){const n=new qv(this._scene,e,t);n.onParticleSizeChanged.add((()=>this._setParticleSizeForRenderTargets())),s||(s=new $v(this._scene,r),this.targetRenderers.push(s)),s._onUseVelocityChanged.hasObservers()||s._onUseVelocityChanged.add((()=>this._setUseVelocityForRenderObject())),void 0!==i&&(s.generateDiffuseTexture=i);const o={object:n,targetRenderer:s};return this.renderObjects.push(o),this._sortRenderingObjects(),this._setParticleSizeForRenderTargets(),o}removeRenderObject(e,t=!0){const i=this.renderObjects.indexOf(e);return-1!==i&&(e.object.dispose(),this.renderObjects.splice(i,1),t&&this._removeUnusedTargetRenderers()?this._initialize():this._setParticleSizeForRenderTargets(),!0)}_sortRenderingObjects(){this.renderObjects.sort(((e,t)=>e.object.priority<t.object.priority?-1:e.object.priority>t.object.priority?1:0))}_removeUnusedTargetRenderers(){const e={};for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t].targetRenderer;e[this.targetRenderers.indexOf(i)]=!0}let t=!1;const i=[];for(let s=0;s<this.targetRenderers.length;++s)e[s]?i.push(this.targetRenderers[s]):(this.targetRenderers[s].dispose(),t=!0);return t&&(this.targetRenderers.length=0,this.targetRenderers.push(...i)),t}_getParticleSystemIndex(e){for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t].object;if(ex(i)&&i.particleSystem===e)return t}return-1}_initialize(){for(let e=0;e<this.targetRenderers.length;++e)this.targetRenderers[e].dispose();const e=new Map;for(let t=0;t<this.targetRenderers.length;++t){const i=this.targetRenderers[t];if(i._initialize(),i.camera&&i._renderPostProcess){let s=e.get(i.camera);s||(s=[[],{}],e.set(i.camera,s)),s[0].push(i),i.camera.attachPostProcess(i._renderPostProcess,t)}}let t=e.keys();for(let i=t.next();!0!==i.done;i=t.next()){const t=i.value,s=e.get(t),r=t._getFirstPostProcess();if(!r)continue;const[n,o]=s;r.onSizeChangedObservable.add((()=>{var e;r.inputTexture.depthStencilTexture||r.inputTexture.createDepthStencilTexture(0,!0,this._engine.isStencilEnable,n[0].samples,this._engine.isStencilEnable?13:14,`PostProcessRTTDepthStencil-${r.name}`);for(const t of n){const i=null===(e=t._thicknessRenderTarget)||void 0===e?void 0:e.renderTarget,s=null==i?void 0:i.texture;if(i&&s){const e=s.width+"_"+s.height;let t=o[e];t||(t=o[e]=new Jv(this._engine,s.width,s.height)),t.depthRTWrapper._shareDepth(i)}}}))}t=this._cameras.keys();for(let i=t.next();!0!==i.done;i=t.next()){const t=i.value,s=this._cameras.get(t)[1],r=e.get(t);if(r)for(const e in s)r[1][e]||s[e].dispose();else for(const e in s)s[e].dispose()}this._cameras.clear(),this._cameras=e,this._setParticleSizeForRenderTargets()}_setParticleSizeForRenderTargets(){const e=new Map;for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t];let s=e.get(i.targetRenderer);void 0===s&&(s=0),e.set(i.targetRenderer,Math.max(s,i.object.particleSize))}e.forEach(((e,t)=>{t._depthRenderTarget&&(t._depthRenderTarget.particleSize=e)}))}_setUseVelocityForRenderObject(){for(const e of this.renderObjects)e.object.useVelocity=e.targetRenderer.useVelocity}_prepareRendering(){for(const e of this.targetRenderers)if(e.needInitialization)return void this._initialize()}_render(e){var t;for(let t=0;t<this.targetRenderers.length;++t)e&&this.targetRenderers[t].camera!==e||this.targetRenderers[t]._clearTargets();const i=this._cameras.keys();for(let s=i.next();!0!==s.done;s=i.next()){const i=s.value,r=this._cameras.get(i);if(e&&i!==e)continue;const n=i._getFirstPostProcess();if(!n)continue;const o=null===(t=n.inputTexture)||void 0===t?void 0:t.depthStencilTexture;if(o){const[e,t]=r;for(const t of e)t._bgDepthTexture=o;for(const e in t)t[e].copy(o)}}for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t];e&&i.targetRenderer.camera!==e||i.targetRenderer._render(i.object)}}dispose(){this._engine.onResizeObservable.remove(this._onEngineResizeObserver),this._onEngineResizeObserver=null;for(let e=0;e<this.renderObjects.length;++e)this.renderObjects[e].object.dispose();for(let e=0;e<this.targetRenderers.length;++e)this.targetRenderers[e].dispose();this._cameras.forEach((e=>{const t=e[1];for(const e in t)t[e].dispose()})),this.renderObjects=[],this.targetRenderers=[],this._cameras.clear()}}class sx{get vertexCount(){return this._vertexCount}_createMaterial(e){ot.ShadersStore.gaussianSplattingVertexShader=sx._VertexShaderSource,ot.ShadersStore.gaussianSplattingFragmentShader=sx._FragmentShaderSource;const t=new kl("GaussianSplattingShader",e,{vertex:"gaussianSplatting",fragment:"gaussianSplatting"},{attributes:["position"],uniforms:["projection","modelView","viewport"]});t.backFaceCulling=!1,t.alpha=.9999,this._material=t}_getMesh(e){const t=new ur(this.name,e),i=new As;i.positions=[-2,-2,0,2,-2,0,2,2,0,-2,2,0],i.indices=[0,1,2,0,2,3],i.applyToMesh(t);const s=t.getBoundingInfo();return s.reConstruct(this._minimum,this._maximum),s.isLocked=!0,t.doNotSyncBoundingInfo=!0,t.material=this._material,t}_setData(e){this._vertexCount=e.length/32;const t=this._vertexCount;this._positions=new Float32Array(3*t),this._covA=new Float32Array(3*t),this._covB=new Float32Array(3*t);const i=new Float32Array(e.buffer);this._uBuffer=new Uint8Array(e.buffer);const s=y.Zero(),r=y.Zero(),n=C.Identity();this._minimum.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._maximum.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let e=0;e<t;e++){const t=i[8*e+0],o=-i[8*e+1],a=i[8*e+2];this._positions[3*e+0]=t,this._positions[3*e+1]=o,this._positions[3*e+2]=a,this._minimum.minimizeInPlaceFromFloats(t,o,a),this._maximum.maximizeInPlaceFromFloats(t,o,a),n.set((this._uBuffer[32*e+28+1]-128)/128,(this._uBuffer[32*e+28+2]-128)/128,(this._uBuffer[32*e+28+3]-128)/128,-(this._uBuffer[32*e+28+0]-128)/128),n.toRotationMatrix(s),y.ScalingToRef(2*i[8*e+3+0],2*i[8*e+3+1],2*i[8*e+3+2],r);const l=s.multiplyToRef(r,R.Matrix[0]).m;this._covA[3*e+0]=l[0]*l[0]+l[1]*l[1]+l[2]*l[2],this._covA[3*e+1]=l[0]*l[4]+l[1]*l[5]+l[2]*l[6],this._covA[3*e+2]=l[0]*l[8]+l[1]*l[9]+l[2]*l[10],this._covB[3*e+0]=l[4]*l[4]+l[5]*l[5]+l[6]*l[6],this._covB[3*e+1]=l[4]*l[8]+l[5]*l[9]+l[6]*l[10],this._covB[3*e+2]=l[8]*l[8]+l[9]*l[9]+l[10]*l[10]}}constructor(e,t){var i;this._vertexCount=0,this._modelViewMatrix=y.Identity(),this._minimum=new S,this._maximum=new S,this.name="GaussianSplatting",this._worker=null,this.scene=t,this.name=e,this._createMaterial(t),null===(i=this._worker)||void 0===i||i.terminate(),this._worker=null}_loadData(e){this.mesh&&this.dispose(),this._setData(new Uint8Array(e));const t=new Float32Array(16*this.vertexCount),i=e=>{var i;for(let i=0;i<this.vertexCount;i++){const s=e[2*i],r=16*i;t[r+0]=this._positions[3*s+0],t[r+1]=this._positions[3*s+1],t[r+2]=this._positions[3*s+2],t[r+4]=this._uBuffer[32*s+24+0]/255,t[r+5]=this._uBuffer[32*s+24+1]/255,t[r+6]=this._uBuffer[32*s+24+2]/255,t[r+7]=this._uBuffer[32*s+24+3]/255,t[r+8]=this._covA[3*s+0],t[r+9]=this._covA[3*s+1],t[r+10]=this._covA[3*s+2],t[r+12]=this._covB[3*s+0],t[r+13]=this._covB[3*s+1],t[r+14]=this._covB[3*s+2]}null===(i=this.mesh)||void 0===i||i.thinInstanceBufferUpdated("matrix")};this.mesh=this._getMesh(this.scene),this.mesh.thinInstanceSetBuffer("matrix",t,16,!1),this._worker=new Worker(URL.createObjectURL(new Blob(["(",sx._CreateWorker.toString(),")(self)"],{type:"application/javascript"}))),this._worker.onmessage=e=>{const t=new Uint32Array(e.data.depthMix.buffer);i(t)};const s=new E;this._sceneBeforeRenderObserver=this.scene.onBeforeRenderObservable.add((()=>{var e;const t=this.scene.getEngine();s.set(t.getRenderWidth(),t.getRenderHeight()),this._material.setVector2("viewport",s);const i=this.mesh.getWorldMatrix();i.multiplyToRef(this.scene.activeCamera.getViewMatrix(),this._modelViewMatrix);const r=this.mesh.getBoundingInfo();r.reConstruct(this._minimum,this._maximum,i),r.isLocked=!0,this._material.setMatrix("modelView",this._modelViewMatrix),null===(e=this._worker)||void 0===e||e.postMessage({view:this._modelViewMatrix.m,positions:this._positions})})),this._sceneDisposeObserver=this.scene.onDisposeObservable.add((()=>{this.dispose()}))}loadDataAsync(e){return Promise.resolve(this._loadData(e))}loadFileAsync(e){return Ht.LoadFileAsync(e,!0).then((e=>{this._loadData(e)}))}dispose(){var e,t;this.scene.onDisposeObservable.remove(this._sceneDisposeObserver),this.scene.onBeforeRenderObservable.remove(this._sceneBeforeRenderObserver),null===(e=this._worker)||void 0===e||e.terminate(),this._worker=null,null===(t=this.mesh)||void 0===t||t.dispose(),this.mesh=null}}sx._VertexShaderSource="\n        precision mediump float;\n        attribute vec2 position;\n\n        attribute vec4 world0;\n        attribute vec4 world1;\n        attribute vec4 world2;\n        attribute vec4 world3;\n\n        uniform mat4 projection, modelView;\n        uniform vec2 viewport;\n\n        varying vec4 vColor;\n        varying vec2 vPosition;\n        void main () {\n        vec3 center = world0.xyz;\n        vec4 color = world1;\n        vec3 covA = world2.xyz;\n        vec3 covB = world3.xyz;\n\n        vec4 camspace = modelView * vec4(center, 1);\n        vec4 pos2d = projection * camspace;\n\n        float bounds = 1.2 * pos2d.w;\n        if (pos2d.z < -pos2d.w || pos2d.x < -bounds || pos2d.x > bounds\n            || pos2d.y < -bounds || pos2d.y > bounds) {\n            gl_Position = vec4(0.0, 0.0, 2.0, 1.0);\n            return;\n        }\n\n        mat3 Vrk = mat3(\n            covA.x, covA.y, covA.z, \n            covA.y, covB.x, covB.y,\n            covA.z, covB.y, covB.z\n        );\n        vec2 focal = vec2(1132., 1132.);\n        mat3 J = mat3(\n            focal.x / camspace.z, 0., -(focal.x * camspace.x) / (camspace.z * camspace.z), \n            0., focal.y / camspace.z, -(focal.y * camspace.y) / (camspace.z * camspace.z), \n            0., 0., 0.\n        );\n\n        mat3 invy = mat3(1,0,0, 0,-1,0,0,0,1);\n\n        mat3 T = invy * transpose(mat3(modelView)) * J;\n        mat3 cov2d = transpose(T) * Vrk * T;\n\n        float mid = (cov2d[0][0] + cov2d[1][1]) / 2.0;\n        float radius = length(vec2((cov2d[0][0] - cov2d[1][1]) / 2.0, cov2d[0][1]));\n        float lambda1 = mid + radius, lambda2 = mid - radius;\n\n        if(lambda2 < 0.0) return;\n        vec2 diagonalVector = normalize(vec2(cov2d[0][1], lambda1 - cov2d[0][0]));\n        vec2 majorAxis = min(sqrt(2.0 * lambda1), 1024.0) * diagonalVector;\n        vec2 minorAxis = min(sqrt(2.0 * lambda2), 1024.0) * vec2(diagonalVector.y, -diagonalVector.x);\n\n        vColor = color;\n        vPosition = position;\n        vec2 vCenter = vec2(pos2d);\n        gl_Position = vec4(\n            vCenter \n            + (position.x * majorAxis * 1. / viewport \n            + position.y * minorAxis * 1. / viewport) * pos2d.w, pos2d.zw);\n        }",sx._FragmentShaderSource="\n        precision highp float;\n        varying vec4 vColor;\n        varying vec2 vPosition;\n        void main () {    \n        float A = -dot(vPosition, vPosition);\n        if (A < -4.0) discard;\n        float B = exp(A) * vColor.a;\n        gl_FragColor = vec4(vColor.rgb, B);\n        }",sx._CreateWorker=function(e){let t,i,s=[],r=0,n=!1;const o=()=>{if(!n){n=!0;const a=t;(t=>{r=i.length;const n=new BigInt64Array(r),o=new Uint32Array(n.buffer);for(let e=0;e<r;e++)o[2*e]=e;const a=new Float32Array(n.buffer);for(let e=0;e<r;e++)a[2*e+1]=1e4-(t[2]*i[3*e+0]+t[6]*i[3*e+1]+t[10]*i[3*e+2]);s=t,n.sort(),e.postMessage({depthMix:n},[n.buffer])})(a),setTimeout((()=>{n=!1,a!==t&&o()}),0)}};e.onmessage=e=>{t=e.data.view;const r=s[2]*t[2]+s[6]*t[6]+s[10]*t[10];Math.abs(r-1)<.01||(i=e.data.positions,o())}};class rx{get animationStarted(){return this._animationStarted}get fromIndex(){return this._fromIndex}get toIndex(){return this._toIndex}get loopAnimation(){return this._loopAnimation}get delay(){return Math.max(this._delay,1)}constructor(){this.width=1,this.height=1,this.angle=0,this.invertU=!1,this.invertV=!1,this.isVisible=!0,this._animationStarted=!1,this._loopAnimation=!1,this._fromIndex=0,this._toIndex=0,this._delay=0,this._direction=1,this._time=0,this._onBaseAnimationEnd=null,this.position={x:1,y:1,z:1},this.color={r:1,g:1,b:1,a:1}}playAnimation(e,t,i,s,r){this._fromIndex=e,this._toIndex=t,this._loopAnimation=i,this._delay=s||1,this._animationStarted=!0,this._onBaseAnimationEnd=r,e<t?this._direction=1:(this._direction=-1,this._toIndex=e,this._fromIndex=t),this.cellIndex=e,this._time=0}stopAnimation(){this._animationStarted=!1}_animate(e){this._animationStarted&&(this._time+=e,this._time>this._delay&&(this._time=this._time%this._delay,this.cellIndex+=this._direction,(this._direction>0&&this.cellIndex>this._toIndex||this._direction<0&&this.cellIndex<this._fromIndex)&&(this._loopAnimation?this.cellIndex=this._direction>0?this._fromIndex:this._toIndex:(this.cellIndex=this._toIndex,this._animationStarted=!1,this._onBaseAnimationEnd&&this._onBaseAnimationEnd()))))}}class nx extends rx{get size(){return this.width}set size(e){this.width=e,this.height=e}get manager(){return this._manager}constructor(e,t){super(),this.name=e,this.animations=new Array,this.isPickable=!1,this.useAlphaForPicking=!1,this.onDisposeObservable=new a,this._onAnimationEnd=null,this._endAnimation=()=>{this._onAnimationEnd&&this._onAnimationEnd(),this.disposeWhenFinishedAnimating&&this.dispose()},this.color=new F(1,1,1,1),this.position=S.Zero(),this._manager=t,this._manager.sprites.push(this),this.uniqueId=this._manager.scene.getUniqueId()}getClassName(){return"Sprite"}get fromIndex(){return this._fromIndex}set fromIndex(e){this.playAnimation(e,this._toIndex,this._loopAnimation,this._delay,this._onAnimationEnd)}get toIndex(){return this._toIndex}set toIndex(e){this.playAnimation(this._fromIndex,e,this._loopAnimation,this._delay,this._onAnimationEnd)}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){this.playAnimation(this._fromIndex,this._toIndex,e,this._delay,this._onAnimationEnd)}get delay(){return Math.max(this._delay,1)}set delay(e){this.playAnimation(this._fromIndex,this._toIndex,this._loopAnimation,e,this._onAnimationEnd)}playAnimation(e,t,i,s,r=null){this._onAnimationEnd=r,super.playAnimation(e,t,i,s,this._endAnimation)}dispose(){for(let e=0;e<this._manager.sprites.length;e++)this._manager.sprites[e]==this&&this._manager.sprites.splice(e,1);this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}serialize(){const e={};return e.name=this.name,e.position=this.position.asArray(),e.color=this.color.asArray(),e.width=this.width,e.height=this.height,e.angle=this.angle,e.cellIndex=this.cellIndex,e.cellRef=this.cellRef,e.invertU=this.invertU,e.invertV=this.invertV,e.disposeWhenFinishedAnimating=this.disposeWhenFinishedAnimating,e.isPickable=this.isPickable,e.isVisible=this.isVisible,e.useAlphaForPicking=this.useAlphaForPicking,e.animationStarted=this.animationStarted,e.fromIndex=this.fromIndex,e.toIndex=this.toIndex,e.loopAnimation=this.loopAnimation,e.delay=this.delay,e}static Parse(e,t){const i=new nx(e.name,t);return i.position=S.FromArray(e.position),i.color=F.FromArray(e.color),i.width=e.width,i.height=e.height,i.angle=e.angle,i.cellIndex=e.cellIndex,i.cellRef=e.cellRef,i.invertU=e.invertU,i.invertV=e.invertV,i.disposeWhenFinishedAnimating=e.disposeWhenFinishedAnimating,i.isPickable=e.isPickable,i.isVisible=e.isVisible,i.useAlphaForPicking=e.useAlphaForPicking,i._fromIndex=e.fromIndex,i._toIndex=e.toIndex,i._loopAnimation=e.loopAnimation,i._delay=e.delay,e.animationStarted&&i.playAnimation(i.fromIndex,i.toIndex,i.loopAnimation,i.delay),i}}Yi.prototype._internalPickSprites=function(e,t,i,s){if(!ci)return null;let r=null;if(!s){if(!this.activeCamera)return null;s=this.activeCamera}if(this.spriteManagers&&this.spriteManagers.length>0)for(let n=0;n<this.spriteManagers.length;n++){const o=this.spriteManagers[n];if(!o.isPickable)continue;const a=o.intersects(e,s,t,i);if(a&&a.hit&&(i||null==r||!(a.distance>=r.distance))&&(r=a,i))break}return r||new ci},Yi.prototype._internalMultiPickSprites=function(e,t,i){if(!ci)return null;let s=[];if(!i){if(!this.activeCamera)return null;i=this.activeCamera}if(this.spriteManagers&&this.spriteManagers.length>0)for(let r=0;r<this.spriteManagers.length;r++){const n=this.spriteManagers[r];if(!n.isPickable)continue;const o=n.multiIntersects(e,i,t);null!==o&&(s=s.concat(o))}return s},Yi.prototype.pickSprite=function(e,t,i,s,r){if(!this._tempSpritePickingRay)return null;this.createPickingRayInCameraSpaceToRef(e,t,this._tempSpritePickingRay,r);const n=this._internalPickSprites(this._tempSpritePickingRay,i,s,r);return n&&(n.ray=this.createPickingRayInCameraSpace(e,t,r)),n},Yi.prototype.pickSpriteWithRay=function(e,t,i,s){if(!this._tempSpritePickingRay)return null;if(!s){if(!this.activeCamera)return null;s=this.activeCamera}Fr.TransformToRef(e,s.getViewMatrix(),this._tempSpritePickingRay);const r=this._internalPickSprites(this._tempSpritePickingRay,t,i,s);return r&&(r.ray=e),r},Yi.prototype.multiPickSprite=function(e,t,i,s){return this.createPickingRayInCameraSpaceToRef(e,t,this._tempSpritePickingRay,s),this._internalMultiPickSprites(this._tempSpritePickingRay,i,s)},Yi.prototype.multiPickSpriteWithRay=function(e,t,i){if(!this._tempSpritePickingRay)return null;if(!i){if(!this.activeCamera)return null;i=this.activeCamera}return Fr.TransformToRef(e,i.getViewMatrix(),this._tempSpritePickingRay),this._internalMultiPickSprites(this._tempSpritePickingRay,t,i)},Yi.prototype.setPointerOverSprite=function(e){this._pointerOverSprite!==e&&(this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(10,B.CreateNewFromSprite(this._pointerOverSprite,this)),this._pointerOverSprite=e,this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(9,B.CreateNewFromSprite(this._pointerOverSprite,this)))},Yi.prototype.getPointerOverSprite=function(){return this._pointerOverSprite};class ox{constructor(e){this.name=fi.NAME_SPRITE,this.scene=e,this.scene.spriteManagers=[],this.scene._tempSpritePickingRay=Fr?Fr.Zero():null,this.scene.onBeforeSpritesRenderingObservable=new a,this.scene.onAfterSpritesRenderingObservable=new a,this._spritePredicate=e=>!!e.actionManager&&e.isPickable&&e.actionManager.hasPointerTriggers}register(){this.scene._pointerMoveStage.registerStep(fi.STEP_POINTERMOVE_SPRITE,this,this._pointerMove),this.scene._pointerDownStage.registerStep(fi.STEP_POINTERDOWN_SPRITE,this,this._pointerDown),this.scene._pointerUpStage.registerStep(fi.STEP_POINTERUP_SPRITE,this,this._pointerUp)}rebuild(){}dispose(){this.scene.onBeforeSpritesRenderingObservable.clear(),this.scene.onAfterSpritesRenderingObservable.clear();const e=this.scene.spriteManagers;if(e)for(;e.length;)e[0].dispose()}_pickSpriteButKeepRay(e,t,i,s,r){const n=this.scene.pickSprite(t,i,this._spritePredicate,s,r);return n&&(n.ray=e?e.ray:null),n}_pointerMove(e,t,i,s,r){const n=this.scene;return s?n.setPointerOverSprite(null):(i=this._pickSpriteButKeepRay(i,e,t,!1,n.cameraToUseForPointers||void 0))&&i.hit&&i.pickedSprite?(n.setPointerOverSprite(i.pickedSprite),!n.doNotHandleCursors&&r&&(n._pointerOverSprite&&n._pointerOverSprite.actionManager&&n._pointerOverSprite.actionManager.hoverCursor?r.style.cursor=n._pointerOverSprite.actionManager.hoverCursor:r.style.cursor=n.hoverCursor)):n.setPointerOverSprite(null),i}_pointerDown(e,t,i,s){const r=this.scene;if(r._pickedDownSprite=null,r.spriteManagers&&r.spriteManagers.length>0&&(i=r.pickSprite(e,t,this._spritePredicate,!1,r.cameraToUseForPointers||void 0))&&i.hit&&i.pickedSprite&&i.pickedSprite.actionManager){switch(r._pickedDownSprite=i.pickedSprite,s.button){case 0:i.pickedSprite.actionManager.processTrigger(2,B.CreateNewFromSprite(i.pickedSprite,r,s));break;case 1:i.pickedSprite.actionManager.processTrigger(4,B.CreateNewFromSprite(i.pickedSprite,r,s));break;case 2:i.pickedSprite.actionManager.processTrigger(3,B.CreateNewFromSprite(i.pickedSprite,r,s))}i.pickedSprite.actionManager&&i.pickedSprite.actionManager.processTrigger(5,B.CreateNewFromSprite(i.pickedSprite,r,s))}return i}_pointerUp(e,t,i,s,r){const n=this.scene;if(n.spriteManagers&&n.spriteManagers.length>0){const i=n.pickSprite(e,t,this._spritePredicate,!1,n.cameraToUseForPointers||void 0);i&&(i.hit&&i.pickedSprite&&i.pickedSprite.actionManager&&(i.pickedSprite.actionManager.processTrigger(7,B.CreateNewFromSprite(i.pickedSprite,n,s)),i.pickedSprite.actionManager&&(this.scene._inputManager._isPointerSwiping()||i.pickedSprite.actionManager.processTrigger(1,B.CreateNewFromSprite(i.pickedSprite,n,s)),r&&i.pickedSprite.actionManager.processTrigger(6,B.CreateNewFromSprite(i.pickedSprite,n,s)))),n._pickedDownSprite&&n._pickedDownSprite.actionManager&&n._pickedDownSprite!==i.pickedSprite&&n._pickedDownSprite.actionManager.processTrigger(16,B.CreateNewFromSprite(n._pickedDownSprite,n,s)))}return i}}nt.IncludesShadersStore.imageProcessingCompatibility="#ifdef IMAGEPROCESSINGPOSTPROCESS\ngl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(2.2));\n#endif\n";nt.ShadersStore.spritesPixelShader="uniform bool alphaTest;varying vec4 vColor;varying vec2 vUV;uniform sampler2D diffuseSampler;\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#ifdef PIXEL_PERFECT\nvec2 uvPixelPerfect(vec2 uv) {vec2 res=vec2(textureSize(diffuseSampler,0));uv=uv*res;vec2 seam=floor(uv+0.5);uv=seam+clamp((uv-seam)/fwidth(uv),-0.5,0.5);return uv/res;}\n#endif\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#ifdef PIXEL_PERFECT\nvec2 uv=uvPixelPerfect(vUV);\n#else\nvec2 uv=vUV;\n#endif\nvec4 color=texture2D(diffuseSampler,uv);float fAlphaTest=float(alphaTest);if (fAlphaTest != 0.)\n{if (color.a<0.95)\ndiscard;}\ncolor*=vColor;\n#include<fogFragment>\ngl_FragColor=color;\n#include<imageProcessingCompatibility>\n#define CUSTOM_FRAGMENT_MAIN_END\n}";nt.ShadersStore.spritesVertexShader="attribute vec4 position;attribute vec2 options;attribute vec2 offsets;attribute vec2 inverts;attribute vec4 cellInfo;attribute vec4 color;uniform mat4 view;uniform mat4 projection;varying vec2 vUV;varying vec4 vColor;\n#include<fogVertexDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 viewPos=(view*vec4(position.xyz,1.0)).xyz; \nvec2 cornerPos;float angle=position.w;vec2 size=vec2(options.x,options.y);vec2 offset=offsets.xy;cornerPos=vec2(offset.x-0.5,offset.y -0.5)*size;vec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;viewPos+=rotatedCorner;gl_Position=projection*vec4(viewPos,1.0); \nvColor=color;vec2 uvOffset=vec2(abs(offset.x-inverts.x),abs(1.0-offset.y-inverts.y));vec2 uvPlace=cellInfo.xy;vec2 uvSize=cellInfo.zw;vUV.x=uvPlace.x+uvSize.x*uvOffset.x;vUV.y=uvPlace.y+uvSize.y*uvOffset.y;\n#ifdef FOG\nvFogDistance=viewPos;\n#endif\n#define CUSTOM_VERTEX_MAIN_END\n}";class ax{get capacity(){return this._capacity}get pixelPerfect(){return this._pixelPerfect}set pixelPerfect(e){this._pixelPerfect!==e&&(this._pixelPerfect=e,this._createEffects())}constructor(e,t,i=.01,s=null){this.blendMode=2,this.autoResetAlpha=!0,this.disableDepthWrite=!1,this.fogEnabled=!0,this._pixelPerfect=!1,this._useVAO=!1,this._useInstancing=!1,this._vertexBuffers={},this._capacity=t,this._epsilon=i,this._engine=e,this._useInstancing=e.getCaps().instancedArrays&&e._features.supportSpriteInstancing,this._useVAO=e.getCaps().vertexArrayObject&&!e.disableVertexArrayObjects,this._scene=s,this._useInstancing||this._buildIndexBuffer(),this._vertexBufferSize=this._useInstancing?16:18,this._vertexData=new Float32Array(t*this._vertexBufferSize*(this._useInstancing?1:4)),this._buffer=new li(e,this._vertexData,!0,this._vertexBufferSize);const r=this._buffer.createVertexBuffer(hi.PositionKind,0,4,this._vertexBufferSize,this._useInstancing),n=this._buffer.createVertexBuffer("options",4,2,this._vertexBufferSize,this._useInstancing);let o,a=6;if(this._useInstancing){const t=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new li(e,t,!1,2),o=this._spriteBuffer.createVertexBuffer("offsets",0,2)}else o=this._buffer.createVertexBuffer("offsets",a,2,this._vertexBufferSize,this._useInstancing),a+=2;const l=this._buffer.createVertexBuffer("inverts",a,2,this._vertexBufferSize,this._useInstancing),h=this._buffer.createVertexBuffer("cellInfo",a+2,4,this._vertexBufferSize,this._useInstancing),c=this._buffer.createVertexBuffer(hi.ColorKind,a+6,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[hi.PositionKind]=r,this._vertexBuffers.options=n,this._vertexBuffers.offsets=o,this._vertexBuffers.inverts=l,this._vertexBuffers.cellInfo=h,this._vertexBuffers[hi.ColorKind]=c,this._createEffects()}_createEffects(){var e,t,i,s;null===(e=this._drawWrapperBase)||void 0===e||e.dispose(),null===(t=this._drawWrapperFog)||void 0===t||t.dispose(),null===(i=this._drawWrapperDepth)||void 0===i||i.dispose(),null===(s=this._drawWrapperFogDepth)||void 0===s||s.dispose(),this._drawWrapperBase=new Tt(this._engine),this._drawWrapperFog=new Tt(this._engine),this._drawWrapperDepth=new Tt(this._engine,!1),this._drawWrapperFogDepth=new Tt(this._engine,!1),this._drawWrapperBase.drawContext&&(this._drawWrapperBase.drawContext.useInstancing=this._useInstancing),this._drawWrapperFog.drawContext&&(this._drawWrapperFog.drawContext.useInstancing=this._useInstancing),this._drawWrapperDepth.drawContext&&(this._drawWrapperDepth.drawContext.useInstancing=this._useInstancing),this._drawWrapperFogDepth.drawContext&&(this._drawWrapperFogDepth.drawContext.useInstancing=this._useInstancing);const r=this._pixelPerfect?"#define PIXEL_PERFECT\n":"";this._drawWrapperBase.effect=this._engine.createEffect("sprites",[hi.PositionKind,"options","offsets","inverts","cellInfo",hi.ColorKind],["view","projection","textureInfos","alphaTest"],["diffuseSampler"],r),this._drawWrapperDepth.effect=this._drawWrapperBase.effect,this._drawWrapperDepth.materialContext=this._drawWrapperBase.materialContext,this._scene&&(this._drawWrapperFog.effect=this._scene.getEngine().createEffect("sprites",[hi.PositionKind,"options","offsets","inverts","cellInfo",hi.ColorKind],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor"],["diffuseSampler"],r+"#define FOG"),this._drawWrapperFogDepth.effect=this._drawWrapperFog.effect,this._drawWrapperFogDepth.materialContext=this._drawWrapperFog.materialContext)}render(e,t,i,s,r=null){if(!this.texture||!this.texture.isReady()||!e.length)return;let n=this._drawWrapperBase,o=this._drawWrapperDepth,a=!1;this.fogEnabled&&this._scene&&this._scene.fogEnabled&&0!==this._scene.fogMode&&(n=this._drawWrapperFog,o=this._drawWrapperFogDepth,a=!0);const l=n.effect;if(!l.isReady())return;const h=this._engine,c=!(!this._scene||!this._scene.useRightHandedSystem),u=this.texture.getBaseSize(),d=Math.min(this._capacity,e.length);let p=0,_=!0;for(let i=0;i<d;i++){const s=e[i];s&&s.isVisible&&(_=!1,s._animate(t),this._appendSpriteVertex(p++,s,0,0,u,c,r),this._useInstancing||(this._appendSpriteVertex(p++,s,1,0,u,c,r),this._appendSpriteVertex(p++,s,1,1,u,c,r),this._appendSpriteVertex(p++,s,0,1,u,c,r)))}if(_)return;this._buffer.update(this._vertexData);const f=!!h.depthCullingState.cull,m=h.depthCullingState.zOffset,g=h.depthCullingState.zOffsetUnits;if(h.setState(f,m,!1,!1,void 0,void 0,g),h.enableEffect(n),l.setTexture("diffuseSampler",this.texture),l.setMatrix("view",i),l.setMatrix("projection",s),a){const e=this._scene;l.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),l.setColor3("vFogColor",e.fogColor)}this._useVAO?(this._vertexArrayObject||(this._vertexArrayObject=h.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,l)),h.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):h.bindBuffers(this._vertexBuffers,this._indexBuffer,l),h.depthCullingState.depthFunc=h.useReverseDepthBuffer?518:515,this.disableDepthWrite||(l.setBool("alphaTest",!0),h.setColorWrite(!1),h.enableEffect(o),this._useInstancing?h.drawArraysType(7,0,4,p):h.drawElementsType(0,0,p/4*6),h.enableEffect(n),h.setColorWrite(!0),l.setBool("alphaTest",!1)),h.setAlphaMode(this.blendMode),this._useInstancing?h.drawArraysType(7,0,4,p):h.drawElementsType(0,0,p/4*6),this.autoResetAlpha&&h.setAlphaMode(0),c&&this._scene.getEngine().setState(f,m,!1,!0,void 0,void 0,g),h.unbindInstanceAttributes()}_appendSpriteVertex(e,t,i,s,r,n,o){let a=e*this._vertexBufferSize;if(0===i?i=this._epsilon:1===i&&(i=1-this._epsilon),0===s?s=this._epsilon:1===s&&(s=1-this._epsilon),o)o(t,r);else{t.cellIndex||(t.cellIndex=0);const e=r.width/this.cellWidth,i=t.cellIndex/e|0;t._xOffset=(t.cellIndex-i*e)*this.cellWidth/r.width,t._yOffset=i*this.cellHeight/r.height,t._xSize=this.cellWidth,t._ySize=this.cellHeight}this._vertexData[a]=t.position.x,this._vertexData[a+1]=t.position.y,this._vertexData[a+2]=t.position.z,this._vertexData[a+3]=t.angle,this._vertexData[a+4]=t.width,this._vertexData[a+5]=t.height,this._useInstancing?a-=2:(this._vertexData[a+6]=i,this._vertexData[a+7]=s),this._vertexData[a+8]=n?t.invertU?0:1:t.invertU?1:0,this._vertexData[a+9]=t.invertV?1:0,this._vertexData[a+10]=t._xOffset,this._vertexData[a+11]=t._yOffset,this._vertexData[a+12]=t._xSize/r.width,this._vertexData[a+13]=t._ySize/r.height,this._vertexData[a+14]=t.color.r,this._vertexData[a+15]=t.color.g,this._vertexData[a+16]=t.color.b,this._vertexData[a+17]=t.color.a}_buildIndexBuffer(){const e=[];let t=0;for(let i=0;i<this._capacity;i++)e.push(t),e.push(t+1),e.push(t+2),e.push(t),e.push(t+2),e.push(t+3),t+=4;this._indexBuffer=this._engine.createIndexBuffer(e)}rebuild(){var e;this._indexBuffer&&this._buildIndexBuffer(),this._useVAO&&(this._vertexArrayObject=void 0),this._buffer._rebuild();for(const e in this._vertexBuffers)this._vertexBuffers[e]._rebuild();null===(e=this._spriteBuffer)||void 0===e||e._rebuild()}dispose(){this._buffer&&(this._buffer.dispose(),this._buffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this.texture&&(this.texture.dispose(),this.texture=null),this._drawWrapperBase.dispose(),this._drawWrapperFog.dispose(),this._drawWrapperDepth.dispose(),this._drawWrapperFogDepth.dispose()}}class lx{set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get children(){return this.sprites}get scene(){return this._scene}get capacity(){return this._spriteRenderer.capacity}get texture(){return this._spriteRenderer.texture}set texture(e){e.wrapU=Ar.CLAMP_ADDRESSMODE,e.wrapV=Ar.CLAMP_ADDRESSMODE,this._spriteRenderer.texture=e,this._textureContent=null}get cellWidth(){return this._spriteRenderer.cellWidth}set cellWidth(e){this._spriteRenderer.cellWidth=e}get cellHeight(){return this._spriteRenderer.cellHeight}set cellHeight(e){this._spriteRenderer.cellHeight=e}get fogEnabled(){return this._spriteRenderer.fogEnabled}set fogEnabled(e){this._spriteRenderer.fogEnabled=e}get blendMode(){return this._spriteRenderer.blendMode}set blendMode(e){this._spriteRenderer.blendMode=e}get disableDepthWrite(){return this._disableDepthWrite}set disableDepthWrite(e){this._disableDepthWrite=e,this._spriteRenderer.disableDepthWrite=e}get pixelPerfect(){return this._spriteRenderer.pixelPerfect}set pixelPerfect(e){this._spriteRenderer.pixelPerfect=e,e&&3!==this.texture.samplingMode&&this.texture.updateSamplingMode(3)}constructor(e,t,i,s,r,n=.01,o=Ar.TRILINEAR_SAMPLINGMODE,l=!1,h=null){this.name=e,this.sprites=[],this.renderingGroupId=0,this.layerMask=268435455,this.isPickable=!1,this.metadata=null,this._wasDispatched=!1,this.onDisposeObservable=new a,this._disableDepthWrite=!1,this._packedAndReady=!1,this._customUpdate=(e,t)=>{e.cellRef||(e.cellIndex=0);const i=e.cellIndex;"number"==typeof i&&isFinite(i)&&Math.floor(i)===i&&(e.cellRef=this._spriteMap[e.cellIndex]),e._xOffset=this._cellData[e.cellRef].frame.x/t.width,e._yOffset=this._cellData[e.cellRef].frame.y/t.height,e._xSize=this._cellData[e.cellRef].frame.w,e._ySize=this._cellData[e.cellRef].frame.h},r||(r=x.LastCreatedScene),r._getComponent(fi.NAME_SPRITE)||r._addComponent(new ox(r)),this._fromPacked=l,this._scene=r;const c=this._scene.getEngine();if(this._spriteRenderer=new ax(c,i,n,r),s.width&&s.height)this.cellWidth=s.width,this.cellHeight=s.height;else{if(void 0===s)return void(this._spriteRenderer=null);this.cellWidth=s,this.cellHeight=s}this._scene.spriteManagers&&this._scene.spriteManagers.push(this),this.uniqueId=this.scene.getUniqueId(),t&&(this.texture=new Ar(t,r,!0,!1,o)),this._fromPacked&&this._makePacked(t,h)}getClassName(){return"SpriteManager"}_makePacked(e,t){if(null!==t)try{let e;if(e="string"==typeof t?JSON.parse(t):t,e.frames.length){const t={};for(let i=0;i<e.frames.length;i++){const s=e.frames[i];if("string"!=typeof Object.keys(s)[0])throw new Error("Invalid JSON Format.  Check the frame values and make sure the name is the first parameter.");t[s[Object.keys(s)[0]]]=s}e.frames=t}const i=Reflect.ownKeys(e.frames);this._spriteMap=i,this._packedAndReady=!0,this._cellData=e.frames}catch(e){throw this._fromPacked=!1,this._packedAndReady=!1,new Error("Invalid JSON from string. Spritesheet managed with constant cell size.")}else{const t=/\./g;let i;do{i=t.lastIndex,t.test(e)}while(t.lastIndex>0);const s=e.substring(0,i-1)+".json",r=()=>{k.Error("JSON ERROR: Unable to load JSON file."),this._fromPacked=!1,this._packedAndReady=!1},n=e=>{try{const t=JSON.parse(e),i=Reflect.ownKeys(t.frames);this._spriteMap=i,this._packedAndReady=!0,this._cellData=t.frames}catch(e){throw this._fromPacked=!1,this._packedAndReady=!1,new Error("Invalid JSON format. Please check documentation for format specifications.")}};Ht.LoadFile(s,n,void 0,void 0,!1,r)}}_checkTextureAlpha(e,t,i,s,r){if(!e.useAlphaForPicking||!this.texture)return!0;const n=this.texture.getSize();this._textureContent||(this._textureContent=new Uint8Array(n.width*n.height*4),this.texture.readPixels(0,0,this._textureContent));const o=R.Vector3[0];o.copyFrom(t.direction),o.normalize(),o.scaleInPlace(i),o.addInPlace(t.origin);const a=(o.x-s.x)/(r.x-s.x),l=1-(o.y-s.y)/(r.y-s.y),h=e._xOffset*n.width+a*e._xSize|0,c=e._yOffset*n.height+l*e._ySize|0;return this._textureContent[4*(h+c*n.width)+3]>.5}intersects(e,t,i,s){const r=Math.min(this.capacity,this.sprites.length),n=S.Zero(),o=S.Zero();let a=Number.MAX_VALUE,l=null;const h=R.Vector3[0],c=R.Vector3[1],u=t.getViewMatrix();let d=e,p=e;for(let t=0;t<r;t++){const r=this.sprites[t];if(r){if(i){if(!i(r))continue}else if(!r.isPickable)continue;if(S.TransformCoordinatesToRef(r.position,u,c),r.angle?(y.TranslationToRef(-c.x,-c.y,0,R.Matrix[1]),y.TranslationToRef(c.x,c.y,0,R.Matrix[2]),y.RotationZToRef(-r.angle,R.Matrix[3]),R.Matrix[1].multiplyToRef(R.Matrix[3],R.Matrix[4]),R.Matrix[4].multiplyToRef(R.Matrix[2],R.Matrix[0]),d=e.clone(),S.TransformCoordinatesToRef(e.origin,R.Matrix[0],d.origin),S.TransformNormalToRef(e.direction,R.Matrix[0],d.direction)):d=e,n.copyFromFloats(c.x-r.width/2,c.y-r.height/2,c.z),o.copyFromFloats(c.x+r.width/2,c.y+r.height/2,c.z),d.intersectsBoxMinMax(n,o)){const e=S.Distance(c,d.origin);if(a>e){if(!this._checkTextureAlpha(r,d,e,n,o))continue;if(p=d,a=e,l=r,s)break}}}}if(l){const e=new ci;u.invertToRef(R.Matrix[0]),e.hit=!0,e.pickedSprite=l,e.distance=a;const t=R.Vector3[2];return t.copyFrom(p.direction),t.normalize(),t.scaleInPlace(a),p.origin.addToRef(t,h),e.pickedPoint=S.TransformCoordinates(h,R.Matrix[0]),e}return null}multiIntersects(e,t,i){const s=Math.min(this.capacity,this.sprites.length),r=S.Zero(),n=S.Zero();let o;const a=[],l=R.Vector3[0].copyFromFloats(0,0,0),h=R.Vector3[1].copyFromFloats(0,0,0),c=t.getViewMatrix();for(let t=0;t<s;t++){const s=this.sprites[t];if(s){if(i){if(!i(s))continue}else if(!s.isPickable)continue;if(S.TransformCoordinatesToRef(s.position,c,h),r.copyFromFloats(h.x-s.width/2,h.y-s.height/2,h.z),n.copyFromFloats(h.x+s.width/2,h.y+s.height/2,h.z),e.intersectsBoxMinMax(r,n)){if(o=S.Distance(h,e.origin),!this._checkTextureAlpha(s,e,o,r,n))continue;const t=new ci;a.push(t),c.invertToRef(R.Matrix[0]),t.hit=!0,t.pickedSprite=s,t.distance=o;const i=R.Vector3[2];i.copyFrom(e.direction),i.normalize(),i.scaleInPlace(o),e.origin.addToRef(i,l),t.pickedPoint=S.TransformCoordinates(l,R.Matrix[0])}}}return a}render(){if(this._fromPacked&&(!this._packedAndReady||!this._spriteMap||!this._cellData))return;const e=this._scene.getEngine().getDeltaTime();this._packedAndReady?this._spriteRenderer.render(this.sprites,e,this._scene.getViewMatrix(),this._scene.getProjectionMatrix(),this._customUpdate):this._spriteRenderer.render(this.sprites,e,this._scene.getViewMatrix(),this._scene.getProjectionMatrix())}rebuild(){var e;null===(e=this._spriteRenderer)||void 0===e||e.rebuild()}dispose(){if(this._spriteRenderer&&(this._spriteRenderer.dispose(),this._spriteRenderer=null),this._textureContent=null,this._scene.spriteManagers){const e=this._scene.spriteManagers.indexOf(this);this._scene.spriteManagers.splice(e,1)}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null}serialize(e=!1){const t={};t.name=this.name,t.capacity=this.capacity,t.cellWidth=this.cellWidth,t.cellHeight=this.cellHeight,t.fogEnabled=this.fogEnabled,t.blendMode=this.blendMode,t.disableDepthWrite=this.disableDepthWrite,t.pixelPerfect=this.pixelPerfect,this.texture&&(e?t.texture=this.texture.serialize():(t.textureUrl=this.texture.name,t.invertY=this.texture._invertY)),t.sprites=[];for(const e of this.sprites)t.sprites.push(e.serialize());return t.metadata=this.metadata,t}static Parse(e,t,i){const s=new lx(e.name,"",e.capacity,{width:e.cellWidth,height:e.cellHeight},t);void 0!==e.fogEnabled&&(s.fogEnabled=e.fogEnabled),void 0!==e.blendMode&&(s.blendMode=e.blendMode),void 0!==e.disableDepthWrite&&(s.disableDepthWrite=e.disableDepthWrite),void 0!==e.pixelPerfect&&(s.pixelPerfect=e.pixelPerfect),void 0!==e.metadata&&(s.metadata=e.metadata),e.texture?s.texture=Ar.Parse(e.texture,t,i):e.textureName&&(s.texture=new Ar(i+e.textureUrl,t,!1,void 0===e.invertY||e.invertY));for(const t of e.sprites)nx.Parse(t,s);return s}static ParseFromFileAsync(e,t,i,s=""){return new Promise(((r,n)=>{const o=new Te;o.addEventListener("readystatechange",(()=>{if(4==o.readyState)if(200==o.status){const t=JSON.parse(o.responseText),n=lx.Parse(t,i||x.LastCreatedScene,s);e&&(n.name=e),r(n)}else n("Unable to load the sprite manager")})),o.open("GET",t),o.send()}))}static ParseFromSnippetAsync(e,t,i=""){return"_BLANK"===e?Promise.resolve(new lx("Default sprite manager","//playground.babylonjs.com/textures/player.png",500,64,t)):new Promise(((s,r)=>{const n=new Te;n.addEventListener("readystatechange",(()=>{if(4==n.readyState)if(200==n.status){const r=JSON.parse(JSON.parse(n.responseText).jsonPayload),o=JSON.parse(r.spriteManager),a=lx.Parse(o,t||x.LastCreatedScene,i);a.snippetId=e,s(a)}else r("Unable to load the snippet "+e)})),n.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),n.send()}))}}lx.SnippetUrl="https://snippet.babylonjs.com",lx.CreateFromSnippetAsync=lx.ParseFromSnippetAsync;nt.ShadersStore.spriteMapPixelShader="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)\n#else\n#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)\n#endif\nprecision highp float;varying vec3 vPosition;varying vec2 vUV;varying vec2 tUV;uniform float time;uniform float spriteCount;uniform sampler2D spriteSheet;uniform vec2 spriteMapSize;uniform vec2 outputSize;uniform vec2 stageSize;uniform sampler2D frameMap;uniform sampler2D tileMaps[LAYERS];uniform sampler2D animationMap;uniform vec3 colorMul;float mt;const float fdStep=1./4.;const float aFrameSteps=1./MAX_ANIMATION_FRAMES;mat4 getFrameData(float frameID){float fX=frameID/spriteCount;return mat4(\ntexture2D(frameMap,vec2(fX,0.),0.),\ntexture2D(frameMap,vec2(fX,fdStep*1.),0.),\ntexture2D(frameMap,vec2(fX,fdStep*2.),0.),\nvec4(0.)\n);}\nvoid main(){vec4 color=vec4(0.);vec2 tileUV=fract(tUV);\n#ifdef FLIPU\ntileUV.y=1.0-tileUV.y;\n#endif\nvec2 tileID=floor(tUV);vec2 sheetUnits=1./spriteMapSize;float spriteUnits=1./spriteCount;vec2 stageUnits=1./stageSize;for(int i=0; i<LAYERS; i++) {float frameID;\n#define LAYER_ID_SWITCH\nvec4 animationData=TEXTUREFUNC(animationMap,vec2((frameID+0.5)/spriteCount,0.),0.);if(animationData.y>0.) {mt=mod(time*animationData.z,1.0);for(float f=0.; f<MAX_ANIMATION_FRAMES; f++){if(animationData.y>mt){frameID=animationData.x;break;}\nanimationData=TEXTUREFUNC(animationMap,vec2((frameID+0.5)/spriteCount,aFrameSteps*f),0.);}}\nmat4 frameData=getFrameData(frameID+0.5);vec2 frameSize=(frameData[0].zw)/spriteMapSize;vec2 offset=frameData[0].xy*sheetUnits;vec2 ratio=frameData[2].xy/frameData[0].zw;if (frameData[2].z==1.){tileUV.xy=tileUV.yx;}\nvec4 nc=texture2D(spriteSheet,tileUV*frameSize+offset);if (i==0){color=nc;} else {float alpha=min(color.a+nc.a,1.0);vec3 mixed=mix(color.xyz,nc.xyz,nc.a);color=vec4(mixed,alpha);}}\ncolor.xyz*=colorMul;gl_FragColor=color;}";var hx;nt.ShadersStore.spriteMapVertexShader="precision highp float;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;varying vec3 vPosition;varying vec2 vUV;varying vec2 tUV;varying vec2 stageUnits;varying vec2 levelUnits;varying vec2 tileID;uniform float time;uniform mat4 worldViewProjection;uniform vec2 outputSize;uniform vec2 stageSize;uniform vec2 spriteMapSize;uniform float stageScale;void main() {vec4 p=vec4( position,1. );vPosition=p.xyz;vUV=uv;tUV=uv*stageSize; \ngl_Position=worldViewProjection*p;}",function(e){e[e.INIT=0]="INIT",e[e.RUNNING=1]="RUNNING",e[e.DONE=2]="DONE",e[e.ERROR=3]="ERROR"}(hx||(hx={}));class cx{get resolve(){return this._resolve}get reject(){return this._reject}constructor(){this.promise=new Promise(((e,t)=>{this._resolve=e,this._reject=t}))}}a.prototype.notifyObserversWithPromise=async function(e,t=-1,i,s,r){let n=Promise.resolve(e);if(!this.observers.length)return n;const o=this._eventState;return o.mask=t,o.target=i,o.currentTarget=s,o.skipNextObservers=!1,o.userInfo=r,this.observers.forEach((i=>{o.skipNextObservers||i._willBeUnregistered||i.mask&t&&(n=i.scope?n.then((t=>(o.lastReturnValue=t,i.callback.apply(i.scope,[e,o])))):n.then((t=>(o.lastReturnValue=t,i.callback(e,o)))),i.unregisterOnNextCall&&this._deferUnregister(i))})),await n,e};class ux{getDescription(){return""}apply(e,t){return!0}constructor(e=0){this.priority=e}}class dx extends ux{constructor(){super(...arguments),this._canBeMerged=e=>{if(!(e instanceof ur))return!1;const t=e;return!(t.isDisposed()||!t.isVisible||!t.isEnabled()||t.instances.length>0||t.skeleton||t.hasLODLevels||0===t.getTotalVertices())}}static get UpdateSelectionTree(){return dx._UpdateSelectionTree}static set UpdateSelectionTree(e){dx._UpdateSelectionTree=e}getDescription(){return"Merging similar meshes together"}apply(e,t,i){const s=e.meshes.slice(0);let r=s.length;for(let e=0;e<r;e++){const t=[],i=s[e];if(this._canBeMerged(i)){t.push(i);for(let n=e+1;n<r;n++){const e=s[n];this._canBeMerged(e)&&e.material===i.material&&e.checkCollisions===i.checkCollisions&&(t.push(e),r--,s.splice(n,1),n--)}t.length<2||ur.MergeMeshes(t,void 0,!0)}}const n=e;return n.createOrUpdateSelectionOctree&&(null!=i?i&&n.createOrUpdateSelectionOctree():dx.UpdateSelectionTree&&n.createOrUpdateSelectionOctree()),!0}}dx._UpdateSelectionTree=!1;let px=[];const _x=(e,t)=>{e.doNotSerialize||(t.vertexData.push(e.serializeVerticeData()),px[e.id]=!0)},fx=(e,t)=>{const i={},s=e._geometry;return s&&(e.getScene().getGeometryById(s.id)||_x(s,t.geometries)),e.serialize&&e.serialize(i),i};class mx{static ClearCache(){px=[]}static Serialize(e){return mx._Serialize(e)}static _Serialize(e,t=!0){const i={};if(t&&!e.getEngine()._features.supportSyncTextureRead&&Ar.ForceSerializeBuffers&&console.warn("The serialization object may not contain the proper base64 encoded texture data! You should use the SerializeAsync method instead."),mx.ClearCache(),i.useDelayedTextureLoading=e.useDelayedTextureLoading,i.autoClear=e.autoClear,i.clearColor=e.clearColor.asArray(),i.ambientColor=e.ambientColor.asArray(),i.gravity=e.gravity.asArray(),i.collisionsEnabled=e.collisionsEnabled,i.useRightHandedSystem=e.useRightHandedSystem,e.fogMode&&0!==e.fogMode&&(i.fogMode=e.fogMode,i.fogColor=e.fogColor.asArray(),i.fogStart=e.fogStart,i.fogEnd=e.fogEnd,i.fogDensity=e.fogDensity),e.isPhysicsEnabled&&e.isPhysicsEnabled()){const t=e.getPhysicsEngine();t&&(i.physicsEnabled=!0,i.physicsGravity=t.gravity.asArray(),i.physicsEngine=t.getPhysicsPluginName())}e.metadata&&(i.metadata=e.metadata),i.morphTargetManagers=[];for(const t of e.meshes){const e=t.morphTargetManager;e&&i.morphTargetManagers.push(e.serialize())}let s,r,n;for(i.lights=[],s=0;s<e.lights.length;s++)r=e.lights[s],r.doNotSerialize||i.lights.push(r.serialize());for(i.cameras=[],s=0;s<e.cameras.length;s++){const t=e.cameras[s];t.doNotSerialize||i.cameras.push(t.serialize())}if(e.activeCamera&&(i.activeCameraID=e.activeCamera.id),de.AppendSerializedAnimations(e,i),e.animationGroups&&e.animationGroups.length>0){i.animationGroups=[];for(let t=0;t<e.animationGroups.length;t++){const s=e.animationGroups[t];i.animationGroups.push(s.serialize())}}if(e.reflectionProbes&&e.reflectionProbes.length>0)for(i.reflectionProbes=[],s=0;s<e.reflectionProbes.length;s++){const t=e.reflectionProbes[s];i.reflectionProbes.push(t.serialize())}for(i.materials=[],i.multiMaterials=[],s=0;s<e.materials.length;s++)n=e.materials[s],n.doNotSerialize||i.materials.push(n.serialize());for(i.multiMaterials=[],s=0;s<e.multiMaterials.length;s++){const t=e.multiMaterials[s];i.multiMaterials.push(t.serialize())}for(e.environmentTexture&&(e.environmentTexture._files?i.environmentTexture=e.environmentTexture.serialize():(i.environmentTexture=e.environmentTexture.name,i.environmentTextureRotationY=e.environmentTexture.rotationY)),i.environmentIntensity=e.environmentIntensity,i.skeletons=[],s=0;s<e.skeletons.length;s++){const t=e.skeletons[s];t.doNotSerialize||i.skeletons.push(t.serialize())}for(i.transformNodes=[],s=0;s<e.transformNodes.length;s++)e.transformNodes[s].doNotSerialize||i.transformNodes.push(e.transformNodes[s].serialize());i.geometries={},i.geometries.boxes=[],i.geometries.spheres=[],i.geometries.cylinders=[],i.geometries.toruses=[],i.geometries.grounds=[],i.geometries.planes=[],i.geometries.torusKnots=[],i.geometries.vertexData=[],px=[];const o=e.getGeometries();for(s=0;s<o.length;s++){const e=o[s];e.isReady()&&_x(e,i.geometries)}for(i.meshes=[],s=0;s<e.meshes.length;s++){const t=e.meshes[s];if(t instanceof ur){const e=t;e.doNotSerialize||1!==e.delayLoadState&&0!==e.delayLoadState||i.meshes.push(fx(e,i))}}for(i.particleSystems=[],s=0;s<e.particleSystems.length;s++)i.particleSystems.push(e.particleSystems[s].serialize(!1));for(i.postProcesses=[],s=0;s<e.postProcesses.length;s++)i.postProcesses.push(e.postProcesses[s].serialize());e.actionManager&&(i.actions=e.actionManager.serialize("scene"));for(const t of e._serializableComponents)t.serialize(i);return i}static SerializeAsync(e){const t=mx._Serialize(e,!1),i=[];return this._CollectPromises(t,i),Promise.all(i).then((()=>t))}static _CollectPromises(e,t){if(Array.isArray(e))for(let i=0;i<e.length;++i){const s=e[i];s instanceof Promise?t.push(s.then((t=>e[i]=t))):(s instanceof Object||Array.isArray(s))&&this._CollectPromises(s,t)}else if(e instanceof Object)for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i)){const s=e[i];s instanceof Promise?t.push(s.then((t=>e[i]=t))):(s instanceof Object||Array.isArray(s))&&this._CollectPromises(s,t)}}static SerializeMesh(e,t=!1,i=!1){const s={meshes:[],transformNodes:[],cameras:[],lights:[]};if(mx.ClearCache(),e=e instanceof Array?e:[e],t||i)for(let s=0;s<e.length;++s)i&&e[s].getDescendants().forEach((t=>{e.indexOf(t)<0&&!t.doNotSerialize&&e.push(t)})),t&&e[s].parent&&e.indexOf(e[s].parent)<0&&!e[s].parent.doNotSerialize&&e.push(e[s].parent);return e.forEach((e=>{((e,t)=>{if(e._isMesh){const i=e;if(1===i.delayLoadState||0===i.delayLoadState){const e=e=>{t.materials=t.materials||[],i.material&&!t.materials.some((e=>e.id===i.material.id))&&t.materials.push(e.serialize())};if(i.material&&!i.material.doNotSerialize)if(i.material instanceof rr){if(t.multiMaterials=t.multiMaterials||[],!t.multiMaterials.some((e=>e.id===i.material.id))){t.multiMaterials.push(i.material.serialize());for(const t of i.material.subMaterials)t&&e(t)}}else e(i.material);else i.material||e(i.getScene().defaultMaterial);const s=i._geometry;s&&(t.geometries||(t.geometries={},t.geometries.boxes=[],t.geometries.spheres=[],t.geometries.cylinders=[],t.geometries.toruses=[],t.geometries.grounds=[],t.geometries.planes=[],t.geometries.torusKnots=[],t.geometries.vertexData=[]),_x(s,t.geometries)),i.skeleton&&!i.skeleton.doNotSerialize&&(t.skeletons=t.skeletons||[],t.skeletons.push(i.skeleton.serialize())),t.meshes=t.meshes||[],t.meshes.push(fx(i,t))}}else if("TransformNode"===e.getClassName()){const i=e;t.transformNodes.push(i.serialize())}else if(-1!==e.getClassName().indexOf("Camera")){const i=e;t.cameras.push(i.serialize())}else if(-1!==e.getClassName().indexOf("Light")){const i=e;t.lights.push(i.serialize())}})(e,s)})),s}}class gx{static IsSupported(e){const t=e.getRenderingCanvas();return!!t&&"function"==typeof t.captureStream}get isRecording(){return!!this._canvas&&this._canvas.isRecording}constructor(e,t={}){if(!gx.IsSupported(e))throw"Your browser does not support recording so far.";const i=e.getRenderingCanvas();if(!i)throw"The babylon engine must have a canvas to be recorded";this._canvas=i,this._canvas.isRecording=!1,this._options=Object.assign(Object.assign({},gx._DefaultOptions),t);const s=this._canvas.captureStream(this._options.fps);if(this._options.audioTracks)for(const e of this._options.audioTracks)s.addTrack(e);this._mediaRecorder=new MediaRecorder(s,{mimeType:this._options.mimeType}),this._mediaRecorder.ondataavailable=e=>this._handleDataAvailable(e),this._mediaRecorder.onerror=e=>this._handleError(e),this._mediaRecorder.onstop=()=>this._handleStop()}stopRecording(){this._canvas&&this._mediaRecorder&&this.isRecording&&(this._canvas.isRecording=!1,this._mediaRecorder.stop())}startRecording(e="babylonjs.webm",t=7){if(!this._canvas||!this._mediaRecorder)throw"Recorder has already been disposed";if(this.isRecording)throw"Recording already in progress";return t>0&&setTimeout((()=>{this.stopRecording()}),1e3*t),this._fileName=e,this._recordedChunks=[],this._resolve=null,this._reject=null,this._canvas.isRecording=!0,this._mediaRecorder.start(this._options.recordChunckSize),new Promise(((e,t)=>{this._resolve=e,this._reject=t}))}dispose(){this._canvas=null,this._mediaRecorder=null,this._recordedChunks=[],this._fileName=null,this._resolve=null,this._reject=null}_handleDataAvailable(e){e.data.size>0&&this._recordedChunks.push(e.data)}_handleError(e){if(this.stopRecording(),!this._reject)throw new e.error;this._reject(e.error)}_handleStop(){this.stopRecording();const e=new Blob(this._recordedChunks);this._resolve&&this._resolve(e),window.URL.createObjectURL(e),this._fileName&&Ht.Download(e,this._fileName)}}gx._DefaultOptions={mimeType:"video/webm",fps:25,recordChunckSize:3e3};let vx=null;function xx(e,t,i,s,r="image/png",n=!1,o){const{height:a,width:l}=Ex(e,t,i);if(!a||!l)return void k.Error("Invalid 'size' parameter !");vx||(vx=document.createElement("canvas")),vx.width=l,vx.height=a;const h=vx.getContext("2d"),c=e.getRenderWidth()/e.getRenderHeight();let u=l,d=u/c;d>a&&(d=a,u=d*c);const p=Math.max(0,l-u)/2,_=Math.max(0,a-d)/2;t.getScene().activeCamera!==t?Tx(e,t,i,(e=>{if(n){const t=new Blob([e]);Ht.DownloadBlob(t),s&&s("")}else s&&s(e)}),r,1,e.getCreationOptions().antialias,void 0,void 0,void 0,void 0,o):e.onEndFrameObservable.addOnce((()=>{const t=e.getRenderingCanvas();h&&t&&h.drawImage(t,p,_,u,d),vx&&(n?(Ht.EncodeScreenshotCanvasData(vx,void 0,r,void 0,o),s&&s("")):Ht.EncodeScreenshotCanvasData(vx,s,r,void 0,o))}))}function Tx(e,t,i,s,r="image/png",n=1,o=!1,a,l=!1,h=!1,c=!0,u,d){const{height:p,width:_,finalWidth:f,finalHeight:m}=Ex(e,t,i),g={width:_,height:p};if(!p||!_)return void k.Error("Invalid 'size' parameter !");const v={width:e.getRenderWidth(),height:e.getRenderHeight()};e.setSize(_,p);const x=t.getScene(),T=new Bn("screenShot",g,x,!1,!1,0,!1,Ar.BILINEAR_SAMPLINGMODE,void 0,h,void 0,void 0,void 0,n);T.renderList=x.meshes.slice(),T.samples=n,T.renderSprites=l,T.activeCamera=t,T.forceLayerMaskCheck=c,null==d||d(T);const E=()=>{T.isReadyForRendering()&&t.isReady(!0)?(e.onEndFrameObservable.addOnce((()=>{f===_&&m===p?T.readPixels(void 0,void 0,void 0,!1).then((e=>{Ln.DumpData(_,p,e,s,r,a,!0,void 0,u),T.dispose()})):Ah("pass",T.getInternalTexture(),x,void 0,void 0,void 0,f,m).then((t=>{e._readTexturePixels(t,f,m,-1,0,null,!0,!1,0,0).then((e=>{Ln.DumpData(f,m,e,s,r,a,!0,void 0,u),t.dispose()}))}))})),T.render(!0),x.incrementRenderId(),x.resetCachedMaterial(),e.setSize(v.width,v.height),t.getProjectionMatrix(!0),x.render()):setTimeout(E,16)},S=()=>{x.incrementRenderId(),x.resetCachedMaterial(),E()};if(o){const e=new sv("antialiasing",1,x.activeCamera);T.addPostProcess(e),e.getEffect().isReady()?S():e.getEffect().onCompiled=()=>{S()}}else S()}function Ex(e,t,i){let s=0,r=0,n=0,o=0;if("object"==typeof i){const a=i.precision?Math.abs(i.precision):1;i.width&&i.height?(s=i.height*a,r=i.width*a):i.width&&!i.height?(r=i.width*a,s=Math.round(r/e.getAspectRatio(t))):i.height&&!i.width?(s=i.height*a,r=Math.round(s*e.getAspectRatio(t))):(r=Math.round(e.getRenderWidth()*a),s=Math.round(r/e.getAspectRatio(t))),i.finalWidth&&i.finalHeight?(o=i.finalHeight,n=i.finalWidth):i.finalWidth&&!i.finalHeight?(n=i.finalWidth,o=Math.round(n/e.getAspectRatio(t))):i.finalHeight&&!i.finalWidth?(o=i.finalHeight,n=Math.round(o*e.getAspectRatio(t))):(n=r,o=s)}else isNaN(i)||(s=i,r=i,n=i,o=i);return r&&(r=Math.floor(r)),s&&(s=Math.floor(s)),n&&(n=Math.floor(n)),o&&(o=Math.floor(o)),{height:0|s,width:0|r,finalWidth:0|n,finalHeight:0|o}}var Sx,bx;Ht.CreateScreenshot=xx,Ht.CreateScreenshotAsync=function(e,t,i,s="image/png",r){return new Promise(((n,o)=>{xx(e,t,i,(e=>{void 0!==e?n(e):o(new Error("Data is undefined"))}),s,void 0,r)}))},Ht.CreateScreenshotUsingRenderTarget=Tx,Ht.CreateScreenshotUsingRenderTargetAsync=function(e,t,i,s="image/png",r=1,n=!1,o,a=!1,l=!1,h=!0,c){return new Promise(((u,d)=>{Tx(e,t,i,(e=>{void 0!==e?u(e):d(new Error("Data is undefined"))}),s,r,n,o,a,l,h,c)}))},function(e){e[e.Checkbox=0]="Checkbox",e[e.Slider=1]="Slider",e[e.Vector3=2]="Vector3",e[e.Quaternion=3]="Quaternion",e[e.Color3=4]="Color3",e[e.String=5]="String",e[e.Button=6]="Button",e[e.Options=7]="Options",e[e.Tab=8]="Tab",e[e.FileButton=9]="FileButton",e[e.Vector2=10]="Vector2"}(Sx||(Sx={}));class Cx{constructor(e){this.byteOffset=0,this.buffer=e}loadAsync(e){return this.buffer.readAsync(this.byteOffset,e).then((e=>{this._dataView=new DataView(e.buffer,e.byteOffset,e.byteLength),this._dataByteOffset=0}))}readUint32(){const e=this._dataView.getUint32(this._dataByteOffset,!0);return this._dataByteOffset+=4,this.byteOffset+=4,e}readUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,e);return this._dataByteOffset+=e,this.byteOffset+=e,t}readString(e){return(e=>{if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);let t="";for(let i=0;i<e.byteLength;i++)t+=String.fromCharCode(e[i]);return t})(this.readUint8Array(e))}skipBytes(e){this._dataByteOffset+=e,this.byteOffset+=e}}class yx{static _GetStorage(){try{return localStorage.setItem("test",""),localStorage.removeItem("test"),localStorage}catch(e){const t={};return{getItem:e=>{const i=t[e];return void 0===i?null:i},setItem:(e,i)=>{t[e]=i}}}}static ReadString(e,t){const i=this._Storage.getItem(e);return null!==i?i:t}static WriteString(e,t){this._Storage.setItem(e,t)}static ReadBoolean(e,t){const i=this._Storage.getItem(e);return null!==i?"true"===i:t}static WriteBoolean(e,t){this._Storage.setItem(e,t?"true":"false")}static ReadNumber(e,t){const i=this._Storage.getItem(e);return null!==i?parseFloat(i):t}static WriteNumber(e,t){this._Storage.setItem(e,t.toString())}}yx._Storage=yx._GetStorage(),function(e){class t{serialize(){const e={},t=new Array(this._characterToIdx.size);return this._characterToIdx.forEach(((e,i)=>{t[e]=i})),e.characters=t,e.insertionCosts=this._insertionCosts,e.deletionCosts=this._deletionCosts,e.substitutionCosts=this._substitutionCosts,JSON.stringify(e)}static Deserialize(e){const i=JSON.parse(e),s=new t(i.characters);return s._insertionCosts=i.insertionCosts,s._deletionCosts=i.deletionCosts,s._substitutionCosts=i.substitutionCosts,s}constructor(e,t=null,i=null,s=null){let r;t=null!=t?t:()=>1,i=null!=i?i:()=>1,s=null!=s?s:(e,t)=>e===t?0:1,this._characterToIdx=new Map,this._insertionCosts=new Array(e.length),this._deletionCosts=new Array(e.length),this._substitutionCosts=new Array(e.length);for(let n=0;n<e.length;++n){r=e[n],this._characterToIdx.set(r,n),this._insertionCosts[n]=t(r),this._deletionCosts[n]=i(r),this._substitutionCosts[n]=new Array(e.length);for(let t=n;t<e.length;++t)this._substitutionCosts[n][t]=s(r,e[t])}}getCharacterIdx(e){return this._characterToIdx.get(e)}getInsertionCost(e){return this._insertionCosts[e]}getDeletionCost(e){return this._deletionCosts[e]}getSubstitutionCost(e,t){const i=Math.min(e,t),s=Math.max(e,t);return this._substitutionCosts[i][s]}}e.Alphabet=t;class i{serialize(){return JSON.stringify(this._characters)}static Deserialize(e,t){const s=new i([],t);return s._characters=JSON.parse(e),s}constructor(e,t){if(e.length>i._MAX_SEQUENCE_LENGTH)throw new Error("Sequences longer than "+i._MAX_SEQUENCE_LENGTH+" not supported.");this._alphabet=t,this._characters=e.map((e=>this._alphabet.getCharacterIdx(e)))}distance(e){return i._Distance(this,e)}static _Distance(e,t){const s=e._alphabet;if(s!==t._alphabet)throw new Error("Cannot Levenshtein compare Sequences built from different alphabets.");const r=e._characters,n=t._characters,o=r.length,a=n.length,l=i._CostMatrix;l[0][0]=0;for(let e=0;e<o;++e)l[e+1][0]=l[e][0]+s.getInsertionCost(r[e]);for(let e=0;e<a;++e)l[0][e+1]=l[0][e]+s.getInsertionCost(n[e]);for(let e=0;e<o;++e)for(let t=0;t<a;++t)i._InsertionCost=l[e+1][t]+s.getInsertionCost(n[t]),i._DeletionCost=l[e][t+1]+s.getDeletionCost(r[e]),i._SubstitutionCost=l[e][t]+s.getSubstitutionCost(r[e],n[t]),l[e+1][t+1]=Math.min(i._InsertionCost,i._DeletionCost,i._SubstitutionCost);return l[o][a]}}i._MAX_SEQUENCE_LENGTH=256,i._CostMatrix=[...Array(i._MAX_SEQUENCE_LENGTH+1)].map((()=>new Array(i._MAX_SEQUENCE_LENGTH+1))),e.Sequence=i}(bx||(bx={}));class Ax{serialize(){return JSON.stringify(this)}static Deserialize(e){const t=JSON.parse(e),i=new Ax(t._segmentLength);return i._points=t._points.map((e=>new S(e._x,e._y,e._z))),i}constructor(e=.01){this._points=[],this._segmentLength=e}getLength(){return this._points.length*this._segmentLength}add(e){let t=this._points.length;if(0===t)this._points.push(e.clone());else{const i=()=>this._segmentLength/S.Distance(this._points[t-1],e);for(let s=i();s<=1;s=i()){const i=this._points[t-1].scale(1-s);e.scaleAndAddToRef(s,i),this._points.push(i),++t}}}resampleAtTargetResolution(e){const t=new Ax(this.getLength()/e);return this._points.forEach((e=>{t.add(e)})),t}tokenize(e){const t=[],i=new S;for(let s=2;s<this._points.length;++s)Ax._TransformSegmentDirToRef(this._points[s-2],this._points[s-1],this._points[s],i)&&t.push(Ax._TokenizeSegment(i,e));return t}static _TransformSegmentDirToRef(e,t,i,s){return t.subtractToRef(e,Ax._ForwardDir),Ax._ForwardDir.normalize(),t.scaleToRef(-1,Ax._InverseFromVec),Ax._InverseFromVec.normalize(),!(Math.abs(S.Dot(Ax._ForwardDir,Ax._InverseFromVec))>.98||(S.CrossToRef(Ax._ForwardDir,Ax._InverseFromVec,Ax._UpDir),Ax._UpDir.normalize(),y.LookAtLHToRef(e,t,Ax._UpDir,Ax._LookMatrix),i.subtractToRef(t,Ax._FromToVec),Ax._FromToVec.normalize(),S.TransformNormalToRef(Ax._FromToVec,Ax._LookMatrix,s),0))}static _TokenizeSegment(e,t){Ax._BestMatch=0,Ax._Score=S.Dot(e,t[0]),Ax._BestScore=Ax._Score;for(let i=1;i<t.length;++i)Ax._Score=S.Dot(e,t[i]),Ax._Score>Ax._BestScore&&(Ax._BestMatch=i,Ax._BestScore=Ax._Score);return Ax._BestMatch}}Ax._ForwardDir=new S,Ax._InverseFromVec=new S,Ax._UpDir=new S,Ax._FromToVec=new S,Ax._LookMatrix=new y;class Rx{serialize(){return JSON.stringify(this._sequences.map((e=>e.serialize())))}static Deserialize(e,t){const i=new Rx;return i._sequences=JSON.parse(e).map((e=>bx.Sequence.Deserialize(e,t))),i}static CreateFromTrajectory(e,t,i){return Rx.CreateFromTokenizationPyramid(Rx._GetTokenizationPyramid(e,t),i)}static CreateFromTokenizationPyramid(e,t){const i=new Rx;return i._sequences=e.map((e=>new bx.Sequence(e,t))),i}constructor(){this._sequences=[]}static _GetTokenizationPyramid(e,t,i=Rx._FINEST_DESCRIPTOR_RESOLUTION){const s=[];for(let r=i;r>4;r=Math.floor(r/2))s.push(e.resampleAtTargetResolution(r).tokenize(t.chars));return s}distance(e){let t,i=0;for(let s=0;s<this._sequences.length;++s)t=Math.pow(2,s),i+=t*this._sequences[s].distance(e._sequences[s]);return i}}Rx._FINEST_DESCRIPTOR_RESOLUTION=32;class Ix{serialize(){const e={};return e.descriptors=this._descriptors.map((e=>e.serialize())),e.centroidIdx=this._centroidIdx,e.averageDistance=this._averageDistance,JSON.stringify(e)}static Deserialize(e,t){const i=JSON.parse(e),s=new Ix;return s._descriptors=i.descriptors.map((e=>Rx.Deserialize(e,t))),s._centroidIdx=i.centroidIdx,s._averageDistance=i.averageDistance,s}constructor(e=[]){this._descriptors=e,this._centroidIdx=-1,this._averageDistance=0,this._refreshDescription()}add(e){this._descriptors.push(e),this._refreshDescription()}getMatchCost(e){return e.distance(this._descriptors[this._centroidIdx])/this._averageDistance}getMatchMinimumDistance(e){return Math.min(...this._descriptors.map((t=>t.distance(e))))}_refreshDescription(){let e;this._centroidIdx=-1;const t=this._descriptors.map((t=>(e=0,this._descriptors.forEach((i=>{e+=t.distance(i)})),e)));for(let e=0;e<t.length;++e)(this._centroidIdx<0||t[e]<t[this._centroidIdx])&&(this._centroidIdx=e);this._averageDistance=0,this._descriptors.forEach((e=>{this._averageDistance+=e.distance(this._descriptors[this._centroidIdx])})),this._descriptors.length>0&&(this._averageDistance=Math.max(this._averageDistance/this._descriptors.length,Ix._MIN_AVERAGE_DISTANCE))}}Ix._MIN_AVERAGE_DISTANCE=1;class Px{constructor(e,t,i){this._scene=e,k.Log(`[Reflector] Connecting to ws://${t}:${i}`),this._webSocket=new WebSocket(`ws://${t}:${i}`),this._webSocket.onmessage=e=>{const t=e.data;if(t.startsWith(Px._SERVER_PREFIX)){const e=t.substr(Px._SERVER_PREFIX.length);return k.Log(`[Reflector] Received server message: ${e.substr(0,64)}`),void this._handleServerMessage(e)}k.Log(`[Reflector] Received client message: ${t.substr(0,64)}`),this._handleClientMessage()},this._webSocket.onclose=e=>{k.Log(`[Reflector] Disconnected ${e.code} ${e.reason}`)}}close(){this._webSocket.close()}_handleServerMessage(e){"connected"===e&&mx.SerializeAsync(this._scene).then((e=>{this._webSocket.send(`load|${JSON.stringify(e)}`)}))}_handleClientMessage(){}}Px._SERVER_PREFIX="$$";class Mx{constructor(e){this._view=new Float32Array(e),this._itemLength=0}get itemLength(){return this._itemLength}at(e){return e<0||e>=this._itemLength?NaN:this._view[e]}subarray(e,t){return e>=t||e<0?new Float32Array(0):(t>this._itemLength&&(t=this._itemLength),this._view.subarray(e,t))}push(e){this._view[this._itemLength]=e,this._itemLength++,this._itemLength>=this._view.length&&this._growArray()}_growArray(){const e=Math.floor(1.5*this._view.length),t=new Float32Array(e);t.set(this._view),this._view=t}}const Ox=1800,Dx="timestamp",Nx="numPoints",Fx=/\r/g;class wx{static get SliceDataOffset(){return 2}static get NumberOfPointsOffset(){return 1}constructor(e,t){this._scene=e,this._collectDataAtFrame=()=>{const e=Fe.Now-this._startingTimestamp,t=this.datasets.ids.length,i=this.datasets.startingIndices.itemLength;let s=0;if(i>0){const e=this.datasets.startingIndices.at(i-1);s=e+this.datasets.data.at(e+wx.NumberOfPointsOffset)+wx.SliceDataOffset}if(this.datasets.startingIndices.push(s),this.datasets.data.push(e),this.datasets.data.push(t),this.datasets.ids.forEach((e=>{const t=this._strategies.get(e);t&&this.datasets.data.push(t.getData())})),this.datasetObservable.hasObservers()){const i=[e,t];for(let e=0;e<t;e++)i.push(this.datasets.data.at(s+wx.SliceDataOffset+e));this.datasetObservable.notifyObservers(i)}},this.datasets={ids:[],data:new Mx(Ox),startingIndices:new Mx(Ox)},this._strategies=new Map,this._datasetMeta=new Map,this._eventRestoreSet=new Set,this._customEventObservable=new a,this.datasetObservable=new a,this.metadataObservable=new a((e=>e.callback(this._datasetMeta,new n(0)))),t&&this.addCollectionStrategies(...t)}registerEvent(e,t,i){var s;if(this._strategies.has(e)&&!t)return;this._strategies.has(e)&&t&&(null===(s=this._strategies.get(e))||void 0===s||s.dispose(),this._strategies.delete(e));const r={name:e};return this._eventRestoreSet.add(e),this.addCollectionStrategies({strategyCallback:t=>{let i=0,s=0;const r=t.onAfterRenderObservable.add((()=>{s=i,i=0})),n=this._customEventObservable.add((t=>{e===t.name&&(void 0!==t.value?i=t.value:i++)}));return{id:e,getData:()=>s,dispose:()=>{t.onAfterRenderObservable.remove(r),this._customEventObservable.remove(n)}}},category:i}),r}sendEvent(e){this._customEventObservable.notifyObservers(e)}_restoreStringEvents(){this._eventRestoreSet.size!==this._customEventObservable.observers.length&&this._eventRestoreSet.forEach((e=>{this.registerEvent(e,!0)}))}addCollectionStrategies(...e){for(let{strategyCallback:t,category:i,hidden:s}of e){const e=t(this._scene);this._strategies.has(e.id)?e.dispose():(this.datasets.ids.push(e.id),i&&(i=i.replace(new RegExp("@","g"),"")),this._datasetMeta.set(e.id,{color:this._getHexColorFromId(e.id),category:i,hidden:s}),this._strategies.set(e.id,e))}this.metadataObservable.notifyObservers(this._datasetMeta)}_getHexColorFromId(e){let t=0;for(let i=0;i<e.length;i++)t=e.charCodeAt(i)+((t<<5)-t);let i="#";for(let e=0;e<24;e+=8)i+=("0"+(t>>e&255).toString(16)).substr(-2);return i}getCurrentSlice(){const e=[Fe.Now-this._startingTimestamp,this.datasets.ids.length];this.datasets.ids.forEach((t=>{const i=this._strategies.get(t);i&&this.datasetObservable.hasObservers()&&e.push(i.getData())})),this.datasetObservable.hasObservers()&&this.datasetObservable.notifyObservers(e)}updateMetadata(e,t,i){const s=this._datasetMeta.get(e);s&&(s[t]=i,this.metadataObservable.notifyObservers(this._datasetMeta))}clear(e){this.datasets.data=new Mx(Ox),this.datasets.ids.length=0,this.datasets.startingIndices=new Mx(Ox),this._datasetMeta.clear(),this._strategies.forEach((e=>e.dispose())),this._strategies.clear(),e||this._eventRestoreSet.clear(),this._hasLoadedData=!1}get hasLoadedData(){return this._hasLoadedData}loadFromFileData(e,t){const i=e.replace(Fx,"").split("\n").map((e=>e.split(",").filter((e=>e.length>0)))).filter((e=>e.length>0)),s=wx.NumberOfPointsOffset;if(i.length<2)return!1;const r={ids:[],data:new Mx(Ox),startingIndices:new Mx(Ox)},[n,...o]=i;if(n.length<2||n[0]!==Dx||n[s]!==Nx)return!1;const a=new Map;for(let e=wx.SliceDataOffset;e<n.length;e++){const[t,i]=n[e].split("@");r.ids.push(t),a.set(t,i)}let l=0;for(const e of o){if(e.length<2)return!1;const t=parseFloat(e[0]),i=parseInt(e[s]);if(isNaN(i)||isNaN(t))return!1;if(r.data.push(t),r.data.push(i),i+wx.SliceDataOffset!==e.length)return!1;for(let t=wx.SliceDataOffset;t<e.length;t++){const i=parseFloat(e[t]);if(isNaN(i))return!1;r.data.push(i)}r.startingIndices.push(l),l+=e.length}if(this.datasets.ids=r.ids,this.datasets.data=r.data,this.datasets.startingIndices=r.startingIndices,t||this._datasetMeta.clear(),this._strategies.forEach((e=>e.dispose())),this._strategies.clear(),!t)for(const e of this.datasets.ids){const t=a.get(e);this._datasetMeta.set(e,{category:t,color:this._getHexColorFromId(e)})}return this.metadataObservable.notifyObservers(this._datasetMeta),this._hasLoadedData=!0,!0}exportDataToCsv(){let e="";e+=`${Dx},${Nx}`;for(let t=0;t<this.datasets.ids.length;t++)if(e+=`,${this.datasets.ids[t]}`,this._datasetMeta){const i=this._datasetMeta.get(this.datasets.ids[t]);(null==i?void 0:i.category)&&(e+=`@${i.category}`)}e+="\n";for(let t=0;t<this.datasets.startingIndices.itemLength;t++){const i=this.datasets.startingIndices.at(t),s=this.datasets.data.at(i),r=this.datasets.data.at(i+wx.NumberOfPointsOffset);e+=`${s},${r}`;for(let t=0;t<r;t++)e+=`,${this.datasets.data.at(i+wx.SliceDataOffset+t)}`;for(let t=0;t<this.datasets.ids.length-r;t++)e+=",";e+="\n"}const t=`${(new Date).toISOString()}-perfdata.csv`;Ht.Download(new Blob([e],{type:"text/csv"}),t)}start(e){e?void 0===this._startingTimestamp&&(this._startingTimestamp=Fe.Now):(this.datasets.data=new Mx(Ox),this.datasets.startingIndices=new Mx(Ox),this._startingTimestamp=Fe.Now),this._scene.onAfterRenderObservable.add(this._collectDataAtFrame),this._restoreStringEvents(),this._isStarted=!0}stop(){this._scene.onAfterRenderObservable.removeCallback(this._collectDataAtFrame),this._isStarted=!1}get isStarted(){return this._isStarted}dispose(){this._scene.onAfterRenderObservable.removeCallback(this._collectDataAtFrame),this._datasetMeta.clear(),this._strategies.forEach((e=>{e.dispose()})),this.datasetObservable.clear(),this.metadataObservable.clear(),this._isStarted=!1,this.datasets=null}}Yi.prototype.getPerfCollector=function(){return this._perfCollector||(this._perfCollector=new wx(this)),this._perfCollector},a.prototype.runCoroutineAsync=function(e){if(!this._coroutineScheduler){const e=function(e){const t=new Array,i=new Array,s=new Array,r=e.add((()=>{const e=t.length;for(let r=0;r<e;r++)ls(t.shift(),i.shift(),s.shift())}));return{scheduler:(e,r,n)=>{t.push(e),i.push(r),s.push(n)},dispose:()=>{e.remove(r)}}}(this);this._coroutineScheduler=e.scheduler,this._coroutineSchedulerDispose=e.dispose}return us(e,this._coroutineScheduler)},a.prototype.cancelAllCoroutines=function(){this._coroutineSchedulerDispose&&this._coroutineSchedulerDispose(),this._coroutineScheduler=void 0,this._coroutineSchedulerDispose=void 0};nt.ShadersStore.equirectangularPanoramaPixelShader="#ifdef GL_ES\nprecision highp float;\n#endif\n#define M_PI 3.1415926535897932384626433832795\nvarying vec2 vUV;uniform samplerCube cubeMap;void main(void) {vec2 uv=vUV;float longitude=uv.x*2.*M_PI-M_PI+M_PI/2.;float latitude=(1.-uv.y)*M_PI;vec3 dir=vec3(\n- sin( longitude )*sin( latitude ),\ncos( latitude ),\n- cos( longitude )*sin( latitude )\n);normalize( dir );gl_FragColor=textureCube( cubeMap,dir );}";class Lx extends Gr{constructor(e,t={}){super(e),this.options=t,this._direction=new S(0,0,-1),this._mat=new y,this._onSelectEnabled=!1,this._origin=new S(0,0,0),this.lastNativeXRHitResults=[],this.onHitTestResultObservable=new a,this._onHitTestResults=e=>{const t=e.map((e=>{const t=y.FromArray(e.hitMatrix);return this._xrSessionManager.scene.useRightHandedSystem||t.toggleModelMatrixHandInPlace(),this.options.worldParentNode&&t.multiplyToRef(this.options.worldParentNode.getWorldMatrix(),t),{xrHitResult:e,transformationMatrix:t}}));this.lastNativeXRHitResults=e,this.onHitTestResultObservable.notifyObservers(t)},this._onSelect=e=>{this._onSelectEnabled&&Lx.XRHitTestWithSelectEvent(e,this._xrSessionManager.referenceSpace)},this.xrNativeFeatureName="hit-test",Ht.Warn("A newer version of this plugin is available")}static XRHitTestWithRay(e,t,i,s){return e.requestHitTest(t,i).then((e=>{const t=s||(e=>!!e.hitMatrix);return e.filter(t)}))}static XRHitTestWithSelectEvent(e,t){const i=e.frame.getPose(e.inputSource.targetRaySpace,t);if(!i)return Promise.resolve([]);const s=new XRRay(i.transform);return this.XRHitTestWithRay(e.frame.session,s,t)}attach(){return!!super.attach()&&(this.options.testOnPointerDownOnly&&this._xrSessionManager.session.addEventListener("select",this._onSelect,!1),!0)}detach(){return!!super.detach()&&(this._onSelectEnabled=!1,this._xrSessionManager.session.removeEventListener("select",this._onSelect),!0)}dispose(){super.dispose(),this.onHitTestResultObservable.clear()}_onXRFrame(e){if(!this.attached||this.options.testOnPointerDownOnly)return;const t=e.getViewerPose(this._xrSessionManager.referenceSpace);if(!t)return;y.FromArrayToRef(t.transform.matrix,0,this._mat),S.TransformCoordinatesFromFloatsToRef(0,0,0,this._mat,this._origin),S.TransformCoordinatesFromFloatsToRef(0,0,-1,this._mat,this._direction),this._direction.subtractInPlace(this._origin),this._direction.normalize();const i=new XRRay({x:this._origin.x,y:this._origin.y,z:this._origin.z,w:0},{x:this._direction.x,y:this._direction.y,z:this._direction.z,w:0});Lx.XRHitTestWithRay(this._xrSessionManager.session,i,this._xrSessionManager.referenceSpace).then(this._onHitTestResults)}}Lx.Name=Vr.HIT_TEST,Lx.Version=1,kr.AddWebXRFeature(Lx.Name,((e,t)=>()=>new Lx(e,t)),Lx.Version,!1);let Bx=0;class Ux extends Gr{set referenceSpaceForFrameAnchors(e){this._referenceSpaceForFrameAnchors=e}constructor(e,t={}){super(e),this._options=t,this._lastFrameDetected=new Set,this._trackedAnchors=[],this._futureAnchors=[],this.onAnchorAddedObservable=new a,this.onAnchorRemovedObservable=new a,this.onAnchorUpdatedObservable=new a,this._tmpVector=new S,this._tmpQuaternion=new C,this.xrNativeFeatureName="anchors"}_populateTmpTransformation(e,t){return this._tmpVector.copyFrom(e),this._tmpQuaternion.copyFrom(t),this._xrSessionManager.scene.useRightHandedSystem||(this._tmpVector.z*=-1,this._tmpQuaternion.z*=-1,this._tmpQuaternion.w*=-1),{position:this._tmpVector,rotationQuaternion:this._tmpQuaternion}}async addAnchorPointUsingHitTestResultAsync(e,t=new S,i=new C){this._populateTmpTransformation(t,i);const s=new XRRigidTransform({x:this._tmpVector.x,y:this._tmpVector.y,z:this._tmpVector.z},{x:this._tmpQuaternion.x,y:this._tmpQuaternion.y,z:this._tmpQuaternion.z,w:this._tmpQuaternion.w});if(!e.xrHitResult.createAnchor)throw this.detach(),new Error("Anchors not enabled in this environment/browser");try{const t=await e.xrHitResult.createAnchor(s);return new Promise(((e,i)=>{this._futureAnchors.push({nativeAnchor:t,resolved:!1,submitted:!0,xrTransformation:s,resolve:e,reject:i})}))}catch(e){throw new Error(e)}}async addAnchorAtPositionAndRotationAsync(e,t=new C,i=!1){this._populateTmpTransformation(e,t);const s=new XRRigidTransform({x:this._tmpVector.x,y:this._tmpVector.y,z:this._tmpVector.z},{x:this._tmpQuaternion.x,y:this._tmpQuaternion.y,z:this._tmpQuaternion.z,w:this._tmpQuaternion.w}),r=i&&this.attached&&this._xrSessionManager.currentFrame?await this._createAnchorAtTransformation(s,this._xrSessionManager.currentFrame):void 0;return new Promise(((e,t)=>{this._futureAnchors.push({nativeAnchor:r,resolved:!1,submitted:!1,xrTransformation:s,resolve:e,reject:t})}))}get anchors(){return this._trackedAnchors}detach(){if(!super.detach())return!1;if(!this._options.doNotRemoveAnchorsOnSessionEnded)for(;this._trackedAnchors.length;){const e=this._trackedAnchors.pop();if(e){try{e.remove()}catch(e){}this.onAnchorRemovedObservable.notifyObservers(e)}}return!0}dispose(){this._futureAnchors.length=0,super.dispose(),this.onAnchorAddedObservable.clear(),this.onAnchorRemovedObservable.clear(),this.onAnchorUpdatedObservable.clear()}_onXRFrame(e){if(!this.attached||!e)return;const t=e.trackedAnchors;if(t){const i=this._trackedAnchors.filter((e=>!t.has(e.xrAnchor))).map((e=>this._trackedAnchors.indexOf(e)));let s=0;i.forEach((e=>{const t=this._trackedAnchors.splice(e-s,1)[0];this.onAnchorRemovedObservable.notifyObservers(t),s++})),t.forEach((t=>{if(this._lastFrameDetected.has(t)){const i=this._findIndexInAnchorArray(t),s=this._trackedAnchors[i];try{this._updateAnchorWithXRFrame(t,s,e),s.attachedNode&&(s.attachedNode.rotationQuaternion=s.attachedNode.rotationQuaternion||new C,s.transformationMatrix.decompose(s.attachedNode.scaling,s.attachedNode.rotationQuaternion,s.attachedNode.position)),this.onAnchorUpdatedObservable.notifyObservers(s)}catch(e){Ht.Warn("Anchor could not be updated")}}else{const i={id:Bx++,xrAnchor:t,remove:()=>t.delete()},s=this._updateAnchorWithXRFrame(t,i,e);this._trackedAnchors.push(s),this.onAnchorAddedObservable.notifyObservers(s);const r=this._futureAnchors.filter((e=>e.nativeAnchor===t))[0];r&&(r.resolve(s),r.resolved=!0)}})),this._lastFrameDetected=t}this._futureAnchors.forEach((t=>{t.resolved||t.submitted||(this._createAnchorAtTransformation(t.xrTransformation,e).then((e=>{t.nativeAnchor=e}),(e=>{t.resolved=!0,t.reject(e)})),t.submitted=!0)}))}_findIndexInAnchorArray(e){for(let t=0;t<this._trackedAnchors.length;++t)if(this._trackedAnchors[t].xrAnchor===e)return t;return-1}_updateAnchorWithXRFrame(e,t,i){const s=i.getPose(e.anchorSpace,this._xrSessionManager.referenceSpace);if(s){const e=t.transformationMatrix||new y;y.FromArrayToRef(s.transform.matrix,0,e),this._xrSessionManager.scene.useRightHandedSystem||e.toggleModelMatrixHandInPlace(),t.transformationMatrix=e,this._options.worldParentNode&&e.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),e)}return t}async _createAnchorAtTransformation(e,t){var i;if(!t.createAnchor)throw this.detach(),new Error("Anchors are not enabled in your browser");try{return t.createAnchor(e,null!==(i=this._referenceSpaceForFrameAnchors)&&void 0!==i?i:this._xrSessionManager.referenceSpace)}catch(e){throw new Error(e)}}}Ux.Name=Vr.ANCHOR_SYSTEM,Ux.Version=1,kr.AddWebXRFeature(Ux.Name,((e,t)=>()=>new Ux(e,t)),Ux.Version);let Vx=0;class kx extends Gr{constructor(e,t={}){super(e),this._options=t,this._detectedPlanes=[],this._enabled=!1,this._lastFrameDetected=new Set,this.onPlaneAddedObservable=new a,this.onPlaneRemovedObservable=new a,this.onPlaneUpdatedObservable=new a,this.xrNativeFeatureName="plane-detection",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce((()=>{this._init()}))}detach(){if(!super.detach())return!1;if(!this._options.doNotRemovePlanesOnSessionEnded)for(;this._detectedPlanes.length;){const e=this._detectedPlanes.pop();e&&this.onPlaneRemovedObservable.notifyObservers(e)}return!0}dispose(){super.dispose(),this.onPlaneAddedObservable.clear(),this.onPlaneRemovedObservable.clear(),this.onPlaneUpdatedObservable.clear()}isCompatible(){return"undefined"!=typeof XRPlane}async initiateRoomCapture(){return this._xrSessionManager.session.initiateRoomCapture?this._xrSessionManager.session.initiateRoomCapture():Promise.reject("initiateRoomCapture is not supported on this session")}_onXRFrame(e){var t;if(!this.attached||!this._enabled||!e)return;const i=e.detectedPlanes||(null===(t=e.worldInformation)||void 0===t?void 0:t.detectedPlanes);if(i){for(let e=0;e<this._detectedPlanes.length;e++){const t=this._detectedPlanes[e];i.has(t.xrPlane)||(this._detectedPlanes.splice(e--,1),this.onPlaneRemovedObservable.notifyObservers(t))}i.forEach((t=>{if(this._lastFrameDetected.has(t)){if(t.lastChangedTime===this._xrSessionManager.currentTimestamp){const i=this._findIndexInPlaneArray(t),s=this._detectedPlanes[i];this._updatePlaneWithXRPlane(t,s,e),this.onPlaneUpdatedObservable.notifyObservers(s)}}else{const i={id:Vx++,xrPlane:t,polygonDefinition:[]},s=this._updatePlaneWithXRPlane(t,i,e);this._detectedPlanes.push(s),this.onPlaneAddedObservable.notifyObservers(s)}})),this._lastFrameDetected=i}}_init(){const e=()=>{this._enabled=!0,this._detectedPlanes.length&&(this._detectedPlanes.length=0)};this._xrSessionManager.isNative&&this._options.preferredDetectorOptions&&this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions&&this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions(this._options.preferredDetectorOptions),this._xrSessionManager.session.updateWorldTrackingState?(this._xrSessionManager.session.updateWorldTrackingState({planeDetectionState:{enabled:!0}}),e()):e()}_updatePlaneWithXRPlane(e,t,i){t.polygonDefinition=e.polygon.map((e=>{const t=this._xrSessionManager.scene.useRightHandedSystem?1:-1;return new S(e.x,e.y,e.z*t)}));const s=i.getPose(e.planeSpace,this._xrSessionManager.referenceSpace);if(s){const e=t.transformationMatrix||new y;y.FromArrayToRef(s.transform.matrix,0,e),this._xrSessionManager.scene.useRightHandedSystem||e.toggleModelMatrixHandInPlace(),t.transformationMatrix=e,this._options.worldParentNode&&e.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),e)}return t}_findIndexInPlaneArray(e){for(let t=0;t<this._detectedPlanes.length;++t)if(this._detectedPlanes[t].xrPlane===e)return t;return-1}}kx.Name=Vr.PLANE_DETECTION,kx.Version=1,kr.AddWebXRFeature(kx.Name,((e,t)=>()=>new kx(e,t)),kx.Version);class Gx extends Gr{constructor(e,t={}){super(e),this.options=t,this.onBackgroundStateChangedObservable=new a}attach(){return this._setBackgroundState(!1),super.attach()}detach(){return this._setBackgroundState(!0),super.detach()}dispose(){super.dispose(),this.onBackgroundStateChangedObservable.clear()}_onXRFrame(e){}_setBackgroundState(e){const t=this._xrSessionManager.scene;if(!this.options.ignoreEnvironmentHelper)if(this.options.environmentHelperRemovalFlags){if(this.options.environmentHelperRemovalFlags.skyBox){const i=t.getMeshByName("BackgroundSkybox");i&&i.setEnabled(e)}if(this.options.environmentHelperRemovalFlags.ground){const i=t.getMeshByName("BackgroundPlane");i&&i.setEnabled(e)}}else{const i=t.getMeshByName("BackgroundHelper");i&&i.setEnabled(e)}this.options.backgroundMeshes&&this.options.backgroundMeshes.forEach((t=>t.setEnabled(e))),this.onBackgroundStateChangedObservable.notifyObservers(e)}}Gx.Name=Vr.BACKGROUND_REMOVER,Gx.Version=1,kr.AddWebXRFeature(Gx.Name,((e,t)=>()=>new Gx(e,t)),Gx.Version,!0);class zx extends Gr{_createPhysicsImpostor(e){const t=this._options.physicsProperties.impostorType||Wr.SphereImpostor,i=this._options.physicsProperties.impostorSize||.1,s=Ol("impostor-mesh-"+e.uniqueId,{diameterX:"number"==typeof i?i:i.width,diameterY:"number"==typeof i?i:i.height,diameterZ:"number"==typeof i?i:i.depth});s.isVisible=this._debugMode,s.isPickable=!1,s.rotationQuaternion=new C;const r=e.grip||e.pointer;s.position.copyFrom(r.position),s.rotationQuaternion.copyFrom(r.rotationQuaternion);const n=new Wr(s,t,Object.assign({mass:0},this._options.physicsProperties));this._controllers[e.uniqueId]={xrController:e,impostor:n,impostorMesh:s}}constructor(e,t){super(e),this._options=t,this._attachController=e=>{this._controllers[e.uniqueId]||(this._xrSessionManager.scene.isPhysicsEnabled()||k.Warn("physics engine not enabled, skipped. Please add this controller manually."),this._options.physicsProperties.useControllerMesh&&e.inputSource.gamepad?e.onMotionControllerInitObservable.addOnce((t=>{t._doNotLoadControllerMesh?this._createPhysicsImpostor(e):t.onModelLoadedObservable.addOnce((()=>{const i=new Wr(t.rootMesh,Wr.MeshImpostor,Object.assign({mass:0},this._options.physicsProperties)),s=e.grip||e.pointer;this._controllers[e.uniqueId]={xrController:e,impostor:i,oldPos:s.position.clone(),oldRotation:s.rotationQuaternion.clone()}}))})):this._createPhysicsImpostor(e))},this._controllers={},this._debugMode=!1,this._delta=0,this._lastTimestamp=0,this._tmpQuaternion=new C,this._tmpVector=new S,this._options.physicsProperties||(this._options.physicsProperties={})}_enablePhysicsDebug(){this._debugMode=!0,Object.keys(this._controllers).forEach((e=>{const t=this._controllers[e];t.impostorMesh&&(t.impostorMesh.isVisible=!0)}))}addController(e){this._attachController(e)}attach(){if(!super.attach())return!1;if(!this._options.xrInput)return!0;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)})),this._options.enableHeadsetImpostor){const e=this._options.headsetImpostorParams||{impostorType:Wr.SphereImpostor,restitution:.8,impostorSize:.3},t=e.impostorSize||.3;this._headsetMesh=Ol("headset-mesh",{diameterX:"number"==typeof t?t:t.width,diameterY:"number"==typeof t?t:t.height,diameterZ:"number"==typeof t?t:t.depth}),this._headsetMesh.rotationQuaternion=new C,this._headsetMesh.isVisible=!1,this._headsetImpostor=new Wr(this._headsetMesh,e.impostorType,Object.assign({mass:0},e))}return!0}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),this._headsetMesh&&this._headsetMesh.dispose(),!0)}getHeadsetImpostor(){return this._headsetImpostor}getImpostorForController(e){const t="string"==typeof e?e:e.uniqueId;return this._controllers[t]?this._controllers[t].impostor:null}setPhysicsProperties(e){this._options.physicsProperties=Object.assign(Object.assign({},this._options.physicsProperties),e)}_onXRFrame(e){var t,i;if(this._delta=this._xrSessionManager.currentTimestamp-this._lastTimestamp,this._lastTimestamp=this._xrSessionManager.currentTimestamp,this._headsetMesh&&this._headsetImpostor){if(this._headsetMesh.position.copyFrom(this._options.xrInput.xrCamera.globalPosition),this._headsetMesh.rotationQuaternion.copyFrom(this._options.xrInput.xrCamera.absoluteRotation),null===(t=this._options.xrInput.xrCamera._lastXRViewerPose)||void 0===t?void 0:t.linearVelocity){const e=this._options.xrInput.xrCamera._lastXRViewerPose.linearVelocity;this._tmpVector.set(e.x,e.y,e.z),this._headsetImpostor.setLinearVelocity(this._tmpVector)}if(null===(i=this._options.xrInput.xrCamera._lastXRViewerPose)||void 0===i?void 0:i.angularVelocity){const e=this._options.xrInput.xrCamera._lastXRViewerPose.angularVelocity;this._tmpVector.set(e.x,e.y,e.z),this._headsetImpostor.setAngularVelocity(this._tmpVector)}}Object.keys(this._controllers).forEach((e=>{var t,i;const s=this._controllers[e],r=s.xrController.grip||s.xrController.pointer,n=s.oldPos||s.impostorMesh.position;if(null===(t=s.xrController._lastXRPose)||void 0===t?void 0:t.linearVelocity){const e=s.xrController._lastXRPose.linearVelocity;this._tmpVector.set(e.x,e.y,e.z),s.impostor.setLinearVelocity(this._tmpVector)}else r.position.subtractToRef(n,this._tmpVector),this._tmpVector.scaleInPlace(1e3/this._delta),s.impostor.setLinearVelocity(this._tmpVector);n.copyFrom(r.position),this._debugMode&&console.log(this._tmpVector,"linear");const o=s.oldRotation||s.impostorMesh.rotationQuaternion;if(null===(i=s.xrController._lastXRPose)||void 0===i?void 0:i.angularVelocity){const e=s.xrController._lastXRPose.angularVelocity;this._tmpVector.set(e.x,e.y,e.z),s.impostor.setAngularVelocity(this._tmpVector)}else if(!o.equalsWithEpsilon(r.rotationQuaternion)){o.conjugateInPlace().multiplyToRef(r.rotationQuaternion,this._tmpQuaternion);const e=Math.sqrt(this._tmpQuaternion.x*this._tmpQuaternion.x+this._tmpQuaternion.y*this._tmpQuaternion.y+this._tmpQuaternion.z*this._tmpQuaternion.z);if(this._tmpVector.set(this._tmpQuaternion.x,this._tmpQuaternion.y,this._tmpQuaternion.z),e<.001)this._tmpVector.scaleInPlace(2);else{const t=2*Math.atan2(e,this._tmpQuaternion.w);this._tmpVector.scaleInPlace(t/(e*(this._delta/1e3)))}s.impostor.setAngularVelocity(this._tmpVector)}o.copyFrom(r.rotationQuaternion),this._debugMode&&console.log(this._tmpVector,this._tmpQuaternion,"angular")}))}_detachController(e){const t=this._controllers[e];t&&(t.impostorMesh&&t.impostorMesh.dispose(),delete this._controllers[e])}}zx.Name=Vr.PHYSICS_CONTROLLERS,zx.Version=1,kr.AddWebXRFeature(zx.Name,((e,t)=>()=>new zx(e,t)),zx.Version,!0);class Wx extends Gr{constructor(e,t={}){super(e),this.options=t,this._tmpMat=new y,this._tmpPos=new S,this._tmpQuat=new C,this._initHitTestSource=e=>{if(!e)return;const t=new XRRay(this.options.offsetRay||{}),i={space:this.options.useReferenceSpace?e:this._xrSessionManager.viewerReferenceSpace,offsetRay:t};this.options.entityTypes&&(i.entityTypes=this.options.entityTypes),i.space?this._xrSessionManager.session.requestHitTestSource(i).then((e=>{this._xrHitTestSource&&this._xrHitTestSource.cancel(),this._xrHitTestSource=e})):Ht.Warn("waiting for viewer reference space to initialize")},this.autoCloneTransformation=!1,this.onHitTestResultObservable=new a,this.paused=!1,this.xrNativeFeatureName="hit-test",Ht.Warn("Hit test is an experimental and unstable feature.")}attach(){if(!super.attach())return!1;if(!this._xrSessionManager.session.requestHitTestSource)return!1;if(this.options.disablePermanentHitTest||(this._xrSessionManager.referenceSpace&&this._initHitTestSource(this._xrSessionManager.referenceSpace),this._xrSessionManager.onXRReferenceSpaceChanged.add(this._initHitTestSource)),this.options.enableTransientHitTest){const e=new XRRay(this.options.transientOffsetRay||{});this._xrSessionManager.session.requestHitTestSourceForTransientInput({profile:this.options.transientHitTestProfile||"generic-touchscreen",offsetRay:e,entityTypes:this.options.entityTypes}).then((e=>{this._transientXrHitTestSource=e}))}return!0}detach(){return!!super.detach()&&(this._xrHitTestSource&&(this._xrHitTestSource.cancel(),this._xrHitTestSource=null),this._xrSessionManager.onXRReferenceSpaceChanged.removeCallback(this._initHitTestSource),this._transientXrHitTestSource&&(this._transientXrHitTestSource.cancel(),this._transientXrHitTestSource=null),!0)}dispose(){super.dispose(),this.onHitTestResultObservable.clear()}_onXRFrame(e){if(this.attached&&!this.paused){if(this._xrHitTestSource){const t=e.getHitTestResults(this._xrHitTestSource);this._processWebXRHitTestResult(t)}this._transientXrHitTestSource&&e.getHitTestResultsForTransientInput(this._transientXrHitTestSource).forEach((e=>{this._processWebXRHitTestResult(e.results,e.inputSource)}))}}_processWebXRHitTestResult(e,t){const i=[];e.forEach((e=>{const s=e.getPose(this._xrSessionManager.referenceSpace);if(!s)return;const r=s.transform.position,n=s.transform.orientation;this._tmpPos.set(r.x,r.y,r.z),this._tmpQuat.set(n.x,n.y,n.z,n.w),y.FromFloat32ArrayToRefScaled(s.transform.matrix,0,1,this._tmpMat),this._xrSessionManager.scene.useRightHandedSystem||(this._tmpPos.z*=-1,this._tmpQuat.z*=-1,this._tmpQuat.w*=-1,this._tmpMat.toggleModelMatrixHandInPlace());const o={position:this.autoCloneTransformation?this._tmpPos.clone():this._tmpPos,rotationQuaternion:this.autoCloneTransformation?this._tmpQuat.clone():this._tmpQuat,transformationMatrix:this.autoCloneTransformation?this._tmpMat.clone():this._tmpMat,inputSource:t,isTransient:!!t,xrHitResult:e};i.push(o)})),this.onHitTestResultObservable.notifyObservers(i)}}Wx.Name=Vr.HIT_TEST,Wx.Version=2,kr.AddWebXRFeature(Wx.Name,((e,t)=>()=>new Wx(e,t)),Wx.Version,!1);class Hx extends Gr{get featurePointCloud(){return this._featurePointCloud}constructor(e){super(e),this._enabled=!1,this._featurePointCloud=[],this.onFeaturePointsAddedObservable=new a,this.onFeaturePointsUpdatedObservable=new a,this.xrNativeFeatureName="bjsfeature-points",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce((()=>{this._init()}))}detach(){return!!super.detach()&&(this.featurePointCloud.length=0,!0)}dispose(){super.dispose(),this._featurePointCloud.length=0,this.onFeaturePointsUpdatedObservable.clear(),this.onFeaturePointsAddedObservable.clear()}_onXRFrame(e){if(!this.attached||!this._enabled||!e)return;const t=e.featurePointCloud;if(t&&0!==t.length){if(t.length%5!=0)throw new Error("Received malformed feature point cloud of length: "+t.length);const e=t.length/5,i=[],s=[];for(let r=0;r<e;r++){const e=5*r,n=t[e+4];this._featurePointCloud[n]?i.push(n):(this._featurePointCloud[n]={position:new S,confidenceValue:0},s.push(n)),this._featurePointCloud[n].position.x=t[e],this._featurePointCloud[n].position.y=t[e+1],this._featurePointCloud[n].position.z=t[e+2],this._featurePointCloud[n].confidenceValue=t[e+3]}s.length>0&&this.onFeaturePointsAddedObservable.notifyObservers(s),i.length>0&&this.onFeaturePointsUpdatedObservable.notifyObservers(i)}}_init(){this._xrSessionManager.session.trySetFeaturePointCloudEnabled&&this._xrSessionManager.session.trySetFeaturePointCloudEnabled(!0)&&(this._enabled=!0)}}Hx.Name=Vr.FEATURE_POINTS,Hx.Version=1,kr.AddWebXRFeature(Hx.Name,(e=>()=>new Hx(e)),Hx.Version);let Xx=0;class Yx extends Gr{constructor(e,t={}){super(e),this._options=t,this._detectedMeshes=new Map,this.onMeshAddedObservable=new a,this.onMeshRemovedObservable=new a,this.onMeshUpdatedObservable=new a,this.xrNativeFeatureName="mesh-detection",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce((()=>{this._init()}))}detach(){return!!super.detach()&&(this._xrSessionManager.isNative&&this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!1),this._options.doNotRemoveMeshesOnSessionEnded||(this._detectedMeshes.forEach((e=>{this.onMeshRemovedObservable.notifyObservers(e)})),this._detectedMeshes.clear()),!0)}dispose(){super.dispose(),this.onMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onMeshUpdatedObservable.clear()}_onXRFrame(e){var t;try{if(!this.attached||!e)return;const i=null===(t=e.worldInformation)||void 0===t?void 0:t.detectedMeshes;if(i){const t=new Set;this._detectedMeshes.forEach(((e,s)=>{i.has(s)||t.add(s)})),t.forEach((e=>{const t=this._detectedMeshes.get(e);t&&(this.onMeshRemovedObservable.notifyObservers(t),this._detectedMeshes.delete(e))})),i.forEach((t=>{if(this._detectedMeshes.has(t)){if(t.lastChangedTime===this._xrSessionManager.currentTimestamp){const i=this._detectedMeshes.get(t);i&&(this._updateVertexDataWithXRMesh(t,i,e),this.onMeshUpdatedObservable.notifyObservers(i))}}else{const i={id:Xx++,xrMesh:t},s=this._updateVertexDataWithXRMesh(t,i,e);this._detectedMeshes.set(t,s),this.onMeshAddedObservable.notifyObservers(s)}}))}}catch(e){console.log(e.stack)}}_init(){this._xrSessionManager.isNative&&(this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!0),this._options.preferredDetectorOptions&&this._xrSessionManager.session.trySetPreferredMeshDetectorOptions&&this._xrSessionManager.session.trySetPreferredMeshDetectorOptions(this._options.preferredDetectorOptions))}_updateVertexDataWithXRMesh(e,t,i){if(t.xrMesh=e,t.worldParentNode=this._options.worldParentNode,this._options.convertCoordinateSystems){if(this._xrSessionManager.scene.useRightHandedSystem)t.positions=e.positions,t.normals=e.normals;else{t.positions=new Float32Array(e.positions.length);for(let i=0;i<e.positions.length;i+=3)t.positions[i]=e.positions[i],t.positions[i+1]=e.positions[i+1],t.positions[i+2]=-1*e.positions[i+2];if(e.normals){t.normals=new Float32Array(e.normals.length);for(let i=0;i<e.normals.length;i+=3)t.normals[i]=e.normals[i],t.normals[i+1]=e.normals[i+1],t.normals[i+2]=-1*e.normals[i+2]}}t.indices=e.indices;const s=i.getPose(e.meshSpace,this._xrSessionManager.referenceSpace);if(s){const e=t.transformationMatrix||new y;y.FromArrayToRef(s.transform.matrix,0,e),this._xrSessionManager.scene.useRightHandedSystem||e.toggleModelMatrixHandInPlace(),t.transformationMatrix=e,this._options.worldParentNode&&e.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),e)}}return t}}var jx;Yx.Name=Vr.MESH_DETECTION,Yx.Version=1,kr.AddWebXRFeature(Yx.Name,((e,t)=>()=>new Yx(e,t)),Yx.Version,!1),function(e){e[e.NotReceived=0]="NotReceived",e[e.Waiting=1]="Waiting",e[e.Received=2]="Received"}(jx||(jx={}));class Kx extends Gr{constructor(e,t){super(e),this.options=t,this.onUntrackableImageFoundObservable=new a,this.onTrackableImageFoundObservable=new a,this.onTrackedImageUpdatedObservable=new a,this._trackableScoreStatus=jx.NotReceived,this._trackedImages=[],this.xrNativeFeatureName="image-tracking"}attach(){return super.attach()}detach(){return super.detach()}getTrackedImageById(e){return this._trackedImages[e]||null}dispose(){super.dispose(),this._trackedImages.forEach((e=>{e.originalBitmap.close()})),this._trackedImages.length=0,this.onTrackableImageFoundObservable.clear(),this.onUntrackableImageFoundObservable.clear(),this.onTrackedImageUpdatedObservable.clear()}async getXRSessionInitExtension(){if(!this.options.images||!this.options.images.length)return{};const e=this.options.images.map((e=>"string"==typeof e.src?this._xrSessionManager.scene.getEngine()._createImageBitmapFromSource(e.src):Promise.resolve(e.src)));try{const t=await Promise.all(e);return this._originalTrackingRequest=t.map(((e,t)=>({image:e,widthInMeters:this.options.images[t].estimatedRealWorldWidth}))),{trackedImages:this._originalTrackingRequest}}catch(e){return Ht.Error("Error loading images for tracking, WebXRImageTracking disabled for this session."),{}}}_onXRFrame(e){if(!e.getImageTrackingResults||this._trackableScoreStatus===jx.Waiting)return;if(this._trackableScoreStatus===jx.NotReceived)return void this._checkScoresAsync();const t=e.getImageTrackingResults();for(const i of t){let t=!1;const s=i.index,r=this._trackedImages[s];if(!r)continue;r.xrTrackingResult=i,r.realWorldWidth!==i.measuredWidthInMeters&&(r.realWorldWidth=i.measuredWidthInMeters,t=!0);const n=e.getPose(i.imageSpace,this._xrSessionManager.referenceSpace);if(n){const e=r.transformationMatrix;y.FromArrayToRef(n.transform.matrix,0,e),this._xrSessionManager.scene.useRightHandedSystem||e.toggleModelMatrixHandInPlace(),t=!0}const o="emulated"===i.trackingState;r.emulated!==o&&(r.emulated=o,t=!0),t&&this.onTrackedImageUpdatedObservable.notifyObservers(r)}}async _checkScoresAsync(){if(!this._xrSessionManager.session.getTrackedImageScores||this._trackableScoreStatus!==jx.NotReceived)return;this._trackableScoreStatus=jx.Waiting;const e=await this._xrSessionManager.session.getTrackedImageScores();if(e&&0!==e.length){for(let t=0;t<e.length;++t)if("untrackable"==e[t])this.onUntrackableImageFoundObservable.notifyObservers(t);else{const e=this._originalTrackingRequest[t].image,i={id:t,originalBitmap:e,transformationMatrix:new y,ratio:e.width/e.height};this._trackedImages[t]=i,this.onTrackableImageFoundObservable.notifyObservers(i)}this._trackableScoreStatus=e.length>0?jx.Received:jx.NotReceived}else this._trackableScoreStatus=jx.NotReceived}}Kx.Name=Vr.IMAGE_TRACKING,Kx.Version=1,kr.AddWebXRFeature(Kx.Name,((e,t)=>()=>new Kx(e,t)),Kx.Version,!1);class $x extends Gr{constructor(e,t){super(e),this.options=t,this._domOverlayType=null,this._beforeXRSelectListener=null,this._element=null,this.xrNativeFeatureName="dom-overlay",Ht.Warn("dom-overlay is an experimental and unstable feature.")}attach(){return!(!super.attach()||!this._xrSessionManager.session.domOverlayState||null===this._xrSessionManager.session.domOverlayState.type||(this._domOverlayType=this._xrSessionManager.session.domOverlayState.type,null!==this._element&&!0===this.options.supressXRSelectEvents&&(this._beforeXRSelectListener=e=>{e.preventDefault()},this._element.addEventListener("beforexrselect",this._beforeXRSelectListener)),0))}get domOverlayType(){return this._domOverlayType}dispose(){super.dispose(),null!==this._element&&this._beforeXRSelectListener&&this._element.removeEventListener("beforexrselect",this._beforeXRSelectListener)}_onXRFrame(e){}async getXRSessionInitExtension(){if(void 0===this.options.element)return Ht.Warn('"element" option must be provided to attach xr-dom-overlay feature.'),{};if("string"==typeof this.options.element){const e=document.querySelector(this.options.element);if(null===e)return Ht.Warn(`element not found '${this.options.element}' (not requesting xr-dom-overlay)`),{};this._element=e}else this._element=this.options.element;return{domOverlay:{root:this._element}}}}$x.Name=Vr.DOM_OVERLAY,$x.Version=1,kr.AddWebXRFeature($x.Name,((e,t)=>()=>new $x(e,t)),$x.Version,!1);class qx extends Gr{get movementDirection(){return this._movementDirection}get movementEnabled(){return this._featureContext.movementEnabled}set movementEnabled(e){this._featureContext.movementEnabled=e}get movementOrientationFollowsViewerPose(){return this._featureContext.movementOrientationFollowsViewerPose}set movementOrientationFollowsViewerPose(e){this._featureContext.movementOrientationFollowsViewerPose=e}get movementSpeed(){return this._featureContext.movementSpeed}set movementSpeed(e){this._featureContext.movementSpeed=e}get movementThreshold(){return this._featureContext.movementThreshold}set movementThreshold(e){this._featureContext.movementThreshold=e}get rotationEnabled(){return this._featureContext.rotationEnabled}set rotationEnabled(e){this._featureContext.rotationEnabled=e}get rotationSpeed(){return this._featureContext.rotationSpeed}set rotationSpeed(e){this._featureContext.rotationSpeed=e}get rotationThreshold(){return this._featureContext.rotationThreshold}set rotationThreshold(e){this._featureContext.rotationThreshold=e}constructor(e,t){var i,s,r,n,o,a;super(e),this._controllers={},this._currentRegistrationConfigurations=[],this._movementDirection=new C,this._tmpRotationMatrix=y.Identity(),this._tmpTranslationDirection=new S,this._tmpMovementTranslation=new S,this._tempCacheQuaternion=new C,this._attachController=e=>{if(this._controllers[e.uniqueId])return;this._controllers[e.uniqueId]={xrController:e,registeredComponents:[]};const t=this._controllers[e.uniqueId];if("tracked-pointer"===t.xrController.inputSource.targetRayMode&&t.xrController.inputSource.gamepad){const i=()=>{if(e.motionController)for(const i of this._currentRegistrationConfigurations){let s=null;if(i.allowedComponentTypes)for(const t of i.allowedComponentTypes){const i=e.motionController.getComponentOfType(t);if(null!==i){s=i;break}}if(i.mainComponentOnly){const t=e.motionController.getMainComponent();if(null===t)continue;s=t}if("function"==typeof i.componentSelectionPredicate&&(s=i.componentSelectionPredicate(e)),s&&i.forceHandedness&&e.inputSource.handedness!==i.forceHandedness)continue;if(null===s)continue;const r={registrationConfiguration:i,component:s};t.registeredComponents.push(r),"axisChangedHandler"in i&&(r.onAxisChangedObserver=s.onAxisValueChangedObservable.add((e=>{i.axisChangedHandler(e,this._movementState,this._featureContext,this._xrInput)}))),"buttonChangedhandler"in i&&(r.onButtonChangedObserver=s.onButtonStateChangedObservable.add((()=>{s.changes.pressed&&i.buttonChangedhandler(s.changes.pressed,this._movementState,this._featureContext,this._xrInput)})))}};e.motionController?i():e.onMotionControllerInitObservable.addOnce((()=>{i()}))}},t&&void 0!==t.xrInput?(Array.isArray(t.customRegistrationConfigurations)?this._currentRegistrationConfigurations=t.customRegistrationConfigurations:this._currentRegistrationConfigurations=qx.REGISTRATIONS.default,this._featureContext={movementEnabled:t.movementEnabled||!0,movementOrientationFollowsViewerPose:null===(i=t.movementOrientationFollowsViewerPose)||void 0===i||i,movementSpeed:null!==(s=t.movementSpeed)&&void 0!==s?s:1,movementThreshold:null!==(r=t.movementThreshold)&&void 0!==r?r:.25,rotationEnabled:null===(n=t.rotationEnabled)||void 0===n||n,rotationSpeed:null!==(o=t.rotationSpeed)&&void 0!==o?o:1,rotationThreshold:null!==(a=t.rotationThreshold)&&void 0!==a?a:.25},this._movementState={moveX:0,moveY:0,rotateX:0,rotateY:0},this._xrInput=t.xrInput):Ht.Error('WebXRControllerMovement feature requires "xrInput" option.')}attach(){return!!super.attach()&&(this._xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)})),!0)}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),this._controllers={},!0)}_onXRFrame(e){if(this.attached){if(0!==this._movementState.rotateX&&this._featureContext.rotationEnabled){const e=.001*this._xrSessionManager.scene.getEngine().getDeltaTime()*this._featureContext.rotationSpeed*this._movementState.rotateX*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);this._featureContext.movementOrientationFollowsViewerPose?(this._xrInput.xrCamera.cameraRotation.y+=e,C.RotationYawPitchRollToRef(e,0,0,this._tempCacheQuaternion),this._xrInput.xrCamera.rotationQuaternion.multiplyToRef(this._tempCacheQuaternion,this._movementDirection)):(C.RotationYawPitchRollToRef(3*e,0,0,this._tempCacheQuaternion),this._movementDirection.multiplyInPlace(this._tempCacheQuaternion))}else this._featureContext.movementOrientationFollowsViewerPose&&this._movementDirection.copyFrom(this._xrInput.xrCamera.rotationQuaternion);(this._movementState.moveX||this._movementState.moveY)&&this._featureContext.movementEnabled&&(y.FromQuaternionToRef(this._movementDirection,this._tmpRotationMatrix),this._tmpTranslationDirection.set(this._movementState.moveX,0,this._movementState.moveY*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),S.TransformCoordinatesToRef(this._tmpTranslationDirection,this._tmpRotationMatrix,this._tmpMovementTranslation),this._tmpMovementTranslation.scaleInPlace(this._xrInput.xrCamera._computeLocalCameraSpeed()*this._featureContext.movementSpeed),this._xrInput.xrCamera.cameraDirection.addInPlace(this._tmpMovementTranslation))}}_detachController(e){const t=this._controllers[e];if(t){for(const e of t.registeredComponents)e.onAxisChangedObserver&&e.component.onAxisValueChangedObservable.remove(e.onAxisChangedObserver),e.onButtonChangedObserver&&e.component.onButtonStateChangedObservable.remove(e.onButtonChangedObserver);delete this._controllers[e]}}}qx.Name=Vr.MOVEMENT,qx.REGISTRATIONS={default:[{allowedComponentTypes:[ep.THUMBSTICK_TYPE,ep.TOUCHPAD_TYPE],forceHandedness:"left",axisChangedHandler:(e,t,i)=>{t.rotateX=Math.abs(e.x)>i.rotationThreshold?e.x:0,t.rotateY=Math.abs(e.y)>i.rotationThreshold?e.y:0}},{allowedComponentTypes:[ep.THUMBSTICK_TYPE,ep.TOUCHPAD_TYPE],forceHandedness:"right",axisChangedHandler:(e,t,i)=>{t.moveX=Math.abs(e.x)>i.movementThreshold?e.x:0,t.moveY=Math.abs(e.y)>i.movementThreshold?e.y:0}}]},qx.Version=1,kr.AddWebXRFeature(qx.Name,((e,t)=>()=>new qx(e,t)),qx.Version,!0);class Qx extends Gr{constructor(e,t){super(e),this.options=t,this._canvasContext=null,this._reflectionCubeMap=null,this._xrLightEstimate=null,this._xrLightProbe=null,this._xrWebGLBinding=null,this._lightDirection=S.Up().negateInPlace(),this._lightColor=N.White(),this._intensity=1,this._sphericalHarmonics=new Ch,this._cubeMapPollTime=Date.now(),this._lightEstimationPollTime=Date.now(),this._reflectionCubeMapTextureSize=16,this.directionalLight=null,this.onReflectionCubeMapUpdatedObservable=new a,this._updateReflectionCubeMap=()=>{var e;if(!this._xrLightProbe)return;if(this.options.cubeMapPollInterval){const e=Date.now();if(e-this._cubeMapPollTime<this.options.cubeMapPollInterval)return;this._cubeMapPollTime=e}const t=this._getXRGLBinding().getReflectionCubeMap(this._xrLightProbe);if(t&&this._reflectionCubeMap){if(this._reflectionCubeMap._texture)null===(e=this._reflectionCubeMap._texture._hardwareTexture)||void 0===e||e.set(t),this._reflectionCubeMap._texture.getEngine().resetTextureCache();else{const e=new dt(this._xrSessionManager.scene.getEngine(),ut.Unknown);e.isCube=!0,e.invertY=!1,e._useSRGBBuffer="srgba8"===this.options.reflectionFormat,e.format=5,e.generateMipMaps=!0,e.type="srgba8"!==this.options.reflectionFormat?2:0,e.samplingMode=3,e.width=this._reflectionCubeMapTextureSize,e.height=this._reflectionCubeMapTextureSize,e._cachedWrapU=1,e._cachedWrapV=1,e._hardwareTexture=new xt(t,this._getCanvasContext()),this._reflectionCubeMap._texture=e}this._reflectionCubeMap._texture.isReady=!0,this.options.disablePreFiltering?(this._xrSessionManager.scene.markAllMaterialsAsDirty(1),this.onReflectionCubeMapUpdatedObservable.notifyObservers(this._reflectionCubeMap)):(this._xrLightProbe.removeEventListener("reflectionchange",this._updateReflectionCubeMap),this._hdrFilter.prefilter(this._reflectionCubeMap).then((()=>{this._xrSessionManager.scene.markAllMaterialsAsDirty(1),this.onReflectionCubeMapUpdatedObservable.notifyObservers(this._reflectionCubeMap),this._xrLightProbe.addEventListener("reflectionchange",this._updateReflectionCubeMap)})))}},this.xrNativeFeatureName="light-estimation",this.options.createDirectionalLightSource&&(this.directionalLight=new rd("light estimation directional",this._lightDirection,this._xrSessionManager.scene),this.directionalLight.position=new S(0,8,0),this.directionalLight.intensity=0,this.directionalLight.falloffType=Ui.FALLOFF_GLTF),this._hdrFilter=new jp(this._xrSessionManager.scene.getEngine()),Ht.Warn("light-estimation is an experimental and unstable feature.")}get reflectionCubeMapTexture(){return this._reflectionCubeMap}get xrLightingEstimate(){return this._xrLightEstimate?{lightColor:this._lightColor,lightDirection:this._lightDirection,lightIntensity:this._intensity,sphericalHarmonics:this._sphericalHarmonics}:this._xrLightEstimate}_getCanvasContext(){return null===this._canvasContext&&(this._canvasContext=this._xrSessionManager.scene.getEngine()._gl),this._canvasContext}_getXRGLBinding(){if(null===this._xrWebGLBinding){const e=this._getCanvasContext();this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,e)}return this._xrWebGLBinding}attach(){var e;if(!super.attach())return!1;const t=null!==(e=this.options.reflectionFormat)&&void 0!==e?e:this._xrSessionManager.session.preferredReflectionFormat||"srgba8";return this.options.reflectionFormat=t,this._xrSessionManager.session.requestLightProbe({reflectionFormat:t}).then((e=>{this._xrLightProbe=e,this.options.disableCubeMapReflection||(this._reflectionCubeMap||(this._reflectionCubeMap=new Cr(this._xrSessionManager.scene),this._reflectionCubeMap._isCube=!0,this._reflectionCubeMap.coordinatesMode=3,this.options.setSceneEnvironmentTexture&&(this._xrSessionManager.scene.environmentTexture=this._reflectionCubeMap)),this._xrLightProbe.addEventListener("reflectionchange",this._updateReflectionCubeMap))})),!0}detach(){const e=super.detach();return null===this._xrLightProbe||this.options.disableCubeMapReflection||(this._xrLightProbe.removeEventListener("reflectionchange",this._updateReflectionCubeMap),this._xrLightProbe=null),this._canvasContext=null,this._xrLightEstimate=null,this._xrWebGLBinding=null,e}dispose(){super.dispose(),this.onReflectionCubeMapUpdatedObservable.clear(),this.directionalLight&&(this.directionalLight.dispose(),this.directionalLight=null),null!==this._reflectionCubeMap&&(this._reflectionCubeMap._texture&&this._reflectionCubeMap._texture.dispose(),this._reflectionCubeMap.dispose(),this._reflectionCubeMap=null)}_onXRFrame(e){var t;if(null!==this._xrLightProbe){if(this.options.lightEstimationPollInterval){const e=Date.now();if(e-this._lightEstimationPollTime<this.options.lightEstimationPollInterval)return;this._lightEstimationPollTime=e}if(this._xrLightEstimate=e.getLightEstimate(this._xrLightProbe),this._xrLightEstimate){this._intensity=Math.max(1,this._xrLightEstimate.primaryLightIntensity.x,this._xrLightEstimate.primaryLightIntensity.y,this._xrLightEstimate.primaryLightIntensity.z);const e=this._xrSessionManager.scene.useRightHandedSystem?1:-1;this.options.disableVectorReuse&&(this._lightDirection=new S,this._lightColor=new N,this.directionalLight&&(this.directionalLight.direction=this._lightDirection,this.directionalLight.diffuse=this._lightColor)),this._lightDirection.copyFromFloats(this._xrLightEstimate.primaryLightDirection.x,this._xrLightEstimate.primaryLightDirection.y,this._xrLightEstimate.primaryLightDirection.z*e),this._lightColor.copyFromFloats(this._xrLightEstimate.primaryLightIntensity.x/this._intensity,this._xrLightEstimate.primaryLightIntensity.y/this._intensity,this._xrLightEstimate.primaryLightIntensity.z/this._intensity),this._sphericalHarmonics.updateFromFloatsArray(this._xrLightEstimate.sphericalHarmonicsCoefficients),this._reflectionCubeMap&&!this.options.disableSphericalPolynomial&&(this._reflectionCubeMap.sphericalPolynomial=this._reflectionCubeMap.sphericalPolynomial||new yh,null===(t=this._reflectionCubeMap.sphericalPolynomial)||void 0===t||t.updateFromHarmonics(this._sphericalHarmonics)),this._lightDirection.negateInPlace(),this.directionalLight&&(this.directionalLight.direction.copyFrom(this._lightDirection),this.directionalLight.intensity=Math.min(this._intensity,1),this.directionalLight.diffuse.copyFrom(this._lightColor))}}}}Qx.Name=Vr.LIGHT_ESTIMATION,Qx.Version=1,kr.AddWebXRFeature(Qx.Name,((e,t)=>()=>new Qx(e,t)),Qx.Version,!1);class Zx extends Gr{constructor(e){super(e),this.onEyeTrackingStartedObservable=new a,this.onEyeTrackingEndedObservable=new a,this.onEyeTrackingFrameUpdateObservable=new a,this._eyeTrackingStartListener=e=>{this._latestEyeSpace=e.gazeSpace,this._gazeRay=new Fr(S.Zero(),S.Forward()),this.onEyeTrackingStartedObservable.notifyObservers(this._gazeRay)},this._eyeTrackingEndListener=()=>{this._latestEyeSpace=null,this._gazeRay=null,this.onEyeTrackingEndedObservable.notifyObservers()},this.xrNativeFeatureName="eye-tracking",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce((()=>{this._init()}))}dispose(){super.dispose(),this._xrSessionManager.session.removeEventListener("eyetrackingstart",this._eyeTrackingStartListener),this._xrSessionManager.session.removeEventListener("eyetrackingend",this._eyeTrackingEndListener),this.onEyeTrackingStartedObservable.clear(),this.onEyeTrackingEndedObservable.clear(),this.onEyeTrackingFrameUpdateObservable.clear()}get isEyeGazeValid(){return!!this._gazeRay}getEyeGaze(){return this._gazeRay}_onXRFrame(e){if(this.attached&&e&&this._latestEyeSpace&&this._gazeRay){const t=e.getPose(this._latestEyeSpace,this._xrSessionManager.referenceSpace);if(t){this._gazeRay.origin.set(t.transform.position.x,t.transform.position.y,t.transform.position.z);const e=t.transform.orientation;R.Quaternion[0].set(e.x,e.y,e.z,e.w),this._xrSessionManager.scene.useRightHandedSystem?S.RightHandedForwardReadOnly.rotateByQuaternionToRef(R.Quaternion[0],this._gazeRay.direction):(this._gazeRay.origin.z*=-1,R.Quaternion[0].z*=-1,R.Quaternion[0].w*=-1,S.LeftHandedForwardReadOnly.rotateByQuaternionToRef(R.Quaternion[0],this._gazeRay.direction)),this.onEyeTrackingFrameUpdateObservable.notifyObservers(this._gazeRay)}}}_init(){this._xrSessionManager.isNative&&(this._xrSessionManager.session.addEventListener("eyetrackingstart",this._eyeTrackingStartListener),this._xrSessionManager.session.addEventListener("eyetrackingend",this._eyeTrackingEndListener))}}Zx.Name=Vr.EYE_TRACKING,Zx.Version=1,kr.AddWebXRFeature(Zx.Name,(e=>()=>new Zx(e)),Zx.Version,!1);class Jx{constructor(e,t){this._samples=[],this._idx=0;for(let i=0;i<e;++i)this._samples.push(t?t():E.Zero())}get length(){return this._samples.length}push(e,t){this._idx=(this._idx+this._samples.length-1)%this._samples.length,this.at(0).copyFromFloats(e,t)}at(e){if(e>=this._samples.length)throw new Error("Index out of bounds");return this._samples[(this._idx+e)%this._samples.length]}}class eT{constructor(){this._samples=new Jx(20),this._entropy=0,this.onFirstStepDetected=new a}update(e,t,i,s){this._samples.push(e,t);const r=this._samples.at(0);if(this._entropy*=this._entropyDecayFactor,this._entropy+=E.Distance(r,this._samples.at(1)),this._entropy>this._entropyThreshold)return;let n;for(n=this._samePointCheckStartIdx;n<this._samples.length&&!(E.DistanceSquared(r,this._samples.at(n))<this._samePointSquaredDistanceThreshold);++n);if(n===this._samples.length)return;let o=-1,a=0;for(let e,t=1;t<n;++t)e=E.DistanceSquared(r,this._samples.at(t)),e>o&&(a=t,o=e);if(o<this._apexSquaredDistanceThreshold)return;const l=this._samples.at(a),h=l.subtract(r);h.normalize();const c=R.Vector2[0];let u,d,p=0;for(let e=1;e<n;++e)d=this._samples.at(e),d.subtractToRef(r,c),u=E.Dot(h,c),p+=c.lengthSquared()-u*u;if(p>n*this._squaredProjectionDistanceThreshold)return;const _=R.Vector3[0];_.set(i,s,0);const f=R.Vector3[1];f.set(h.x,h.y,0);const m=S.Cross(_,f).z>0,g=r.clone(),v=r.clone();l.subtractToRef(r,h),m?(h.scaleAndAddToRef(this._axisToApexShrinkFactor,g),h.scaleAndAddToRef(this._axisToApexExtendFactor,v)):(h.scaleAndAddToRef(this._axisToApexExtendFactor,g),h.scaleAndAddToRef(this._axisToApexShrinkFactor,v)),this.onFirstStepDetected.notifyObservers({leftApex:g,rightApex:v,currentPosition:r,currentStepDirection:m?"right":"left"})}reset(){for(let e=0;e<this._samples.length;++e)this._samples.at(e).copyFromFloats(0,0)}get _samePointCheckStartIdx(){return Math.floor(this._samples.length/3)}get _samePointSquaredDistanceThreshold(){return 9e-4}get _apexSquaredDistanceThreshold(){return.0081}get _squaredProjectionDistanceThreshold(){return 9e-4}get _axisToApexShrinkFactor(){return.8}get _axisToApexExtendFactor(){return-1.6}get _entropyDecayFactor(){return.93}get _entropyThreshold(){return.4}}class tT{constructor(e,t,i,s){this._leftApex=new E,this._rightApex=new E,this._currentPosition=new E,this._axis=new E,this._axisLength=-1,this._forward=new E,this._steppingLeft=!1,this._t=-1,this._maxT=-1,this._maxTPosition=new E,this._vitality=0,this.onMovement=new a,this.onFootfall=new a,this._reset(e,t,i,"left"===s)}_reset(e,t,i,s){this._leftApex.copyFrom(e),this._rightApex.copyFrom(t),this._steppingLeft=s,this._steppingLeft?(this._leftApex.subtractToRef(this._rightApex,this._axis),this._forward.copyFromFloats(-this._axis.y,this._axis.x)):(this._rightApex.subtractToRef(this._leftApex,this._axis),this._forward.copyFromFloats(this._axis.y,-this._axis.x)),this._axisLength=this._axis.length(),this._forward.scaleInPlace(1/this._axisLength),this._updateTAndVitality(i.x,i.y),this._maxT=this._t,this._maxTPosition.copyFrom(i),this._vitality=1}_updateTAndVitality(e,t){this._currentPosition.copyFromFloats(e,t),this._steppingLeft?this._currentPosition.subtractInPlace(this._rightApex):this._currentPosition.subtractInPlace(this._leftApex);const i=this._t,s=E.Dot(this._currentPosition,this._axis);this._t=s/(this._axisLength*this._axisLength);const r=this._currentPosition.lengthSquared()-s/this._axisLength*(s/this._axisLength);this._vitality*=.92-100*Math.max(r-.0016,0)+Math.max(this._t-i,0)}update(e,t){if(this._vitality<this._vitalityThreshold)return!1;const i=this._t;return this._updateTAndVitality(e,t),this._t>this._maxT&&(this._maxT=this._t,this._maxTPosition.copyFromFloats(e,t)),!(this._vitality<this._vitalityThreshold||(this._t>i&&(this.onMovement.notifyObservers({deltaT:this._t-i}),i<.5&&this._t>=.5&&this.onFootfall.notifyObservers({foot:this._steppingLeft?"left":"right"})),this._t<.95*this._maxT&&(this._currentPosition.copyFromFloats(e,t),this._steppingLeft?this._leftApex.copyFrom(this._maxTPosition):this._rightApex.copyFrom(this._maxTPosition),this._reset(this._leftApex,this._rightApex,this._currentPosition,!this._steppingLeft)),this._axisLength<.03))}get _vitalityThreshold(){return.1}get forward(){return this._forward}}class iT{static get _MillisecondsPerUpdate(){return 1e3/15}constructor(e){this._detector=new eT,this._walker=null,this._movement=new E,this._millisecondsSinceLastUpdate=iT._MillisecondsPerUpdate,this.movementThisFrame=S.Zero(),this._engine=e,this._detector.onFirstStepDetected.add((e=>{this._walker||(this._walker=new tT(e.leftApex,e.rightApex,e.currentPosition,e.currentStepDirection),this._walker.onFootfall.add((()=>{console.log("Footfall!")})),this._walker.onMovement.add((e=>{this._walker.forward.scaleAndAddToRef(.024*e.deltaT,this._movement)})))}))}update(e,t){t.y=0,t.normalize(),this._millisecondsSinceLastUpdate+=this._engine.getDeltaTime(),this._millisecondsSinceLastUpdate>=iT._MillisecondsPerUpdate&&(this._millisecondsSinceLastUpdate-=iT._MillisecondsPerUpdate,this._detector.update(e.x,e.z,t.x,t.z),this._walker&&(this._walker.update(e.x,e.z)||(this._walker=null)),this._movement.scaleInPlace(.85)),this.movementThisFrame.set(this._movement.x,0,this._movement.y)}}class sT extends Gr{static get Name(){return Vr.WALKING_LOCOMOTION}static get Version(){return 1}get locomotionTarget(){return this._locomotionTarget}set locomotionTarget(e){this._locomotionTarget=e,this._isLocomotionTargetWebXRCamera="WebXRCamera"===this._locomotionTarget.getClassName()}constructor(e,t){super(e),this._up=new S,this._forward=new S,this._position=new S,this._movement=new S,this._sessionManager=e,this.locomotionTarget=t.locomotionTarget,this._isLocomotionTargetWebXRCamera&&k.Warn("Using walking locomotion directly on a WebXRCamera may have unintended interactions with other XR techniques. Using an XR space parent is highly recommended")}isCompatible(){return void 0===this._sessionManager.sessionMode||"immersive-vr"===this._sessionManager.sessionMode}attach(){return!(!this.isCompatible||!super.attach()||(this._walker=new iT(this._sessionManager.scene.getEngine()),0))}detach(){return!!super.detach()&&(this._walker=null,!0)}_onXRFrame(e){const t=e.getViewerPose(this._sessionManager.baseReferenceSpace);if(!t)return;const i=this.locomotionTarget.getScene().useRightHandedSystem?1:-1,s=t.transform.matrix;this._up.copyFromFloats(s[4],s[5],i*s[6]),this._forward.copyFromFloats(s[8],s[9],i*s[10]),this._position.copyFromFloats(s[12],s[13],i*s[14]),this._forward.scaleAndAddToRef(.05,this._position),this._up.scaleAndAddToRef(-.05,this._position),this._walker.update(this._position,this._forward),this._movement.copyFrom(this._walker.movementThisFrame),this._isLocomotionTargetWebXRCamera||S.TransformNormalToRef(this._movement,this.locomotionTarget.getWorldMatrix(),this._movement),this.locomotionTarget.position.addInPlace(this._movement)}}kr.AddWebXRFeature(sT.Name,((e,t)=>()=>new sT(e,t)),sT.Version,!1);class rT extends Ga{constructor(e,t,i,s,r,n){super(e,t,i,s,n),this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=s,this.isMultiview=r,this.createRTTProvider=n}}class nT extends za{constructor(e,t,i){super(e.scene,i),this._xrSessionManager=e,this._xrWebGLBinding=t,this.layerWrapper=i,this._lastSubImages=new Map,this._compositionLayer=i.layer}_getRenderTargetForSubImage(e,t){var i,s,r,n;const o=this._lastSubImages.get(t),a="left"==t?0:1,l=null!==(i=e.colorTextureWidth)&&void 0!==i?i:e.textureWidth,h=null!==(s=e.colorTextureHeight)&&void 0!==s?s:e.textureHeight;if(!this._renderTargetTextures[a]||(null==o?void 0:o.textureWidth)!==l||(null==o?void 0:o.textureHeight)!==h){let t;const i=null!==(r=e.depthStencilTextureWidth)&&void 0!==r?r:l,s=null!==(n=e.depthStencilTextureHeight)&&void 0!==n?n:h;l!==i&&h!==s||(t=e.depthStencilTexture),this._renderTargetTextures[a]=this._createRenderTargetTexture(l,h,null,e.colorTexture,t,this.layerWrapper.isMultiview),this._framebufferDimensions={framebufferWidth:l,framebufferHeight:h}}return this._lastSubImages.set(t,e),this._renderTargetTextures[a]}_getSubImageForEye(e){const t=this._xrSessionManager.currentFrame;return t?this._xrWebGLBinding.getSubImage(this._compositionLayer,t,e):null}getRenderTargetTextureForEye(e){const t=this._getSubImageForEye(e);return t?this._getRenderTargetForSubImage(t,e):null}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e.eye)}_setViewportForSubImage(e,t){var i,s;const r=null!==(i=t.colorTextureWidth)&&void 0!==i?i:t.textureWidth,n=null!==(s=t.colorTextureWidth)&&void 0!==s?s:t.textureHeight,o=t.viewport;e.x=o.x/r,e.y=o.y/n,e.width=o.width/r,e.height=o.height/n}trySetViewportForView(e,t){const i=this._lastSubImages.get(t.eye)||this._getSubImageForEye(t.eye);return!!i&&(this._setViewportForSubImage(e,i),!0)}}class oT extends rT{constructor(e,t,i){super((()=>e.textureWidth),(()=>e.textureHeight),e,"XRProjectionLayer",t,(e=>new aT(e,i,this))),this.layer=e}}class aT extends nT{constructor(e,t,i){super(e,t,i),this.layerWrapper=i,this._projectionLayer=i.layer}_getSubImageForView(e){return this._xrWebGLBinding.getViewSubImage(this._projectionLayer,e)}getRenderTargetTextureForView(e){return this._getRenderTargetForSubImage(this._getSubImageForView(e),e.eye)}getRenderTargetTextureForEye(e){const t=this._lastSubImages.get(e);return t?this._getRenderTargetForSubImage(t,e):null}trySetViewportForView(e,t){const i=this._lastSubImages.get(t.eye)||this._getSubImageForView(t);return!!i&&(this._setViewportForSubImage(e,i),!0)}}const lT={},hT={textureType:"texture",colorFormat:6408,depthFormat:35056,scaleFactor:1};class cT extends Gr{constructor(e,t={}){super(e),this._options=t,this._existingLayers=[],this.xrNativeFeatureName="layers"}attach(){if(!super.attach())return!1;const e=this._xrSessionManager.scene.getEngine();this._glContext=e._gl,this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),this._existingLayers.length=0;const t=Object.assign({},hT),i=this._options.preferMultiviewOnInit&&e.getCaps().multiview;return i&&(t.textureType="texture-array"),this.addXRSessionLayer(this.createProjectionLayer(t,i)),!0}detach(){return!!super.detach()&&(this._existingLayers.length=0,!0)}createXRWebGLLayer(e=lT){const t=new XRWebGLLayer(this._xrSessionManager.session,this._glContext,e);return new Wa(t)}createProjectionLayer(e=hT,t=!1){if(t&&"texture-array"!==e.textureType)throw new Error("Projection layers can only be made multiview if they use texture arrays. Set the textureType parameter to 'texture-array'.");if(!t&&"texture-array"===e.textureType)throw new Error("We currently only support multiview rendering when the textureType parameter is set to 'texture-array'.");const i=this._xrWebGLBinding.createProjectionLayer(e);return new oT(i,t,this._xrWebGLBinding)}addXRSessionLayer(e){this.setXRSessionLayers([...this._existingLayers,e])}setXRSessionLayers(e){this._existingLayers=e;const t=Object.assign({},this._xrSessionManager.session.renderState);t.baseLayer=void 0,t.layers=e.map((e=>e.layer)),this._xrSessionManager.updateRenderState(t),this._xrSessionManager._setBaseLayerWrapper(e.length>0?e[0]:null)}isCompatible(){return!this._xrSessionManager.isNative&&"undefined"!=typeof XRWebGLBinding&&!!XRWebGLBinding.prototype.createProjectionLayer}dispose(){super.dispose()}_onXRFrame(e){}}cT.Name=Vr.LAYERS,cT.Version=1,kr.AddWebXRFeature(cT.Name,((e,t)=>()=>new cT(e,t)),cT.Version,!1);class uT extends Gr{get width(){return this._width}get height(){return this._height}get rawValueToMeters(){return this._rawValueToMeters}get normDepthBufferFromNormView(){return this._normDepthBufferFromNormView}get depthUsage(){switch(this._xrSessionManager.session.depthUsage){case"cpu-optimized":return"cpu";case"gpu-optimized":return"gpu"}}get depthDataFormat(){switch(this._xrSessionManager.session.depthDataFormat){case"luminance-alpha":return"ushort";case"float32":return"float"}}get latestInternalTexture(){var e,t;if(!this._cachedWebGLTexture)return null;const i=this._xrSessionManager.scene.getEngine(),s=new dt(i,ut.Unknown);return s.isCube=!1,s.invertY=!1,s._useSRGBBuffer=!1,s.format="ushort"===this.depthDataFormat?2:5,s.generateMipMaps=!1,s.type="ushort"===this.depthDataFormat?5:1,s.samplingMode=7,s.width=null!==(e=this.width)&&void 0!==e?e:0,s.height=null!==(t=this.height)&&void 0!==t?t:0,s._cachedWrapU=1,s._cachedWrapV=1,s._hardwareTexture=new xt(this._cachedWebGLTexture,i._gl),s}get latestDepthBuffer(){return this._cachedDepthBuffer?"ushort"===this.depthDataFormat?new Uint16Array(this._cachedDepthBuffer):new Float32Array(this._cachedDepthBuffer):null}get latestDepthImageTexture(){return this._cachedDepthImageTexture}constructor(e,t){super(e),this.options=t,this._width=null,this._height=null,this._rawValueToMeters=null,this._normDepthBufferFromNormView=null,this._cachedDepthBuffer=null,this._cachedWebGLTexture=null,this._cachedDepthImageTexture=null,this.onGetDepthInMetersAvailable=new a,this.xrNativeFeatureName="depth-sensing",Ht.Warn("depth-sensing is an experimental and unstable feature.")}attach(e){return!!super.attach(e)&&(null!=this._xrSessionManager.session.depthDataFormat&&null!=this._xrSessionManager.session.depthUsage&&(this._glBinding=new XRWebGLBinding(this._xrSessionManager.session,this._xrSessionManager.scene.getEngine()._gl),!0))}dispose(){var e;null===(e=this._cachedDepthImageTexture)||void 0===e||e.dispose()}_onXRFrame(e){const t=this._xrSessionManager.referenceSpace,i=e.getViewerPose(t);if(null!=i)for(const t of i.views)switch(this.depthUsage){case"cpu":this._updateDepthInformationAndTextureCPUDepthUsage(e,t,this.depthDataFormat);break;case"gpu":if(!this._glBinding)break;this._updateDepthInformationAndTextureWebGLDepthUsage(this._glBinding,t,this.depthDataFormat);break;default:Ht.Error("Unknown depth usage"),this.detach()}}_updateDepthInformationAndTextureCPUDepthUsage(e,t,i){const s=e.getDepthInformation(t);if(null===s)return;const{data:r,width:n,height:o,rawValueToMeters:a,getDepthInMeters:l}=s;switch(this._width=n,this._height=o,this._rawValueToMeters=a,this._cachedDepthBuffer=r,this.onGetDepthInMetersAvailable.notifyObservers(l.bind(s)),this._cachedDepthImageTexture||(this._cachedDepthImageTexture=Mr.CreateRTexture(null,n,o,this._xrSessionManager.scene,!1,!0,Ar.NEAREST_SAMPLINGMODE,Ns.TEXTURETYPE_FLOAT)),i){case"ushort":this._cachedDepthImageTexture.update(Float32Array.from(new Uint16Array(r)).map((e=>e*a)));break;case"float":this._cachedDepthImageTexture.update(new Float32Array(r).map((e=>e*a)))}}_updateDepthInformationAndTextureWebGLDepthUsage(e,t,i){const s=e.getDepthInformation(t);if(null===s)return;const{texture:r,width:n,height:o}=s;this._width=n,this._height=o,this._cachedWebGLTexture=r;const a=this._xrSessionManager.scene,l=a.getEngine().wrapWebGLTexture(r);this._cachedDepthImageTexture||(this._cachedDepthImageTexture=Mr.CreateRTexture(null,n,o,a,!1,!0,Ar.NEAREST_SAMPLINGMODE,"ushort"===i?Ns.TEXTURETYPE_UNSIGNED_BYTE:Ns.TEXTURETYPE_FLOAT)),this._cachedDepthImageTexture._texture=l}getXRSessionInitExtension(){const e=null!=this.options.usagePreference&&0!==this.options.usagePreference.length,t=null!=this.options.dataFormatPreference&&0!==this.options.dataFormatPreference.length;return new Promise((i=>{i(e&&t?{depthSensing:{usagePreference:this.options.usagePreference.map((e=>{switch(e){case"cpu":return"cpu-optimized";case"gpu":return"gpu-optimized"}})),dataFormatPreference:this.options.dataFormatPreference.map((e=>{switch(e){case"ushort":return"luminance-alpha";case"float":return"float32"}}))}}:{})}))}}uT.Name=Vr.DEPTH_SENSING,uT.Version=1,kr.AddWebXRFeature(uT.Name,((e,t)=>()=>new uT(e,t)),uT.Version,!1);nt.ShadersStore.velocityPixelShader="precision highp float;\n#define CUSTOM_FRAGMENT_BEGIN\nvarying vec4 clipPos;varying vec4 previousClipPos;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nhighp vec4 motionVector=( clipPos/clipPos.w-previousClipPos/previousClipPos.w );gl_FragColor=motionVector;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";nt.ShadersStore.velocityVertexShader="#define CUSTOM_VERTEX_BEGIN\n#define VELOCITY\nattribute vec3 position;\n#include<instancesDeclaration>\nuniform mat4 viewProjection;uniform mat4 previousViewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;uniform mat4 previousViewProjectionR;\n#endif\nvarying vec4 clipPos;varying vec4 previousClipPos;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#include<instancesVertex>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vec4 previousWorldPos=finalPreviousWorld*vec4(positionUpdated,1.0);\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {clipPos=viewProjection*worldPos;previousClipPos=previousViewProjection*previousWorldPos;gl_Position=clipPos;} else {clipPos=viewProjectionR*worldPos;previousClipPos=previousViewProjectionR*previousWorldPos;gl_Position=clipPos;}\n#elif\nclipPos=viewProjection*worldPos;previousClipPos=previousViewProjection*previousWorldPos;gl_Position=clipPos;\n#endif\n#define CUSTOM_VERTEX_MAIN_END\n}";class dT extends Bn{constructor(e,t,i,s=512){super("spacewarp rtt",s,i,!1,!0,2,!1,void 0,!1,!1,!0,void 0,!0),this._originalPairing=[],this._previousWorldMatrices=[],this._previousTransforms=[y.Identity(),y.Identity()],this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight(),e,t),this._renderTarget._disposeOnlyFramebuffers=!0,this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,i&&(this._velocityMaterial=new kl("velocity shader material",i,{vertex:"velocity",fragment:"velocity"},{uniforms:["world","previousWorld","viewProjection","viewProjectionR","previousViewProjection","previousViewProjectionR"]}),this._velocityMaterial._materialHelperNeedsPreviousMatrices=!0,this._velocityMaterial.onBindObservable.add((e=>{this._previousWorldMatrices[e.uniqueId]=this._previousWorldMatrices[e.uniqueId]||e.getWorldMatrix(),this._velocityMaterial.getEffect().setMatrix("previousWorld",this._previousWorldMatrices[e.uniqueId]),this._previousWorldMatrices[e.uniqueId]=e.getWorldMatrix(),this._velocityMaterial.getEffect().setMatrix("previousViewProjection",this._previousTransforms[0]),this._velocityMaterial.getEffect().setMatrix("previousViewProjectionR",this._previousTransforms[1]),this._previousTransforms[0].copyFrom(i.getTransformMatrix()),this._previousTransforms[1].copyFrom(i._transformMatrixR)})),this._velocityMaterial.freeze())}render(e=!1,t=!1){this._originalPairing.length=0;const i=this.getScene();i&&this._velocityMaterial&&i.getActiveMeshes().forEach((e=>{this._originalPairing.push([e,e.material]),e.material=this._velocityMaterial})),super.render(e,t),this._originalPairing.forEach((e=>{e[0].material=e[1]}))}_bindFrameBuffer(){this._renderTarget&&this.getScene().getEngine().bindSpaceWarpFramebuffer(this._renderTarget)}getViewCount(){return 2}dispose(){super.dispose(),this._velocityMaterial.dispose(),this._previousTransforms.length=0,this._previousWorldMatrices.length=0,this._originalPairing.length=0}}class pT{constructor(e,t,i){this._scene=e,this._xrSessionManager=t,this._xrWebGLBinding=i,this._lastSubImages=new Map,this._renderTargetTextures=new Map,this._engine=e.getEngine()}_getSubImageForView(e){const t=this._xrSessionManager._getBaseLayerWrapper();if(!t)throw new Error("For Space Warp, the base layer should be a WebXR Projection Layer.");if("XRProjectionLayer"!==t.layerType)throw new Error('For Space Warp, the base layer type should "XRProjectionLayer".');const i=t.layer;return this._xrWebGLBinding.getViewSubImage(i,e)}_setViewportForSubImage(e,t){e.x=0,e.y=0,e.width=t.motionVectorTextureWidth,e.height=t.motionVectorTextureHeight}_createRenderTargetTexture(e,t,i,s,r){if(!this._engine)throw new Error("Engine is disposed");const n={width:e,height:t},o=new dT(s,r,this._scene,n),a=o.renderTarget;return i&&(a._framebuffer=i),a._colorTextureArray=s,a._depthStencilTextureArray=r,o.disableRescaling(),o.renderListPredicate=()=>!0,o}_getRenderTargetForSubImage(e,t){const i=this._lastSubImages.get(t);let s=this._renderTargetTextures.get(t.eye);const r=e.motionVectorTextureWidth,n=e.motionVectorTextureHeight;return s&&(null==i?void 0:i.textureWidth)===r&&(null==i?void 0:i.textureHeight)==n||(s=this._createRenderTargetTexture(r,n,null,e.motionVectorTexture,e.depthStencilTexture),this._renderTargetTextures.set(t.eye,s),this._framebufferDimensions={framebufferWidth:r,framebufferHeight:n}),this._lastSubImages.set(t,e),s}trySetViewportForView(e,t){const i=this._lastSubImages.get(t)||this._getSubImageForView(t);return!!i&&(this._setViewportForSubImage(e,i),!0)}accessMotionVector(e){const t=this._getSubImageForView(e);t&&(t.motionVectorTexture,t.depthStencilTexture)}getRenderTargetTextureForEye(e){return null}getRenderTargetTextureForView(e){const t=this._getSubImageForView(e);return t?this._getRenderTargetForSubImage(t,e):null}dispose(){this._renderTargetTextures.forEach((e=>e.dispose())),this._renderTargetTextures.clear()}}class _T extends Gr{constructor(e){super(e),this._onAfterRenderObserver=null,this.dependsOn=[Vr.LAYERS],this.xrNativeFeatureName="space-warp",this._xrSessionManager.scene.needsPreviousWorldMatrices=!0}attach(){if(!super.attach())return!1;const e=this._xrSessionManager.scene.getEngine();return this._glContext=e._gl,this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),this.spaceWarpRTTProvider=new pT(this._xrSessionManager.scene,this._xrSessionManager,this._xrWebGLBinding),this._onAfterRenderObserver=this._xrSessionManager.scene.onAfterRenderObservable.add((()=>this._onAfterRender())),!0}detach(){return this._xrSessionManager.scene.onAfterRenderObservable.remove(this._onAfterRenderObserver),super.detach()}_onAfterRender(){this.attached&&this._renderTargetTexture&&this._renderTargetTexture.render(!1,!1)}isCompatible(){return this._xrSessionManager.scene.getEngine().getCaps().colorBufferHalfFloat||!1}dispose(){super.dispose()}_onXRFrame(e){const t=e.getViewerPose(this._xrSessionManager.referenceSpace);if(!t)return;const i=t.views[0];this._renderTargetTexture=this._renderTargetTexture||this.spaceWarpRTTProvider.getRenderTargetTextureForView(i),this.spaceWarpRTTProvider.accessMotionVector(i)}}_T.Name=Vr.SPACE_WARP,_T.Version=1,kr.AddWebXRFeature(_T.Name,(e=>()=>new _T(e)),_T.Version,!1);class fT extends Gr{constructor(e,t={}){super(e),this.options=t,this._cachedInternalTextures=[],this.texturesData=[],this.viewIndex=[],this.cameraIntrinsics=[],this.onTexturesUpdatedObservable=new a,this.xrNativeFeatureName="camera-access"}attach(e){return!!super.attach(e)&&(this._glContext=this._xrSessionManager.scene.getEngine()._gl,this._glBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),!0)}detach(){return!!super.detach()&&(this._glBinding=void 0,this.options.doNotDisposeOnDetach||(this._cachedInternalTextures.forEach((e=>e.dispose())),this.texturesData.forEach((e=>e.dispose())),this._cachedInternalTextures.length=0,this.texturesData.length=0,this.cameraIntrinsics.length=0),!0)}dispose(){super.dispose(),this.onTexturesUpdatedObservable.clear()}_updateCameraIntrinsics(e,t){const i={width:e.camera.width,height:e.camera.height,x:0,y:0},s=e.projectionMatrix,r=(1-s[8])*i.width/2+i.x,n=(1-s[9])*i.height/2+i.y,o=i.width/2*s[0],a=i.height/2*s[5],l=i.width/2*s[4];this.cameraIntrinsics[t]={u0:r,v0:n,ax:o,ay:a,gamma:l,width:i.width,height:i.height,viewportX:i.x,viewportY:i.y}}_updateInternalTextures(e,t=0){var i,s;if(!e.camera)return!1;this.viewIndex[t]=e.eye;const r=null===(i=this._glBinding)||void 0===i?void 0:i.getCameraImage(e.camera);if(this._cachedInternalTextures[t])null===(s=this._cachedInternalTextures[t]._hardwareTexture)||void 0===s||s.set(r);else{const i=new dt(this._xrSessionManager.scene.getEngine(),ut.Unknown,!0);i.isCube=!0,i.invertY=!1,i.format=5,i.generateMipMaps=!0,i.type=1,i.samplingMode=3,i.width=e.camera.width,i.height=e.camera.height,i._cachedWrapU=1,i._cachedWrapV=1,i._hardwareTexture=new xt(r,this._glContext),this._cachedInternalTextures[t]=i;const s=new Cr(this._xrSessionManager.scene);s.name=`WebXR Raw Camera Access (${t})`,s._texture=this._cachedInternalTextures[t],this.texturesData[t]=s,this._updateCameraIntrinsics(e,t)}return this._cachedInternalTextures[t].isReady=!0,!0}_onXRFrame(e){const t=this._xrSessionManager.referenceSpace,i=e.getViewerPose(t);if(!i||!i.views)return;let s=!0;i.views.forEach(((e,t)=>{s=s&&this._updateInternalTextures(e,t)})),s&&this.onTexturesUpdatedObservable.notifyObservers(this.texturesData)}}fT.Name=Vr.RAW_CAMERA_ACCESS,fT.Version=1,kr.AddWebXRFeature(fT.Name,((e,t)=>()=>new fT(e,t)),fT.Version,!1);class mT extends tp{constructor(e,t,i){super(e,gT[i],t,i,!0),this.profileId="generic-hand-select-grasp"}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){}_setRootMesh(e){}_updateModel(){}}op.RegisterController("generic-hand-select-grasp",((e,t)=>new mT(t,e.gamepad,e.handedness)));const gT={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-none",assetPath:"none.glb"}};class vT extends tp{constructor(e,t,i){super(e,xT["left-right"],t,i),this._mapping={defaultButton:{valueNodeName:"VALUE",unpressedNodeName:"UNPRESSED",pressedNodeName:"PRESSED"},defaultAxis:{valueNodeName:"VALUE",minNodeName:"MIN",maxNodeName:"MAX"},buttons:{"xr-standard-trigger":{rootNodeName:"SELECT",componentProperty:"button",states:["default","touched","pressed"]},"xr-standard-squeeze":{rootNodeName:"GRASP",componentProperty:"state",states:["pressed"]},"xr-standard-touchpad":{rootNodeName:"TOUCHPAD_PRESS",labelAnchorNodeName:"squeeze-label",touchPointNodeName:"TOUCH"},"xr-standard-thumbstick":{rootNodeName:"THUMBSTICK_PRESS",componentProperty:"state",states:["pressed"]}},axes:{"xr-standard-touchpad":{"x-axis":{rootNodeName:"TOUCHPAD_TOUCH_X"},"y-axis":{rootNodeName:"TOUCHPAD_TOUCH_Y"}},"xr-standard-thumbstick":{"x-axis":{rootNodeName:"THUMBSTICK_X"},"y-axis":{rootNodeName:"THUMBSTICK_Y"}}}},this.profileId="microsoft-mixed-reality"}_getFilenameAndPath(){let e="";return e="left"===this.handedness?vT.MODEL_LEFT_FILENAME:vT.MODEL_RIGHT_FILENAME,{filename:e,path:vT.MODEL_BASE_URL+"default/"}}_getModelLoadingConstraints(){const e=Hr.IsPluginForExtensionAvailable(".glb");return e||k.Warn("glTF / glb loaded was not registered, using generic controller instead"),e}_processLoadedModel(e){this.rootMesh&&(this.getComponentIds().forEach(((e,t)=>{if(!this.disableAnimation&&e&&this.rootMesh){const i=this._mapping.buttons[e],s=i.rootNodeName;if(!s)return void k.Log("Skipping unknown button at index: "+t+" with mapped name: "+e);const r=this._getChildByName(this.rootMesh,s);if(!r)return void k.Warn("Missing button mesh with name: "+s);if(i.valueMesh=this._getImmediateChildByName(r,this._mapping.defaultButton.valueNodeName),i.pressedMesh=this._getImmediateChildByName(r,this._mapping.defaultButton.pressedNodeName),i.unpressedMesh=this._getImmediateChildByName(r,this._mapping.defaultButton.unpressedNodeName),i.valueMesh&&i.pressedMesh&&i.unpressedMesh){const t=this.getComponent(e);t&&t.onButtonStateChangedObservable.add((e=>{this._lerpTransform(i,e.value)}),void 0,!0)}else k.Warn("Missing button submesh under mesh with name: "+s)}})),this.getComponentIds().forEach((e=>{const t=this.getComponent(e);t.isAxes()&&["x-axis","y-axis"].forEach((i=>{if(!this.rootMesh)return;const s=this._mapping.axes[e][i],r=this._getChildByName(this.rootMesh,s.rootNodeName);r?(s.valueMesh=this._getImmediateChildByName(r,this._mapping.defaultAxis.valueNodeName),s.minMesh=this._getImmediateChildByName(r,this._mapping.defaultAxis.minNodeName),s.maxMesh=this._getImmediateChildByName(r,this._mapping.defaultAxis.maxNodeName),s.valueMesh&&s.minMesh&&s.maxMesh?t&&t.onAxisValueChangedObservable.add((e=>{const t="x-axis"===i?e.x:e.y;this._lerpTransform(s,t,!0)}),void 0,!0):k.Warn("Missing axis submesh under mesh with name: "+s.rootNodeName)):k.Warn("Missing axis mesh with name: "+s.rootNodeName)}))})))}_setRootMesh(e){let t;this.rootMesh=new ur(this.profileId+" "+this.handedness,this.scene),this.rootMesh.isPickable=!1;for(let i=0;i<e.length;i++){const s=e[i];s.isPickable=!1,s.parent||(t=s)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=C.FromEulerAngles(0,Math.PI,0))}_updateModel(){}}vT.MODEL_BASE_URL="https://controllers.babylonjs.com/microsoft/",vT.MODEL_LEFT_FILENAME="left.glb",vT.MODEL_RIGHT_FILENAME="right.glb",op.RegisterController("windows-mixed-reality",((e,t)=>new vT(t,e.gamepad,e.handedness)));const xT={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-right",assetPath:"right.glb"}};class TT extends tp{constructor(e,t,i,s=!1,r=!1){super(e,ET[i],t,i),this._forceLegacyControllers=r,this.profileId="oculus-touch"}_getFilenameAndPath(){let e="";return e="left"===this.handedness?TT.MODEL_LEFT_FILENAME:TT.MODEL_RIGHT_FILENAME,{filename:e,path:this._isQuest()?TT.QUEST_MODEL_BASE_URL:TT.MODEL_BASE_URL}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){const t=this._isQuest(),i="right"===this.handedness?-1:1;this.getComponentIds().forEach((e=>{const s=e&&this.getComponent(e);s&&s.onButtonStateChangedObservable.add((s=>{if(this.rootMesh&&!this.disableAnimation)switch(e){case"xr-standard-trigger":return void(t||(this._modelRootNode.getChildren()[3].rotation.x=.2*-s.value,this._modelRootNode.getChildren()[3].position.y=.005*-s.value,this._modelRootNode.getChildren()[3].position.z=.005*-s.value));case"xr-standard-squeeze":return void(t||(this._modelRootNode.getChildren()[4].position.x=i*s.value*.0035));case"xr-standard-thumbstick":return;case"a-button":case"x-button":return void(t||(s.pressed?this._modelRootNode.getChildren()[1].position.y=-.001:this._modelRootNode.getChildren()[1].position.y=0));case"b-button":case"y-button":return void(t||(s.pressed?this._modelRootNode.getChildren()[2].position.y=-.001:this._modelRootNode.getChildren()[2].position.y=0))}}),void 0,!0)}))}_setRootMesh(e){this.rootMesh=new ur(this.profileId+" "+this.handedness,this.scene),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=C.FromEulerAngles(0,Math.PI,0)),e.forEach((e=>{e.isPickable=!1})),this._isQuest()?this._modelRootNode=e[0]:(this._modelRootNode=e[1],this.rootMesh.position.y=.034,this.rootMesh.position.z=.052),this._modelRootNode.parent=this.rootMesh}_updateModel(){}_isQuest(){return!!navigator.userAgent.match(/Quest/gi)&&!this._forceLegacyControllers}}TT.MODEL_BASE_URL="https://controllers.babylonjs.com/oculus/",TT.MODEL_LEFT_FILENAME="left.babylon",TT.MODEL_RIGHT_FILENAME="right.babylon",TT.QUEST_MODEL_BASE_URL="https://controllers.babylonjs.com/oculusQuest/",op.RegisterController("oculus-touch",((e,t)=>new TT(t,e.gamepad,e.handedness))),op.RegisterController("oculus-touch-legacy",((e,t)=>new TT(t,e.gamepad,e.handedness,!0)));const ET={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"x-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"x_button",visualResponses:{}},"y-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"y_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"a-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"a_button",visualResponses:{}},"b-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"b_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-right",assetPath:"right.glb"}};class ST extends tp{constructor(e,t,i){super(e,bT[i],t,i),this.profileId="htc-vive"}_getFilenameAndPath(){return{filename:ST.MODEL_FILENAME,path:ST.MODEL_BASE_URL}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){this.getComponentIds().forEach((e=>{const t=e&&this.getComponent(e);t&&t.onButtonStateChangedObservable.add((t=>{if(this.rootMesh&&!this.disableAnimation)switch(e){case"xr-standard-trigger":return void(this._modelRootNode.getChildren()[6].rotation.x=.15*-t.value);case"xr-standard-touchpad":case"xr-standard-squeeze":return}}),void 0,!0)}))}_setRootMesh(e){this.rootMesh=new ur(this.profileId+" "+this.handedness,this.scene),e.forEach((e=>{e.isPickable=!1})),this._modelRootNode=e[1],this._modelRootNode.parent=this.rootMesh,this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=C.FromEulerAngles(0,Math.PI,0))}_updateModel(){}}ST.MODEL_BASE_URL="https://controllers.babylonjs.com/vive/",ST.MODEL_FILENAME="wand.babylon",op.RegisterController("htc-vive",((e,t)=>new ST(t,e.gamepad,e.handedness)));const bT={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc-vive-none",assetPath:"none.glb"}};var CT;!async function(){(await new Promise((e=>{"undefined"==typeof _native?sc.addOnce((t=>e(t))):e(_native)}))).NativeXRFrame=class{get session(){return this._nativeImpl.session}constructor(e){this._nativeImpl=e,this._xrTransform=new XRRigidTransform,this._xrPose={transform:this._xrTransform,emulatedPosition:!1},this._xrPoseVectorData=new Float32Array(8),this.fillPoses=this._nativeImpl.fillPoses.bind(this._nativeImpl),this.getViewerPose=this._nativeImpl.getViewerPose.bind(this._nativeImpl),this.getHitTestResults=this._nativeImpl.getHitTestResults.bind(this._nativeImpl),this.getHitTestResultsForTransientInput=()=>{throw new Error("XRFrame.getHitTestResultsForTransientInput not supported on native.")},this.createAnchor=this._nativeImpl.createAnchor.bind(this._nativeImpl),this.getJointPose=this._nativeImpl.getJointPose.bind(this._nativeImpl),this.fillJointRadii=this._nativeImpl.fillJointRadii.bind(this._nativeImpl),this.getLightEstimate=()=>{throw new Error("XRFrame.getLightEstimate not supported on native.")},this.getImageTrackingResults=()=>{var e;return null!==(e=this._nativeImpl._imageTrackingResults)&&void 0!==e?e:[]}}getPose(e,t){if(!this._nativeImpl.getPoseData(e,t,this._xrPoseVectorData.buffer,this._xrTransform.matrix.buffer))return;const i=this._xrTransform.position;i.x=this._xrPoseVectorData[0],i.y=this._xrPoseVectorData[1],i.z=this._xrPoseVectorData[2],i.w=this._xrPoseVectorData[3];const s=this._xrTransform.orientation;return s.x=this._xrPoseVectorData[4],s.y=this._xrPoseVectorData[5],s.z=this._xrPoseVectorData[6],s.w=this._xrPoseVectorData[7],this._xrPose}get trackedAnchors(){return this._nativeImpl.trackedAnchors}get worldInformation(){return this._nativeImpl.worldInformation}get detectedPlanes(){return this._nativeImpl.detectedPlanes}get featurePointCloud(){return this._nativeImpl.featurePointCloud}getDepthInformation(e){throw new Error("This function is not available in Babylon Native")}}}(),function(e){e[e.Input=0]="Input",e[e.Output=1]="Output"}(CT||(CT={}));class yT{constructor(e,t,i){this._ownerBlock=i,this._connectedPoint=[],this.uniqueId=Wt(),this.connectedPointIds=[],this.name=e,this._connectionType=t}get connectionType(){return this._connectionType}_isSingularConnection(){return!0}isConnected(){return this._connectedPoint.length>0}connectTo(e){if(this._connectionType===e._connectionType)throw new Error(`Cannot connect two points of type ${this.connectionType}`);if(this._isSingularConnection()&&this._connectedPoint.length>0||e._isSingularConnection()&&e._connectedPoint.length>0)throw new Error("Max number of connections for point reached");this._connectedPoint.push(e),e._connectedPoint.push(this)}serialize(e={}){e.uniqueId=this.uniqueId,e.name=this.name,e._connectionType=this._connectionType,e.connectedPointIds=[],e.className=this.getClassName();for(const t of this._connectedPoint)e.connectedPointIds.push(t.uniqueId)}getClassName(){return"FGConnection"}deserialize(e){this.uniqueId=e.uniqueId,this.name=e.name,this._connectionType=e._connectionType,this.connectedPointIds=e.connectedPointIds}static Parse(e={},t){const i=new(Ht.Instantiate(e.className))(e.name,e._connectionType,t);return i.deserialize(e),i}}class AT{constructor(e,t){this.typeName=e,this.defaultValue=t}serialize(e){e.typeName=this.typeName,e.defaultValue=this.defaultValue}static Parse(e){return new AT(e.typeName,e.defaultValue)}}const RT=new AT("any",void 0),IT=new AT("string",""),PT=new AT("number",0),MT=new AT("boolean",!1),OT=new AT("Vector2",E.Zero()),DT=new AT("Vector3",S.Zero()),NT=new AT("Vector4",b.Zero()),FT=new AT("Matrix",y.Identity()),wT=new AT("Color3",N.Black()),LT=new AT("Color4",new F(0,0,0,0)),BT=new AT("Quaternion",C.Identity());class UT extends yT{constructor(e,t,i,s){super(e,t,i),this.richType=s}_isSingularConnection(){return this.connectionType===CT.Input}setValue(e,t){t._setConnectionValue(this,e)}connectTo(e){super.connectTo(e)}_getValueOrDefault(e){return e._hasConnectionValue(this)?e._getConnectionValue(this):this.richType.defaultValue}getValue(e){return this.connectionType===CT.Output?(e._notifyExecuteNode(this._ownerBlock),this._ownerBlock._updateOutputs(e),this._getValueOrDefault(e)):this.isConnected()?this._connectedPoint[0].getValue(e):this._getValueOrDefault(e)}getClassName(){return"FGDataConnection"}serialize(e={}){super.serialize(e),e.richType={},this.richType.serialize(e.richType)}static Parse(e,t){const i=yT.Parse(e,t);return i.richType=AT.Parse(e.richType),i}}m("FGDataConnection",UT);class VT{constructor(e){this.config=e,this.uniqueId=Wt(),this.configure()}configure(){var e,t;this.name=null!==(t=null===(e=this.config)||void 0===e?void 0:e.name)&&void 0!==t?t:this.getClassName(),this.dataInputs=[],this.dataOutputs=[]}_updateOutputs(e){}registerDataInput(e,t){const i=new UT(e,CT.Input,this,t);return this.dataInputs.push(i),i}registerDataOutput(e,t){const i=new UT(e,CT.Output,this,t);return this.dataOutputs.push(i),i}getDataInput(e){return this.dataInputs.find((t=>t.name===e))}serialize(e={}){e.uniqueId=this.uniqueId,e.config={},this.config&&(e.config.name=this.config.name),e.dataInputs=[],e.dataOutputs=[],e.className=this.getClassName();for(const t of this.dataInputs){const i={};t.serialize(i),e.dataInputs.push(i)}for(const t of this.dataOutputs){const i={};t.serialize(i),e.dataOutputs.push(i)}}getClassName(){return"FGBlock"}static Parse(e){const t=Ht.Instantiate(e.className),i={};if(e.config)for(const t in e.config){const s=e.config[t];if(s&&s.className){const e=Ht.Instantiate(s.className);i[t]=e.prototype.Parse(s)}else i[t]=s}const s=new t(i);s.uniqueId=e.uniqueId;for(let t=0;t<e.dataInputs.length;t++)s.dataInputs[t].deserialize(e.dataInputs[t]);for(let t=0;t<e.dataOutputs.length;t++)s.dataOutputs[t].deserialize(e.dataOutputs[t]);if(s instanceof GT){for(let t=0;t<e.signalInputs.length;t++)s.signalInputs[t].deserialize(e.signalInputs[t]);for(let t=0;t<e.signalOutputs.length;t++)s.signalOutputs[t].deserialize(e.signalOutputs[t])}return s}}class kT extends yT{_isSingularConnection(){return this.connectionType===CT.Output}_activateSignal(e){var t;this.connectionType===CT.Input?(e._notifyExecuteNode(this._ownerBlock),this._ownerBlock._execute(e,this),e._increaseExecutionId()):null===(t=this._connectedPoint[0])||void 0===t||t._activateSignal(e)}}m("FlowGraphSignalConnection",kT);class GT extends VT{constructor(e){super(e),this.onStart=this._registerSignalInput("onStart")}configure(){super.configure(),this.signalInputs=[],this.signalOutputs=[]}_registerSignalInput(e){const t=new kT(e,CT.Input,this);return this.signalInputs.push(t),t}_registerSignalOutput(e){const t=new kT(e,CT.Output,this);return this.signalOutputs.push(t),t}serialize(e={}){super.serialize(e),e.signalInputs=[],e.signalOutputs=[];for(const t of this.signalInputs){const i={};t.serialize(i),e.signalInputs.push(i)}for(const t of this.signalOutputs){const i={};t.serialize(i),e.signalOutputs.push(i)}}getClassName(){return"FGExecutionBlock"}static Parse(e={}){const t=super.Parse(e);for(let i=0;i<e.signalInputs.length;i++)t.signalInputs[i].deserialize(e.signalInputs[i]);for(let i=0;i<e.signalOutputs.length;i++)t.signalOutputs[i].deserialize(e.signalOutputs[i]);return t}}class zT extends GT{constructor(e){super(e),this.onDone=this._registerSignalOutput("onDone")}_startPendingTasks(e){this._preparePendingTasks(e),e._addPendingBlock(this)}}class WT extends zT{_execute(e){e._notifyExecuteNode(this),this.onDone._activateSignal(e)}}function HT(e){return"Mesh"===e||"AbstractMesh"===e||"GroundMesh"===e||"InstanceMesh"===e||"LinesMesh"===e||"GoldbergMesh"===e||"GreasedLineMesh"===e||"TrailMesh"===e}function XT(e){return"Vector2"===e||"Vector3"===e||"Vector4"===e||"Quaternion"===e}function YT(e,t,i){var s,r;const n=null!==(r=null===(s=null==t?void 0:t.getClassName)||void 0===s?void 0:s.call(t))&&void 0!==r?r:"";HT(n)?i[e]={name:t.name,className:n}:XT(n)?i[e]={value:t.asArray(),className:n}:i[e]=t}function jT(e,t,i){const s=t[e];let r;const n=null==s?void 0:s.className;return r=HT(n)?i.getMeshByName(s.name):XT(n)?function(e,t){if("Vector2"===e)return E.FromArray(t);if("Vector3"===e)return S.FromArray(t);if("Vector4"===e)return b.FromArray(t);if("Quaternion"===e)return C.FromArray(t);throw new Error(`Unknown vector class name ${e}`)}(n,s.value):s,r}class KT{constructor(e){this.uniqueId=Wt(),this._userVariables={},this._executionVariables={},this._connectionValues={},this._pendingBlocks=[],this._executionId=0,this.onNodeExecutedObservable=new a,this._configuration=e}hasVariable(e){return e in this._userVariables}setVariable(e,t){this._userVariables[e]=t}getVariable(e){return this._userVariables[e]}_getUniqueIdPrefixedName(e,t){return`${e.uniqueId}_${t}`}_setExecutionVariable(e,t,i){this._executionVariables[this._getUniqueIdPrefixedName(e,t)]=i}_getExecutionVariable(e,t,i){return this._hasExecutionVariable(e,t)?this._executionVariables[this._getUniqueIdPrefixedName(e,t)]:i}_deleteExecutionVariable(e,t){delete this._executionVariables[this._getUniqueIdPrefixedName(e,t)]}_hasExecutionVariable(e,t){return this._getUniqueIdPrefixedName(e,t)in this._executionVariables}_hasConnectionValue(e){return e.uniqueId in this._connectionValues}_setConnectionValue(e,t){this._connectionValues[e.uniqueId]=t}_getConnectionValue(e){return this._connectionValues[e.uniqueId]}get configuration(){return this._configuration}_addPendingBlock(e){this._pendingBlocks.push(e)}_removePendingBlock(e){const t=this._pendingBlocks.indexOf(e);-1!==t&&this._pendingBlocks.splice(t,1)}_clearPendingBlocks(){for(const e of this._pendingBlocks)e._cancelPendingTasks(this);this._pendingBlocks.length=0}_notifyExecuteNode(e){this.onNodeExecutedObservable.notifyObservers(e)}_increaseExecutionId(){this._executionId++}get executionId(){return this._executionId}serialize(e={},t=YT){e.uniqueId=this.uniqueId,e._userVariables={};for(const i in this._userVariables)t(i,this._userVariables[i],e._userVariables);e._connectionValues={};for(const i in this._connectionValues)t(i,this._connectionValues[i],e._connectionValues)}getClassName(){return"FGContext"}static Parse(e={},t,i=jT){const s=t.createContext();s.uniqueId=e.uniqueId;for(const t in e._userVariables){const r=i(t,e._userVariables,s._configuration.scene);s._userVariables[t]=r}for(const t in e._connectionValues){const r=i(t,e._connectionValues,s._configuration.scene);s._connectionValues[t]=r}return s}}function $T(e,t){return!(!e.parent||e.parent!==t&&!$T(e.parent,t))}me([ie()],KT.prototype,"uniqueId",void 0);class qT extends WT{constructor(e){e.path.hasTemplateStrings&&Ht.Warn("Template strings are not supported in the path of mesh pick event blocks."),super(e),this.config=e}_getReferencedMesh(e){return this.config.path.getProperty(e)}_preparePendingTasks(e){let t=e._getExecutionVariable(this,"meshPickObserver");if(!t){const i=this.config.path.getProperty(e);if(!(i&&i instanceof Vs))throw new Error("Mesh pick event block requires a valid mesh");e._setExecutionVariable(this,"mesh",i),t=i.getScene().onPointerObservable.add((t=>{var s,r,n;t.type===gi.POINTERPICK&&(null===(s=t.pickInfo)||void 0===s?void 0:s.pickedMesh)&&((null===(r=t.pickInfo)||void 0===r?void 0:r.pickedMesh)===i||$T(null===(n=t.pickInfo)||void 0===n?void 0:n.pickedMesh,i))&&this._execute(e)}));const s=i.onDisposeObservable.add((()=>this._onDispose));e._setExecutionVariable(this,"meshPickObserver",t),e._setExecutionVariable(this,"meshDisposeObserver",s)}}_onDispose(e){this._cancelPendingTasks(e),e._removePendingBlock(this)}_cancelPendingTasks(e){const t=e._getExecutionVariable(this,"mesh"),i=e._getExecutionVariable(this,"meshPickObserver"),s=e._getExecutionVariable(this,"meshDisposeObserver");t.getScene().onPointerObservable.remove(i),t.onDisposeObservable.remove(s),e._deleteExecutionVariable(this,"mesh"),e._deleteExecutionVariable(this,"meshPickObserver"),e._deleteExecutionVariable(this,"meshDisposeObserver")}getClassName(){return qT.ClassName}serialize(e){super.serialize(e),e.config.path=this.config.path.serialize()}}var QT;qT.ClassName="FGMeshPickEventBlock",m(qT.ClassName,qT),function(e){e[e.Stopped=0]="Stopped",e[e.Started=1]="Started"}(QT||(QT={}));class ZT{constructor(e){this._eventBlocks=[],this._executionContexts=[],this.state=QT.Stopped,this._scene=e.scene,this._coordinator=e.coordinator,this._sceneDisposeObserver=this._scene.onDisposeObservable.add((()=>this.dispose()))}createContext(){const e=new KT({scene:this._scene,coordinator:this._coordinator});return this._executionContexts.push(e),e}addEventBlock(e){this._eventBlocks.push(e)}start(){if(this.state!==QT.Started){this.state=QT.Started,0===this._executionContexts.length&&this.createContext();for(const e of this._executionContexts){const t=this._getContextualOrder(e);for(const i of t)i._startPendingTasks(e)}}}_getContextualOrder(e){const t=[];for(const i of this._eventBlocks)if(i.getClassName()===qT.ClassName){const s=i._getReferencedMesh(e);let r=0;for(;r<t.length;r++){const i=t[r]._getReferencedMesh(e);if(s&&i&&$T(s,i))break}t.splice(r,0,i)}else t.push(i);return t}dispose(){if(this.state!==QT.Stopped){this.state=QT.Stopped;for(const e of this._executionContexts)e._clearPendingBlocks();this._executionContexts.length=0,this._eventBlocks.length=0,this._scene.onDisposeObservable.remove(this._sceneDisposeObserver),this._sceneDisposeObserver=null}}visitAllBlocks(e){const t=[],i=new Set;for(const e of this._eventBlocks)t.push(e),i.add(e.uniqueId);for(;t.length>0;){const s=t.pop();e(s);for(const e of s.dataInputs)for(const s of e._connectedPoint)i.has(s._ownerBlock.uniqueId)||(t.push(s._ownerBlock),i.add(s._ownerBlock.uniqueId));if(s instanceof GT)for(const e of s.signalOutputs)for(const s of e._connectedPoint)i.has(s._ownerBlock.uniqueId)||(t.push(s._ownerBlock),i.add(s._ownerBlock.uniqueId))}}serialize(e={},t){e.variableDefinitions={},e.allBlocks=[],this.visitAllBlocks((t=>{const i={};t.serialize(i),e.allBlocks.push(i)})),e.executionContexts=[];for(const i of this._executionContexts){const s={};i.serialize(s,t),e.executionContexts.push(s)}}static GetDataOutConnectionByUniqueId(e,t){for(const i of e)for(const e of i.dataOutputs)if(e.uniqueId===t)return e;throw new Error("Could not find data out connection with unique id "+t)}static GetSignalInConnectionByUniqueId(e,t){for(const i of e)if(i instanceof GT)for(const e of i.signalInputs)if(e.uniqueId===t)return e;throw new Error("Could not find signal in connection with unique id "+t)}static Parse(e,t,i){const s=t.createGraph(),r=[];for(const t of e.allBlocks){const e=VT.Parse(t);r.push(e),e instanceof WT&&s.addEventBlock(e)}for(const e of r){for(const t of e.dataInputs)for(const e of t.connectedPointIds){const i=ZT.GetDataOutConnectionByUniqueId(r,e);t.connectTo(i)}if(e instanceof GT)for(const t of e.signalOutputs)for(const e of t.connectedPointIds){const i=ZT.GetSignalInConnectionByUniqueId(r,e);t.connectTo(i)}}for(const t of e.executionContexts)KT.Parse(t,s,i);return s}}class JT{constructor(e){var t;this._config=e,this._flowGraphs=[],this._customEventsMap=new Map,this._config.scene.onDisposeObservable.add((()=>{this.dispose()})),(null!==(t=JT.SceneCoordinators.get(this._config.scene))&&void 0!==t?t:[]).push(this)}createGraph(){const e=new ZT({scene:this._config.scene,coordinator:this});return this._flowGraphs.push(e),e}removeGraph(e){const t=this._flowGraphs.indexOf(e);-1!==t&&(e.dispose(),this._flowGraphs.splice(t,1))}start(){this._flowGraphs.forEach((e=>e.start()))}dispose(){var e;this._flowGraphs.forEach((e=>e.dispose())),this._flowGraphs.length=0;const t=null!==(e=JT.SceneCoordinators.get(this._config.scene))&&void 0!==e?e:[],i=t.indexOf(this);-1!==i&&t.splice(i,1)}serialize(e,t){e._flowGraphs=[],this._flowGraphs.forEach((i=>{const s={};i.serialize(s,t),e._flowGraphs.push(s)}))}static Parse(e,t,i){var s;const r=new JT({scene:t});return null===(s=e._flowGraphs)||void 0===s||s.forEach((e=>{ZT.Parse(e,r,i)})),r}getCustomEventObservable(e){let t=this._customEventsMap.get(e);return t||(t=new a,this._customEventsMap.set(e,t)),t}notifyCustomEvent(e,t){const i=this._customEventsMap.get(e);i&&i.notifyObservers(t)}}JT.SceneCoordinators=new Map;const eE=/([./])({?\w+}?)/g;class tE{constructor(e){this._templateSubstitutions={},this._pathParts=[],this._templateStrings=[],this.hasTemplateStrings=!1,this._path=e;const{pathParts:t,templateStrings:i}=this._getPathPartsAndTemplateStrings(e);this._pathParts=t,this._templateStrings=i,this.hasTemplateStrings=i.length>0}_getPathPartsAndTemplateStrings(e){const t=e.matchAll(eE),i=[],s=[];let r=t.next();for(;!r.done;){const e=r.value,[,n,o]=e;let a=o,l=!1;o.startsWith("{")&&o.endsWith("}")&&(l=!0,a=o.slice(1,o.length-1),-1===s.indexOf(a)&&s.push(a)),i.push({value:o,isTemplate:l,valueWithoutBraces:a,separator:n}),r=t.next()}return{pathParts:i,templateStrings:s}}getTemplateStrings(){return this._templateStrings}setTemplateSubstitution(e,t){if(-1===this._templateStrings.indexOf(e))throw new Error(`Template string ${e} does not exist in path ${this._path}`);this._templateSubstitutions[e]=t}_evaluateTemplates(){for(const e of this._pathParts)if(e.isTemplate){const t=this._templateSubstitutions[e.valueWithoutBraces];if(void 0===t)throw new Error(`Template string ${e.value} was not substituted`);e.replacedValue=t.toString()}}_getFinalPath(){let e="";for(const t of this._pathParts)e+=t.separator,t.isTemplate?e+=t.replacedValue:e+=t.value;return e}_evaluatePath(e){this._evaluateTemplates();const t=[],i=[];let s=e._userVariables;for(const e of this._pathParts){if(void 0===s)throw new Error(`Could not find path ${this._getFinalPath()} in target context`);const r=e.isTemplate?e.replacedValue:e.value;if(!r)throw new Error(`Invalid path ${this._getFinalPath()}`);s=s[r],t.push(s),i.push(r)}return{entityChain:t,splitPath:i}}getProperty(e){const{entityChain:t}=this._evaluatePath(e);return t[t.length-1]}setProperty(e,t){const{entityChain:i,splitPath:s}=this._evaluatePath(e);i[i.length-2][s[s.length-1]]=t}getClassName(){return"FGPath"}serialize(e={}){return e.path=this._path,e.className=this.getClassName(),e}Parse(e){return new tE(e.path)}}m("FGPath",tE);class iE extends GT{constructor(e){super(e),this.onDone=this._registerSignalOutput("onDone")}}m("FGLogBlock",class extends iE{constructor(e){super(e),this.message=this.registerDataInput("message",RT)}_execute(e){const t=this.message.getValue(e);console.log(t),this.onDone._activateSignal(e)}getClassName(){return"FGLogBlock"}}),m("FGSetVariableBlock",class extends iE{constructor(e){super(e),this.variableName=this.registerDataInput("variableName",IT),this.input=this.registerDataInput("input",RT)}_execute(e){const t=this.variableName.getValue(e),i=this.input.getValue(e);e.setVariable(t,i),this.onDone._activateSignal(e)}getClassName(){return"FGSetVariableBlock"}});class sE{constructor(e,t){this.templateStringInputs=[],this.path=e,this.ownerBlock=t;for(const t of e.getTemplateStrings())this.templateStringInputs.push(this.ownerBlock.registerDataInput(t,PT))}substitutePath(e){for(const t of this.templateStringInputs){const i=t.getValue(e),s=t.name;this.path.setTemplateSubstitution(s,i)}return this.path}getProperty(e){return this.substitutePath(e),this.path.getProperty(e)}setProperty(e,t){this.substitutePath(e),this.path.setProperty(e,t)}}m("FGSetPropertyBlock",class extends iE{constructor(e){super(e),this.config=e,this.value=this.registerDataInput("value",RT),this.templateComponent=new sE(e.path,this)}_execute(e){const t=this.value.getValue(e);this.templateComponent.setProperty(e,t),this.onDone._activateSignal(e)}serialize(e={}){super.serialize(e),e.config.path=this.config.path.serialize()}getClassName(){return"FGSetPropertyBlock"}}),m("FGSendCustomEventBlock",class extends iE{constructor(e){super(e),this.eventId=this.registerDataInput("eventId",IT),this.eventData=this.registerDataInput("eventData",RT)}_execute(e){const t=this.eventId.getValue(e),i=this.eventData.getValue(e);e.configuration.coordinator.notifyCustomEvent(t,i),this.onDone._activateSignal(e)}getClassName(){return"FGSendCustomEventBlock"}}),m("FGBranchBlock",class extends GT{constructor(e){super(e),this.condition=this.registerDataInput("condition",MT),this.onTrue=this._registerSignalOutput("onTrue"),this.onFalse=this._registerSignalOutput("onFalse")}_execute(e){this.condition.getValue(e)?this.onTrue._activateSignal(e):this.onFalse._activateSignal(e)}getClassName(){return"FGBranchBlock"}}),m("FGDoNBlock",class extends iE{constructor(e){super(e),this.reset=this._registerSignalInput("reset"),this.maxNumberOfExecutions=this.registerDataInput("numberOfExecutions",PT),this.currentCount=this.registerDataOutput("currentCount",PT)}_execute(e,t){if(t===this.reset)this.currentCount.setValue(0,e);else{const t=this.currentCount.getValue(e);t<this.maxNumberOfExecutions.getValue(e)&&(this.currentCount.setValue(t+1,e),this.onDone._activateSignal(e))}}getClassName(){return"FGDoNBlock"}}),m("FGForLoopBlock",class extends iE{constructor(e){super(e),this.startIndex=this.registerDataInput("startIndex",PT),this.endIndex=this.registerDataInput("endIndex",PT),this.step=this.registerDataInput("step",PT),this.index=this.registerDataOutput("index",PT),this.onLoop=this._registerSignalOutput("onLoop"),this.onDone=this._registerSignalOutput("onDone")}_executeLoop(e){let t=e._getExecutionVariable(this,"index");t<e._getExecutionVariable(this,"endIndex")?(this.index.setValue(t,e),this.onLoop._activateSignal(e),t+=e._getExecutionVariable(this,"step",1),e._setExecutionVariable(this,"index",t),this._executeLoop(e)):this.onDone._activateSignal(e)}_execute(e){const t=this.startIndex.getValue(e),i=this.endIndex.getValue(e),s=this.step.getValue(e);e._setExecutionVariable(this,"index",t),e._setExecutionVariable(this,"endIndex",i),e._setExecutionVariable(this,"step",s),this._executeLoop(e)}getClassName(){return"FGForLoopBlock"}}),m("FGThrottleBlock",class extends iE{constructor(e){super(e),this.reset=this._registerSignalInput("reset"),this.duration=this.registerDataInput("duration",PT),this.timeRemaining=this.registerDataOutput("timeRemaining",PT)}_execute(e,t){const i=e._getExecutionVariable(this,"lastExecutedTime"),s=this.duration.getValue(e),r=Date.now();if(t===this.reset||void 0===i||r-i>s)this.timeRemaining.setValue(0,e),this.onDone._activateSignal(e),e._setExecutionVariable(this,"lastExecutedTime",r);else{const t=s-(r-i);this.timeRemaining.setValue(t,e)}}getClassName(){return"FGThrottleBlock"}}),m("FGTimerBlock",class extends zT{constructor(e){super(e),this.timeout=this.registerDataInput("timeout",PT),this.onTimerDone=this._registerSignalOutput("onTimerDone")}_preparePendingTasks(e){const t=this.timeout.getValue(e);if(void 0!==t&&t>=0){const i=e._getExecutionVariable(this,"runningTimers")||[],s=e.configuration.scene,r=new vp({timeout:t,contextObservable:s.onBeforeRenderObservable,onEnded:()=>this._onEnded(r,e)});r.start(),i.push(r),e._setExecutionVariable(this,"runningTimers",i)}}_execute(e){this._startPendingTasks(e),this.onDone._activateSignal(e)}_onEnded(e,t){const i=t._getExecutionVariable(this,"runningTimers")||[],s=i.indexOf(e);-1!==s?i.splice(s,1):Ht.Warn("FlowGraphTimerBlock: Timer ended but was not found in the running timers list"),t._removePendingBlock(this),this.onTimerDone._activateSignal(t)}_cancelPendingTasks(e){const t=e._getExecutionVariable(this,"runningTimers")||[];for(const e of t)e.dispose();e._deleteExecutionVariable(this,"runningTimers")}getClassName(){return"FGTimerBlock"}}),m("FGMultiGateBlock",class extends GT{constructor(e){super(e),this.config=e,this._cachedUnusedIndexes=[],this.reset=this._registerSignalInput("reset"),this.currentIndex=this.registerDataOutput("currentIndex",PT)}configure(){super.configure(),this.config.startIndex=void 0!==this.config.startIndex?this.config.startIndex:0,this.config.startIndex=Math.max(0,Math.min(this.config.startIndex,this.config.numberOutputFlows-1)),this.outFlows=[];for(let e=0;e<this.config.numberOutputFlows;e++)this.outFlows.push(this._registerSignalOutput(`out${e}`))}_getUnusedIndexes(e){const t=this._cachedUnusedIndexes;if(t.length=0,e._hasExecutionVariable(this,"unusedIndexes")){const i=e._getExecutionVariable(this,"unusedIndexes");for(let e=0;e<i.length;e++)t.push(i[e])}else for(let e=0;e<this.config.numberOutputFlows;e++)t.push(e);return t}_getNextOutput(e,t){return this.config.isRandom?t[Math.floor(Math.random()*t.length)]:e+1}_execute(e,t){var i;const s=null!==(i=e._getExecutionVariable(this,"currentIndex"))&&void 0!==i?i:this.config.startIndex-1;let r=this._getUnusedIndexes(e);if(t===this.reset)return e._deleteExecutionVariable(this,"currentIndex"),void e._deleteExecutionVariable(this,"unusedIndexes");let n=this._getNextOutput(s,r);if(n>=this.config.numberOutputFlows&&this.config.loop)n=0;else if(n>=this.config.numberOutputFlows&&!this.config.loop)return;if(r=r.filter((e=>e!==n)),0===r.length)for(let e=0;e<this.config.numberOutputFlows;e++)r.push(e);e._setExecutionVariable(this,"unusedIndexes",r),e._setExecutionVariable(this,"currentIndex",n),this.currentIndex.setValue(n,e),this.outFlows[n]._activateSignal(e)}getClassName(){return"FGMultiGateBlock"}serialize(e){super.serialize(e),e.config.numberOutputFlows=this.config.numberOutputFlows,e.config.isRandom=this.config.isRandom,e.config.loop=this.config.loop,e.config.startIndex=this.config.startIndex}}),m("FGSwitchBlock",class extends GT{constructor(e){super(e),this.config=e,this.selection=this.registerDataInput("selection",RT)}configure(){super.configure(),this.outputFlows=[];for(let e=0;e<=this.config.cases.length;e++)this.outputFlows.push(this._registerSignalOutput(`out${e}`))}_execute(e,t){const i=this.selection.getValue(e);for(let t=0;t<this.config.cases.length;t++)if(i===this.config.cases[t])return void this.outputFlows[t]._activateSignal(e);this.outputFlows[this.outputFlows.length-1]._activateSignal(e)}getClassName(){return"FGSwitchBlock"}serialize(e){super.serialize(e),e.cases=this.config.cases}}),m("FGWaitAllBlock",class extends iE{constructor(e){super(e),this.config=e,this.inFlows=[],this._cachedActivationState=[],this.reset=this._registerSignalInput("reset")}configure(){for(let e=1;e<this.config.numberInputFlows;e++)this.inFlows.push(this._registerSignalInput(`in${e}`))}_getCurrentActivationState(e){const t=this._cachedActivationState;if(t.length=0,e._hasExecutionVariable(this,"activationState")){const i=e._getExecutionVariable(this,"activationState");for(let e=0;e<i.length;e++)t.push(i[e])}else for(let e=0;e<this.config.numberInputFlows;e++)t.push(!1);return t}_execute(e,t){const i=this._getCurrentActivationState(e);if(t===this.reset)for(let e=0;e<this.config.numberInputFlows;e++)i[e]=!1;else if(t===this.onStart)i[0]=!0;else{const e=this.inFlows.indexOf(t);e>=0&&(i[e+1]=!0)}if(e._setExecutionVariable(this,"activationState",i.slice()),i.every((e=>e))){this.onDone._activateSignal(e);for(let e=0;e<this.config.numberInputFlows;e++)i[e]=!1}}getClassName(){return"FGWaitAllBlock"}serialize(e){super.serialize(e),e.config.numberInputFlows=this.config.numberInputFlows}}),m("FGCounterBlock",class extends iE{constructor(e){super(e),this.count=this.registerDataOutput("count",PT),this.reset=this._registerSignalInput("reset")}_execute(e,t){var i;if(t===this.reset)return e._setExecutionVariable(this,"count",0),void this.count.setValue(0,e);const s=(null!==(i=e._getExecutionVariable(this,"count"))&&void 0!==i?i:0)+1;e._setExecutionVariable(this,"count",s),this.count.setValue(s,e),this.onDone._activateSignal(e)}getClassName(){return"FGCounterBlock"}}),m("FGWhileLoopBlock",class extends iE{constructor(e){super(e),this.config=e,this.condition=this.registerDataInput("condition",MT),this.loopBody=this._registerSignalOutput("loopBody")}_execute(e,t){var i;let s=this.condition.getValue(e);for((null===(i=this.config)||void 0===i?void 0:i.isDo)&&!s&&this.loopBody._activateSignal(e);s;)this.loopBody._activateSignal(e),s=this.condition.getValue(e);this.onDone._activateSignal(e)}getClassName(){return"FGWhileLoopBlock"}serialize(e){var t;super.serialize(e),e.isDo=null===(t=this.config)||void 0===t?void 0:t.isDo}}),m("FGDebounceBlock",class extends iE{constructor(e){super(e),this.count=this.registerDataInput("count",PT),this.reset=this._registerSignalInput("reset"),this.currentCount=this.registerDataOutput("currentCount",PT)}_execute(e,t){if(t===this.reset)return void e._setExecutionVariable(this,"debounceCount",0);const i=this.count.getValue(e),s=e._getExecutionVariable(this,"debounceCount",0)+1;this.currentCount.setValue(s,e),e._setExecutionVariable(this,"debounceCount",s),s>=i&&(this.onDone._activateSignal(e),e._setExecutionVariable(this,"debounceCount",0))}getClassName(){return"FGDebounceBlock"}}),m("FGFlipFlopBlock",class extends GT{constructor(e){super(e),this.onOn=this._registerSignalOutput("onOn"),this.onOff=this._registerSignalOutput("onOff"),this.isOn=this.registerDataOutput("isOn",MT)}_execute(e,t){let i=e._getExecutionVariable(this,"value",!1);i=!i,e._setExecutionVariable(this,"value",i),this.isOn.setValue(i,e),i?this.onOn._activateSignal(e):this.onOff._activateSignal(e)}getClassName(){return"FGFlipFlopBlock"}}),m("FGPlayAnimationBlock",class extends zT{constructor(e){super(e),this.config=e,this.templateTargetComponent=new sE(e.targetPath,this),this.templateAnimationComponent=new sE(e.animationPath,this),this.speed=this.registerDataInput("speed",PT),this.loop=this.registerDataInput("loop",MT),this.from=this.registerDataInput("from",PT),this.to=this.registerDataInput("to",PT),this.onAnimationEnd=this._registerSignalOutput("onAnimationEnd"),this.runningAnimatable=this.registerDataOutput("runningAnimatable",RT)}_preparePendingTasks(e){var t;const i=this.templateTargetComponent.getProperty(e),s=this.templateAnimationComponent.getProperty(e);if(!i||!s)throw new Error("Cannot play animation without target or animation");const r=null!==(t=e._getExecutionVariable(this,"runningAnimatables"))&&void 0!==t?t:[],n=this.runningAnimatable.getValue(e);if(n&&n.paused)n.restart();else{const t=e.configuration.scene.beginDirectAnimation(i,[s],this.from.getValue(e),this.to.getValue(e),this.loop.getValue(e),this.speed.getValue(e),(()=>this._onAnimationEnd(t,e)));this.runningAnimatable.setValue(t,e),r.push(t)}e._setExecutionVariable(this,"runningAnimatables",r)}_execute(e){this._startPendingTasks(e),this.onDone._activateSignal(e)}_onAnimationEnd(e,t){var i;const s=null!==(i=t._getExecutionVariable(this,"runningAnimatables"))&&void 0!==i?i:[],r=s.indexOf(e);-1!==r&&s.splice(r,1),t._removePendingBlock(this),this.onAnimationEnd._activateSignal(t)}_cancelPendingTasks(e){var t;const i=null!==(t=e._getExecutionVariable(this,"runningAnimatables"))&&void 0!==t?t:[];for(const e of i)e.stop();e._deleteExecutionVariable(this,"runningAnimatables")}getClassName(){return"FGPlayAnimationBlock"}serialize(e={}){super.serialize(e),e.config.targetPath=this.config.targetPath.serialize(),e.config.animationPath=this.config.animationPath.serialize()}}),m("FGStopAnimationBlock",class extends iE{constructor(e){super(e),this.animationToStop=this.registerDataInput("animationToStop",RT)}_execute(e){this.animationToStop.getValue(e).stop(),this.onDone._activateSignal(e)}getClassName(){return"FGStopAnimationBlock"}}),m("FGPauseAnimationBlock",class extends iE{constructor(e){super(e),this.animationToPause=this.registerDataInput("animationToPause",RT)}_execute(e){this.animationToPause.getValue(e).pause(),this.onDone._activateSignal(e)}getClassName(){return"FGPauseAnimationBlock"}}),m("FGPlayAudioBlock",class extends iE{constructor(e){super(e),this.audio=this.registerDataInput("audio",RT)}_execute(e,t){const i=this.audio.getValue(e);i instanceof vr&&i.play(),this.onDone._activateSignal(e)}getClassName(){return"FGPlayAudioBlock"}}),m("FGStopAudioBlock",class extends iE{constructor(e){super(e),this.audio=this.registerDataInput("audio",RT)}_execute(e,t){const i=this.audio.getValue(e);i instanceof vr&&i.stop()}getClassName(){return"FGStopAudioBlock"}}),m("FGConditionalDataBlock",class extends VT{constructor(e){super(e),this.condition=this.registerDataInput("condition",MT),this.trueValue=this.registerDataInput("trueValue",RT),this.falseValue=this.registerDataInput("falseValue",RT),this.output=this.registerDataOutput("output",RT)}_updateOutputs(e){this.output.setValue(this.condition.getValue(e)?this.trueValue.getValue(e):this.falseValue.getValue(e),e)}getClassName(){return"FGConditionalDataBlock"}}),m("FGGetVariableBlock",class extends VT{constructor(e){super(e),this.variableName=this.registerDataInput("variableName",IT),this.output=this.registerDataOutput("output",RT)}_updateOutputs(e){const t=this.variableName.getValue(e);e.hasVariable(t)&&this.output.setValue(e.getVariable(t),e)}getClassName(){return"FGGetVariableBlock"}}),m("FGCoordinateTransformBlock",class extends VT{constructor(e){super(e),this.sourceSystem=this.registerDataInput("sourceSystem",RT),this.destinationSystem=this.registerDataInput("destinationSystem",RT),this.inputCoordinates=this.registerDataInput("inputCoordinates",DT),this.outputCoordinates=this.registerDataOutput("outputCoordinates",DT)}_updateOutputs(e){const t=this.sourceSystem.getValue(e),i=this.destinationSystem.getValue(e),s=this.inputCoordinates.getValue(e),r=t.getWorldMatrix(),n=i.getWorldMatrix(),o=R.Matrix[0].copyFrom(n);o.invert();const a=R.Matrix[1];o.multiplyToRef(r,a);const l=this.outputCoordinates.getValue(e);S.TransformCoordinatesToRef(s,a,l)}getClassName(){return"FGCoordinateTransformBlock"}}),m("FGConstantBlock",class extends VT{constructor(e){super(e),this.config=e,this.output=this.registerDataOutput("output",function(e){switch(typeof e){case"string":return IT;case"number":return PT;case"boolean":return MT;case"object":return e instanceof E?OT:e instanceof S?DT:e instanceof b?NT:e instanceof N?wT:e instanceof F?LT:e instanceof C?BT:RT;default:return RT}}(e.value))}_updateOutputs(e){this.output.setValue(this.config.value,e)}getClassName(){return"FGConstantBlock"}});const rE="cachedOperationValue",nE="cachedExecutionId";class oE extends VT{constructor(e,t){super(t),this.output=this.registerDataOutput("output",e)}_updateOutputs(e){const t=e._getExecutionVariable(this,nE),i=e._getExecutionVariable(this,rE);if(void 0!==i&&t===e.executionId)this.output.setValue(i,e);else{const t=this._doOperation(e);e._setExecutionVariable(this,rE,t),e._setExecutionVariable(this,nE,e.executionId),this.output.setValue(t,e)}}}class aE extends oE{constructor(e,t,i,s,r,n){super(i,n),this._operation=s,this._className=r,this.leftInput=this.registerDataInput("leftInput",e),this.rightInput=this.registerDataInput("rightInput",t)}_doOperation(e){return this._operation(this.leftInput.getValue(e),this.rightInput.getValue(e))}getClassName(){return this._className}}class lE extends oE{constructor(e,t,i,s,r){super(t,r),this._operation=i,this._className=s,this.input=this.registerDataInput("input",e)}_doOperation(e){return this._operation(this.input.getValue(e))}getClassName(){return this._className}}const hE="FGBitwise",cE="AndBlock",uE="OrBlock",dE="XorBlock",pE="NotBlock",_E="LeftShiftBlock",fE="RightShiftBlock",mE="CountLeadingZerosBlock",gE="CountTrailingZerosBlock";m(`${hE}${cE}`,class extends aE{constructor(e){super(PT,PT,PT,((e,t)=>e&t),`${hE}${cE}`,e)}}),m(`${hE}${uE}`,class extends aE{constructor(e){super(PT,PT,PT,((e,t)=>e|t),`${hE}${uE}`,e)}}),m(`${hE}${dE}`,class extends aE{constructor(e){super(PT,PT,PT,((e,t)=>e^t),`${hE}${dE}`,e)}}),m(`${hE}${pE}`,class extends lE{constructor(e){super(PT,PT,(e=>~e),`${hE}${pE}`,e)}}),m(`${hE}${_E}`,class extends aE{constructor(e){super(PT,PT,PT,((e,t)=>e<<t),`${hE}${_E}`,e)}}),m(`${hE}${fE}`,class extends aE{constructor(e){super(PT,PT,PT,((e,t)=>e>>t),`${hE}${fE}`,e)}}),m(`${hE}${mE}`,class extends lE{constructor(e){super(PT,PT,(e=>Math.clz32(e)),`${hE}${mE}`,e)}}),m(`${hE}${gE}`,class extends lE{_ctrz(e){return 0==(e>>>=0)?32:(e&=-e,31-Math.clz32(e))}constructor(e){super(PT,PT,(e=>this._ctrz(e)),`${hE}${gE}`,e)}});const vE="FGLogic",xE="AndBlock",TE="OrBlock",EE="NotBlock";m(`${vE}${xE}`,class extends aE{constructor(e){super(MT,MT,MT,((e,t)=>e&&t),`${vE}${xE}`,e)}}),m(`${vE}${TE}`,class extends aE{constructor(e){super(MT,MT,MT,((e,t)=>e||t),`${vE}${TE}`,e)}}),m(`${vE}${EE}`,class extends lE{constructor(e){super(MT,MT,(e=>!e),`${vE}${EE}`,e)}});class SE extends oE{constructor(e,t,i,s){super(e,s),this._operation=t,this._className=i}_doOperation(e){return this._operation()}getClassName(){return this._className}}const bE="FGAddNumberBlock";m(bE,class extends aE{constructor(e){super(PT,PT,PT,((e,t)=>e+t),bE,e)}});const CE="FGSubtractNumberBlock";m(CE,class extends aE{constructor(e){super(PT,PT,PT,((e,t)=>e-t),CE,e)}});const yE="FGMultiplyNumberBlock";m(yE,class extends aE{constructor(e){super(PT,PT,PT,((e,t)=>e*t),yE,e)}});const AE="FGDivideNumberBlock";m(AE,class extends aE{constructor(e){super(PT,PT,PT,((e,t)=>e/t),AE,e)}});const RE="FGModNumberBlock";m(RE,class extends aE{constructor(e){super(PT,PT,PT,((e,t)=>e%t),RE,e)}});const IE="FGPowNumberBlock";m(IE,class extends aE{constructor(e){super(PT,PT,PT,((e,t)=>Math.pow(e,t)),IE,e)}});const PE="FGIsNaNNumberBlock";m(PE,class extends lE{constructor(e){super(PT,MT,(e=>isNaN(e)),PE,e)}});const ME="FGIsInfinityNumberBlock";m(ME,class extends lE{constructor(e){super(PT,MT,(e=>!isFinite(e)),ME,e)}});const OE="FGSqrtNumberBlock";m(OE,class extends lE{constructor(e){super(PT,PT,(e=>Math.sqrt(e)),OE,e)}});const DE="FGAbsNumberBlock";m(DE,class extends lE{constructor(e){super(PT,PT,(e=>Math.abs(e)),DE,e)}});const NE="FGNegateNumberBlock";m(NE,class extends lE{constructor(e){super(PT,PT,(e=>-e),NE,e)}});const FE="FGFloorNumberBlock";m(FE,class extends lE{constructor(e){super(PT,PT,(e=>Math.floor(e)),FE,e)}});const wE="FGCeilNumberBlock";m(wE,class extends lE{constructor(e){super(PT,PT,(e=>Math.ceil(e)),wE,e)}});const LE="FGRoundNumberBlock";m(LE,class extends aE{constructor(e){super(PT,PT,PT,((e,t)=>Math.round(e/Math.pow(10,t))/Math.pow(10,t)),LE,e)}});const BE="FGTruncNumberBlock";m(BE,class extends lE{constructor(e){super(PT,PT,(e=>Math.trunc(e)),BE,e)}});const UE="FGExpNumberBlock";m(UE,class extends lE{constructor(e){super(PT,PT,(e=>Math.exp(e)),UE,e)}});const VE="FGLog10NumberBlock";m(VE,class extends lE{constructor(e){super(PT,PT,(e=>Math.log10(e)),VE,e)}});const kE="FGLogNumberBlock";m(kE,class extends lE{constructor(e){super(PT,PT,(e=>Math.log(e)),kE,e)}});const GE="FGLnNumberBlock";m(GE,class extends lE{constructor(e){super(PT,PT,(e=>Math.log(e)/Math.LN2),GE,e)}});const zE="FGSineNumberBlock";m(zE,class extends lE{constructor(e){super(PT,PT,(e=>Math.sin(e)),zE,e)}});const WE="FGCosNumberBlock";m(WE,class extends lE{constructor(e){super(PT,PT,(e=>Math.cos(e)),WE,e)}});const HE="FGTanNumberBlock";m(HE,class extends lE{constructor(e){super(PT,PT,(e=>Math.tan(e)),HE,e)}});const XE="FGASineNumberBlock";m(XE,class extends lE{constructor(e){super(PT,PT,(e=>Math.asin(e)),XE,e)}});const YE="FGACosNumberBlock";m(YE,class extends lE{constructor(e){super(PT,PT,(e=>Math.acos(e)),YE,e)}});const jE="FGATanNumberBlock";m(jE,class extends lE{constructor(e){super(PT,PT,(e=>Math.atan(e)),jE,e)}});const KE="FGENumberBlock";m(KE,class extends SE{constructor(e){super(PT,(()=>Math.E),KE,e)}});const $E="FGPiNumberBlock";m($E,class extends SE{constructor(e){super(PT,(()=>Math.PI),$E,e)}});const qE="FGATan2NumberBlock";m(qE,class extends aE{constructor(e){super(PT,PT,PT,((e,t)=>Math.atan2(e,t)),qE,e)}});const QE="FGRandomNumberBlock";m(QE,class extends aE{constructor(e){super(PT,PT,PT,((e,t)=>e+Math.random()*(t-e)),QE,e)}});const ZE="FGMinNumberBlock";m(ZE,class extends aE{constructor(e){super(PT,PT,PT,((e,t)=>Math.min(e,t)),ZE,e)}});const JE="FGMaxNumberBlock";m(JE,class extends aE{constructor(e){super(PT,PT,PT,((e,t)=>Math.max(e,t)),JE,e)}});const eS="FGEqualsNumberBlock";m(eS,class extends aE{constructor(e){super(PT,PT,MT,((e,t)=>e===t),eS,e)}});const tS="FGGreaterThanNumberBlock";m(tS,class extends aE{constructor(e){super(PT,PT,MT,((e,t)=>e>t),tS,e)}});const iS="FGGreaterThanOrEqualsNumberBlock";m(iS,class extends aE{constructor(e){super(PT,PT,MT,((e,t)=>e>=t),iS,e)}});const sS="FGLessThanNumberBlock";m(sS,class extends aE{constructor(e){super(PT,PT,MT,((e,t)=>e<t),sS,e)}});const rS="FGLessThanOrEqualsNumberBlock";m(rS,class extends aE{constructor(e){super(PT,PT,MT,((e,t)=>e<=t),rS,e)}});const nS="FGMixNumberBlock";m(nS,class extends VT{constructor(e){super(e),this.leftInput=this.registerDataInput("leftInput",PT),this.rightInput=this.registerDataInput("rightInput",PT),this.alphaInput=this.registerDataInput("alphaInput",PT),this.resultOutput=this.registerDataOutput("resultOutput",PT)}_updateOutputs(e){const t=this.leftInput.getValue(e),i=t+(this.rightInput.getValue(e)-t)*this.alphaInput.getValue(e);this.resultOutput.setValue(i,e)}getClassName(){return nS}});const oS="FGAddVector2Block";m(oS,class extends aE{constructor(e){super(OT,OT,OT,((e,t)=>e.add(t)),oS,e)}});const aS="FGSubtractVector2Block";m(aS,class extends aE{constructor(e){super(OT,OT,OT,((e,t)=>e.subtract(t)),aS,e)}});const lS="FGMultiplyVector2Block";m(lS,class extends aE{constructor(e){super(OT,OT,OT,((e,t)=>e.multiply(t)),lS,e)}});const hS="FGDivideVector2Block";m(hS,class extends aE{constructor(e){super(OT,OT,OT,((e,t)=>e.divide(t)),hS,e)}});const cS="FGScaleVector2Block";m(cS,class extends aE{constructor(e){super(OT,PT,OT,((e,t)=>e.scale(t)),cS,e)}});const uS="FGLengthVector2Block";m(uS,class extends lE{constructor(e){super(OT,PT,(e=>e.length()),uS,e)}});const dS="FGNormalizeVector2Block";m(dS,class extends lE{constructor(e){super(OT,OT,(e=>{const t=e.clone();return t.normalize(),t}),dS,e)}}),m("FGCreateVector2Block",class extends VT{constructor(e){super(e),this._cachedVector=E.Zero(),this.x=this.registerDataInput("x",PT),this.y=this.registerDataInput("y",PT),this.vector=this.registerDataOutput("vector",OT)}_updateOutputs(e){this._cachedVector.x=this.x.getValue(e),this._cachedVector.y=this.y.getValue(e),this.vector.setValue(this._cachedVector,e)}}),m("FGSplitVector2Block",class extends VT{constructor(e){super(e),this.vector=this.registerDataInput("vector",OT),this.x=this.registerDataOutput("x",PT),this.y=this.registerDataOutput("y",PT)}_updateOutputs(e){const t=this.vector.getValue(e);this.x.setValue(t.x,e),this.y.setValue(t.y,e)}}),m("FGRotate2dVector2Block",class extends VT{constructor(e){super(e),this._cachedVector=E.Zero(),this.input=this.registerDataInput("input",OT),this.angle=this.registerDataInput("angle",PT),this.output=this.registerDataOutput("output",OT)}_updateOutputs(e){const t=this.input.getValue(e),i=this.angle.getValue(e);this._cachedVector.x=t.x*Math.cos(i)-t.y*Math.sin(i),this._cachedVector.y=t.x*Math.sin(i)+t.y*Math.cos(i),this.output.setValue(this._cachedVector,e)}});const pS="FGAddVector3Block";m(pS,class extends aE{constructor(e){super(DT,DT,DT,((e,t)=>e.add(t)),pS,e)}});const _S="FGSubtractVector3Block";m(_S,class extends aE{constructor(e){super(DT,DT,DT,((e,t)=>e.subtract(t)),_S,e)}});const fS="FGMultiplyVector3Block";m(fS,class extends aE{constructor(e){super(DT,DT,DT,((e,t)=>e.multiply(t)),fS,e)}});const mS="FGDivideVector3Block";m(mS,class extends aE{constructor(e){super(DT,DT,DT,((e,t)=>e.divide(t)),mS,e)}});const gS="FGScaleVector3Block";m(gS,class extends aE{constructor(e){super(DT,PT,DT,((e,t)=>e.scale(t)),gS,e)}});const vS="FGLengthVector3Block";m(vS,class extends lE{constructor(e){super(DT,PT,(e=>e.length()),vS,e)}});const xS="FGNormalizeVector3Block";m(xS,class extends lE{constructor(e){super(DT,DT,(e=>e.normalizeToNew()),xS,e)}});const TS="FGDotVector3Block";m(TS,class extends aE{constructor(e){super(DT,DT,PT,((e,t)=>S.Dot(e,t)),TS,e)}});const ES="FGCrossVector3Block";m(ES,class extends aE{constructor(e){super(DT,DT,DT,((e,t)=>S.Cross(e,t)),ES,e)}});const SS="FGCreateVector3Block";m(SS,class extends VT{constructor(e){super(e),this._cachedVector=S.Zero(),this.x=this.registerDataInput("x",PT),this.y=this.registerDataInput("y",PT),this.z=this.registerDataInput("y",PT),this.vector=this.registerDataOutput("vector",DT)}_updateOutputs(e){this._cachedVector.x=this.x.getValue(e),this._cachedVector.y=this.y.getValue(e),this._cachedVector.z=this.z.getValue(e),this.vector.setValue(this._cachedVector,e)}getClassName(){return SS}});const bS="FGSplitVector3Block";m(bS,class extends VT{constructor(e){super(e),this.vector=this.registerDataInput("vector",DT),this.x=this.registerDataOutput("x",PT),this.y=this.registerDataOutput("y",PT),this.z=this.registerDataOutput("z",PT)}_updateOutputs(e){const t=this.vector.getValue(e);this.x.setValue(t.x,e),this.y.setValue(t.y,e),this.z.setValue(t.z,e)}getClassName(){return bS}});const CS="FGRotateVector3Block";m(CS,class extends VT{constructor(e){super(e),this._cachedQuaternion=new C,this.input=this.registerDataInput("input",DT),this.angle=this.registerDataInput("angle",PT),this.output=this.registerDataOutput("output",DT)}_updateOutputs(e){const t=C.RotationAxisToRef(this.axis.getValue(e),this.angle.getValue(e),this._cachedQuaternion),i=this.input.getValue(e),s=this.output.getValue(e);i.applyRotationQuaternionToRef(t,s)}getClassName(){return CS}});const yS="FGTransformVector3Block";m(yS,class extends aE{constructor(e){super(FT,DT,DT,((e,t)=>S.TransformCoordinatesToRef(t,e,this._cachedResult)),yS,e),this._cachedResult=S.Zero()}});const AS="FGAddVector4Block";m(AS,class extends aE{constructor(e){super(NT,NT,NT,((e,t)=>e.add(t)),AS,e)}});const RS="FGSubtractVector4Block";m(RS,class extends aE{constructor(e){super(NT,NT,NT,((e,t)=>e.subtract(t)),RS,e)}});const IS="FGMultiplyVector4Block";m(IS,class extends aE{constructor(e){super(NT,NT,NT,((e,t)=>e.multiply(t)),IS,e)}});const PS="FGDivideVector4Block";m(PS,class extends aE{constructor(e){super(NT,NT,NT,((e,t)=>e.divide(t)),PS,e)}});const MS="FGScaleVector4Block";m(MS,class extends aE{constructor(e){super(NT,PT,NT,((e,t)=>e.scale(t)),MS,e)}});const OS="FGLengthVector4Block";m(OS,class extends lE{constructor(e){super(NT,PT,(e=>e.length()),OS,e)}});const DS="FGNormalizeVector4Block";m(DS,class extends lE{constructor(e){super(NT,NT,(e=>{const t=e.clone();return t.normalize(),t}),DS,e)}getClassName(){return DS}});const NS="FGCreateVector4Block";m(NS,class extends VT{constructor(e){super(e),this._cachedVector=b.Zero(),this.x=this.registerDataInput("x",PT),this.y=this.registerDataInput("y",PT),this.z=this.registerDataInput("y",PT),this.w=this.registerDataInput("w",PT),this.vector=this.registerDataOutput("vector",NT)}_updateOutputs(e){this._cachedVector.x=this.x.getValue(e),this._cachedVector.y=this.y.getValue(e),this._cachedVector.z=this.z.getValue(e),this._cachedVector.w=this.w.getValue(e),this.vector.setValue(this._cachedVector,e)}getClassName(){return NS}});const FS="FGSplitVector4Block";m(FS,class extends VT{constructor(e){super(e),this.vector=this.registerDataInput("vector",NT),this.x=this.registerDataOutput("x",PT),this.y=this.registerDataOutput("y",PT),this.z=this.registerDataOutput("z",PT),this.w=this.registerDataOutput("w",PT)}_updateOutputs(e){const t=this.vector.getValue(e);this.x.setValue(t.x,e),this.y.setValue(t.y,e),this.z.setValue(t.z,e),this.w.setValue(t.w,e)}getClassName(){return FS}});const wS="FGAddMatrixBlock";m(wS,class extends aE{constructor(e){super(FT,FT,FT,((e,t)=>e.addToRef(t,this._cachedMatrix)),wS,e),this._cachedMatrix=y.Zero()}});const LS="FGAddMatrixAndNumberBlock";m(LS,class extends aE{constructor(e){super(FT,PT,FT,((e,t)=>{for(let i=0;i<e.m.length;i++)this._cachedArray[i]=e.m[i]+t;return y.FromArrayToRef(this._cachedArray,0,this._cachedMatrix)}),LS,e),this._cachedArray=new Float32Array(16),this._cachedMatrix=y.Zero()}});const BS="FGSubtractMatrixBlock";m(BS,class extends aE{constructor(e){super(FT,FT,FT,((e,t)=>e.addToRef(t.scaleToRef(-1,R.Matrix[0]),this._cachedMatrix)),BS,e),this._cachedMatrix=y.Zero()}});const US="FGSubtractMatrixAndNumberBlock";m(US,class extends aE{constructor(e){super(FT,PT,FT,((e,t)=>{for(let i=0;i<e.m.length;i++)this._cachedArray[i]=e.m[i]-t;return y.FromArrayToRef(this._cachedArray,0,this._cachedMatrix)}),US,e),this._cachedArray=new Float32Array(16),this._cachedMatrix=y.Zero()}});const VS="FGMultiplyMatrixBlock";m(VS,class extends aE{constructor(e){super(FT,FT,FT,((e,t)=>e.multiplyToRef(t,this._cachedMatrix)),VS,e),this._cachedMatrix=y.Zero()}});const kS="FGDivideMatrixBlock";m(kS,class extends aE{constructor(e){super(FT,FT,FT,((e,t)=>e.multiplyToRef(t.invertToRef(R.Matrix[0]),this._cachedResultMatrix)),kS,e),this._cachedResultMatrix=y.Zero()}});const GS="FGDivideMatrixAndNumberBlock";m(GS,class extends aE{constructor(e){super(FT,PT,FT,((e,t)=>{for(let i=0;i<e.m.length;i++)this._cachedArray[i]=e.m[i]/t;return y.FromArrayToRef(this._cachedArray,0,this._cachedMatrix)}),GS,e),this._cachedArray=new Float32Array(16),this._cachedMatrix=y.Zero()}});const zS="FGScaleMatrixBlock";m(zS,class extends aE{constructor(e){super(FT,PT,FT,((e,t)=>e.scaleToRef(t,this._cachedMatrix)),zS,e),this._cachedMatrix=y.Zero()}});const WS="FGClampMatrixBlock";m(WS,class extends VT{constructor(e){super(e),this._cachedArray=new Float32Array(16),this._cachedMatrix=y.Identity(),this.input=this.registerDataInput("input",FT),this.min=this.registerDataInput("min",PT),this.max=this.registerDataInput("max",PT),this.output=this.registerDataOutput("output",FT)}_updateOutputs(e){const t=this.input.getValue(e),i=this.min.getValue(e),s=this.max.getValue(e);for(let e=0;e<t.m.length;e++)this._cachedArray[e]=Math.min(Math.max(t.m[e],i),s);y.FromArrayToRef(this._cachedArray,0,this._cachedMatrix),this.output.setValue(this._cachedMatrix,e)}getClassName(){return WS}});const HS="FGDecomposeMatrixBlock";m(HS,class extends VT{constructor(e){super(e),this._cachedTranslation=new S,this._cachedRotation=new C,this._cachedScale=new S,this.input=this.registerDataInput("input",FT),this.translation=this.registerDataOutput("translation",DT),this.rotation=this.registerDataOutput("rotation",BT),this.scale=this.registerDataOutput("scale",DT)}_updateOutputs(e){this.input.getValue(e).decompose(this._cachedScale,this._cachedRotation,this._cachedTranslation),this.translation.setValue(this._cachedTranslation,e),this.rotation.setValue(this._cachedRotation,e),this.scale.setValue(this._cachedScale,e)}getClassName(){return HS}});const XS="FGComposeMatrixBlock";m(XS,class extends VT{constructor(e){super(e),this._cachedMatrix=new y,this.output=this.registerDataOutput("input",FT),this.translation=this.registerDataInput("translation",DT),this.rotation=this.registerDataInput("rotation",BT),this.scale=this.registerDataInput("scale",DT)}_updateOutputs(e){const t=this.translation.getValue(e),i=this.rotation.getValue(e),s=this.scale.getValue(e);y.ComposeToRef(s,i,t,this._cachedMatrix),this.output.setValue(this._cachedMatrix,e)}getClassName(){return XS}});const YS="FGQuaternionToRotationMatrixBlock";m(YS,class extends lE{constructor(e){super(BT,FT,(e=>y.FromQuaternionToRef(e,this._cachedMatrix)),YS,e),this._cachedMatrix=new y}});const jS="FGGetTransformationMatrixBlock";function KS(e,t,i,s){const r={externalResourceFunction:e=>s(e).then((e=>new Uint8Array(e)))};return i&&(r.uri="file:"===t?i:t+i),e instanceof ArrayBuffer?GLTFValidator.validateBytes(new Uint8Array(e),r):GLTFValidator.validateString(e,r)}function $S(){const e=[];onmessage=t=>{const i=t.data;switch(i.id){case"init":importScripts(i.url);break;case"validate":KS(i.data,i.rootUrl,i.fileName,(t=>new Promise(((i,s)=>{const r=e.length;e.push({resolve:i,reject:s}),postMessage({id:"getExternalResource",index:r,uri:t})})))).then((e=>{postMessage({id:"validate.resolve",value:e})}),(e=>{postMessage({id:"validate.reject",reason:e})}));break;case"getExternalResource.resolve":e[i.index].resolve(i.value);break;case"getExternalResource.reject":e[i.index].reject(i.reason)}}}m(jS,class extends aE{constructor(e){super(RT,RT,FT,((e,t)=>{const i=e.getWorldMatrix();return t.getWorldMatrix().invertToRef(R.Matrix[0]).multiplyToRef(i,this._cachedResult)}),jS,e),this._cachedResult=y.Zero()}}),m("FGSceneReadyEventBlock",class extends WT{_preparePendingTasks(e){if(!e._getExecutionVariable(this,"sceneReadyObserver")){const t=e.configuration.scene.onReadyObservable.add((()=>{this._execute(e)}));e._setExecutionVariable(this,"sceneReadyObserver",t)}}_cancelPendingTasks(e){const t=e._getExecutionVariable(this,"sceneReadyObserver");e.configuration.scene.onReadyObservable.remove(t),e._deleteExecutionVariable(this,"sceneReadyObserver")}getClassName(){return"FGSceneReadyEventBlock"}}),m("FGReceiveCustomEventBlock",class extends WT{constructor(e){super(e),this.config=e,this.eventData=this.registerDataOutput("eventData",RT)}_preparePendingTasks(e){const t=e.configuration.coordinator.getCustomEventObservable(this.config.eventId);this._eventObserver=t.add((t=>{this.eventData.setValue(t,e),this._execute(e)}))}_cancelPendingTasks(e){const t=e.configuration.coordinator.getCustomEventObservable(this.config.eventId);t?t.remove(this._eventObserver):Ht.Warn(`FlowGraphReceiveCustomEventBlock: Missing observable for event ${this.config.eventId}`)}getClassName(){return"FGReceiveCustomEventBlock"}serialize(e){super.serialize(e),e.eventId=this.config.eventId}}),m("FGSceneTickEventBlock",class extends WT{_preparePendingTasks(e){if(!e._getExecutionVariable(this,"sceneBeforeRender")){const t=e.configuration.scene.onBeforeRenderObservable.add((()=>{this._execute(e)}));e._setExecutionVariable(this,"sceneBeforeRender",t)}}_cancelPendingTasks(e){const t=e._getExecutionVariable(this,"sceneBeforeRender");e.configuration.scene.onBeforeRenderObservable.remove(t),e._deleteExecutionVariable(this,"sceneBeforeRender")}getClassName(){return"FGSceneTickEventBlock"}});class qS{static ValidateAsync(e,t,i,s){const r=ArrayBuffer.isView(e)?e.slice().buffer:e;return"function"==typeof Worker?new Promise(((e,n)=>{const o=`${KS}(${$S})()`,a=URL.createObjectURL(new Blob([o],{type:"application/javascript"})),l=new Worker(a),h=e=>{l.removeEventListener("error",h),l.removeEventListener("message",c),n(e)},c=t=>{const i=t.data;switch(i.id){case"getExternalResource":s(i.uri).then((e=>{l.postMessage({id:"getExternalResource.resolve",index:i.index,value:e},[e])}),(e=>{l.postMessage({id:"getExternalResource.reject",index:i.index,reason:e})}));break;case"validate.resolve":l.removeEventListener("error",h),l.removeEventListener("message",c),e(i.value),l.terminate();break;case"validate.reject":l.removeEventListener("error",h),l.removeEventListener("message",c),n(i.reason),l.terminate()}};l.addEventListener("error",h),l.addEventListener("message",c),l.postMessage({id:"init",url:Ht.GetBabylonScriptURL(this.Configuration.url)}),l.postMessage({id:"validate",data:r,rootUrl:t,fileName:i})})):(this._LoadScriptPromise||(this._LoadScriptPromise=Ht.LoadBabylonScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then((()=>KS(r,t,i,s))))}}function QS(e,t,i){try{return Promise.resolve(new Uint8Array(e,t,i))}catch(e){return Promise.reject(e)}}var ZS,JS,eb,tb,ib,sb,rb,nb,ob,ab,lb,hb;qS.Configuration={url:`${Ht._DefaultCdnUrl}/gltf_validator.js`},function(e){e[e.AUTO=0]="AUTO",e[e.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"}(ZS||(ZS={})),function(e){e[e.NONE=0]="NONE",e[e.FIRST=1]="FIRST",e[e.ALL=2]="ALL"}(JS||(JS={})),function(e){e[e.LOADING=0]="LOADING",e[e.READY=1]="READY",e[e.COMPLETE=2]="COMPLETE"}(eb||(eb={}));class cb{constructor(){this.onParsedObservable=new a,this.coordinateSystemMode=ZS.AUTO,this.animationStartMode=JS.FIRST,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.loadOnlyMaterials=!1,this.skipMaterials=!1,this.useSRGBBuffers=!0,this.targetFps=60,this.alwaysComputeSkeletonRootNode=!1,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable=new a,this.onSkinLoadedObservable=new a,this.onTextureLoadedObservable=new a,this.onMaterialLoadedObservable=new a,this.onCameraLoadedObservable=new a,this.onCompleteObservable=new a,this.onErrorObservable=new a,this.onDisposeObservable=new a,this.onExtensionLoadedObservable=new a,this.validate=!1,this.onValidatedObservable=new a,this._loader=null,this._state=null,this._requests=new Array,this.name="gltf",this.extensions={".gltf":{isBinary:!1},".glb":{isBinary:!0}},this.onLoaderStateChangedObservable=new a,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled}set onParsed(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),this._onParsedObserver=this.onParsedObservable.add(e)}set onMeshLoaded(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e)}set onTextureLoaded(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e)}set onMaterialLoaded(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e)}set onCameraLoaded(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e)}set onComplete(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)}set onError(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onExtensionLoaded(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(const e of this._requests)e.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(e,t,i,s,r,n,o,l){if(ArrayBuffer.isView(t))return this._loadBinary(e,t,i,s,o,l),null;this._progressCallback=r;const h=t.name||Ht.GetFilename(t);if(n){if(this.useRangeRequests){this.validate&&k.Warn("glTF validation is not supported when range requests are enabled");const i={abort:()=>{},onCompleteObservable:new a},r={readAsync:(i,s)=>new Promise(((r,n)=>{this._loadFile(e,t,(e=>{r(new Uint8Array(e))}),!0,(e=>{n(e)}),(e=>{e.setRequestHeader("Range",`bytes=${i}-${i+s-1}`)}))})),byteLength:0};return this._unpackBinaryAsync(new Cx(r)).then((e=>{i.onCompleteObservable.notifyObservers(i),s(e)}),o?e=>o(void 0,e):void 0),i}return this._loadFile(e,t,(t=>{this._validate(e,new Uint8Array(t),i,h),this._unpackBinaryAsync(new Cx({readAsync:(e,i)=>QS(t,e,i),byteLength:t.byteLength})).then((e=>{s(e)}),o?e=>o(void 0,e):void 0)}),!0,o)}return this._loadFile(e,t,(t=>{this._validate(e,new Uint8Array(t),i,h),s({json:this._parseJson(t)})}),n,o)}_loadBinary(e,t,i,s,r,n){this._validate(e,t,i,n),this._unpackBinaryAsync(new Cx({readAsync:(e,i)=>function(e,t,i){try{if(t<0||t>=e.byteLength)throw new RangeError("Offset is out of range.");if(t+i>e.byteLength)throw new RangeError("Length is out of range.");return Promise.resolve(new Uint8Array(e.buffer,e.byteOffset+t,i))}catch(e){return Promise.reject(e)}}(t,e,i),byteLength:t.byteLength})).then((e=>{s(e)}),r?e=>r(void 0,e):void 0)}importMeshAsync(e,t,i,s,r,n){return Promise.resolve().then((()=>(this.onParsedObservable.notifyObservers(i),this.onParsedObservable.clear(),this._log(`Loading ${n||""}`),this._loader=this._getLoader(i),this._loader.importMeshAsync(e,t,null,i,s,r,n))))}loadAsync(e,t,i,s,r){return Promise.resolve().then((()=>(this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${r||""}`),this._loader=this._getLoader(t),this._loader.loadAsync(e,t,i,s,r))))}loadAssetContainerAsync(e,t,i,s,r){return Promise.resolve().then((()=>{this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${r||""}`),this._loader=this._getLoader(t);const n=new mr(e),o=[];this.onMaterialLoadedObservable.add((e=>{o.push(e)}));const a=[];this.onTextureLoadedObservable.add((e=>{a.push(e)}));const l=[];this.onCameraLoadedObservable.add((e=>{l.push(e)}));const h=[];return this.onMeshLoadedObservable.add((e=>{e.morphTargetManager&&h.push(e.morphTargetManager)})),this._loader.importMeshAsync(null,e,n,t,i,s,r).then((e=>(Array.prototype.push.apply(n.geometries,e.geometries),Array.prototype.push.apply(n.meshes,e.meshes),Array.prototype.push.apply(n.particleSystems,e.particleSystems),Array.prototype.push.apply(n.skeletons,e.skeletons),Array.prototype.push.apply(n.animationGroups,e.animationGroups),Array.prototype.push.apply(n.materials,o),Array.prototype.push.apply(n.textures,a),Array.prototype.push.apply(n.lights,e.lights),Array.prototype.push.apply(n.transformNodes,e.transformNodes),Array.prototype.push.apply(n.cameras,l),Array.prototype.push.apply(n.morphTargetManagers,h),n)))}))}canDirectLoad(e){return-1!==e.indexOf("asset")&&-1!==e.indexOf("version")||e.startsWith("data:base64,"+cb._MagicBase64Encoded)||e.startsWith("data:;base64,"+cb._MagicBase64Encoded)||e.startsWith("data:application/octet-stream;base64,"+cb._MagicBase64Encoded)||e.startsWith("data:model/gltf-binary;base64,"+cb._MagicBase64Encoded)}directLoad(e,t){if(t.startsWith("base64,"+cb._MagicBase64Encoded)||t.startsWith(";base64,"+cb._MagicBase64Encoded)||t.startsWith("application/octet-stream;base64,"+cb._MagicBase64Encoded)||t.startsWith("model/gltf-binary;base64,"+cb._MagicBase64Encoded)){const i=Vt(t);return this._validate(e,new Uint8Array(i)),this._unpackBinaryAsync(new Cx({readAsync:(e,t)=>QS(i,e,t),byteLength:i.byteLength}))}return this._validate(e,t),Promise.resolve({json:this._parseJson(t)})}createPlugin(){return new cb}get loaderState(){return this._state}whenCompleteAsync(){return new Promise(((e,t)=>{this.onCompleteObservable.addOnce((()=>{e()})),this.onErrorObservable.addOnce((e=>{t(e)}))}))}_setState(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(eb[this._state]))}_loadFile(e,t,i,s,r,n){const o=e._loadFile(t,i,(e=>{this._onProgress(e,o)}),!0,s,r,n);return o.onCompleteObservable.add((e=>{this._requests.splice(this._requests.indexOf(e),1)})),this._requests.push(o),o}_onProgress(e,t){if(!this._progressCallback)return;t._lengthComputable=e.lengthComputable,t._loaded=e.loaded,t._total=e.total;let i=!0,s=0,r=0;for(const e of this._requests){if(void 0===e._lengthComputable||void 0===e._loaded||void 0===e._total)return;i=i&&e._lengthComputable,s+=e._loaded,r+=e._total}this._progressCallback({lengthComputable:i,loaded:s,total:i?r:0})}_validate(e,t,i="",s=""){this.validate&&(this._startPerformanceCounter("Validate JSON"),qS.ValidateAsync(t,i,s,(t=>this.preprocessUrlAsync(i+t).then((t=>e._loadFileAsync(t,void 0,!0,!0))))).then((e=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(e),this.onValidatedObservable.clear()}),(e=>{this._endPerformanceCounter("Validate JSON"),Ht.Warn(`Failed to validate: ${e.message}`),this.onValidatedObservable.clear()})))}_getLoader(e){const t=e.json.asset||{};this._log(`Asset version: ${t.version}`),t.minVersion&&this._log(`Asset minimum version: ${t.minVersion}`),t.generator&&this._log(`Asset generator: ${t.generator}`);const i=cb._parseVersion(t.version);if(!i)throw new Error("Invalid version: "+t.version);if(void 0!==t.minVersion){const e=cb._parseVersion(t.minVersion);if(!e)throw new Error("Invalid minimum version: "+t.minVersion);if(cb._compareVersion(e,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+t.minVersion)}const s={1:cb._CreateGLTF1Loader,2:cb._CreateGLTF2Loader}[i.major];if(!s)throw new Error("Unsupported version: "+t.version);return s(this)}_parseJson(e){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${e.length}`);const t=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),t}_unpackBinaryAsync(e){return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then((()=>{const t=e.readUint32();if(1179937895!==t)throw new Ue("Unexpected magic: "+t,2e3);const i=e.readUint32();this.loggingEnabled&&this._log(`Binary version: ${i}`);const s=e.readUint32();let r;switch(this.useRangeRequests||s===e.buffer.byteLength||k.Warn(`Length in header does not match actual data length: ${s} != ${e.buffer.byteLength}`),i){case 1:r=this._unpackBinaryV1Async(e,s);break;case 2:r=this._unpackBinaryV2Async(e,s);break;default:throw new Error("Unsupported version: "+i)}return this._endPerformanceCounter("Unpack Binary"),r}))}_unpackBinaryV1Async(e,t){const i=e.readUint32(),s=e.readUint32();if(0!==s)throw new Error(`Unexpected content format: ${s}`);const r=t-e.byteOffset,n={json:this._parseJson(e.readString(i)),bin:null};if(0!==r){const t=e.byteOffset;n.bin={readAsync:(i,s)=>e.buffer.readAsync(t+i,s),byteLength:r}}return Promise.resolve(n)}_unpackBinaryV2Async(e,t){const i=1313821514,s=e.readUint32();if(e.readUint32()!==i)throw new Error("First chunk format is not JSON");return e.byteOffset+s===t?e.loadAsync(s).then((()=>({json:this._parseJson(e.readString(s)),bin:null}))):e.loadAsync(s+8).then((()=>{const r={json:this._parseJson(e.readString(s)),bin:null},n=()=>{const s=e.readUint32();switch(e.readUint32()){case i:throw new Error("Unexpected JSON chunk");case 5130562:{const t=e.byteOffset;r.bin={readAsync:(i,s)=>e.buffer.readAsync(t+i,s),byteLength:s},e.skipBytes(s);break}default:e.skipBytes(s)}return e.byteOffset!==t?e.loadAsync(8).then(n):Promise.resolve(r)};return n()}))}static _parseVersion(e){if("1.0"===e||"1.0.1"===e)return{major:1,minor:0};const t=(e+"").match(/^(\d+)\.(\d+)/);return t?{major:parseInt(t[1]),minor:parseInt(t[2])}:null}static _compareVersion(e,t){return e.major>t.major?1:e.major<t.major?-1:e.minor>t.minor?1:e.minor<t.minor?-1:0}_logOpen(e){this._log(e),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(e){const t=cb._logSpaces.substr(0,2*this._logIndentLevel);k.Log(`${t}${e}`)}_logDisabled(e){}_startPerformanceCounterEnabled(e){Ht.StartPerformanceCounter(e)}_startPerformanceCounterDisabled(e){}_endPerformanceCounterEnabled(e){Ht.EndPerformanceCounter(e)}_endPerformanceCounterDisabled(e){}}cb.IncrementalLoading=!0,cb.HomogeneousCoordinates=!1,cb._MagicBase64Encoded="Z2xURg",cb._logSpaces="                                ",Hr&&Hr.RegisterPlugin(new cb),function(e){e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.FLOAT=5126]="FLOAT"}(tb||(tb={})),function(e){e[e.FRAGMENT=35632]="FRAGMENT",e[e.VERTEX=35633]="VERTEX"}(ib||(ib={})),function(e){e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.INT=5124]="INT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.FLOAT=5126]="FLOAT",e[e.FLOAT_VEC2=35664]="FLOAT_VEC2",e[e.FLOAT_VEC3=35665]="FLOAT_VEC3",e[e.FLOAT_VEC4=35666]="FLOAT_VEC4",e[e.INT_VEC2=35667]="INT_VEC2",e[e.INT_VEC3=35668]="INT_VEC3",e[e.INT_VEC4=35669]="INT_VEC4",e[e.BOOL=35670]="BOOL",e[e.BOOL_VEC2=35671]="BOOL_VEC2",e[e.BOOL_VEC3=35672]="BOOL_VEC3",e[e.BOOL_VEC4=35673]="BOOL_VEC4",e[e.FLOAT_MAT2=35674]="FLOAT_MAT2",e[e.FLOAT_MAT3=35675]="FLOAT_MAT3",e[e.FLOAT_MAT4=35676]="FLOAT_MAT4",e[e.SAMPLER_2D=35678]="SAMPLER_2D"}(sb||(sb={})),function(e){e[e.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",e[e.REPEAT=10497]="REPEAT"}(rb||(rb={})),function(e){e[e.NEAREST=9728]="NEAREST",e[e.LINEAR=9728]="LINEAR",e[e.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",e[e.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",e[e.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",e[e.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"}(nb||(nb={})),function(e){e[e.ALPHA=6406]="ALPHA",e[e.RGB=6407]="RGB",e[e.RGBA=6408]="RGBA",e[e.LUMINANCE=6409]="LUMINANCE",e[e.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA"}(ob||(ob={})),function(e){e[e.FRONT=1028]="FRONT",e[e.BACK=1029]="BACK",e[e.FRONT_AND_BACK=1032]="FRONT_AND_BACK"}(ab||(ab={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_COLOR=768]="SRC_COLOR",e[e.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",e[e.DST_COLOR=774]="DST_COLOR",e[e.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA=770]="SRC_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",e[e.DST_ALPHA=772]="DST_ALPHA",e[e.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",e[e.CONSTANT_COLOR=32769]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",e[e.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE"}(lb||(lb={}));class ub{static SetMatrix(e,t,i,s,r){let n=null;if("MODEL"===i.semantic?n=t.getWorldMatrix():"PROJECTION"===i.semantic?n=e.getProjectionMatrix():"VIEW"===i.semantic?n=e.getViewMatrix():"MODELVIEWINVERSETRANSPOSE"===i.semantic?n=y.Transpose(t.getWorldMatrix().multiply(e.getViewMatrix()).invert()):"MODELVIEW"===i.semantic?n=t.getWorldMatrix().multiply(e.getViewMatrix()):"MODELVIEWPROJECTION"===i.semantic?n=t.getWorldMatrix().multiply(e.getTransformMatrix()):"MODELINVERSE"===i.semantic?n=t.getWorldMatrix().invert():"VIEWINVERSE"===i.semantic?n=e.getViewMatrix().invert():"PROJECTIONINVERSE"===i.semantic?n=e.getProjectionMatrix().invert():"MODELVIEWINVERSE"===i.semantic?n=t.getWorldMatrix().multiply(e.getViewMatrix()).invert():"MODELVIEWPROJECTIONINVERSE"===i.semantic?n=t.getWorldMatrix().multiply(e.getTransformMatrix()).invert():"MODELINVERSETRANSPOSE"===i.semantic&&(n=y.Transpose(t.getWorldMatrix().invert())),n)switch(i.type){case sb.FLOAT_MAT2:r.setMatrix2x2(s,y.GetAsMatrix2x2(n));break;case sb.FLOAT_MAT3:r.setMatrix3x3(s,y.GetAsMatrix3x3(n));break;case sb.FLOAT_MAT4:r.setMatrix(s,n)}}static SetUniform(e,t,i,s){switch(s){case sb.FLOAT:return e.setFloat(t,i),!0;case sb.FLOAT_VEC2:return e.setVector2(t,E.FromArray(i)),!0;case sb.FLOAT_VEC3:return e.setVector3(t,S.FromArray(i)),!0;case sb.FLOAT_VEC4:return e.setVector4(t,b.FromArray(i)),!0;default:return!1}}static GetWrapMode(e){switch(e){case rb.CLAMP_TO_EDGE:return Ar.CLAMP_ADDRESSMODE;case rb.MIRRORED_REPEAT:return Ar.MIRROR_ADDRESSMODE;case rb.REPEAT:default:return Ar.WRAP_ADDRESSMODE}}static GetByteStrideFromType(e){switch(e.type){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}}static GetTextureFilterMode(e){switch(e){case nb.LINEAR:case nb.LINEAR_MIPMAP_NEAREST:case nb.LINEAR_MIPMAP_LINEAR:return Ar.TRILINEAR_SAMPLINGMODE;case nb.NEAREST:case nb.NEAREST_MIPMAP_NEAREST:return Ar.NEAREST_SAMPLINGMODE;default:return Ar.BILINEAR_SAMPLINGMODE}}static GetBufferFromBufferView(e,t,i,s,r){i=t.byteOffset+i;const n=e.loadedBufferViews[t.buffer];if(i+s>n.byteLength)throw new Error("Buffer access is out of range");const o=n.buffer;switch(i+=n.byteOffset,r){case tb.BYTE:return new Int8Array(o,i,s);case tb.UNSIGNED_BYTE:return new Uint8Array(o,i,s);case tb.SHORT:return new Int16Array(o,i,s);case tb.UNSIGNED_SHORT:return new Uint16Array(o,i,s);default:return new Float32Array(o,i,s)}}static GetBufferFromAccessor(e,t){const i=e.bufferViews[t.bufferView],s=t.count*ub.GetByteStrideFromType(t);return ub.GetBufferFromBufferView(e,i,t.byteOffset,s,t.componentType)}static DecodeBufferToText(e){let t="";const i=e.byteLength;for(let s=0;s<i;++s)t+=String.fromCharCode(e[s]);return t}static GetDefaultMaterial(e){if(!ub._DefaultMaterial){ot.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join("\n"),ot.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join("\n");const t={vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},i={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};ub._DefaultMaterial=new kl("GLTFDefaultMaterial",e,t,i),ub._DefaultMaterial.setColor4("u_emission",new F(.5,.5,.5,1))}return ub._DefaultMaterial}}ub._DefaultMaterial=null,function(e){e[e.IDENTIFIER=1]="IDENTIFIER",e[e.UNKNOWN=2]="UNKNOWN",e[e.END_OF_INPUT=3]="END_OF_INPUT"}(hb||(hb={}));class db{constructor(e){this._pos=0,this.currentToken=hb.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}getNextToken(){if(this.isEnd())return hb.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=hb.UNKNOWN,"_"===this.currentString||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=hb.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||"_"===this.currentString);)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken}peek(){return this._toParse[this._pos]}read(){return this._toParse[this._pos++]}forward(){this._pos++}isEnd(){return this._pos>=this._maxPos}}const pb=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],_b=["world","view","projection","worldView","worldViewProjection","mBones"],fb=["translation","rotation","scale"],mb=["position","rotationQuaternion","scaling"],gb=(e,t,i)=>{for(const s in e){const r=e[s];i[t][s]=r}},vb=e=>{if(e)for(let t=0;t<e.length/2;t++)e[2*t+1]=1-e[2*t+1]},xb=e=>{if("NORMAL"===e.semantic)return"normal";if("POSITION"===e.semantic)return"position";if("JOINT"===e.semantic)return"matricesIndices";if("WEIGHT"===e.semantic)return"matricesWeights";if("COLOR"===e.semantic)return"color";if(e.semantic&&-1!==e.semantic.indexOf("TEXCOORD_")){const t=Number(e.semantic.split("_")[1]);return"uv"+(0===t?"":t+1)}return null},Tb=e=>{let t=null;if(e.translation||e.rotation||e.scale){const i=S.FromArray(e.scale||[1,1,1]),s=C.FromArray(e.rotation||[0,0,0,1]),r=S.FromArray(e.translation||[0,0,0]);t=y.Compose(i,s,r)}else t=y.FromArray(e.matrix);return t},Eb=(e,t,i,s)=>{for(let e=0;e<s.bones.length;e++)if(s.bones[e].name===i)return s.bones[e];const r=e.nodes;for(const n in r){const o=r[n];if(!o.jointName)continue;const a=o.children;for(let r=0;r<a.length;r++){const l=e.nodes[a[r]];if(l.jointName&&l.jointName===i){const i=Tb(o),r=new Ki(o.name||"",s,Eb(e,t,o.jointName,s),i);return r.id=n,r}}}return null},Sb=(e,t)=>{for(let i=0;i<e.length;i++){const s=e[i];for(let e=0;e<s.node.children.length;e++)if(s.node.children[e]===t)return s.bone}return null},bb=(e,t)=>{const i=e.nodes;let s=i[t];if(s)return{node:s,id:t};for(const e in i)if(s=i[e],s.jointName===t)return{node:s,id:e};return null},Cb=(e,t)=>{for(let i=0;i<e.jointNames.length;i++)if(e.jointNames[i]===t)return!0;return!1},yb=(e,t,i,s,r)=>{if(r||(e.scene._blockEntityCollection=!!e.assetContainer,(r=new ur(t.name||"",e.scene))._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,r.id=s),!t.babylonNode)return r;const n=[];let o=null;const a=[],l=[],h=[],c=[];for(let t=0;t<i.length;t++){const s=i[t],r=e.meshes[s];if(r)for(let t=0;t<r.primitives.length;t++){const i=new As,s=r.primitives[t];s.mode;const u=s.attributes;let d=null,p=null;for(const t in u)if(d=e.accessors[u[t]],p=ub.GetBufferFromAccessor(e,d),"NORMAL"===t)i.normals=new Float32Array(p.length),i.normals.set(p);else if("POSITION"===t){if(cb.HomogeneousCoordinates){i.positions=new Float32Array(p.length-p.length/4);for(let e=0;e<p.length;e+=4)i.positions[e]=p[e],i.positions[e+1]=p[e+1],i.positions[e+2]=p[e+2]}else i.positions=new Float32Array(p.length),i.positions.set(p);l.push(i.positions.length)}else if(-1!==t.indexOf("TEXCOORD_")){const e=Number(t.split("_")[1]),s=hi.UVKind+(0===e?"":e+1),r=new Float32Array(p.length);r.set(p),vb(r),i.set(r,s)}else"JOINT"===t?(i.matricesIndices=new Float32Array(p.length),i.matricesIndices.set(p)):"WEIGHT"===t?(i.matricesWeights=new Float32Array(p.length),i.matricesWeights.set(p)):"COLOR"===t&&(i.colors=new Float32Array(p.length),i.colors.set(p));if(d=e.accessors[s.indices],d)p=ub.GetBufferFromAccessor(e,d),i.indices=new Int32Array(p.length),i.indices.set(p),c.push(i.indices.length);else{const e=[];for(let t=0;t<i.positions.length/3;t++)e.push(t);i.indices=new Int32Array(e),c.push(i.indices.length)}o?o.merge(i):o=i;const _=e.scene.getMaterialById(s.material);n.push(null===_?ub.GetDefaultMaterial(e.scene):_),a.push(0===a.length?0:a[a.length-1]+l[l.length-2]),h.push(0===h.length?0:h[h.length-1]+c[c.length-2])}}let u;e.scene._blockEntityCollection=!!e.assetContainer,n.length>1?(u=new rr("multimat"+s,e.scene),u.subMaterials=n):u=new Va("multimat"+s,e.scene),1===n.length&&(u=n[0]),u._parentContainer=e.assetContainer,r.material||(r.material=u),new Ps(s,e.scene,o,!1,r),r.computeWorldMatrix(!0),e.scene._blockEntityCollection=!1,r.subMeshes=[];let d=0;for(let t=0;t<i.length;t++){const s=i[t],n=e.meshes[s];if(n)for(let e=0;e<n.primitives.length;e++)n.primitives[e].mode,Cs.AddToMesh(d,a[d],l[d],h[d],c[d],r,r,!0),d++}return r},Ab=(e,t,i,s)=>{e.position&&(e.position=t),(e.rotationQuaternion||e.rotation)&&(e.rotationQuaternion=i),e.scaling&&(e.scaling=s)},Rb=(e,t,i)=>{let s=null;if(e.importOnlyMeshes&&(t.skin||t.meshes)&&e.importMeshesNames&&e.importMeshesNames.length>0&&-1===e.importMeshesNames.indexOf(t.name||""))return null;if(t.skin){if(t.meshes){const r=e.skins[t.skin],n=yb(e,t,t.meshes,i,t.babylonNode);n.skeleton=e.scene.getLastSkeletonById(t.skin),null===n.skeleton&&(n.skeleton=((e,t,i,s)=>{if(s||(s=new no(t.name||"","",e.scene)),!t.babylonSkeleton)return s;const r=[],n=[];((e,t,i,s)=>{for(const r in e.nodes){const n=e.nodes[r],o=r;if(!n.jointName||Cb(i,n.jointName))continue;const a=Tb(n),l=new Ki(n.name||"",t,null,a);l.id=o,s.push({bone:l,node:n,id:o})}for(let e=0;e<s.length;e++){const t=s[e],i=t.node.children;for(let e=0;e<i.length;e++){let r=null;for(let t=0;t<s.length;t++)if(s[t].id===i[e]){r=s[t];break}r&&(r.bone._parent=t.bone,t.bone.children.push(r.bone))}}})(e,s,t,r),s.bones=[];for(let i=0;i<t.jointNames.length;i++){const o=bb(e,t.jointNames[i]);if(!o)continue;const a=o.node;if(!a){Ht.Warn("Joint named "+t.jointNames[i]+" does not exist");continue}const l=o.id,h=e.scene.getBoneById(l);if(h){s.bones.push(h);continue}let c=!1,u=null;for(let r=0;r<i;r++){const i=bb(e,t.jointNames[r]);if(!i)continue;const n=i.node;if(!n){Ht.Warn("Joint named "+t.jointNames[r]+" does not exist when looking for parent");continue}const o=n.children;if(o){c=!1;for(let i=0;i<o.length;i++)if(o[i]===l){u=Eb(e,t,t.jointNames[r],s),c=!0;break}if(c)break}}const d=Tb(a);!u&&r.length>0&&(u=Sb(r,l),u&&-1===n.indexOf(u)&&n.push(u)),new Ki(a.jointName||"",s,u,d).id=l}const o=s.bones;s.bones=[];for(let i=0;i<t.jointNames.length;i++){const r=bb(e,t.jointNames[i]);if(r)for(let e=0;e<o.length;e++)if(o[e].id===r.id){s.bones.push(o[e]);break}}s.prepare();for(let e=0;e<n.length;e++)s.bones.push(n[e]);return s})(e,r,0,r.babylonSkeleton),r.babylonSkeleton||(r.babylonSkeleton=n.skeleton)),s=n}}else if(t.meshes)s=yb(e,t,t.mesh?[t.mesh]:t.meshes,i,t.babylonNode);else if(!t.light||t.babylonNode||e.importOnlyMeshes){if(t.camera&&!t.babylonNode&&!e.importOnlyMeshes){const i=e.cameras[t.camera];if(i){if(e.scene._blockEntityCollection=!!e.assetContainer,"orthographic"===i.type){const i=new zo(t.camera,S.Zero(),e.scene,!1);i.name=t.name||"",i.mode=ps.ORTHOGRAPHIC_CAMERA,i.attachControl(),s=i,i._parentContainer=e.assetContainer}else if("perspective"===i.type){const r=i[i.type],n=new zo(t.camera,S.Zero(),e.scene,!1);n.name=t.name||"",n.attachControl(),r.aspectRatio||(r.aspectRatio=e.scene.getEngine().getRenderWidth()/e.scene.getEngine().getRenderHeight()),r.znear&&r.zfar&&(n.maxZ=r.zfar,n.minZ=r.znear),s=n,n._parentContainer=e.assetContainer}e.scene._blockEntityCollection=!1}}}else{const i=e.lights[t.light];if(i)if("ambient"===i.type){const r=i[i.type],n=new Cl(t.light,S.Zero(),e.scene);n.name=t.name||"",r.color&&(n.diffuse=N.FromArray(r.color)),s=n}else if("directional"===i.type){const r=i[i.type],n=new rd(t.light,S.Zero(),e.scene);n.name=t.name||"",r.color&&(n.diffuse=N.FromArray(r.color)),s=n}else if("point"===i.type){const r=i[i.type],n=new Wp(t.light,S.Zero(),e.scene);n.name=t.name||"",r.color&&(n.diffuse=N.FromArray(r.color)),s=n}else if("spot"===i.type){const r=i[i.type],n=new od(t.light,S.Zero(),S.Zero(),0,0,e.scene);n.name=t.name||"",r.color&&(n.diffuse=N.FromArray(r.color)),r.fallOfAngle&&(n.angle=r.fallOfAngle),r.fallOffExponent&&(n.exponent=r.fallOffExponent),s=n}}if(!t.jointName){if(t.babylonNode)return t.babylonNode;if(null===s){e.scene._blockEntityCollection=!!e.assetContainer;const i=new ur(t.name||"",e.scene);i._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,t.babylonNode=i,s=i}}if(null!==s){if(t.matrix&&s instanceof ur)((e,t)=>{if(t.matrix){const i=new S(0,0,0),s=new C,r=new S(0,0,0);y.FromArray(t.matrix).decompose(r,s,i),Ab(e,i,s,r)}else t.translation&&t.rotation&&t.scale&&Ab(e,S.FromArray(t.translation),C.FromArray(t.rotation),S.FromArray(t.scale));e.computeWorldMatrix(!0)})(s,t);else{const e=t.translation||[0,0,0],i=t.rotation||[0,0,0,1],r=t.scale||[1,1,1];Ab(s,S.FromArray(e),C.FromArray(i),S.FromArray(r))}s.updateCache(!0),t.babylonNode=s}return s},Ib=(e,t,i,s=!1)=>{const r=e.nodes[t];let n=null;if(s=!(e.importOnlyMeshes&&!s&&e.importMeshesNames)||-1!==e.importMeshesNames.indexOf(r.name||"")||0===e.importMeshesNames.length,!r.jointName&&s&&(n=Rb(e,r,t),null!==n&&(n.id=t,n.parent=i)),r.children)for(let t=0;t<r.children.length;t++)Ib(e,r.children[t],n,s)},Pb=e=>{let t=e.currentScene;if(t)for(let i=0;i<t.nodes.length;i++)Ib(e,t.nodes[i],null);else for(const i in e.scenes){t=e.scenes[i];for(let i=0;i<t.nodes.length;i++)Ib(e,t.nodes[i],null)}(e=>{for(const t in e.animations){const i=e.animations[t];if(!i.channels||!i.samplers)continue;let s=null;for(let r=0;r<i.channels.length;r++){const n=i.channels[r],o=i.samplers[n.sampler];if(!o)continue;let a=null,l=null;i.parameters?(a=i.parameters[o.input],l=i.parameters[o.output]):(a=o.input,l=o.output);const h=ub.GetBufferFromAccessor(e,e.accessors[a]),c=ub.GetBufferFromAccessor(e,e.accessors[l]),u=n.target.id;let d=e.scene.getNodeById(u);if(null===d&&(d=e.scene.getNodeByName(u)),null===d){Ht.Warn("Creating animation named "+t+". But cannot find node named "+u+" to attach to");continue}const p=d instanceof Ki;let _=n.target.path;const f=fb.indexOf(_);-1!==f&&(_=mb[f]);let m=Ie.ANIMATIONTYPE_MATRIX;p||("rotationQuaternion"===_?(m=Ie.ANIMATIONTYPE_QUATERNION,d.rotationQuaternion=new C):m=Ie.ANIMATIONTYPE_VECTOR3);let g=null;const v=[];let x=0,T=!1;p&&s&&s.getKeys().length===h.length&&(g=s,T=!0),T||(e.scene._blockEntityCollection=!!e.assetContainer,g=new Ie(t,p?"_matrix":_,1,m,Ie.ANIMATIONLOOPMODE_CYCLE),e.scene._blockEntityCollection=!1);for(let e=0;e<h.length;e++){let t=null;if("rotationQuaternion"===_?(t=C.FromArray([c[x],c[x+1],c[x+2],c[x+3]]),x+=4):(t=S.FromArray([c[x],c[x+1],c[x+2]]),x+=3),p){const i=d;let r=S.Zero(),n=new C,o=S.Zero(),a=i.getBaseMatrix();T&&s&&(a=s.getKeys()[e].value),a.decompose(o,n,r),"position"===_?r=t:"rotationQuaternion"===_?n=t:o=t,t=y.Compose(o,n,r)}T?s&&(s.getKeys()[e].value=t):v.push({frame:h[e],value:t})}!T&&g&&(g.setKeys(v),d.animations.push(g)),s=g,e.scene.stopAnimation(d),e.scene.beginAnimation(d,0,h[h.length-1],!0,1)}}})(e);for(let t=0;t<e.scene.skeletons.length;t++){const i=e.scene.skeletons[t];e.scene.beginAnimation(i,0,Number.MAX_VALUE,!0,1)}},Mb=(e,t,i)=>{for(const s in t.uniforms){const r=t.uniforms[s],n=t.parameters[r];if(e.currentIdentifier===s&&n.semantic&&!n.source&&!n.node){const e=pb.indexOf(n.semantic);if(-1!==e)return delete i[s],_b[e]}}return e.currentIdentifier},Ob=e=>{for(const t in e.materials)Fb.LoadMaterialAsync(e,t,(()=>{}),(()=>{}))};class Db{static CreateRuntime(e,t,i){const s={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:t,rootUrl:i,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return e.extensions&&gb(e.extensions,"extensions",s),e.extensionsUsed&&gb(e.extensionsUsed,"extensionsUsed",s),e.buffers&&((e,t)=>{for(const i in e){const s=e[i];t.buffers[i]=s,t.buffersCount++}})(e.buffers,s),e.bufferViews&&gb(e.bufferViews,"bufferViews",s),e.accessors&&gb(e.accessors,"accessors",s),e.meshes&&gb(e.meshes,"meshes",s),e.lights&&gb(e.lights,"lights",s),e.cameras&&gb(e.cameras,"cameras",s),e.nodes&&gb(e.nodes,"nodes",s),e.images&&gb(e.images,"images",s),e.textures&&gb(e.textures,"textures",s),e.shaders&&((e,t)=>{for(const i in e){const s=e[i];t.shaders[i]=s,t.shaderscount++}})(e.shaders,s),e.programs&&gb(e.programs,"programs",s),e.samplers&&gb(e.samplers,"samplers",s),e.techniques&&gb(e.techniques,"techniques",s),e.materials&&gb(e.materials,"materials",s),e.animations&&gb(e.animations,"animations",s),e.skins&&gb(e.skins,"skins",s),e.scenes&&(s.scenes=e.scenes),e.scene&&e.scenes&&(s.currentScene=e.scenes[e.scene]),s}static LoadBufferAsync(e,t,i,s,r){const n=e.buffers[t];Ht.IsBase64(n.uri)?setTimeout((()=>i(new Uint8Array(Ht.DecodeBase64(n.uri))))):Ht.LoadFile(e.rootUrl+n.uri,(e=>i(new Uint8Array(e))),r,void 0,!0,(e=>{e&&s(e.status+" "+e.statusText)}))}static LoadTextureBufferAsync(e,t,i,s){const r=e.textures[t];if(!r||!r.source)return void s("");if(r.babylonTexture)return void i(null);const n=e.images[r.source];Ht.IsBase64(n.uri)?setTimeout((()=>i(new Uint8Array(Ht.DecodeBase64(n.uri))))):Ht.LoadFile(e.rootUrl+n.uri,(e=>i(new Uint8Array(e))),void 0,void 0,!0,(e=>{e&&s(e.status+" "+e.statusText)}))}static CreateTextureAsync(e,t,i,s){const r=e.textures[t];if(r.babylonTexture)return void s(r.babylonTexture);const n=e.samplers[r.sampler],o=n.minFilter===nb.NEAREST_MIPMAP_NEAREST||n.minFilter===nb.NEAREST_MIPMAP_LINEAR||n.minFilter===nb.LINEAR_MIPMAP_NEAREST||n.minFilter===nb.LINEAR_MIPMAP_LINEAR,a=Ar.BILINEAR_SAMPLINGMODE,l=null==i?new Blob:new Blob([i]),h=URL.createObjectURL(l),c=()=>URL.revokeObjectURL(h),u=new Ar(h,e.scene,!o,!0,a,c,c);void 0!==n.wrapS&&(u.wrapU=ub.GetWrapMode(n.wrapS)),void 0!==n.wrapT&&(u.wrapV=ub.GetWrapMode(n.wrapT)),u.name=t,r.babylonTexture=u,s(u)}static LoadShaderStringAsync(e,t,i,s){const r=e.shaders[t];if(Ht.IsBase64(r.uri)){const e=atob(r.uri.split(",")[1]);i&&i(e)}else Ht.LoadFile(e.rootUrl+r.uri,i,void 0,void 0,!1,(e=>{e&&s&&s(e.status+" "+e.statusText)}))}static LoadMaterialAsync(e,t,i,s){const r=e.materials[t];if(!r.technique)return void(s&&s("No technique found."));const n=e.techniques[r.technique];if(!n){e.scene._blockEntityCollection=!!e.assetContainer;const s=new Va(t,e.scene);return s._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,s.diffuseColor=new N(.5,.5,.5),s.sideOrientation=sr.CounterClockWiseSideOrientation,void i(s)}const o=e.programs[n.program],a=n.states,l=ot.ShadersStore[o.vertexShader+"VertexShader"],h=ot.ShadersStore[o.fragmentShader+"PixelShader"];let c="",u="";const d=new db(l),p=new db(h),_={},f=[],m=[],g=[];for(const e in n.uniforms){const t=n.uniforms[e],i=n.parameters[t];if(_[e]=i,!i.semantic||i.node||i.source)i.type===sb.SAMPLER_2D?g.push(e):f.push(e);else{const t=pb.indexOf(i.semantic);-1!==t?(f.push(_b[t]),delete _[e]):f.push(e)}}for(const e in n.attributes){const t=n.attributes[e],i=n.parameters[t];if(i.semantic){const e=xb(i);e&&m.push(e)}}for(;!d.isEnd()&&d.getNextToken();){if(d.currentToken!==hb.IDENTIFIER){c+=d.currentString;continue}let e=!1;for(const t in n.attributes){const i=n.attributes[t],s=n.parameters[i];if(d.currentIdentifier===t&&s.semantic){c+=xb(s),e=!0;break}}e||(c+=Mb(d,n,_))}for(;!p.isEnd()&&p.getNextToken();)p.currentToken===hb.IDENTIFIER?u+=Mb(p,n,_):u+=p.currentString;const v={vertex:o.vertexShader+t,fragment:o.fragmentShader+t},x={attributes:m,uniforms:f,samplers:g,needAlphaBlending:a&&a.enable&&-1!==a.enable.indexOf(3042)};ot.ShadersStore[o.vertexShader+t+"VertexShader"]=c,ot.ShadersStore[o.fragmentShader+t+"PixelShader"]=u;const T=new kl(t,e.scene,v,x);if(T.onError=((e,t,i)=>(s,r)=>{t.dispose(!0),i("Cannot compile program named "+e.name+". Error: "+r+". Default material will be applied")})(o,T,s),T.onCompiled=((e,t,i,s,r,n)=>o=>{((e,t,i,s,r)=>{const n=s.values||i.parameters,o=i.uniforms;for(const i in r){const a=r[i],l=a.type;let h=n[o[i]];if(void 0===h&&(h=a.value),!h)continue;const c=e=>i=>{a.value&&e&&(t.setTexture(e,i),delete r[e])};l===sb.SAMPLER_2D?Fb.LoadTextureAsync(e,s.values?h:a.value,c(i),(()=>c(null))):a.value&&ub.SetUniform(t,i,s.values?h:a.value,l)&&delete r[i]}})(e,t,i,s,r),t.onBind=o=>{((e,t,i,s,r,n,o)=>{const a=n.values||r.parameters;for(const o in i){const l=i[o],h=l.type;if(h===sb.FLOAT_MAT2||h===sb.FLOAT_MAT3||h===sb.FLOAT_MAT4)if(!l.semantic||l.source||l.node){if(l.semantic&&(l.source||l.node)){let e=t.scene.getNodeByName(l.source||l.node||"");if(null===e&&(e=t.scene.getNodeById(l.source||l.node||"")),null===e)continue;ub.SetMatrix(t.scene,e,l,o,s.getEffect())}}else ub.SetMatrix(t.scene,e,l,o,s.getEffect());else{const e=a[r.uniforms[o]];if(!e)continue;if(h===sb.SAMPLER_2D){const i=t.textures[n.values?e:l.value].babylonTexture;if(null==i)continue;s.getEffect().setTexture(o,i)}else ub.SetUniform(s.getEffect(),o,e,h)}}o(s)})(o,e,r,t,i,s,n)}})(e,T,n,r,_,i),T.sideOrientation=sr.CounterClockWiseSideOrientation,a&&a.functions){const e=a.functions;e.cullFace&&e.cullFace[0]!==ab.BACK&&(T.backFaceCulling=!1);const t=e.blendFuncSeparate;t&&(t[0]===lb.SRC_ALPHA&&t[1]===lb.ONE_MINUS_SRC_ALPHA&&t[2]===lb.ONE&&t[3]===lb.ONE?T.alphaMode=ph.ALPHA_COMBINE:t[0]===lb.ONE&&t[1]===lb.ONE&&t[2]===lb.ZERO&&t[3]===lb.ONE?T.alphaMode=ph.ALPHA_ONEONE:t[0]===lb.SRC_ALPHA&&t[1]===lb.ONE&&t[2]===lb.ZERO&&t[3]===lb.ONE?T.alphaMode=ph.ALPHA_ADD:t[0]===lb.ZERO&&t[1]===lb.ONE_MINUS_SRC_COLOR&&t[2]===lb.ONE&&t[3]===lb.ONE?T.alphaMode=ph.ALPHA_SUBTRACT:t[0]===lb.DST_COLOR&&t[1]===lb.ZERO&&t[2]===lb.ONE&&t[3]===lb.ONE?T.alphaMode=ph.ALPHA_MULTIPLY:t[0]===lb.SRC_ALPHA&&t[1]===lb.ONE_MINUS_SRC_COLOR&&t[2]===lb.ONE&&t[3]===lb.ONE&&(T.alphaMode=ph.ALPHA_MAXIMIZED))}}}class Nb{static RegisterExtension(e){Nb.Extensions[e.name]?Ht.Error('Tool with the same name "'+e.name+'" already exists'):Nb.Extensions[e.name]=e}dispose(){}_importMeshAsync(e,t,i,s,r,n,o,a){return t.useRightHandedSystem=!0,Fb.LoadRuntimeAsync(t,i,s,(t=>{t.assetContainer=r,t.importOnlyMeshes=!0,""===e?t.importMeshesNames=[]:"string"==typeof e?t.importMeshesNames=[e]:!e||e instanceof Array?(t.importMeshesNames=[],Ht.Warn("Argument meshesNames must be of type string or string[]")):t.importMeshesNames=[e],this._createNodes(t);const i=[],s=[];for(const e in t.nodes){const s=t.nodes[e];s.babylonNode instanceof Vs&&i.push(s.babylonNode)}for(const e in t.skins){const i=t.skins[e];i.babylonSkeleton instanceof no&&s.push(i.babylonSkeleton)}this._loadBuffersAsync(t,(()=>{this._loadShadersAsync(t,(()=>{Ob(t),Pb(t),!cb.IncrementalLoading&&n&&n(i,s)}))})),cb.IncrementalLoading&&n&&n(i,s)}),a),!0}importMeshAsync(e,t,i,s,r,n){return new Promise(((o,a)=>{this._importMeshAsync(e,t,s,r,i,((e,t)=>{o({meshes:e,particleSystems:[],skeletons:t,animationGroups:[],lights:[],transformNodes:[],geometries:[]})}),n,(e=>{a(new Error(e))}))}))}_loadAsync(e,t,i,s,r,n){e.useRightHandedSystem=!0,Fb.LoadRuntimeAsync(e,t,i,(e=>{Fb.LoadRuntimeExtensionsAsync(e,(()=>{this._createNodes(e),this._loadBuffersAsync(e,(()=>{this._loadShadersAsync(e,(()=>{Ob(e),Pb(e),cb.IncrementalLoading||s()}))})),cb.IncrementalLoading&&s()}),n)}),n)}loadAsync(e,t,i,s){return new Promise(((r,n)=>{this._loadAsync(e,t,i,(()=>{r()}),s,(e=>{n(new Error(e))}))}))}_loadShadersAsync(e,t){let i=!1;const s=(i,s)=>{Fb.LoadShaderStringAsync(e,i,(r=>{r instanceof ArrayBuffer||(e.loadedShaderCount++,r&&(ot.ShadersStore[i+(s.type===ib.VERTEX?"VertexShader":"PixelShader")]=r),e.loadedShaderCount===e.shaderscount&&t())}),(()=>{Ht.Error("Error when loading shader program named "+i+" located at "+s.uri)}))};for(const t in e.shaders){i=!0;const r=e.shaders[t];r?s.bind(this,t,r)():Ht.Error("No shader named: "+t)}i||t()}_loadBuffersAsync(e,t){let i=!1;const s=(i,s)=>{Fb.LoadBufferAsync(e,i,(r=>{e.loadedBufferCount++,r&&(r.byteLength!=e.buffers[i].byteLength&&Ht.Error("Buffer named "+i+" is length "+r.byteLength+". Expected: "+s.byteLength),e.loadedBufferViews[i]=r),e.loadedBufferCount===e.buffersCount&&t()}),(()=>{Ht.Error("Error when loading buffer named "+i+" located at "+s.uri)}))};for(const t in e.buffers){i=!0;const r=e.buffers[t];r?s.bind(this,t,r)():Ht.Error("No buffer named: "+t)}i||t()}_createNodes(e){let t=e.currentScene;if(t)for(let i=0;i<t.nodes.length;i++)Ib(e,t.nodes[i],null);else for(const i in e.scenes){t=e.scenes[i];for(let i=0;i<t.nodes.length;i++)Ib(e,t.nodes[i],null)}}}Nb.Extensions={};class Fb{constructor(e){this._name=e}get name(){return this._name}loadRuntimeAsync(e,t,i,s,r){return!1}loadRuntimeExtensionsAsync(e,t,i){return!1}loadBufferAsync(e,t,i,s,r){return!1}loadTextureBufferAsync(e,t,i,s){return!1}createTextureAsync(e,t,i,s,r){return!1}loadShaderStringAsync(e,t,i,s){return!1}loadMaterialAsync(e,t,i,s){return!1}static LoadRuntimeAsync(e,t,i,s,r){Fb._ApplyExtensions((n=>n.loadRuntimeAsync(e,t,i,s,r)),(()=>{setTimeout((()=>{s&&s(Db.CreateRuntime(t.json,e,i))}))}))}static LoadRuntimeExtensionsAsync(e,t,i){Fb._ApplyExtensions((s=>s.loadRuntimeExtensionsAsync(e,t,i)),(()=>{setTimeout((()=>{t()}))}))}static LoadBufferAsync(e,t,i,s,r){Fb._ApplyExtensions((n=>n.loadBufferAsync(e,t,i,s,r)),(()=>{Db.LoadBufferAsync(e,t,i,s,r)}))}static LoadTextureAsync(e,t,i,s){Fb._LoadTextureBufferAsync(e,t,(r=>{r&&Fb._CreateTextureAsync(e,t,r,i,s)}),s)}static LoadShaderStringAsync(e,t,i,s){Fb._ApplyExtensions((r=>r.loadShaderStringAsync(e,t,i,s)),(()=>{Db.LoadShaderStringAsync(e,t,i,s)}))}static LoadMaterialAsync(e,t,i,s){Fb._ApplyExtensions((r=>r.loadMaterialAsync(e,t,i,s)),(()=>{Db.LoadMaterialAsync(e,t,i,s)}))}static _LoadTextureBufferAsync(e,t,i,s){Fb._ApplyExtensions((r=>r.loadTextureBufferAsync(e,t,i,s)),(()=>{Db.LoadTextureBufferAsync(e,t,i,s)}))}static _CreateTextureAsync(e,t,i,s,r){Fb._ApplyExtensions((n=>n.createTextureAsync(e,t,i,s,r)),(()=>{Db.CreateTextureAsync(e,t,i,s)}))}static _ApplyExtensions(e,t){for(const t in Nb.Extensions)if(e(Nb.Extensions[t]))return;t()}}function wb(e,t,i,s){return S.FromArray(t,i).scaleInPlace(s)}cb._CreateGLTF1Loader=()=>new Nb,Nb.RegisterExtension(new class extends Fb{constructor(){super("KHR_binary_glTF")}loadRuntimeAsync(e,t,i,s){const r=t.json.extensionsUsed;return!(!r||-1===r.indexOf(this.name)||!t.bin||(this._bin=t.bin,s(Db.CreateRuntime(t.json,e,i)),0))}loadBufferAsync(e,t,i,s){return-1!==e.extensionsUsed.indexOf(this.name)&&"binary_glTF"===t&&(this._bin.readAsync(0,this._bin.byteLength).then(i,(e=>s(e.message))),!0)}loadTextureBufferAsync(e,t,i){const s=e.textures[t],r=e.images[s.source];if(!r.extensions||!(this.name in r.extensions))return!1;const n=r.extensions[this.name],o=e.bufferViews[n.bufferView];return i(ub.GetBufferFromBufferView(e,o,0,o.byteLength,tb.UNSIGNED_BYTE)),!0}loadShaderStringAsync(e,t,i){const s=e.shaders[t];if(!s.extensions||!(this.name in s.extensions))return!1;const r=s.extensions[this.name],n=e.bufferViews[r.bufferView],o=ub.GetBufferFromBufferView(e,n,0,n.byteLength,tb.UNSIGNED_BYTE);return setTimeout((()=>{const e=ub.DecodeBufferToText(o);i(e)})),!0}}),Nb.RegisterExtension(new class extends Fb{constructor(){super("KHR_materials_common")}loadRuntimeExtensionsAsync(e){if(!e.extensions)return!1;const t=e.extensions[this.name];if(!t)return!1;const i=t.lights;if(i)for(const t in i){const s=i[t];switch(s.type){case"ambient":{const t=new Cl(s.name,new S(0,1,0),e.scene),i=s.ambient;i&&(t.diffuse=N.FromArray(i.color||[1,1,1]));break}case"point":{const t=new Wp(s.name,new S(10,10,10),e.scene),i=s.point;i&&(t.diffuse=N.FromArray(i.color||[1,1,1]));break}case"directional":{const t=new rd(s.name,new S(0,-1,0),e.scene),i=s.directional;i&&(t.diffuse=N.FromArray(i.color||[1,1,1]));break}case"spot":{const t=s.spot;t&&(new od(s.name,new S(0,10,0),new S(0,-1,0),t.fallOffAngle||Math.PI,t.fallOffExponent||0,e.scene).diffuse=N.FromArray(t.color||[1,1,1]));break}default:Ht.Warn('GLTF Material Common extension: light type "'+s.type+"” not supported")}}return!1}loadMaterialAsync(e,t,i,s){const r=e.materials[t];if(!r||!r.extensions)return!1;const n=r.extensions[this.name];if(!n)return!1;const o=new Va(t,e.scene);return o.sideOrientation=sr.CounterClockWiseSideOrientation,"CONSTANT"===n.technique&&(o.disableLighting=!0),o.backFaceCulling=void 0!==n.doubleSided&&!n.doubleSided,o.alpha=void 0===n.values.transparency?1:n.values.transparency,o.specularPower=void 0===n.values.shininess?0:n.values.shininess,"string"==typeof n.values.ambient?this._loadTexture(e,n.values.ambient,o,"ambientTexture",s):o.ambientColor=N.FromArray(n.values.ambient||[0,0,0]),"string"==typeof n.values.diffuse?this._loadTexture(e,n.values.diffuse,o,"diffuseTexture",s):o.diffuseColor=N.FromArray(n.values.diffuse||[0,0,0]),"string"==typeof n.values.emission?this._loadTexture(e,n.values.emission,o,"emissiveTexture",s):o.emissiveColor=N.FromArray(n.values.emission||[0,0,0]),"string"==typeof n.values.specular?this._loadTexture(e,n.values.specular,o,"specularTexture",s):o.specularColor=N.FromArray(n.values.specular||[0,0,0]),!0}_loadTexture(e,t,i,s,r){Db.LoadTextureBufferAsync(e,t,(r=>{Db.CreateTextureAsync(e,t,r,(e=>i[s]=e))}),r)}});class Lb{constructor(e,t,i,s){this.type=e,this.name=t,this.getValue=i,this.getStride=s}_buildAnimation(e,t,i){const s=new Ie(e,this.name,t,this.type);return s.setKeys(i),s}}class Bb extends Lb{buildAnimations(e,t,i,s,r){r(e._babylonTransformNode,this._buildAnimation(t,i,s))}}const Ub={translation:[new Bb(Ie.ANIMATIONTYPE_VECTOR3,"position",wb,(()=>3))],rotation:[new Bb(Ie.ANIMATIONTYPE_QUATERNION,"rotationQuaternion",(function(e,t,i,s){return C.FromArray(t,i).scaleInPlace(s)}),(()=>4))],scale:[new Bb(Ie.ANIMATIONTYPE_VECTOR3,"scaling",wb,(()=>3))],weights:[new class extends Lb{buildAnimations(e,t,i,s,r){if(e._numMorphTargets)for(let n=0;n<e._numMorphTargets;n++){const o=new Ie(`${t}_${n}`,this.name,i,this.type);if(o.setKeys(s.map((e=>({frame:e.frame,inTangent:e.inTangent?e.inTangent[n]:void 0,value:e.value[n],outTangent:e.outTangent?e.outTangent[n]:void 0,interpolation:e.interpolation})))),e._primitiveBabylonMeshes)for(const t of e._primitiveBabylonMeshes)if(t.morphTargetManager){const e=t.morphTargetManager.getTarget(n),i=o.clone();e.animations.push(i),r(e,i)}}}}(Ie.ANIMATIONTYPE_FLOAT,"influence",(function(e,t,i,s){const r=new Array(e._numMorphTargets);for(let e=0;e<r.length;e++)r[e]=t[i++]*s;return r}),(e=>e._numMorphTargets))]};function Vb(...e){const t=e=>e&&"object"==typeof e;return e.reduce(((e,i)=>(Object.keys(i).forEach((s=>{const r=e[s],n=i[s];Array.isArray(r)&&Array.isArray(n)?e[s]=r.concat(...n):t(r)&&t(n)?e[s]=Vb(r,n):e[s]=n})),e)),{})}class kb{static Get(e,t,i){if(!t||null==i||!t[i])throw new Error(`${e}: Failed to find index (${i})`);return t[i]}static TryGet(e,t){return e&&null!=t&&e[t]?e[t]:null}static Assign(e){if(e)for(let t=0;t<e.length;t++)e[t].index=t}}class Gb{static RegisterExtension(e,t){Gb.UnregisterExtension(e)&&k.Warn(`Extension with the name '${e}' already exists`),Gb._RegisteredExtensions[e]={factory:t}}static UnregisterExtension(e){return!!Gb._RegisteredExtensions[e]&&(delete Gb._RegisteredExtensions[e],!0)}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}constructor(e){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._allMaterialsDirtyRequired=!1,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._parent=e}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach((e=>e.dispose&&e.dispose())),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}importMeshAsync(e,t,i,s,r,n,o=""){return Promise.resolve().then((()=>{this._babylonScene=t,this._assetContainer=i,this._loadData(s);let n=null;if(e){const t={};if(this._gltf.nodes)for(const e of this._gltf.nodes)e.name&&(t[e.name]=e.index);n=(e instanceof Array?e:[e]).map((e=>{const i=t[e];if(void 0===i)throw new Error(`Failed to find node '${e}'`);return i}))}return this._loadAsync(r,o,n,(()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries()})))}))}loadAsync(e,t,i,s,r=""){return Promise.resolve().then((()=>(this._babylonScene=e,this._loadData(t),this._loadAsync(i,r,null,(()=>{})))))}_loadAsync(e,t,i,s){return Promise.resolve().then((()=>{this._rootUrl=e,this._uniqueRootUrl=!e.startsWith("file:")&&t?e:`${e}${Date.now()}/`,this._fileName=t,this._allMaterialsDirtyRequired=!1,this._loadExtensions(),this._checkExtensions();const r=`${eb[eb.LOADING]} => ${eb[eb.READY]}`,n=`${eb[eb.LOADING]} => ${eb[eb.COMPLETE]}`;this._parent._startPerformanceCounter(r),this._parent._startPerformanceCounter(n),this._parent._setState(eb.LOADING),this._extensionsOnLoading();const o=new Array,a=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials)if(i)o.push(this.loadSceneAsync("/nodes",{nodes:i,index:-1}));else if(null!=this._gltf.scene||this._gltf.scenes&&this._gltf.scenes[0]){const e=kb.Get("/scene",this._gltf.scenes,this._gltf.scene||0);o.push(this.loadSceneAsync(`/scenes/${e.index}`,e))}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let e=0;e<this._gltf.materials.length;++e){const t=this._gltf.materials[e],i="/materials/"+e,s=sr.TriangleFillMode;o.push(this._loadMaterialAsync(i,t,null,s,(()=>{})))}return this._allMaterialsDirtyRequired?this._babylonScene.blockMaterialDirtyMechanism=a:this._babylonScene._forceBlockMaterialDirtyMechanism(a),this._parent.compileMaterials&&o.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&o.push(this._compileShadowGeneratorsAsync()),Promise.all(o).then((()=>(this._rootBabylonMesh&&this._rootBabylonMesh.setEnabled(!0),this._extensionsOnReady(),this._parent._setState(eb.READY),this._startAnimations(),s()))).then((e=>(this._parent._endPerformanceCounter(r),Ht.SetImmediate((()=>{this._disposed||Promise.all(this._completePromises).then((()=>{this._parent._endPerformanceCounter(n),this._parent._setState(eb.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()}),(e=>{this._parent.onErrorObservable.notifyObservers(e),this._parent.onErrorObservable.clear(),this.dispose()}))})),e)))})).catch((e=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(e),this._parent.onErrorObservable.clear(),this.dispose()),e}))}_loadData(e){if(this._gltf=e.json,this._setupData(),e.bin){const t=this._gltf.buffers;if(t&&t[0]&&!t[0].uri){const i=t[0];(i.byteLength<e.bin.byteLength-3||i.byteLength>e.bin.byteLength)&&k.Warn(`Binary buffer length (${i.byteLength}) from JSON does not match chunk length (${e.bin.byteLength})`),this._bin=e.bin}else k.Warn("Unexpected BIN chunk")}}_setupData(){if(kb.Assign(this._gltf.accessors),kb.Assign(this._gltf.animations),kb.Assign(this._gltf.buffers),kb.Assign(this._gltf.bufferViews),kb.Assign(this._gltf.cameras),kb.Assign(this._gltf.images),kb.Assign(this._gltf.materials),kb.Assign(this._gltf.meshes),kb.Assign(this._gltf.nodes),kb.Assign(this._gltf.samplers),kb.Assign(this._gltf.scenes),kb.Assign(this._gltf.skins),kb.Assign(this._gltf.textures),this._gltf.nodes){const e={};for(const t of this._gltf.nodes)if(t.children)for(const i of t.children)e[i]=t.index;const t=this._createRootNode();for(const i of this._gltf.nodes){const s=e[i.index];i.parent=void 0===s?t:this._gltf.nodes[s]}}}_loadExtensions(){for(const e in Gb._RegisteredExtensions){const t=Gb._RegisteredExtensions[e].factory(this);t.name!==e&&k.Warn(`The name of the glTF loader extension instance does not match the registered name: ${t.name} !== ${e}`),this._extensions.push(t),this._parent.onExtensionLoadedObservable.notifyObservers(t)}this._extensions.sort(((e,t)=>(e.order||Number.MAX_VALUE)-(t.order||Number.MAX_VALUE))),this._parent.onExtensionLoadedObservable.clear()}_checkExtensions(){if(this._gltf.extensionsRequired)for(const e of this._gltf.extensionsRequired)if(!this._extensions.some((t=>t.name===e&&t.enabled)))throw new Error(`Required extension ${e} is not available`)}_createRootNode(){this._babylonScene._blockEntityCollection=!!this._assetContainer,this._rootBabylonMesh=new ur("__root__",this._babylonScene),this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);const e={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case ZS.AUTO:this._babylonScene.useRightHandedSystem||(e.rotation=[0,1,0,0],e.scale=[1,1,-1],Gb._LoadTransform(e,this._rootBabylonMesh));break;case ZS.FORCE_RIGHT_HANDED:this._babylonScene.useRightHandedSystem=!0;break;default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(this._rootBabylonMesh),e}loadSceneAsync(e,t){const i=this._extensionsLoadSceneAsync(e,t);if(i)return i;const s=new Array;if(this.logOpen(`${e} ${t.name||""}`),t.nodes)for(const i of t.nodes){const t=kb.Get(`${e}/nodes/${i}`,this._gltf.nodes,i);s.push(this.loadNodeAsync(`/nodes/${t.index}`,t,(e=>{e.parent=this._rootBabylonMesh})))}for(const e of this._postSceneLoadActions)e();return s.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(s).then((()=>{}))}_forEachPrimitive(e,t){if(e._primitiveBabylonMeshes)for(const i of e._primitiveBabylonMeshes)t(i)}_getGeometries(){const e=[],t=this._gltf.nodes;if(t)for(const i of t)this._forEachPrimitive(i,(t=>{const i=t.geometry;i&&-1===e.indexOf(i)&&e.push(i)}));return e}_getMeshes(){const e=[];this._rootBabylonMesh&&e.push(this._rootBabylonMesh);const t=this._gltf.nodes;if(t)for(const i of t)this._forEachPrimitive(i,(t=>{e.push(t)}));return e}_getTransformNodes(){const e=[],t=this._gltf.nodes;if(t)for(const i of t)i._babylonTransformNode&&"TransformNode"===i._babylonTransformNode.getClassName()&&e.push(i._babylonTransformNode),i._babylonTransformNodeForSkin&&e.push(i._babylonTransformNodeForSkin);return e}_getSkeletons(){const e=[],t=this._gltf.skins;if(t)for(const i of t)i._data&&e.push(i._data.babylonSkeleton);return e}_getAnimationGroups(){const e=[],t=this._gltf.animations;if(t)for(const i of t)i._babylonAnimationGroup&&e.push(i._babylonAnimationGroup);return e}_startAnimations(){switch(this._parent.animationStartMode){case JS.NONE:break;case JS.FIRST:{const e=this._getAnimationGroups();0!==e.length&&e[0].start(!0);break}case JS.ALL:{const e=this._getAnimationGroups();for(const t of e)t.start(!0);break}default:return void k.Error(`Invalid animation start mode (${this._parent.animationStartMode})`)}}loadNodeAsync(e,t,i=()=>{}){const s=this._extensionsLoadNodeAsync(e,t,i);if(s)return s;if(t._babylonTransformNode)throw new Error(`${e}: Invalid recursive node hierarchy`);const r=new Array;this.logOpen(`${e} ${t.name||""}`);const n=s=>{if(Gb.AddPointerMetadata(s,e),Gb._LoadTransform(t,s),null!=t.camera){const i=kb.Get(`${e}/camera`,this._gltf.cameras,t.camera);r.push(this.loadCameraAsync(`/cameras/${i.index}`,i,(e=>{e.parent=s})))}if(t.children)for(const i of t.children){const t=kb.Get(`${e}/children/${i}`,this._gltf.nodes,i);r.push(this.loadNodeAsync(`/nodes/${t.index}`,t,(e=>{e.parent=s})))}i(s)};if(null==t.mesh||null!=t.skin){const e=t.name||`node${t.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const i=new ws(e,this._babylonScene);i._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,null==t.mesh?t._babylonTransformNode=i:t._babylonTransformNodeForSkin=i,n(i)}if(null!=t.mesh)if(null==t.skin){const i=kb.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);r.push(this._loadMeshAsync(`/meshes/${i.index}`,t,i,n))}else{const i=kb.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);r.push(this._loadMeshAsync(`/meshes/${i.index}`,t,i,(i=>{const s=t._babylonTransformNodeForSkin;i.metadata=Vb(s.metadata,i.metadata||{});const n=kb.Get(`${e}/skin`,this._gltf.skins,t.skin);r.push(this._loadSkinAsync(`/skins/${n.index}`,t,n,(e=>{this._forEachPrimitive(t,(t=>{t.skeleton=e})),this._postSceneLoadActions.push((()=>{if(null!=n.skeleton){const e=kb.Get(`/skins/${n.index}/skeleton`,this._gltf.nodes,n.skeleton).parent;t.index===e.index?i.parent=s.parent:i.parent=e._babylonTransformNode}else i.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:s,skinnedNode:i})}))})))})))}return this.logClose(),Promise.all(r).then((()=>(this._forEachPrimitive(t,(e=>{e.geometry&&e.geometry.useBoundingInfoFromGeometry?e._updateBoundingInfo():e.refreshBoundingInfo(!0)})),t._babylonTransformNode)))}_loadMeshAsync(e,t,i,s){const r=i.primitives;if(!r||!r.length)throw new Error(`${e}: Primitives are missing`);null==r[0].index&&kb.Assign(r);const n=new Array;this.logOpen(`${e} ${i.name||""}`);const o=t.name||`node${t.index}`;if(1===r.length){const s=i.primitives[0];n.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${s.index}`,o,t,i,s,(e=>{t._babylonTransformNode=e,t._primitiveBabylonMeshes=[e]})))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,t._babylonTransformNode=new ws(o,this._babylonScene),t._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._primitiveBabylonMeshes=[];for(const s of r)n.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${s.index}`,`${o}_primitive${s.index}`,t,i,s,(e=>{e.parent=t._babylonTransformNode,t._primitiveBabylonMeshes.push(e)})))}return s(t._babylonTransformNode),this.logClose(),Promise.all(n).then((()=>t._babylonTransformNode))}_loadMeshPrimitiveAsync(e,t,i,s,r,n){const o=this._extensionsLoadMeshPrimitiveAsync(e,t,i,s,r,n);if(o)return o;this.logOpen(`${e}`);const a=0===this._disableInstancedMesh&&this._parent.createInstances&&null==i.skin&&!s.primitives[0].targets;let l,h;if(a&&r._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,l=r._instanceData.babylonSourceMesh.createInstance(t),l._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,h=r._instanceData.promise;else{const n=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;const o=new ur(t,this._babylonScene);o._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,o.overrideMaterialSideOrientation=this._babylonScene.useRightHandedSystem?sr.CounterClockWiseSideOrientation:sr.ClockWiseSideOrientation,this._createMorphTargets(e,i,s,r,o),n.push(this._loadVertexDataAsync(e,r,o).then((t=>this._loadMorphTargetsAsync(e,r,o,t).then((()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,t.applyToMesh(o),t._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)})))));const c=Gb._GetDrawMode(e,r.mode);if(null==r.material){let e=this._defaultBabylonMaterialData[c];e||(e=this._createDefaultMaterial("__GLTFLoader._default",c),this._parent.onMaterialLoadedObservable.notifyObservers(e),this._defaultBabylonMaterialData[c]=e),o.material=e}else if(!this.parent.skipMaterials){const t=kb.Get(`${e}/material`,this._gltf.materials,r.material);n.push(this._loadMaterialAsync(`/materials/${t.index}`,t,o,c,(e=>{o.material=e})))}h=Promise.all(n),a&&(r._instanceData={babylonSourceMesh:o,promise:h}),l=o}return Gb.AddPointerMetadata(l,e),this._parent.onMeshLoadedObservable.notifyObservers(l),n(l),this.logClose(),h.then((()=>l))}_loadVertexDataAsync(e,t,i){const s=this._extensionsLoadVertexDataAsync(e,t,i);if(s)return s;const r=t.attributes;if(!r)throw new Error(`${e}: Attributes are missing`);const n=new Array,o=new Ps(i.name,this._babylonScene);if(null==t.indices)i.isUnIndexed=!0;else{const i=kb.Get(`${e}/indices`,this._gltf.accessors,t.indices);n.push(this._loadIndicesAccessorAsync(`/accessors/${i.index}`,i).then((e=>{o.setIndices(e)})))}const a=(t,s,a)=>{if(null==r[t])return;i._delayInfo=i._delayInfo||[],-1===i._delayInfo.indexOf(s)&&i._delayInfo.push(s);const l=kb.Get(`${e}/attributes/${t}`,this._gltf.accessors,r[t]);n.push(this._loadVertexAccessorAsync(`/accessors/${l.index}`,l,s).then((e=>{if(e.getKind()===hi.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!i.skeleton&&l.min&&l.max){const e=R.Vector3[0].copyFromFloats(...l.min),t=R.Vector3[1].copyFromFloats(...l.max);if(l.normalized&&5126!==l.componentType){let i=1;switch(l.componentType){case 5120:i=127;break;case 5121:i=255;break;case 5122:i=32767;break;case 5123:i=65535}const s=1/i;e.scaleInPlace(s),t.scaleInPlace(s)}o._boundingInfo=new Es(e,t),o.useBoundingInfoFromGeometry=!0}o.setVerticesBuffer(e,l.count)}))),s==hi.MatricesIndicesExtraKind&&(i.numBoneInfluencers=8),a&&a(l)};return a("POSITION",hi.PositionKind),a("NORMAL",hi.NormalKind),a("TANGENT",hi.TangentKind),a("TEXCOORD_0",hi.UVKind),a("TEXCOORD_1",hi.UV2Kind),a("TEXCOORD_2",hi.UV3Kind),a("TEXCOORD_3",hi.UV4Kind),a("TEXCOORD_4",hi.UV5Kind),a("TEXCOORD_5",hi.UV6Kind),a("JOINTS_0",hi.MatricesIndicesKind),a("WEIGHTS_0",hi.MatricesWeightsKind),a("JOINTS_1",hi.MatricesIndicesExtraKind),a("WEIGHTS_1",hi.MatricesWeightsExtraKind),a("COLOR_0",hi.ColorKind,(e=>{"VEC4"===e.type&&(i.hasVertexAlpha=!0)})),Promise.all(n).then((()=>o))}_createMorphTargets(e,t,i,s,r){if(!s.targets)return;if(null==t._numMorphTargets)t._numMorphTargets=s.targets.length;else if(s.targets.length!==t._numMorphTargets)throw new Error(`${e}: Primitives do not have the same number of targets`);const n=i.extras?i.extras.targetNames:null;this._babylonScene._blockEntityCollection=!!this._assetContainer,r.morphTargetManager=new Qp(this._babylonScene),r.morphTargetManager._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,r.morphTargetManager.areUpdatesFrozen=!0;for(let e=0;e<s.targets.length;e++){const s=t.weights?t.weights[e]:i.weights?i.weights[e]:0,o=n?n[e]:`morphTarget${e}`;r.morphTargetManager.addTarget(new $p(o,s,r.getScene()))}}_loadMorphTargetsAsync(e,t,i,s){if(!t.targets)return Promise.resolve();const r=new Array,n=i.morphTargetManager;for(let i=0;i<n.numTargets;i++){const o=n.getTarget(i);r.push(this._loadMorphTargetVertexDataAsync(`${e}/targets/${i}`,s,t.targets[i],o))}return Promise.all(r).then((()=>{n.areUpdatesFrozen=!1}))}_loadMorphTargetVertexDataAsync(e,t,i,s){const r=new Array,n=(s,n,o)=>{if(null==i[s])return;const a=t.getVertexBuffer(n);if(!a)return;const l=kb.Get(`${e}/${s}`,this._gltf.accessors,i[s]);r.push(this._loadFloatAccessorAsync(`/accessors/${l.index}`,l).then((e=>{o(a,e)})))};return n("POSITION",hi.PositionKind,((e,t)=>{const i=new Float32Array(t.length);e.forEach(t.length,((e,s)=>{i[s]=t[s]+e})),s.setPositions(i)})),n("NORMAL",hi.NormalKind,((e,t)=>{const i=new Float32Array(t.length);e.forEach(i.length,((e,s)=>{i[s]=t[s]+e})),s.setNormals(i)})),n("TANGENT",hi.TangentKind,((e,t)=>{const i=new Float32Array(t.length/3*4);let r=0;e.forEach(t.length/3*4,((e,s)=>{(s+1)%4!=0&&(i[r]=t[r]+e,r++)})),s.setTangents(i)})),Promise.all(r).then((()=>{}))}static _LoadTransform(e,t){if(null!=e.skin)return;let i=S.Zero(),s=C.Identity(),r=S.One();e.matrix?y.FromArray(e.matrix).decompose(r,s,i):(e.translation&&(i=S.FromArray(e.translation)),e.rotation&&(s=C.FromArray(e.rotation)),e.scale&&(r=S.FromArray(e.scale))),t.position=i,t.rotationQuaternion=s,t.scaling=r}_loadSkinAsync(e,t,i,s){const r=this._extensionsLoadSkinAsync(e,t,i);if(r)return r;if(i._data)return s(i._data.babylonSkeleton),i._data.promise;const n=`skeleton${i.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const o=new no(i.name||n,n,this._babylonScene);o._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(e,i,o);const a=this._loadSkinInverseBindMatricesDataAsync(e,i).then((e=>{this._updateBoneMatrices(o,e)}));return i._data={babylonSkeleton:o,promise:a},s(o),a}_loadBones(e,t,i){if(null==t.skeleton||this._parent.alwaysComputeSkeletonRootNode){const i=this._findSkeletonRootNode(`${e}/joints`,t.joints);if(i)if(void 0===t.skeleton)t.skeleton=i.index;else{const s=(e,t)=>{for(;t.parent;t=t.parent)if(t.parent===e)return!0;return!1},r=kb.Get(`${e}/skeleton`,this._gltf.nodes,t.skeleton);r===i||s(r,i)||(k.Warn(`${e}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),t.skeleton=i.index)}else k.Warn(`${e}: Failed to find common root`)}const s={};for(const r of t.joints){const n=kb.Get(`${e}/joints/${r}`,this._gltf.nodes,r);this._loadBone(n,t,i,s)}}_findSkeletonRootNode(e,t){if(0===t.length)return null;const i={};for(const s of t){const t=[];let r=kb.Get(`${e}/${s}`,this._gltf.nodes,s);for(;-1!==r.index;)t.unshift(r),r=r.parent;i[s]=t}let s=null;for(let e=0;;++e){let r=i[t[0]];if(e>=r.length)return s;const n=r[e];for(let o=1;o<t.length;++o)if(r=i[t[o]],e>=r.length||n!==r[e])return s;s=n}}_loadBone(e,t,i,s){let r=s[e.index];if(r)return r;let n=null;e.index!==t.skeleton&&(e.parent&&-1!==e.parent.index?n=this._loadBone(e.parent,t,i,s):void 0!==t.skeleton&&k.Warn(`/skins/${t.index}/skeleton: Skeleton node is not a common root`));const o=t.joints.indexOf(e.index);return r=new Ki(e.name||`joint${e.index}`,i,n,this._getNodeMatrix(e),null,null,o),s[e.index]=r,this._postSceneLoadActions.push((()=>{r.linkTransformNode(e._babylonTransformNode)})),r}_loadSkinInverseBindMatricesDataAsync(e,t){if(null==t.inverseBindMatrices)return Promise.resolve(null);const i=kb.Get(`${e}/inverseBindMatrices`,this._gltf.accessors,t.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${i.index}`,i)}_updateBoneMatrices(e,t){for(const i of e.bones){const e=y.Identity(),s=i._index;t&&-1!==s&&(y.FromArrayToRef(t,16*s,e),e.invertToRef(e));const r=i.getParent();r&&e.multiplyToRef(r.getAbsoluteInverseBindMatrix(),e),i.updateMatrix(e,!1,!1),i._updateAbsoluteBindMatrices(void 0,!1)}}_getNodeMatrix(e){return e.matrix?y.FromArray(e.matrix):y.Compose(e.scale?S.FromArray(e.scale):S.One(),e.rotation?C.FromArray(e.rotation):C.Identity(),e.translation?S.FromArray(e.translation):S.Zero())}loadCameraAsync(e,t,i=()=>{}){const s=this._extensionsLoadCameraAsync(e,t,i);if(s)return s;const r=new Array;this.logOpen(`${e} ${t.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;const n=new zo(t.name||`camera${t.index}`,S.Zero(),this._babylonScene,!1);switch(n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n.ignoreParentScaling=!0,t._babylonCamera=n,n.rotation.set(0,Math.PI,0),t.type){case"perspective":{const i=t.perspective;if(!i)throw new Error(`${e}: Camera perspective properties are missing`);n.fov=i.yfov,n.minZ=i.znear,n.maxZ=i.zfar||0;break}case"orthographic":if(!t.orthographic)throw new Error(`${e}: Camera orthographic properties are missing`);n.mode=ps.ORTHOGRAPHIC_CAMERA,n.orthoLeft=-t.orthographic.xmag,n.orthoRight=t.orthographic.xmag,n.orthoBottom=-t.orthographic.ymag,n.orthoTop=t.orthographic.ymag,n.minZ=t.orthographic.znear,n.maxZ=t.orthographic.zfar;break;default:throw new Error(`${e}: Invalid camera type (${t.type})`)}return Gb.AddPointerMetadata(n,e),this._parent.onCameraLoadedObservable.notifyObservers(n),i(n),this.logClose(),Promise.all(r).then((()=>n))}_loadAnimationsAsync(){const e=this._gltf.animations;if(!e)return Promise.resolve();const t=new Array;for(let i=0;i<e.length;i++){const s=e[i];t.push(this.loadAnimationAsync(`/animations/${s.index}`,s).then((e=>{0===e.targetedAnimations.length&&e.dispose()})))}return Promise.all(t).then((()=>{}))}loadAnimationAsync(e,t){const i=this._extensionsLoadAnimationAsync(e,t);if(i)return i;this._babylonScene._blockEntityCollection=!!this._assetContainer;const s=new as(t.name||`animation${t.index}`,this._babylonScene);s._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._babylonAnimationGroup=s;const r=new Array;kb.Assign(t.channels),kb.Assign(t.samplers);for(const i of t.channels)r.push(this._loadAnimationChannelAsync(`${e}/channels/${i.index}`,e,t,i,((e,t)=>{e.animations=e.animations||[],e.animations.push(t),s.addTargetedAnimation(t,e)})));return Promise.all(r).then((()=>(s.normalize(0),s)))}_loadAnimationChannelAsync(e,t,i,s,r){const n=this._extensionsLoadAnimationChannelAsync(e,t,i,s,r);if(n)return n;if(null==s.target.node)return Promise.resolve();const o=kb.Get(`${e}/target/node`,this._gltf.nodes,s.target.node);if("weights"===s.target.path&&!o._numMorphTargets||"weights"!==s.target.path&&!o._babylonTransformNode)return Promise.resolve();let a;switch(s.target.path){case"translation":a=Ub.translation;break;case"rotation":a=Ub.rotation;break;case"scale":a=Ub.scale;break;case"weights":a=Ub.weights;break;default:throw new Error(`${e}/target/path: Invalid value (${s.target.path})`)}const l={target:o,properties:a};return this._loadAnimationChannelFromTargetInfoAsync(e,t,i,s,l,r)}_loadAnimationChannelFromTargetInfoAsync(e,t,i,s,r,n){const o=this.parent.targetFps,a=1/o,l=kb.Get(`${e}/sampler`,i.samplers,s.sampler);return this._loadAnimationSamplerAsync(`${t}/samplers/${s.sampler}`,l).then((e=>{let t=0;for(const l of r.properties){const h=l.getStride(r.target),c=e.input,u=e.output,d=new Array(c.length);let p=0;switch(e.interpolation){case"STEP":for(let e=0;e<c.length;e++){const t=l.getValue(r.target,u,p,1);p+=h,d[e]={frame:c[e]*o,value:t,interpolation:_e.STEP}}break;case"CUBICSPLINE":for(let e=0;e<c.length;e++){const t=l.getValue(r.target,u,p,a);p+=h;const i=l.getValue(r.target,u,p,1);p+=h;const s=l.getValue(r.target,u,p,a);p+=h,d[e]={frame:c[e]*o,inTangent:t,value:i,outTangent:s}}break;case"LINEAR":for(let e=0;e<c.length;e++){const t=l.getValue(r.target,u,p,1);p+=h,d[e]={frame:c[e]*o,value:t}}}if(p>0){const e=`${i.name||`animation${i.index}`}_channel${s.index}_${t}`;l.buildAnimations(r.target,e,o,d,((e,i)=>{++t,n(e,i)}))}}}))}_loadAnimationSamplerAsync(e,t){if(t._data)return t._data;const i=t.interpolation||"LINEAR";switch(i){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(`${e}/interpolation: Invalid value (${t.interpolation})`)}const s=kb.Get(`${e}/input`,this._gltf.accessors,t.input),r=kb.Get(`${e}/output`,this._gltf.accessors,t.output);return t._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${s.index}`,s),this._loadFloatAccessorAsync(`/accessors/${r.index}`,r)]).then((([e,t])=>({input:e,interpolation:i,output:t}))),t._data}loadBufferAsync(e,t,i,s){const r=this._extensionsLoadBufferAsync(e,t,i,s);if(r)return r;if(!t._data)if(t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{if(!this._bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);t._data=this._bin.readAsync(0,t.byteLength)}return t._data.then((t=>{try{return new Uint8Array(t.buffer,t.byteOffset+i,s)}catch(t){throw new Error(`${e}: ${t.message}`)}}))}loadBufferViewAsync(e,t){const i=this._extensionsLoadBufferViewAsync(e,t);if(i)return i;if(t._data)return t._data;const s=kb.Get(`${e}/buffer`,this._gltf.buffers,t.buffer);return t._data=this.loadBufferAsync(`/buffers/${s.index}`,s,t.byteOffset||0,t.byteLength),t._data}_loadAccessorAsync(e,t,i){if(t._data)return t._data;const s=Gb._GetNumComponents(e,t.type),r=s*hi.GetTypeByteLength(t.componentType),n=s*t.count;if(null==t.bufferView)t._data=Promise.resolve(new i(n));else{const o=kb.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${o.index}`,o).then((a=>{if(5126!==t.componentType||t.normalized||o.byteStride&&o.byteStride!==r){const e=new i(n);return hi.ForEach(a,t.byteOffset||0,o.byteStride||r,s,t.componentType,e.length,t.normalized||!1,((t,i)=>{e[i]=t})),e}return Gb._GetTypedArray(e,t.componentType,a,t.byteOffset,n)}))}if(t.sparse){const n=t.sparse;t._data=t._data.then((o=>{const a=o,l=kb.Get(`${e}/sparse/indices/bufferView`,this._gltf.bufferViews,n.indices.bufferView),h=kb.Get(`${e}/sparse/values/bufferView`,this._gltf.bufferViews,n.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${l.index}`,l),this.loadBufferViewAsync(`/bufferViews/${h.index}`,h)]).then((([o,l])=>{const h=Gb._GetTypedArray(`${e}/sparse/indices`,n.indices.componentType,o,n.indices.byteOffset,n.count),c=s*n.count;let u;if(5126!==t.componentType||t.normalized){const o=Gb._GetTypedArray(`${e}/sparse/values`,t.componentType,l,n.values.byteOffset,c);u=new i(c),hi.ForEach(o,0,r,s,t.componentType,u.length,t.normalized||!1,((e,t)=>{u[t]=e}))}else u=Gb._GetTypedArray(`${e}/sparse/values`,t.componentType,l,n.values.byteOffset,c);let d=0;for(let e=0;e<h.length;e++){let t=h[e]*s;for(let e=0;e<s;e++)a[t++]=u[d++]}return a}))}))}return t._data}_loadFloatAccessorAsync(e,t){return this._loadAccessorAsync(e,t,Float32Array)}_loadIndicesAccessorAsync(e,t){if("SCALAR"!==t.type)throw new Error(`${e}/type: Invalid value ${t.type}`);if(5121!==t.componentType&&5123!==t.componentType&&5125!==t.componentType)throw new Error(`${e}/componentType: Invalid value ${t.componentType}`);if(t._data)return t._data;if(t.sparse){const i=Gb._GetTypedArrayConstructor(`${e}/componentType`,t.componentType);t._data=this._loadAccessorAsync(e,t,i)}else{const i=kb.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${i.index}`,i).then((i=>Gb._GetTypedArray(e,t.componentType,i,t.byteOffset,t.count)))}return t._data}_loadVertexBufferViewAsync(e){if(e._babylonBuffer)return e._babylonBuffer;const t=this._babylonScene.getEngine();return e._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${e.index}`,e).then((e=>new li(t,e,!1))),e._babylonBuffer}_loadVertexAccessorAsync(e,t,i){var s;if(null===(s=t._babylonVertexBuffer)||void 0===s?void 0:s[i])return t._babylonVertexBuffer[i];t._babylonVertexBuffer||(t._babylonVertexBuffer={});const r=this._babylonScene.getEngine();if(t.sparse||null==t.bufferView)t._babylonVertexBuffer[i]=this._loadFloatAccessorAsync(e,t).then((e=>new hi(r,e,i,!1)));else{const s=kb.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._babylonVertexBuffer[i]=this._loadVertexBufferViewAsync(s).then((n=>{const o=Gb._GetNumComponents(e,t.type);return new hi(r,n,i,!1,void 0,s.byteStride,void 0,t.byteOffset,o,t.componentType,t.normalized,!0,void 0,!0)}))}return t._babylonVertexBuffer[i]}_loadMaterialMetallicRoughnessPropertiesAsync(e,t,i){if(!(i instanceof Fd))throw new Error(`${e}: Material type not supported`);const s=new Array;return t&&(t.baseColorFactor?(i.albedoColor=N.FromArray(t.baseColorFactor),i.alpha=t.baseColorFactor[3]):i.albedoColor=N.White(),i.metallic=null==t.metallicFactor?1:t.metallicFactor,i.roughness=null==t.roughnessFactor?1:t.roughnessFactor,t.baseColorTexture&&s.push(this.loadTextureInfoAsync(`${e}/baseColorTexture`,t.baseColorTexture,(e=>{e.name=`${i.name} (Base Color)`,i.albedoTexture=e}))),t.metallicRoughnessTexture&&(t.metallicRoughnessTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(`${e}/metallicRoughnessTexture`,t.metallicRoughnessTexture,(e=>{e.name=`${i.name} (Metallic Roughness)`,i.metallicTexture=e}))),i.useMetallnessFromMetallicTextureBlue=!0,i.useRoughnessFromMetallicTextureGreen=!0,i.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(s).then((()=>{}))}_loadMaterialAsync(e,t,i,s,r=()=>{}){const n=this._extensionsLoadMaterialAsync(e,t,i,s,r);if(n)return n;t._data=t._data||{};let o=t._data[s];if(!o){this.logOpen(`${e} ${t.name||""}`);const i=this.createMaterial(e,t,s);o={babylonMaterial:i,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,t,i)},t._data[s]=o,Gb.AddPointerMetadata(i,e),this._parent.onMaterialLoadedObservable.notifyObservers(i),this.logClose()}return i&&(o.babylonMeshes.push(i),i.onDisposeObservable.addOnce((()=>{const e=o.babylonMeshes.indexOf(i);-1!==e&&o.babylonMeshes.splice(e,1)}))),r(o.babylonMaterial),o.promise.then((()=>o.babylonMaterial))}_createDefaultMaterial(e,t){this._babylonScene._blockEntityCollection=!!this._assetContainer;const i=new Fd(e,this._babylonScene);return i._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i.fillMode=t,i.enableSpecularAntiAliasing=!0,i.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,i.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,i.transparencyMode=Fd.PBRMATERIAL_OPAQUE,i.metallic=1,i.roughness=1,i}createMaterial(e,t,i){const s=this._extensionsCreateMaterial(e,t,i);if(s)return s;const r=t.name||`material${t.index}`;return this._createDefaultMaterial(r,i)}loadMaterialPropertiesAsync(e,t,i){const s=this._extensionsLoadMaterialPropertiesAsync(e,t,i);if(s)return s;const r=new Array;return r.push(this.loadMaterialBasePropertiesAsync(e,t,i)),t.pbrMetallicRoughness&&r.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${e}/pbrMetallicRoughness`,t.pbrMetallicRoughness,i)),this.loadMaterialAlphaProperties(e,t,i),Promise.all(r).then((()=>{}))}loadMaterialBasePropertiesAsync(e,t,i){if(!(i instanceof Fd))throw new Error(`${e}: Material type not supported`);const s=new Array;return i.emissiveColor=t.emissiveFactor?N.FromArray(t.emissiveFactor):new N(0,0,0),t.doubleSided&&(i.backFaceCulling=!1,i.twoSidedLighting=!0),t.normalTexture&&(t.normalTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(`${e}/normalTexture`,t.normalTexture,(e=>{e.name=`${i.name} (Normal)`,i.bumpTexture=e}))),i.invertNormalMapX=!this._babylonScene.useRightHandedSystem,i.invertNormalMapY=this._babylonScene.useRightHandedSystem,null!=t.normalTexture.scale&&i.bumpTexture&&(i.bumpTexture.level=t.normalTexture.scale),i.forceIrradianceInFragment=!0),t.occlusionTexture&&(t.occlusionTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(`${e}/occlusionTexture`,t.occlusionTexture,(e=>{e.name=`${i.name} (Occlusion)`,i.ambientTexture=e}))),i.useAmbientInGrayScale=!0,null!=t.occlusionTexture.strength&&(i.ambientTextureStrength=t.occlusionTexture.strength)),t.emissiveTexture&&s.push(this.loadTextureInfoAsync(`${e}/emissiveTexture`,t.emissiveTexture,(e=>{e.name=`${i.name} (Emissive)`,i.emissiveTexture=e}))),Promise.all(s).then((()=>{}))}loadMaterialAlphaProperties(e,t,i){if(!(i instanceof Fd))throw new Error(`${e}: Material type not supported`);switch(t.alphaMode||"OPAQUE"){case"OPAQUE":i.transparencyMode=Fd.PBRMATERIAL_OPAQUE;break;case"MASK":i.transparencyMode=Fd.PBRMATERIAL_ALPHATEST,i.alphaCutOff=null==t.alphaCutoff?.5:t.alphaCutoff,i.albedoTexture&&(i.albedoTexture.hasAlpha=!0);break;case"BLEND":i.transparencyMode=Fd.PBRMATERIAL_ALPHABLEND,i.albedoTexture&&(i.albedoTexture.hasAlpha=!0,i.useAlphaFromAlbedoTexture=!0);break;default:throw new Error(`${e}/alphaMode: Invalid value (${t.alphaMode})`)}}loadTextureInfoAsync(e,t,i=()=>{}){const s=this._extensionsLoadTextureInfoAsync(e,t,i);if(s)return s;if(this.logOpen(`${e}`),t.texCoord>=6)throw new Error(`${e}/texCoord: Invalid value (${t.texCoord})`);const r=kb.Get(`${e}/index`,this._gltf.textures,t.index);r._textureInfo=t;const n=this._loadTextureAsync(`/textures/${t.index}`,r,(s=>{s.coordinatesIndex=t.texCoord||0,Gb.AddPointerMetadata(s,e),this._parent.onTextureLoadedObservable.notifyObservers(s),i(s)}));return this.logClose(),n}_loadTextureAsync(e,t,i=()=>{}){const s=this._extensionsLoadTextureAsync(e,t,i);if(s)return s;this.logOpen(`${e} ${t.name||""}`);const r=null==t.sampler?Gb.DefaultSampler:kb.Get(`${e}/sampler`,this._gltf.samplers,t.sampler),n=kb.Get(`${e}/source`,this._gltf.images,t.source),o=this._createTextureAsync(e,r,n,i,void 0,!t._textureInfo.nonColorData);return this.logClose(),o}_createTextureAsync(e,t,i,s=()=>{},r,n){const o=this._loadSampler(`/samplers/${t.index}`,t),a=new Array,l=new cx;this._babylonScene._blockEntityCollection=!!this._assetContainer;const h={noMipmap:o.noMipMaps,invertY:!1,samplingMode:o.samplingMode,onLoad:()=>{this._disposed||l.resolve()},onError:(t,i)=>{this._disposed||l.reject(new Error(`${e}: ${i&&i.message?i.message:t||"Failed to load texture"}`))},mimeType:i.mimeType,loaderOptions:r,useSRGBBuffer:!!n&&this._parent.useSRGBBuffers},c=new Ar(null,this._babylonScene,h);return c._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,a.push(l.promise),a.push(this.loadImageAsync(`/images/${i.index}`,i).then((e=>{const t=i.uri||`${this._fileName}#image${i.index}`,s=`data:${this._uniqueRootUrl}${t}`;c.updateURL(s,e)}))),c.wrapU=o.wrapU,c.wrapV=o.wrapV,s(c),Promise.all(a).then((()=>c))}_loadSampler(e,t){return t._data||(t._data={noMipMaps:9728===t.minFilter||9729===t.minFilter,samplingMode:Gb._GetTextureSamplingMode(e,t),wrapU:Gb._GetTextureWrapMode(`${e}/wrapS`,t.wrapS),wrapV:Gb._GetTextureWrapMode(`${e}/wrapT`,t.wrapT)}),t._data}loadImageAsync(e,t){if(!t._data){if(this.logOpen(`${e} ${t.name||""}`),t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{const i=kb.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${i.index}`,i)}this.logClose()}return t._data}loadUriAsync(e,t,i){const s=this._extensionsLoadUriAsync(e,t,i);if(s)return s;if(!Gb._ValidateUri(i))throw new Error(`${e}: '${i}' is invalid`);if(Bt(i)){const t=new Uint8Array(Vt(i));return this.log(`${e}: Decoded ${i.substr(0,64)}... (${t.length} bytes)`),Promise.resolve(t)}return this.log(`${e}: Loading ${i}`),this._parent.preprocessUrlAsync(this._rootUrl+i).then((t=>new Promise(((s,r)=>{this._parent._loadFile(this._babylonScene,t,(t=>{this._disposed||(this.log(`${e}: Loaded ${i} (${t.byteLength} bytes)`),s(new Uint8Array(t)))}),!0,(t=>{r(new At(`${e}: Failed to load '${i}'${t?": "+t.status+" "+t.statusText:""}`,t))}))}))))}static AddPointerMetadata(e,t){e.metadata=e.metadata||{};const i=e._internalMetadata=e._internalMetadata||{},s=i.gltf=i.gltf||{};(s.pointers=s.pointers||[]).push(t)}static _GetTextureWrapMode(e,t){switch(t=null==t?10497:t){case 33071:return Ar.CLAMP_ADDRESSMODE;case 33648:return Ar.MIRROR_ADDRESSMODE;case 10497:return Ar.WRAP_ADDRESSMODE;default:return k.Warn(`${e}: Invalid value (${t})`),Ar.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(e,t){const i=null==t.magFilter?9729:t.magFilter,s=null==t.minFilter?9987:t.minFilter;if(9729===i)switch(s){case 9728:return Ar.LINEAR_NEAREST;case 9729:return Ar.LINEAR_LINEAR;case 9984:return Ar.LINEAR_NEAREST_MIPNEAREST;case 9985:return Ar.LINEAR_LINEAR_MIPNEAREST;case 9986:return Ar.LINEAR_NEAREST_MIPLINEAR;case 9987:return Ar.LINEAR_LINEAR_MIPLINEAR;default:return k.Warn(`${e}/minFilter: Invalid value (${s})`),Ar.LINEAR_LINEAR_MIPLINEAR}else switch(9728!==i&&k.Warn(`${e}/magFilter: Invalid value (${i})`),s){case 9728:return Ar.NEAREST_NEAREST;case 9729:return Ar.NEAREST_LINEAR;case 9984:return Ar.NEAREST_NEAREST_MIPNEAREST;case 9985:return Ar.NEAREST_LINEAR_MIPNEAREST;case 9986:return Ar.NEAREST_NEAREST_MIPLINEAR;case 9987:return Ar.NEAREST_LINEAR_MIPLINEAR;default:return k.Warn(`${e}/minFilter: Invalid value (${s})`),Ar.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(e,t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error(`${e}: Invalid component type ${t}`)}}static _GetTypedArray(e,t,i,s,r){const n=i.buffer;s=i.byteOffset+(s||0);const o=Gb._GetTypedArrayConstructor(`${e}/componentType`,t),a=hi.GetTypeByteLength(t);return s%a!=0?(k.Warn(`${e}: Copying buffer as byte offset (${s}) is not a multiple of component type byte length (${a})`),new o(n.slice(s,s+r*a),0)):new o(n,s,r)}static _GetNumComponents(e,t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(`${e}: Invalid type (${t})`)}static _ValidateUri(e){return Ht.IsBase64(e)||-1===e.indexOf("..")}static _GetDrawMode(e,t){switch(null==t&&(t=4),t){case 0:return sr.PointListDrawMode;case 1:return sr.LineListDrawMode;case 2:return sr.LineLoopDrawMode;case 3:return sr.LineStripDrawMode;case 4:return sr.TriangleFillMode;case 5:return sr.TriangleStripDrawMode;case 6:return sr.TriangleFanDrawMode}throw new Error(`${e}: Invalid mesh primitive mode (${t})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");const e=new Array;if(this._gltf.materials)for(const t of this._gltf.materials)if(t._data)for(const i in t._data){const s=t._data[i];for(const t of s.babylonMeshes){t.computeWorldMatrix(!0);const i=s.babylonMaterial;e.push(i.forceCompilationAsync(t)),e.push(i.forceCompilationAsync(t,{useInstances:!0})),this._parent.useClipPlane&&(e.push(i.forceCompilationAsync(t,{clipPlane:!0})),e.push(i.forceCompilationAsync(t,{clipPlane:!0,useInstances:!0})))}}return Promise.all(e).then((()=>{this._parent._endPerformanceCounter("Compile materials")}))}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");const e=new Array,t=this._babylonScene.lights;for(const i of t){const t=i.getShadowGenerator();t&&e.push(t.forceCompilationAsync())}return Promise.all(e).then((()=>{this._parent._endPerformanceCounter("Compile shadow generators")}))}_forEachExtensions(e){for(const t of this._extensions)t.enabled&&e(t)}_applyExtensions(e,t,i){for(const s of this._extensions)if(s.enabled){const r=`${s.name}.${t}`,n=e;n._activeLoaderExtensionFunctions=n._activeLoaderExtensionFunctions||{};const o=n._activeLoaderExtensionFunctions;if(!o[r]){o[r]=!0;try{const e=i(s);if(e)return e}finally{delete o[r]}}}return null}_extensionsOnLoading(){this._forEachExtensions((e=>e.onLoading&&e.onLoading()))}_extensionsOnReady(){this._forEachExtensions((e=>e.onReady&&e.onReady()))}_extensionsLoadSceneAsync(e,t){return this._applyExtensions(t,"loadScene",(i=>i.loadSceneAsync&&i.loadSceneAsync(e,t)))}_extensionsLoadNodeAsync(e,t,i){return this._applyExtensions(t,"loadNode",(s=>s.loadNodeAsync&&s.loadNodeAsync(e,t,i)))}_extensionsLoadCameraAsync(e,t,i){return this._applyExtensions(t,"loadCamera",(s=>s.loadCameraAsync&&s.loadCameraAsync(e,t,i)))}_extensionsLoadVertexDataAsync(e,t,i){return this._applyExtensions(t,"loadVertexData",(s=>s._loadVertexDataAsync&&s._loadVertexDataAsync(e,t,i)))}_extensionsLoadMeshPrimitiveAsync(e,t,i,s,r,n){return this._applyExtensions(r,"loadMeshPrimitive",(o=>o._loadMeshPrimitiveAsync&&o._loadMeshPrimitiveAsync(e,t,i,s,r,n)))}_extensionsLoadMaterialAsync(e,t,i,s,r){return this._applyExtensions(t,"loadMaterial",(n=>n._loadMaterialAsync&&n._loadMaterialAsync(e,t,i,s,r)))}_extensionsCreateMaterial(e,t,i){return this._applyExtensions(t,"createMaterial",(s=>s.createMaterial&&s.createMaterial(e,t,i)))}_extensionsLoadMaterialPropertiesAsync(e,t,i){return this._applyExtensions(t,"loadMaterialProperties",(s=>s.loadMaterialPropertiesAsync&&s.loadMaterialPropertiesAsync(e,t,i)))}_extensionsLoadTextureInfoAsync(e,t,i){return this._applyExtensions(t,"loadTextureInfo",(s=>s.loadTextureInfoAsync&&s.loadTextureInfoAsync(e,t,i)))}_extensionsLoadTextureAsync(e,t,i){return this._applyExtensions(t,"loadTexture",(s=>s._loadTextureAsync&&s._loadTextureAsync(e,t,i)))}_extensionsLoadAnimationAsync(e,t){return this._applyExtensions(t,"loadAnimation",(i=>i.loadAnimationAsync&&i.loadAnimationAsync(e,t)))}_extensionsLoadAnimationChannelAsync(e,t,i,s,r){return this._applyExtensions(i,"loadAnimationChannel",(n=>n._loadAnimationChannelAsync&&n._loadAnimationChannelAsync(e,t,i,s,r)))}_extensionsLoadSkinAsync(e,t,i){return this._applyExtensions(i,"loadSkin",(s=>s._loadSkinAsync&&s._loadSkinAsync(e,t,i)))}_extensionsLoadUriAsync(e,t,i){return this._applyExtensions(t,"loadUri",(s=>s._loadUriAsync&&s._loadUriAsync(e,t,i)))}_extensionsLoadBufferViewAsync(e,t){return this._applyExtensions(t,"loadBufferView",(i=>i.loadBufferViewAsync&&i.loadBufferViewAsync(e,t)))}_extensionsLoadBufferAsync(e,t,i,s){return this._applyExtensions(t,"loadBuffer",(r=>r.loadBufferAsync&&r.loadBufferAsync(e,t,i,s)))}static LoadExtensionAsync(e,t,i,s){if(!t.extensions)return null;const r=t.extensions[i];return r?s(`${e}/extensions/${i}`,r):null}static LoadExtraAsync(e,t,i,s){if(!t.extras)return null;const r=t.extras[i];return r?s(`${e}/extras/${i}`,r):null}isExtensionUsed(e){return!!this._gltf.extensionsUsed&&-1!==this._gltf.extensionsUsed.indexOf(e)}logOpen(e){this._parent._logOpen(e)}logClose(){this._parent._logClose()}log(e){this._parent._log(e)}startPerformanceCounter(e){this._parent._startPerformanceCounter(e)}endPerformanceCounter(e){this._parent._endPerformanceCounter(e)}}Gb._RegisteredExtensions={},Gb.DefaultSampler={index:-1},cb._CreateGLTF2Loader=e=>new Gb(e);const zb="EXT_lights_image_based";class Wb{constructor(e){this.name=zb,this._loader=e,this.enabled=this._loader.isExtensionUsed(zb)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights}}loadSceneAsync(e,t){return Gb.LoadExtensionAsync(e,t,this.name,((i,s)=>{this._loader._allMaterialsDirtyRequired=!0;const r=new Array;r.push(this._loader.loadSceneAsync(e,t)),this._loader.logOpen(`${i}`);const n=kb.Get(`${i}/light`,this._lights,s.light);return r.push(this._loadLightAsync(`/extensions/${this.name}/lights/${s.light}`,n).then((e=>{this._loader.babylonScene.environmentTexture=e}))),this._loader.logClose(),Promise.all(r).then((()=>{}))}))}_loadLightAsync(e,t){if(!t._loaded){const i=new Array;this._loader.logOpen(`${e}`);const s=new Array(t.specularImages.length);for(let r=0;r<t.specularImages.length;r++){const n=t.specularImages[r];s[r]=new Array(n.length);for(let t=0;t<n.length;t++){const o=`${e}/specularImages/${r}/${t}`;this._loader.logOpen(`${o}`);const a=n[t],l=kb.Get(o,this._loader.gltf.images,a);i.push(this._loader.loadImageAsync(`/images/${a}`,l).then((e=>{s[r][t]=e}))),this._loader.logClose()}}this._loader.logClose(),t._loaded=Promise.all(i).then((()=>{const i=new U_(this._loader.babylonScene,null,t.specularImageSize);if(i.name=t.name||"environment",t._babylonTexture=i,null!=t.intensity&&(i.level=t.intensity),t.rotation){let e=C.FromArray(t.rotation);this._loader.babylonScene.useRightHandedSystem||(e=C.Inverse(e)),y.FromQuaternionToRef(e,i.getReflectionTextureMatrix())}if(!t.irradianceCoefficients)throw new Error(`${e}: Irradiance coefficients are missing`);const r=Ch.FromArray(t.irradianceCoefficients);r.scaleInPlace(t.intensity),r.convertIrradianceToLambertianRadiance();const n=yh.FromHarmonics(r),o=(s.length-1)/l.Log2(t.specularImageSize);return i.updateRGBDAsync(s,n,o)}))}return t._loaded.then((()=>t._babylonTexture))}}Gb.RegisterExtension(zb,(e=>new Wb(e)));const Hb="EXT_mesh_gpu_instancing";class Xb{constructor(e){this.name=Hb,this._loader=e,this.enabled=this._loader.isExtensionUsed(Hb)}dispose(){this._loader=null}loadNodeAsync(e,t,i){return Gb.LoadExtensionAsync(e,t,this.name,((e,s)=>{this._loader._disableInstancedMesh++;const r=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,i);if(this._loader._disableInstancedMesh--,!t._primitiveBabylonMeshes)return r;const n=new Array;let o=0;const a=t=>{if(null==s.attributes[t])return void n.push(Promise.resolve(null));const i=kb.Get(`${e}/attributes/${t}`,this._loader.gltf.accessors,s.attributes[t]);if(n.push(this._loader._loadFloatAccessorAsync(`/accessors/${i.bufferView}`,i)),0===o)o=i.count;else if(o!==i.count)throw new Error(`${e}/attributes: Instance buffer accessors do not have the same count.`)};return a("TRANSLATION"),a("ROTATION"),a("SCALE"),r.then((e=>Promise.all(n).then((([i,s,r])=>{const n=new Float32Array(16*o);R.Vector3[0].copyFromFloats(0,0,0),R.Quaternion[0].copyFromFloats(0,0,0,1),R.Vector3[1].copyFromFloats(1,1,1);for(let e=0;e<o;++e)i&&S.FromArrayToRef(i,3*e,R.Vector3[0]),s&&C.FromArrayToRef(s,4*e,R.Quaternion[0]),r&&S.FromArrayToRef(r,3*e,R.Vector3[1]),y.ComposeToRef(R.Vector3[1],R.Quaternion[0],R.Vector3[0],R.Matrix[0]),R.Matrix[0].copyToArray(n,16*e);for(const e of t._primitiveBabylonMeshes)e.thinInstanceSetBuffer("matrix",n,16,!0);return e}))))}))}}Gb.RegisterExtension(Hb,(e=>new Xb(e)));const Yb="EXT_meshopt_compression";class jb{constructor(e){this.name=Yb,this.enabled=e.isExtensionUsed(Yb),this._loader=e}dispose(){this._loader=null}loadBufferViewAsync(e,t){return Gb.LoadExtensionAsync(e,t,this.name,((i,s)=>{const r=t;if(r._meshOptData)return r._meshOptData;const n=kb.Get(`${e}/buffer`,this._loader.gltf.buffers,s.buffer);return r._meshOptData=this._loader.loadBufferAsync(`/buffers/${n.index}`,n,s.byteOffset||0,s.byteLength).then((e=>Lf.Default.decodeGltfBufferAsync(e,s.count,s.byteStride,s.mode,s.filter))),r._meshOptData}))}}Gb.RegisterExtension(Yb,(e=>new jb(e)));const Kb="EXT_texture_webp";class $b{constructor(e){this.name=Kb,this._loader=e,this.enabled=e.isExtensionUsed(Kb)}dispose(){this._loader=null}_loadTextureAsync(e,t,i){return Gb.LoadExtensionAsync(e,t,this.name,((s,r)=>{const n=null==t.sampler?Gb.DefaultSampler:kb.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),o=kb.Get(`${s}/source`,this._loader.gltf.images,r.source);return this._loader._createTextureAsync(e,n,o,(e=>{i(e)}),void 0,!t._textureInfo.nonColorData)}))}}Gb.RegisterExtension(Kb,(e=>new $b(e)));const qb="KHR_draco_mesh_compression";class Qb{constructor(e){this.name=qb,this.useNormalizedFlagFromAccessor=!0,this._loader=e,this.enabled=wf.DecoderAvailable&&this._loader.isExtensionUsed(qb)}dispose(){delete this.dracoCompression,this._loader=null}_loadVertexDataAsync(e,t,i){return Gb.LoadExtensionAsync(e,t,this.name,((s,r)=>{if(null!=t.mode){if(5!==t.mode&&4!==t.mode)throw new Error(`${e}: Unsupported mode ${t.mode}`);if(5===t.mode)throw new Error(`${e}: Mode ${t.mode} is not currently supported`)}const n={},o={},a=(e,s)=>{const a=r.attributes[e];if(null!=a&&(i._delayInfo=i._delayInfo||[],-1===i._delayInfo.indexOf(s)&&i._delayInfo.push(s),n[s]=a,this.useNormalizedFlagFromAccessor)){const i=kb.TryGet(this._loader.gltf.accessors,t.attributes[e]);i&&(o[s]=i.normalized||!1)}};a("POSITION",hi.PositionKind),a("NORMAL",hi.NormalKind),a("TANGENT",hi.TangentKind),a("TEXCOORD_0",hi.UVKind),a("TEXCOORD_1",hi.UV2Kind),a("TEXCOORD_2",hi.UV3Kind),a("TEXCOORD_3",hi.UV4Kind),a("TEXCOORD_4",hi.UV5Kind),a("TEXCOORD_5",hi.UV6Kind),a("JOINTS_0",hi.MatricesIndicesKind),a("WEIGHTS_0",hi.MatricesWeightsKind),a("COLOR_0",hi.ColorKind);const l=kb.Get(s,this._loader.gltf.bufferViews,r.bufferView);return l._dracoBabylonGeometry||(l._dracoBabylonGeometry=this._loader.loadBufferViewAsync(`/bufferViews/${l.index}`,l).then((t=>(this.dracoCompression||wf.Default)._decodeMeshToGeometryForGltfAsync(i.name,this._loader.babylonScene,t,n,o).catch((t=>{throw new Error(`${e}: ${t.message}`)}))))),l._dracoBabylonGeometry}))}}Gb.RegisterExtension(qb,(e=>new Qb(e)));const Zb="KHR_lights_punctual";class Jb{constructor(e){this.name=Zb,this._loader=e,this.enabled=this._loader.isExtensionUsed(Zb)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights,kb.Assign(this._lights)}}loadNodeAsync(e,t,i){return Gb.LoadExtensionAsync(e,t,this.name,((s,r)=>(this._loader._allMaterialsDirtyRequired=!0,this._loader.loadNodeAsync(e,t,(e=>{let t;const n=kb.Get(s,this._lights,r.light),o=n.name||e.name;switch(this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,n.type){case"directional":{const e=new rd(o,S.Backward(),this._loader.babylonScene);e.position.setAll(0),t=e;break}case"point":t=new Wp(o,S.Zero(),this._loader.babylonScene);break;case"spot":{const e=new od(o,S.Zero(),S.Backward(),0,1,this._loader.babylonScene);e.angle=2*(n.spot&&n.spot.outerConeAngle||Math.PI/4),e.innerAngle=2*(n.spot&&n.spot.innerConeAngle||0),t=e;break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${s}: Invalid light type (${n.type})`)}t._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,n._babylonLight=t,t.falloffType=pr.FALLOFF_GLTF,t.diffuse=n.color?N.FromArray(n.color):N.White(),t.intensity=null==n.intensity?1:n.intensity,t.range=null==n.range?Number.MAX_VALUE:n.range,t.parent=e,this._loader._babylonLights.push(t),Gb.AddPointerMetadata(t,s),i(e)})))))}}Gb.RegisterExtension(Zb,(e=>new Jb(e)));const eC="KHR_materials_pbrSpecularGlossiness";class tC{constructor(e){this.name=eC,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(eC)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Gb.LoadExtensionAsync(e,t,this.name,((s,r)=>{const n=new Array;return n.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),n.push(this._loadSpecularGlossinessPropertiesAsync(s,t,r,i)),this._loader.loadMaterialAlphaProperties(e,t,i),Promise.all(n).then((()=>{}))}))}_loadSpecularGlossinessPropertiesAsync(e,t,i,s){if(!(s instanceof Fd))throw new Error(`${e}: Material type not supported`);const r=new Array;return s.metallic=null,s.roughness=null,i.diffuseFactor?(s.albedoColor=N.FromArray(i.diffuseFactor),s.alpha=i.diffuseFactor[3]):s.albedoColor=N.White(),s.reflectivityColor=i.specularFactor?N.FromArray(i.specularFactor):N.White(),s.microSurface=null==i.glossinessFactor?1:i.glossinessFactor,i.diffuseTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTexture`,i.diffuseTexture,(e=>{e.name=`${s.name} (Diffuse)`,s.albedoTexture=e}))),i.specularGlossinessTexture&&(r.push(this._loader.loadTextureInfoAsync(`${e}/specularGlossinessTexture`,i.specularGlossinessTexture,(e=>{e.name=`${s.name} (Specular Glossiness)`,s.reflectivityTexture=e,s.reflectivityTexture.hasAlpha=!0}))),s.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(r).then((()=>{}))}}Gb.RegisterExtension(eC,(e=>new tC(e)));const iC="KHR_materials_unlit";class sC{constructor(e){this.name=iC,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(iC)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Gb.LoadExtensionAsync(e,t,this.name,(()=>this._loadUnlitPropertiesAsync(e,t,i)))}_loadUnlitPropertiesAsync(e,t,i){if(!(i instanceof Fd))throw new Error(`${e}: Material type not supported`);const s=new Array;i.unlit=!0;const r=t.pbrMetallicRoughness;return r&&(r.baseColorFactor?(i.albedoColor=N.FromArray(r.baseColorFactor),i.alpha=r.baseColorFactor[3]):i.albedoColor=N.White(),r.baseColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/baseColorTexture`,r.baseColorTexture,(e=>{e.name=`${i.name} (Base Color)`,i.albedoTexture=e})))),t.doubleSided&&(i.backFaceCulling=!1,i.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,t,i),Promise.all(s).then((()=>{}))}}Gb.RegisterExtension(iC,(e=>new sC(e)));const rC="KHR_materials_clearcoat";class nC{constructor(e){this.name=rC,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(rC)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Gb.LoadExtensionAsync(e,t,this.name,((s,r)=>{const n=new Array;return n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadClearCoatPropertiesAsync(s,r,i)),Promise.all(n).then((()=>{}))}))}_loadClearCoatPropertiesAsync(e,t,i){if(!(i instanceof Fd))throw new Error(`${e}: Material type not supported`);const s=new Array;return i.clearCoat.isEnabled=!0,i.clearCoat.useRoughnessFromMainTexture=!1,i.clearCoat.remapF0OnInterfaceChange=!1,null!=t.clearcoatFactor?i.clearCoat.intensity=t.clearcoatFactor:i.clearCoat.intensity=0,t.clearcoatTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatTexture`,t.clearcoatTexture,(e=>{e.name=`${i.name} (ClearCoat Intensity)`,i.clearCoat.texture=e}))),null!=t.clearcoatRoughnessFactor?i.clearCoat.roughness=t.clearcoatRoughnessFactor:i.clearCoat.roughness=0,t.clearcoatRoughnessTexture&&(t.clearcoatRoughnessTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatRoughnessTexture`,t.clearcoatRoughnessTexture,(e=>{e.name=`${i.name} (ClearCoat Roughness)`,i.clearCoat.textureRoughness=e})))),t.clearcoatNormalTexture&&(t.clearcoatNormalTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatNormalTexture`,t.clearcoatNormalTexture,(e=>{e.name=`${i.name} (ClearCoat Normal)`,i.clearCoat.bumpTexture=e}))),i.invertNormalMapX=!i.getScene().useRightHandedSystem,i.invertNormalMapY=i.getScene().useRightHandedSystem,null!=t.clearcoatNormalTexture.scale&&(i.clearCoat.bumpTexture.level=t.clearcoatNormalTexture.scale)),Promise.all(s).then((()=>{}))}}Gb.RegisterExtension(rC,(e=>new nC(e)));const oC="KHR_materials_iridescence";class aC{constructor(e){this.name=oC,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(oC)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Gb.LoadExtensionAsync(e,t,this.name,((s,r)=>{const n=new Array;return n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadIridescencePropertiesAsync(s,r,i)),Promise.all(n).then((()=>{}))}))}_loadIridescencePropertiesAsync(e,t,i){var s,r,n,o,a;if(!(i instanceof Fd))throw new Error(`${e}: Material type not supported`);const l=new Array;return i.iridescence.isEnabled=!0,i.iridescence.intensity=null!==(s=t.iridescenceFactor)&&void 0!==s?s:0,i.iridescence.indexOfRefraction=null!==(n=null!==(r=t.iridescenceIor)&&void 0!==r?r:t.iridescenceIOR)&&void 0!==n?n:1.3,i.iridescence.minimumThickness=null!==(o=t.iridescenceThicknessMinimum)&&void 0!==o?o:100,i.iridescence.maximumThickness=null!==(a=t.iridescenceThicknessMaximum)&&void 0!==a?a:400,t.iridescenceTexture&&l.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceTexture`,t.iridescenceTexture,(e=>{e.name=`${i.name} (Iridescence Intensity)`,i.iridescence.texture=e}))),t.iridescenceThicknessTexture&&l.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceThicknessTexture`,t.iridescenceThicknessTexture,(e=>{e.name=`${i.name} (Iridescence Thickness)`,i.iridescence.thicknessTexture=e}))),Promise.all(l).then((()=>{}))}}Gb.RegisterExtension(oC,(e=>new aC(e)));const lC="KHR_materials_anisotropy";class hC{constructor(e){this.name=lC,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(lC)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Gb.LoadExtensionAsync(e,t,this.name,((s,r)=>{const n=new Array;return n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadIridescencePropertiesAsync(s,r,i)),Promise.all(n).then((()=>{}))}))}_loadIridescencePropertiesAsync(e,t,i){var s,r;if(!(i instanceof Fd))throw new Error(`${e}: Material type not supported`);const n=new Array;return i.anisotropy.isEnabled=!0,i.anisotropy.intensity=null!==(s=t.anisotropyStrength)&&void 0!==s?s:0,i.anisotropy.angle=null!==(r=t.anisotropyRotation)&&void 0!==r?r:0,t.anisotropyTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/anisotropyTexture`,t.anisotropyTexture,(e=>{e.name=`${i.name} (Anisotropy Intensity)`,i.anisotropy.texture=e}))),Promise.all(n).then((()=>{}))}}Gb.RegisterExtension(lC,(e=>new hC(e)));const cC="KHR_materials_emissive_strength";class uC{constructor(e){this.name=cC,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(cC)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Gb.LoadExtensionAsync(e,t,this.name,((s,r)=>this._loader.loadMaterialPropertiesAsync(e,t,i).then((()=>{this._loadEmissiveProperties(s,r,i)}))))}_loadEmissiveProperties(e,t,i){if(!(i instanceof Fd))throw new Error(`${e}: Material type not supported`);void 0!==t.emissiveStrength&&i.emissiveColor.scaleToRef(t.emissiveStrength,i.emissiveColor)}}Gb.RegisterExtension(cC,(e=>new uC(e)));const dC="KHR_materials_sheen";class pC{constructor(e){this.name=dC,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(dC)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Gb.LoadExtensionAsync(e,t,this.name,((s,r)=>{const n=new Array;return n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadSheenPropertiesAsync(s,r,i)),Promise.all(n).then((()=>{}))}))}_loadSheenPropertiesAsync(e,t,i){if(!(i instanceof Fd))throw new Error(`${e}: Material type not supported`);const s=new Array;return i.sheen.isEnabled=!0,i.sheen.intensity=1,null!=t.sheenColorFactor?i.sheen.color=N.FromArray(t.sheenColorFactor):i.sheen.color=N.Black(),t.sheenColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/sheenColorTexture`,t.sheenColorTexture,(e=>{e.name=`${i.name} (Sheen Color)`,i.sheen.texture=e}))),void 0!==t.sheenRoughnessFactor?i.sheen.roughness=t.sheenRoughnessFactor:i.sheen.roughness=0,t.sheenRoughnessTexture&&(t.sheenRoughnessTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/sheenRoughnessTexture`,t.sheenRoughnessTexture,(e=>{e.name=`${i.name} (Sheen Roughness)`,i.sheen.textureRoughness=e})))),i.sheen.albedoScaling=!0,i.sheen.useRoughnessFromMainTexture=!1,Promise.all(s).then((()=>{}))}}Gb.RegisterExtension(dC,(e=>new pC(e)));const _C="KHR_materials_specular";class fC{constructor(e){this.name=_C,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(_C)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Gb.LoadExtensionAsync(e,t,this.name,((s,r)=>{const n=new Array;return n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadSpecularPropertiesAsync(s,r,i)),Promise.all(n).then((()=>{}))}))}_loadSpecularPropertiesAsync(e,t,i){if(!(i instanceof Fd))throw new Error(`${e}: Material type not supported`);const s=new Array;return void 0!==t.specularFactor&&(i.metallicF0Factor=t.specularFactor),void 0!==t.specularColorFactor&&(i.metallicReflectanceColor=N.FromArray(t.specularColorFactor)),t.specularTexture&&(t.specularTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/specularTexture`,t.specularTexture,(e=>{e.name=`${i.name} (Specular F0 Strength)`,i.metallicReflectanceTexture=e,i.useOnlyMetallicFromMetallicReflectanceTexture=!0})))),t.specularColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/specularColorTexture`,t.specularColorTexture,(e=>{e.name=`${i.name} (Specular F0 Color)`,i.reflectanceTexture=e}))),Promise.all(s).then((()=>{}))}}Gb.RegisterExtension(_C,(e=>new fC(e)));const mC="KHR_materials_ior";class gC{constructor(e){this.name=mC,this.order=180,this._loader=e,this.enabled=this._loader.isExtensionUsed(mC)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Gb.LoadExtensionAsync(e,t,this.name,((s,r)=>{const n=new Array;return n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadIorPropertiesAsync(s,r,i)),Promise.all(n).then((()=>{}))}))}_loadIorPropertiesAsync(e,t,i){if(!(i instanceof Fd))throw new Error(`${e}: Material type not supported`);return void 0!==t.ior?i.indexOfRefraction=t.ior:i.indexOfRefraction=gC._DEFAULT_IOR,Promise.resolve()}}gC._DEFAULT_IOR=1.5,Gb.RegisterExtension(mC,(e=>new gC(e)));const vC="KHR_materials_variants";class xC{constructor(e){this.name=vC,this._loader=e,this.enabled=this._loader.isExtensionUsed(vC)}dispose(){this._loader=null}static GetAvailableVariants(e){const t=this._GetExtensionMetadata(e);return t?Object.keys(t.variants):[]}getAvailableVariants(e){return xC.GetAvailableVariants(e)}static SelectVariant(e,t){const i=this._GetExtensionMetadata(e);if(!i)throw new Error(`Cannot select variant on a glTF mesh that does not have the ${vC} extension`);const s=e=>{const t=i.variants[e];if(t)for(const e of t)e.mesh.material=e.material};if(t instanceof Array)for(const e of t)s(e);else s(t);i.lastSelected=t}selectVariant(e,t){return xC.SelectVariant(e,t)}static Reset(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot reset on a glTF mesh that does not have the ${vC} extension`);for(const e of t.original)e.mesh.material=e.material;t.lastSelected=null}reset(e){return xC.Reset(e)}static GetLastSelectedVariant(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot get the last selected variant on a glTF mesh that does not have the ${vC} extension`);return t.lastSelected}getLastSelectedVariant(e){return xC.GetLastSelectedVariant(e)}static _GetExtensionMetadata(e){var t,i;return(null===(i=null===(t=null==e?void 0:e._internalMetadata)||void 0===t?void 0:t.gltf)||void 0===i?void 0:i[vC])||null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._variants=t.variants}}_loadMeshPrimitiveAsync(e,t,i,s,r,n){return Gb.LoadExtensionAsync(e,r,this.name,((o,a)=>{const l=new Array;return l.push(this._loader._loadMeshPrimitiveAsync(e,t,i,s,r,(t=>{if(n(t),t instanceof ur){const i=Gb._GetDrawMode(e,r.mode),s=this._loader.rootBabylonMesh,n=s?s._internalMetadata=s._internalMetadata||{}:{},h=n.gltf=n.gltf||{},c=h[vC]=h[vC]||{lastSelected:null,original:[],variants:{}};c.original.push({mesh:t,material:t.material});for(let e=0;e<a.mappings.length;++e){const r=a.mappings[e],n=kb.Get(`${o}/mappings/${e}/material`,this._loader.gltf.materials,r.material);l.push(this._loader._loadMaterialAsync(`#/materials/${r.material}`,n,t,i,(e=>{for(let i=0;i<r.variants.length;++i){const n=r.variants[i],o=kb.Get(`/extensions/${vC}/variants/${n}`,this._variants,n);c.variants[o.name]=c.variants[o.name]||[],c.variants[o.name].push({mesh:t,material:e}),t.onClonedObservable.add((e=>{const i=e;let r=null,n=i;do{if(n=n.parent,!n)return;r=xC._GetExtensionMetadata(n)}while(null===r);if(s&&r===xC._GetExtensionMetadata(s)){n._internalMetadata={};for(const e in s._internalMetadata)n._internalMetadata[e]=s._internalMetadata[e];n._internalMetadata.gltf=[];for(const e in s._internalMetadata.gltf)n._internalMetadata.gltf[e]=s._internalMetadata.gltf[e];n._internalMetadata.gltf[vC]={lastSelected:null,original:[],variants:{}};for(const e of r.original)n._internalMetadata.gltf[vC].original.push({mesh:e.mesh,material:e.material});for(const e in r.variants)if(Object.prototype.hasOwnProperty.call(r.variants,e)){n._internalMetadata.gltf[vC].variants[e]=[];for(const t of r.variants[e])n._internalMetadata.gltf[vC].variants[e].push({mesh:t.mesh,material:t.material})}r=n._internalMetadata.gltf[vC]}for(const e of r.original)e.mesh===t&&(e.mesh=i);for(const e of r.variants[o.name])e.mesh===t&&(e.mesh=i)}))}})))}}}))),Promise.all(l).then((([e])=>e))}))}}Gb.RegisterExtension(vC,(e=>new xC(e)));class TC{static _GetDefaultOptions(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:ph.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}}constructor(e,t){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options={...TC._GetDefaultOptions(),...e},this._scene=t,this._scene._transmissionHelper=this,this.onErrorObservable=new a,this._scene.onDisposeObservable.addOnce((()=>{this.dispose()})),this._parseScene(),this._setupRenderTargets()}updateOptions(e){if(!Object.keys(e).filter((t=>this._options[t]!==e[t])).length)return;const t={...this._options,...e},i=this._options;this._options=t,t.renderSize===i.renderSize&&t.renderTargetTextureType===i.renderTargetTextureType&&t.generateMipmaps===i.generateMipmaps&&this._opaqueRenderTarget?(this._opaqueRenderTarget.samples=t.samples,this._opaqueRenderTarget.lodGenerationScale=t.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=t.lodGenerationOffset):this._setupRenderTargets()}getOpaqueTarget(){return this._opaqueRenderTarget}_shouldRenderAsTransmission(e){return!!e&&!!(e instanceof Fd&&e.subSurface.isRefractionEnabled)}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),Ht.SetImmediate((()=>{this._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=this._opaqueRenderTarget,-1===this._transparentMeshesCache.indexOf(e)&&this._transparentMeshesCache.push(e)):-1===this._opaqueMeshesCache.indexOf(e)&&this._opaqueMeshesCache.push(e)}))}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let t=this._transparentMeshesCache.indexOf(e);-1!==t&&this._transparentMeshesCache.splice(t,1),t=this._opaqueMeshesCache.indexOf(e),-1!==t&&this._opaqueMeshesCache.splice(t,1)}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))}_onMeshMaterialChanged(e){const t=this._transparentMeshesCache.indexOf(e),i=this._opaqueMeshesCache.indexOf(e);this._shouldRenderAsTransmission(e.material)?(e.material instanceof Fd&&(e.material.subSurface.refractionTexture=this._opaqueRenderTarget),-1!==i?(this._opaqueMeshesCache.splice(i,1),this._transparentMeshesCache.push(e)):-1===t&&this._transparentMeshesCache.push(e)):-1!==t?(this._transparentMeshesCache.splice(t,1),this._opaqueMeshesCache.push(e)):-1===i&&this._opaqueMeshesCache.push(e)}_isRenderTargetValid(){var e;return null!==(null===(e=this._opaqueRenderTarget)||void 0===e?void 0:e.getInternalTexture())}_setupRenderTargets(){var e,t;let i,s;this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new Bn("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=null!==(t=null===(e=this._options.clearColor)||void 0===e?void 0:e.clone())&&void 0!==t?t:this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples,this._opaqueRenderTarget.renderSprites=!0,this._opaqueRenderTarget.renderParticles=!0,this._opaqueRenderTarget.onBeforeBindObservable.add((e=>{s=this._scene.environmentIntensity,this._scene.environmentIntensity=1,i=this._scene.imageProcessingConfiguration.applyByPostProcess,this._options.clearColor?e.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(e.clearColor,this._scene.getEngine().useExactSrgbConversions),this._scene.imageProcessingConfiguration._applyByPostProcess=!0})),this._opaqueRenderTarget.onAfterUnbindObservable.add((()=>{this._scene.environmentIntensity=s,this._scene.imageProcessingConfiguration._applyByPostProcess=i})),this._transparentMeshesCache.forEach((e=>{this._shouldRenderAsTransmission(e.material)&&(e.material.refractionTexture=this._opaqueRenderTarget)}))}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]}}const EC="KHR_materials_transmission";class SC{constructor(e){this.name=EC,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(EC),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Gb.LoadExtensionAsync(e,t,this.name,((s,r)=>{const n=new Array;return n.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadTransparentPropertiesAsync(s,t,i,r)),Promise.all(n).then((()=>{}))}))}_loadTransparentPropertiesAsync(e,t,i,s){var r,n;if(!(i instanceof Fd))throw new Error(`${e}: Material type not supported`);const o=i;if(o.subSurface.isRefractionEnabled=!0,o.subSurface.volumeIndexOfRefraction=1,o.subSurface.useAlbedoToTintRefraction=!0,void 0===s.transmissionFactor)return o.subSurface.refractionIntensity=0,o.subSurface.isRefractionEnabled=!1,Promise.resolve();{o.subSurface.refractionIntensity=s.transmissionFactor;const e=o.getScene();o.subSurface.refractionIntensity&&!e._transmissionHelper?new TC({},o.getScene()):o.subSurface.refractionIntensity&&!(null===(r=e._transmissionHelper)||void 0===r?void 0:r._isRenderTargetValid())&&(null===(n=e._transmissionHelper)||void 0===n||n._setupRenderTargets())}return o.subSurface.minimumThickness=0,o.subSurface.maximumThickness=0,s.transmissionTexture?(s.transmissionTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/transmissionTexture`,s.transmissionTexture,void 0).then((e=>{o.subSurface.refractionIntensityTexture=e,o.subSurface.useGltfStyleTextures=!0}))):Promise.resolve()}}Gb.RegisterExtension(EC,(e=>new SC(e)));const bC="KHR_materials_translucency";class CC{constructor(e){this.name=bC,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(bC),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Gb.LoadExtensionAsync(e,t,this.name,((s,r)=>{const n=new Array;return n.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadTranslucentPropertiesAsync(s,t,i,r)),Promise.all(n).then((()=>{}))}))}_loadTranslucentPropertiesAsync(e,t,i,s){if(!(i instanceof Fd))throw new Error(`${e}: Material type not supported`);const r=i;return r.subSurface.isTranslucencyEnabled=!0,r.subSurface.volumeIndexOfRefraction=1,r.subSurface.minimumThickness=0,r.subSurface.maximumThickness=0,r.subSurface.useAlbedoToTintTranslucency=!0,void 0===s.translucencyFactor?(r.subSurface.translucencyIntensity=0,r.subSurface.isTranslucencyEnabled=!1,Promise.resolve()):(r.subSurface.translucencyIntensity=s.translucencyFactor,s.translucencyTexture?(s.translucencyTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/translucencyTexture`,s.translucencyTexture).then((e=>{r.subSurface.translucencyIntensityTexture=e}))):Promise.resolve())}}Gb.RegisterExtension(bC,(e=>new CC(e)));const yC="KHR_materials_volume";class AC{constructor(e){this.name=yC,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(yC),this.enabled&&this._loader._disableInstancedMesh++}dispose(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Gb.LoadExtensionAsync(e,t,this.name,((s,r)=>{const n=new Array;return n.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadVolumePropertiesAsync(s,t,i,r)),Promise.all(n).then((()=>{}))}))}_loadVolumePropertiesAsync(e,t,i,s){if(!(i instanceof Fd))throw new Error(`${e}: Material type not supported`);if(!i.subSurface.isRefractionEnabled&&!i.subSurface.isTranslucencyEnabled||!s.thicknessFactor)return Promise.resolve();i.subSurface.volumeIndexOfRefraction=i.indexOfRefraction;const r=void 0!==s.attenuationDistance?s.attenuationDistance:Number.MAX_VALUE;return i.subSurface.tintColorAtDistance=r,void 0!==s.attenuationColor&&3==s.attenuationColor.length&&i.subSurface.tintColor.copyFromFloats(s.attenuationColor[0],s.attenuationColor[1],s.attenuationColor[2]),i.subSurface.minimumThickness=0,i.subSurface.maximumThickness=s.thicknessFactor,i.subSurface.useThicknessAsDepth=!0,s.thicknessTexture?(s.thicknessTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/thicknessTexture`,s.thicknessTexture).then((e=>{i.subSurface.thicknessTexture=e,i.subSurface.useGltfStyleTextures=!0}))):Promise.resolve()}}Gb.RegisterExtension(yC,(e=>new AC(e)));const RC="KHR_materials_dispersion";class IC{constructor(e){this.name=RC,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(RC)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Gb.LoadExtensionAsync(e,t,this.name,((s,r)=>{const n=new Array;return n.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadDispersionPropertiesAsync(s,t,i,r)),Promise.all(n).then((()=>{}))}))}_loadDispersionPropertiesAsync(e,t,i,s){if(!(i instanceof Fd))throw new Error(`${e}: Material type not supported`);return i.subSurface.isRefractionEnabled&&s.dispersion?(i.subSurface.isDispersionEnabled=!0,i.subSurface.dispersion=s.dispersion,Promise.resolve()):Promise.resolve()}}Gb.RegisterExtension(RC,(e=>new IC(e)));const PC="KHR_mesh_quantization";class MC{constructor(e){this.name=PC,this.enabled=e.isExtensionUsed(PC)}dispose(){}}Gb.RegisterExtension(PC,(e=>new MC(e)));const OC="KHR_texture_basisu";class DC{constructor(e){this.name=OC,this._loader=e,this.enabled=e.isExtensionUsed(OC)}dispose(){this._loader=null}_loadTextureAsync(e,t,i){return Gb.LoadExtensionAsync(e,t,this.name,((s,r)=>{const n=null==t.sampler?Gb.DefaultSampler:kb.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),o=kb.Get(`${s}/source`,this._loader.gltf.images,r.source);return this._loader._createTextureAsync(e,n,o,(e=>{i(e)}),t._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!t._textureInfo.nonColorData)}))}}Gb.RegisterExtension(OC,(e=>new DC(e)));const NC="KHR_texture_transform";class FC{constructor(e){this.name=NC,this._loader=e,this.enabled=this._loader.isExtensionUsed(NC)}dispose(){this._loader=null}loadTextureInfoAsync(e,t,i){return Gb.LoadExtensionAsync(e,t,this.name,((s,r)=>this._loader.loadTextureInfoAsync(e,t,(e=>{if(!(e instanceof Ar))throw new Error(`${s}: Texture type not supported`);r.offset&&(e.uOffset=r.offset[0],e.vOffset=r.offset[1]),e.uRotationCenter=0,e.vRotationCenter=0,r.rotation&&(e.wAng=-r.rotation),r.scale&&(e.uScale=r.scale[0],e.vScale=r.scale[1]),null!=r.texCoord&&(e.coordinatesIndex=r.texCoord),i(e)}))))}}Gb.RegisterExtension(NC,(e=>new FC(e)));const wC="KHR_xmp_json_ld";class LC{constructor(e){this.name=wC,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(wC)}dispose(){this._loader=null}onLoading(){var e,t,i;if(null===this._loader.rootBabylonMesh)return;const s=null===(e=this._loader.gltf.extensions)||void 0===e?void 0:e.KHR_xmp_json_ld,r=null===(i=null===(t=this._loader.gltf.asset)||void 0===t?void 0:t.extensions)||void 0===i?void 0:i.KHR_xmp_json_ld;if(s&&r){const e=+r.packet;s.packets&&e<s.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=s.packets[e])}}}function BC(e,t,i,s){return N.FromArray(t,i).scale(s)}function UC(e,t,i,s){return t[i]*s}function VC(e,t,i,s){return-t[i]*s}function kC(e,t,i,s){return t[i+1]*s}function GC(e,t,i,s){return t[i]*s*2}function zC(e){return{scale:[new HC(Ie.ANIMATIONTYPE_FLOAT,`${e}.uScale`,UC,(()=>2)),new HC(Ie.ANIMATIONTYPE_FLOAT,`${e}.vScale`,kC,(()=>2))],offset:[new HC(Ie.ANIMATIONTYPE_FLOAT,`${e}.uOffset`,UC,(()=>2)),new HC(Ie.ANIMATIONTYPE_FLOAT,`${e}.vOffset`,kC,(()=>2))],rotation:[new HC(Ie.ANIMATIONTYPE_FLOAT,`${e}.wAng`,VC,(()=>1))]}}Gb.RegisterExtension(wC,(e=>new LC(e)));class WC extends Lb{buildAnimations(e,t,i,s,r){r(e._babylonCamera,this._buildAnimation(t,i,s))}}class HC extends Lb{buildAnimations(e,t,i,s,r){for(const n in e._data)r(e._data[n].babylonMaterial,this._buildAnimation(t,i,s))}}class XC extends Lb{buildAnimations(e,t,i,s,r){r(e._babylonLight,this._buildAnimation(t,i,s))}}const YC={__array__:{__target__:!0,...Ub}},jC={__array__:{__target__:!0,orthographic:{xmag:[new WC(Ie.ANIMATIONTYPE_FLOAT,"orthoLeft",VC,(()=>1)),new WC(Ie.ANIMATIONTYPE_FLOAT,"orthoRight",kC,(()=>1))],ymag:[new WC(Ie.ANIMATIONTYPE_FLOAT,"orthoBottom",VC,(()=>1)),new WC(Ie.ANIMATIONTYPE_FLOAT,"orthoTop",kC,(()=>1))],zfar:[new WC(Ie.ANIMATIONTYPE_FLOAT,"maxZ",UC,(()=>1))],znear:[new WC(Ie.ANIMATIONTYPE_FLOAT,"minZ",UC,(()=>1))]},perspective:{yfov:[new WC(Ie.ANIMATIONTYPE_FLOAT,"fov",UC,(()=>1))],zfar:[new WC(Ie.ANIMATIONTYPE_FLOAT,"maxZ",UC,(()=>1))],znear:[new WC(Ie.ANIMATIONTYPE_FLOAT,"minZ",UC,(()=>1))]}}},KC={nodes:YC,materials:{__array__:{__target__:!0,pbrMetallicRoughness:{baseColorFactor:[new HC(Ie.ANIMATIONTYPE_COLOR3,"albedoColor",BC,(()=>4)),new HC(Ie.ANIMATIONTYPE_FLOAT,"alpha",(function(e,t,i,s){return t[i+3]*s}),(()=>4))],metallicFactor:[new HC(Ie.ANIMATIONTYPE_FLOAT,"metallic",UC,(()=>1))],roughnessFactor:[new HC(Ie.ANIMATIONTYPE_FLOAT,"roughness",UC,(()=>1))],baseColorTexture:{extensions:{KHR_texture_transform:zC("albedoTexture")}}},emissiveFactor:[new HC(Ie.ANIMATIONTYPE_COLOR3,"emissiveColor",BC,(()=>3))],normalTexture:{scale:[new HC(Ie.ANIMATIONTYPE_FLOAT,"bumpTexture.level",UC,(()=>1))]},occlusionTexture:{strength:[new HC(Ie.ANIMATIONTYPE_FLOAT,"ambientTextureStrength",UC,(()=>1))],extensions:{KHR_texture_transform:zC("ambientTexture")}},emissiveTexture:{extensions:{KHR_texture_transform:zC("emissiveTexture")}},extensions:{KHR_materials_ior:{ior:[new HC(Ie.ANIMATIONTYPE_FLOAT,"indexOfRefraction",UC,(()=>1))]},KHR_materials_clearcoat:{clearcoatFactor:[new HC(Ie.ANIMATIONTYPE_FLOAT,"clearCoat.intensity",UC,(()=>1))],clearcoatRoughnessFactor:[new HC(Ie.ANIMATIONTYPE_FLOAT,"clearCoat.roughness",UC,(()=>1))]},KHR_materials_sheen:{sheenColorFactor:[new HC(Ie.ANIMATIONTYPE_COLOR3,"sheen.color",BC,(()=>3))],sheenRoughnessFactor:[new HC(Ie.ANIMATIONTYPE_FLOAT,"sheen.roughness",UC,(()=>1))]},KHR_materials_specular:{specularFactor:[new HC(Ie.ANIMATIONTYPE_FLOAT,"metallicF0Factor",UC,(()=>1))],specularColorFactor:[new HC(Ie.ANIMATIONTYPE_COLOR3,"metallicReflectanceColor",BC,(()=>3))]},KHR_materials_emissive_strength:{emissiveStrength:[new HC(Ie.ANIMATIONTYPE_FLOAT,"emissiveIntensity",UC,(()=>1))]},KHR_materials_transmission:{transmissionFactor:[new HC(Ie.ANIMATIONTYPE_FLOAT,"subSurface.refractionIntensity",UC,(()=>1))]},KHR_materials_volume:{attenuationColor:[new HC(Ie.ANIMATIONTYPE_COLOR3,"subSurface.tintColor",BC,(()=>3))],attenuationDistance:[new HC(Ie.ANIMATIONTYPE_FLOAT,"subSurface.tintColorAtDistance",UC,(()=>1))],thicknessFactor:[new HC(Ie.ANIMATIONTYPE_FLOAT,"subSurface.maximumThickness",UC,(()=>1))]},KHR_materials_dispersion:{dispersion:[new HC(Ie.ANIMATIONTYPE_FLOAT,"subSurface.dispersion",UC,(()=>1))]},KHR_materials_iridescence:{iridescenceFactor:[new HC(Ie.ANIMATIONTYPE_FLOAT,"iridescence.intensity",UC,(()=>1))],iridescenceIor:[new HC(Ie.ANIMATIONTYPE_FLOAT,"iridescence.indexOfRefraction",UC,(()=>1))],iridescenceThicknessMinimum:[new HC(Ie.ANIMATIONTYPE_FLOAT,"iridescence.minimumThickness",UC,(()=>1))],iridescenceThicknessMaximum:[new HC(Ie.ANIMATIONTYPE_FLOAT,"iridescence.maximumThickness",UC,(()=>1))]},KHR_materials_anisotropy:{anisotropyStrength:[new HC(Ie.ANIMATIONTYPE_FLOAT,"anisotropy.intensity",UC,(()=>1))],anisotropyRotation:[new HC(Ie.ANIMATIONTYPE_FLOAT,"anisotropy.angle",UC,(()=>1))]}}}},cameras:jC,extensions:{KHR_lights_punctual:{lights:{__array__:{__target__:!0,color:[new XC(Ie.ANIMATIONTYPE_COLOR3,"diffuse",BC,(()=>3))],intensity:[new XC(Ie.ANIMATIONTYPE_FLOAT,"intensity",UC,(()=>1))],range:[new XC(Ie.ANIMATIONTYPE_FLOAT,"range",UC,(()=>1))],spot:{innerConeAngle:[new XC(Ie.ANIMATIONTYPE_FLOAT,"innerAngle",GC,(()=>1))],outerConeAngle:[new XC(Ie.ANIMATIONTYPE_FLOAT,"angle",GC,(()=>1))]}}}}}},$C="KHR_animation_pointer";class qC{constructor(e){this.name=$C,this._loader=e}get enabled(){return this._loader.isExtensionUsed($C)}dispose(){this._loader=null}_loadAnimationChannelAsync(e,t,i,s,r){var n;const o=null===(n=s.target.extensions)||void 0===n?void 0:n.KHR_animation_pointer;if(!o)return null;"pointer"!==s.target.path&&k.Warn(`${e}/target/path: Value (${s.target.path}) must be (pointer) when using the ${this.name} extension`),null!=s.target.node&&k.Warn(`${e}/target/node: Value (${s.target.node}) must not be present when using the ${this.name} extension`);const a=`${e}/extensions/${this.name}`,l=o.pointer;if(!l)throw new Error(`${a}: Pointer is missing`);const h=this._parseAnimationPointer(`${a}/pointer`,l);return h?this._loader._loadAnimationChannelFromTargetInfoAsync(e,t,i,s,h,r):(k.Warn(`${a}/pointer: Invalid pointer (${l}) skipped`),null)}_parseAnimationPointer(e,t){if(!t.startsWith("/"))return k.Warn(`${e}: Value (${t}) must start with a slash`),null;const i=t.split("/");i.shift();let s,r=KC,n=this._loader.gltf;for(const e of i){if(r.__array__)r=r.__array__;else if(r=r[e],!r)return null;n=n&&n[e],r.__target__&&(s=n)}return s&&Array.isArray(r)?{target:s,properties:r}:null}}Gb.RegisterExtension($C,(e=>new qC(e)));const QC="MSFT_audio_emitter";class ZC{constructor(e){this.name=QC,this._loader=e,this.enabled=this._loader.isExtensionUsed(QC)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._clips=t.clips,this._emitters=t.emitters,kb.Assign(this._clips),kb.Assign(this._emitters)}}loadSceneAsync(e,t){return Gb.LoadExtensionAsync(e,t,this.name,((i,s)=>{const r=new Array;r.push(this._loader.loadSceneAsync(e,t));for(const e of s.emitters){const t=kb.Get(`${i}/emitters`,this._emitters,e);if(null!=t.refDistance||null!=t.maxDistance||null!=t.rolloffFactor||null!=t.distanceModel||null!=t.innerAngle||null!=t.outerAngle)throw new Error(`${i}: Direction or Distance properties are not allowed on emitters attached to a scene`);r.push(this._loadEmitterAsync(`${i}/emitters/${t.index}`,t))}return Promise.all(r).then((()=>{}))}))}loadNodeAsync(e,t,i){return Gb.LoadExtensionAsync(e,t,this.name,((e,s)=>{const r=new Array;return this._loader.loadNodeAsync(e,t,(t=>{for(const i of s.emitters){const s=kb.Get(`${e}/emitters`,this._emitters,i);r.push(this._loadEmitterAsync(`${e}/emitters/${s.index}`,s).then((()=>{for(const e of s._babylonSounds)e.attachToMesh(t),null==s.innerAngle&&null==s.outerAngle||(e.setLocalDirectionToMesh(S.Forward()),e.setDirectionalCone(2*Ht.ToDegrees(null==s.innerAngle?Math.PI:s.innerAngle),2*Ht.ToDegrees(null==s.outerAngle?Math.PI:s.outerAngle),0))})))}i(t)})).then((e=>Promise.all(r).then((()=>e))))}))}loadAnimationAsync(e,t){return Gb.LoadExtensionAsync(e,t,this.name,((i,s)=>this._loader.loadAnimationAsync(e,t).then((r=>{const n=new Array;kb.Assign(s.events);for(const o of s.events)n.push(this._loadAnimationEventAsync(`${i}/events/${o.index}`,e,t,o,r));return Promise.all(n).then((()=>r))}))))}_loadClipAsync(e,t){if(t._objectURL)return t._objectURL;let i;if(t.uri)i=this._loader.loadUriAsync(e,t,t.uri);else{const s=kb.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,t.bufferView);i=this._loader.loadBufferViewAsync(`/bufferViews/${s.index}`,s)}return t._objectURL=i.then((e=>URL.createObjectURL(new Blob([e],{type:t.mimeType})))),t._objectURL}_loadEmitterAsync(e,t){if(t._babylonSounds=t._babylonSounds||[],!t._babylonData){const e=new Array,i=t.name||`emitter${t.index}`,s={loop:!1,autoplay:!1,volume:null==t.volume?1:t.volume};for(let r=0;r<t.clips.length;r++){const n=`/extensions/${this.name}/clips`,o=kb.Get(n,this._clips,t.clips[r].clip);e.push(this._loadClipAsync(`${n}/${t.clips[r].clip}`,o).then((e=>{const n=t._babylonSounds[r]=new vr(i,e,this._loader.babylonScene,null,s);n.refDistance=t.refDistance||1,n.maxDistance=t.maxDistance||256,n.rolloffFactor=t.rolloffFactor||1,n.distanceModel=t.distanceModel||"exponential"})))}const r=Promise.all(e).then((()=>{const e=t.clips.map((e=>e.weight||1)),i=new Er(t.loop||!1,t._babylonSounds,e);t.innerAngle&&(i.directionalConeInnerAngle=2*Ht.ToDegrees(t.innerAngle)),t.outerAngle&&(i.directionalConeOuterAngle=2*Ht.ToDegrees(t.outerAngle)),t.volume&&(i.volume=t.volume),t._babylonData.sound=i}));t._babylonData={loaded:r}}return t._babylonData.loaded}_getEventAction(e,t,i,s,r){switch(i){case"play":return e=>{const i=(r||0)+(e-s);t.play(i)};case"stop":return()=>{t.stop()};case"pause":return()=>{t.pause()};default:throw new Error(`${e}: Unsupported action ${i}`)}}_loadAnimationEventAsync(e,t,i,s,r){if(0==r.targetedAnimations.length)return Promise.resolve();const n=r.targetedAnimations[0],o=s.emitter,a=kb.Get(`/extensions/${this.name}/emitters`,this._emitters,o);return this._loadEmitterAsync(e,a).then((()=>{const t=a._babylonData.sound;if(t){const i=new ns(s.time,this._getEventAction(e,t,s.action,s.time,s.startOffset));n.animation.addEvent(i),r.onAnimationGroupEndObservable.add((()=>{t.stop()})),r.onAnimationGroupPauseObservable.add((()=>{t.pause()}))}}))}}Gb.RegisterExtension(QC,(e=>new ZC(e)));const JC="MSFT_lod";class ey{constructor(e){this.name=JC,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new a,this.onMaterialLODsLoadedObservable=new a,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.enabled=this._loader.isExtensionUsed(JC)}dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){const t=Promise.all(this._nodePromiseLODs[e]).then((()=>{0!==e&&(this._loader.endPerformanceCounter(`Node LOD ${e}`),this._loader.log(`Loaded node LOD ${e}`)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Node LOD ${e+1}`),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve())}));this._loader._completePromises.push(t)}for(let e=0;e<this._materialPromiseLODs.length;e++){const t=Promise.all(this._materialPromiseLODs[e]).then((()=>{0!==e&&(this._loader.endPerformanceCounter(`Material LOD ${e}`),this._loader.log(`Loaded material LOD ${e}`)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Material LOD ${e+1}`),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve())}));this._loader._completePromises.push(t)}}loadSceneAsync(e,t){const i=this._loader.loadSceneAsync(e,t);return this._loadBufferLOD(this._bufferLODs,0),i}loadNodeAsync(e,t,i){return Gb.LoadExtensionAsync(e,t,this.name,((e,s)=>{let r;const n=this._getLODs(e,t,this._loader.gltf.nodes,s.ids);this._loader.logOpen(`${e}`);for(let e=0;e<n.length;e++){const t=n[e];0!==e&&(this._nodeIndexLOD=e,this._nodeSignalLODs[e]=this._nodeSignalLODs[e]||new cx);const s=e=>{i(e),e.setEnabled(!1)},o=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,s).then((t=>{if(0!==e){const t=n[e-1];t._babylonTransformNode&&(this._disposeTransformNode(t._babylonTransformNode),delete t._babylonTransformNode)}return t.setEnabled(!0),t}));this._nodePromiseLODs[e]=this._nodePromiseLODs[e]||[],0===e?r=o:(this._nodeIndexLOD=null,this._nodePromiseLODs[e].push(o))}return this._loader.logClose(),r}))}_loadMaterialAsync(e,t,i,s,r){return this._nodeIndexLOD?null:Gb.LoadExtensionAsync(e,t,this.name,((e,n)=>{let o;const a=this._getLODs(e,t,this._loader.gltf.materials,n.ids);this._loader.logOpen(`${e}`);for(let e=0;e<a.length;e++){const t=a[e];0!==e&&(this._materialIndexLOD=e);const n=this._loader._loadMaterialAsync(`/materials/${t.index}`,t,i,s,(t=>{0===e&&r(t)})).then((t=>{if(0!==e){r(t);const i=a[e-1]._data;i[s]&&(this._disposeMaterials([i[s].babylonMaterial]),delete i[s])}return t}));this._materialPromiseLODs[e]=this._materialPromiseLODs[e]||[],0===e?o=n:(this._materialIndexLOD=null,this._materialPromiseLODs[e].push(n))}return this._loader.logClose(),o}))}_loadUriAsync(e,t,i){if(null!==this._nodeIndexLOD){this._loader.log("deferred");const s=this._nodeIndexLOD-1;return this._nodeSignalLODs[s]=this._nodeSignalLODs[s]||new cx,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then((()=>this._loader.loadUriAsync(e,t,i)))}if(null!==this._materialIndexLOD){this._loader.log("deferred");const s=this._materialIndexLOD-1;return this._materialSignalLODs[s]=this._materialSignalLODs[s]||new cx,this._materialSignalLODs[s].promise.then((()=>this._loader.loadUriAsync(e,t,i)))}return null}loadBufferAsync(e,t,i,s){if(this._loader.parent.useRangeRequests&&!t.uri){if(!this._loader.bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);const t=(e,t)=>{const r=i,n=r+s-1;let o=e[t];return o?(o.start=Math.min(o.start,r),o.end=Math.max(o.end,n)):(o={start:r,end:n,loaded:new cx},e[t]=o),o.loaded.promise.then((e=>new Uint8Array(e.buffer,e.byteOffset+i-o.start,s)))};return this._loader.log("deferred"),null!==this._nodeIndexLOD?t(this._nodeBufferLODs,this._nodeIndexLOD):null!==this._materialIndexLOD?t(this._materialBufferLODs,this._materialIndexLOD):t(this._bufferLODs,0)}return null}_loadBufferLOD(e,t){const i=e[t];i&&(this._loader.log(`Loading buffer range [${i.start}-${i.end}]`),this._loader.bin.readAsync(i.start,i.end-i.start+1).then((e=>{i.loaded.resolve(e)}),(e=>{i.loaded.reject(e)})))}_getLODs(e,t,i,s){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");const r=[];for(let t=s.length-1;t>=0;t--)if(r.push(kb.Get(`${e}/ids/${s[t]}`,i,s[t])),r.length===this.maxLODsToLoad)return r;return r.push(t),r}_disposeTransformNode(e){const t=[],i=e.material;i&&t.push(i);for(const i of e.getChildMeshes())i.material&&t.push(i.material);e.dispose();const s=t.filter((e=>this._loader.babylonScene.meshes.every((t=>t.material!=e))));this._disposeMaterials(s)}_disposeMaterials(e){const t={};for(const i of e){for(const e of i.getActiveTextures())t[e.uniqueId]=e;i.dispose()}for(const e in t)for(const i of this._loader.babylonScene.materials)i.hasTexture(t[e])&&delete t[e];for(const e in t)t[e].dispose()}}Gb.RegisterExtension(JC,(e=>new ey(e)));const ty="MSFT_minecraftMesh";class iy{constructor(e){this.name=ty,this._loader=e,this.enabled=this._loader.isExtensionUsed(ty)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Gb.LoadExtraAsync(e,t,this.name,((s,r)=>{if(r){if(!(i instanceof Fd))throw new Error(`${s}: Material type not supported`);const r=this._loader.loadMaterialPropertiesAsync(e,t,i);return i.needAlphaBlending()&&(i.forceDepthWrite=!0,i.separateCullingPass=!0),i.backFaceCulling=i.forceDepthWrite,i.twoSidedLighting=!0,r}return null}))}}Gb.RegisterExtension(ty,(e=>new iy(e)));const sy="MSFT_sRGBFactors";class ry{constructor(e){this.name=sy,this._loader=e,this.enabled=this._loader.isExtensionUsed(sy)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Gb.LoadExtraAsync(e,t,this.name,((s,r)=>{if(r){if(!(i instanceof Fd))throw new Error(`${s}: Material type not supported`);const r=this._loader.loadMaterialPropertiesAsync(e,t,i),n=i.getScene().getEngine().useExactSrgbConversions;return i.albedoTexture||i.albedoColor.toLinearSpaceToRef(i.albedoColor,n),i.reflectivityTexture||i.reflectivityColor.toLinearSpaceToRef(i.reflectivityColor,n),r}return null}))}}Gb.RegisterExtension(sy,(e=>new ry(e)));const ny="ExtrasAsMetadata";class oy{_assignExtras(e,t){if(t.extras&&Object.keys(t.extras).length>0){const i=e.metadata=e.metadata||{};(i.gltf=i.gltf||{}).extras=t.extras}}constructor(e){this.name=ny,this.enabled=!0,this._loader=e}dispose(){this._loader=null}loadNodeAsync(e,t,i){return this._loader.loadNodeAsync(e,t,(e=>{this._assignExtras(e,t),i(e)}))}loadCameraAsync(e,t,i){return this._loader.loadCameraAsync(e,t,(e=>{this._assignExtras(e,t),i(e)}))}createMaterial(e,t,i){const s=this._loader.createMaterial(e,t,i);return this._assignExtras(s,t),s}}Gb.RegisterExtension(ny,(e=>new oy(e)));class ay{constructor(){this.materials=[]}parseMTL(e,t,i,s){if(t instanceof ArrayBuffer)return;const r=t.split("\n"),n=/\s+/;let o,a=null;for(let t=0;t<r.length;t++){const l=r[t].trim();if(0===l.length||"#"===l.charAt(0))continue;const h=l.indexOf(" ");let c=h>=0?l.substring(0,h):l;c=c.toLowerCase();const u=h>=0?l.substring(h+1).trim():"";if("newmtl"===c)a&&this.materials.push(a),e._blockEntityCollection=!!s,a=new Va(u,e),a._parentContainer=s,e._blockEntityCollection=!1;else if("kd"===c&&a)o=u.split(n,3).map(parseFloat),a.diffuseColor=N.FromArray(o);else if("ka"===c&&a)o=u.split(n,3).map(parseFloat),a.ambientColor=N.FromArray(o);else if("ks"===c&&a)o=u.split(n,3).map(parseFloat),a.specularColor=N.FromArray(o);else if("ke"===c&&a)o=u.split(n,3).map(parseFloat),a.emissiveColor=N.FromArray(o);else if("ns"===c&&a)a.specularPower=parseFloat(u);else if("d"===c&&a)a.alpha=parseFloat(u);else if("map_ka"===c&&a)a.ambientTexture=ay._GetTexture(i,u,e);else if("map_kd"===c&&a)a.diffuseTexture=ay._GetTexture(i,u,e);else if("map_ks"===c&&a)a.specularTexture=ay._GetTexture(i,u,e);else if("map_ns"===c);else if("map_bump"===c&&a){const t=u.split(n),s=t.indexOf("-bm");let r=null;s>=0&&(r=t[s+1],t.splice(s,2)),a.bumpTexture=ay._GetTexture(i,t.join(" "),e),a.bumpTexture&&null!==r&&(a.bumpTexture.level=parseFloat(r))}else"map_d"===c&&a&&(a.opacityTexture=ay._GetTexture(i,u,e))}a&&this.materials.push(a)}static _GetTexture(e,t,i){if(!t)return null;let s=e;if("file:"===e){let e=t.lastIndexOf("\\");-1===e&&(e=t.lastIndexOf("/")),s+=e>-1?t.substr(e+1):t}else s+=t;return new Ar(s,i,!1,ay.INVERT_TEXTURE_Y)}}ay.INVERT_TEXTURE_Y=!0;class ly{constructor(e,t,i){this._positions=[],this._normals=[],this._uvs=[],this._colors=[],this._meshesFromObj=[],this._indicesForBabylon=[],this._wrappedPositionForBabylon=[],this._wrappedUvsForBabylon=[],this._wrappedColorsForBabylon=[],this._wrappedNormalsForBabylon=[],this._tuplePosNorm=[],this._curPositionInIndices=0,this._hasMeshes=!1,this._unwrappedPositionsForBabylon=[],this._unwrappedColorsForBabylon=[],this._unwrappedNormalsForBabylon=[],this._unwrappedUVForBabylon=[],this._triangles=[],this._materialNameFromObj="",this._objMeshName="",this._increment=1,this._isFirstMaterial=!0,this._grayColor=new F(.5,.5,.5,1),this._materialToUse=e,this._babylonMeshesArray=t,this._loadingOptions=i}_isInArray(e,t){e[t[0]]||(e[t[0]]={normals:[],idx:[]});const i=e[t[0]].normals.indexOf(t[1]);return-1===i?-1:e[t[0]].idx[i]}_isInArrayUV(e,t){e[t[0]]||(e[t[0]]={normals:[],idx:[],uv:[]});const i=e[t[0]].normals.indexOf(t[1]);return 1!=i&&t[2]===e[t[0]].uv[i]?e[t[0]].idx[i]:-1}_setData(e,t,i,s,r,n,o){let a;a=this._loadingOptions.optimizeWithUV?this._isInArrayUV(this._tuplePosNorm,[e,i,t]):this._isInArray(this._tuplePosNorm,[e,i]),-1===a?(this._indicesForBabylon.push(this._wrappedPositionForBabylon.length),this._wrappedPositionForBabylon.push(s),this._wrappedUvsForBabylon.push(r),this._wrappedNormalsForBabylon.push(n),void 0!==o&&this._wrappedColorsForBabylon.push(o),this._tuplePosNorm[e].normals.push(i),this._tuplePosNorm[e].idx.push(this._curPositionInIndices++),this._loadingOptions.optimizeWithUV&&this._tuplePosNorm[e].uv.push(t)):this._indicesForBabylon.push(a)}_unwrapData(){for(let e=0;e<this._wrappedPositionForBabylon.length;e++)this._unwrappedPositionsForBabylon.push(this._wrappedPositionForBabylon[e].x,this._wrappedPositionForBabylon[e].y,this._wrappedPositionForBabylon[e].z),this._unwrappedNormalsForBabylon.push(this._wrappedNormalsForBabylon[e].x,this._wrappedNormalsForBabylon[e].y,this._wrappedNormalsForBabylon[e].z),this._unwrappedUVForBabylon.push(this._wrappedUvsForBabylon[e].x,this._wrappedUvsForBabylon[e].y),this._loadingOptions.importVertexColors&&this._unwrappedColorsForBabylon.push(this._wrappedColorsForBabylon[e].r,this._wrappedColorsForBabylon[e].g,this._wrappedColorsForBabylon[e].b,this._wrappedColorsForBabylon[e].a);this._wrappedPositionForBabylon.length=0,this._wrappedNormalsForBabylon.length=0,this._wrappedUvsForBabylon.length=0,this._wrappedColorsForBabylon.length=0,this._tuplePosNorm.length=0,this._curPositionInIndices=0}_getTriangles(e,t){for(let i=t;i<e.length-1;i++)this._triangles.push(e[0],e[i],e[i+1])}_setDataForCurrentFaceWithPattern1(e,t){this._getTriangles(e,t);for(let e=0;e<this._triangles.length;e++){const t=parseInt(this._triangles[e])-1;this._setData(t,0,0,this._positions[t],E.Zero(),S.Up(),this._loadingOptions.importVertexColors?this._colors[t]:void 0)}this._triangles.length=0}_setDataForCurrentFaceWithPattern2(e,t){this._getTriangles(e,t);for(let e=0;e<this._triangles.length;e++){const t=this._triangles[e].split("/"),i=parseInt(t[0])-1,s=parseInt(t[1])-1;this._setData(i,s,0,this._positions[i],this._uvs[s],S.Up(),this._loadingOptions.importVertexColors?this._colors[i]:void 0)}this._triangles.length=0}_setDataForCurrentFaceWithPattern3(e,t){this._getTriangles(e,t);for(let e=0;e<this._triangles.length;e++){const t=this._triangles[e].split("/"),i=parseInt(t[0])-1,s=parseInt(t[1])-1,r=parseInt(t[2])-1;this._setData(i,s,r,this._positions[i],this._uvs[s],this._normals[r])}this._triangles.length=0}_setDataForCurrentFaceWithPattern4(e,t){this._getTriangles(e,t);for(let e=0;e<this._triangles.length;e++){const t=this._triangles[e].split("//"),i=parseInt(t[0])-1,s=parseInt(t[1])-1;this._setData(i,1,s,this._positions[i],E.Zero(),this._normals[s],this._loadingOptions.importVertexColors?this._colors[i]:void 0)}this._triangles.length=0}_setDataForCurrentFaceWithPattern5(e,t){this._getTriangles(e,t);for(let e=0;e<this._triangles.length;e++){const t=this._triangles[e].split("/"),i=this._positions.length+parseInt(t[0]),s=this._uvs.length+parseInt(t[1]),r=this._normals.length+parseInt(t[2]);this._setData(i,s,r,this._positions[i],this._uvs[s],this._normals[r],this._loadingOptions.importVertexColors?this._colors[i]:void 0)}this._triangles.length=0}_addPreviousObjMesh(){this._meshesFromObj.length>0&&(this._handledMesh=this._meshesFromObj[this._meshesFromObj.length-1],this._unwrapData(),this._indicesForBabylon.reverse(),this._handledMesh.indices=this._indicesForBabylon.slice(),this._handledMesh.positions=this._unwrappedPositionsForBabylon.slice(),this._handledMesh.normals=this._unwrappedNormalsForBabylon.slice(),this._handledMesh.uvs=this._unwrappedUVForBabylon.slice(),this._loadingOptions.importVertexColors&&(this._handledMesh.colors=this._unwrappedColorsForBabylon.slice()),this._indicesForBabylon.length=0,this._unwrappedPositionsForBabylon.length=0,this._unwrappedColorsForBabylon.length=0,this._unwrappedNormalsForBabylon.length=0,this._unwrappedUVForBabylon.length=0)}_optimizeNormals(e){const t=e.getVerticesData(hi.PositionKind),i=e.getVerticesData(hi.NormalKind),s={};if(!t||!i)return;for(let e=0;e<t.length/3;e++){const i=t[3*e+0]+"_"+t[3*e+1]+"_"+t[3*e+2];let r=s[i];r||(r=[],s[i]=r),r.push(e)}const r=new S;for(const e in s){const t=s[e];if(t.length<2)continue;const n=t[0];for(let e=1;e<t.length;++e){const s=t[e];i[3*n+0]+=i[3*s+0],i[3*n+1]+=i[3*s+1],i[3*n+2]+=i[3*s+2]}r.copyFromFloats(i[3*n+0],i[3*n+1],i[3*n+2]),r.normalize();for(let e=0;e<t.length;++e){const s=t[e];i[3*s+0]=r.x,i[3*s+1]=r.y,i[3*s+2]=r.z}}e.setVerticesData(hi.NormalKind,i)}parse(e,t,i,s,r){var n;const o=t.split("\n");for(let e=0;e<o.length;e++){const t=o[e].trim().replace(/\s\s/g," ");let i;if(0!==t.length&&"#"!==t.charAt(0))if(ly.VertexPattern.test(t)){if(i=t.match(/[^ ]+/g),this._positions.push(new S(parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3]))),this._loadingOptions.importVertexColors)if(i.length>=7){const e=parseFloat(i[4]),t=parseFloat(i[5]),s=parseFloat(i[6]);this._colors.push(new F(e>1?e/255:e,t>1?t/255:t,s>1?s/255:s,7===i.length||void 0===i[7]?1:parseFloat(i[7])))}else this._colors.push(this._grayColor)}else if(null!==(i=ly.NormalPattern.exec(t)))this._normals.push(new S(parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3])));else if(null!==(i=ly.UVPattern.exec(t)))this._uvs.push(new E(parseFloat(i[1])*this._loadingOptions.UVScaling.x,parseFloat(i[2])*this._loadingOptions.UVScaling.y));else if(null!==(i=ly.FacePattern3.exec(t)))this._setDataForCurrentFaceWithPattern3(i[1].trim().split(" "),1);else if(null!==(i=ly.FacePattern4.exec(t)))this._setDataForCurrentFaceWithPattern4(i[1].trim().split(" "),1);else if(null!==(i=ly.FacePattern5.exec(t)))this._setDataForCurrentFaceWithPattern5(i[1].trim().split(" "),1);else if(null!==(i=ly.FacePattern2.exec(t)))this._setDataForCurrentFaceWithPattern2(i[1].trim().split(" "),1);else if(null!==(i=ly.FacePattern1.exec(t)))this._setDataForCurrentFaceWithPattern1(i[1].trim().split(" "),1);else if(null!==(i=ly.LinePattern1.exec(t)))this._setDataForCurrentFaceWithPattern1(i[1].trim().split(" "),0);else if(null!==(i=ly.LinePattern2.exec(t)))this._setDataForCurrentFaceWithPattern2(i[1].trim().split(" "),0);else if(null!==(i=ly.LinePattern3.exec(t)))this._setDataForCurrentFaceWithPattern3(i[1].trim().split(" "),0);else if(ly.GroupDescriptor.test(t)||ly.ObjectDescriptor.test(t)){const e={name:t.substring(2).trim(),indices:void 0,positions:void 0,normals:void 0,uvs:void 0,colors:void 0,materialName:this._materialNameFromObj,isObject:ly.ObjectDescriptor.test(t)};this._addPreviousObjMesh(),this._meshesFromObj.push(e),this._hasMeshes=!0,this._isFirstMaterial=!0,this._increment=1}else if(ly.UseMtlDescriptor.test(t)){if(this._materialNameFromObj=t.substring(7).trim(),!this._isFirstMaterial||!this._hasMeshes){this._addPreviousObjMesh();const e={name:(this._objMeshName||"mesh")+"_mm"+this._increment.toString(),indices:void 0,positions:void 0,normals:void 0,uvs:void 0,colors:void 0,materialName:this._materialNameFromObj,isObject:!1};this._increment++,this._meshesFromObj.push(e),this._hasMeshes=!0}this._hasMeshes&&this._isFirstMaterial&&(this._meshesFromObj[this._meshesFromObj.length-1].materialName=this._materialNameFromObj,this._isFirstMaterial=!1)}else ly.MtlLibGroupDescriptor.test(t)?r(t.substring(7).trim()):ly.SmoothDescriptor.test(t)||console.log("Unhandled expression at line : "+t)}if(this._hasMeshes&&(this._handledMesh=this._meshesFromObj[this._meshesFromObj.length-1],this._indicesForBabylon.reverse(),this._unwrapData(),this._handledMesh.indices=this._indicesForBabylon,this._handledMesh.positions=this._unwrappedPositionsForBabylon,this._handledMesh.normals=this._unwrappedNormalsForBabylon,this._handledMesh.uvs=this._unwrappedUVForBabylon,this._loadingOptions.importVertexColors&&(this._handledMesh.colors=this._unwrappedColorsForBabylon)),!this._hasMeshes){let e=null;if(this._indicesForBabylon.length)this._indicesForBabylon.reverse(),this._unwrapData();else{for(const e of this._positions)this._unwrappedPositionsForBabylon.push(e.x,e.y,e.z);if(this._normals.length)for(const e of this._normals)this._unwrappedNormalsForBabylon.push(e.x,e.y,e.z);if(this._uvs.length)for(const e of this._uvs)this._unwrappedUVForBabylon.push(e.x,e.y);if(this._colors.length)for(const e of this._colors)this._unwrappedColorsForBabylon.push(e.r,e.g,e.b,e.a);this._materialNameFromObj||(e=new Va(Ps.RandomId(),i),e.pointsCloud=!0,this._materialNameFromObj=e.name,this._normals.length||(e.disableLighting=!0,e.emissiveColor=N.White()))}this._meshesFromObj.push({name:Ps.RandomId(),indices:this._indicesForBabylon,positions:this._unwrappedPositionsForBabylon,colors:this._unwrappedColorsForBabylon,normals:this._unwrappedNormalsForBabylon,uvs:this._unwrappedUVForBabylon,materialName:this._materialNameFromObj,directMaterial:e,isObject:!0})}for(let t=0;t<this._meshesFromObj.length;t++){if(e&&this._meshesFromObj[t].name)if(e instanceof Array){if(-1===e.indexOf(this._meshesFromObj[t].name))continue}else if(this._meshesFromObj[t].name!==e)continue;this._handledMesh=this._meshesFromObj[t],i._blockEntityCollection=!!s;const r=new ur(this._meshesFromObj[t].name,i);if(r._parentContainer=s,i._blockEntityCollection=!1,this._handledMesh._babylonMesh=r,!this._handledMesh.isObject)for(let e=t-1;e>=0;--e)if(this._meshesFromObj[e].isObject&&this._meshesFromObj[e]._babylonMesh){r.parent=this._meshesFromObj[e]._babylonMesh;break}if(this._materialToUse.push(this._meshesFromObj[t].materialName),0===(null===(n=this._handledMesh.positions)||void 0===n?void 0:n.length)){this._babylonMeshesArray.push(r);continue}const o=new As;if(o.uvs=this._handledMesh.uvs,o.indices=this._handledMesh.indices,o.positions=this._handledMesh.positions,this._loadingOptions.computeNormals){const e=new Array;As.ComputeNormals(this._handledMesh.positions,this._handledMesh.indices,e),o.normals=e}else o.normals=this._handledMesh.normals;this._loadingOptions.importVertexColors&&(o.colors=this._handledMesh.colors),o.applyToMesh(r),this._loadingOptions.invertY&&(r.scaling.y*=-1),this._loadingOptions.optimizeNormals&&this._optimizeNormals(r),this._babylonMeshesArray.push(r),this._handledMesh.directMaterial&&(r.material=this._handledMesh.directMaterial)}}}ly.ObjectDescriptor=/^o/,ly.GroupDescriptor=/^g/,ly.MtlLibGroupDescriptor=/^mtllib /,ly.UseMtlDescriptor=/^usemtl /,ly.SmoothDescriptor=/^s /,ly.VertexPattern=/^v(\s+[\d|.|+|\-|e|E]+){3,7}/,ly.NormalPattern=/^vn(\s+[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)/,ly.UVPattern=/^vt(\s+[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)/,ly.FacePattern1=/^f\s+(([\d]{1,}[\s]?){3,})+/,ly.FacePattern2=/^f\s+((([\d]{1,}\/[\d]{1,}[\s]?){3,})+)/,ly.FacePattern3=/^f\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){3,})+)/,ly.FacePattern4=/^f\s+((([\d]{1,}\/\/[\d]{1,}[\s]?){3,})+)/,ly.FacePattern5=/^f\s+(((-[\d]{1,}\/-[\d]{1,}\/-[\d]{1,}[\s]?){3,})+)/,ly.LinePattern1=/^l\s+(([\d]{1,}[\s]?){2,})+/,ly.LinePattern2=/^l\s+((([\d]{1,}\/[\d]{1,}[\s]?){2,})+)/,ly.LinePattern3=/^l\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){2,})+)/;class hy{static get INVERT_TEXTURE_Y(){return ay.INVERT_TEXTURE_Y}static set INVERT_TEXTURE_Y(e){ay.INVERT_TEXTURE_Y=e}constructor(e){this.name="obj",this.extensions=".obj",this._assetContainer=null,this._loadingOptions=e||hy._DefaultLoadingOptions}static get _DefaultLoadingOptions(){return{computeNormals:hy.COMPUTE_NORMALS,optimizeNormals:hy.OPTIMIZE_NORMALS,importVertexColors:hy.IMPORT_VERTEX_COLORS,invertY:hy.INVERT_Y,invertTextureY:hy.INVERT_TEXTURE_Y,UVScaling:hy.UV_SCALING,materialLoadingFailsSilently:hy.MATERIAL_LOADING_FAILS_SILENTLY,optimizeWithUV:hy.OPTIMIZE_WITH_UV,skipMaterials:hy.SKIP_MATERIALS}}_loadMTL(e,t,i,s){const r=t+e;Ht.LoadFile(r,i,void 0,void 0,!1,((e,t)=>{s(r,t)}))}createPlugin(){return new hy(hy._DefaultLoadingOptions)}canDirectLoad(){return!1}importMeshAsync(e,t,i,s){return this._parseSolid(e,t,i,s).then((e=>({meshes:e,particleSystems:[],skeletons:[],animationGroups:[],transformNodes:[],geometries:[],lights:[]})))}loadAsync(e,t,i){return this.importMeshAsync(null,e,t,i).then((()=>{}))}loadAssetContainerAsync(e,t,i){const s=new mr(e);return this._assetContainer=s,this.importMeshAsync(null,e,t,i).then((e=>(e.meshes.forEach((e=>s.meshes.push(e))),e.meshes.forEach((e=>{const t=e.material;t&&-1==s.materials.indexOf(t)&&(s.materials.push(t),t.getActiveTextures().forEach((e=>{-1==s.textures.indexOf(e)&&s.textures.push(e)})))})),this._assetContainer=null,s))).catch((e=>{throw this._assetContainer=null,e}))}_parseSolid(e,t,i,s){let r="";const n=new ay,o=[],a=[];new ly(o,a,this._loadingOptions).parse(e,i,t,this._assetContainer,(e=>{r=e}));const l=[];return""===r||this._loadingOptions.skipMaterials||l.push(new Promise(((e,i)=>{this._loadMTL(r,s,(l=>{try{n.parseMTL(t,l,s,this._assetContainer);for(let e=0;e<n.materials.length;e++){let t=0;const i=[];let s;for(;(s=o.indexOf(n.materials[e].name,t))>-1;)i.push(s),t=s+1;if(-1===s&&0===i.length)n.materials[e].dispose();else for(let t=0;t<i.length;t++){const s=a[i[t]],r=n.materials[e];s.material=r,s.getTotalIndices()||(r.pointsCloud=!0)}}e()}catch(t){Ht.Warn(`Error processing MTL file: '${r}'`),this._loadingOptions.materialLoadingFailsSilently?e():i(t)}}),((t,s)=>{Ht.Warn(`Error downloading MTL file: '${r}'`),this._loadingOptions.materialLoadingFailsSilently?e():i(s)}))}))),Promise.all(l).then((()=>a))}}hy.OPTIMIZE_WITH_UV=!0,hy.INVERT_Y=!1,hy.IMPORT_VERTEX_COLORS=!1,hy.COMPUTE_NORMALS=!1,hy.OPTIMIZE_NORMALS=!1,hy.UV_SCALING=new E(1,1),hy.SKIP_MATERIALS=!1,hy.MATERIAL_LOADING_FAILS_SILENTLY=!0,Hr&&Hr.RegisterPlugin(new hy);class cy{constructor(){this.solidPattern=/solid (\S*)([\S\s]*?)endsolid[ ]*(\S*)/g,this.facetsPattern=/facet([\s\S]*?)endfacet/g,this.normalPattern=/normal[\s]+([-+]?[0-9]+\.?[0-9]*([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+/g,this.vertexPattern=/vertex[\s]+([-+]?[0-9]+\.?[0-9]*([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+/g,this.name="stl",this.extensions={".stl":{isBinary:!0}}}importMesh(e,t,i,s,r){let n;if("string"!=typeof i){if(this._isBinary(i)){const e=new ur("stlmesh",t);return this._parseBinary(e,i),r&&r.push(e),!0}i=(new TextDecoder).decode(new Uint8Array(i))}for(;n=this.solidPattern.exec(i);){let i=n[1];const s=n[3];if(s&&i!=s)return Ht.Error("Error in STL, solid name != endsolid name"),!1;if(e&&i)if(e instanceof Array){if(!e.indexOf(i))continue}else if(i!==e)continue;i=i||"stlmesh";const o=new ur(i,t);this._parseASCII(o,n[2]),r&&r.push(o)}return!0}load(e,t,i){return this.importMesh(null,e,t,i,null)}loadAssetContainer(e,t,i){const s=new mr(e);return e._blockEntityCollection=!0,this.importMesh(null,e,t,i,s.meshes),e._blockEntityCollection=!1,s}_isBinary(e){const t=new DataView(e);if(t.byteLength<=80)return!1;if(84+50*t.getUint32(80,!0)===t.byteLength)return!0;const i=[115,111,108,105,100];for(let e=0;e<5;e++)if(t.getUint8(e)!==i[e])return!0;return!1}_parseBinary(e,t){const i=new DataView(t),s=i.getUint32(80,!0);let r=0;const n=new Float32Array(3*s*3),o=new Float32Array(3*s*3),a=new Uint32Array(3*s);let l=0;for(let e=0;e<s;e++){const t=84+50*e,s=i.getFloat32(t,!0),h=i.getFloat32(t+4,!0),c=i.getFloat32(t+8,!0);for(let e=1;e<=3;e++){const a=t+12*e;n[r]=i.getFloat32(a,!0),o[r]=s,cy.DO_NOT_ALTER_FILE_COORDINATES?(n[r+1]=i.getFloat32(a+4,!0),n[r+2]=i.getFloat32(a+8,!0),o[r+1]=h,o[r+2]=c):(n[r+2]=i.getFloat32(a+4,!0),n[r+1]=i.getFloat32(a+8,!0),o[r+2]=h,o[r+1]=c),r+=3}cy.DO_NOT_ALTER_FILE_COORDINATES?(a[l]=l,a[l+1]=l+2,a[l+2]=l+1,l+=3):(a[l]=l++,a[l]=l++,a[l]=l++)}e.setVerticesData(hi.PositionKind,n),e.setVerticesData(hi.NormalKind,o),e.setIndices(a),e.computeWorldMatrix(!0)}_parseASCII(e,t){const i=[],s=[],r=[];let n,o=0;for(;n=this.facetsPattern.exec(t);){const e=n[1],t=this.normalPattern.exec(e);if(this.normalPattern.lastIndex=0,!t)continue;const a=[Number(t[1]),Number(t[5]),Number(t[3])];let l;for(;l=this.vertexPattern.exec(e);)cy.DO_NOT_ALTER_FILE_COORDINATES?(i.push(Number(l[1]),Number(l[3]),Number(l[5])),s.push(a[0],a[2],a[1])):(i.push(Number(l[1]),Number(l[5]),Number(l[3])),s.push(a[0],a[1],a[2]));cy.DO_NOT_ALTER_FILE_COORDINATES?(r.push(o,o+2,o+1),o+=3):r.push(o++,o++,o++),this.vertexPattern.lastIndex=0}this.facetsPattern.lastIndex=0,e.setVerticesData(hi.PositionKind,i),e.setVerticesData(hi.NormalKind,s),e.setIndices(r),e.computeWorldMatrix(!0)}}cy.DO_NOT_ALTER_FILE_COORDINATES=!1,Hr&&Hr.RegisterPlugin(new cy);class uy{constructor(){this.name="splat",this.extensions={".splat":{isBinary:!0}}}createPlugin(){return new uy}canDirectLoad(){return!1}importMeshAsync(e,t,i,s){return new sx("",t).loadFileAsync(s)}loadAsync(e,t,i){return new sx("GaussianSplatting",e).loadDataAsync(t)}loadAssetContainerAsync(e,t,i){throw new Error("loadAssetContainerAsync not implemented for Gaussian Splatting loading")}}Hr&&Hr.RegisterPlugin(new uy);class dy{static DEG2RADFACTOR=Math.PI/180;model=null;root=null;boundingSphere=null;armModel=null;scene;_color=new N(.8,.8,.8);constructor(e){this.scene=e}async loadAsync(){let e=await Hr.ImportMeshAsync("","/Models/","untitled.glb",this.scene);this.model=e.meshes[0];for(const e of this.model.getChildMeshes())e.renderOutline=!0,e.outlineColor=new N(.4,.4,.4),e.outlineWidth=1,e.material=new Va("material",this.scene),e.material.diffuseColor=this._color,e.normalizeToUnitCube(!0);this.boundingSphere=Ol("t",{diameter:1.5}),this.boundingSphere.setEnabled(!1);const t=this.armModel=e.meshes[1];t.rotationQuaternion=null,t.rotation.y=-90*dy.DEG2RADFACTOR}set color(e){this._color=e,this.model.getChildMeshes(!0)?.forEach((t=>{t.material&&(t.material.diffuseColor=e)}))}_amplitude=0;get amplitude(){return this._amplitude}set amplitude(e){this._amplitude=e}_frequency=0;get frequency(){return this._frequency}set frequency(e){this._frequency=e}_offset=90;get offset(){return this._offset}set offset(e){this._offset=e}currentPos=0;updateAnimation(){const e=this.scene.deltaTime/1e3;if(isNaN(e))return;this.currentPos=(this.currentPos+e)%(1/this.frequency);const t=2*Math.PI;let i=90-this.offset+Math.sin(this.currentPos*t*this.frequency)*this.amplitude;i=Math.min(90,Math.max(-90,i)),this.armModel instanceof Vs&&(this.armModel.rotation.x=i*dy.DEG2RADFACTOR)}}var py=i(105);class _y extends Yi{edmoModel=null;camera;engine;canvas;resizeObserver;loaded=!1;constructor(e,t){const i=new Ns(e);super(i,t),this.engine=i,this.canvas=e;const s=new Cl("Global lights",new S(0,1,0),this);s.diffuse=new N(1,1,1),s.specular=new N(1,1,1),s.groundColor=new N(.4,.4,.4),this.edmoModel=new dy(this),this.clearColor=new F(0,0,0,0);let r=this.camera=new Ho("Camera2",.4,.9,5,S.ZeroReadOnly,this);r.attachControl(e,!0),r.useFramingBehavior=!0,r.framingBehavior&&(r.framingBehavior.mode=Nr.FitFrustumSidesMode),window.addEventListener("resize",(()=>this.Resize())),this.resizeObserver=new ResizeObserver((e=>this.Resize())),i.runRenderLoop((()=>{this.Update(),this.render()}))}async loadAsync(){await this.edmoModel.loadAsync(),this.camera.setTarget(this.edmoModel.boundingSphere),this.resizeObserver.observe(this.canvas),this.loaded=!0}Resize(){this.loaded&&(this.engine.resize(),this.camera.setTarget(this.edmoModel.boundingSphere))}Update(){this.edmoModel?.updateAnimation(),isNaN(this.deltaTime)}updateEdmoModel(e,t){if(this.edmoModel)switch(e){case py.R.Offset:this.edmoModel.offset=t;break;case py.R.Frequency:this.edmoModel.frequency=t;break;case py.R.Amplitude:this.edmoModel.amplitude=t}}}},105:(e,t,i)=>{var s;i.d(t,{R:()=>s}),function(e){e[e.Offset=0]="Offset",e[e.Frequency=1]="Frequency",e[e.Amplitude=2]="Amplitude",e[e.Relation=3]="Relation"}(s||(s={}))},626:(e,t,i)=>{i.a(e,(async(e,t)=>{try{var s=i(993),r=i(816),n=i(911),o=i(105),a=i(526),l=i(746),h=i(981),c=i(418),u=i(909),d=i(77),p=i(253),_=i(134);await _.p.loadLocalisationBanks("/strings/controllerStrings.json");const m=localStorage.getItem("ConnectTarget")??"",g=localStorage.getItem("ConnectName")??"UnnamedPlayer",v=document.getElementById("panelArea"),x=document.getElementById("feedbackBubble"),T=document.getElementById("taskBubble"),E=document.getElementById("robotSprite"),S="bloom"==g.toLowerCase()?new p.x(E):new a.S(E),b=new l.o(x),C=document.getElementById("canvasContainer"),y=document.getElementById("controllerContainer"),A=document.createElement("span");A.innerText="  ";const R=document.createElement("span");A.appendChild(R),R.innerText="-1";const I=new c.Q([{faIcon:"fa-gamepad",selectionCallback:()=>B(),overlayElement:A},{faIcon:"fa-list",selectionCallback:()=>{v.replaceChildren(I.element,M.element)}},{faIcon:"fa-user-group",selectionCallback:()=>{v.replaceChildren(I.element,O.element)}}]),P=new h.U(null,{frequencyChangedCallback:z,amplitudeChangedCallback:W,offsetChangedCallback:H,phaseShiftChangedCallback:X,helpButtonClicked:k}),M=new u.W(T),O=new d.Z;let D=[];const N=document.getElementById("renderCanvas"),F=new s.n(N);F.loadAsync();const w=[0,120,240,60];var f=-1;const L=new r.v(g,(0,n.zT)(`controller/${m}`,"8080","ws:"),[V]);function B(){v.replaceChildren(I.element,P.element)}B();const U=Math.PI/180;async function V(e){const t=e.indexOf(" "),i=e.substring(0,t).trim(),s=e.substring(t).trim();switch(i){case"ID":f=parseInt(s),document.documentElement.style.setProperty("--hue",`${w[f]}`),O.setID(f),R.innerText=f.toString();break;case"amp":{const e=parseFloat(s);P.amplitude=e,W(e,!1);break}case"freq":{const e=parseFloat(s);P.frequency=e,z(e,!1);break}case"phb":{const e=parseFloat(s)/U;P.phaseShift=e,X(e,!1);break}case"off":{const e=parseFloat(s);P.offset=e,H(e,!1);break}case"TaskInfo":const e=JSON.parse(s);M.refreshTasks(e);break;case"HelpEnabled":0!=parseInt(s)?(S.show(),P.showHelpButton()):(S.hide(),P.hideHelpButton());break;case"SimpleMode":0!=parseInt(s)?(C.classList.add("simple"),N.classList.add("simple"),y.classList.add("simple")):(C.classList.remove("simple"),N.classList.remove("simple"),y.classList.remove("simple"));break;case"Feedback":b.show(s);const t=_.p.getKeysFor(s);for(const e of new Set(t))P.highlight(e);S.speak();break;case"PlayerInfo":D=JSON.parse(s),D.sort(),O.refreshPlayers(D)}}function k(){L.sendMessage("vote "+(G()?.voted?0:1))}function G(){for(const e of D)if(e.number==f)return e}function z(e,t=!0){F.updateEdmoModel(o.R.Frequency,e),t&&L.sendMessage(`freq ${e}`)}function W(e,t=!0){F.updateEdmoModel(o.R.Amplitude,e),t&&L.sendMessage(`amp ${e}`)}function H(e,t=!0){F.updateEdmoModel(o.R.Offset,e),t&&L.sendMessage(`off ${e}`)}function X(e,t=!0){F.updateEdmoModel(o.R.Relation,e),t&&L.sendMessage("phb "+Number(e)*U)}t()}catch(Y){t(Y)}}),1)},911:(e,t,i)=>{async function s(e,t){try{const i=await fetch(e,t);return i.ok?await i.json():null}catch{return null}}function r(e,t=window.location.port,i=window.location.protocol){return`${i}//${window.location.hostname}:${t}/${e}`}i.d(t,{Fd:()=>s,zT:()=>r})},253:(e,t,i)=>{i.d(t,{x:()=>s});class s{static imagesURI=["./Textures/Bloom/Idle.png","./Textures/Bloom/Idle+Wave.png","./Textures/Bloom/IdleBlink.png","./Textures/Bloom/IdleBlink+Wave.png","./Textures/Bloom/Speaking.png","./Textures/Bloom/Speaking+Wave.png","./Textures/Bloom/SpeakingBlink.png","./Textures/Bloom/SpeakingBlink+Wave.png"];static cachedImages=[];blinking=!1;speaking=!1;waving=!1;scaleFactor=0;blinkFrames=0;waveFrames=0;speakFrames=0;mouthSwitchFrames=0;static{for(const e of this.imagesURI){const t=new Image;t.src=e,this.cachedImages.push(t)}}target;timer=null;constructor(e){this.target=e,this.target.className="bloomSprite hidden",this.setImage(s.imagesURI[0]),this.target.addEventListener("mouseover",this.onMouseOver.bind(this)),this.timer=setInterval(this.update.bind(this),16)}update(){if(this.blinking)0==--this.blinkFrames&&(this.blinking=!1);else{const e=.005;Math.random()<=e&&(this.blinking=!0,this.blinkFrames=Math.floor(5*Math.random()+5))}this.waving&&--this.waveFrames<=0&&(this.waving=!1),this.speakFrames>0?(--this.mouthSwitchFrames,--this.speakFrames,this.mouthSwitchFrames<=0&&(this.speaking=!this.speaking,this.mouthSwitchFrames=Math.floor(10*Math.random()))):this.speaking=!1;let e=0;this.speaking&&(e+=4),this.blinking&&(e+=2),this.waving&&(e+=1),this.setImage(s.imagesURI[e])}onMouseOver(e){this.wave()}setImage(e){this.target.style.backgroundImage=`url(${e})`}wave(){this.waving=!0,this.waveFrames=40}speak(){this.speaking=!0,this.speakFrames=300}show(){this.target.classList.remove("hidden"),this.wave()}hide(){this.wave(),this.target.classList.add("hidden")}}},746:(e,t,i)=>{i.d(t,{o:()=>s});class s{target;timer;constructor(e){this.target=e}show(e){this.target.innerText=e,this.target.classList.remove("hidden"),null!=this.timer&&(clearInterval(this.timer),this.timer=null),this.timer=setInterval(this.hide.bind(this),5e3)}hide(){this.target.classList.add("hidden"),clearInterval(this.timer)}}},134:(e,t,i)=>{i.d(t,{p:()=>r});var s=i(911);class r{static localisationBanks=[];static currentLanguage="nl";static{this.currentLanguage=localStorage.getItem("language")??"nl"}static async loadLocalisationBanks(...e){for(const t of e){const e=await(0,s.Fd)(t);if(!e)return;this.localisationBanks.push(e)}this.applyLocalisationToAllElements()}static get CurrentLanguage(){return this.currentLanguage}static getString(e,t=null){for(const i of this.localisationBanks){if(!(e in i))continue;const s=i[e];if(this.currentLanguage in s)return this.format(s[this.currentLanguage],t)}const i=`Can't find string with key {${e}} for language code {${this.currentLanguage}}`;return console.log(i),""}static getKeysFor(e){return e.split(" ").map(this.getKeyFor.bind(this))}static getKeyFor(e){for(const t of this.localisationBanks)for(const i in t){if(!e.localeCompare(i,void 0,{sensitivity:"accent"}))return i;const s=t[i];for(const t in s)if(!e.localeCompare(s[t],void 0,{sensitivity:"accent"}))return i}return""}static addLocalisationBanks(...e){for(const t of e)this.localisationBanks.push(t);this.applyLocalisationToAllElements()}static clearLocalisationBanks(){this.localisationBanks=[]}static findAllLocalizableElements(){return document.querySelectorAll("[data-i18n-key]")}static setLocalisationKey(e,t,i=null){e.setAttribute("data-i18n-key",t),i&&e.setAttribute("data-i18n-args",JSON.stringify(i)),this.applyLocalisation(e)}static removeLocalisationKey(e){e.removeAttribute("data-i18n-key"),e.removeAttribute("data-i18n-args")}static setLanguage(e){this.currentLanguage=e,localStorage.setItem("language",e),this.applyLocalisationToAllElements()}static applyLocalisation(e){const t=e.getAttribute("data-i18n-key"),i=e.getAttribute("data-i18n-args"),s=i?JSON.parse(i):null;if(!t)return;const r=this.getString(t,s);e instanceof HTMLInputElement?e.placeholder=r:e.innerText=r}static applyLocalisationToAllElements(){const e=this.findAllLocalizableElements();for(const t of e)t instanceof HTMLElement&&this.applyLocalisation(t)}static format(e,t=null){return t?e.replace(/\{\{|\}\}|\{(\w+)\}/g,(function(e,i){return"{{"==e?"{":"}}"==e?"}":i in t?t[i]:`{${i}}`})):e}}},526:(e,t,i)=>{i.d(t,{S:()=>s});class s{static robotImagesURI=["./Textures/robot1.png","./Textures/robot2.png","./Textures/robot3.png","./Textures/robot4.png"];static cachedImages=[];static{for(const e of this.robotImagesURI){const t=new Image;t.src=e,this.cachedImages.push(t)}}timer;frameNumber=0;target;constructor(e){this.target=e,this.setImage(s.robotImagesURI[0]),this.target.addEventListener("mouseover",this.onMouseOver.bind(this))}setImage(e){this.target.style.backgroundImage=`url(${e})`}updateWave(){this.frameNumber++;let e=this.frameNumber;e>=4&&e<6?e=3:e>=6&&e<=8?e=6-(e-2):e>=8&&(e=this.frameNumber=0,clearInterval(this.timer)),this.setImage(s.robotImagesURI[e])}show(){this.target.classList.remove("hidden"),this.wave(100)}hide(){this.target.classList.add("hidden")}speak(){}onMouseOver(e){this.wave()}wave(e=200){null!=this.timer&&(clearInterval(this.timer),this.frameNumber=0),this.timer=setInterval(this.updateWave.bind(this),e)}}}},n={};function o(e){var t=n[e];if(void 0!==t)return t.exports;var i=n[e]={exports:{}};return r[e](i,i.exports,o),i.exports}e="function"==typeof Symbol?Symbol("webpack queues"):"__webpack_queues__",t="function"==typeof Symbol?Symbol("webpack exports"):"__webpack_exports__",i="function"==typeof Symbol?Symbol("webpack error"):"__webpack_error__",s=e=>{e&&e.d<1&&(e.d=1,e.forEach((e=>e.r--)),e.forEach((e=>e.r--?e.r++:e())))},o.a=(r,n,o)=>{var a;o&&((a=[]).d=-1);var l,h,c,u=new Set,d=r.exports,p=new Promise(((e,t)=>{c=t,h=e}));p[t]=d,p[e]=e=>(a&&e(a),u.forEach(e),p.catch((e=>{}))),r.exports=p,n((r=>{var n;l=(r=>r.map((r=>{if(null!==r&&"object"==typeof r){if(r[e])return r;if(r.then){var n=[];n.d=0,r.then((e=>{o[t]=e,s(n)}),(e=>{o[i]=e,s(n)}));var o={};return o[e]=e=>e(n),o}}var a={};return a[e]=e=>{},a[t]=r,a})))(r);var o=()=>l.map((e=>{if(e[i])throw e[i];return e[t]})),h=new Promise((t=>{(n=()=>t(o)).r=0;var i=e=>e!==a&&!u.has(e)&&(u.add(e),e&&!e.d&&(n.r++,e.push(n)));l.map((t=>t[e](i)))}));return n.r?h:o()}),(e=>(e?c(p[i]=e):h(d),s(a)))),a&&a.d<0&&(a.d=0)},o.d=(e,t)=>{for(var i in t)o.o(t,i)&&!o.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o(626)})();